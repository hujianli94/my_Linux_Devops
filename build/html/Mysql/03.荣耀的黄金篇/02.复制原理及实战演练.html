<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3.2. 02.复制原理及实战演练 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="4. 04.尊贵的铂金篇" href="../04.%E5%B0%8A%E8%B4%B5%E7%9A%84%E9%93%82%E9%87%91%E7%AF%87/index.html" />
    <link rel="prev" title="3.1. 01.主从复制概述" href="01.%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%A6%82%E8%BF%B0.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> 小健_Linux-shell-Devops_Blog
            <img src="../../_static/devops_photo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../DevOps/index.html">DevOps和自动化运维实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Github/index.html">Github入门到实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Jenkins/index.html">Jenkins持续化集成</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../KVM/index.html">KVM实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Linux/index.html">Linux</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Mysql王者之路</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01.%E5%80%94%E5%BC%BA%E7%9A%84%E9%9D%92%E9%93%9C%E7%AF%87/index.html">1. 01.倔强的青铜篇</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02.%E7%A7%A9%E5%BA%8F%E7%9A%84%E7%99%BD%E9%93%B6%E7%AF%87/index.html">2. 02.秩序的白银篇</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">3. 03.荣耀的黄金篇</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="01.%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%A6%82%E8%BF%B0.html">3.1. 01.主从复制概述</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">3.2. 02.复制原理及实战演练</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">3.2.1. 异步复制</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">3.2.2. 主从复制故障处理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">3.2.3. 半同步复制</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">3.2.4. 半同步模式和异步复制模式的切换</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gtid">3.2.5. GTID复制</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id26">3.2.6. 多源复制</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id28">3.2.7. 总结</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../04.%E5%B0%8A%E8%B4%B5%E7%9A%84%E9%93%82%E9%87%91%E7%AF%87/index.html">4. 04.尊贵的铂金篇</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05.%E6%B0%B8%E6%81%92%E7%9A%84%E9%92%BB%E7%9F%B3%E7%AF%87/index.html">5. 05.永恒的钻石篇</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06.%E8%87%B3%E5%B0%8A%E7%9A%84%E6%98%9F%E8%80%80%E7%AF%87/index.html">6. 06.至尊的星耀篇</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07.%E6%9C%80%E5%BC%BA%E7%9A%84%E7%8E%8B%E8%80%85%E7%AF%87/index.html">7. 07.最强的王者篇</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../other/index.html">Other</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Network_route_switch/index.html">Network_route_switch</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">小健_Linux-shell-Devops_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Mysql王者之路</a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">3. </span>03.荣耀的黄金篇</a> &raquo;</li>
      <li><span class="section-number">3.2. </span>02.复制原理及实战演练</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Mysql/03.荣耀的黄金篇/02.复制原理及实战演练.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#id1" id="id29">02.复制原理及实战演练</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id30">异步复制</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id31">环境：</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id32">主从的必要几个条件</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id33">主库上的操作</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id34">从库上的操作</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id35">报错处理</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id36">验证如下</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id37">主从复制管理命令：</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id10" id="id38">主从复制故障处理</a></p>
<ul>
<li><p><a class="reference internal" href="#id11" id="id39">1、主键冲突，错误代码1062</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id40">2.主库更新数据，从库找不到而报错，错误代码1032</a></p></li>
<li><p><a class="reference internal" href="#server-id" id="id41">主从server-id一致</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id42">跨库操作，丢失数据</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id14" id="id43">半同步复制</a></p></li>
<li><p><a class="reference internal" href="#id15" id="id44">半同步模式和异步复制模式的切换</a></p>
<ul>
<li><p><a class="reference internal" href="#id16" id="id45">半同步切换为异步</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#gtid" id="id46">GTID复制</a></p>
<ul>
<li><p><a class="reference internal" href="#id18" id="id47">主库配置</a></p></li>
<li><p><a class="reference internal" href="#id19" id="id48">从库配置</a></p></li>
<li><p><a class="reference internal" href="#id20" id="id49">清除原有主从复制关系</a></p></li>
<li><p><a class="reference internal" href="#id21" id="id50">验证</a></p></li>
<li><p><a class="reference internal" href="#id22" id="id51">GTID复制与传统复制的切换</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id26" id="id52">多源复制</a></p>
<ul>
<li><p><a class="reference internal" href="#id27" id="id53">基于GTID的多源复制搭建过程</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id28" id="id54">总结</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="id1">
<h1><a class="toc-backref" href="#id29"><span class="section-number">3.2. </span>02.复制原理及实战演练</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<section id="id2">
<h2><a class="toc-backref" href="#id30"><span class="section-number">3.2.1. </span>异步复制</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>在主库写入binlog日志后即可成功返回客户端，无须等待binlog日志传递给从库的过程。一旦主库发生宕机，就有可能出现丢失数据的情况</p>
<p>非gtid模式，基于binlog和position方式</p>
<section id="id3">
<h3><a class="toc-backref" href="#id31">环境：</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Linux版本：Linux Centos 6.4 32位
Mysql版本：Mysql-5.6.38-linux-glibc2.12-i686
Mysql安装：Mysql安装教程
搭建环境：在源LAMP架构基础，增加一台Mysql服务，搭建Replication 主从。

主192.168.0.128
备192.168.0.129
</pre></div>
</div>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id32">主从的必要几个条件</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·主库从库的server-id保证两者不一致

·主库开启binlig功能，从库建议也开启binlog，并且开启log_slave_updates参数，让从库也写binlog，方便后期扩展架构。
log_slave_updates = 1

· 为了避免后期出现数据不一致的情况，保证binlog格式为row模式来实施搭建过程，分别在主库和从库上配置如下：
binlog_format = row
</pre></div>
</div>
</section>
<section id="id5">
<h3><a class="toc-backref" href="#id33">主库上的操作</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(1)修改本地主机名为master（可略）。

# 临时修改主机名
hostname master
# 实时生效
bash

vim /etc/sysconfig/network

NETWORKING=yes
HOSTNAME=master

(2) 修改mysql主配置文件
vim /etc/my.cnf
# 解注释：主ID为1
server-id = 1
# 解注释：开启二进制日志，mysql-bin前缀名
log-bin = /data/mysql/mysql-bin




# 重启Mysql服务
/etc/init.d/mysqld restart

# 查看bin-log日志
[root@master mysql]# ls /data/mysql/mysql-bin.*
/data/mysql/mysql-bin.000001  /data/mysql/mysql-bin.000002  /data/mysql/mysql-bin.000003  /data/mysql/mysql-bin.000004  /data/mysql/mysql-bin.index


(3)授权主从用户。
# 进入数据库
mysql -uroot -proot123
# 添加用户repl 授权主从允许访问所有库
mysql&gt; grant replication slave on *.* to &#39;repl&#39;@&#39;192.168.0.%&#39; identified by &#39;123456&#39;;
# 安全起见:占时锁表,不让数据库更新
mysql&gt; flush tables with read lock;

(4)查看二进制相关信息。
mysql&gt; show master status;
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000001 |      328 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
1 row in set (0.01 sec)


(4)从库测试到主库的连通性，使用授权用户
[root@pxe-server mysql]# mysql -urepl -p123456 -h192.168.0.128 -P3306
注：可登陆说明链接正常。
注：链接不上需要查看网络，端口，密码，地址等是否正确。


# 备份数据库为all_db.sql
[root@master mysql]# mysqldump -uroot -proot123  --all-databases &gt; all_db.sql

# 远程将备份文件发送给从服务端的root目录内
[root@192 mysql]# scp all_db.sql root@192.168.0.129:/root/
到此，主库上的操作已结束。
</pre></div>
</div>
</section>
<section id="id6">
<h3><a class="toc-backref" href="#id34">从库上的操作</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1、修改本地主机名为（可略）。

# 临时修改主机名
hostname slave
# 实时生效
bash

vim /etc/sysconfig/network
NETWORKING=yes
HOSTNAME=slave

(1)恢复从主库传递过来的数据
[root@pxe-server mysql]# mysql -uroot -proot123 &lt; /root/all_db.sql

2、修改Mysql主配置文件、重启服务。
# 修改mysq主配置文件
vim /etc/my.cnf
# 解注释：从ID为2、从可以注释掉此选项
server-id = 2
log-bin = /data/mysql/mysql-bin
# 重启Mysql服务
/etc/init.d/mysqld restart

(2)进入数据库,配置主从命令
mysql -uroot -proot123

# 关闭复制
stop slave;
# 配置主从建立链接、master_log_file与master_log_pos要与主内的数据匹配
change master to master_host=&#39;192.168.0.128&#39;,
master_port=3306,
master_user=&#39;repl&#39;,
master_password=&#39;123456&#39;,
master_log_file=&#39;mysql-bin.000001&#39;,
master_log_pos=328;

(3)开启复制
start slave;

(4)查看主从复制状态
mysql&gt; show slave status\G
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 192.168.0.128
                  Master_User: repl
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: 328
               Relay_Log_File: slave-relay-bin.000003
                Relay_Log_Pos: 491
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes

##Slave_IO_Running和Slave_SQL_Running均为Yes即主从复制正常
</pre></div>
</div>
<p><img alt="image0" src="../../_images/mysql_zhucong0001.png" /></p>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id35">报错处理</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>主库添加log-bin-index 参数后，从库报这个错误：Got fatal error 1236 from master when reading data from binary log: &#39;Could not find first log file name in binary log index file&#39;
Got fatal error 1236 from master when reading data from binary log: &#39;could not find next log&#39;

可以
stop slave;
reset slave;
start slave;
</pre></div>
</div>
</section>
<section id="id8">
<h3><a class="toc-backref" href="#id36">验证如下</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 主库上创建hujianlidb数据库</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">database</span> <span class="n">hujianlidb</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="c1"># 从库上查看数据库</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">Database</span>           <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">hujianlidb</span>         <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>
<span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">test</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">ttport</span>             <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="mi">6</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id37">主从复制管理命令：</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">show</span> <span class="n">slave</span> <span class="n">status</span>\<span class="n">G</span>                 <span class="c1">#在从库上查看主从状态。</span>
<span class="n">show</span> <span class="n">master</span> <span class="n">status</span>\<span class="n">G</span>                <span class="c1">#查看主库binlog文件和位置及开启gtid模式下记录的gtid。</span>
<span class="n">change</span> <span class="n">master</span> <span class="n">to</span>                    <span class="c1">#在从库上配置主从过程。</span>
<span class="n">start</span> <span class="n">slave</span>                         <span class="c1">#开启主从同步。</span>
<span class="n">stop</span> <span class="n">slave</span>                          <span class="c1">#关闭主从同步。</span>
<span class="n">reset</span> <span class="n">slave</span> <span class="nb">all</span>                     <span class="c1">#清空从库的所有配置信息。</span>
</pre></div>
</div>
</section>
</section>
<section id="id10">
<h2><a class="toc-backref" href="#id38"><span class="section-number">3.2.2. </span>主从复制故障处理</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<section id="id11">
<h3><a class="toc-backref" href="#id39">1、主键冲突，错误代码1062</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>原因：由于误操作，在从库上执行了写入操作，导致再在主库执行相同操作时，由于主键冲突，
主从复制状态会报错。所以生产环境中建议在从库开启read only，避免在从库执行写入操作。


解决办法：可直接通过percona-toolkit工具集中的pt-slave-restart命令在从库跳过错误
./pt-slave-restart -uroot -proot123

再次查看主从状态，已经恢复正常。
</pre></div>
</div>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id40">2.主库更新数据，从库找不到而报错，错误代码1032</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>从库少数据，需要找到缺少的数据，在从库上重新执行一遍

原因：由于误操作，在从库上执行delete操作，导致主从数据不一致，这时再在主库执行同条数据的更新操作时，由于从库已经没有该数据，SQL无法在从库实现
</pre></div>
</div>
<p>解决办法：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>根据报错信息所知道的binlog文件和position号，在主库上，通过mysqlbinlog找到在主库上执行的SQL语句
Last_Error: Could not execute Update_rows event on table test.t; Can&#39;t find record in &#39;t&#39;, Error_code: 1032; handler error HA_ERR_KEY_NOT_FOUND; the event&#39;s master log mysql-binlog.000003, end_log_pos 1408


mysqlbinlog --no-defaults -v -v --base64-output=decode-rows mysql-binlog.000003 |grep -A 10 1408 &gt;sql.log

#180706 22:36:45 server id 3306100 end_log_pos 1408 CRC32 0xc37d8c70 Update_rows: table id 139 flags: STMT_END_F
### UPDATE test.t
### WHERE
### @1=2 /* INT meta=0 nullable=0 is_null=0 */
### @2=&#39;tzy&#39; /* VARSTRING(80) meta=80 nullable=1 is_null=0 */
### @3=&#39;sh&#39; /* VARSTRING(40) meta=40 nullable=1 is_null=0 */
### SET
### @1=2 /* INT meta=0 nullable=0 is_null=0 */
### @2=&#39;zyn&#39; /* VARSTRING(80) meta=80 nullable=1 is_null=0 */
### @3=&#39;sh&#39; /* VARSTRING(40) meta=40 nullable=1 is_null=0 */
# at 1408
接下来只需把从库上丢失的这条数据补上，然后再执行跳过错误，主从复制功能就恢复正常了
注：在生产环境上，若从库缺失多条数据，建议重新搭建主从环境来确保数据一致性

insert into t (id,name,city) values (&#39;2&#39;,&#39;zyn&#39;,&#39;sh&#39;);
./pt-slave-restart -uroot -proot123
</pre></div>
</div>
</section>
<section id="server-id">
<h3><a class="toc-backref" href="#id41">主从server-id一致</a><a class="headerlink" href="#server-id" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>原因：两台服务器配置了相同的server-id

解决方法：不同机器设置不同的server-id
</pre></div>
</div>
</section>
<section id="id13">
<h3><a class="toc-backref" href="#id42">跨库操作，丢失数据</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>原因：主库设置了binlog-do-db参数，使用的binlog记录格式为statement模式，导致在主库上执行跨库操作时，从库执行失败

解决办法：主库上尽量避免使用过滤规则，可以在从库上使用replicate-do-db或replicate-ignore-db等参数，最重要的是让binlog格式为row模式
</pre></div>
</div>
</section>
</section>
<section id="id14">
<h2><a class="toc-backref" href="#id43"><span class="section-number">3.2.3. </span>半同步复制</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h2>
<p>异步复制的不足在于，当主库把event写入二进制日志后，并不知道从库是否已经接收并应用了。若主库崩溃，很有可能在主库中已经提交的事务，并没有传到任何一台从库机器上，在高可用集群架构下做主备切换，会造成新的主库丢失数据的现象</p>
<p>5.5版本引用半同步复制，主从服务器必须同时安装半同步复制插件，才能开启该复制功能。</p>
<p>在从库接收完主库传递过来的binlog内容写入到自己的relay
log里面后，才通知主库上面的等待线程，该操作完毕。</p>
<p>若等待超时，超过rpl_semi_sync_master_timeout后，关闭半同步，转为异步，直到至少有一台从库通知主库已收到binlog信息为止</p>
<p>半同步复制可以提升主从间数据一致性，让复制更加安全可靠</p>
<p>5.7中增加rpl_semi_sync_master_wait_point参数，控制半同步模式下主库在返回给session事务成功之前的事务提交方式，</p>
<p>值有：<code class="docutils literal notranslate"><span class="pre">AFTER_COMMIT</span></code>、<code class="docutils literal notranslate"><span class="pre">AFTER_SYNC</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>AFTER_COMMIT，5.6默认值，主库将每个事务写入binlog，并传递给从库，刷新到中继日志中，同时主库提交事务，之后主库等待从库反馈，在收到从库回复后，主库才将&quot;commit ok&quot;结果反馈客户端

AFTER_SYNC，5.7默认值，主库将每个事务写入binlog，并传递给从库，刷新到中继日志中，主库等待从库反馈，在收到从库回复后，主库再提交事务并返回&quot;commit ok&quot;结果给客户端
</pre></div>
</div>
<p>rpl_semi_sync_master_wait_for_slave_count
控制主库接收多少个从库写事务成功反馈，才返回成功给客户端
在after_sync模式下，即使主库宕机，所有在主库上已经提交的事务都能保证已经同步到从库中继日志中，不会丢失数据</p>
<p>MySQL半同步复制原理 <img alt="image1" src="../../_images/mysql_bantongbu.png" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>半同步复制搭建：
1）在异步复制的基础上
2）在主库中安装半同步复制插件并开启半同步复制功能
install plugin rpl_semi_sync_master soname &#39;semisync_master.so&#39;;
set global rpl_semi_sync_master_enabled=on;

mysql&gt; show variables like &quot;%semi%&quot;;
+------------------------------------+-------+
| Variable_name                      | Value |
+------------------------------------+-------+
| rpl_semi_sync_master_enabled       | ON    |

show plugins;
| rpl_semi_sync_master       | ACTIVE   | REPLICATION        | semisync_master.so | GPL
#rpl_semi_sync_master_timeout 主库等待从库回复消息的时间超时，单位毫秒，
超过该值就切换为异步复制，默认10s。该值可以设置得很大，禁止向异步复制切换保保证数据复制的安全性


3）在从库中安装半同步复制插件并开启半同步复制功能
mysql&gt; install plugin rpl_semi_sync_slave soname &#39;semisync_slave.so&#39;;
Query OK, 0 rows affected (0.01 sec)

mysql&gt; set global rpl_semi_sync_slave_enabled=on;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; show variables like &quot;%semi%&quot;;
+---------------------------------+-------+
| Variable_name                   | Value |
+---------------------------------+-------+
| rpl_semi_sync_slave_enabled     | ON    |

show plugins;
| rpl_semi_sync_slave        | ACTIVE   | REPLICATION        | semisync_slave.so | GPL
为了以后开机自启半同步复制功能，
可以把rpl_semi_sync_slave_enabled=on、rpl_semi_sync_master_enabled=on写到配置文件my.cnf中


4）重启从库I/O线程激活半同步复制
mysql&gt; stop slave io_thread;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; start slave io_thread;
Query OK, 0 rows affected (0.00 sec)



5）在主库上检查半同步复制是否正常运行
show global status like &quot;%semi%&quot;;
Rpl_semi_sync_master_clients 1 #已经有一个从库连接到了主库，且是半同步复制方式
Rpl_semi_sync_master_status ON #表示已经是半同步复制模式
Rpl_semi_sync_master_no_tx 0 #没有成功接收slave提交的次数
Rpl_semi_sync_master_yes_tx 0 #成功接收slave事务回复的次数

6）在从库上查看半同步复制状态
mysql&gt; show global status like &quot;%semi%&quot;;
+----------------------------+-------+
| Variable_name              | Value |
+----------------------------+-------+
| Rpl_semi_sync_slave_status | ON    |
+----------------------------+-------+

Rpl_semi_sync_slave_status ON #从库开启了半同步复制
</pre></div>
</div>
</section>
<section id="id15">
<h2><a class="toc-backref" href="#id44"><span class="section-number">3.2.4. </span>半同步模式和异步复制模式的切换</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h2>
<p>半同步复制的原理是从库I/O
thread接收完主库binlog后，写入relay中，然后会给主库一个回馈。
但若主库等待从库回复时间超过rpl_semi_sync_master_timeout时间后，会自动切换为异步复制方式。</p>
<p>目前测试过程中，等待时间是10s</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">variables</span> <span class="n">like</span> <span class="s2">&quot;</span><span class="si">%r</span><span class="s2">pl_semi_sync_master_timeout%&quot;</span><span class="p">;</span>
<span class="o">+------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+------------------------------+-------+</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_timeout</span> <span class="o">|</span> <span class="mi">10000</span> <span class="o">|</span>
</pre></div>
</div>
<section id="id16">
<h3><a class="toc-backref" href="#id45">半同步切换为异步</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>从库：stop slave io_thread;
从库：show global status like &quot;%semi%&quot;; #OFF状态
主库：show global status like &quot;%semi%&quot;; #ON状态

#插入要等待10秒很慢，主库一直在等待从库的回复，直到超过默认的等待时间10s
主库：insert into t (name,city) values (&#39;ff&#39;,&#39;99&#39;);

主库：show global status like &quot;%semi%&quot;; #OFF状态
</pre></div>
</div>
<p>生产环境中不建议半同步复制切换到异步复制模式，因为这样对安全性没有保证，
所以部分公司将rpl_sync_master_timeout设置得很大。</p>
<section id="id17">
<h4>异步切换为半同步<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<p>如果再想从异步复制切换到半同步复制，只需要重新开启从库的I/O thread。
命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 从库半同步复制开启</span>
<span class="n">start</span> <span class="n">slave</span> <span class="n">io_thread</span><span class="p">;</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="k">global</span> <span class="n">status</span> <span class="n">like</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">emi%&quot;</span><span class="p">;</span>
<span class="o">+----------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>              <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+----------------------------+-------+</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_slave_status</span> <span class="o">|</span> <span class="n">ON</span>    <span class="o">|</span>


<span class="c1"># 主库半同步复制开启成功</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="k">global</span> <span class="n">status</span> <span class="n">like</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">emi%&quot;</span><span class="p">;</span>
<span class="o">+--------------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                              <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+--------------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_status</span>                <span class="o">|</span> <span class="n">ON</span>    <span class="o">|</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="gtid">
<h2><a class="toc-backref" href="#id46"><span class="section-number">3.2.5. </span>GTID复制</a><a class="headerlink" href="#gtid" title="Permalink to this headline">¶</a></h2>
<p>gtid，全局事务ID，是一个已提交事务的编号，且是全局唯一的编号，5.6版本后新增</p>
<p>gtid由server_uuid和事务id组成，GTID=server_uuid:transaction_id。server_uuid在数据库启动过程中自动生成，唯一，存放于数据目录auto.cnf中；transaction_id是事务提交时由系统顺序分配的不重复的序列号</p>
<p>gtid的优势：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1）使用master_auto_position=1代替基于binlog和position号的主从复制方式，更便于主从复制的搭建
2）gtid可以知道事务在最开始是在哪个实例上提交的
3）gtid方便实现主从间failover，再也不用不断地找position和binlog了
</pre></div>
</div>
<section id="id18">
<h3><a class="toc-backref" href="#id47">主库配置</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gtid_mode</span><span class="o">=</span><span class="n">on</span>
<span class="n">enforce_gtid_consistency</span><span class="o">=</span><span class="n">on</span>
<span class="n">log_bin</span><span class="o">=</span><span class="n">on</span>
<span class="n">server</span><span class="o">-</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span>
<span class="n">binlog_format</span><span class="o">=</span><span class="n">row</span>
</pre></div>
</div>
</section>
<section id="id19">
<h3><a class="toc-backref" href="#id48">从库配置</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gtid_mode</span><span class="o">=</span><span class="n">on</span>
<span class="n">enforce_gtid_consistency</span><span class="o">=</span><span class="n">on</span>
<span class="n">log_slave_updates</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
</section>
<section id="id20">
<h3><a class="toc-backref" href="#id49">清除原有主从复制关系</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p>从库：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stop</span> <span class="n">slave</span><span class="p">;</span>
<span class="n">reset</span> <span class="n">slave</span> <span class="nb">all</span><span class="p">;</span>
<span class="n">show</span> <span class="n">slave</span> <span class="n">status</span>\<span class="n">G</span>    <span class="c1">#结果应为空</span>
<span class="n">server</span><span class="o">-</span><span class="nb">id</span><span class="o">=</span>
</pre></div>
</div>
<p>主库：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reset</span> <span class="n">master</span><span class="p">;</span>    <span class="c1">#删除所有binlog日志文件，并清空日志索引文件，重新开始所有新的日志文件</span>
</pre></div>
</div>
<p>建立主从复制： 主库</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">master</span> <span class="n">status</span>\<span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
             <span class="n">File</span><span class="p">:</span> <span class="n">on</span><span class="mf">.000002</span>
         <span class="n">Position</span><span class="p">:</span> <span class="mi">333</span>
     <span class="n">Binlog_Do_DB</span><span class="p">:</span>
 <span class="n">Binlog_Ignore_DB</span><span class="p">:</span>
<span class="n">Executed_Gtid_Set</span><span class="p">:</span> <span class="mi">0295</span><span class="n">c9c0</span><span class="o">-</span><span class="mf">5e0</span><span class="n">b</span><span class="o">-</span><span class="mi">11</span><span class="n">ea</span><span class="o">-</span><span class="mi">8</span><span class="n">d6e</span><span class="o">-</span><span class="mi">000</span><span class="n">c296e3df6</span><span class="p">:</span><span class="mi">1</span>

 <span class="c1">#查看Executed_Gtid_Set，从库操作完成后，Executed_Gtid_Set值会自动生成。</span>
</pre></div>
</div>
<p>从库</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 测试授权用户到主库的连接</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@slave</span> <span class="n">mysql</span><span class="p">]</span><span class="c1"># mysql -urepl -p123456 -h192.168.0.128 -P3306</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">change</span> <span class="n">master</span> <span class="n">to</span>
    <span class="o">-&gt;</span> <span class="n">master_host</span><span class="o">=</span><span class="s1">&#39;192.168.0.128&#39;</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="n">master_user</span><span class="o">=</span><span class="s1">&#39;repl&#39;</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="n">master_password</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="n">master_port</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="n">master_auto_position</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>


<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">start</span> <span class="n">slave</span><span class="p">;</span>


<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">slave</span> <span class="n">status</span>\<span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="n">Slave_IO_State</span><span class="p">:</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">master</span> <span class="n">to</span> <span class="n">send</span> <span class="n">event</span>
                  <span class="n">Master_Host</span><span class="p">:</span> <span class="mf">192.168.0.128</span>
                  <span class="n">Master_User</span><span class="p">:</span> <span class="n">repl</span>
                  <span class="n">Master_Port</span><span class="p">:</span> <span class="mi">3306</span>
                <span class="n">Connect_Retry</span><span class="p">:</span> <span class="mi">60</span>
              <span class="n">Master_Log_File</span><span class="p">:</span> <span class="n">on</span><span class="mf">.000002</span>
          <span class="n">Read_Master_Log_Pos</span><span class="p">:</span> <span class="mi">151</span>
               <span class="n">Relay_Log_File</span><span class="p">:</span> <span class="n">slave</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="nb">bin</span><span class="mf">.000002</span>
                <span class="n">Relay_Log_Pos</span><span class="p">:</span> <span class="mi">347</span>
        <span class="n">Relay_Master_Log_File</span><span class="p">:</span> <span class="n">on</span><span class="mf">.000002</span>
             <span class="n">Slave_IO_Running</span><span class="p">:</span> <span class="n">Yes</span>
            <span class="n">Slave_SQL_Running</span><span class="p">:</span> <span class="n">Yes</span>
</pre></div>
</div>
<p>5.7之后，gtid_executed这个值持久化了，在mysql库下新增了一张表：<code class="docutils literal notranslate"><span class="pre">gtid_executed</span></code></p>
<p>该表会记录已经执行的gtid集合的信息，有了这张表，就不用再像5.6版本时，必须开启log_slave_updates参数，从库才可以进行复制。
gtid信息会保存在gtid_executed表中，可以关闭从库binlog，节约binlog记录开销。执行reset
master时，会清空表内所有数据</p>
<p>5.7还有<code class="docutils literal notranslate"><span class="pre">gtid_executed_compression_period</span></code>参数，控制gtid_executed表压缩，默认值为1000，表示执行完1000个事务后开始压缩</p>
</section>
<section id="id21">
<h3><a class="toc-backref" href="#id50">验证</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 主库上创建hujianlitest2数据库</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">database</span> <span class="n">hujianlitest2</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>


<span class="c1"># 从库上查看</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">Database</span>           <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">hujianlitest2</span>      <span class="o">|</span>
</pre></div>
</div>
</section>
<section id="id22">
<h3><a class="toc-backref" href="#id51">GTID复制与传统复制的切换</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>当前为gtid复制，配置文件中gtid_mode=on，调整为传统复制
show slave status\G
#停止主从复制，调整为传统复制，让master_auto_position=0
stop slave;
show slave status\G #获取主库当前binlog和pos
change master to
master_auto_position=0,
master_host=&#39;192.168.10.110&#39;,
master_user=&#39;bak&#39;,
master_password=&#39;bak123&#39;,
master_port=3306,
master_log_file=&#39;mysql-binlog.000002&#39;,
master_log_pos=680;
start slave;
</pre></div>
</div>
<section id="id23">
<h4>传统复制 -&gt; GTid复制<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>主从服务器上同时调整gtid_mode为on_permissive
show variables like &quot;%gtid_mode%&quot;;   #ON状态
set global gtid_mode=on_permissive;

主从服务器上同时调整gtid_mode为off_permissive
set global gtid_mode=off_permissive;

主从服务器上同时关闭gtid功能
set global gtid_mode=off;
将gtid_mode=off和enforce_gtid_consistency=off写入配置文件my.cnf中，下次重启会直接生效

检查是否成功
标志：show slave status\G，gtid值不再增加
</pre></div>
</div>
</section>
<section id="id24">
<h4>GTID复制 -&gt; 传统复制<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>主从上同时修改enforce_gtid_consistency=warn，确保在error log中不会出现警告信息
set global enforce_gtid_consistency=warn;
show variables like &quot;%gtid_consistency%&quot;;

主从上同时把enforce_gtid_consistency改为on，保证gtid一致性
set global enforce_gtid_consistency=on;

主从服务器上同时调整gtid_mode为off_permissive
set global gtid_mode=off_permissive;

主从服务器上同时调整gtid_mode为on_permissive
set global gtid_mode=on_permissive;

show variables like &quot;%gtid_mode%&quot;;
确认从库ongoing_anonymous_transaction_count参数是否为0，若为0，代表没有等待的事务，可以进行下一步了

show global status like &quot;%ongoing_anonymous_transaction_count%&quot;;
主从服务器上同时设置gtid_mode=on
set global gtid_mode=on;

把传统复制改为gtid，需要把原有传统复制停止，再执行change master to master_auto_position=1
stop slave;
change master to master_auto_position=1;
start slave;
show slave status\G
检查：若gtid值增加，则说明gtid复制成功
</pre></div>
</div>
</section>
<section id="id25">
<h4>GTID使用中的限制<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h4>
<p>GTID是针对事务来说的，一个事务对应一个GTID</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1）不能使用create table table_name select * from table_name
2）在一个事务中既包含事务表的操作又包含非事务表的操作
3）不支持create temporary table、drop temporary table语句
4）使用GTID复制从库跳过错误时，不支持执行sql_slave_skip_counter参数
</pre></div>
</div>
</section>
</section>
</section>
<section id="id26">
<h2><a class="toc-backref" href="#id52"><span class="section-number">3.2.6. </span>多源复制</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h2>
<p>把多台主库数据同步到一台从库上，从库会创建通往每个主库的管道。多源复制在5.7版本上新增，它的搭建模式支持gtid和binlog+position方式
<img alt="image2" src="../../_images/mysql_duozhuyicong001.png" /></p>
<p>多源复制优势：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1）可以集中备份，在从库上备份，不影响线上数据库正常运行
2）节约从库成本，只需一个服务器即可
3）数据都汇总在一起，方便后期做数据统计
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>搭建中注意事项：

MasterA和MasterB不能拥有相同的数据库名，否则会在从库出现数据覆盖现象

MasterA-&gt;slave与MasterB-&gt;slave要拥有不同的复制帐号

三台机器的数据库参数跟gtid复制一样，保证开启gtid，server-id不一致，binlog格式为row

从库需要配置参数，主从间复制信息要记录到表中
master_info_repository=table
relay_log_info_repository=table
</pre></div>
</div>
<section id="id27">
<h3><a class="toc-backref" href="#id53">基于GTID的多源复制搭建过程</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1）分别在MasterA和MasterB上创建复制帐号
A：
create user &#39;bak&#39;@&#39;192.168.10.%&#39; identified by &#39;bak123&#39;;
grant replication slave on *.* to &#39;bak&#39;@&#39;192.168.10.%&#39;;
flush privileges;
B:
create user &#39;repl&#39;@&#39;192.168.10.%&#39; identified by &#39;repl123&#39;;
grant replication slave on *.* to &#39;repl&#39;@&#39;192.168.10.%&#39;;
flush privileges;


2）分别在A/B上使用mysqldump导出需要备份的tzy库和zs库
A:
mysqldump -uroot -proot123 --master-data=2 --single-transaction --set-gtid-purged=OFF tzy &gt; /root/tzy.sql
B:
mysqldump -uroot -proot123 --master-data=2 --single-transaction --set-gtid-purged=OFF zs &gt; /root/zs.sql


3）从库开启参数
master_info_repository=table
relay_log_info_repository=table


4）在从库上进行数据库的恢复操作
scp tzy.sql root@192.168.10.120:/root
scp zs.sql root@192.168.10.120:/root
mysql -uroot -proot123 tzy &lt;tzy.sql
mysql -uroot -proot123 zs &lt;zs.sql


5）在从库上分别配置MasterA-&gt;slave MasterB-&gt;slave的同步过程
忽略部分库
##建议配置文件中添加replicate_ignore_db=
stop slave sql_thread;
change replication filter replicate_do_db=(db_list) replication_ignore_db=(db_list)  #不需要重启
start slave sql_thread;
change replication filter需要super权限
##
change master to
master_host=&#39;192.168.10.110&#39;,
master_user=&#39;bak&#39;,
master_password=&#39;bak123&#39;,
master_auto_position=1 for channel &#39;m1&#39;;
change master to
master_host=&#39;192.168.10.130&#39;,
master_user=&#39;repl&#39;,
master_password=&#39;repl123&#39;,
master_auto_position=1 for channel &#39;m2&#39;;
这里定义两个从库通往主库的通道，m1和m2


6）开启主从复制，可以通过start slave开启所有复制，也可以通过start slave for channel来分别开启
start slave for channel &#39;m1&#39;;
start slave for channel &#39;m2&#39;;

查看状态
show slave status\G
show slave status for channel &#39;m1&#39;\G
show slave status for channel &#39;m2&#39;\G
performance_schema库下replication_connection_configuration记录复制配置信息；replication_connection_status表记录主从复制状态
start/stop slave for channel &#39;name&#39;; 启动/关闭某个通道的复制
reset slave all for channel &#39;name&#39;; 重置某个通道的复制
</pre></div>
</div>
<p>跳过一步</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>传统复制：
stop slave;
set global sql_slave_skip_counter = 1;
start slave;
show slave status;

gtid复制：
首先找到gtid点
show slave status\G
Retrieved_Gtid_Set: cfc0499d-8109-11e8-89cc-000c29014dc0:1-9  #将要执行的事务
Executed_Gtid_Set: 99af9b61-8109-11e8-9b9e-000c297d2b33:1-7:9 #已经执行的事务

#将要执行事务1-9，已经执行1-7:9，已经从事务1执行到了事务7，报错了，说明是在执行事务8的时候，所以这里把事务8设置成空事务
#也可以到相应主库在查看事务8内容，确认是不是和报错的语句对应

#show binary logs;  查看binlog文件名

#show binlog events; 显示二进制日志内事件，默认为第一个日志文件

#show binlog events in &#39;mysql-binlog.000001&#39;;  查看指定文件

#语法：show binlog events [in &#39;log_name&#39;] [from pos] [limit [offset,] row_count]
stop slave;
set gtid_next=&#39;cfc0499d-8109-11e8-89cc-000c29014dc0:8&#39;;
begin;commit;
set gtid_next=&#39;automatic&#39;;
</pre></div>
</div>
</section>
</section>
<section id="id28">
<h2><a class="toc-backref" href="#id54"><span class="section-number">3.2.7. </span>总结</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h2>
<p>生产环境中建议使用GTID+rows复制模式，直接根据GTID找到同步的位置，不需要再去查找binlog和position的位置。
对于维护主从架构太方便了，MySQL的复制也是为了后期的高可用集群架构做准备。</p>
<p>参考文献如下： <a class="reference external" href="https://pdf.us/2018/07/05/1494.html">https://pdf.us/2018/07/05/1494.html</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="01.%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%A6%82%E8%BF%B0.html" class="btn btn-neutral float-left" title="3.1. 01.主从复制概述" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../04.%E5%B0%8A%E8%B4%B5%E7%9A%84%E9%93%82%E9%87%91%E7%AF%87/index.html" class="btn btn-neutral float-right" title="4. 04.尊贵的铂金篇" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>