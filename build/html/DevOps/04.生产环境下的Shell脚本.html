<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4. 生产环境下的Shell脚本 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. 工作中的Python脚本分享" href="05.%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84Python%E8%84%9A%E6%9C%AC%E5%88%86%E4%BA%AB.html" />
    <link rel="prev" title="3. Python在Devops与自动化运维中的应用" href="03.Python%E5%9C%A8Devops%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> 小健_Linux-shell-Devops_Blog
            <img src="../_static/devops_photo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">DevOps和自动化运维实践</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01.Devops%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E7%9A%84%E6%84%8F%E4%B9%89.html">1. Devops与自动化运维的意义</a></li>
<li class="toctree-l2"><a class="reference internal" href="02.Shell%E8%84%9A%E6%9C%AC%E5%9C%A8Devops%E4%B8%8B%E7%9A%84%E5%BA%94%E7%94%A8.html">2. Shell脚本在Devops下的应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="03.Python%E5%9C%A8Devops%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8.html">3. Python在Devops与自动化运维中的应用</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4. 生产环境下的Shell脚本</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">4.1. 1.生产环境下的备份类脚本</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#svn">4.1.1. <strong>1.1 版本控制软件SVN的代码库的备份脚本</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="#mysqls3">4.1.2. <strong>1.2 Mysql数据库备份至S3文件系统</strong></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id2">4.2. 2.生产环境下的统计类脚本</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">4.2.1. <strong>2.1 统计设备资产明细脚本</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">4.2.2. <strong>2.2 统计重要业务程序是否正常运行</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="#ip">4.2.3. <strong>2.3 统计机器的IP连接数</strong></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id5">4.3. 3.生产环境下的监控类脚本</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#nginxnginx">4.3.1. <strong>3.1 在Nginx负载均衡器上监控Nginx进程的脚本</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">4.3.2. <strong>3.2 系统文件数打开监控脚本</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="#cpu">4.3.3. <strong>3.3 监控机器CPU利用率脚本</strong></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">4.4. 4. 生产环境下运维开发类脚本</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">4.4.1. <strong>4.1 系统初始化脚本</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">4.4.2. <strong>4.2 控制shell多进程数量的脚本</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="#ansible">4.4.3. <strong>4.3 调用Ansible来分发多条线路的配置</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="#raid">4.4.4. <strong>4.4 手动建立软Raid级别需求</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">4.4.5. <strong>4.5 重载或更新机器路由配置</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="05.%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84Python%E8%84%9A%E6%9C%AC%E5%88%86%E4%BA%AB.html">5. 工作中的Python脚本分享</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.%E5%88%A9%E7%94%A8Docker%E6%90%AD%E5%BB%BAJenkines-Master-Slave%E5%88%86%E5%B8%83%E5%BC%8F%E7%8E%AF%E5%A2%83.html">6. 利用Docker搭建Jenkines-Master-Slave分布式环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.GitLab%E5%9C%A8DevOps%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8.html">7. GitLab在DevOps工作中的实际应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="08.%E7%94%A8Gunicorn%E9%83%A8%E7%BD%B2%E9%AB%98%E6%80%A7%E8%83%BDPython-WSGI%E6%9C%8D%E5%8A%A1%E5%99%A8.html">8. 用Gunicorn部署高性能Python-WSGI服务器</a></li>
<li class="toctree-l2"><a class="reference internal" href="09.Supervisor%E5%9C%A8DevOps%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8.html">9. Supervisor在DevOps中的应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="10.%E5%88%86%E5%B8%83%E5%BC%8F%E9%98%9F%E5%88%97%E7%AE%A1%E7%90%86Cerely.html">10. 分布式队列管理Cerely</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Github/index.html">Github入门到实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Jenkins/index.html">Jenkins持续化集成</a></li>
<li class="toctree-l1"><a class="reference internal" href="../KVM/index.html">KVM实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Linux/index.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Mysql/index.html">Mysql王者之路</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/index.html">Other</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Network_route_switch/index.html">Network_route_switch</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">小健_Linux-shell-Devops_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">DevOps和自动化运维实践</a> &raquo;</li>
      <li><span class="section-number">4. </span>生产环境下的Shell脚本</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/DevOps/04.生产环境下的Shell脚本.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#shell" id="id11">生产环境下的Shell脚本</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id12">1.生产环境下的备份类脚本</a></p>
<ul>
<li><p><a class="reference internal" href="#svn" id="id13"><strong>1.1 版本控制软件SVN的代码库的备份脚本</strong></a></p></li>
<li><p><a class="reference internal" href="#mysqls3" id="id14"><strong>1.2 Mysql数据库备份至S3文件系统</strong></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id2" id="id15">2.生产环境下的统计类脚本</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id16"><strong>2.1 统计设备资产明细脚本</strong></a></p></li>
<li><p><a class="reference internal" href="#id4" id="id17"><strong>2.2 统计重要业务程序是否正常运行</strong></a></p></li>
<li><p><a class="reference internal" href="#ip" id="id18"><strong>2.3 统计机器的IP连接数</strong></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id5" id="id19">3.生产环境下的监控类脚本</a></p>
<ul>
<li><p><a class="reference internal" href="#nginxnginx" id="id20"><strong>3.1 在Nginx负载均衡器上监控Nginx进程的脚本</strong></a></p></li>
<li><p><a class="reference internal" href="#id6" id="id21"><strong>3.2 系统文件数打开监控脚本</strong></a></p></li>
<li><p><a class="reference internal" href="#cpu" id="id22"><strong>3.3 监控机器CPU利用率脚本</strong></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id7" id="id23">4. 生产环境下运维开发类脚本</a></p>
<ul>
<li><p><a class="reference internal" href="#id8" id="id24"><strong>4.1 系统初始化脚本</strong></a></p></li>
<li><p><a class="reference internal" href="#id9" id="id25"><strong>4.2 控制shell多进程数量的脚本</strong></a></p></li>
<li><p><a class="reference internal" href="#ansible" id="id26"><strong>4.3 调用Ansible来分发多条线路的配置</strong></a></p></li>
<li><p><a class="reference internal" href="#raid" id="id27"><strong>4.4 手动建立软Raid级别需求</strong></a></p></li>
<li><p><a class="reference internal" href="#id10" id="id28"><strong>4.5 重载或更新机器路由配置</strong></a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="shell">
<h1><a class="toc-backref" href="#id11"><span class="section-number">4. </span>生产环境下的Shell脚本</a><a class="headerlink" href="#shell" title="Permalink to this headline">¶</a></h1>
<section id="id1">
<h2><a class="toc-backref" href="#id12"><span class="section-number">4.1. </span>1.生产环境下的备份类脚本</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<section id="svn">
<h3><a class="toc-backref" href="#id13"><span class="section-number">4.1.1. </span><strong>1.1 版本控制软件SVN的代码库的备份脚本</strong></a><a class="headerlink" href="#svn" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="nv">SVNDIR</span><span class="o">=</span>/data/svn
<span class="nv">SVNADMIN</span><span class="o">=</span>/usr/bin/svnadmin
<span class="nv">DATE</span><span class="o">=</span><span class="sb">`</span>date +%Y-%m-%d<span class="sb">`</span>
<span class="nv">OLDDATE</span><span class="o">=</span><span class="sb">`</span>date +%Y-%m-%d -d <span class="s1">&#39;30 days&#39;</span><span class="sb">`</span>
<span class="nv">BACKDIR</span><span class="o">=</span>/data/backup/svn-backup

<span class="o">[</span> -d <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span> <span class="o">]</span> <span class="o">||</span> mkdir -p <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>
<span class="nv">LogFile</span><span class="o">=</span><span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/svnbak.log
<span class="o">[</span> -f <span class="si">${</span><span class="nv">LogFile</span><span class="si">}</span> <span class="o">]</span> <span class="o">||</span> touch <span class="si">${</span><span class="nv">LogFile</span><span class="si">}</span>
mkdir <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>


<span class="k">for</span> PROJECT <span class="k">in</span> myproject official analysis mypharma
<span class="k">do</span>
  <span class="nb">cd</span> <span class="nv">$SVNDIR</span>
  <span class="nv">$SVNADMIN</span> hotcopy <span class="nv">$PROJECT</span>  <span class="nv">$BACKDIR</span>/<span class="nv">$DATE</span>/<span class="nv">$PROJECT</span> --clean-logs
  <span class="nb">cd</span> <span class="nv">$BACKDIR</span>/<span class="nv">$DATE</span>
  tar zcvf <span class="si">${</span><span class="nv">PROJECT</span><span class="si">}</span>_svn_<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>.tar.gz <span class="nv">$PROJECT</span>  &gt; /dev/null
  rm -rf <span class="nv">$PROJECT</span>
sleep <span class="m">2</span>
<span class="k">done</span>

<span class="nv">HOST</span><span class="o">=</span><span class="m">192</span>.168.2.112
<span class="nv">FTP_USERNAME</span><span class="o">=</span>svn
<span class="nv">FTP_PASSWORD</span><span class="o">=</span>svn101

<span class="nb">cd</span> <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>

ftp -i -n -v &lt;&lt; !
open <span class="si">${</span><span class="nv">HOST</span><span class="si">}</span>
user <span class="si">${</span><span class="nv">FTP_USERNAME</span><span class="si">}</span> <span class="si">${</span><span class="nv">FTP_PASSWORD</span><span class="si">}</span>
bin
<span class="nb">cd</span> <span class="si">${</span><span class="nv">OLDDATE</span><span class="si">}</span>
mdelete *
<span class="nb">cd</span> ..
rmdir <span class="si">${</span><span class="nv">OLDDATE</span><span class="si">}</span>
mkdir <span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>
<span class="nb">cd</span> <span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>
mput *
bye
!
</pre></div>
</div>
</section>
<section id="mysqls3">
<h3><a class="toc-backref" href="#id14"><span class="section-number">4.1.2. </span><strong>1.2 Mysql数据库备份至S3文件系统</strong></a><a class="headerlink" href="#mysqls3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#</span>
<span class="c1"># Filename:</span>
<span class="c1"># backupdatabase.sh</span>
<span class="c1"># Description:</span>
<span class="c1"># backup cms database and remove backup data before 7 days</span>
<span class="c1"># crontab</span>
<span class="c1"># 55 23 * * * /bin/sh /yundisk/cms/crontab/backupdatabase.sh &gt;&gt; /yundisk/cms/crontab/backupdatabase.log 2&gt;&amp;1</span>

<span class="nv">DATE</span><span class="o">=</span><span class="sb">`</span>date +%Y-%m-%d<span class="sb">`</span>
<span class="nv">OLDDATE</span><span class="o">=</span><span class="sb">`</span>date +%Y-%m-%d -d <span class="s1">&#39;-7 days&#39;</span><span class="sb">`</span>

<span class="c1">#MYSQL=/usr/local/mysql/bin/mysql</span>
<span class="c1">#MYSQLDUMP=/usr/local/mysql/bin/mysqldump</span>
<span class="c1">#MYSQLADMIN=/usr/local/mysql/bin/mysqladmin</span>

<span class="nv">BACKDIR</span><span class="o">=</span>/yundisk/cms/database
<span class="o">[</span> -d <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span> <span class="o">]</span> <span class="o">||</span> mkdir -p <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>
<span class="o">[</span> -d <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span> <span class="o">]</span> <span class="o">||</span> mkdir <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>
<span class="o">[</span> ! -d <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">OLDDATE</span><span class="si">}</span> <span class="o">]</span> <span class="o">||</span> rm -rf <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">OLDDATE</span><span class="si">}</span>

mysqldump --default-character-set<span class="o">=</span>utf8 --no-autocommit --quick --hex-blob --single-transaction -uroot  cms_production  <span class="p">|</span> gzip &gt; <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>/cms-backup-<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>.sql.gz
<span class="nb">echo</span> <span class="s2">&quot;Database cms_production and bbs has been backup successful&quot;</span>
/bin/sleep <span class="m">5</span>

aws s3 cp <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>/* s3://example-share/cms/databackup/
</pre></div>
</div>
</section>
</section>
<section id="id2">
<h2><a class="toc-backref" href="#id15"><span class="section-number">4.2. </span>2.生产环境下的统计类脚本</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<section id="id3">
<h3><a class="toc-backref" href="#id16"><span class="section-number">4.2.1. </span><strong>2.1 统计设备资产明细脚本</strong></a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#####get cpu info#####</span>
<span class="nv">cpu_num</span><span class="o">=</span><span class="sb">`</span>cat /proc/cpuinfo<span class="p">|</span> grep <span class="s2">&quot;physical id&quot;</span><span class="p">|</span> sort<span class="p">|</span> uniq<span class="p">|</span> wc -l<span class="sb">`</span>
<span class="nv">cpu_sum</span><span class="o">=</span><span class="sb">`</span>cat /proc/cpuinfo <span class="p">|</span>grep processor <span class="p">|</span>wc -l<span class="sb">`</span>
<span class="nv">cpu_hz</span><span class="o">=</span><span class="sb">`</span>cat /proc/cpuinfo <span class="p">|</span>grep <span class="s1">&#39;model name&#39;</span> <span class="p">|</span>uniq -c <span class="p">|</span>awk <span class="s1">&#39;{print $NF}&#39;</span><span class="sb">`</span>

<span class="c1">#####get mem info#####</span>
<span class="nv">mem_m</span><span class="o">=</span><span class="m">0</span>
<span class="k">for</span> i <span class="k">in</span> <span class="sb">`</span>dmidecode -t memory <span class="p">|</span>grep Size: <span class="p">|</span>grep -v <span class="s2">&quot;No Module Installed&quot;</span> <span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
<span class="k">do</span>
    <span class="nv">mem_m</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$mem_m</span> + <span class="nv">$i</span><span class="sb">`</span>
<span class="k">done</span>
<span class="nv">mem_sum</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$mem_m</span> / <span class="m">1024</span> <span class="p">|</span> bc<span class="sb">`</span>

<span class="c1">#####get nic info#####</span>
<span class="nv">qian_num</span><span class="o">=</span><span class="sb">`</span>lspci <span class="p">|</span>grep Ethernet <span class="p">|</span>egrep -v <span class="s1">&#39;10-Gigabit|10 Gigabit&#39;</span> <span class="p">|</span>wc -l<span class="sb">`</span>
<span class="nv">wan_num</span><span class="o">=</span><span class="sb">`</span>lspci <span class="p">|</span>grep Ethernet <span class="p">|</span>egrep  <span class="s1">&#39;10-Gigabit|10 Gigabit&#39;</span> <span class="p">|</span>wc -l<span class="sb">`</span>

<span class="c1">#####get disk num#####</span>
<span class="nv">B</span><span class="o">=</span><span class="sb">`</span>date +%s<span class="sb">`</span>
<span class="nv">ssd_num</span><span class="o">=</span><span class="nv">0</span><span class="o">=</span>
<span class="nv">sata_num</span><span class="o">=</span><span class="m">0</span>
<span class="k">for</span> i <span class="k">in</span> <span class="sb">`</span>lsblk <span class="p">|</span>grep <span class="s2">&quot;disk&quot;</span><span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="p">|</span>egrep -v <span class="s2">&quot;ram&quot;</span><span class="p">|</span>sort<span class="sb">`</span><span class="p">;</span>
<span class="k">do</span>
    <span class="nv">code</span><span class="o">=</span><span class="sb">`</span>cat /sys/block/<span class="nv">$i</span>/queue/rotational<span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$code</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
       <span class="nv">ssd_num</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$ssd_num</span> + <span class="m">1</span><span class="sb">`</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$i</span> &gt;&gt;/tmp/<span class="nv">$B</span>.ssd
    <span class="k">else</span>
       <span class="nv">sata_num</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$sata_num</span> + <span class="m">1</span><span class="sb">`</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$i</span> &gt;&gt;/tmp/<span class="nv">$B</span>.sata
    <span class="k">fi</span>
<span class="k">done</span>

<span class="c1">#####get disk sum#####</span>
<span class="nv">C</span><span class="o">=</span><span class="sb">`</span>date +%N<span class="sb">`</span>
<span class="nv">ssd_sum</span><span class="o">=</span><span class="m">0</span>
<span class="nv">sata_sum</span><span class="o">=</span><span class="m">0</span>
<span class="k">if</span> <span class="o">[</span> -f /tmp/<span class="nv">$B</span>.ssd <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    <span class="k">for</span> n <span class="k">in</span> <span class="sb">`</span>cat /tmp/<span class="nv">$B</span>.ssd<span class="sb">`</span><span class="p">;</span><span class="k">do</span>
        fdisk -l /dev/<span class="nv">$n</span> &gt;&gt;/tmp/<span class="nv">$C</span>.ssd <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
        <span class="k">for</span> x <span class="k">in</span> <span class="sb">`</span>grep <span class="s2">&quot;Disk /dev&quot;</span> /tmp/<span class="nv">$C</span>.ssd <span class="p">|</span>awk <span class="s1">&#39;{print $3}&#39;</span><span class="sb">`</span><span class="p">;</span><span class="k">do</span>
            <span class="nv">u</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$x</span> / <span class="m">1</span><span class="p">|</span>bc<span class="sb">`</span>
        <span class="k">done</span>
     <span class="nv">ssd_sum</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$ssd_sum</span> + <span class="nv">$u</span> + <span class="m">1</span><span class="sb">`</span>
    <span class="k">done</span>
<span class="k">fi</span>

<span class="k">for</span> m <span class="k">in</span> <span class="sb">`</span>cat /tmp/<span class="nv">$B</span>.sata<span class="sb">`</span><span class="p">;</span><span class="k">do</span>
   fdisk -l /dev/<span class="nv">$m</span> &gt;&gt;/tmp/<span class="nv">$C</span>.sata <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
   <span class="k">for</span> y <span class="k">in</span> <span class="sb">`</span>grep <span class="s2">&quot;Disk /dev&quot;</span> /tmp/<span class="nv">$C</span>.sata <span class="p">|</span>awk <span class="s1">&#39;{print $3}&#39;</span><span class="sb">`</span><span class="p">;</span><span class="k">do</span>
      <span class="nv">v</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$y</span> / <span class="m">1</span><span class="p">|</span>bc<span class="sb">`</span>
   <span class="k">done</span>
   <span class="nv">sata_sum</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$sata_sum</span> + <span class="nv">$v</span> + <span class="m">1</span><span class="sb">`</span>
<span class="k">done</span>

<span class="c1">#####show dev info#####</span>
<span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$ip</span><span class="s2"> `hostname` </span><span class="nv">$plat</span><span class="s2"> </span><span class="nv">$pop</span><span class="s2"> </span><span class="nv">$prov</span><span class="s2"> &quot;</span>
<span class="nb">echo</span> -n <span class="s2">&quot;CPU(物理核数,逻辑核数,频率): </span><span class="nv">$cpu_num</span><span class="s2"> </span><span class="nv">$cpu_sum</span><span class="s2"> </span><span class="nv">$cpu_hz</span><span class="s2"> &quot;</span>
<span class="nb">echo</span> -n <span class="s2">&quot;内存(GB): </span><span class="nv">$mem_sum</span><span class="s2"> &quot;</span>
<span class="nb">echo</span> -n <span class="s2">&quot;网卡数量(千兆,万兆): </span><span class="nv">$qian_num</span><span class="s2"> </span><span class="nv">$wan_num</span><span class="s2"> &quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;SSD数量: </span><span class="si">${</span><span class="nv">ssd_num</span><span class="si">}</span><span class="s2"> SSD容量: </span><span class="si">${</span><span class="nv">ssd_sum</span><span class="si">}</span><span class="s2">GB SATA数量: </span><span class="si">${</span><span class="nv">sata_num</span><span class="si">}</span><span class="s2"> SATA容量 </span><span class="si">${</span><span class="nv">sata_sum</span><span class="si">}</span><span class="s2">GB &quot;</span>
</pre></div>
</div>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id17"><span class="section-number">4.2.2. </span><strong>2.2 统计重要业务程序是否正常运行</strong></a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">sync_redis_status</span><span class="o">=</span><span class="sb">`</span>ps aux <span class="p">|</span> grep sync_redis.py <span class="p">|</span> grep -v grep <span class="p">|</span> wc -l <span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">sync_redis_status</span><span class="si">}</span> !<span class="o">=</span> <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Critical! sync_redis is Died&quot;</span>
    <span class="nb">exit</span> <span class="m">2</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;OK! sync_redis is Alive&quot;</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>
</pre></div>
</div>
</section>
<section id="ip">
<h3><a class="toc-backref" href="#id18"><span class="section-number">4.2.3. </span><strong>2.3 统计机器的IP连接数</strong></a><a class="headerlink" href="#ip" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#脚本的$1和$2报警阀值可以根据业务的实际情况调整。</span>
<span class="c1">#$1 = 15000，$2 = 20000</span>
<span class="nv">ip_conns</span><span class="o">=</span><span class="sb">`</span>netstat -an <span class="p">|</span> grep tcp <span class="p">|</span> grep EST <span class="p">|</span> wc -l<span class="sb">`</span>
<span class="nv">messages</span><span class="o">=</span><span class="sb">`</span>netstat -ant <span class="p">|</span> awk <span class="s1">&#39;/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}&#39;</span><span class="p">|</span>tr -s <span class="s1">&#39;\n&#39;</span> <span class="s1">&#39;,&#39;</span> <span class="p">|</span> sed -r <span class="s1">&#39;s/(.*),/\1\n/g&#39;</span> <span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$ip_conns</span> -lt <span class="nv">$1</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$messages</span><span class="s2">,OK -connect counts is </span><span class="nv">$ip_conns</span><span class="s2">&quot;</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$ip_conns</span> -gt <span class="nv">$1</span> -a <span class="nv">$ip_conns</span> -lt <span class="nv">$2</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$messages</span><span class="s2">,Warning -connect counts is </span><span class="nv">$ip_conns</span><span class="s2">&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$ip_conns</span> -gt <span class="nv">$2</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$messages</span><span class="s2">,Critical -connect counts is </span><span class="nv">$ip_conns</span><span class="s2">&quot;</span>
    <span class="nb">exit</span> <span class="m">2</span>
<span class="k">fi</span>
</pre></div>
</div>
</section>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id19"><span class="section-number">4.3. </span>3.生产环境下的监控类脚本</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<section id="nginxnginx">
<h3><a class="toc-backref" href="#id20"><span class="section-number">4.3.1. </span><strong>3.1 在Nginx负载均衡器上监控Nginx进程的脚本</strong></a><a class="headerlink" href="#nginxnginx" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="k">while</span> :
<span class="k">do</span>
 <span class="nv">nginxpid</span><span class="o">=</span><span class="sb">`</span>ps -C nginx --no-header <span class="p">|</span> wc -l<span class="sb">`</span>
 <span class="k">if</span> <span class="o">[</span> <span class="nv">$nginxpid</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    <span class="nb">ulimit</span> -SHn <span class="m">65535</span>
    /usr/local/nginx/sbin/nginx
    sleep <span class="m">5</span>
   <span class="k">if</span> <span class="o">[</span> <span class="nv">$nginxpid</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
     /etc/init.d/keepalived stop
   <span class="k">fi</span>
 <span class="k">fi</span>
 sleep <span class="m">5</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3><a class="toc-backref" href="#id21"><span class="section-number">4.3.2. </span><strong>3.2 系统文件数打开监控脚本</strong></a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="k">for</span> pid <span class="k">in</span> <span class="sb">`</span>ps aux <span class="p">|</span>grep nginx <span class="p">|</span>grep -v grep<span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
<span class="k">do</span>
cat /proc/<span class="si">${</span><span class="nv">pid</span><span class="si">}</span>/limits <span class="p">|</span> grep <span class="s1">&#39;Max open files&#39;</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="cpu">
<h3><a class="toc-backref" href="#id22"><span class="section-number">4.3.3. </span><strong>3.3 监控机器CPU利用率脚本</strong></a><a class="headerlink" href="#cpu" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># CPU Utilization Statistics plugin for Nagios</span>
<span class="c1">#</span>
<span class="c1"># USAGE     :   ./check_cpu_utili.sh [-w &lt;user,system,iowait&gt;] [-c &lt;user,system,iowait&gt;] ( [ -i &lt;intervals in second&gt; ] [ -n &lt;report number&gt; ])</span>
<span class="c1">#</span>
<span class="c1"># Exemple: ./check_cpu_utili.sh</span>
<span class="c1">#          ./check_cpu_utili.sh -w 70,40,30 -c 90,60,40</span>
<span class="c1">#          ./check_cpu_utili.sh -w 70,40,30 -c 90,60,40 -i 3 -n 5</span>
<span class="c1"># Paths to commands used in this script.  These may have to be modified to match your system setup.</span>
<span class="nv">IOSTAT</span><span class="o">=</span><span class="s2">&quot;/usr/bin/iostat&quot;</span>

<span class="c1"># Nagios return codes</span>
<span class="nv">STATE_OK</span><span class="o">=</span><span class="m">0</span>
<span class="nv">STATE_WARNING</span><span class="o">=</span><span class="m">1</span>
<span class="nv">STATE_CRITICAL</span><span class="o">=</span><span class="m">2</span>
<span class="nv">STATE_UNKNOWN</span><span class="o">=</span><span class="m">3</span>

<span class="c1"># Plugin parameters value if not define</span>
<span class="nv">LIST_WARNING_THRESHOLD</span><span class="o">=</span><span class="s2">&quot;70,40,30&quot;</span>
<span class="nv">LIST_CRITICAL_THRESHOLD</span><span class="o">=</span><span class="s2">&quot;90,60,40&quot;</span>
<span class="nv">INTERVAL_SEC</span><span class="o">=</span><span class="m">1</span>
<span class="nv">NUM_REPORT</span><span class="o">=</span><span class="m">1</span>
<span class="c1"># Plugin variable description</span>
<span class="nv">PROGNAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$0</span><span class="k">)</span>

<span class="k">if</span> <span class="o">[</span> ! -x <span class="nv">$IOSTAT</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;UNKNOWN: iostat not found or is not executable by the nagios user.&quot;</span>
    <span class="nb">exit</span> <span class="nv">$STATE_UNKNOWN</span>
<span class="k">fi</span>

print_usage<span class="o">()</span> <span class="o">{</span>
        <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$PROGNAME</span><span class="s2"> </span><span class="nv">$RELEASE</span><span class="s2"> - CPU Utilization check script for Nagios&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Usage: check_cpu_utili.sh -w -c (-i -n)&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;  -w  Warning threshold in % for warn_user,warn_system,warn_iowait CPU (default : 70,40,30)&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;  Exit with WARNING status if cpu exceeds warn_n&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;  -c  Critical threshold in % for crit_user,crit_system,crit_iowait CPU (default : 90,60,40)&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;  Exit with CRITICAL status if cpu exceeds crit_n&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;  -i  Interval in seconds for iostat (default : 1)&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;  -n  Number report for iostat (default : 3)&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;  -h  Show this page&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="nv">$PROGNAME</span><span class="s2">&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="nv">$PROGNAME</span><span class="s2"> --help&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="o">}</span>

print_help<span class="o">()</span> <span class="o">{</span>
    print_usage
        <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;This plugin will check cpu utilization (user,system,CPU_Iowait in %)&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="o">}</span>

<span class="c1"># Parse parameters</span>
<span class="k">while</span> <span class="o">[</span> <span class="nv">$#</span> -gt <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
        -h <span class="p">|</span> --help<span class="o">)</span>
            print_help
            <span class="nb">exit</span> <span class="nv">$STATE_OK</span>
            <span class="p">;;</span>
        -v <span class="p">|</span> --version<span class="o">)</span>
                print_release
                <span class="nb">exit</span> <span class="nv">$STATE_OK</span>
                <span class="p">;;</span>
        -w <span class="p">|</span> --warning<span class="o">)</span>
                <span class="nb">shift</span>
                <span class="nv">LIST_WARNING_THRESHOLD</span><span class="o">=</span><span class="nv">$1</span>
                <span class="p">;;</span>
        -c <span class="p">|</span> --critical<span class="o">)</span>
               <span class="nb">shift</span>
                <span class="nv">LIST_CRITICAL_THRESHOLD</span><span class="o">=</span><span class="nv">$1</span>
                <span class="p">;;</span>
        -i <span class="p">|</span> --interval<span class="o">)</span>
               <span class="nb">shift</span>
               <span class="nv">INTERVAL_SEC</span><span class="o">=</span><span class="nv">$1</span>
                <span class="p">;;</span>
        -n <span class="p">|</span> --number<span class="o">)</span>
               <span class="nb">shift</span>
               <span class="nv">NUM_REPORT</span><span class="o">=</span><span class="nv">$1</span>
                <span class="p">;;</span>
        *<span class="o">)</span>  <span class="nb">echo</span> <span class="s2">&quot;Unknown argument: </span><span class="nv">$1</span><span class="s2">&quot;</span>
            print_usage
            <span class="nb">exit</span> <span class="nv">$STATE_UNKNOWN</span>
            <span class="p">;;</span>
        <span class="k">esac</span>
<span class="nb">shift</span>
<span class="k">done</span>

<span class="c1"># List to Table for warning threshold (compatibility with</span>
<span class="nv">TAB_WARNING_THRESHOLD</span><span class="o">=(</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$LIST_WARNING_THRESHOLD</span> <span class="p">|</span> sed <span class="s1">&#39;s/,/ /g&#39;</span><span class="sb">`</span><span class="o">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${#</span><span class="nv">TAB_WARNING_THRESHOLD</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span> -ne <span class="s2">&quot;3&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;ERROR : Bad count parameter in Warning Threshold&quot;</span>
  <span class="nb">exit</span> <span class="nv">$STATE_WARNING</span>
<span class="k">else</span>
<span class="nv">USER_WARNING_THRESHOLD</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">TAB_WARNING_THRESHOLD</span><span class="p">[0]</span><span class="si">}</span><span class="sb">`</span>
<span class="nv">SYSTEM_WARNING_THRESHOLD</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">TAB_WARNING_THRESHOLD</span><span class="p">[1]</span><span class="si">}</span><span class="sb">`</span>
<span class="nv">IOWAIT_WARNING_THRESHOLD</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">TAB_WARNING_THRESHOLD</span><span class="p">[2]</span><span class="si">}</span><span class="sb">`</span>
<span class="k">fi</span>

<span class="c1"># List to Table for critical threshold</span>
<span class="nv">TAB_CRITICAL_THRESHOLD</span><span class="o">=(</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$LIST_CRITICAL_THRESHOLD</span> <span class="p">|</span> sed <span class="s1">&#39;s/,/ /g&#39;</span><span class="sb">`</span><span class="o">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${#</span><span class="nv">TAB_CRITICAL_THRESHOLD</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span> -ne <span class="s2">&quot;3&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;ERROR : Bad count parameter in CRITICAL Threshold&quot;</span>
  <span class="nb">exit</span> <span class="nv">$STATE_WARNING</span>
<span class="k">else</span>
<span class="nv">USER_CRITICAL_THRESHOLD</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">TAB_CRITICAL_THRESHOLD</span><span class="p">[0]</span><span class="si">}</span><span class="sb">`</span>
<span class="nv">SYSTEM_CRITICAL_THRESHOLD</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">TAB_CRITICAL_THRESHOLD</span><span class="p">[1]</span><span class="si">}</span><span class="sb">`</span>
<span class="nv">IOWAIT_CRITICAL_THRESHOLD</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">TAB_CRITICAL_THRESHOLD</span><span class="p">[2]</span><span class="si">}</span><span class="sb">`</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">TAB_WARNING_THRESHOLD</span><span class="p">[0]</span><span class="si">}</span> -ge <span class="si">${</span><span class="nv">TAB_CRITICAL_THRESHOLD</span><span class="p">[0]</span><span class="si">}</span> -o <span class="si">${</span><span class="nv">TAB_WARNING_THRESHOLD</span><span class="p">[1]</span><span class="si">}</span> -ge <span class="si">${</span><span class="nv">TAB_CRITICAL_THRESHOLD</span><span class="p">[1]</span><span class="si">}</span> -o <span class="si">${</span><span class="nv">TAB_WARNING_THRESHOLD</span><span class="p">[2]</span><span class="si">}</span> -ge <span class="si">${</span><span class="nv">TAB_CRITICAL_THRESHOLD</span><span class="p">[2]</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;ERROR : Critical CPU Threshold lower as Warning CPU Threshold &quot;</span>
  <span class="nb">exit</span> <span class="nv">$STATE_WARNING</span>
<span class="k">fi</span>

<span class="nv">CPU_REPORT</span><span class="o">=</span><span class="sb">`</span>iostat -c <span class="nv">$INTERVAL_SEC</span> <span class="nv">$NUM_REPORT</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/,/./g&#39;</span> <span class="p">|</span> tr -s <span class="s1">&#39; &#39;</span> <span class="s1">&#39;;&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;/^$/d&#39;</span> <span class="p">|</span> tail -1<span class="sb">`</span>
<span class="nv">CPU_REPORT_SECTIONS</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">CPU_REPORT</span><span class="si">}</span> <span class="p">|</span> grep <span class="s1">&#39;;&#39;</span> -o <span class="p">|</span> wc -l<span class="sb">`</span>
<span class="nv">CPU_USER</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$CPU_REPORT</span> <span class="p">|</span> cut -d <span class="s2">&quot;;&quot;</span> -f <span class="m">2</span><span class="sb">`</span>
<span class="nv">CPU_SYSTEM</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$CPU_REPORT</span> <span class="p">|</span> cut -d <span class="s2">&quot;;&quot;</span> -f <span class="m">4</span><span class="sb">`</span>
<span class="nv">CPU_IOWAIT</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$CPU_REPORT</span> <span class="p">|</span> cut -d <span class="s2">&quot;;&quot;</span> -f <span class="m">5</span><span class="sb">`</span>
<span class="nv">CPU_STEAL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$CPU_REPORT</span> <span class="p">|</span> cut -d <span class="s2">&quot;;&quot;</span> -f <span class="m">6</span><span class="sb">`</span>
<span class="nv">CPU_IDLE</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$CPU_REPORT</span> <span class="p">|</span> cut -d <span class="s2">&quot;;&quot;</span> -f <span class="m">7</span><span class="sb">`</span>
<span class="nv">NAGIOS_STATUS</span><span class="o">=</span><span class="s2">&quot;user=</span><span class="si">${</span><span class="nv">CPU_USER</span><span class="si">}</span><span class="s2">%,system=</span><span class="si">${</span><span class="nv">CPU_SYSTEM</span><span class="si">}</span><span class="s2">%,iowait=</span><span class="si">${</span><span class="nv">CPU_IOWAIT</span><span class="si">}</span><span class="s2">%,idle=</span><span class="si">${</span><span class="nv">CPU_IDLE</span><span class="si">}</span><span class="s2">%&quot;</span>
<span class="nv">NAGIOS_DATA</span><span class="o">=</span><span class="s2">&quot;CpuUser=</span><span class="si">${</span><span class="nv">CPU_USER</span><span class="si">}</span><span class="s2">;</span><span class="si">${</span><span class="nv">TAB_WARNING_THRESHOLD</span><span class="p">[0]</span><span class="si">}</span><span class="s2">;</span><span class="si">${</span><span class="nv">TAB_CRITICAL_THRESHOLD</span><span class="p">[0]</span><span class="si">}</span><span class="s2">;0&quot;</span>

<span class="nv">CPU_USER_MAJOR</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$CPU_USER</span><span class="p">|</span> cut -d <span class="s2">&quot;.&quot;</span> -f <span class="m">1</span><span class="sb">`</span>
<span class="nv">CPU_SYSTEM_MAJOR</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$CPU_SYSTEM</span> <span class="p">|</span> cut -d <span class="s2">&quot;.&quot;</span> -f <span class="m">1</span><span class="sb">`</span>
<span class="nv">CPU_IOWAIT_MAJOR</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$CPU_IOWAIT</span> <span class="p">|</span> cut -d <span class="s2">&quot;.&quot;</span> -f <span class="m">1</span><span class="sb">`</span>
<span class="nv">CPU_IDLE_MAJOR</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$CPU_IDLE</span> <span class="p">|</span> cut -d <span class="s2">&quot;.&quot;</span> -f <span class="m">1</span><span class="sb">`</span>



<span class="c1"># Return</span>
<span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">CPU_USER_MAJOR</span><span class="si">}</span> -ge <span class="nv">$USER_CRITICAL_THRESHOLD</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;CPU STATISTICS OK:</span><span class="si">${</span><span class="nv">NAGIOS_STATUS</span><span class="si">}</span><span class="s2"> | CPU_USER=</span><span class="si">${</span><span class="nv">CPU_USER</span><span class="si">}</span><span class="s2">%;70;90;0;100&quot;</span>
        <span class="nb">exit</span> <span class="nv">$STATE_CRITICAL</span>
    <span class="k">elif</span> <span class="o">[</span> <span class="si">${</span><span class="nv">CPU_SYSTEM_MAJOR</span><span class="si">}</span> -ge <span class="nv">$SYSTEM_CRITICAL_THRESHOLD</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;CPU STATISTICS OK:</span><span class="si">${</span><span class="nv">NAGIOS_STATUS</span><span class="si">}</span><span class="s2"> | CPU_USER=</span><span class="si">${</span><span class="nv">CPU_USER</span><span class="si">}</span><span class="s2">%;70;90;0;100&quot;</span>
        <span class="nb">exit</span> <span class="nv">$STATE_CRITICAL</span>
    <span class="k">elif</span> <span class="o">[</span> <span class="si">${</span><span class="nv">CPU_IOWAIT_MAJOR</span><span class="si">}</span> -ge <span class="nv">$IOWAIT_CRITICAL_THRESHOLD</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;CPU STATISTICS OK:</span><span class="si">${</span><span class="nv">NAGIOS_STATUS</span><span class="si">}</span><span class="s2"> | CPU_USER=</span><span class="si">${</span><span class="nv">CPU_USER</span><span class="si">}</span><span class="s2">%;70;90;0;100&quot;</span>
        <span class="nb">exit</span> <span class="nv">$STATE_CRITICAL</span>
    <span class="k">elif</span> <span class="o">[</span> <span class="si">${</span><span class="nv">CPU_USER_MAJOR</span><span class="si">}</span> -ge <span class="nv">$USER_WARNING_THRESHOLD</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="si">${</span><span class="nv">CPU_USER_MAJOR</span><span class="si">}</span> -lt <span class="nv">$USER_CRITICAL_THRESHOLD</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;CPU STATISTICS OK:</span><span class="si">${</span><span class="nv">NAGIOS_STATUS</span><span class="si">}</span><span class="s2"> | CPU_USER=</span><span class="si">${</span><span class="nv">CPU_USER</span><span class="si">}</span><span class="s2">%;70;90;0;100&quot;</span>
        <span class="nb">exit</span> <span class="nv">$STATE_WARNING</span>
      <span class="k">elif</span> <span class="o">[</span> <span class="si">${</span><span class="nv">CPU_SYSTEM_MAJOR</span><span class="si">}</span> -ge <span class="nv">$SYSTEM_WARNING_THRESHOLD</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="si">${</span><span class="nv">CPU_SYSTEM_MAJOR</span><span class="si">}</span> -lt <span class="nv">$SYSTEM_CRITICAL_THRESHOLD</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;CPU STATISTICS OK:</span><span class="si">${</span><span class="nv">NAGIOS_STATUS</span><span class="si">}</span><span class="s2"> | CPU_USER=</span><span class="si">${</span><span class="nv">CPU_USER</span><span class="si">}</span><span class="s2">%;70;90;0;100&quot;</span>
        <span class="nb">exit</span> <span class="nv">$STATE_WARNING</span>
      <span class="k">elif</span>  <span class="o">[</span> <span class="si">${</span><span class="nv">CPU_IOWAIT_MAJOR</span><span class="si">}</span> -ge <span class="nv">$IOWAIT_WARNING_THRESHOLD</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="si">${</span><span class="nv">CPU_IOWAIT_MAJOR</span><span class="si">}</span> -lt <span class="nv">$IOWAIT_CRITICAL_THRESHOLD</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;CPU STATISTICS OK:</span><span class="si">${</span><span class="nv">NAGIOS_STATUS</span><span class="si">}</span><span class="s2"> | CPU_USER=</span><span class="si">${</span><span class="nv">CPU_USER</span><span class="si">}</span><span class="s2">%;70;90;0;100&quot;</span>
        <span class="nb">exit</span> <span class="nv">$STATE_WARNING</span>
<span class="k">else</span>

        <span class="nb">echo</span> <span class="s2">&quot;CPU STATISTICS OK:</span><span class="si">${</span><span class="nv">NAGIOS_STATUS</span><span class="si">}</span><span class="s2"> | CPU_USER=</span><span class="si">${</span><span class="nv">CPU_USER</span><span class="si">}</span><span class="s2">%;70;90;0;100&quot;</span>
        <span class="nb">exit</span> <span class="nv">$STATE_OK</span>
<span class="k">fi</span>
</pre></div>
</div>
</section>
</section>
<section id="id7">
<h2><a class="toc-backref" href="#id23"><span class="section-number">4.4. </span>4. 生产环境下运维开发类脚本</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<section id="id8">
<h3><a class="toc-backref" href="#id24"><span class="section-number">4.4.1. </span><strong>4.1 系统初始化脚本</strong></a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>系统初始化脚本用于新装Linux的相关配置工作，</p>
<p>比如禁掉iptables和SELinux及IPv6、优化系统内核、停掉一些没必要启动的系统服务等。</p>
<p>我们将系统初始化脚本应用于公司内部的运维开发机器的批量部署（比如用Ansible来下发）上。事实上，复杂的系统业务初始化initial脚本由于涉及了多条产品线和多个业务平台，因此远比这里列出的开发环境下的初始化脚本复杂得多，而且其代码量也极大，基本上都是6000～7000行的Shell脚本，各功能模块以函数的形式进行封装。下面的脚本只是涉及一些基础部分，希望大家注意这点。脚本代码如下所示（此脚本已在CentOS
6.8 x86_x64下测试通过）：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#添加epel外部yum扩展源</span>
<span class="nb">cd</span> /usr/local/src
wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
rpm -ivh epel-release-6-8.noarch.rpm

<span class="c1">#安装gcc基础库文件以及sysstat工具</span>
yum -y install gcc gcc-c++ vim-enhanced unzip unrar sysstat

<span class="c1">#配置ntpdate自动对时</span>
yum -y install ntp
<span class="nb">echo</span> <span class="s2">&quot;01 01 * * * /usr/sbin/ntpdate ntp.api.bz    &gt;&gt; /dev/null 2&gt;&amp;1&quot;</span> &gt;&gt; /etc/crontab
ntpdate ntp.api.bz
service crond restart

<span class="c1">#配置文件的ulimit值</span>
<span class="nb">ulimit</span> -SHn <span class="m">65535</span>
<span class="nb">echo</span> <span class="s2">&quot;ulimit -SHn 65535&quot;</span> &gt;&gt; /etc/rc.local
cat &gt;&gt; /etc/security/limits.conf <span class="s">&lt;&lt; EOF</span>
<span class="s">*                     soft     nofile             65535</span>
<span class="s">*                     hard     nofile             65535</span>
<span class="s">EOF</span>

<span class="c1">#基础系统内核优化</span>
cat &gt;&gt; /etc/sysctl.conf <span class="s">&lt;&lt; EOF</span>
<span class="s">fs.file-max=419430</span>
<span class="s">net.ipv4.tcp_syncookies = 1</span>
<span class="s">net.ipv4.tcp_syn_retries = 1</span>
<span class="s">net.ipv4.tcp_tw_recycle = 1</span>
<span class="s">net.ipv4.tcp_tw_reuse = 1</span>
<span class="s">net.ipv4.tcp_fin_timeout = 1</span>
<span class="s">net.ipv4.tcp_keepalive_time = 1200</span>
<span class="s">net.ipv4.ip_local_port_range = 1024 65535</span>
<span class="s">net.ipv4.tcp_max_syn_backlog = 16384</span>
<span class="s">net.ipv4.tcp_max_tw_buckets = 36000</span>
<span class="s">net.ipv4.route.gc_timeout = 100</span>
<span class="s">net.ipv4.tcp_syn_retries = 1</span>
<span class="s">net.ipv4.tcp_synack_retries = 1</span>
<span class="s">net.core.somaxconn = 16384</span>
<span class="s">net.core.netdev_max_backlog = 16384</span>
<span class="s">net.ipv4.tcp_max_orphans = 16384</span>
<span class="s">EOF</span>
/sbin/sysctl -p

<span class="c1">#禁用control-alt-delete组合键以防止误操作</span>
sed -i <span class="s1">&#39;s@ca::ctrlaltdel:/sbin/shutdown -t3 -r now@#ca::ctrlaltdel:/sbin/shutdown -t3 -r now@&#39;</span> /etc/inittab

<span class="c1">#关闭SELinux</span>
sed -i <span class="s1">&#39;s@SELINUX=enforcing@SELINUX=disabled@&#39;</span> /etc/selinux/config

<span class="c1">#关闭iptables</span>
service iptables stop
chkconfig iptables off

<span class="c1">#ssh服务配置优化,请至少保持机器中至少有一个具有sudo权限的用户，下面的配置会禁止root远程登录</span>
sed -i <span class="s1">&#39;s@#PermitRootLogin yes@PermitRootLogin no@&#39;</span> /etc/ssh/sshd_config <span class="c1">#禁止root远程登录</span>
sed -i <span class="s1">&#39;s@#PermitEmptyPasswords no@PermitEmptyPasswords no@&#39;</span> /etc/ssh/sshd_config <span class="c1">#禁止空密码登录</span>
sed -i <span class="s1">&#39;s@#UseDNS yes@UseDNS no@&#39;</span> /etc/ssh/sshd_config /etc/ssh/sshd_config
service sshd restart

<span class="c1">#禁用IPv6地址</span>
<span class="nb">echo</span> <span class="s2">&quot;alias net-pf-10 off&quot;</span> &gt;&gt; /etc/modprobe.d/dist.conf
<span class="nb">echo</span> <span class="s2">&quot;alias ipv6 off&quot;</span> &gt;&gt; /etc/modprobe.d/dist.conf
chkconfig ip6tables off

<span class="c1">#vim基础语法优化</span>
<span class="nb">echo</span> <span class="s2">&quot;syntax on&quot;</span> &gt;&gt; /root/.vimrc
<span class="nb">echo</span> <span class="s2">&quot;set nohlsearch&quot;</span> &gt;&gt; /root/.vimrc

<span class="c1">#精简开机自启动服务，安装最小化服务的机器初始可以只保留crond，network，rsyslog，sshd这四个服务。</span>
<span class="k">for</span> i <span class="k">in</span> <span class="sb">`</span>chkconfig --list<span class="p">|</span>grep <span class="m">3</span>:on<span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span><span class="p">;</span><span class="k">do</span> chkconfig --level <span class="m">3</span> <span class="nv">$i</span> off<span class="p">;</span><span class="k">done</span>
<span class="k">for</span> CURSRV  <span class="k">in</span> crond rsyslog sshd network<span class="p">;</span><span class="k">do</span> chkconfig --level <span class="m">3</span> <span class="nv">$CURSRV</span> on<span class="p">;</span><span class="k">done</span>

<span class="c1">#重启服务器</span>
reboot
</pre></div>
</div>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id25"><span class="section-number">4.4.2. </span><strong>4.2 控制shell多进程数量的脚本</strong></a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>下面的run.py是爬虫程序，经测试，在机器上运行8个run.py进程是机器性能最好的时候，该进程数量既能充分发挥机器的性能又不会导致机器响度速度过慢。</p>
<p>而且有时为了避免并发进程数过多导致机器卡死，需要<strong>限制并发的数量</strong>。下面的脚本可以实现这个需求，其代码如下所示：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:${NAME}.sh</span>
<span class="c1"># author：xiaojian</span>

<span class="nv">CE_HOME</span><span class="o">=</span><span class="s2">&quot;/data/ContentEnginne&quot;</span>
<span class="nv">LOG_PATH</span><span class="o">=</span><span class="s2">&quot;/data/logs&quot;</span>

<span class="c1"># 控制爬虫数量为8</span>
<span class="nv">MAX_SPIDER_COUNT</span><span class="o">=</span><span class="m">8</span>

<span class="nv">count</span><span class="o">=</span><span class="sb">`</span>ps -ef<span class="p">|</span>grep -v grep<span class="p">|</span>grep run.py<span class="p">|</span>wc -l<span class="sb">`</span>
<span class="nv">try_time</span><span class="o">=</span><span class="m">0</span>

<span class="nb">cd</span> <span class="nv">$CE_HOME</span>

<span class="c1"># 限制并发的数量</span>
<span class="k">while</span> <span class="o">[</span> <span class="nv">$count</span> -lt <span class="nv">$MAX_SPIDER_COUNT</span> -a <span class="nv">$try_time</span> -lt <span class="nv">$MAX_SPIDER_COUNT</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">let</span> <span class="nv">try_time</span> <span class="o">+=</span><span class="m">1</span>
    python run.py &gt;&gt; <span class="si">${</span><span class="nv">LOG_PATH</span><span class="si">}</span>/spider.log <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>
    <span class="nv">count</span><span class="o">=</span><span class="sb">`</span>ps -ef<span class="p">|</span>grep -v grep<span class="p">|</span>grep run.py<span class="p">|</span>wc -l<span class="sb">`</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="ansible">
<h3><a class="toc-backref" href="#id26"><span class="section-number">4.4.3. </span><strong>4.3 调用Ansible来分发多条线路的配置</strong></a><a class="headerlink" href="#ansible" title="Permalink to this headline">¶</a></h3>
<p>Ansible的<code class="docutils literal notranslate"><span class="pre">hosts</span></code>文件内容如下,举例IP，真实IP已被隐藏</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">yd</span><span class="p">]</span>
<span class="mf">1.1.1.1</span>
<span class="mf">2.2.2.2</span>

<span class="p">[</span><span class="n">wt</span><span class="p">]</span>
<span class="mf">3.3.3.3</span>
<span class="mf">4.4.4.4</span>

<span class="p">[</span><span class="n">dx</span><span class="p">]</span>
<span class="mf">5.5.5.5</span>
<span class="mf">6.6.6.6</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">publishconf.sh</span></code>部分内容如下</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#如果hosts文件不存在，就调用touch命令建立；另外，这里要增加一个逻辑判断，即如果已经有人在发布平台了，第二个运维人员发布的时候，一定要强制退出，等待前面的发布人员发布结束。</span>
<span class="k">if</span> <span class="o">[</span> ! -f <span class="s2">&quot;</span><span class="nv">$hosts</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
    touch <span class="s2">&quot;</span><span class="nv">$hosts</span><span class="s2">&quot;</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;此平台已经有运维小伙伴在发布，请耐心等待！&quot;</span>
    <span class="nb">exit</span>
<span class="k">fi</span>

<span class="c1">#如果出现中止进程的情况，捕捉异常信号，清理临时文件。</span>
<span class="nb">trap</span> <span class="s2">&quot;echo &#39;程序被中止，开始清理临时文件&#39;;rm -rf </span><span class="nv">$hosts</span><span class="s2">;exit&quot;</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span>
<span class="c1">#进入public_conf目录，通过git pull获取gitlab上最新的相关文件配置</span>

<span class="nb">cd</span> /data/conf /public_conf/
git pull origin master:master

<span class="c1">#配置文件这里也是通过内部的GitLab管理，这里没简化操作，主要是防止执行git pull origin master或git pull的时候，此时可能会存在着多分支的情况会导致运行报错</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="o">==</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;当前配置文件为最新版本，可以发布！&quot;</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;当前配置文件不是最新的，请检查后再发布&quot;</span>
    <span class="nb">exit</span>
<span class="k">fi</span>

<span class="c1">#此为发布单平台多IP的逻辑，$#判断参数个数，这里的逻辑判断为参数大于或等于3时就是单平台多IP发布。</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> &gt;<span class="o">=</span><span class="m">3</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
  <span class="nb">shift</span> <span class="m">1</span>
  这里通过shift命令往左偏移一个位置参数，从而获取全部的IP。
  <span class="nb">echo</span> <span class="s2">&quot;此次需要更新的机器IP为：</span><span class="nv">$@</span><span class="s2">&quot;</span>
  <span class="k">for</span> flat <span class="k">in</span> <span class="nv">$@</span>
  <span class="k">do</span>
  <span class="nb">echo</span> <span class="s2">&quot;此次需要更新的机器IP为：</span><span class="nv">$flat</span><span class="s2">&quot;</span>
  <span class="nv">platform</span><span class="o">=</span><span class="sb">`</span>awk <span class="s1">&#39;/\[/{a=$0}/&#39;</span><span class="s2">&quot;</span><span class="nv">$flat</span><span class="s2">&quot;</span><span class="s1">&#39;/{print a}&#39;</span> <span class="nv">$hosts</span> <span class="p">|</span> head -n1<span class="sb">`</span>
    <span class="c1">#通过这段awk命令组和来获取当前的机器ip属于哪条线路，比如是移动还是网通或者电信，后续有相应的措施。</span>


  <span class="k">if</span>  <span class="o">[[</span> <span class="nv">$platform</span> <span class="o">=</span>~ <span class="s2">&quot;yd&quot;</span> <span class="o">]]</span><span class="p">;</span><span class="k">then</span>
    /usr/local/bin/ansible -i <span class="nv">$hosts</span> <span class="nv">$flat</span> -m shell -a <span class="s2">&quot;/home/fastcache_conf/publish_fastcache.sh </span><span class="si">${</span><span class="nv">public_conf</span><span class="si">}</span><span class="s2">_yd&quot;</span>
    <span class="k">elif</span>  <span class="o">[[</span> <span class="nv">$platform</span> <span class="o">=</span>~ <span class="s2">&quot;wt&quot;</span> <span class="o">]]</span><span class="p">;</span><span class="k">then</span>
    /usr/local/bin/ansible -i <span class="nv">$hosts</span> <span class="nv">$flat</span> -m shell -a <span class="s2">&quot;/home/fastcache_conf/publish_fastcache.sh </span><span class="si">${</span><span class="nv">public_conf</span><span class="si">}</span><span class="s2">_wt&quot;</span>
    <span class="k">else</span>
    /usr/local/bin/ansible -i <span class="nv">$hosts</span> <span class="nv">$flat</span> -m shell -a <span class="s2">&quot;/home/fastcache_conf/publish_fastcache.sh </span><span class="si">${</span><span class="nv">public_conf</span><span class="si">}</span><span class="s2">_dx&quot;</span>
  <span class="k">fi</span>
  <span class="k">done</span>
<span class="k">fi</span>

<span class="c1">#程序正常运行后，也要清理此临时文件，方便下次任务发布</span>
rm -rf <span class="nv">$hosts</span>
<span class="nb">trap</span> <span class="s2">&quot;rm -rf </span><span class="nv">$hosts</span><span class="s2">&quot;</span> <span class="nb">exit</span>
</pre></div>
</div>
</section>
<section id="raid">
<h3><a class="toc-backref" href="#id27"><span class="section-number">4.4.4. </span><strong>4.4 手动建立软Raid级别需求</strong></a><a class="headerlink" href="#raid" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="k">function</span> rg_mkfs_interac<span class="o">()</span> <span class="o">{</span>
    <span class="nb">read</span> -p <span class="s2">&quot;请输入您要做的RAID级别，可选择项为0|1|5|10:&quot;</span> raid
    <span class="nb">read</span> -p <span class="s2">&quot;请输入哪些磁盘需要并进RAID，磁盘之间请用空格格开，例如sdb sdc等&quot;</span> mydev
    <span class="nb">echo</span> <span class="nv">$raid</span>
    <span class="nb">echo</span> <span class="nv">$mydev</span>
    <span class="c1"># create md0</span>
        rg_info <span class="s2">&quot;Create RAID...&quot;</span>
        mdadm -Ss
        yes <span class="p">|</span> mdadm -C /dev/md0 --level<span class="o">=</span><span class="nv">$raid</span> --auto<span class="o">=</span>yes <span class="nv">$mydev</span> &gt;/dev/null
        mdadm -D /dev/md0 &gt;/dev/null <span class="o">||</span> rg_info <span class="m">58</span> <span class="s2">&quot;Create RAID /dev/md0 failed.&quot;</span>
            <span class="c1"># public</span>
            partprobe /dev/<span class="nv">$DISK_SYS</span> <span class="m">2</span>&gt;/dev/null
            sleep <span class="m">3</span>
            <span class="c1"># mkfs</span>
            <span class="k">for</span> i <span class="k">in</span> <span class="o">{</span><span class="si">${</span><span class="nv">DISK_SYS</span><span class="si">}</span><span class="m">4</span>,md0<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
                <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$MKFS</span><span class="s2"> /dev/</span><span class="nv">$i</span><span class="s2">... &quot;</span>
                <span class="k">if</span> <span class="nv">$MKFS</span> /dev/<span class="nv">$i</span> <span class="p">&amp;</span>&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
                <span class="nb">echo</span> OK
                <span class="k">else</span>
                <span class="nb">echo</span> failed <span class="o">&amp;&amp;</span> rg_info <span class="m">55</span> <span class="s2">&quot;mkfs </span><span class="nv">$i</span><span class="s2"> failed&quot;</span>
                <span class="k">fi</span>
            <span class="k">done</span>
            rg_info <span class="s2">&quot;Create cache direcotry...&quot;</span> <span class="o">&amp;&amp;</span> mkdir -p /cache/<span class="o">{</span>cache,logs<span class="o">}</span>
            <span class="nb">echo</span> -e <span class="s2">&quot;/dev/</span><span class="si">${</span><span class="nv">DISK_SYS</span><span class="si">}</span><span class="s2">4 \t\t/cache/logs \t\t</span><span class="nv">$FS</span><span class="s2"> \tdefaults \t0 0&quot;</span> &gt;&gt;/etc/fstab
            <span class="nb">echo</span> -e <span class="s2">&quot;/dev/md0 \t\t/cache/cache \t\t</span><span class="nv">$FS</span><span class="s2"> \t</span><span class="nv">$MOUNT_OPTS</span><span class="s2"> \t0 0&quot;</span> &gt;&gt;/etc/fstab
        <span class="nb">echo</span> <span class="s2">&quot;--&quot;</span>
<span class="c1">#save mdadm.conf</span>
        <span class="k">if</span> <span class="o">(</span>mdadm -Ds <span class="m">2</span>&gt;/dev/null <span class="p">|</span>grep -q .<span class="o">)</span><span class="p">;</span> <span class="k">then</span>
            <span class="o">[</span> -f /etc/mdadm.conf <span class="o">]</span> <span class="o">&amp;&amp;</span> rg_info <span class="s2">&quot;Backup old mdadm.conf...&quot;</span> <span class="o">&amp;&amp;</span> /bin/cp /etc/mdadm.conf /etc/mdadm.conf.bak
            rg_info <span class="s2">&quot;Save RAID configration (mdadm.conf)...&quot;</span>
                <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$VER6</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                    mdadm -Ds <span class="p">|</span>sed <span class="s1">&#39;s!/dev/md[^ ]*:\([0-9]\)!/dev/md\1!; s!metadata[^ ]* !!; s/$/ auto=yes/&#39;</span> &gt;/etc/mdadm.conf
                <span class="k">else</span>
                    mdadm -Ds <span class="p">|</span>sed <span class="s1">&#39;s/$/ auto=yes/&#39;</span> &gt;/etc/mdadm.conf
                <span class="k">fi</span>
        <span class="k">fi</span>
<span class="c1">#mount all</span>
        fgrep -q /cache /etc/fstab <span class="o">||</span> rg_info <span class="m">48</span> <span class="s2">&quot;Internal error: f_mkfs has BUG!&quot;</span>
        rg_info <span class="s2">&quot;挂载所有分区...&quot;</span>
        <span class="k">if</span> mount -a<span class="p">;</span> <span class="k">then</span>
            rg_info <span class="s2">&quot;创建mkpart锁...&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$VERSION</span><span class="s2">&quot;</span> &gt;<span class="nv">$MKFS_LOCK</span> <span class="m">2</span>&gt;/dev/null <span class="o">&amp;&amp;</span> chattr +i <span class="nv">$MKFS_LOCK</span>
            <span class="nv">ret</span><span class="o">=</span><span class="m">0</span>
        <span class="k">else</span>
            rg_info <span class="m">49</span> <span class="s2">&quot;mount -a 出错&quot;</span>
        <span class="k">fi</span>
        <span class="k">return</span> <span class="nv">$ret</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id28"><span class="section-number">4.4.5. </span><strong>4.5 重载或更新机器路由配置</strong></a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>参考了Git的思想，配置文件分成3种：</p>
<p>分别对应Git的工作区、Git本地版本库和Git远程版本库。对应的动作和思路很明确：</p>
<p>reload和updata动作都会进行差异对比，然后根据需求获取真正有用的rules配置文件。</p>
<p>这里只列举了<code class="docutils literal notranslate"><span class="pre">updata_rules()</span></code>函数,<code class="docutils literal notranslate"><span class="pre">reload_rules()</span></code>函数的设计思路与此类似。
其内容如下所示：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="k">function</span> update_rules<span class="o">()</span> <span class="o">{</span>
<span class="c1">#使用是内部SVN服务器，所以这里帐号和密码明文，没有考虑太多安全带来的问题</span>
svn co svn://192.168.10.68/route_auto /tmp/route_auto --username<span class="o">=</span>testyum --password<span class="o">=</span>oTIil31pw --force --no-auth-cache

<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;[INFO]: 获取最新 rules 成功,检测下载的 rules 库文件是否为空...&quot;</span>
    <span class="k">if</span> !<span class="o">(</span><span class="nb">test</span> -s <span class="nv">$LOCAL_TMP_RULES</span><span class="o">)</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;获取到的最新 rules 库文件为空,请检查远端 rules 库文件!!&quot;</span>
        <span class="nb">exit</span> <span class="m">1</span>
    <span class="k">else</span>
    cp -rf <span class="nv">$LOCAL_TMP_RULES</span> <span class="nv">$RULES_ENV_FILE</span>
    cp -rf <span class="nv">$LOCAL_TMP_RULES</span> <span class="nv">$TMPFILES</span>
    <span class="nb">echo</span> <span class="s2">&quot;获取到的最新 rules 库文件非空,程序继续...&quot;</span>
    <span class="k">fi</span>

    <span class="nb">echo</span> <span class="s2">&quot;[INFO]: 将最新 rules 库文件与本地 rules 库文件比对是否有差异...&quot;</span>
    <span class="k">if</span> ! <span class="o">(</span>diff <span class="nv">$RULES_ENV_FILE</span> <span class="nv">$LOCAL_TMP_RULES</span> <span class="p">&amp;</span>&gt;/dev/null<span class="o">)</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;有差异 rules,加载最新 rules 库配置...&quot;</span>
        . <span class="nv">$LOCAL_TMP_RULES</span>
        cp -rf <span class="nv">$LOCAL_TMP_RULES</span> <span class="nv">$RULES_ENV_FILE</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;无差异 rules,加载本地 rules 库配置...&quot;</span>
        . <span class="nv">$RULES_ENV_FILE</span>
    <span class="k">fi</span>
<span class="k">fi</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="03.Python%E5%9C%A8Devops%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8.html" class="btn btn-neutral float-left" title="3. Python在Devops与自动化运维中的应用" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="05.%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84Python%E8%84%9A%E6%9C%AC%E5%88%86%E4%BA%AB.html" class="btn btn-neutral float-right" title="5. 工作中的Python脚本分享" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>