<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jenkins2.x实践指南 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Jenkins pipeline 小结" href="03.Jenkins-pipeline%E5%B0%8F%E7%BB%93.html" />
    <link rel="prev" title="Jenkins基础知识" href="01.Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> 小健_Linux-shell-Devops_Blog
            <img src="../_static/devops_photo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../DevOps/index.html">DevOps和自动化运维实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Github/index.html">Github入门到实践</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Jenkins持续化集成</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01.Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html">Jenkins基础知识</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Jenkins2.x实践指南</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#jenkins">1. Jenkins介绍</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">1.1 简介</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">1.2 特点</a></li>
<li class="toctree-l4"><a class="reference internal" href="#jenkinsdevops">1.3 Jenkins与DevOps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">1.4 Jenkins安装</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">1.5 Jenkins配置管理工具</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">1.6 jenkins插件下载和加速</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pipeline">2. pipeline入门</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">2.1 pipeline是什么</a></li>
<li class="toctree-l4"><a class="reference internal" href="#jenkinsfile">2.2 Jenkinsfile又是什么</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">2.3 pipeline语法的选择</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">2.4 创建第一个pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">2.5 从版本控制库拉取pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mavenjava">2.6 使用Maven构建Java应用</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">小结</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id11">3. pipeline语法讲解</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#groovy">3.1 必要的Groovy知识</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">3.2 pipeline的组成</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id25">4.环境变量</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id26">4.1 Jenkins内置变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id27">4.2 自定义pipeline环境变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id28">4.3 自定义全局环境变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id29">4.4 一些pipeline示例</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id32">5.构建工具</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#tools">5.1 tools指令介绍</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id34">5.2 利用环境变量支持更多的构建工具</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id35">5.3 利用tools作用域实现多版本编译</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id36">6.触发Pipeline执行</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id37">6.1 时间触发</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id38">6.2 事件触发</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gitlab">6.3 GitLab通知触发</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pipelinegitlab-trigger">6.4 在pipeline中实现GitLab trigger</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generic-webhook-trigger">6.5 使用Generic Webhook Trigger插件实现触发</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id43">7.将构建状态信息推送到GitLab</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id44">8.多分支构建</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id45">8.1 创建多分支pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id46">8.2 根据分支部署到不同的环境</a></li>
<li class="toctree-l4"><a class="reference internal" href="#when">8.3 when指令的用法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gitlab-triggerpipeline">8.4 GitLab trigger对多分支pipeline的支持</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id48">8.5 并发示例</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id49">9.参数化pipeline</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id50">9.1 什么是参数化pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parameters">9.2 使用parameters指令</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id53">9.3 由另一个pipeline传参并触发</a></li>
<li class="toctree-l4"><a class="reference internal" href="#conditional-buildstep">9.4 使用Conditional BuildStep插件处理复杂的判断逻辑</a></li>
<li class="toctree-l4"><a class="reference internal" href="#input">9.5 使用input步骤</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id56">9.6 小贴士</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id59">10.凭证管理</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id60">10.1 为什么要管理凭证</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id61">10.2 凭证是什么</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id62">10.3 常用凭证</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id63">9.4 优雅地使用凭证</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hashicorp-vault">9.5 使用HashiCorp Vault</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id66">9.6 在Jenkins日志中隐藏敏感信息</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id67">10.制品管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id68">11.自动化部署</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id69">11.1 关于部署有什么好说的</a></li>
<li class="toctree-l4"><a class="reference internal" href="#jenkinsansible">11.2 Jenkins集成Ansible实现自动化部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id75">11.3 手动部署比自动化部署更可靠吗</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id76">11.4 如何开始自动化部署</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id79">12.通知</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id80">12.1 邮件通知</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id81">12.2 钉钉通知</a></li>
<li class="toctree-l4"><a class="reference internal" href="#http">12.3 HTTP请求通知</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id82">13.分布式构建与并行构建</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id83">14.扩展pipeline</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id84">14.1 <strong>为什么要扩展pipeline</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="#id85">14.2 在pipeline中定义函数</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id86">15.Jenkins运维</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id87">15.1 认证管理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id89">15.2 授权管理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id93">15.3 Jenkins监控</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id94">15.4 Jenkins备份</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id95">15.5 汉化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id96">15.6 Jenkins配置即代码</a></li>
<li class="toctree-l4"><a class="reference internal" href="#init-groovyjenkins">15.7 使用init.groovy配置Jenkins</a></li>
<li class="toctree-l4"><a class="reference internal" href="#jenkinsagent">15.8 为Jenkins添加静态agent节点</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id97">16.自动化运维经验</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id98">16.1 小团队自动化运维实践经验</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#python-jenkins">17.Python-jenkins库</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="03.Jenkins-pipeline%E5%B0%8F%E7%BB%93.html">Jenkins pipeline 小结</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../KVM/index.html">KVM实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Linux/index.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Mysql/index.html">Mysql王者之路</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/index.html">Other</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Network_route_switch/index.html">Network_route_switch</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">小健_Linux-shell-Devops_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Jenkins持续化集成</a> &raquo;</li>
      <li>Jenkins2.x实践指南</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Jenkins/02.Jenkins2.x实践指南.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#jenkins2-x" id="id104">Jenkins2.x实践指南</a></p>
<ul>
<li><p><a class="reference internal" href="#jenkins" id="id105">1. Jenkins介绍</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id106">1.1 简介</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id107">1.2 特点</a></p></li>
<li><p><a class="reference internal" href="#jenkinsdevops" id="id108">1.3 Jenkins与DevOps</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id109">1.4 Jenkins安装</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id110">1.5 Jenkins配置管理工具</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id111">1.6 jenkins插件下载和加速</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#pipeline" id="id112">2. pipeline入门</a></p>
<ul>
<li><p><a class="reference internal" href="#id6" id="id113">2.1 pipeline是什么</a></p></li>
<li><p><a class="reference internal" href="#jenkinsfile" id="id114">2.2 Jenkinsfile又是什么</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id115">2.3 pipeline语法的选择</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id116">2.4 创建第一个pipeline</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id117">2.5 从版本控制库拉取pipeline</a></p></li>
<li><p><a class="reference internal" href="#mavenjava" id="id118">2.6 使用Maven构建Java应用</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id119">小结</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id11" id="id120">3. pipeline语法讲解</a></p>
<ul>
<li><p><a class="reference internal" href="#groovy" id="id121">3.1 必要的Groovy知识</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id122">3.2 pipeline的组成</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id25" id="id123">4.环境变量</a></p>
<ul>
<li><p><a class="reference internal" href="#id26" id="id124">4.1 Jenkins内置变量</a></p></li>
<li><p><a class="reference internal" href="#id27" id="id125">4.2 自定义pipeline环境变量</a></p></li>
<li><p><a class="reference internal" href="#id28" id="id126">4.3 自定义全局环境变量</a></p></li>
<li><p><a class="reference internal" href="#id29" id="id127">4.4 一些pipeline示例</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id32" id="id128">5.构建工具</a></p>
<ul>
<li><p><a class="reference internal" href="#tools" id="id129">5.1 tools指令介绍</a></p></li>
<li><p><a class="reference internal" href="#id34" id="id130">5.2 利用环境变量支持更多的构建工具</a></p></li>
<li><p><a class="reference internal" href="#id35" id="id131">5.3 利用tools作用域实现多版本编译</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id36" id="id132">6.触发Pipeline执行</a></p>
<ul>
<li><p><a class="reference internal" href="#id37" id="id133">6.1 时间触发</a></p></li>
<li><p><a class="reference internal" href="#id38" id="id134">6.2 事件触发</a></p></li>
<li><p><a class="reference internal" href="#gitlab" id="id135">6.3 GitLab通知触发</a></p></li>
<li><p><a class="reference internal" href="#pipelinegitlab-trigger" id="id136">6.4 在pipeline中实现GitLab trigger</a></p></li>
<li><p><a class="reference internal" href="#generic-webhook-trigger" id="id137">6.5 使用Generic Webhook Trigger插件实现触发</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id43" id="id138">7.将构建状态信息推送到GitLab</a></p></li>
<li><p><a class="reference internal" href="#id44" id="id139">8.多分支构建</a></p>
<ul>
<li><p><a class="reference internal" href="#id45" id="id140">8.1 创建多分支pipeline</a></p></li>
<li><p><a class="reference internal" href="#id46" id="id141">8.2 根据分支部署到不同的环境</a></p></li>
<li><p><a class="reference internal" href="#when" id="id142">8.3 when指令的用法</a></p></li>
<li><p><a class="reference internal" href="#gitlab-triggerpipeline" id="id143">8.4 GitLab trigger对多分支pipeline的支持</a></p></li>
<li><p><a class="reference internal" href="#id48" id="id144">8.5 并发示例</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id49" id="id145">9.参数化pipeline</a></p>
<ul>
<li><p><a class="reference internal" href="#id50" id="id146">9.1 什么是参数化pipeline</a></p></li>
<li><p><a class="reference internal" href="#parameters" id="id147">9.2 使用parameters指令</a></p></li>
<li><p><a class="reference internal" href="#id53" id="id148">9.3 由另一个pipeline传参并触发</a></p></li>
<li><p><a class="reference internal" href="#conditional-buildstep" id="id149">9.4 使用Conditional BuildStep插件处理复杂的判断逻辑</a></p></li>
<li><p><a class="reference internal" href="#input" id="id150">9.5 使用input步骤</a></p></li>
<li><p><a class="reference internal" href="#id56" id="id151">9.6 小贴士</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id59" id="id152">10.凭证管理</a></p>
<ul>
<li><p><a class="reference internal" href="#id60" id="id153">10.1 为什么要管理凭证</a></p></li>
<li><p><a class="reference internal" href="#id61" id="id154">10.2 凭证是什么</a></p></li>
<li><p><a class="reference internal" href="#id62" id="id155">10.3 常用凭证</a></p></li>
<li><p><a class="reference internal" href="#id63" id="id156">9.4 优雅地使用凭证</a></p></li>
<li><p><a class="reference internal" href="#hashicorp-vault" id="id157">9.5 使用HashiCorp Vault</a></p></li>
<li><p><a class="reference internal" href="#id66" id="id158">9.6 在Jenkins日志中隐藏敏感信息</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id67" id="id159">10.制品管理</a></p></li>
<li><p><a class="reference internal" href="#id68" id="id160">11.自动化部署</a></p>
<ul>
<li><p><a class="reference internal" href="#id69" id="id161">11.1 关于部署有什么好说的</a></p></li>
<li><p><a class="reference internal" href="#jenkinsansible" id="id162">11.2 Jenkins集成Ansible实现自动化部署</a></p></li>
<li><p><a class="reference internal" href="#id75" id="id163">11.3 手动部署比自动化部署更可靠吗</a></p></li>
<li><p><a class="reference internal" href="#id76" id="id164">11.4 如何开始自动化部署</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id79" id="id165">12.通知</a></p>
<ul>
<li><p><a class="reference internal" href="#id80" id="id166">12.1 邮件通知</a></p></li>
<li><p><a class="reference internal" href="#id81" id="id167">12.2 钉钉通知</a></p></li>
<li><p><a class="reference internal" href="#http" id="id168">12.3 HTTP请求通知</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id82" id="id169">13.分布式构建与并行构建</a></p></li>
<li><p><a class="reference internal" href="#id83" id="id170">14.扩展pipeline</a></p>
<ul>
<li><p><a class="reference internal" href="#id84" id="id171">14.1 <strong>为什么要扩展pipeline</strong></a></p></li>
<li><p><a class="reference internal" href="#id85" id="id172">14.2 在pipeline中定义函数</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id86" id="id173">15.Jenkins运维</a></p>
<ul>
<li><p><a class="reference internal" href="#id87" id="id174">15.1 认证管理</a></p></li>
<li><p><a class="reference internal" href="#id89" id="id175">15.2 授权管理</a></p></li>
<li><p><a class="reference internal" href="#id93" id="id176">15.3 Jenkins监控</a></p></li>
<li><p><a class="reference internal" href="#id94" id="id177">15.4 Jenkins备份</a></p></li>
<li><p><a class="reference internal" href="#id95" id="id178">15.5 汉化</a></p></li>
<li><p><a class="reference internal" href="#id96" id="id179">15.6 Jenkins配置即代码</a></p></li>
<li><p><a class="reference internal" href="#init-groovyjenkins" id="id180">15.7 使用init.groovy配置Jenkins</a></p></li>
<li><p><a class="reference internal" href="#jenkinsagent" id="id181">15.8 为Jenkins添加静态agent节点</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id97" id="id182">16.自动化运维经验</a></p>
<ul>
<li><p><a class="reference internal" href="#id98" id="id183">16.1 小团队自动化运维实践经验</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#python-jenkins" id="id184">17.Python-jenkins库</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="jenkins2-x">
<h1><a class="toc-backref" href="#id104">Jenkins2.x实践指南</a><a class="headerlink" href="#jenkins2-x" title="Permalink to this headline">¶</a></h1>
<section id="jenkins">
<h2><a class="toc-backref" href="#id105">1. Jenkins介绍</a><a class="headerlink" href="#jenkins" title="Permalink to this headline">¶</a></h2>
<section id="id1">
<h3><a class="toc-backref" href="#id106">1.1 简介</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Jenkins是一个开源项目，提供了一种易于使用可扩展的持续集成系统，使开发者从繁杂的集成中解脱出来，专注于更为重要的业务逻辑实现上。同时Jenkins能实时监控集成时存在的错误，提供详细的日志文件和提醒功能，还能用图表的形式形象地展示项目构建的趋势和稳定性。</p>
<p>2009年，<a class="reference external" href="https://baike.baidu.com/item/甲骨文公司/430115?fromtitle=甲骨文&amp;fromid=471435&amp;fr=aladdin">甲骨文</a>收购了<a class="reference external" href="https://baike.baidu.com/item/Sun%20Microsystems/6064586?fromtitle=SUN&amp;fromid=69463">Sun</a>并继承了<a class="reference external" href="https://baike.baidu.com/item/HUDSON/4807682">Hudson</a>代码库。在
2011
年年初，甲骨文和开源社区之间的关系破裂，该项目被分成两个独立的项目：
Jenkins：由大部分原始开发人员组成 Hudson：由甲骨文公司继续管理</p>
<p>Jenkins
其本身上没有整合太多的功能，只是提供了一个持续集成的WEB平台，它是通过大量的插件，实现了一系列的持续化集成的工作。</p>
<p>例如通过gitlab插件进行代码下载，指定下载分支。通过Git Parameter
Plug-In动态获取代码的分支信息，构建时可以选择分支发布。</p>
<p>觉得默认显示的pipeline流程页面不好看，用Blue
Ocean插件可以显示更舒服的流程页面。</p>
<p>实际上不使用那些插件，只单纯写一个shell脚本，里面写上git
clone代码，编译再ansible发布，而jenkins只是运行这个脚本并打印日志也是可以的。并且也推荐用这种方法，这里使用ansible插件就需要在jenkins中进行配置不方便后续进行迁移。而在机器上安装一个Ansible并在脚本中运行playbook会更加方便管理。</p>
<p>使用Jenkins能提升软件工程生产力的根本原因就在于它提供的是一个自动化平台。一个团队引入了Jenkins就像原来手工作坊式的工厂引入了生产流水线。由于知识的特殊性，它还能帮助我们将知识固化到自动化流水线中，在一定程度上解决了知识被人带走的问题。</p>
<p>我们使用Jenkins的过程，有如设计软件生产流水线的过程。</p>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id107">1.2 特点</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>易于安装，只要把jenkins.war部署到servlet容器，不需要数据库支持</p></li>
<li><p>易于配置，所有配置都是通过其提供的web界面实现</p></li>
<li><p>集成RSS/E-mail通过RSS发布构建结果或当构建完成时通过e-mail通知</p></li>
<li><p>生成JUnit/TestNG测试报告</p></li>
<li><p>分布式构建支持Jenkins能够让多台计算机一起构建/测试</p></li>
<li><p>支持多种扩展插件，你可以开发适合自己团队使用的工具</p></li>
<li><p>支持pipeline流水线，可以用代码描述配置过程，方便使用</p></li>
</ul>
</section>
<section id="jenkinsdevops">
<h3><a class="toc-backref" href="#id108">1.3 Jenkins与DevOps</a><a class="headerlink" href="#jenkinsdevops" title="Permalink to this headline">¶</a></h3>
<p><em>DevOps</em>集文化理念、实践和工具于一身，可以提高组织高速交付应用程序和服务的能力，与使用传统软件开发和基础设施管理流程相比，能够帮助组织更快地发展和改进产品。这种速度使组织能够更好地服务于客户，并在市场上更高效地参与竞争。</p>
<p><em>DevOps</em>（<em>Development</em>和<em>Operations</em>的组合）是一种重视软件开发人员（<em>Dev</em>）和<em>IT</em>运维技术人员（<em>Ops</em>）之间沟通合作的文化、运动或惯例。通过自动化软件交付和架构变更的流程，使得构建、测试、发布软件能够更加快捷、频繁和可靠。</p>
<p>在谈到真正要落地DevOps时，基本上都会谈到Jenkins。这说明Jenkins能帮助我们很好地兑现DevOps的承诺。</p>
</section>
<section id="id3">
<h3><a class="toc-backref" href="#id109">1.4 Jenkins安装</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>参考文献：</p>
<p><a class="reference external" href="https://www.cnblogs.com/rxysg/p/15681492.html#ansible%E5%AE%89%E8%A3%85jenkins">https://www.cnblogs.com/rxysg/p/15681492.html#ansible%E5%AE%89%E8%A3%85jenkins</a></p>
<p><a class="reference external" href="https://www.jenkins.io/zh/doc/book/installing/">https://www.jenkins.io/zh/doc/book/installing/</a></p>
<p>ubuntu 安装 Jenkins</p>
<p><a class="reference external" href="https://ld246.com/article/1615968668499">https://ld246.com/article/1615968668499</a></p>
<p>centos7安装jenkins</p>
<p><a class="reference external" href="https://ld246.com/article/1601370128878">https://ld246.com/article/1601370128878</a></p>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id110">1.5 Jenkins配置管理工具</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>安装完成后，配置管理工具</p>
<section id="git">
<h4>1.安装并配置git<a class="headerlink" href="#git" title="Permalink to this headline">¶</a></h4>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>yum -y install git
</pre></div>
</div>
<p>编辑git环境变量为/usr/bin/git</p>
</section>
<section id="maven">
<h4>2.安装并配置maven<a class="headerlink" href="#maven" title="Permalink to this headline">¶</a></h4>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>wget https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz

tar -xvf apache-maven-3.6.3-bin.tar.gz

mv apache-maven-3.6.3 /usr/local/maven
vim /etc/profile.d/maven.sh
<span class="c1">#!/bin/bash</span>

<span class="nb">export</span> <span class="nv">M2_HOME</span><span class="o">=</span>/usr/local/maven

<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$M2_HOME</span>/bin
<span class="nb">source</span> /etc/profile.d/maven.sh

mvn --version
</pre></div>
</div>
<p>编辑maven的环境变量为/usr/local/maven</p>
</section>
<section id="ansible">
<h4>3.安装并配置ansible<a class="headerlink" href="#ansible" title="Permalink to this headline">¶</a></h4>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>yum -y install ansible
</pre></div>
</div>
<p>编辑ansible的环境变量为/usr/bin</p>
</section>
</section>
<section id="id5">
<h3><a class="toc-backref" href="#id111">1.6 jenkins插件下载和加速</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>插件下载参考文献</p>
<p><a class="reference external" href="https://www.cnblogs.com/wengshaohang/p/12272952.html">https://www.cnblogs.com/wengshaohang/p/12272952.html</a></p>
<p>jenkins插件加速方式：</p>
<p><a class="reference external" href="https://ld246.com/article/1588144059031">https://ld246.com/article/1588144059031</a></p>
</section>
</section>
<section id="pipeline">
<h2><a class="toc-backref" href="#id112">2. pipeline入门</a><a class="headerlink" href="#pipeline" title="Permalink to this headline">¶</a></h2>
<section id="id6">
<h3><a class="toc-backref" href="#id113">2.1 pipeline是什么</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>按《持续交付》中的定义，Jenkins本来就支持pipeline（通常会把部署流水线简称为pipeline，本书会交替使用这两个术语），只是一开始不叫pipeline，而叫任务。</p>
<p>Jenkins 1.x只能通过界面手动操作来“描述”部署流水线。</p>
<p>Jenkins 2.x终于支持pipeline as code了，可以通过“代码”来描述部署流水线。</p>
<p>使用“代码”而不是UI的意义在于：</p>
<ul class="simple">
<li><p>更好地版本化：将pipeline提交到软件版本库中进行版本控制。</p></li>
<li><p>更好地协作：pipeline的每次修改对所有人都是可见的。除此之外，还可以对pipeline进行代码审查。</p></li>
<li><p>更好的重用性：手动操作没法重用，但是代码可以重用。</p></li>
</ul>
</section>
<section id="jenkinsfile">
<h3><a class="toc-backref" href="#id114">2.2 Jenkinsfile又是什么</a><a class="headerlink" href="#jenkinsfile" title="Permalink to this headline">¶</a></h3>
<p>Jenkinsfile就是一个文本文件，也就是部署流水线概念在Jenkins中的表现形式。像Dockerfile之于Docker。</p>
<p>所有部署流水线的逻辑都写在Jenkinsfile中。</p>
<p>Jenkins默认是不支持Jenkinsfile的。我们需要安装pipeline插件，其安装方式和普通插件的安装方式无异。安装完成后，就可以创建pipeline项目了。</p>
<p>我们使用的插件版本为2.6</p>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id115">2.3 pipeline语法的选择</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>Jenkins团队在一开始实现Jenkins
pipeline时，Groovy语言被选择作为基础来实现pipeline。所以，在写脚本式pipeline时，很像是（其实就是）在写Groovy代码。这样的确为用户提供了巨大的灵活性和可扩展性，我们还可以在脚本式pipeline中写try-catch。示例如下：</p>
<p><strong>脚本式（Scripted）语法</strong></p>
<p>灵活、可扩展</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span> <span class="p">{</span>
    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Build&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">//</span><span class="n">执行构建</span>
    <span class="p">}</span>

    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Test&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">//</span><span class="n">执行测试</span>
    <span class="p">}</span>

    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Deploy&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="o">//</span> <span class="n">执行部署</span>
        <span class="p">}</span><span class="n">catch</span><span class="p">(</span><span class="n">err</span><span class="p">){</span>
            <span class="n">currentBuild</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;FAILURE&quot;</span>
            <span class="n">mail</span> <span class="n">body</span><span class="p">:</span> <span class="s2">&quot;project error is here:$</span><span class="si">{env.BUILD_URL}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">from</span><span class="p">:</span> <span class="s1">&#39;xxxx@yyy.com&#39;</span><span class="p">,</span>
            <span class="n">replyTo</span><span class="p">:</span> <span class="s2">&quot;project build failed&quot;</span><span class="p">,</span>
            <span class="n">to</span><span class="p">:</span> <span class="s1">&#39;zzzzz@yyyy.com&#39;</span>
            <span class="n">throw</span> <span class="n">errr</span>

        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>声明式（Declar-ative）语法</strong></p>
<p>更简单、更结构化（more opinionated）的语法</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>

    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Build&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;Building....&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Test&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;Testing....&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Deploy&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;Deploying.....&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p>推荐使用声明式语法。因为声明式语法更符合人类的阅读习惯、更简单。声明式语法也是Jenkins社区推荐的语法。</p>
</div></blockquote>
</section>
<section id="id8">
<h3><a class="toc-backref" href="#id116">2.4 创建第一个pipeline</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>声明式-hello-world例子</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>

    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s1">&#39;Hello World&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>声明式-kubernets例子</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Uses</span> <span class="n">Declarative</span> <span class="n">syntax</span> <span class="n">to</span> <span class="n">run</span> <span class="n">commands</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">container</span><span class="o">.</span>
<span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="p">{</span>
        <span class="n">kubernetes</span> <span class="p">{</span>
            <span class="o">//</span> <span class="n">Rather</span> <span class="n">than</span> <span class="n">inline</span> <span class="n">YAML</span><span class="p">,</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">multibranch</span> <span class="n">Pipeline</span> <span class="n">you</span> <span class="n">could</span> <span class="n">use</span><span class="p">:</span> <span class="n">yamlFile</span> <span class="s1">&#39;jenkins-pod.yaml&#39;</span>
            <span class="o">//</span> <span class="n">Or</span><span class="p">,</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">YAML</span><span class="p">:</span>
            <span class="o">//</span> <span class="n">containerTemplate</span> <span class="p">{</span>
            <span class="o">//</span>     <span class="n">name</span> <span class="s1">&#39;shell&#39;</span>
            <span class="o">//</span>     <span class="n">image</span> <span class="s1">&#39;ubuntu&#39;</span>
            <span class="o">//</span>     <span class="n">command</span> <span class="s1">&#39;sleep&#39;</span>
            <span class="o">//</span>     <span class="n">args</span> <span class="s1">&#39;infinity&#39;</span>
            <span class="o">//</span> <span class="p">}</span>
            <span class="n">yaml</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">apiVersion: v1</span>
<span class="s1">kind: Pod</span>
<span class="s1">spec:</span>
<span class="s1">  containers:</span>
<span class="s1">  - name: shell</span>
<span class="s1">    image: ubuntu</span>
<span class="s1">    command:</span>
<span class="s1">    - sleep</span>
<span class="s1">    args:</span>
<span class="s1">    - infinity</span>
<span class="s1">&#39;&#39;&#39;</span>
            <span class="o">//</span> <span class="n">Can</span> <span class="n">also</span> <span class="n">wrap</span> <span class="n">individual</span> <span class="n">steps</span><span class="p">:</span>
            <span class="o">//</span> <span class="n">container</span><span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">//</span>     <span class="n">sh</span> <span class="s1">&#39;hostname&#39;</span>
            <span class="o">//</span> <span class="p">}</span>
            <span class="n">defaultContainer</span> <span class="s1">&#39;shell&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Main&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">sh</span> <span class="s1">&#39;hostname&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id117">2.5 从版本控制库拉取pipeline</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p><strong>演示：我们让Jenkins从Git仓库拉取pipeline并执行。</strong></p>
<p>将Git私钥放到Jenkins上的方法是：进入<code class="docutils literal notranslate"><span class="pre">Jenkins→Credentials→System→Global</span> <span class="pre">credentials</span></code>页，然后选择Kind为“SSH
Username with private key”，接下来按照提示设置就好了</p>
<p>Jenkins从Git仓库拉取代码时，需要SSH
key就可以了，然后Jenkins本身提供了这种方式让我们设置，我们首先配置一个ssh的全局凭证。我们需要提前将SSH的公钥放到Git仓库中。</p>
<p>在Pipeline节点下，在“Definition”中选择“Pipeline script from
SCM”，并在“SCM”中选择“Git”，然后根据选项填入信息内容就可以了</p>
<p><img alt="image0" src="../_images/jenkintest0001.png" /></p>
<p><img alt="image1" src="../_images/jenkins_test002.png" /></p>
<p>查看开发机器上的ssh公钥信息：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat ~/.ssh/id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCe7MOCVnYO49leDorAxmIcicmC6Fow5yRiTG+FmTea6/zki8CFeLG4c1qRSepb7OpLUoMCIH9LerDyeG3lKhtdtbLYPOEeBz7Eq2qlf/jiStWjK36PictgdEVVEvorRGZAcLJ8fMd1N3xe04wBslWqi1qulXJuPaAusrHcAZX6KFeNd29YtltLOdTou94vNktvGzYzZa2QwFHsTsPQE3OTBS9+JZfKQHwSPbg71bUHRfQCrZzY8tCeFg3bHN4KmyL6vdq3r4dQCAAc/SrUCppx youremail@example.com
</pre></div>
</div>
<p>配置Gitlab上的公钥认证</p>
<p><img alt="image2" src="../_images/gitlab-000ssh.png" /></p>
<p>编写一个Jenkinsfile文件上传到master分支中，Jenkinsfile文件就是之前的Hello
world。</p>
<p><img alt="image3" src="../_images/jenkins_test003.png" /></p>
<p>手动触发Jenkins任务。</p>
<p><img alt="image4" src="../_images/jenkins_test004.png" /></p>
<p>查看pipline执行日志输出</p>
<p><img alt="image5" src="../_images/gitlab-jenkins00002.png" /></p>
<p><strong>Jenkins SCM</strong> 在拉取代码时候执行输出如下信息</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="o">&gt;</span> <span class="n">git</span> <span class="n">init</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">jenkins_home</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">first_pipleline</span> <span class="c1"># timeout=10</span>
<span class="n">Fetching</span> <span class="n">upstream</span> <span class="n">changes</span> <span class="kn">from</span> <span class="nn">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.1.25</span><span class="p">:</span><span class="mi">10080</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">test_jenkins</span>
 <span class="o">&gt;</span> <span class="n">git</span> <span class="o">--</span><span class="n">version</span> <span class="c1"># timeout=10</span>
 <span class="o">&gt;</span> <span class="n">git</span> <span class="o">--</span><span class="n">version</span> <span class="c1"># &#39;git version 2.11.0&#39;</span>
<span class="n">using</span> <span class="n">GIT_ASKPASS</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">credentials</span>
 <span class="o">&gt;</span> <span class="n">git</span> <span class="n">fetch</span> <span class="o">--</span><span class="n">tags</span> <span class="o">--</span><span class="n">progress</span> <span class="o">--</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.1.25</span><span class="p">:</span><span class="mi">10080</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">test_jenkins</span> <span class="o">+</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/*</span><span class="p">:</span><span class="n">refs</span><span class="o">/</span><span class="n">remotes</span><span class="o">/</span><span class="n">origin</span><span class="o">/*</span> <span class="c1"># timeout=10</span>
 <span class="o">&gt;</span> <span class="n">git</span> <span class="n">config</span> <span class="n">remote</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">url</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.1.25</span><span class="p">:</span><span class="mi">10080</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">test_jenkins</span> <span class="c1"># timeout=10</span>
 <span class="o">&gt;</span> <span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="n">add</span> <span class="n">remote</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">fetch</span> <span class="o">+</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/*</span><span class="p">:</span><span class="n">refs</span><span class="o">/</span><span class="n">remotes</span><span class="o">/</span><span class="n">origin</span><span class="o">/*</span> <span class="c1"># timeout=10</span>
<span class="n">Avoid</span> <span class="n">second</span> <span class="n">fetch</span>
 <span class="o">&gt;</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">parse</span> <span class="n">refs</span><span class="o">/</span><span class="n">remotes</span><span class="o">/</span><span class="n">origin</span><span class="o">/</span><span class="n">master</span><span class="o">^</span><span class="p">{</span><span class="n">commit</span><span class="p">}</span> <span class="c1"># timeout=10</span>
<span class="n">Checking</span> <span class="n">out</span> <span class="n">Revision</span> <span class="mi">626</span><span class="n">d37de57ef1888c2a76d1bdf84dabb5ff66223</span> <span class="p">(</span><span class="n">refs</span><span class="o">/</span><span class="n">remotes</span><span class="o">/</span><span class="n">origin</span><span class="o">/</span><span class="n">master</span><span class="p">)</span>
 <span class="o">&gt;</span> <span class="n">git</span> <span class="n">config</span> <span class="n">core</span><span class="o">.</span><span class="n">sparsecheckout</span> <span class="c1"># timeout=10</span>
 <span class="o">&gt;</span> <span class="n">git</span> <span class="n">checkout</span> <span class="o">-</span><span class="n">f</span> <span class="mi">626</span><span class="n">d37de57ef1888c2a76d1bdf84dabb5ff66223</span> <span class="c1"># timeout=10</span>
</pre></div>
</div>
</section>
<section id="mavenjava">
<h3><a class="toc-backref" href="#id118">2.6 使用Maven构建Java应用</a><a class="headerlink" href="#mavenjava" title="Permalink to this headline">¶</a></h3>
<p>Jenkins上安装JDK和Maven。我们可以登录Jenkins服务器手动安装，也可以让Jenkins自动安装。这里选择后者。方法如下：</p>
<p><img alt="image6" src="../_images/jenkins_test005.png" /></p>
<p><img alt="image7" src="../_images/jenkins_test006.png" /></p>
<p><img alt="image8" src="../_images/jenkins_test007.png" /></p>
<p>当Jenkins执行到tools时，就会根据Maven的设置自动下载指定版本的Maven，并安装。tools是pipeline中的一个指令，用于自动安装工具，同时将其路径放到PATH变量中。通过命令sh
“printenv”，可以看到tools将MAVEN_HOME放到了当前任务的环境变量中。</p>
<p><code class="docutils literal notranslate"><span class="pre">Jenkinsfile</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>

    <span class="n">tools</span> <span class="p">{</span>
        <span class="n">maven</span> <span class="s1">&#39;mvn-3.5.4&#39;</span>
    <span class="p">}</span>

    <span class="n">stages</span><span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Build&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">sh</span> <span class="s2">&quot;mvn clean package spring-boot:repackage&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;printenv&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


<span class="p">}</span>
</pre></div>
</div>
<p>单击构建后，通过Jenkins执行日志，我们看到指定版本的Maven被下载和安装，mvn执行打包。</p>
<p><img alt="image9" src="../_images/jenkins_test008.png" /></p>
<p>两个完整的pipeline入门示例完成了。</p>
<p>总结：</p>
<p>Jenkins pipeline支持两种语法。</p>
<ul class="simple">
<li><p>node为根节点的是脚本式语法</p></li>
<li><p>pipeline为根节点的是声明式语法</p></li>
</ul>
<p>因为Jenkins pipeline毕竟只是工具，我们需要原则与实践的指导。</p>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id119">小结</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>参考文献</p>
<p><a class="reference external" href="https://blog.51cto.com/ygqygq2/2445184">https://blog.51cto.com/ygqygq2/2445184</a></p>
</section>
</section>
<section id="id11">
<h2><a class="toc-backref" href="#id120">3. pipeline语法讲解</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<section id="groovy">
<h3><a class="toc-backref" href="#id121">3.1 必要的Groovy知识</a><a class="headerlink" href="#groovy" title="Permalink to this headline">¶</a></h3>
<p>虽然学习Jenkins
pipeline可以不需要任何Groovy知识，但是学习以下Groovy知识，对于我们写pipeline如虎添翼。</p>
<blockquote>
<div><ul class="simple">
<li><p>虽然Groovy同时支持静态类型和动态类型，但是在定义变量时，在Groovy中我们习惯使用def关键字，比如def
x=“abc”、def y=1。</p></li>
<li><p>不像Java，Groovy语句最后的分号不是必需的。</p></li>
<li><p>Groovy中的方法调用可以省略括号，比如System.out.println “Hello
world”。</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><ol class="arabic simple">
<li><p>支持命名参数，比如：</p></li>
</ol>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">createName</span><span class="p">(</span><span class="n">String</span> <span class="n">givenName</span><span class="p">,</span> <span class="n">String</span> <span class="n">familyName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">givenName</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">familyName</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">调用时可以这样</span>
<span class="n">createName</span> <span class="n">familyName</span> <span class="o">=</span>  <span class="s2">&quot;Hujianli&quot;</span> <span class="p">,</span> <span class="n">givenName</span> <span class="o">=</span> <span class="s2">&quot;Jenkinfiles&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><ol class="arabic simple" start="2">
<li><p>支持默认参数值，比如：</p></li>
</ol>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sayHello</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;hujianli&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">print</span> <span class="s2">&quot;hello $</span><span class="si">{name}</span><span class="s2">&quot;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">调用</span>
<span class="n">sayHello</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><ol class="arabic simple" start="3">
<li><p>支持单引号、双引号。双引号支持插值，单引号不支持。比如：</p></li>
</ol>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>def name = &quot;world&quot;

// 结果：hello world
print &quot;hello ${name}&quot;

// 结果：hello ${name}
print &#39;hello ${name}&#39;&#39;
</pre></div>
</div>
<ul class="simple">
<li><ol class="arabic simple" start="4">
<li><p>支持三引号。三引号分为三单引号和三双引号。它们都支持换行，区别在于只有三双引号支持插值。比如：</p></li>
</ol>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>def strippedFirstNewline = &#39;&#39;&#39;line one
line two
line three
&#39;&#39;&#39;

// 可以写成下面这种形式，可读性更好

def strippedFirstNewline = &#39;&#39;&#39;\
line one
line two
line three
&#39;&#39;&#39;
</pre></div>
</div>
<ul class="simple">
<li><ol class="arabic simple" start="5">
<li><p>支持函数。</p></li>
</ol>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getSecure</span><span class="p">(</span><span class="n">String</span> <span class="n">Ticket_Token</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">token</span> <span class="o">=</span> <span class="s2">&quot;Ticket Token is &quot;</span> <span class="o">+</span> <span class="n">Ticket_Token</span>
  <span class="k">return</span> <span class="n">token</span>
<span class="p">}</span>

<span class="n">println</span> <span class="n">getSecure</span><span class="p">(</span><span class="s2">&quot;weiyigeek&quot;</span><span class="p">)</span>  <span class="o">//</span><span class="n">Ticket</span> <span class="n">Token</span> <span class="ow">is</span> <span class="n">weiyigeek</span>
</pre></div>
</div>
<ul class="simple">
<li><ol class="arabic simple" start="6">
<li><p>支持闭包。闭包的定义方法如下：</p></li>
</ol>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="c1"># 闭包的定义方法：</span>
<span class="k">def</span> <span class="nf">codeBlock</span> <span class="o">=</span> <span class="p">{</span><span class="nb">print</span> <span class="s2">&quot;hello world!&quot;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">codeBlock</span><span class="p">()</span> <span class="o">//</span>

<span class="o">//</span> <span class="c1"># 闭包的另类用法:</span>
<span class="o">//</span> <span class="n">定义一个stage函数</span>
<span class="k">def</span> <span class="nf">stage</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">closue</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">println</span> <span class="n">name</span>
  <span class="k">def</span> <span class="nf">closue</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">println</span> <span class="s2">&quot;闭包调用的 closue function!&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">stage</span><span class="p">(</span><span class="s2">&quot;stage name&quot;</span><span class="p">,{</span><span class="n">println</span> <span class="s2">&quot;closue&quot;</span><span class="p">})</span>
</pre></div>
</div>
<ul class="simple">
<li><ol class="arabic simple" start="7">
<li><p>支持类定义和实例化。</p></li>
</ol>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>class Greet {
  def name
  Greet(who) { name = who[0].toUpperCase() + who[1..-1] }
  def salute() { println &quot;Hello &quot; + name + &quot;!&quot; }
}

g = new Greet(&#39;world&#39;)  // create object
g.salute()   // Hello World!
</pre></div>
</div>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id122">3.2 pipeline的组成</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>Jenkins
pipeline其实就是基于Groovy语言实现的一种DSL（领域特定语言），用于描述整条流水线是如何进行的。流水线的内容包括执行编译、打包、测试、输出测试报告等步骤。</p>
<section id="id13">
<h4>1. pipeline最简结构<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>一个基本的pipeline结构:</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Example Build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s1">&#39;Hello World&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• pipeline：代表整条流水线，包含整条流水线的逻辑。


• stage部分：阶段，代表流水线的阶段。每个阶段都必须有名称。本例中，build就是此阶段的名称。


• stages部分：流水线中多个stage的容器。stages部分至少包含一个stage。


• steps部分：代表阶段中的一个或多个具体步骤（step）的容器。steps部分至少包含一个步骤，本例中，echo就是一个步骤。在一个stage中有且只有一个steps。


• agent部分：指定流水线的执行位置（Jenkins agent）。流水线中的每个阶段都必须在某个地方（物理机、虚拟机或Docker容器）执行，agent部分即指定具体在哪里执行。
</pre></div>
</div>
<blockquote>
<div><p>jenkins-pipeline：在Jenkinsfile中配置多个代理</p>
<p><a class="reference external" href="https://zhuanlan.zhihu.com/p/147262645">https://zhuanlan.zhihu.com/p/147262645</a></p>
</div></blockquote>
</section>
<section id="id14">
<h4>2. 步骤<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p>pipeline基本结构决定的是pipeline整体流程，但是真正“做事”的还是pipeline中的每一个步骤。<code class="docutils literal notranslate"><span class="pre">步骤是pipeline中已经不能再拆分的最小操作。</span></code></p>
<p>前文中，我们只看到两个步骤：sh和echo。</p>
<p>sh是指执行一条shell命令；echo是指执行echo命令。这两个步骤只是Jenkins
pipeline内置的大量步骤中的两个。</p>
<p>pipeline
plugin的GitHub仓库给出了一个列表（<a class="reference external" href="https://github.com/jenkinsci/pipeline-plugin/blob/master/COMPATIBILITY.md">https://github.com/jenkinsci/pipeline-plugin/blob/master/COMPATIBILITY.md</a>）方便大家检索。</p>
<p>Jenkins官方还提供了pipeline步骤参考文档（<a class="reference external" href="https://jenkins.io/doc/pipeline/steps/">https://jenkins.io/doc/pipeline/steps/</a>）。</p>
</section>
<section id="post">
<h4>3. post部分<a class="headerlink" href="#post" title="Permalink to this headline">¶</a></h4>
<p>包含的是在整个pipeline或阶段完成后一些附加的步骤。</p>
<p>post部分是可选的，所以并不包含在pipeline最简结构中。但这并不代表它作用不大。</p>
<p>根据pipeline或阶段的完成状态，post部分分成多种条件块，包括：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• always：无论流水线或阶段的完成状态如何，都允许在 post 部分运行该步骤。

• changed：只有当前流水线或阶段的完成状态与它之前的运行不同时，才允许在 post 部分运行该步骤。

• fixed：上一次完成状态为失败或不稳定（unstable），当前完成状态为成功时执行。

• regression：上一次完成状态为成功，当前完成状态为失败、不稳定或中止（aborted）时执行。

• aborted：当前执行结果是中止状态时（一般为人为中止）执行, 通常由于流水线被手动的aborted。通常web UI是灰色。

• failure：当前完成状态为失败时执行,通常web UI是红色。

• success：当前完成状态为成功时执行,通常web UI是蓝色或绿色。

• unstable：当前完成状态为不稳定时执行,通常由于测试失败,代码违规等造成。通常web UI是黄色。

• cleanup：清理条件块。不论当前完成状态是什么，在其他所有条件块执行完成后都执行。
</pre></div>
</div>
<p>post部分可以同时包含多种条件块。</p>
<p>以下是post部分的完整示例。</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>

    <span class="n">stages</span><span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s2">&quot;build&quot;</span><span class="o">){</span>
            <span class="n">steps</span><span class="o">{</span>
                <span class="n">echo</span> <span class="s2">&quot;build stage&quot;</span>
            <span class="o">}</span>

            <span class="n">post</span><span class="o">{</span>
                <span class="n">always</span> <span class="o">{</span>
                    <span class="n">echo</span> <span class="s2">&quot;stage post always....&quot;</span>
                <span class="o">}</span>
            <span class="o">}</span>

        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">post</span><span class="o">{</span>
        <span class="n">changed</span><span class="o">{</span>
            <span class="n">echo</span> <span class="s2">&quot;pipeline post change&quot;</span>
            <span class="o">}</span>
        <span class="n">always</span><span class="o">{</span>
            <span class="n">echo</span> <span class="s2">&quot;pipeline post always&quot;</span>
        <span class="o">}</span>
        <span class="n">success</span><span class="o">{</span>
            <span class="n">echo</span> <span class="s2">&quot;pipeline post success&quot;</span>
        <span class="o">}</span>
        <span class="c1">// 省略其他条件</span>
    <span class="o">}</span>


<span class="o">}</span>
</pre></div>
</div>
<p><strong>pipeline支持的指令</strong></p>
<p>显然，基本结构满足不了现实多变的需求。所以，Jenkins
pipeline通过各种指令（directive）来丰富自己。指令可以被理解为对Jenkins
pipeline基本结构的补充。</p>
<p>Jenkins pipeline支持的指令有：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• environment：用于设置环境变量，可定义在stage或pipeline部分。

• tools：可定义在pipeline或stage部分。它会自动下载并安装我们指定的工具，并将其加入PATH变量中。

• input：定义在stage部分，会暂停pipeline，提示你输入内容。

• options：用于配置Jenkins pipeline本身的选项，比如options {retry（3）}指当pipeline失败时再重试2次。options指令可定义在stage或pipeline部分。

• parallel：并行执行多个step。在pipeline插件1.2版本后，parallel开始支持对多个阶段进行并行执行。

• parameters：与input不同，parameters是执行pipeline前传入的一些参数。

• triggers：用于定义执行pipeline的触发器。

• when：当满足when定义的条件时，阶段才执行。
</pre></div>
</div>
<p>在使用指令时，需要注意的是每个指令都有自己的“作用域”。如果指令使用的位置不正确，Jenkins将会报错。</p>
<ul class="simple">
<li><p>parallel示例</p></li>
</ul>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Non-Parallel Stage&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s1">&#39;This stage will be executed first.&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Parallel Stage&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">failFast</span> <span class="kc">true</span>
            <span class="n">parallel</span> <span class="o">{</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;并行一 打印ENV&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                      <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                          printenv</span>
<span class="s1">                    &#39;&#39;&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;并行二&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;并行二&quot;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;并行三&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">stages</span> <span class="o">{</span>
                        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Nested 1&#39;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">steps</span> <span class="o">{</span>
                                <span class="n">echo</span> <span class="s2">&quot;In stage Nested 1 within Branch C&quot;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Nested 2&#39;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">steps</span> <span class="o">{</span>
                                <span class="n">echo</span> <span class="s2">&quot;In stage Nested 2 within Branch C&quot;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>CI流程效果图如下</p>
<p><img alt="image10" src="../_images/image-20220520182556265.png" /></p>
</section>
<section id="id15">
<h4>4. 配置pipeline本身<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>options指令用于配置整个Jenkins
pipeline本身的选项。根据具体的选项不同，可以将其放在pipeline块或stage块中。</p>
<section id="builddiscarder">
<h5>buildDiscarder<a class="headerlink" href="#builddiscarder" title="Permalink to this headline">¶</a></h5>
<p>保存最近历史构建记录的数量，比较熟悉Jenkins的童鞋应该明白这个参数的意义，可以有效控制Jenkins主机存储空间。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">表示保留10次构建历史</span>
    <span class="n">buildDiscarder</span><span class="p">(</span><span class="n">logRotator</span><span class="p">(</span><span class="n">numToKeepStr</span><span class="p">:</span> <span class="s1">&#39;10&#39;</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="checkouttosubdirectory">
<h5>checkoutToSubdirectory<a class="headerlink" href="#checkouttosubdirectory" title="Permalink to this headline">¶</a></h5>
<p>Jenkins从版本控制库拉取源码时，默认检出到工作空间的根目录中，此选项可以指定检出到工作空间的子目录中。示例如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="p">{</span>
    <span class="n">checkoutToSubdirectory</span><span class="p">(</span><span class="s1">&#39;testdir&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="disableconcurrentbuilds">
<h5>disableConcurrentBuilds<a class="headerlink" href="#disableconcurrentbuilds" title="Permalink to this headline">¶</a></h5>
<p>同一个pipeline，Jenkins默认是可以同时执行多次的，此选项是为了禁止pipeline同时执行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="p">{</span>
    <span class="n">disableConcurrentBuilds</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="newcontainerperstage">
<h5>newContainerPerStage<a class="headerlink" href="#newcontainerperstage" title="Permalink to this headline">¶</a></h5>
<p>当agent为docker或dockerfile时，指定在同一个Jenkins节点上，每个stage都分别运行在一个新的容器中，而不是所有stage都运行在同一个容器中。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="p">{</span>
    <span class="n">newContainerPerStage</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="retry">
<h5>retry<a class="headerlink" href="#retry" title="Permalink to this headline">¶</a></h5>
<p>当发生失败时进行重试，可以指定整个pipeline的重试次数。需要注意的是，这个次数是指总次数，包括第1次失败。以下例子总共会执行4次。当使用retry选项时，options可以被放在stage块中。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="p">{</span>
    <span class="n">retry</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="timeout">
<h5>timeout<a class="headerlink" href="#timeout" title="Permalink to this headline">¶</a></h5>
<p>设置项目构建超时时间，很明显，如果超时，将会以失败状态结束构建。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>options {
    // 设置流水线运行的超过10分钟，Jenkins将中止流水线
    timeout(time: 10, unit: &#39;MINUTES&#39;)
}
</pre></div>
</div>
</section>
<section id="timestamps">
<h5>timestamps<a class="headerlink" href="#timestamps" title="Permalink to this headline">¶</a></h5>
<p>设置在项目打印日志时带上对应时间。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">输出构建的时间信息</span>
  <span class="n">timestamps</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="skipdefaultcheckout">
<h5>skipDefaultCheckout<a class="headerlink" href="#skipdefaultcheckout" title="Permalink to this headline">¶</a></h5>
<p>在<code class="docutils literal notranslate"><span class="pre">agent</span></code> 指令中，跳过从源代码控制中检出代码的默认情况。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">跳过默认的代码检出</span>
    <span class="n">skipDefaultCheckout</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id16">
<h5>常用汇总<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="p">{</span>
  <span class="n">disableResume</span><span class="p">()</span>
  <span class="n">skipDefaultCheckout</span><span class="p">()</span>
  <span class="n">quietPeriod</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
  <span class="n">timestamps</span><span class="p">()</span>
  <span class="n">buildDiscarder</span><span class="p">(</span><span class="n">logRotator</span><span class="p">(</span><span class="n">numToKeepStr</span><span class="p">:</span> <span class="s1">&#39;100&#39;</span><span class="p">))</span>
  <span class="n">timeout</span><span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id17">
<h4>5. 声明式pipeline中使用脚本<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<p>描述: 前面我们说过我们可在<code class="docutils literal notranslate"><span class="pre">Declarative</span> <span class="pre">Pipeline</span></code> 中
采用script指令来执行<code class="docutils literal notranslate"><span class="pre">Scripted</span> <span class="pre">Pipeline</span></code>中的一些脚本;</p>
<p>Jenkins
pipeline专门提供了一个script步骤，你能在script步骤中像写代码一样写pipeline逻辑。比如分别在不同的浏览器上跑测试。</p>
<p>例子.单步式声明式 &amp;&amp; Script Block in Declarative Pipeline</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pipeline {
    agent any
    stages {
        stage(&#39;Example&#39;) {
          // 步骤部分必须包含一个或多个步骤。
          steps {
              echo &#39;Hello World&#39;
              // 执行 Scripted Pipeline (实际上就是直接执行并采用Groovy原生语法)
              script {
                def browsers = [&#39;chrome&#39;, &#39;firefox&#39;]
                for (int i = 0; i &lt; browsers.size(); ++i) {
                    echo &quot;Testing the ${browsers[i]} browser&quot;
                }
              }
          }
        }
    }
}
</pre></div>
</div>
<p>如果在script步骤中写了大量的逻辑，则说明你应该把这些逻辑拆分到不同的阶段，或者放到共享库中</p>
</section>
<section id="id18">
<h4>6 pipeline内置基础步骤<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<section id="deletedir">
<h5>deleteDir<a class="headerlink" href="#deletedir" title="Permalink to this headline">¶</a></h5>
<p>删除当前目录.deleteDir是一个无参步骤，删除的是当前工作目录。通常它与dir步骤一起使用，用于删除指定目录下的内容。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stage</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">steps</span> <span class="p">{</span>
        <span class="n">echo</span> <span class="s1">&#39;清理工作目录&#39;</span>
        <span class="n">deleteDir</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>另外还有一个clean（此方法依赖于插件
<code class="docutils literal notranslate"><span class="pre">Workspace</span> <span class="pre">Cleanup</span></code>）清理工作空间时用法与之类似。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stage</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">steps</span> <span class="p">{</span>
        <span class="n">echo</span> <span class="s1">&#39;清理工作目录&#39;</span>
        <span class="n">cleanWs</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>区别在于deleteDir可以指定目录删除。</p>
</section>
<section id="dir">
<h5>dir<a class="headerlink" href="#dir" title="Permalink to this headline">¶</a></h5>
<p>切换到目录.默认pipeline工作在工作空间目录下，dir步骤可以让我们切换到其他目录。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">dir</span><span class="p">(</span><span class="s2">&quot;/var/logs&quot;</span><span class="p">){</span>
        <span class="n">deleteDir</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="fileexists">
<h5>fileExists<a class="headerlink" href="#fileexists" title="Permalink to this headline">¶</a></h5>
<p>判断文件是否存在。可用绝对路径，也可以使用相对路径，相对路径的时候，记住是基于
<code class="docutils literal notranslate"><span class="pre">$WORKSPACE</span></code>的。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">environment</span> <span class="p">{</span>
        <span class="n">git_url</span>     <span class="o">=</span> <span class="s2">&quot;git@192.168.3.65:jenkins-learn/hello-world.git&quot;</span>
        <span class="n">remote_ip</span>   <span class="o">=</span> <span class="s2">&quot;192.168.3.67&quot;</span>
        <span class="n">remote_dir</span>  <span class="o">=</span> <span class="s2">&quot;/opt/hello&quot;</span>
    <span class="p">}</span>
    <span class="n">options</span> <span class="p">{</span>
        <span class="n">buildDiscarder</span><span class="p">(</span><span class="n">logRotator</span><span class="p">(</span><span class="n">numToKeepStr</span><span class="p">:</span> <span class="s1">&#39;10&#39;</span><span class="p">))</span>
        <span class="n">disableConcurrentBuilds</span><span class="p">()</span>
        <span class="n">timestamps</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;rsync&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">script</span> <span class="p">{</span>
                    <span class="n">build_file</span> <span class="o">=</span> <span class="s2">&quot;$WORKSPACE/README.md&quot;</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">fileExists</span><span class="p">(</span><span class="n">build_file</span><span class="p">)</span> <span class="o">==</span> <span class="n">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        rsync -avz --progress -e &#39;ssh -p 22&#39; --exclude=&#39;Jenkinsfile&#39; --exclude=&#39;.git&#39; --delete $</span><span class="si">{WORKSPACE}</span><span class="s1">/  root@$remote_ip:$remote_dir</span>
<span class="s1">                    &#39;&#39;&#39;</span>
                    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
                        <span class="n">error</span><span class="p">(</span><span class="s2">&quot;here haven&#39;t find json file&quot;</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s1">&#39;清理工作目录&#39;</span>
                <span class="n">cleanWs</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">post</span> <span class="p">{</span>
        <span class="n">success</span> <span class="p">{</span>
            <span class="n">sh</span> <span class="s2">&quot;echo 成功了&quot;</span>
        <span class="p">}</span>
        <span class="n">failure</span> <span class="p">{</span>
            <span class="n">sh</span> <span class="s2">&quot;echo 失败了&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这个例子比较适合生产当中的情境，部署的步骤放在编译的后边，如果编译之后，Java项目的war包没有生成，那么我们跳出构建，如果生成了，则执行构建的步骤。</p>
</section>
<section id="error">
<h5>error<a class="headerlink" href="#error" title="Permalink to this headline">¶</a></h5>
<p><strong>主动报错，中止当前pipeline</strong></p>
<p>error
步骤的执行类似于抛出一个异常。它只有一个必需参数：message。通常省略参数：error（“there’s
an error”）。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stage</span><span class="p">(</span><span class="s1">&#39;npm build&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">steps</span> <span class="p">{</span>
        <span class="n">script</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">BUILD_EXPRESSION</span> <span class="o">==</span> <span class="n">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                npm run build-i18n</span>
<span class="s1">                sleep 3</span>
<span class="s1">            &#39;&#39;&#39;</span>
          <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
              <span class="n">error</span><span class="p">(</span><span class="s2">&quot;npm install error!!!&quot;</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="timeout-1">
<span id="id19"></span><h5>timeout<a class="headerlink" href="#timeout-1" title="Permalink to this headline">¶</a></h5>
<p>代码块超时时间。通常这在执行一些编译步骤如遇不可知情况导致编译失败而又不退出的情况。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">timeout</span><span class="p">(</span><span class="mi">20</span><span class="p">){</span>
        <span class="n">steps</span><span class="p">{</span>
        <span class="n">sh</span> <span class="s1">&#39;rsync -avz --progress -e &#39;</span><span class="n">ssh</span> <span class="o">-</span><span class="n">p</span> <span class="mi">22</span><span class="s1">&#39; --exclude=&#39;</span><span class="n">Jenkinsfile</span><span class="s1">&#39; --exclude=&#39;</span><span class="o">.</span><span class="n">git</span><span class="s1">&#39; --delete $</span><span class="si">{WORKSPACE}</span><span class="s1">/  root@$remote_ip:$remote_dir&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="waitutil">
<h5>waitUtil<a class="headerlink" href="#waitutil" title="Permalink to this headline">¶</a></h5>
<p>等待条件满足，不断重复代码块中的内容，直到条件为true。这个功能的应用场景我倒是想到了一个，很贴切，有一些服务在生产环境跑着，并不能直接关闭发布，而往往加入一个优雅停机的功能，因此调用停机接口之后，我们就可以做一个等待，等待服务端口彻底关闭之后，再进行部署，当然，最好再配合一下timeout，以避免死循环。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">timeout</span><span class="p">(</span><span class="mi">10</span><span class="p">){</span>
    <span class="n">waitUntil</span><span class="p">{</span>
        <span class="n">script</span><span class="p">{</span>
            <span class="k">def</span> <span class="nf">r</span> <span class="o">=</span> <span class="n">sh</span> <span class="n">script</span><span class="p">:</span> <span class="s1">&#39;curl http://exmaple&#39;</span><span class="p">,</span><span class="n">returnStatus</span><span class="p">:</span> <span class="n">true</span>
            <span class="k">return</span> <span class="p">(</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="retry-1">
<span id="id20"></span><h5>retry<a class="headerlink" href="#retry-1" title="Permalink to this headline">¶</a></h5>
<p>重复执行某个块，如果某次执行中有异常，则跳出当次，而不会影响整体。注意，在执行retry过程中，用户无法手动终止流水线。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">steps</span> <span class="p">{</span>
    <span class="n">retry</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">script</span><span class="p">{</span>
        <span class="n">sh</span> <span class="n">script</span><span class="p">:</span> <span class="s1">&#39;curl http://exmaple&#39;</span><span class="p">,</span><span class="n">returnStatus</span><span class="p">:</span> <span class="n">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="sleep">
<h5>sleep<a class="headerlink" href="#sleep" title="Permalink to this headline">¶</a></h5>
<p>让pipeline睡眠一段时间。</p>
<p>支持参数如下：</p>
<ul class="simple">
<li><p>time：整型，休眠时间。</p></li>
<li><p>unit：时间单位，支持的值有NANOSECONDS,MICROSECONDS,MILLISECONDS,SECONDS(默认),MINUTES,HOURS,DAYS.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sleep</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span> <span class="o">//</span><span class="n">休眠120秒</span>
<span class="n">sleep</span><span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="n">unit</span><span class="p">:</span> <span class="s2">&quot;MINUTES&quot;</span><span class="p">)</span> <span class="o">//</span><span class="n">休眠2分钟</span>
</pre></div>
</div>
</section>
<section id="try-catch">
<h5>try&amp;catch<a class="headerlink" href="#try-catch" title="Permalink to this headline">¶</a></h5>
<p>简单说明就是，流水线会顺行执行try关键字块内的语句，如果所有语句执行都正常，那么程序正常退出，如果有异常，则catch部分将会捕捉错误，进行打印，并退出整个流水线，这一点非常关键，某个阶段有异常，整个构建结束，这一特性，值得推广到所有的流水线当中应用起来。</p>
<p>简单示例</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">stages</span><span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Example1&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">script</span> <span class="p">{</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="n">echo</span> <span class="s1">&#39;aaa&#39;</span>
                        <span class="n">eccho</span> <span class="s1">&#39;bbb&#39;</span>
                        <span class="n">echo</span> <span class="s1">&#39;ccc&#39;</span>
                    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">echo</span> <span class="s1">&#39;err&#39;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Example2&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">script</span> <span class="p">{</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="n">echo</span> <span class="s1">&#39;aaa&#39;</span>
                        <span class="n">echo</span> <span class="s1">&#39;ccc&#39;</span>
                    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">echo</span> <span class="s1">&#39;err&#39;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">post</span><span class="p">{</span>
        <span class="n">always</span><span class="p">{</span>
            <span class="n">echo</span> <span class="s2">&quot;========always========&quot;</span>
        <span class="p">}</span>
        <span class="n">success</span><span class="p">{</span>
            <span class="n">echo</span> <span class="s2">&quot;========pipeline executed successfully ========&quot;</span>
        <span class="p">}</span>
        <span class="n">failure</span><span class="p">{</span>
            <span class="n">echo</span> <span class="s2">&quot;========pipeline execution failed========&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>isUnix：判断是否为类UNIX系统
如果当前pipeline运行在一个类UNIX系统上，则返回true。

pwd：确认当前目录
pwd与Linux的pwd命令一样，返回当前所在目录。它有一个布尔类型的可选参数：tmp，如果参数值为true，则返回与当前工作空间关联的临时目录。

writeFile：将内容写入指定文件中
writeFile支持的参数有：
• file：文件路径，可以是绝对路径，也可以是相对路径。
• text：要写入的文件内容。
• encoding（可选）：目标文件的编码。如果留空，则使用操作系统默认的编码。如果写的是Base64的数据，则可以使用Base64编码。


readFile：读取文件内容
读取指定文件的内容，以文本返回。readFile支持的参数有：
• file：路径，可以是绝对路径，也可以是相对路径。
• encoding（可选）：读取文件时使用的编码。
</pre></div>
</div>
</section>
<section id="id21">
<h5>制品相关步骤<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>stash：保存临时文件
stash步骤可以将一些文件保存起来，以便被同一次构建的其他步骤或阶段使用。如果整个pipeline的所有阶段在同一台机器上执行，则stash步骤是多余的。所以，通常需要stash的文件都是要跨Jenkins node使用的。


unstash：取出之前stash的文件
unstash步骤只有一个name参数，即stash时的唯一标识。
</pre></div>
</div>
</section>
<section id="id22">
<h5>命令相关步骤<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh：执行shell命令
参考：https://www.qedev.com/auto/214147.html

bat、powershell步骤
</pre></div>
</div>
<p>Jenkinsfile 中获取shell命令的标准输出或者状态</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">product_name</span> <span class="o">=</span> <span class="n">sh</span> <span class="p">(</span><span class="n">returnStdout</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
           <span class="n">script</span><span class="p">:</span> <span class="s2">&quot;grep ^product_name: schema.yml| awk &#39;{print \$2}&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>获取标准输出</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">第一种</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sh</span> <span class="n">returnStdout</span><span class="p">:</span> <span class="n">true</span> <span class="p">,</span><span class="n">script</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span>
<span class="o">//</span><span class="n">第二种</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sh</span><span class="p">(</span><span class="n">script</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">returnStdout</span><span class="p">:</span> <span class="n">true</span><span class="p">)</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span>
<span class="o">//</span><span class="n">第三种</span>
<span class="n">sh</span> <span class="s2">&quot; &gt; commandResult&quot;</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">readFile</span><span class="p">(</span><span class="s1">&#39;commandResult&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>获取执行状态</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">第一种</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sh</span> <span class="n">returnStatus</span><span class="p">:</span> <span class="n">true</span> <span class="p">,</span><span class="n">script</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span>

<span class="o">//</span><span class="n">第二种</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sh</span><span class="p">(</span><span class="n">script</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">returnStatus</span><span class="p">:</span> <span class="n">true</span><span class="p">)</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span>

<span class="o">//</span><span class="n">第三种</span>
<span class="n">sh</span> <span class="s1">&#39;; echo $? &gt; status&#39;</span>
<span class="k">def</span> <span class="nf">r</span> <span class="o">=</span> <span class="n">readFile</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span> <span class="o">//</span><span class="n">值得学习</span>

<span class="o">//</span><span class="n">第四种</span>
<span class="n">sh</span> <span class="n">label</span><span class="p">:</span> <span class="s1">&#39;release&#39;</span><span class="p">,</span> <span class="n">returnStdout</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="n">script</span><span class="p">:</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">sudo apk add jq &amp;&amp; </span><span class="se">\</span>
<span class="s2">if ( \$(curl -s --header &#39;PRIVATE-TOKEN: $</span><span class="si">{private_token}</span><span class="s2">&#39; $</span><span class="si">{GITLAB_REL}</span><span class="s2"> | jq .[].tag_name | grep -c &#39;$</span><span class="si">{params.RELEASE_VERSION}</span><span class="s2">&#39;) != 0 );then echo -n 1 &gt; result.txt;else echo -n 0 &gt; result.txt;fi</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="k">def</span> <span class="nf">r</span> <span class="o">=</span> <span class="n">readFile</span><span class="p">(</span><span class="s1">&#39;result.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span> <span class="o">//</span><span class="n">值得学习</span>

<span class="o">//</span> <span class="n">注意使用</span><span class="s1">&#39;但引号也可以解析变量</span>
<span class="n">sh</span><span class="p">(</span><span class="n">returnStatus</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="n">script</span><span class="p">:</span> <span class="s2">&quot;sudo apk add jq &amp;&amp; curl -s --header &#39;PRIVATE-TOKEN: $</span><span class="si">{private_token}</span><span class="s2">&#39; $</span><span class="si">{GITLAB_REL}</span><span class="s2"> | jq .[].tag_name | grep -c &#39;$</span><span class="si">{params.RELEASE_VERSION}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>只需要执行shell命令</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>`sh &#39;&lt;shell command&gt;&#39;
</pre></div>
</div>
<p>简单示例</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">result</span> <span class="o">=</span> <span class="n">sh</span><span class="p">(</span><span class="n">script</span><span class="p">:</span> <span class="s2">&quot;grep -i &#39;xxx&#39; /etc/myfolder&quot;</span><span class="p">,</span> <span class="n">returnStatus</span><span class="p">:</span> <span class="n">true</span><span class="p">)</span>
<span class="n">echo</span> <span class="s2">&quot;return result :$</span><span class="si">{result}</span><span class="s2">&quot;</span>
<span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
   <span class="n">如果命令没有正常执行的时候执行的代码快</span>
<span class="p">}</span>
</pre></div>
</div>
<p>实践示例</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="c1"># (1) 命令拼接</span>
<span class="n">sh</span> <span class="s1">&#39; $SonarScannerHome/bin/sonar-scanner &#39;</span> <span class="o">+</span>
    <span class="s1">&#39;-Dsonar.sources=src/main &#39;</span> <span class="o">+</span>
    <span class="s1">&#39;-Dsonar.projectKey=&quot;test&quot; &#39;</span> <span class="o">+</span>
    <span class="s1">&#39;-Dsonar.projectName=&quot;test&quot; &#39;</span>

<span class="o">//</span> <span class="c1"># (2) 值传递到参数</span>
<span class="n">stage</span> <span class="p">(</span><span class="s2">&quot;测试&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">steps</span> <span class="p">{</span>
    <span class="n">timeout</span><span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">script</span> <span class="p">{</span>
          <span class="k">def</span> <span class="nf">RELEASE</span><span class="o">=</span><span class="n">sh</span> <span class="n">returnStdout</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="n">script</span><span class="p">:</span> <span class="s1">&#39;git tag -l --column&#39;</span>   <span class="o">//</span> <span class="c1"># git show --oneline --ignore-all-space --text | head -n 1</span>
          <span class="n">env</span><span class="o">.</span><span class="n">DEPLOY_ENV</span> <span class="o">=</span> <span class="nb">input</span> <span class="n">message</span><span class="p">:</span> <span class="s2">&quot;选择部署的环境的版本&quot;</span><span class="p">,</span> <span class="n">ok</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span>
              <span class="n">parameters</span><span class="p">:</span> <span class="p">[</span><span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;DEPLOY_ENV&#39;</span><span class="p">,</span><span class="n">defaultValue</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">{RELEASE}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">description</span><span class="p">:</span> <span class="s2">&quot;可选项选择的版本 $</span><span class="si">{RELEASE}</span><span class="s2">&quot;</span><span class="p">)]</span>
         <span class="p">}</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span> <span class="c1"># (3) 多行命令执行(值得注意在sh中得 $符号 需要采用 \$ 进行转义)</span>
<span class="n">stage</span> <span class="p">(</span><span class="s2">&quot;测试&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">steps</span> <span class="p">{</span>
      <span class="n">timeout</span><span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">script</span> <span class="p">{</span>
          <span class="k">def</span> <span class="nf">RELEASE</span><span class="o">=</span><span class="n">sh</span> <span class="n">returnStdout</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="n">script</span><span class="p">:</span> <span class="s1">&#39;git tag -l --column&#39;</span>
          <span class="k">def</span> <span class="nf">RELE</span><span class="o">=</span><span class="n">sh</span> <span class="n">returnStdout</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="n">script</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">          git tag -l --column | tr -d &#39; &#39;  &gt; tag ;</span>
<span class="s2">          export a=&quot;\$(sed &quot;s#v#,&#39;v#g&quot; tag)&#39;&quot;;</span>
<span class="s2">          echo [\${a#,*}];</span>
<span class="s2">          &quot;&quot;&quot;</span>
          <span class="o">//</span> <span class="n">env</span><span class="o">.</span><span class="n">DEPLOY_ENV</span> <span class="o">=</span> <span class="nb">input</span> <span class="n">message</span><span class="p">:</span> <span class="s2">&quot;选择部署的环境的版本1&quot;</span><span class="p">,</span> <span class="n">ok</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span>
          <span class="o">//</span>     <span class="n">parameters</span><span class="p">:</span> <span class="p">[</span><span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;DEPLOY_ENV&#39;</span><span class="p">,</span><span class="n">defaultValue</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">{RELEASE}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">description</span><span class="p">:</span> <span class="s2">&quot;可选项选择的版本 $</span><span class="si">{RELEASE}</span><span class="s2">&quot;</span><span class="p">)]</span>
          <span class="o">//</span> <span class="p">}</span>
          <span class="n">println</span> <span class="n">RELE</span> <span class="o">//</span> <span class="p">[</span><span class="s1">&#39;v1.1,&#39;</span><span class="n">v1</span><span class="mf">.10</span><span class="p">,</span><span class="s1">&#39;v1.11,&#39;</span><span class="n">v1</span><span class="mf">.2</span><span class="p">,</span><span class="s1">&#39;v1.3,&#39;</span><span class="n">v1</span><span class="mf">.6</span><span class="p">,</span><span class="s1">&#39;v1.7,&#39;</span><span class="n">v1</span><span class="mf">.8</span><span class="p">,</span><span class="s1">&#39;v1.9&#39;</span><span class="p">]</span>
          <span class="o">//</span> <span class="n">选择部署的环境的版本</span> <span class="p">[</span><span class="s1">&#39;v1.1,&#39;</span><span class="n">v1</span><span class="mf">.10</span><span class="p">,</span><span class="s1">&#39;v1.11,&#39;</span><span class="n">v1</span><span class="mf">.2</span><span class="p">,</span><span class="s1">&#39;v1.3,&#39;</span><span class="n">v1</span><span class="mf">.6</span><span class="p">,</span><span class="s1">&#39;v1.7,&#39;</span><span class="n">v1</span><span class="mf">.8</span><span class="p">,</span><span class="s1">&#39;v1.9&#39;</span><span class="p">]</span>
          <span class="n">env</span><span class="o">.</span><span class="n">DEPLOY_RELEASE</span> <span class="o">=</span> <span class="nb">input</span> <span class="n">message</span><span class="p">:</span> <span class="s2">&quot;选择部署的环境的版本 $</span><span class="si">{RELE}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ok</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span>
          <span class="n">parameters</span><span class="p">:</span> <span class="p">[</span><span class="n">choice</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;PREJECT_OPERATION&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ss&quot;</span><span class="p">,</span><span class="s2">&quot;s&quot;</span><span class="p">],</span> <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;Message: 选择项目版本? $</span><span class="si">{RELE}</span><span class="s1">&#39;</span><span class="p">)]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id23">
<h4>7. 使用pipeline代码片段生成器学习<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<p>对于初学Jenkins
pipeline的新人来说，如何开始写pipeline是一个坎儿。好在Jenkins提供了一个pipeline代码片段生成器，通过界面操作就可以生成代码。</p>
<p>进入“Pipeline Syntax”页面后，在右边的“Sample
Step”下拉框中选择需要生成代码的步骤，并根据提示填入参数，然后单击“Generate
Pipeline Script”按钮，就可以生成代码了。</p>
</section>
<section id="jenkins-linter-idea-plugin">
<h4>8. 使用jenkins-linter-idea-plugin 插件<a class="headerlink" href="#jenkins-linter-idea-plugin" title="Permalink to this headline">¶</a></h4>
<p>jenkins-linter-idea-plugin 插件检查语法。该扩展只能利用Jenkins
API进行语法校验。</p>
</section>
<section id="workspace-cleanup">
<h4>9. 使用Workspace Cleanup插件清理空间<a class="headerlink" href="#workspace-cleanup" title="Permalink to this headline">¶</a></h4>
<p>通常，当pipeline执行完成后，并不会自动清理空间。如果需要（通常需要）清理工作空间，则可以通过Workspace
Cleanup插件实现。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">post</span><span class="p">{</span>
    <span class="n">changed</span><span class="p">{</span>
        <span class="n">echo</span> <span class="s2">&quot;pipeline post change&quot;</span>
        <span class="p">}</span>
    <span class="n">always</span><span class="p">{</span>
        <span class="n">echo</span> <span class="s2">&quot;pipeline post always&quot;</span>
        <span class="o">//</span> <span class="n">使用插件清理空间</span>  <span class="n">Deleting</span> <span class="n">project</span> <span class="n">workspace</span><span class="o">...</span>
        <span class="n">cleanWs</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">success</span><span class="p">{</span>
        <span class="n">echo</span> <span class="s2">&quot;pipeline post success&quot;</span>
    <span class="p">}</span>
    <span class="o">//</span> <span class="n">省略其他条件</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="ant">
<h4>10. Ant风格路径表达式简介<a class="headerlink" href="#ant" title="Permalink to this headline">¶</a></h4>
<p>Ant是比Maven更老的Java构建工具。Ant发明了一种描述文件路径的表达式，大家都习惯称其为Ant风格路径表达式。Jenkins
pipeline的很多步骤的参数也会使用此表达式。</p>
<p>Ant路径表达式包括3种通配符。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>•？：匹配任何单字符。

•*：匹配0个或者任意数量的字符。

•**：匹配0个或者更多的目录。
</pre></div>
</div>
<p><strong>小结</strong></p>
<p>参考文献：</p>
<p><a class="reference external" href="https://blog.51cto.com/ygqygq2/2446145">https://blog.51cto.com/ygqygq2/2446145</a></p>
<p><a class="reference external" href="https://blog.csdn.net/kikajack/article/details/79434552">https://blog.csdn.net/kikajack/article/details/79434552</a></p>
</section>
<section id="id24">
<h4>11. Pipeline 片段示例<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<p><strong>(1) 超时设置与部署参数switch语句选择</strong></p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">1</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">script</span> <span class="o">{</span>
    <span class="n">env</span><span class="o">.</span><span class="na">deploy_option</span> <span class="o">=</span> <span class="n">input</span> <span class="nl">message:</span> <span class="s1">&#39;选择操作&#39;</span><span class="o">,</span> <span class="nl">ok:</span> <span class="s1">&#39;deploy&#39;</span><span class="o">,</span>
    <span class="nl">parameters:</span> <span class="o">[</span><span class="n">choice</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">&#39;deploy_option&#39;</span><span class="o">,</span> <span class="nl">choices:</span> <span class="o">[</span><span class="s1">&#39;deploy&#39;</span><span class="o">,</span> <span class="s1">&#39;rollback&#39;</span><span class="o">,</span> <span class="s1">&#39;redeploy&#39;</span><span class="o">],</span> <span class="nl">description:</span> <span class="s1">&#39;选择部署环境&#39;</span><span class="o">)]</span>
    <span class="k">switch</span><span class="o">(</span><span class="s2">&quot;${env.deploy_option}&quot;</span><span class="o">){</span>
        <span class="k">case</span> <span class="s1">&#39;deploy&#39;</span><span class="o">:</span>
            <span class="n">println</span><span class="o">(</span><span class="s1">&#39;1.deploy prd env&#39;</span><span class="o">)</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="s1">&#39;rollback&#39;</span><span class="o">:</span>
            <span class="n">println</span><span class="o">(</span><span class="s1">&#39;2.rollback env&#39;</span><span class="o">)</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="s1">&#39;redeploy&#39;</span><span class="o">:</span>
            <span class="n">println</span><span class="o">(</span><span class="s1">&#39;3.redeploy env&#39;</span><span class="o">)</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="n">println</span><span class="o">(</span><span class="s1">&#39;error env&#39;</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><strong>（2）代码仓库拉取之checkout SCM</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>checkout([$class: &#39;GitSCM&#39;, branches: [[name: &#39;*/master&#39;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: &#39;b4c8b4e9-2777-44a1-a1ed-e9dc21d37f4f&#39;, url: &#39;git@gitlab.weiyigeek.top:ci-cd/java-maven.git&#39;]]])
</pre></div>
</div>
<p><img alt="image11" src="../_images/image-20220520181149891.png" /></p>
<p><strong>(3) Kubernetes 动态节点 Pod 模板的选择</strong></p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="c1">// # Scripted Pipeline</span>
<span class="n">podTemplate</span><span class="o">(</span><span class="nl">label:</span> <span class="s1">&#39;jenkins-jnlp-slave&#39;</span><span class="o">,</span> <span class="nl">cloud:</span> <span class="s1">&#39;k8s_115&#39;</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">node</span> <span class="o">(</span><span class="s1">&#39;jenkins-jnlp-slave&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">stage</span> <span class="o">(</span><span class="s1">&#39;dynamic-checkout&#39;</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">checkout</span><span class="o">([</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;GitSCM&#39;</span><span class="o">,</span> <span class="nl">branches:</span> <span class="o">[[</span><span class="nl">name:</span> <span class="s1">&#39;*/master&#39;</span><span class="o">]],</span> <span class="nl">userRemoteConfigs:</span> <span class="o">[[</span><span class="nl">credentialsId:</span> <span class="s1">&#39;69c0dbf0-f786-4aa0-975a-76528f10de8b&#39;</span><span class="o">,</span> <span class="nl">url:</span> <span class="s1">&#39;http://127.0.0.1/xxx/devops_test.git&#39;</span><span class="o">]]])</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id25">
<h2><a class="toc-backref" href="#id123">4.环境变量</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h2>
<p>10分钟搞定让你困惑的 Jenkins 环境变量</p>
<p><a class="reference external" href="https://www.cnblogs.com/zepc007/p/14646893.html">https://www.cnblogs.com/zepc007/p/14646893.html</a></p>
<section id="id26">
<h3><a class="toc-backref" href="#id124">4.1 Jenkins内置变量</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<p>在pipeline执行时，Jenkins通过一个名为env的全局变量，将Jenkins内置环境变量暴露出来。其使用方法有多种，示例如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>

    <span class="n">stages</span><span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="o">//</span><span class="n">方法1</span>
                <span class="n">echo</span> <span class="s2">&quot;Running $</span><span class="si">{env.BUILD_NUMBER}</span><span class="s2"> on $</span><span class="si">{env.BUILD_URL}</span><span class="s2">&quot;</span>
                <span class="o">//</span><span class="n">方法2</span>
                <span class="n">echo</span> <span class="s2">&quot;Running $env.BUILD_NUMBER on $env.BUILD_URL&quot;</span>
                <span class="o">//</span><span class="n">方法3</span> <span class="n">不推荐</span>
                <span class="n">echo</span> <span class="s2">&quot;Running $</span><span class="si">{BUILD_NUMBER}</span><span class="s2"> on $</span><span class="si">{BUILD_URL}</span><span class="s2">&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


<span class="p">}</span>
</pre></div>
</div>
<p><em>Scripted Pipeline</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span> <span class="p">{</span>
    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">BRANCH_NAME</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">echo</span> <span class="s1">&#39;I only execute on the master branch&#39;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">echo</span> <span class="s1">&#39;I execute elsewhere&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>下面我们简单介绍几个在实际工作中经常用到的变量。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• BUILD_NUMBER：构建号，累加的数字。在打包时，它可作为制品名称的一部分，比如server-2.jar。

• BRANCH_NAME：多分支pipeline项目支持。当需要根据不同的分支做不同的事情时就会用到，比如通过代码将release分支发布到生产环境中、master分支发布到测试环境中。

• BUILD_URL：当前构建的页面URL。如果构建失败，则需要将失败的构建链接放在邮件通知中，这个链接就可以是BUILD_URL。

• GIT_BRANCH：通过git拉取的源码构建的项目才会有此变量。
</pre></div>
</div>
<p>在使用env变量时，需要注意不同类型的项目，env变量所包含的属性及其值是不一样的。比如普通pipeline任务中的GIT
BRANCH变量的值为origin/master，而在多分支pipeline任务中GIT
BRANCH变量的值为master。</p>
<blockquote>
<div><p>小技巧：在调试<em>pipeline</em> 时，可以在<em>pipeline</em>
的开始阶段加一句：sh’printenv’，将env变量的属性值打印出来。这样可以帮助我们避免不少问题。</p>
</div></blockquote>
<p>打印信息如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>+ printenv
JAVA_URL_VERSION=8u242b08

JENKINS_HOME=/var/jenkins_home

GIT_PREVIOUS_SUCCESSFUL_COMMIT=d06003e92c2b577bd4c7165a6f7be3d94bf0001c

JENKINS_UC_EXPERIMENTAL=https://updates.jenkins.io/experimental

RUN_CHANGES_DISPLAY_URL=http://192.168.186.129:8080/job/jenk
ins_test001/15/display/redirect?page=changes

HOSTNAME=15b3c3e0ee4d

SHLVL=0

NODE_LABELS=master

HUDSON_URL=http://192.168.186.129:8080/

GIT_COMMIT=36ac60e8ccb80f8252f4cf0f1d4ec1005bccdd79

JAVA_BASE_URL=https://github.com/AdoptOpenJDK/openjdk8-upstream-binaries/releases/download/jdk8u242-b08/OpenJDK8U-jdk_

HOME=/root

BUILD_URL=http://192.168.186.129:8080/job/jenkins_test001/15/

HUDSON_COOKIE=f799490a-d9fc-432e-b1e1-d81f0bf4c04b

JENKINS_SERVER_COOKIE=durable-d16ae7ef9d5972f11bd0b9c12dbe5af4

MAVEN_HOME=/var/jenkins_home/tools/hudson.tasks.Maven_MavenInstallation/mvn-3.5.4

JENKINS_UC=https://updates.jenkins.io
WORKSPACE=/var/jenkins_home/workspace/jenkins_test001

REF=/usr/share/jenkins/ref

JAVA_VERSION=8u242

NODE_NAME=master

RUN_ARTIFACTS_DISPLAY_URL=http://192.168.186.129:8080/job/jenkins_test001/15/display/redirect?page=artifacts

STAGE_NAME=Show env

GIT_BRANCH=origin/master

EXECUTOR_NUMBER=0

RUN_TESTS_DISPLAY_URL=http://192.168.186.129:8080/job/jenkins_test001/15/display/redirect?page=tests

BUILD_DISPLAY_NAME=#15

JENKINS_VERSION=2.249.3

JENKINS_INCREMENTALS_REPO_MIRROR=https://repo.jenkins-
ci.org/incrementals

HUDSON_HOME=/var/jenkins_home

JOB_BASE_NAME=jenkins_test001

PATH=/var/jenkins_home/tools/hudson.tasks.Maven_MavenInstallation/mvn-3.5.4/bin:/var/jenkins_home/tools/hudson.tasks.Maven_MavenInstallation/mvn-3.5.4/bin:/usr/local/openjdk-8/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

BUILD_ID=15

JAVA_OPTS=-Djava.util.logging.config.file=/var/jenkins_home/log.properties

BUILD_TAG=jenkins-jenkins_test001-15

JENKINS_URL=http://192.168.186.129:8080/

LANG=C.UTF-8

JOB_URL=http://192.168.186.129:8080/job/jenkins_test001/

GIT_URL=http://192.168.186.131:11080/hu_admin/test_jenkins_ci

BUILD_NUMBER=15

JENKINS_NODE_COOKIE=bf264975-a05d-43b0-8b98-cb7a8fdb9abf

RUN_DISPLAY_URL=http://192.168.186.129:8080/job/jenkins_test001/15/display/redirect

JENKINS_SLAVE_AGENT_PORT=50000

HUDSON_SERVER_COOKIE=408afd28d9b43a96

JOB_DISPLAY_URL=http://192.168.186.129:8080/job/jenkins_test001/display/redirect

JOB_NAME=jenkins_test001

COPY_REFERENCE_FILE_LOG=/var/jenkins_home/copy_reference_file.log

PWD=/var/jenkins_home/workspace/jenkins_test001

JAVA_HOME=/usr/local/openjdk-8

M2_HOME=/var/jenkins_home/tools/hudson.tasks.Maven_MavenInstallation/mvn-3.5.4

GIT_PREVIOUS_COMMIT=d06003e92c2b577bd4c7165a6f7be3d94bf0001c
WORKSPACE_TMP=/var/jenkins_home/workspace/jenkins_test001@tmp
</pre></div>
</div>
</section>
<section id="id27">
<h3><a class="toc-backref" href="#id125">4.2 自定义pipeline环境变量</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<p>当pipeline变得复杂时，我们就会有定义自己的环境变量的需求。声明式pipeline提供了environment指令，方便自定义变量。比如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">environment</span> <span class="p">{</span>
        <span class="n">CC</span> <span class="o">=</span> <span class="s2">&quot;echo&quot;</span>
    <span class="p">}</span>
    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s2">&quot;Example&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">environment</span> <span class="p">{</span>
                <span class="n">DEBUG_FLAGS</span> <span class="o">=</span> <span class="s2">&quot;hello world&quot;</span>
            <span class="p">}</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">sh</span> <span class="s2">&quot;$</span><span class="si">{CC}</span><span class="s2"> $</span><span class="si">{DEBUG_FLAGS}</span><span class="s2">&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;printenv&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>environment指令可以在pipeline中定义，代表变量作用域为整个pipeline；也可以在stage中定义，代表变量只在该阶段有效。</p>
<blockquote>
<div><p>小技巧：为避免变量名冲突，读者可根据所在公司的实际情况，在变量名前加上前缀，比如__server_name，__就是前缀。</p>
</div></blockquote>
<p>在实际工作中，还会遇到一个环境变量引用另一个环境变量的情况。在environment中可以这样定义：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">environment</span> <span class="p">{</span>
    <span class="n">__server_name</span> <span class="o">=</span> <span class="s2">&quot;mail-server&quot;</span>
    <span class="n">__version</span> <span class="o">=</span> <span class="s2">&quot;$</span><span class="si">{BUILD_NUMBER}</span><span class="s2">&quot;</span>
    <span class="n">__artifact_name</span> <span class="o">=</span> <span class="s2">&quot;$</span><span class="si">{__server_name}</span><span class="s2">-$</span><span class="si">{__version}</span><span class="s2">.jar&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id28">
<h3><a class="toc-backref" href="#id126">4.3 自定义全局环境变量</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<p>进入Manage Jenkins→Configure System→Global
properties页，勾选“Environment
variables”复选框，单击“Add”按钮，在输入框中输入变量名和变量值即可。</p>
<p><img alt="image12" src="../_images/jenkins_test009.png" /></p>
<p>通过单击“Add”按钮，还可以添加多个全局环境变量。</p>
<p>自定义全局环境变量会被加入 env
属性列表中，所以，使用自定义全局环境变量与使用Jenkins内置变量的方法无异：<code class="docutils literal notranslate"><span class="pre">${env.redis_user}</span></code>。</p>
<p>10分钟弄懂Jenkins环境变量</p>
<p><a class="reference external" href="https://didispace-wx.blog.csdn.net/article/details/112550529">https://didispace-wx.blog.csdn.net/article/details/112550529</a></p>
</section>
<section id="id29">
<h3><a class="toc-backref" href="#id127">4.4 一些pipeline示例</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<p><strong>多分支构建</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">environment</span> <span class="p">{</span>
        <span class="n">remote_dir</span> <span class="o">=</span> <span class="s2">&quot;/opt/hello&quot;</span>
    <span class="p">}</span>
    <span class="n">triggers</span><span class="p">{</span>
        <span class="n">gitlab</span><span class="p">(</span> <span class="n">triggerOnPush</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
                <span class="n">triggerOnMergeRequest</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
                <span class="n">branchFilterType</span><span class="p">:</span> <span class="s1">&#39;All&#39;</span><span class="p">,</span>
                <span class="n">secretToken</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">{env.git_token}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">options</span> <span class="p">{</span>
        <span class="n">buildDiscarder</span><span class="p">(</span><span class="n">logRotator</span><span class="p">(</span><span class="n">numToKeepStr</span><span class="p">:</span> <span class="s1">&#39;10&#39;</span><span class="p">))</span>
        <span class="n">disableConcurrentBuilds</span><span class="p">()</span>
        <span class="n">timeout</span><span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="p">)</span>
        <span class="n">timestamps</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;部署到测试环境&#39;</span><span class="p">){</span>
            <span class="n">when</span> <span class="p">{</span>
                <span class="n">branch</span> <span class="s1">&#39;test&#39;</span>
            <span class="p">}</span>
            <span class="n">steps</span><span class="p">{</span>
                <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    rsync -avz --progress -e &#39;ssh -p 22&#39; --exclude=&#39;Jenkinsfile&#39; --exclude=&#39;.git&#39; --delete $</span><span class="si">{WORKSPACE}</span><span class="s1">/  root@192.168.3.68:$remote_dir</span>
<span class="s1">                &#39;&#39;&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;部署到线上环境&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">when</span> <span class="p">{</span>
                <span class="n">branch</span> <span class="s1">&#39;master&#39;</span>
            <span class="p">}</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    rsync -avz --progress -e &#39;ssh -p 22&#39; --exclude=&#39;Jenkinsfile&#39; --exclude=&#39;.git&#39; --delete $</span><span class="si">{WORKSPACE}</span><span class="s1">/  root@192.168.3.61:$remote_dir</span>
<span class="s1">                &#39;&#39;&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s1">&#39;清理工作目录&#39;</span>
                <span class="n">cleanWs</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">post</span> <span class="p">{</span>
        <span class="n">success</span> <span class="p">{</span>
            <span class="n">sh</span> <span class="s2">&quot;echo 成功了&quot;</span>
        <span class="p">}</span>
        <span class="n">failure</span> <span class="p">{</span>
            <span class="n">sh</span> <span class="s2">&quot;echo 失败了&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>判断分支</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span> <span class="p">{</span>
    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">BRANCH_NAME</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">echo</span> <span class="s1">&#39;I only execute on the master branch&#39;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">echo</span> <span class="s1">&#39;I execute elsewhere&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>触发ansible，执行nginx部署</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="p">{</span>
  <span class="o">//</span> <span class="n">任务执行在具有</span> <span class="n">ansible</span> <span class="n">标签的</span> <span class="n">agent</span> <span class="n">上</span>
  <span class="n">agent</span> <span class="p">{</span> <span class="n">label</span> <span class="s2">&quot;ansible&quot;</span><span class="p">}</span>
  <span class="n">environment</span><span class="p">{</span>
     <span class="o">//</span> <span class="n">设置</span> <span class="n">Ansible</span> <span class="n">不检查</span> <span class="n">HOST_KEY</span>
    <span class="n">ANSIBLE_HOST_KEY_CHECKING</span> <span class="o">=</span> <span class="n">false</span>
  <span class="p">}</span>
  <span class="n">triggers</span> <span class="p">{</span>
     <span class="n">pollSCM</span><span class="p">(</span><span class="s1">&#39;H/1 * * * *&#39;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">stages</span><span class="p">{</span>
    <span class="n">stage</span><span class="p">(</span><span class="s2">&quot;deploy nginx&quot;</span><span class="p">){</span>
      <span class="n">steps</span><span class="p">{</span>
        <span class="n">sh</span> <span class="s2">&quot;ansible-playbook -i env-conf/dev  deploy/playbook.yaml&quot;</span>
      <span class="p">}</span>
<span class="p">}}}</span>
</pre></div>
</div>
<section id="id30">
<h4>4.4.1 pipeline脚本式语法使用的实例<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h4>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
<span class="n">agent</span> <span class="n">any</span>
<span class="n">options</span> <span class="o">{</span>
    <span class="n">durabilityHint</span> <span class="s1">&#39;PERFORMANCE_OPTIMIZED&#39;</span>
    <span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span><span class="mi">5</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="o">)</span>
    <span class="n">timestamps</span><span class="o">()</span>
    <span class="n">skipStagesAfterUnstable</span><span class="o">()</span>
    <span class="c1">// retry(2)</span>
    <span class="n">skipDefaultCheckout</span> <span class="kc">true</span>
    <span class="n">buildDiscarder</span> <span class="n">logRotator</span><span class="o">(</span><span class="nl">artifactDaysToKeepStr:</span> <span class="s1">&#39;1&#39;</span><span class="o">,</span> <span class="nl">artifactNumToKeepStr:</span> <span class="s1">&#39;1&#39;</span><span class="o">,</span> <span class="nl">daysToKeepStr:</span> <span class="s1">&#39;10&#39;</span><span class="o">,</span> <span class="nl">numToKeepStr:</span> <span class="s1">&#39;5&#39;</span><span class="o">)</span>
<span class="o">}</span>
<span class="n">stages</span> <span class="o">{</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;拉取代码&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">steps</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s1">&#39;正在拉取代码...&#39;</span>
            <span class="n">script</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">checkout</span><span class="o">([</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;GitSCM&#39;</span><span class="o">,</span> <span class="nl">branches:</span> <span class="o">[[</span><span class="nl">name:</span> <span class="s1">&#39;v1-0-8-apix-20190531&#39;</span><span class="o">]],</span> <span class="nl">doGenerateSubmoduleConfigurations:</span> <span class="kc">false</span><span class="o">,</span> <span class="nl">extensions:</span> <span class="o">[[</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;CloneOption&#39;</span><span class="o">,</span> <span class="nl">noTags:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">shallow:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">depth:</span> <span class="mi">1</span><span class="o">,</span> <span class="nl">honorRefspec:</span><span class="kc">true</span><span class="o">]],</span> <span class="nl">submoduleCfg:</span> <span class="o">[],</span> <span class="nl">userRemoteConfigs:</span> <span class="o">[[</span><span class="nl">credentialsId:</span> <span class="s1">&#39;7e1f82d8-c808-4555-8c82-2a67f6cbcded&#39;</span><span class="o">,</span><span class="nl">refspec:</span> <span class="s1">&#39;+refs/heads/v1-0-8-apix-20190531:refs/remotes/origin/v1-0-8-apix-20190531&#39;</span><span class="o">,</span> <span class="nl">url:</span> <span class="s1">&#39;git@gitlab.test.cn:app/forseti.git&#39;</span><span class="o">]]])</span>
                <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">err</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">echo</span> <span class="n">err</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()</span>
                    <span class="n">echo</span> <span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
                    <span class="n">unstable</span> <span class="s1">&#39;拉取代码失败&#39;</span>
                    <span class="n">warnError</span><span class="o">(</span><span class="s1">&#39;拉取代码失败信息回调失败&#39;</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">retry</span><span class="o">(</span><span class="mi">5</span><span class="o">){</span>
                            <span class="n">httpRequest</span> <span class="nl">acceptType:</span> <span class="s1">&#39;APPLICATION_JSON&#39;</span><span class="o">,</span> <span class="nl">consoleLogResponseBody:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">contentType:</span> <span class="s1">&#39;APPLICATION_JSON&#39;</span><span class="o">,</span> <span class="nl">httpMode:</span> <span class="s1">&#39;POST&#39;</span><span class="o">,</span> <span class="nl">ignoreSslErrors:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">requestBody:</span> <span class="s2">&quot;{\&quot;step\&quot;:\&quot;pull\&quot;,\&quot;id\&quot;:\&quot;${JOB_NAME}\&quot;,\&quot;build_number\&quot;:\&quot;${BUILD_NUMBER}\&quot;}&quot;</span><span class="o">,</span> <span class="nl">timeout:</span> <span class="mi">5</span><span class="o">,</span> <span class="nl">url:</span> <span class="s1">&#39;http://127.0.0.1:8088/api/v1/job_finish&#39;</span><span class="o">,</span> <span class="nl">validResponseCodes:</span> <span class="s1">&#39;200&#39;</span><span class="o">,</span> <span class="nl">validResponseContent:</span> <span class="s1">&#39;ok&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;构建&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">options</span> <span class="o">{</span>
            <span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span><span class="mi">3</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">steps</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s1">&#39;正在构建....&#39;</span>
            <span class="n">script</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;touch forseti-api.properties&#39;</span>
                    <span class="n">sh</span> <span class="s1">&#39;mvn -B clean install -DskipTests -U&#39;</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">err</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">echo</span> <span class="n">err</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()</span>
                    <span class="n">echo</span> <span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
                    <span class="n">unstable</span> <span class="s1">&#39;构建失败&#39;</span>
                    <span class="n">warnError</span><span class="o">(</span><span class="s1">&#39;构建失败信息回调失败&#39;</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">retry</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">httpRequest</span> <span class="nl">acceptType:</span> <span class="s1">&#39;APPLICATION_JSON&#39;</span><span class="o">,</span> <span class="nl">consoleLogResponseBody:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">contentType:</span> <span class="s1">&#39;APPLICATION_JSON&#39;</span><span class="o">,</span> <span class="nl">httpMode:</span> <span class="s1">&#39;POST&#39;</span><span class="o">,</span> <span class="nl">ignoreSslErrors:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">requestBody:</span> <span class="s2">&quot;{\&quot;step\&quot;:\&quot;build\&quot;,\&quot;id\&quot;:\&quot;${JOB_NAME}\&quot;,\&quot;build_number\&quot;:\&quot;${BUILD_NUMBER}\&quot;}&quot;</span><span class="o">,</span> <span class="nl">timeout:</span> <span class="mi">5</span><span class="o">,</span> <span class="nl">url:</span> <span class="s1">&#39;http://127.0.0.1:8088/api/v1/job_finish&#39;</span><span class="o">,</span> <span class="nl">validResponseCodes:</span> <span class="s1">&#39;200&#39;</span><span class="o">,</span> <span class="nl">validResponseContent:</span> <span class="s1">&#39;ok&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;依赖性检查&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">steps</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s1">&#39;正在生成依赖性检查信息...&#39;</span>
            <span class="n">script</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;mvn -B dependency:tree &gt; dependency.log&#39;</span>
                <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">err</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">echo</span> <span class="n">err</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()</span>
                    <span class="n">echo</span> <span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
                    <span class="n">unstable</span> <span class="s1">&#39;依赖性检查失败&#39;</span>
                    <span class="n">warnError</span><span class="o">(</span><span class="s1">&#39;依赖性检查失败信息回调失败&#39;</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">retry</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">httpRequest</span> <span class="nl">acceptType:</span> <span class="s1">&#39;APPLICATION_JSON&#39;</span><span class="o">,</span> <span class="nl">consoleLogResponseBody:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">contentType:</span> <span class="s1">&#39;APPLICATION_JSON&#39;</span><span class="o">,</span> <span class="nl">httpMode:</span> <span class="s1">&#39;POST&#39;</span><span class="o">,</span> <span class="nl">ignoreSslErrors:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">requestBody:</span> <span class="s2">&quot;{\&quot;step\&quot;:\&quot;check\&quot;,\&quot;id\&quot;:\&quot;${JOB_NAME}\&quot;,\&quot;build_number\&quot;:\&quot;${BUILD_NUMBER}\&quot;}&quot;</span><span class="o">,</span> <span class="nl">timeout:</span> <span class="mi">5</span><span class="o">,</span> <span class="nl">url:</span> <span class="s1">&#39;http://127.0.0.1:8088/api/v1/job_finish&#39;</span><span class="o">,</span> <span class="nl">validResponseCodes:</span> <span class="s1">&#39;200&#39;</span><span class="o">,</span> <span class="nl">validResponseContent:</span> <span class="s1">&#39;ok&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;返回依赖性检查文件&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">steps</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s1">&#39;正在返回依赖性检查文件给erebsu应用...&#39;</span>
            <span class="n">script</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">retry</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">httpRequest</span> <span class="nl">acceptType:</span> <span class="s1">&#39;APPLICATION_JSON&#39;</span><span class="o">,</span> <span class="nl">consoleLogResponseBody:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">contentType:</span> <span class="s1">&#39;APPLICATION_OCTETSTREAM&#39;</span><span class="o">,</span> <span class="nl">customHeaders:</span> <span class="o">[[</span><span class="nl">maskValue:</span> <span class="kc">false</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;Content-Disposition&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;id=dependency.log&#39;</span><span class="o">]],</span> <span class="nl">httpMode:</span> <span class="s1">&#39;POST&#39;</span><span class="o">,</span> <span class="nl">ignoreSslErrors:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">multipartName:</span> <span class="s1">&#39;file&#39;</span><span class="o">,</span> <span class="nl">requestBody:</span> <span class="s2">&quot;{\&quot;id\&quot;:\&quot;${JOB_NAME}\&quot;}&quot;</span><span class="o">,</span> <span class="nl">timeout:</span> <span class="mi">5</span><span class="o">,</span> <span class="nl">uploadFile:</span> <span class="s1">&#39;dependency.log&#39;</span><span class="o">,</span> <span class="nl">url:</span> <span class="s1">&#39;http://127.0.0.1:8088/api/v1/job_data_update&#39;</span><span class="o">,</span> <span class="nl">validResponseCodes:</span> <span class="s1">&#39;200&#39;</span><span class="o">,</span> <span class="nl">validResponseContent:</span> <span class="s1">&#39;ok&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">err</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">echo</span> <span class="n">err</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()</span>
                    <span class="n">echo</span> <span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
                    <span class="n">unstable</span> <span class="s1">&#39;依赖性检查文件返回给erebus失败&#39;</span>
                    <span class="n">warnError</span><span class="o">(</span><span class="s1">&#39;依赖性检查文件返回给erebus失败信息回调失败&#39;</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">retry</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">httpRequest</span> <span class="nl">acceptType:</span> <span class="s1">&#39;APPLICATION_JSON&#39;</span><span class="o">,</span> <span class="nl">consoleLogResponseBody:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">contentType:</span> <span class="s1">&#39;APPLICATION_JSON&#39;</span><span class="o">,</span> <span class="nl">httpMode:</span> <span class="s1">&#39;POST&#39;</span><span class="o">,</span> <span class="nl">ignoreSslErrors:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">requestBody:</span> <span class="s2">&quot;{\&quot;step\&quot;:\&quot;callback\&quot;,\&quot;id\&quot;:\&quot;${JOB_NAME}\&quot;,\&quot;build_number\&quot;:\&quot;${BUILD_NUMBER}\&quot;}&quot;</span><span class="o">,</span> <span class="nl">timeout:</span> <span class="mi">5</span><span class="o">,</span> <span class="nl">url:</span> <span class="s1">&#39;http://127.0.0.1:8088/api/v1/job_finish&#39;</span><span class="o">,</span> <span class="nl">validResponseCodes:</span> <span class="s1">&#39;200&#39;</span><span class="o">,</span> <span class="nl">validResponseContent:</span> <span class="s1">&#39;ok&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;完成&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">steps</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s1">&#39;依赖性检查完成，正在返回完成信息...&#39;</span>
            <span class="n">retry</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">httpRequest</span> <span class="nl">contentType:</span> <span class="s1">&#39;APPLICATION_OCTETSTREAM&#39;</span><span class="o">,</span> <span class="nl">customHeaders:</span> <span class="o">[[</span><span class="nl">maskValue:</span> <span class="kc">false</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;Content-type&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;application/json&#39;</span><span class="o">],</span> <span class="o">[</span><span class="nl">maskValue:</span> <span class="kc">false</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;Accept&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;application/json&#39;</span><span class="o">]],</span> <span class="nl">httpMode:</span> <span class="s1">&#39;POST&#39;</span><span class="o">,</span> <span class="nl">ignoreSslErrors:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">requestBody:</span> <span class="s2">&quot;{\&quot;id\&quot;:\&quot;${JOB_NAME}\&quot;,\&quot;build_number\&quot;:\&quot;${BUILD_NUMBER}\&quot;}&quot;</span><span class="o">,</span> <span class="nl">responseHandle:</span> <span class="s1">&#39;NONE&#39;</span><span class="o">,</span> <span class="nl">timeout:</span> <span class="mi">5</span><span class="o">,</span> <span class="nl">url:</span> <span class="s1">&#39;http://127.0.0.1:8088/api/v1/job_finish&#39;</span><span class="o">,</span> <span class="nl">validResponseContent:</span> <span class="s1">&#39;ok&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">post</span> <span class="o">{</span>
    <span class="n">always</span> <span class="o">{</span>
        <span class="n">cleanWs</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="deploy-test-cicd">
<h4>4.4.2 自动化Deploy+test CICD示例<a class="headerlink" href="#deploy-test-cicd" title="Permalink to this headline">¶</a></h4>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="c1">// 在任何可用的代理上执行流水线或阶段</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;build images and assets&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
            <span class="c1">//当嵌套条件不满足anyof下的任意一个</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// 将failFast true添加到包含并行的stage中，强制在其中任何一个失败时中止并行stage。</span>
            <span class="n">failFast</span> <span class="kc">true</span>
            <span class="c1">// parallel中的stage顺序执行,并行</span>
            <span class="n">parallel</span> <span class="o">{</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;add start comment to GiteePR&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI triggered, building... [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;build frontend assets&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                            set -u</span>
<span class="s1">                            if [[ $(echo $giteePullRequestDescription|grep without_compare|wc -l) -gt 0 ]]; then</span>
<span class="s1">                                echo &quot;skip compare&quot;</span>

<span class="s1">                            fi</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;build frontend images&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                            set -u</span>
<span class="s1">                            echo &quot;..............&quot;</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;build backend image&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                            set -u</span>
<span class="s1">                            echo &quot;......................&quot;</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;deploy&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
            <span class="c1">//当嵌套条件不满足anyof下的任意一个</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>

                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    set -u</span>
<span class="s1">                    echo &quot;..............&quot;</span>
<span class="s1">                    echo &quot;..............&quot;</span>
<span class="s1">                    echo &quot;..............&quot;</span>
<span class="s1">                &#39;&#39;&#39;</span>
                <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&lt;details&gt;</span>
<span class="s1">    &lt;summary&gt;CI Opened&lt;/summary&gt;</span>

<span class="s1">部署已完成，正在启动服务。[点我测试](http://&#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">giteePullRequestIid</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;.gitee.cc)</span>

<span class="s1">访问该 url 前 需要本地 dns 设置为192.168.1.60</span>

<span class="s1">测试用户：（可联系测试人员获取更多用户）</span>

<span class="s1">​```</span>
<span class="s1">用户名： git</span>
<span class="s1">密码： qwe123</span>
<span class="s1">​```</span>

<span class="s1">若有任务需要执行或者查看日志，请仔细阅读[参考文档](https://gitee.com/oschina/CI-gitee-Docs/blob/master/dev-usage.md)</span>

<span class="s1">&lt;/details&gt;</span>
<span class="s1">                &#39;&#39;&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;delete&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="c1">// 当嵌套条件满足下面任何一个时候，触发steps</span>
                <span class="n">anyOf</span> <span class="o">{</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    set -u</span>
<span class="s1">                    echo $giteePullRequestState</span>
<span class="s1">                &#39;&#39;&#39;</span>
                <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI Closed&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//无论流水线或阶段的完成状态如何，都在post 部分运行该步骤。</span>
    <span class="n">post</span> <span class="o">{</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI build failure! [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="o">}</span>
        <span class="n">aborted</span> <span class="o">{</span>
            <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI build aborted! [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="cicd-pipeline">
<h4>4.4.3 带参数选择项的CICD pipeline示例<a class="headerlink" href="#cicd-pipeline" title="Permalink to this headline">¶</a></h4>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="kt">def</span> <span class="nf">createVersion</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 定义一个版本号作为当次构建的版本，输出结果 20191210175842_69</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Date</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="s1">&#39;yyyyMMddHHmmss&#39;</span><span class="o">)</span> <span class="o">+</span> <span class="s2">&quot;_${env.BUILD_ID}&quot;</span>
<span class="o">}</span>

<span class="n">pipeline</span><span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">parameters</span> <span class="o">{</span>
        <span class="n">gitParameter</span> <span class="nl">branch:</span> <span class="s1">&#39;&#39;</span><span class="o">,</span> <span class="nl">branchFilter:</span> <span class="s1">&#39;.*&#39;</span><span class="o">,</span> <span class="nl">defaultValue:</span> <span class="s1">&#39;master&#39;</span><span class="o">,</span> <span class="nl">description:</span> <span class="s1">&#39;选择代码分支&#39;</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;branch&#39;</span><span class="o">,</span> <span class="nl">quickFilterEnabled:</span> <span class="kc">false</span><span class="o">,</span> <span class="nl">selectedValue:</span> <span class="s1">&#39;NONE&#39;</span><span class="o">,</span> <span class="nl">sortMode:</span> <span class="s1">&#39;NONE&#39;</span><span class="o">,</span> <span class="nl">tagFilter:</span> <span class="s1">&#39;*&#39;</span><span class="o">,</span> <span class="nl">type:</span> <span class="s1">&#39;PT_BRANCH&#39;</span>
        <span class="n">choice</span> <span class="nl">choices:</span> <span class="o">[</span><span class="s1">&#39;吴增辉&#39;</span><span class="o">],</span> <span class="nl">description:</span> <span class="s1">&#39;填写开发人员&#39;</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;developer&#39;</span>
        <span class="n">choice</span> <span class="nl">choices:</span> <span class="o">[</span><span class="s1">&#39;yes&#39;</span><span class="o">,</span><span class="s1">&#39;no&#39;</span><span class="o">],</span> <span class="nl">description:</span> <span class="s1">&#39;是否备份&#39;</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;backup&#39;</span>
        <span class="n">text</span> <span class="nl">defaultValue:</span> <span class="s1">&#39;&#39;</span><span class="o">,</span> <span class="nl">description:</span> <span class="s1">&#39;请填写更新日志&#39;</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;record&#39;</span>
    <span class="o">}</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">ip</span> <span class="o">=</span> <span class="s2">&quot;172.16.0.62_go2noticeposp&quot;</span>
        <span class="kt">def</span> <span class="n">remotedir</span> <span class="o">=</span> <span class="s2">&quot;/data/beego/cups-api&quot;</span>
        <span class="kt">def</span> <span class="n">_version</span> <span class="o">=</span> <span class="n">createVersion</span><span class="o">()</span>
        <span class="kt">def</span> <span class="n">tmpdir</span> <span class="o">=</span> <span class="s2">&quot;/tmp/cups-api_${_version}&quot;</span>
    <span class="o">}</span>

    <span class="n">options</span> <span class="o">{</span>
        <span class="n">disableConcurrentBuilds</span><span class="o">()</span>
        <span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">3</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="o">)</span>
        <span class="n">buildDiscarder</span><span class="o">(</span><span class="n">logRotator</span><span class="o">(</span><span class="nl">numToKeepStr:</span> <span class="s1">&#39;10&#39;</span><span class="o">))</span>
    <span class="o">}</span>

    <span class="n">stages</span><span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;拉取代码&#39;</span><span class="o">){</span>
            <span class="n">steps</span><span class="o">{</span>
                <span class="n">deleteDir</span><span class="o">()</span>
                <span class="n">checkout</span><span class="o">([</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;GitSCM&#39;</span><span class="o">,</span> <span class="nl">branches:</span> <span class="o">[[</span><span class="nl">name:</span> <span class="s1">&#39;$branch&#39;</span><span class="o">]],</span> <span class="nl">doGenerateSubmoduleConfigurations:</span> <span class="kc">false</span><span class="o">,</span> <span class="nl">extensions:</span> <span class="o">[],</span> <span class="nl">submoduleCfg:</span> <span class="o">[],</span> <span class="nl">userRemoteConfigs:</span> <span class="o">[[</span><span class="nl">credentialsId:</span> <span class="s1">&#39;9df82ae3-5563-4d32-808b-00e8aa9ae26c&#39;</span><span class="o">,</span> <span class="nl">url:</span> <span class="s1">&#39;git@192.168.80.13:wuzh/cups-api.git&#39;</span><span class="o">]]])</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;打包应用&#39;</span><span class="o">){</span>
            <span class="n">options</span> <span class="o">{</span>
                <span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">4</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="o">)</span>
            <span class="o">}</span>
            <span class="n">steps</span><span class="o">{</span>
                <span class="n">sh</span> <span class="nl">label:</span> <span class="s1">&#39;&#39;</span><span class="o">,</span> <span class="nl">script:</span> <span class="s1">&#39;/root/go/bin/bee pack&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;备份服务器文件&#39;</span><span class="o">){</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;backup&#39;</span><span class="o">,</span>
                <span class="nl">value:</span> <span class="s1">&#39;yes&#39;</span>
            <span class="o">}</span>
            <span class="n">steps</span><span class="o">{</span>
                <span class="n">sh</span> <span class="nl">label:</span> <span class="s1">&#39;&#39;</span><span class="o">,</span> <span class="nl">script:</span> <span class="s1">&#39;&#39;&#39;ansible ${ip} -m file -a &quot;path=$tmpdir state=directory&quot;</span>
<span class="s1">                ansible ${ip} -m shell -a &quot;rsync -qa $remotedir/*  $tmpdir --exclude=\&#39;logs\&#39;&quot;&#39;&#39;&#39;</span>

            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;发布文件到服务器&#39;</span><span class="o">){</span>
            <span class="n">steps</span><span class="o">{</span>
                <span class="n">sh</span> <span class="nl">label:</span> <span class="s1">&#39;&#39;</span><span class="o">,</span> <span class="nl">script:</span> <span class="s1">&#39;tar -zxf ${WORKSPACE}/go_online-cups-api.tar.gz&#39;</span>
                <span class="n">sh</span> <span class="nl">label:</span> <span class="s1">&#39;&#39;</span><span class="o">,</span> <span class="nl">script:</span> <span class="s1">&#39;ansible ${ip} -m synchronize -a &quot;src=${WORKSPACE}/go_online-cups-api dest=$remotedir delete=no archive=yes compress=yes rsync_opts=--exclude=\&#39;conf\&#39;&quot;&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;重启supervisor队列&#39;</span><span class="o">){</span>
            <span class="n">steps</span><span class="o">{</span>
                <span class="n">sh</span> <span class="nl">label:</span> <span class="s1">&#39;&#39;</span><span class="o">,</span> <span class="nl">script:</span> <span class="s1">&#39;ansible ${ip} -m shell -a &quot;supervisorctl restart beepkg&quot;&#39;</span>
                <span class="n">sh</span> <span class="nl">label:</span> <span class="s1">&#39;&#39;</span><span class="o">,</span> <span class="nl">script:</span> <span class="s1">&#39;ansible ${ip} -m shell -a &quot;supervisorctl status beepkg&quot;&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;生成日志&#39;</span><span class="o">){</span>
            <span class="n">steps</span><span class="o">{</span>
                <span class="n">sh</span> <span class="nl">label:</span> <span class="s1">&#39;&#39;</span><span class="o">,</span> <span class="nl">script:</span> <span class="s1">&#39;&#39;&#39;today=`date &quot;+%Y_%m_%d&quot;`</span>
<span class="s1">                now=`date &quot;+%Y_%m_%d_%H_%M_%S&quot;`</span>
<span class="s1">                echo &quot;时间: $now&quot; &gt;&gt; /root/update_log/$today</span>
<span class="s1">                echo &quot;开发者: $developer&quot; &gt;&gt; /root/update_log/$today</span>
<span class="s1">                echo &quot;git地址: git@192.168.80.13:wuzh/cups-api.git&quot; &gt;&gt; /root/update_log/$today</span>
<span class="s1">                echo &quot;分支名字: $branch&quot; &gt;&gt; /root/update_log/$today</span>
<span class="s1">                echo &quot;更新日志: $record&quot; &gt;&gt; /root/update_log/$today</span>
<span class="s1">                echo -e \&#39;-----------------------------------\\n\&#39; &gt;&gt; /root/update_log/$today&#39;&#39;&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">post</span><span class="o">(</span><span class="s1">&#39;send mail&#39;</span><span class="o">){</span>
        <span class="n">always</span><span class="o">{</span>
            <span class="n">emailext</span><span class="o">(</span>
                <span class="nl">subject:</span> <span class="s1">&#39;构建通知：${PROJECT_NAME} - Build # ${BUILD_NUMBER} -${BUILD_STATUS}!&#39;</span><span class="o">,</span>
                <span class="nl">body:</span> <span class="s1">&#39;${FILE,path=&quot;/root/script/email.html&quot;}&#39;</span><span class="o">,</span>
                <span class="nl">to:</span> <span class="s1">&#39;guoyabin@96199.com.cn&#39;</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="jenkins-harbor-k8s-cicd">
<h4>4.4.4 Jenkins+harbor+k8s CICD示例<a class="headerlink" href="#jenkins-harbor-k8s-cicd" title="Permalink to this headline">¶</a></h4>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="c1">// 镜像仓库地址</span>
<span class="kt">def</span> <span class="n">registry</span> <span class="o">=</span> <span class="s2">&quot;172.16.0.37:9090&quot;</span>
<span class="c1">// 镜像仓库项目</span>
<span class="kt">def</span> <span class="n">project</span> <span class="o">=</span> <span class="s2">&quot;jenkinsci&quot;</span>
<span class="c1">// 镜像名称</span>
<span class="kt">def</span> <span class="n">app_name</span> <span class="o">=</span> <span class="s2">&quot;citest&quot;</span>
<span class="c1">// 镜像完整名称</span>
<span class="kt">def</span> <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;${registry}/${project}/${app_name}:${BUILD_NUMBER}&quot;</span>
<span class="c1">// git仓库地址</span>
<span class="kt">def</span> <span class="n">git_address</span> <span class="o">=</span> <span class="s2">&quot;http://172.16.0.37:10080/zgcloud-test/first_testcicd01.git&quot;</span>

<span class="c1">// 认证</span>
<span class="kt">def</span> <span class="n">gitlab_auth</span> <span class="o">=</span> <span class="s2">&quot;64c59b6b-07c7-48cb-bee2-80f76661b283&quot;</span>
<span class="kt">def</span> <span class="n">harbor_auth</span> <span class="o">=</span> <span class="s2">&quot;f41a2e0d-71d2-40da-a50f-7130a60b0ab9&quot;</span>

<span class="c1">//代码分支，空着为全部分支</span>
<span class="kt">def</span> <span class="n">Branch</span> <span class="o">=</span> <span class="s2">&quot;*/master&quot;</span>

<span class="c1">// K8s认证</span>
<span class="kt">def</span> <span class="n">k8s_auth</span> <span class="o">=</span> <span class="s2">&quot;4b9388ee-e881-4304-b675-ad9a4ca77926&quot;</span>
<span class="kt">def</span> <span class="n">K8s_master1_ip</span> <span class="o">=</span> <span class="s2">&quot;172.16.0.4&quot;</span>
<span class="kt">def</span> <span class="n">K8s_master2_ip</span> <span class="o">=</span> <span class="s2">&quot;172.16.0.3&quot;</span>
<span class="kt">def</span> <span class="n">K8s_master3_ip</span> <span class="o">=</span> <span class="s2">&quot;172.16.0.2&quot;</span>

<span class="c1">// harbor仓库secret_name</span>
<span class="kt">def</span> <span class="n">harbor_registry_secret</span> <span class="o">=</span> <span class="s2">&quot;harbor-pull-secret&quot;</span>

<span class="c1">// k8s部署后暴露的nodePort</span>
<span class="kt">def</span> <span class="n">nodePort</span> <span class="o">=</span> <span class="s2">&quot;30666&quot;</span>



<span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>

    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Pull code&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">checkout</span><span class="o">([</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;GitSCM&#39;</span><span class="o">,</span> <span class="nl">branches:</span> <span class="o">[[</span><span class="nl">name:</span> <span class="s2">&quot;${Branch}&quot;</span><span class="o">]],</span> <span class="nl">userRemoteConfigs:</span> <span class="o">[[</span><span class="nl">credentialsId:</span> <span class="s2">&quot;${gitlab_auth}&quot;</span><span class="o">,</span> <span class="nl">url:</span> <span class="s2">&quot;${git_address}&quot;</span><span class="o">]]])</span>
                <span class="n">sh</span> <span class="s2">&quot;ls&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// stage(&#39;code compoie&#39;) {</span>
        <span class="c1">//    steps {</span>
        <span class="c1">//        sh &quot;mvn clean package -Dmaven.test.skip=true&quot;</span>
        <span class="c1">//        sh &quot;ls&quot;</span>
        <span class="c1">//    }</span>
        <span class="c1">// }</span>

        <span class="n">stage</span> <span class="o">(</span><span class="s1">&#39;Build docker&#39;</span><span class="o">){</span>
            <span class="n">steps</span><span class="o">{</span>
                <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s2">&quot;${harbor_auth}&quot;</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s1">&#39;password&#39;</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s1">&#39;username&#39;</span><span class="o">)])</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    echo &#39;</span>
<span class="s2">                        FROM tomcat</span>
<span class="s2">                        LABEL maintainer miaocunfa</span>
<span class="s2">                        RUN rm -rf /usr/local/tomcat/webapps/*</span>
<span class="s2">                        ADD target/* /usr/local/tomcat/webapps/ROOT/</span>
<span class="s2">                    &#39; &gt; Dockerfile</span>

<span class="s2">                    docker build -t ${image_name} .</span>
<span class="s2">                    docker login -u ${username} -p &#39;${password}&#39; ${registry}</span>
<span class="s2">                    docker push ${image_name}</span>
<span class="s2">                &quot;&quot;&quot;</span>

            <span class="o">}</span>

        <span class="o">}</span>

    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;deploy to K8s&#39;</span><span class="o">){</span>
        <span class="n">steps</span><span class="o">{</span>
         <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s2">&quot;${harbor_auth}&quot;</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s1">&#39;password&#39;</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s1">&#39;username&#39;</span><span class="o">)])</span> <span class="o">{</span>
            <span class="n">sh</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                sed -i &#39;s#\$IMAGE_NAME#${image_name}#&#39; deploy.yaml</span>
<span class="s2">                sed -i &#39;s#\$SECRET_NAME#${harbor_registry_secret}#&#39; deploy.yaml</span>
<span class="s2">                sed -i &#39;s#\$NODE_PORT#${nodePort}#&#39; deploy.yaml</span>
<span class="s2">                scp deploy.yaml root@${K8s_master1_ip}:/root &amp;&amp; scp deploy.yaml root@${K8s_master2_ip}:/root &amp;&amp; scp deploy.yaml root@${K8s_master3_ip}:/root</span>
<span class="s2">                ssh root@${K8s_master1_ip} &quot;kubectl apply -f /root/deploy.yaml&quot; || ssh root@${K8s_master2_ip} &quot;kubectl apply -f /root/deploy.yaml&quot; || ssh root@${K8s_master3_ip} &quot;kubectl apply -f /root/deploy.yaml&quot;</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="c1">// kubernetesDeploy configs: &#39;deploy.yaml&#39;, kubeconfigId: &quot;${k8s_auth}&quot;</span>
        <span class="o">}</span>
        <span class="o">}</span>

<span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="jenkinsfilephp">
<h4>4.4.5 Jenkinsfile发布PHP项目<a class="headerlink" href="#jenkinsfilephp" title="Permalink to this headline">¶</a></h4>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">environment</span> <span class="o">{</span>
            <span class="c1">// 定义项目名称方便全局引用</span>
        <span class="n">project</span>     <span class="o">=</span> <span class="s2">&quot;test-php&quot;</span>
        <span class="c1">// 远程主机地址，这里只演示了一台，如果是多台，可以空格继续写，下边的部署嵌套个for循环即可</span>
        <span class="n">remote_ip</span>   <span class="o">=</span> <span class="s2">&quot;192.168.0.1&quot;</span>
        <span class="n">remote_dir</span>  <span class="o">=</span> <span class="s2">&quot;/data/www/test-php&quot;</span>
    <span class="o">}</span>
    <span class="n">options</span> <span class="o">{</span>
        <span class="n">timestamps</span><span class="o">()</span>
        <span class="n">disableConcurrentBuilds</span><span class="o">()</span>
        <span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">10</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="o">)</span>
        <span class="n">buildDiscarder</span><span class="o">(</span><span class="n">logRotator</span><span class="o">(</span><span class="nl">numToKeepStr:</span> <span class="s1">&#39;10&#39;</span><span class="o">))</span>
    <span class="o">}</span>
    <span class="n">triggers</span><span class="o">{</span>
        <span class="n">gitlab</span><span class="o">(</span> <span class="nl">triggerOnPush:</span> <span class="kc">true</span><span class="o">,</span>
                <span class="nl">triggerOnMergeRequest:</span> <span class="kc">true</span><span class="o">,</span>
                <span class="nl">branchFilterType:</span> <span class="s1">&#39;All&#39;</span><span class="o">,</span>
                <span class="nl">secretToken:</span> <span class="s2">&quot;${env.git_token}&quot;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="c1">// 这里使用参数化构建的方式，而没有使用input参数，下边会说明一下原因。</span>
    <span class="n">parameters</span> <span class="o">{</span>
        <span class="n">choice</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">&#39;MODE&#39;</span><span class="o">,</span> <span class="nl">choices:</span> <span class="o">[</span><span class="s1">&#39;deploy&#39;</span><span class="o">,</span><span class="s1">&#39;rollback&#39;</span><span class="o">],</span> <span class="nl">description:</span> <span class="s1">&#39;请选择发布或者回滚？&#39;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;部署&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;MODE&#39;</span><span class="o">,</span><span class="nl">value:</span> <span class="s1">&#39;deploy&#39;</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                            ssh -p 10022 root@$remote_ip &quot;mkdir -p /media/${project}&quot;</span>
<span class="s1">                            rsync -avz -e &#39;ssh -p 34222&#39; --exclude=&#39;Jenkinsfile&#39; --delete ${WORKSPACE}/  root@$remote_ip:/media/${project}/${BUILD_ID}</span>
<span class="s1">                            ssh -p 10022 root@$remote_ip &quot;rm -rf $remote_dir &amp;&amp; ln -s /media/${project}/${BUILD_ID} $remote_dir&quot;</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">err</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;${err}&quot;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;回滚&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;MODE&#39;</span><span class="o">,</span><span class="nl">value:</span> <span class="s1">&#39;rollback&#39;</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                            last_success=$(ssh -p 10022 root@$remote_ip &quot;ls -lt /media/${project} | sed -n &#39;3p&#39;&quot; | awk &#39;{print \$9}&#39;)</span>
<span class="s1">                            ssh -p 10022 root@$remote_ip &quot;rm -rf $remote_dir &amp;&amp; ln -s /media/${project}/${last_success} $remote_dir&quot;</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">err</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;${err}&quot;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;清理工作空间&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s1">&#39;清理工作空间&#39;</span>
                <span class="n">cleanWs</span><span class="o">()</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">post</span> <span class="o">{</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="n">dingTalk</span> <span class="nl">accessToken:</span><span class="s1">&#39;https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxxxxx&#39;</span><span class="o">,</span>
            <span class="nl">imageUrl:</span><span class="s1">&#39;https://ae01.alicdn.com/kf/Hdfe28d2621434a1eb821ac6327b768e79.png&#39;</span><span class="o">,</span>
            <span class="nl">jenkinsUrl:</span> <span class="s2">&quot;${env.JENKINS_URL}&quot;</span><span class="o">,</span>
            <span class="nl">message:</span><span class="s1">&#39;构建成功 ✅&#39;</span><span class="o">,</span>
            <span class="nl">notifyPeople:</span><span class="s1">&#39;李启龙&#39;</span>
        <span class="o">}</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">dingTalk</span> <span class="nl">accessToken:</span><span class="s1">&#39;https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxxxxx&#39;</span><span class="o">,</span>
            <span class="nl">imageUrl:</span><span class="s1">&#39;https://ae01.alicdn.com/kf/Hdfe28d2621434a1eb821ac6327b768e79.png&#39;</span><span class="o">,</span>
            <span class="nl">jenkinsUrl:</span> <span class="s2">&quot;${env.JENKINS_URL}&quot;</span><span class="o">,</span>
            <span class="nl">message:</span><span class="s1">&#39;构建失败 ❌&#39;</span><span class="o">,</span>
            <span class="nl">notifyPeople:</span><span class="s1">&#39;李启龙&#39;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="jenkinsfilenodejs">
<h4>4.4.6 Jenkinsfile发布nodejs项目<a class="headerlink" href="#jenkinsfilenodejs" title="Permalink to this headline">¶</a></h4>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">tools</span> <span class="o">{</span><span class="n">nodejs</span> <span class="s2">&quot;node12.13&quot;</span><span class="o">}</span>
    <span class="n">options</span> <span class="o">{</span>
       <span class="n">timestamps</span><span class="o">()</span>
       <span class="n">buildDiscarder</span><span class="o">(</span><span class="n">logRotator</span><span class="o">(</span><span class="nl">numToKeepStr:</span> <span class="s1">&#39;10&#39;</span><span class="o">))</span>
       <span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">20</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="o">)</span>
       <span class="n">checkoutToSubdirectory</span><span class="o">(</span><span class="s2">&quot;${giteePullRequestIid}&quot;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;deploy&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">failFast</span> <span class="kc">true</span>
            <span class="n">parallel</span> <span class="o">{</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;add start comment to GiteePR&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI triggered, building... [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Build static&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                            set -u</span>
<span class="s1">                            set -x</span>
<span class="s1">                            node -v &amp;&amp; npm i -g npm@6 &amp;&amp; npm -v &amp;&amp; npm install -g cnpm --registry=https://registry.npm.taobao.org &amp;&amp; npm install rimraf -g</span>
<span class="s1">                            npm cache clean --force &amp;&amp; rimraf node_modules</span>
<span class="s1">                            cd ${WORKSPACE}/${giteePullRequestIid}/ &amp;&amp; rm -rf package-lock.json</span>
<span class="s1">                            cd ${WORKSPACE}/${giteePullRequestIid}/ \</span>
<span class="s1">                            &amp;&amp; npm install &amp;&amp; npm run build-i18n &amp;&amp; npm run build-vendor &amp;&amp; npm run web:prod-ci || exit 1</span>
<span class="s1">                            sleep 6</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Docker run web&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                    set -u</span>
<span class="s1">                    cd /var/jenkins_home/nginx_conf/vhosts/ &amp;&amp; sed &quot;s/base/${giteePullRequestIid}/g&quot; base.conf &gt; ${giteePullRequestIid}.conf</span>
<span class="s1">                    mkdir -p /var/jenkins_home/html/${giteePullRequestIid}</span>
<span class="s1">                    cp -arf ${WORKSPACE}/${giteePullRequestIid}/public/ /var/jenkins_home/html/${giteePullRequestIid}</span>
<span class="s1">                    sleep 3</span>
<span class="s1">                    /var/jenkins_home/bin/docker -H tcp://192.168.1.27:2375 exec nginx_docker nginx -s reload</span>

<span class="s1">                    while true</span>
<span class="s1">                    do</span>
<span class="s1">                        if [[ $(curl --connect-timeout 3 -sL -w &quot;%{http_code}\\n&quot; http://${giteePullRequestIid}.git-ent.com -o /dev/null) -eq 200 ]]; then</span>
<span class="s1">                          echo &quot;Deployment complete...........&quot;</span>
<span class="s1">                          break</span>
<span class="s1">                        else</span>
<span class="s1">                          echo &quot;wait website init dns setting ...&quot;</span>
<span class="s1">                          sleep 1</span>
<span class="s1">                      fi</span>
<span class="s1">                    done</span>
<span class="s1">                &#39;&#39;&#39;</span>
                <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&lt;details&gt;</span>
<span class="s1">    &lt;summary&gt;CI Opened&lt;/summary&gt;</span>

<span class="s1">部署已完成，正在启动服务。[点我测试](http://&#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">giteePullRequestIid</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;.git-ent.com)</span>

<span class="s1">访问该 url 前 需要本地 dns 设置为192.168.1.60</span>

<span class="s1">测试用户：（可联系测试人员获取更多用户）</span>

<span class="s1">​```</span>
<span class="s1">用户名： wiki@qq.com</span>
<span class="s1">密码： 123456</span>
<span class="s1">​```</span>

<span class="s1">若有任务需要执行或者查看日志,待开发... t0d0</span>

<span class="s1">&lt;/details&gt;</span>
<span class="s1">                &#39;&#39;&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;delete&#39;</span><span class="o">){</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">anyOf</span> <span class="o">{</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    set -u</span>
<span class="s1">                    rm -rf /var/jenkins_home/nginx_conf/vhosts/${giteePullRequestIid}.conf</span>
<span class="s1">                    rm -rf /var/jenkins_home/html/${giteePullRequestIid}</span>
<span class="s1">                    /var/jenkins_home/bin/docker -H tcp://192.168.1.27:2375 exec nginx_docker nginx -s reload</span>
<span class="s1">                    sleep 3</span>
<span class="s1">                &#39;&#39;&#39;</span>
                <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI Closed&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>
  <span class="o">}</span>

    <span class="n">post</span> <span class="o">{</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI build failure! [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="c1">// clean namespace</span>
            <span class="c1">//cleanWs()</span>
        <span class="o">}</span>
        <span class="n">aborted</span> <span class="o">{</span>
            <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI build aborted! [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="jenkin">
<h4>4.4.7 Jenkin进行参数判断跳过相关阶段示例<a class="headerlink" href="#jenkin" title="Permalink to this headline">¶</a></h4>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="o">{</span> <span class="n">label</span> <span class="s1">&#39;agent-113-ssd&#39;</span> <span class="o">}</span>

    <span class="n">tools</span> <span class="o">{</span> <span class="n">nodejs</span> <span class="s2">&quot;node14.18.0&quot;</span> <span class="o">}</span>

    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">GIT_ADDRESS</span> <span class="o">=</span> <span class="s2">&quot;https://gitee.com/oschina/gitee-ent-web.git&quot;</span>
        <span class="n">COMMENT_ID</span> <span class="o">=</span> <span class="n">sh</span><span class="o">(</span><span class="nl">returnStdout:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">script:</span> <span class="s1">&#39;echo -n $noteBody |sed -e &quot;s/ci_build//g&quot;&#39;</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span>
        <span class="n">IS_COMMUNITY</span> <span class="o">=</span> <span class="n">sh</span><span class="o">(</span><span class="nl">returnStdout:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">script:</span> <span class="s1">&#39;echo -n $giteeBranch |grep &quot;community&quot; -q &amp;&amp; echo true || echo false&#39;</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span>
        <span class="n">NFS_SERVER</span> <span class="o">=</span> <span class="s2">&quot;192.168.1.60&quot;</span>
        <span class="n">ENV_api</span> <span class="o">=</span> <span class="s2">&quot;ci-runjs&quot;</span>
        <span class="n">ENV</span> <span class="o">=</span> <span class="s2">&quot;ci&quot;</span>
        <span class="n">MAIL_RECEIVER</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="o">}</span>



    <span class="n">options</span> <span class="o">{</span>
       <span class="n">skipDefaultCheckout</span> <span class="kc">true</span>
       <span class="n">timestamps</span><span class="o">()</span>
       <span class="n">quietPeriod</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
       <span class="n">buildDiscarder</span><span class="o">(</span><span class="n">logRotator</span><span class="o">(</span><span class="nl">numToKeepStr:</span> <span class="s1">&#39;10&#39;</span><span class="o">))</span>
       <span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">30</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="o">)</span>
       <span class="n">checkoutToSubdirectory</span><span class="o">(</span><span class="s2">&quot;${giteePullRequestIid}&quot;</span><span class="o">)</span>
    <span class="o">}</span>


    <span class="n">stages</span> <span class="o">{</span>
      <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;delete comment&#39;</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">when</span> <span class="o">{</span>
              <span class="n">not</span> <span class="o">{</span>
                  <span class="n">anyOf</span> <span class="o">{</span>
                      <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                      <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                  <span class="o">}</span>
              <span class="o">}</span>
          <span class="o">}</span>
          <span class="n">steps</span> <span class="o">{</span>
              <span class="n">sh</span> <span class="s1">&#39;python ${JENKINS_HOME}/comments_pr.py ${giteePullRequestIid} ${access_token}&#39;</span>
          <span class="o">}</span>
        <span class="o">}</span>

      <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;before compilation&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">when</span> <span class="o">{</span>
            <span class="n">not</span> <span class="o">{</span>
                <span class="n">anyOf</span> <span class="o">{</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">failFast</span> <span class="kc">true</span>
        <span class="n">parallel</span> <span class="o">{</span>
          <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;git clone&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">options</span> <span class="o">{</span> <span class="n">retry</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">}</span>
              <span class="n">steps</span> <span class="o">{</span>
                <span class="n">checkout</span><span class="o">([</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;GitSCM&#39;</span><span class="o">,</span> <span class="nl">branches:</span> <span class="o">[[</span><span class="nl">name:</span> <span class="s1">&#39;pull/${giteePullRequestIid}/MERGE&#39;</span><span class="o">]],</span> <span class="nl">extensions:</span> <span class="o">[[</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;CleanBeforeCheckout&#39;</span><span class="o">,</span> <span class="nl">deleteUntrackedNestedRepositories:</span> <span class="kc">true</span><span class="o">],</span> <span class="o">[</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;RelativeTargetDirectory&#39;</span><span class="o">,</span> <span class="nl">relativeTargetDir:</span> <span class="s1">&#39;$giteePullRequestIid&#39;</span><span class="o">]],</span> <span class="nl">userRemoteConfigs:</span> <span class="o">[[</span><span class="nl">credentialsId:</span> <span class="s1">&#39;8b3c4868-feea-42cd-aa94-09431a281392&#39;</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;origin&#39;</span><span class="o">,</span> <span class="nl">refspec:</span> <span class="s1">&#39;+refs/pull/*/MERGE:refs/pull/*/MERGE&#39;</span><span class="o">,</span> <span class="nl">url:</span> <span class="s2">&quot;${GIT_ADDRESS}&quot;</span><span class="o">]]])</span>
              <span class="o">}</span>
            <span class="o">}</span>

          <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;add start comment to GiteePR&#39;</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">steps</span> <span class="o">{</span>
                  <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI triggered, building... [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="o">+</span><span class="s2">&quot; **查看构建进度 👉**   账号:devops-dev 密码:OSChina@2022&quot;</span>
              <span class="o">}</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;build way&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">failFast</span> <span class="kc">true</span>
            <span class="n">parallel</span> <span class="o">{</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;build gitee-community-web image&#39;</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">when</span> <span class="o">{</span>
                      <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;IS_COMMUNITY&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;true&#39;</span>
                    <span class="o">}</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                            set -ux</span>
<span class="s1">                            cd ${WORKSPACE}/${giteePullRequestIid}/packages/gitee-community-web/  \</span>
<span class="s1">                            &amp;&amp; sed -i &quot;s#https://gitee.com#https://${giteePullRequestIid}-com.runjs.cn#g&quot; .env.production \</span>
<span class="s1">                            &amp;&amp; sed -i &quot;s#http://cbd.runjs.cn#https://${giteePullRequestIid}-com.runjs.cn#g&quot; .env</span>
<span class="s1">                            cat .env.production</span>
<span class="s1">                            cat .env</span>
<span class="s1">                            cd ${WORKSPACE}/${giteePullRequestIid}/ &amp;&amp; \</span>
<span class="s1">                            GIT_COMMIT=$(cd ${WORKSPACE}/${giteePullRequestIid}/ &amp;&amp; \</span>
<span class="s1">                            git log -1 --format=%h) &amp;&amp; \</span>
<span class="s1">                            make community \</span>
<span class="s1">                              &amp;&amp; docker tag gitee-community-web:$GIT_COMMIT hub.gitee.cc/gitee-web/gitee-community-web:${giteePullRequestIid} \</span>
<span class="s1">                              &amp;&amp; docker push hub.gitee.cc/gitee-web/gitee-community-web:${giteePullRequestIid} \</span>
<span class="s1">                              &amp;&amp; docker rmi hub.gitee.cc/gitee-web/gitee-community-web:${giteePullRequestIid}</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;install node_module&#39;</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">when</span> <span class="o">{</span>
                      <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;IS_COMMUNITY&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;false&#39;</span>
                    <span class="o">}</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                            set -ux</span>
<span class="s1">                            node -v &amp;&amp; npm -v  &amp;&amp; npm install yarn -g &amp;&amp; yarn -v \</span>
<span class="s1">                            &amp;&amp; cd ${WORKSPACE}/${giteePullRequestIid}/ \</span>
<span class="s1">                            &amp;&amp; yarn install \</span>
<span class="s1">                            &amp;&amp; yarn run build-i18n &amp;&amp; yarn run build-vendor || exit 1</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>


        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;IS_COMMUNITY&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;true&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">failFast</span> <span class="kc">true</span>
            <span class="n">parallel</span> <span class="o">{</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Code style check&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                            set -ux</span>
<span class="s1">                            cd ${WORKSPACE}/${giteePullRequestIid}/</span>
<span class="s1">                            ./scripts/prettier-migration.sh check || exit 1</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Unit tests&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                            set -ux</span>
<span class="s1">                            cd ${WORKSPACE}/${giteePullRequestIid}/</span>
<span class="s1">                            yarn test --ci --reporters=default --reporters=&quot;jest-junit&quot; || exit 1</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span>
                    <span class="n">post</span> <span class="o">{</span>
                        <span class="n">always</span> <span class="o">{</span>
                            <span class="n">junit</span> <span class="n">env</span><span class="o">.</span><span class="na">giteePullRequestIid</span> <span class="o">+</span> <span class="s1">&#39;/junit.xml&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Build ci&#39;</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">when</span> <span class="o">{</span>
                      <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;COMMENT_ID&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;&#39;</span>
                    <span class="o">}</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                              set -ux</span>
<span class="s1">                              export ENV=&quot;ci&quot;</span>
<span class="s1">                              cd ${WORKSPACE}/${giteePullRequestIid}/</span>
<span class="s1">                              yarn run web:prod-ci || exit 1</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span>
                    <span class="n">post</span> <span class="o">{</span>
                        <span class="n">failure</span> <span class="o">{</span>
                            <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;⛔ build 前端资源失败，查看详细信息 👉  &quot;</span> <span class="o">+</span> <span class="s2">&quot;[BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                <span class="o">}</span>

                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Build ci-runjs&#39;</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">when</span> <span class="o">{</span>
                      <span class="n">not</span> <span class="o">{</span>
                          <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;COMMENT_ID&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                              set -ux</span>
<span class="s1">                              export ENV=&quot;ci-runjs&quot;</span>
<span class="s1">                              cd ${WORKSPACE}/${giteePullRequestIid}/</span>
<span class="s1">                              export GITEE_BASE_URL=https://${COMMENT_ID}.runjs.cn &amp;&amp; export PIPE_BASE_URL=https://local-pipe-api.runjs.cn || exit 1</span>
<span class="s1">                              yarn web:prod-ci-runjs || exit 1</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span>
                    <span class="n">post</span> <span class="o">{</span>
                        <span class="n">failure</span> <span class="o">{</span>
                            <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;⛔ build 前端资源失败，查看详细信息 👉  &quot;</span> <span class="o">+</span> <span class="s2">&quot;[BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>


        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Deploy node&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;IS_COMMUNITY&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;true&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">failFast</span> <span class="kc">true</span>
            <span class="n">parallel</span> <span class="o">{</span>
              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;ci-node deploy&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">when</span> <span class="o">{</span>
                  <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;COMMENT_ID&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;&#39;</span>
                <span class="o">}</span>
                <span class="n">steps</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                          set -ux</span>
<span class="s1">                          # helm uninstall</span>
<span class="s1">                          $JENKINS_HOME/bin/helm uninstall ci-nginx-${giteePullRequestIid} -n ci-nginx-${giteePullRequestIid}</span>
<span class="s1">                          $JENKINS_HOME/bin/kubectl delete ns ci-nginx-${giteePullRequestIid}</span>

<span class="s1">                          # copy static files</span>
<span class="s1">                          $JENKINS_HOME/bin/sshpass -p &quot;${nfs_passord}&quot; ssh -n root@${NFS_SERVER} &quot;rm -rf /data/nfs/k8ssc/jenkins/ent-gitee/nginx/html/${giteePullRequestIid}&quot;</span>
<span class="s1">                          $JENKINS_HOME/bin/sshpass -p &quot;${nfs_passord}&quot; ssh -n root@${NFS_SERVER} &quot;mkdir -p /data/nfs/k8ssc/jenkins/ent-gitee/nginx/html/${giteePullRequestIid}&quot;</span>
<span class="s1">                          $JENKINS_HOME/bin/sshpass -p &quot;${nfs_passord}&quot; rsync -aqvzP -e &quot;ssh -p 22&quot; ${WORKSPACE}/${giteePullRequestIid}/dist root@${NFS_SERVER}:/data/nfs/k8ssc/jenkins/ent-gitee/nginx/html/${giteePullRequestIid}/</span>
<span class="s1">                          $JENKINS_HOME/bin/sshpass -p &quot;${nfs_passord}&quot; ssh -n root@${NFS_SERVER} &quot;chown -R 1000:1000 /data/nfs/k8ssc/jenkins/ent-gitee/nginx/html/${giteePullRequestIid}&quot;</span>

<span class="s1">                          # helm deploy</span>
<span class="s1">                          $JENKINS_HOME/bin/kubectl create ns ci-nginx-${giteePullRequestIid}</span>
<span class="s1">                          cp -rf $JENKINS_HOME/ent-nginx-helm $JENKINS_HOME/ent-nginx-helm-${giteePullRequestIid}</span>
<span class="s1">                          sed -i &quot;s@PRID@${giteePullRequestIid}@g&quot; $JENKINS_HOME/ent-nginx-helm-${giteePullRequestIid}/values.yaml</span>
<span class="s1">                          $JENKINS_HOME/bin/helm install ci-nginx-${giteePullRequestIid} $JENKINS_HOME/ent-nginx-helm-${giteePullRequestIid} -n ci-nginx-${giteePullRequestIid}</span>
<span class="s1">                          rm -rf $JENKINS_HOME/ent-nginx-helm-${giteePullRequestIid}</span>
<span class="s1">                       &#39;&#39;&#39;</span>
                       <span class="o">}</span>
                    <span class="o">}</span>

              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;ci-runjs-node deploy&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">when</span> <span class="o">{</span>
                  <span class="n">not</span> <span class="o">{</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;COMMENT_ID&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;&#39;</span>
                   <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">steps</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                          set -ux</span>
<span class="s1">                          # helm uninstall</span>
<span class="s1">                          $JENKINS_HOME/bin/helm uninstall ci-nginx-${giteePullRequestIid} -n ci-nginx-${giteePullRequestIid}</span>
<span class="s1">                          $JENKINS_HOME/bin/kubectl delete ns ci-nginx-${giteePullRequestIid}</span>

<span class="s1">                          # copy static files</span>
<span class="s1">                          $JENKINS_HOME/bin/sshpass -p &quot;${nfs_passord}&quot; ssh -n root@${NFS_SERVER} &quot;rm -rf /data/nfs/k8ssc/jenkins/ent-gitee/nginx/htmlapi/${giteePullRequestIid}&quot;</span>
<span class="s1">                          $JENKINS_HOME/bin/sshpass -p &quot;${nfs_passord}&quot; ssh -n root@${NFS_SERVER} &quot;mkdir -p /data/nfs/k8ssc/jenkins/ent-gitee/nginx/htmlapi/${giteePullRequestIid}&quot;</span>
<span class="s1">                          $JENKINS_HOME/bin/sshpass -p &quot;${nfs_passord}&quot; rsync -aqvzP -e &quot;ssh -p 22&quot; ${WORKSPACE}/${giteePullRequestIid}/dist root@${NFS_SERVER}:/data/nfs/k8ssc/jenkins/ent-gitee/nginx/htmlapi/${giteePullRequestIid}/</span>
<span class="s1">                          $JENKINS_HOME/bin/sshpass -p &quot;${nfs_passord}&quot; ssh -n root@${NFS_SERVER} &quot;chown -R 1000:1000 /data/nfs/k8ssc/jenkins/ent-gitee/nginx/htmlapi/${giteePullRequestIid}&quot;</span>

<span class="s1">                          # helm deploy</span>
<span class="s1">                          $JENKINS_HOME/bin/kubectl create ns ci-nginx-${giteePullRequestIid}</span>
<span class="s1">                          cp -rf $JENKINS_HOME/ent-nginx-api-helm $JENKINS_HOME/ent-nginx-api-helm-${giteePullRequestIid}</span>

<span class="s1">                          sed -i &quot;s@PRID@${giteePullRequestIid}@g&quot; $JENKINS_HOME/ent-nginx-api-helm-${giteePullRequestIid}/values.yaml</span>
<span class="s1">                          sed -i &quot;s@GITEE_API_ID@${COMMENT_ID}@g&quot; $JENKINS_HOME/ent-nginx-api-helm-${giteePullRequestIid}/values.yaml</span>
<span class="s1">                          $JENKINS_HOME/bin/helm install ci-nginx-${giteePullRequestIid} $JENKINS_HOME/ent-nginx-api-helm-${giteePullRequestIid} -n ci-nginx-${giteePullRequestIid}</span>
<span class="s1">                          rm -rf $JENKINS_HOME/ent-nginx-api-helm-${giteePullRequestIid}</span>
<span class="s1">                       &#39;&#39;&#39;</span>
                       <span class="o">}</span>
                    <span class="o">}</span>
                  <span class="o">}</span>
              <span class="o">}</span>


        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Deploy gitee-community-web&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;IS_COMMUNITY&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;false&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">failFast</span> <span class="kc">true</span>
            <span class="n">parallel</span> <span class="o">{</span>
              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;ci-nextjs deploy&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">when</span> <span class="o">{</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;COMMENT_ID&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;&#39;</span>
                <span class="o">}</span>
                <span class="n">steps</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                          set -ux</span>
<span class="s1">                          echo &quot;部署nextjs&quot;</span>
<span class="s1">                          # helm uninstall</span>
<span class="s1">                          $JENKINS_HOME/bin/helm uninstall gitee-community-web-${giteePullRequestIid} -n nextjs</span>

<span class="s1">                          # helm deploy</span>
<span class="s1">                          cp -rf $JENKINS_HOME/nextjs-helm $JENKINS_HOME/nextjs-helm-${giteePullRequestIid}</span>
<span class="s1">                          sed -i &quot;s@PRID@${giteePullRequestIid}@g&quot; $JENKINS_HOME/nextjs-helm-${giteePullRequestIid}/values.yaml</span>
<span class="s1">                          cd $JENKINS_HOME &amp;&amp; \</span>
<span class="s1">                            $JENKINS_HOME/bin/helm install gitee-community-web-${giteePullRequestIid} nextjs-helm-${giteePullRequestIid}/ -n nextjs</span>

<span class="s1">                          rm -rf $JENKINS_HOME/nextjs-helm-${giteePullRequestIid}</span>
<span class="s1">                       &#39;&#39;&#39;</span>

                   <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                         set -ux</span>
<span class="s1">                         echo &quot;部署nginx-proxy&quot;</span>
<span class="s1">                         # helm uninstall</span>
<span class="s1">                         $JENKINS_HOME/bin/helm uninstall nginx-proxy-${giteePullRequestIid} -n nginx-${giteePullRequestIid}</span>
<span class="s1">                         $JENKINS_HOME/bin/kubectl delete ns nginx-${giteePullRequestIid}</span>

<span class="s1">                         # helm deploy</span>
<span class="s1">                         $JENKINS_HOME/bin/kubectl create ns nginx-${giteePullRequestIid}</span>
<span class="s1">                         cp -rf $JENKINS_HOME/nginx-proxy-helm $JENKINS_HOME/nginx-proxy-helm-${giteePullRequestIid}</span>
<span class="s1">                         sed -i &quot;s@PRID@${giteePullRequestIid}@g&quot; $JENKINS_HOME/nginx-proxy-helm-${giteePullRequestIid}/values.yaml</span>
<span class="s1">                         sed -i &quot;s@GITEE_API_ID@master@g&quot; $JENKINS_HOME/nginx-proxy-helm-${giteePullRequestIid}/values.yaml</span>

<span class="s1">                         cd $JENKINS_HOME &amp;&amp; \</span>
<span class="s1">                            $JENKINS_HOME/bin/helm install nginx-proxy-${giteePullRequestIid} nginx-proxy-helm-${giteePullRequestIid}/ -n nginx-${giteePullRequestIid}</span>
<span class="s1">                         rm -rf $JENKINS_HOME/nginx-proxy-helm-${giteePullRequestIid}</span>
<span class="s1">                      &#39;&#39;&#39;</span>
                       <span class="o">}</span>
                    <span class="o">}</span>

              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;ci-runjs-nextjs deploy&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">when</span> <span class="o">{</span>
                    <span class="n">not</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;COMMENT_ID&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;&#39;</span>
                     <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">steps</span> <span class="o">{</span>
                  <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                        set -ux</span>
<span class="s1">                        echo &quot;部署nextjs&quot;</span>
<span class="s1">                        # helm uninstall</span>
<span class="s1">                        $JENKINS_HOME/bin/helm uninstall gitee-community-web-${giteePullRequestIid} -n nextjs</span>

<span class="s1">                        # helm deploy</span>
<span class="s1">                        cp -rf $JENKINS_HOME/nextjs-helm $JENKINS_HOME/nextjs-helm-${giteePullRequestIid}</span>
<span class="s1">                        sed -i &quot;s@PRID@${giteePullRequestIid}@g&quot; $JENKINS_HOME/nextjs-helm-${giteePullRequestIid}/values.yaml</span>

<span class="s1">                        cd $JENKINS_HOME &amp;&amp; \</span>
<span class="s1">                          $JENKINS_HOME/bin/helm install gitee-community-web-${giteePullRequestIid} nextjs-helm-${giteePullRequestIid}/ -n nextjs</span>
<span class="s1">                        rm -rf $JENKINS_HOME/nextjs-helm-${giteePullRequestIid}</span>
<span class="s1">                     &#39;&#39;&#39;</span>

                    <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                          set -ux</span>
<span class="s1">                          echo &quot;部署nginx-proxy&quot;</span>
<span class="s1">                          # helm uninstall</span>
<span class="s1">                          $JENKINS_HOME/bin/helm uninstall nginx-proxy-${giteePullRequestIid} -n nginx-${giteePullRequestIid}</span>
<span class="s1">                          $JENKINS_HOME/bin/kubectl delete ns nginx-${giteePullRequestIid}</span>

<span class="s1">                          # helm deploy</span>
<span class="s1">                          $JENKINS_HOME/bin/kubectl create ns nginx-${giteePullRequestIid}</span>
<span class="s1">                          cp -rf $JENKINS_HOME/nginx-proxy-helm $JENKINS_HOME/nginx-proxy-helm-${giteePullRequestIid}</span>
<span class="s1">                          sed -i &quot;s@PRID@${giteePullRequestIid}@g&quot; $JENKINS_HOME/nginx-proxy-helm-${giteePullRequestIid}/values.yaml</span>
<span class="s1">                          sed -i &quot;s@GITEE_API_ID@${COMMENT_ID}@g&quot; $JENKINS_HOME/nginx-proxy-helm-${giteePullRequestIid}/values.yaml</span>

<span class="s1">                          cd $JENKINS_HOME &amp;&amp; \</span>
<span class="s1">                            $JENKINS_HOME/bin/helm install nginx-proxy-${giteePullRequestIid} nginx-proxy-helm-${giteePullRequestIid}/ -n nginx-${giteePullRequestIid}</span>
<span class="s1">                          rm -rf $JENKINS_HOME/nginx-proxy-helm-${giteePullRequestIid}</span>
<span class="s1">                       &#39;&#39;&#39;</span>
                     <span class="o">}</span>
                  <span class="o">}</span>
                <span class="o">}</span>
              <span class="o">}</span>

     <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;publish-node&#39;</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">when</span> <span class="o">{</span>
           <span class="n">not</span> <span class="o">{</span>
               <span class="n">anyOf</span> <span class="o">{</span>
                 <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                 <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                 <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;IS_COMMUNITY&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;true&#39;</span>
               <span class="o">}</span>
           <span class="o">}</span>
       <span class="o">}</span>
      <span class="n">failFast</span> <span class="kc">true</span>
      <span class="n">parallel</span> <span class="o">{</span>
      <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;publish ci-node&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">when</span> <span class="o">{</span>
            <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;COMMENT_ID&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;&#39;</span>
          <span class="o">}</span>
          <span class="n">steps</span> <span class="o">{</span>
            <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                set -ux</span>
<span class="s1">                while true</span>
<span class="s1">                do</span>
<span class="s1">                    Nginx_pod_Name=$($JENKINS_HOME/bin/kubectl get pod -n ci-nginx-${giteePullRequestIid}|grep ent-nginx|awk &#39;{print $1}&#39;)</span>
<span class="s1">                    Nginx_Pod_State=$($JENKINS_HOME/bin/kubectl get pod ${Nginx_pod_Name} -n ci-nginx-${giteePullRequestIid} --template=&quot;{{.status.phase}}&quot;)</span>
<span class="s1">                    if [[ &quot;${Nginx_Pod_State}&quot; == &quot;Running&quot; ]]; then</span>
<span class="s1">                      echo &quot;Deployment complete...........&quot;</span>
<span class="s1">                      break</span>
<span class="s1">                    else</span>
<span class="s1">                      echo &quot;wait website init dns setting ...&quot;</span>
<span class="s1">                      sleep 3</span>
<span class="s1">                  fi</span>
<span class="s1">                done</span>
<span class="s1">                &#39;&#39;&#39;</span>
                <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&lt;details&gt;</span>
<span class="s1">    &lt;summary&gt;CI Opened&lt;/summary&gt;</span>

<span class="s1">✅️部署已完成，正在启动服务。[点我测试](http://&#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">giteePullRequestIid</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;.git-ent.com)</span>

<span class="s1">访问该 url 前 需要本地 dns 设置为192.168.1.60</span>

<span class="s1">测试用户：（可联系测试人员获取更多用户）</span>

<span class="s1">```</span>
<span class="s1">用户名： wiki@qq.com</span>
<span class="s1">密码： 123456</span>
<span class="s1">```</span>

<span class="s1">若有任务需要执行或者查看docker容器日志,访问kubernetes容器管理界面，[点击访问](https://kube-dashboard.gitee.cc)</span>

<span class="s1">[kubernetes dashboard使用文档](https://gitee.com/oschina/CI-gitee-Docs/blob/master/dev-usage.md)</span>
<span class="s1">&lt;/details&gt;</span>
<span class="s1">&#39;&#39;&#39;</span>
          <span class="o">}</span>
      <span class="o">}</span>

      <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;publish ci-runjs-node&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">when</span> <span class="o">{</span>
          <span class="n">not</span> <span class="o">{</span>
              <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;COMMENT_ID&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;&#39;</span>
            <span class="o">}</span>
          <span class="o">}</span>
          <span class="n">steps</span> <span class="o">{</span>
              <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                  set -ux</span>
<span class="s1">                  while true</span>
<span class="s1">                  do</span>
<span class="s1">                      Nginx_pod_Name=$($JENKINS_HOME/bin/kubectl get pod -n ci-nginx-${giteePullRequestIid}|grep ent-api-nginx|awk &#39;{print $1}&#39;)</span>
<span class="s1">                      Nginx_Pod_State=$($JENKINS_HOME/bin/kubectl get pod ${Nginx_pod_Name} -n ci-nginx-${giteePullRequestIid} --template=&quot;{{.status.phase}}&quot;)</span>
<span class="s1">                      if [[ &quot;${Nginx_Pod_State}&quot; == &quot;Running&quot; ]]; then</span>
<span class="s1">                        echo &quot;Deployment complete...........&quot;</span>
<span class="s1">                        break</span>
<span class="s1">                      else</span>
<span class="s1">                        echo &quot;wait website init dns setting ...&quot;</span>
<span class="s1">                        sleep 3</span>
<span class="s1">                    fi</span>
<span class="s1">                  done</span>
<span class="s1">               &#39;&#39;&#39;</span>
<span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&lt;details&gt;</span>
<span class="s1">    &lt;summary&gt;✅️CI Opened，&lt;a href=&quot;https://&#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">giteePullRequestIid</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;-e.runjs.cn&quot;&gt;开始测试&lt;/a&gt;&lt;/summary&gt;</span>

<span class="s1">部署已完成，正在启动服务。</span>
<span class="s1">访问该 url 前 需要本地 dns 设置为 `192.168.1.60`，前端通过 `ci_build &#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">COMMENT_ID</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;` 跟后端对接调用数据展示，需要先 [访问后端](https://&#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">COMMENT_ID</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;.runjs.cn) 获取token登录信息。</span>
<span class="s1">测试用户：（可联系测试人员获取更多用户）</span>

<span class="s1">```</span>
<span class="s1">测试账号： git</span>
<span class="s1">密码： qwe123</span>
<span class="s1">```</span>
<span class="s1">若有任务需要执行或者查看docker容器日志,访问kubernetes容器管理界面，[点击访问](https://kube-dashboard.gitee.cc)</span>

<span class="s1">[kubernetes dashboard使用文档](https://gitee.com/oschina/CI-gitee-Docs/blob/master/dev-usage.md)</span>
<span class="s1">&lt;/details&gt;</span>
<span class="s1">  &#39;&#39;&#39;</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>



      <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;publish nextjs or runjs-nextjs&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">when</span> <span class="o">{</span>
            <span class="n">not</span> <span class="o">{</span>
                <span class="n">anyOf</span> <span class="o">{</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;IS_COMMUNITY&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;false&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
          <span class="o">}</span>
         <span class="n">steps</span> <span class="o">{</span>
             <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                   set -ux</span>
<span class="s1">                   echo &quot;publish ci-nextjs 版本&quot;</span>
<span class="s1">                   while true</span>
<span class="s1">                   do</span>
<span class="s1">                       nextjs_pod_Name=$($JENKINS_HOME/bin/kubectl get pod -n nextjs|grep gitee-community-web-${giteePullRequestIid} |awk &#39;{print $1}&#39;)</span>
<span class="s1">                       nextjs_Pod_State=$($JENKINS_HOME/bin/kubectl get pod ${nextjs_pod_Name} -n nextjs |grep gitee-community-web|awk &#39;{print $3}&#39;)</span>

<span class="s1">                       n_proxy_pod_Name=$($JENKINS_HOME/bin/kubectl get pod -n nginx-${giteePullRequestIid}|grep gitee-nginx|awk &#39;{print $1}&#39;)</span>
<span class="s1">                       n_proxy_Pod_State=$($JENKINS_HOME/bin/kubectl get pod ${n_proxy_pod_Name} -n nginx-${giteePullRequestIid} |grep gitee-nginx|awk &#39;{print $3}&#39;)</span>

<span class="s1">                       if [[ &quot;${nextjs_Pod_State}&quot; == &quot;Running&quot; &amp;&amp; &quot;${n_proxy_Pod_State}&quot; == &quot;Running&quot; ]]; then</span>
<span class="s1">                         echo &quot;Deployment complete...........&quot;</span>
<span class="s1">                         break</span>
<span class="s1">                       else</span>
<span class="s1">                         echo &quot;wait website init dns setting ...&quot;</span>
<span class="s1">                         sleep 3</span>
<span class="s1">                       fi</span>
<span class="s1">                   done</span>
<span class="s1">                &#39;&#39;&#39;</span>
                 <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1"> &lt;details&gt;</span>
<span class="s1">    &lt;summary&gt;✅️部署已完成 CI Opened ，&lt;a href=&quot;https://&#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">giteePullRequestIid</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;-com.runjs.cn&quot;&gt;开始测试&lt;/a&gt;&lt;/summary&gt;</span>

<span class="s1"> 访问该 url 前 需要本地 dns 设置为192.168.1.60</span>

<span class="s1"> 测试用户：（可联系测试人员获取更多用户）</span>

<span class="s1"> ```</span>
<span class="s1"> 用户名： wiki@qq.com</span>
<span class="s1"> 密码： 123456</span>
<span class="s1"> ```</span>

<span class="s1"> 若有任务需要执行或者查看docker容器日志,访问kubernetes容器管理界面，[点击访问](https://kube-dashboard.gitee.cc)</span>

<span class="s1"> [kubernetes dashboard使用文档](https://gitee.com/oschina/CI-gitee-Docs/blob/master/dev-usage.md)</span>
<span class="s1"> &lt;/details&gt;</span>
<span class="s1"> &#39;&#39;&#39;</span>
                <span class="o">}</span>
             <span class="o">}</span>


    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;提醒测试&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">steps</span> <span class="o">{</span>
            <span class="n">sh</span> <span class="s1">&#39;python ${JENKINS_HOME}/pr_check_tips.py ${giteePullRequestIid} ${access_token}&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="n">post</span> <span class="o">{</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI build failure! [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="o">+</span> <span class="s2">&quot; 👉   账号:devops-dev 密码:OSChina@2022&quot;</span>
            <span class="c1">// clean namespace</span>
        <span class="o">}</span>
        <span class="n">aborted</span> <span class="o">{</span>
            <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI build aborted! [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="o">+</span> <span class="s2">&quot; 👉   账号:devops-dev 密码:OSChina@2022&quot;</span>
            <span class="n">cleanWs</span><span class="o">()</span>
        <span class="o">}</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI build success! [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>  <span class="o">+</span> <span class="s2">&quot; 👉   账号:devops-dev 密码:OSChina@2022&quot;</span>
            <span class="n">cleanWs</span><span class="o">()</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="jenkins-jenkins-salvek8s">
<h4>4.4.8 Jenkins+Jenkins-salve在k8s部署示例<a class="headerlink" href="#jenkins-jenkins-salvek8s" title="Permalink to this headline">¶</a></h4>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="o">{</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">IMAGES_VERSION</span> <span class="o">=</span> <span class="s2">&quot;v4.0.0&quot;</span>
        <span class="n">RELEASE_VERSION</span> <span class="o">=</span> <span class="s2">&quot;master&quot;</span>
        <span class="n">GIT_ADDRESS</span> <span class="o">=</span> <span class="s2">&quot;https://gitee.com/oschina/gitee.git&quot;</span>
        <span class="n">GIT_AUTH</span> <span class="o">=</span> <span class="s2">&quot;gitee-ci-bot&quot;</span>
        <span class="n">Harbor_address</span> <span class="o">=</span> <span class="s2">&quot;hub.gitee.cc&quot;</span>
        <span class="n">Harbor_project_name</span> <span class="o">=</span> <span class="s2">&quot;hub.gitee.cc/gitee_ci&quot;</span>
        <span class="n">NFS_SERVER</span> <span class="o">=</span> <span class="s2">&quot;192.168.1.60&quot;</span>
        <span class="n">Harbor_auth</span> <span class="o">=</span> <span class="s2">&quot;c9ae4329-29f2-433f-a1b6-xxxx&quot;</span>
        <span class="n">MAIL_RECEIVER</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="o">}</span>

    <span class="n">options</span> <span class="o">{</span>
      <span class="n">disableResume</span><span class="o">()</span>
      <span class="n">skipDefaultCheckout</span><span class="o">()</span>
      <span class="n">quietPeriod</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
      <span class="n">timestamps</span><span class="o">()</span>
      <span class="n">buildDiscarder</span><span class="o">(</span><span class="n">logRotator</span><span class="o">(</span><span class="nl">numToKeepStr:</span> <span class="s1">&#39;100&#39;</span><span class="o">))</span>
      <span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">60</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;MINUTES&#39;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">agent</span> <span class="o">{</span>
        <span class="n">kubernetes</span> <span class="o">{</span>
            <span class="n">yaml</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">apiVersion: &quot;v1&quot;</span>
<span class="s1">kind: &quot;Pod&quot;</span>
<span class="s1">metadata:</span>
<span class="s1">  labels:</span>
<span class="s1">    jenkins: &quot;slave&quot;</span>
<span class="s1">  name: &quot;jenkins-slave&quot;</span>
<span class="s1">spec:</span>
<span class="s1">  containers:</span>
<span class="s1">  - env:</span>
<span class="s1">    - name: &quot;JENKINS_AGENT_WORKDIR&quot;</span>
<span class="s1">      value: &quot;/home/jenkins/agent&quot;</span>
<span class="s1">    - name: &quot;JENKINS_URL&quot;</span>
<span class="s1">      value: &quot;http://jenkins.ci.svc.cluster.local:8080/jenkins/&quot;</span>
<span class="s1">    name: &quot;jnlp&quot;</span>
<span class="s1">    image: &quot;hub.gitee.cc/library/jenkins-salve:v5.0.0&quot;</span>
<span class="s1">    imagePullPolicy: &quot;IfNotPresent&quot;</span>
<span class="s1">    tty: true</span>

<span class="s1">    volumeMounts:</span>
<span class="s1">    - mountPath: &quot;/etc/hosts&quot;</span>
<span class="s1">      name: &quot;gitee-hosts-cm&quot;</span>
<span class="s1">      subPath: hosts</span>
<span class="s1">      readOnly: false</span>
<span class="s1">    - mountPath: &quot;/home/jenkins/agent/scripts&quot;</span>
<span class="s1">      name: &quot;gitee-scripts&quot;</span>
<span class="s1">      readOnly: false</span>
<span class="s1">    - mountPath: &quot;/home/jenkins/agent/dockerfile&quot;</span>
<span class="s1">      name: &quot;gitee-dockerfile&quot;</span>
<span class="s1">      readOnly: false</span>
<span class="s1">    - mountPath: &quot;/home/jenkins/agent/helm-chart&quot;</span>
<span class="s1">      name: &quot;gitee-helm&quot;</span>
<span class="s1">      readOnly: false</span>

<span class="s1">    - mountPath: &quot;/home/jenkins/agent/global&quot;</span>
<span class="s1">      name: &quot;global&quot;</span>
<span class="s1">    - mountPath: &quot;/home/jenkins/agent/target/allure-results&quot;</span>
<span class="s1">      name: &quot;allure-results&quot;</span>

<span class="s1">    - mountPath: &quot;/home/jenkins/agent&quot;</span>
<span class="s1">      name: &quot;workspace-volume&quot;</span>
<span class="s1">      readOnly: false</span>
<span class="s1">  restartPolicy: &quot;Never&quot;</span>


<span class="s1">  volumes:</span>
<span class="s1">  - name: &quot;gitee-hosts-cm&quot;</span>
<span class="s1">    configMap:</span>
<span class="s1">      name: gitee-hosts-cm</span>
<span class="s1">      defaultMode: 493</span>
<span class="s1">  - name: &quot;gitee-dockerfile&quot;</span>
<span class="s1">    nfs:</span>
<span class="s1">      path: &quot;/k8ssc/jenkins/community-gitee/dockerfile&quot;</span>
<span class="s1">      readOnly: false</span>
<span class="s1">      server: &quot;192.168.1.60&quot;</span>
<span class="s1">  - name: &quot;gitee-scripts&quot;</span>
<span class="s1">    nfs:</span>
<span class="s1">      path: &quot;/k8ssc/jenkins/community-gitee/scripts&quot;</span>
<span class="s1">      readOnly: false</span>
<span class="s1">      server: &quot;192.168.1.60&quot;</span>
<span class="s1">  - name: &quot;gitee-helm&quot;</span>
<span class="s1">    nfs:</span>
<span class="s1">      path: &quot;/k8ssc/jenkins/community-gitee/helm-chart&quot;</span>
<span class="s1">      readOnly: false</span>
<span class="s1">      server: &quot;192.168.1.60&quot;</span>
<span class="s1">  - name: &quot;allure-results&quot;</span>
<span class="s1">    nfs:</span>
<span class="s1">      path: &quot;/k8ssc/jenkins/target/allure-results&quot;</span>
<span class="s1">      readOnly: false</span>
<span class="s1">      server: &quot;192.168.1.60&quot;</span>

<span class="s1">  - name: &quot;global&quot;</span>
<span class="s1">    nfs:</span>
<span class="s1">      path: &quot;/global&quot;</span>
<span class="s1">      server: &quot;192.168.1.60&quot;</span>
<span class="s1">  - emptyDir:</span>
<span class="s1">      medium: &quot;&quot;</span>
<span class="s1">    name: &quot;workspace-volume&quot;</span>
<span class="s1">            &#39;&#39;&#39;</span>
        <span class="o">}</span>
    <span class="o">}</span>


     <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;delete comment&#39;</span><span class="o">){</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                python --version &amp;&amp; \</span>
<span class="s1">                cd $JENKINS_AGENT_WORKDIR/scripts &amp;&amp; python comments_pr.py ${giteePullRequestIid} ${access_token}</span>
<span class="s1">                &#39;&#39;&#39;</span>
               <span class="o">}</span>
        <span class="o">}</span>


        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;add start comment to GiteePR&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI triggered, building... [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="o">+</span><span class="s2">&quot; **查看构建进度 👉** 账号:devops-dev 密码:OSChina@2022&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>



        <span class="n">stage</span><span class="o">(</span><span class="s2">&quot;build and pull image&quot;</span><span class="o">){</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">failFast</span> <span class="kc">true</span>
            <span class="n">parallel</span> <span class="o">{</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;git fetch pr-code&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">options</span> <span class="o">{</span> <span class="n">retry</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">}</span>
                <span class="n">steps</span> <span class="o">{</span>
                    <span class="n">checkout</span><span class="o">([</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;GitSCM&#39;</span><span class="o">,</span> <span class="nl">branches:</span> <span class="o">[[</span><span class="nl">name:</span> <span class="s2">&quot;pull/${giteePullRequestIid}/MERGE&quot;</span><span class="o">]],</span> <span class="nl">extensions:</span> <span class="o">[[</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;SparseCheckoutPaths&#39;</span><span class="o">,</span> <span class="nl">sparseCheckoutPaths:</span> <span class="o">[[</span><span class="nl">path:</span> <span class="s1">&#39;config/&#39;</span><span class="o">]]]],</span> <span class="nl">userRemoteConfigs:</span> <span class="o">[[</span><span class="nl">credentialsId:</span> <span class="s2">&quot;${GIT_AUTH}&quot;</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;origin&#39;</span><span class="o">,</span> <span class="nl">refspec:</span> <span class="s1">&#39;+refs/pull/*/MERGE:refs/pull/*/MERGE&#39;</span><span class="o">,</span> <span class="nl">url:</span> <span class="s2">&quot;${GIT_ADDRESS}&quot;</span><span class="o">]]])</span>
                <span class="o">}</span>
                <span class="n">post</span> <span class="o">{</span>
                    <span class="n">failure</span> <span class="o">{</span>
                        <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s1">&#39;&#39;&#39;⛔ 拉取代码异常.  ⬇️请重新ci_build...&#39;&#39;&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
            <span class="o">}</span>

            <span class="n">stage</span><span class="o">(</span><span class="s2">&quot;build pr cigiteebe image&quot;</span><span class="o">){</span>
                <span class="n">options</span> <span class="o">{</span> <span class="n">retry</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">}</span>
                <span class="n">steps</span> <span class="o">{</span>
                    <span class="n">withCredentials</span><span class="o">([[</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;UsernamePasswordMultiBinding&#39;</span><span class="o">,</span>
                      <span class="nl">credentialsId:</span> <span class="s2">&quot;${Harbor_auth}&quot;</span><span class="o">,</span>
                      <span class="nl">usernameVariable:</span> <span class="s1">&#39;Harbor_user&#39;</span><span class="o">,</span>
                      <span class="nl">passwordVariable:</span> <span class="s1">&#39;Harbor_password&#39;</span><span class="o">]])</span> <span class="o">{</span>
                      <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                        set -eux</span>
<span class="s1">                        # build backend image on 113</span>
<span class="s1">                        cp -rf $JENKINS_AGENT_WORKDIR/dockerfile $JENKINS_AGENT_WORKDIR/dockerfile-${giteePullRequestIid}</span>
<span class="s1">                        cd $JENKINS_AGENT_WORKDIR/dockerfile-${giteePullRequestIid}</span>
<span class="s1">                        export DOCKER_HOST=tcp://192.168.1.113:2375 &amp;&amp; \</span>
<span class="s1">                        sed -i &quot;s@PRID@${giteePullRequestIid}@g&quot; Dockerfile${IMAGES_VERSION}-backend</span>
<span class="s1">                        $HOME/bin/docker login -u ${Harbor_user} -p ${Harbor_password} ${Harbor_address}</span>
<span class="s1">                        $HOME/bin/docker build --no-cache --pull -f Dockerfile${IMAGES_VERSION}-backend -t ${Harbor_project_name}/backend:${IMAGES_VERSION}-${giteePullRequestIid} .</span>
<span class="s1">                        $HOME/bin/docker push ${Harbor_project_name}/backend:${IMAGES_VERSION}-${giteePullRequestIid}</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="n">post</span> <span class="o">{</span>
                    <span class="n">failure</span> <span class="o">{</span>
                        <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s1">&#39;&#39;&#39;⛔ PR分支与master分支差异太大，出现PR冲突 Compile PR image error...  ⬇️请合并master分支代码 再次ci_build进行部署...&#39;&#39;&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="n">stage</span><span class="o">(</span><span class="s2">&quot;build pr cigiteefe image&quot;</span><span class="o">){</span>
                <span class="n">options</span> <span class="o">{</span> <span class="n">retry</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">}</span>
                <span class="n">steps</span> <span class="o">{</span>
                    <span class="n">withCredentials</span><span class="o">([[</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;UsernamePasswordMultiBinding&#39;</span><span class="o">,</span>
                      <span class="nl">credentialsId:</span> <span class="s2">&quot;${Harbor_auth}&quot;</span><span class="o">,</span>
                      <span class="nl">usernameVariable:</span> <span class="s1">&#39;Harbor_user&#39;</span><span class="o">,</span>
                      <span class="nl">passwordVariable:</span> <span class="s1">&#39;Harbor_password&#39;</span><span class="o">]])</span> <span class="o">{</span>
                      <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                        set -eux</span>
<span class="s1">                        # build frontend image on 61</span>
<span class="s1">                        cp -rf $JENKINS_AGENT_WORKDIR/dockerfile $JENKINS_AGENT_WORKDIR/dockerfile-${giteePullRequestIid}</span>
<span class="s1">                        cd $JENKINS_AGENT_WORKDIR/dockerfile-${giteePullRequestIid}</span>
<span class="s1">                        sed -i &quot;s@PRID@${giteePullRequestIid}@g&quot; Dockerfile${IMAGES_VERSION}-frontend</span>
<span class="s1">                        export DOCKER_HOST=tcp://192.168.1.61:2375 &amp;&amp; \</span>
<span class="s1">                        $HOME/bin/docker login -u ${Harbor_user} -p ${Harbor_password} ${Harbor_address}</span>
<span class="s1">                        $HOME/bin/docker build --no-cache --pull -f Dockerfile${IMAGES_VERSION}-frontend -t ${Harbor_project_name}/nginx:${IMAGES_VERSION}-${giteePullRequestIid} .</span>
<span class="s1">                        $HOME/bin/docker push ${Harbor_project_name}/nginx:${IMAGES_VERSION}-${giteePullRequestIid}</span>
<span class="s1">                        $HOME/bin/docker rmi ${Harbor_project_name}/nginx:${IMAGES_VERSION}-${giteePullRequestIid}</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="n">post</span> <span class="o">{</span>
                    <span class="n">failure</span> <span class="o">{</span>
                        <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s1">&#39;&#39;&#39;⛔ PR分支与master分支差异太大，出现PR冲突 Compile PR image error...  ⬇️请合并master分支代码 再次ci_build进行部署&#39;&#39;&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;helm deploy&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                            set -ux</span>
<span class="s1">                            if [ ! -d $JENKINS_AGENT_WORKDIR/global/${giteePullRequestIid}/public ];then</span>
<span class="s1">                                mkdir -p $JENKINS_AGENT_WORKDIR/global/${giteePullRequestIid}/public</span>
<span class="s1">                                tar -zxf $JENKINS_AGENT_WORKDIR/global/public/assets.tar.gz -C $JENKINS_AGENT_WORKDIR/global/${giteePullRequestIid}/public</span>
<span class="s1">                                tar -zxf $JENKINS_AGENT_WORKDIR/global/public/webpacks.tar.gz -C $JENKINS_AGENT_WORKDIR/global/${giteePullRequestIid}/public</span>
<span class="s1">                            else</span>
<span class="s1">                                echo &quot;$JENKINS_AGENT_WORKDIR/global/${giteePullRequestIid}/public already exists..&quot;</span>
<span class="s1">                            fi</span>
<span class="s1">                    &#39;&#39;&#39;</span>


                <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                     set -eux</span>
<span class="s1">                     cp -rf $JENKINS_AGENT_WORKDIR/helm-chart/CI-gitee-helmv4.0 $JENKINS_AGENT_WORKDIR/helm-chart/CI-gitee-helmv4.0-${giteePullRequestIid}</span>

<span class="s1">                     cd $JENKINS_AGENT_WORKDIR/helm-chart/CI-gitee-helmv4.0-${giteePullRequestIid} &amp;&amp; \</span>
<span class="s1">                        sed \</span>
<span class="s1">                        -e &quot;s@CPRID@${giteePullRequestIid}@g&quot; \</span>
<span class="s1">                        -e &quot;s@image: gitee_ci/backend:.*@image: gitee_ci/backend:${IMAGES_VERSION}-${giteePullRequestIid}@g&quot; \</span>
<span class="s1">                        -e &quot;s@image: gitee_ci/nginx:.*@image: gitee_ci/nginx:${IMAGES_VERSION}-${giteePullRequestIid}@g&quot; values.yaml.template &gt; ${giteePullRequestIid}values.yaml</span>

<span class="s1">                    cp -rf $WORKSPACE/config/gitlab.yml.cm ./charts/backend/templates/configmap-gitlab-yml.yaml &amp;&amp; \</span>
<span class="s1">                    cp -rf $WORKSPACE/config/environments/production.rb.cm ./charts/backend/templates/configmap-production-rb.yaml</span>

<span class="s1">                     $HOME/bin/kubectl create ns ci-gitee-${giteePullRequestIid} || echo &quot;namespace already exists&quot;</span>

<span class="s1">                     cd $JENKINS_AGENT_WORKDIR/helm-chart/CI-gitee-helmv4.0-${giteePullRequestIid} &amp;&amp; \</span>
<span class="s1">                         $HOME/bin/helm upgrade --install -f ${giteePullRequestIid}values.yaml -n ci-gitee-${giteePullRequestIid} ci-gitee-${giteePullRequestIid} ./ &amp;&amp; \</span>
<span class="s1">                         rm -rf $JENKINS_AGENT_WORKDIR/helm-chart/CI-gitee-helmv4.0-${giteePullRequestIid}</span>
<span class="s1">                &#39;&#39;&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;publish&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                    set -ux</span>
<span class="s1">                    while true</span>
<span class="s1">                    do</span>
<span class="s1">                        cigiteebe_status=$($HOME/bin/kubectl get pod -n ci-gitee-${giteePullRequestIid} | grep cigiteebe|awk &#39;{print $3}&#39;)</span>
<span class="s1">                        cigiteefe_status=$($HOME/bin/kubectl get pod -n ci-gitee-${giteePullRequestIid} | grep cigiteefe|awk &#39;{print $3}&#39;)</span>
<span class="s1">                        if [[ &quot;Running&quot; == &quot;${cigiteebe_status}&quot; &amp;&amp; &quot;Running&quot; == &quot;${cigiteefe_status}&quot; ]]; then</span>
<span class="s1">                            break</span>
<span class="s1">                        else</span>
<span class="s1">                            echo &quot;Pod starting, plz wait.....&quot;</span>
<span class="s1">                            sleep 5</span>
<span class="s1">                        fi</span>
<span class="s1">                   done</span>
<span class="s1">                &#39;&#39;&#39;</span>
                <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&lt;details&gt;</span>
<span class="s1">    &lt;summary&gt;CI Opened ☟ 点击展开  &lt;/summary&gt;</span>

<span class="s1">👍 CI构建成功，部署完毕    **前端数据正在更新中...**</span>


<span class="s1">➤➤ 服务已启动 访问入口已开启： [点我开始测试](http://&#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">giteePullRequestIid</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;.runjs.cn )</span>

<span class="s1">访问该url前 需要本地 dns 设置为: **192.168.1.60**</span>

<span class="s1">✎ 测试用户：（可联系测试人员获取更多用户）</span>

<span class="s1">| 用户名 | 密码   |</span>
<span class="s1">| ------ | ------ |</span>
<span class="s1">| git    | qwe123 |</span>

<span class="s1">➽ 若有任务需要执行或者查看日志，请仔细阅读[参考文档](https://gitee.com/oschina/CI-gitee-Docs/blob/master/dev-usage.md)</span>

<span class="s1">- CI部署疑问联系人:      ☞ 胡建力 😄</span>
<span class="s1">&lt;/details&gt;</span>
<span class="s1">            &#39;&#39;&#39;</span>
                    <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s2">&quot;Compile assets、webpack&quot;</span><span class="o">){</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">not</span> <span class="o">{</span>
                    <span class="n">anyOf</span> <span class="o">{</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">failFast</span> <span class="kc">true</span>
            <span class="n">parallel</span> <span class="o">{</span>
            <span class="n">stage</span><span class="o">(</span><span class="s2">&quot;Compile assets&quot;</span><span class="o">){</span>
                <span class="n">steps</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                          set -eux</span>
<span class="s1">                          BACKEND_POD_NAME=$($HOME/bin/kubectl get pod -n ci-gitee-${giteePullRequestIid} | grep cigiteebe|awk &#39;{print $1}&#39;)</span>
<span class="s1">                          $HOME/bin/kubectl exec -n ci-gitee-${giteePullRequestIid} $BACKEND_POD_NAME -c cigiteebe -- bash -x /compile.sh</span>
<span class="s1">                          find $JENKINS_AGENT_WORKDIR/global/${giteePullRequestIid}/public/assets/ -name manifest* |xargs ls -t |xargs -n 1|sed 1d|xargs rm -rf</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>

            <span class="n">stage</span><span class="o">(</span><span class="s2">&quot;Compile webpack&quot;</span><span class="o">){</span>
                <span class="n">steps</span> <span class="o">{</span>
                    <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s1">&#39;d3c4027b-8900-4ce1-b3fc-37998ff57abc&#39;</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s1">&#39;Password&#39;</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s1">&#39;Username&#39;</span><span class="o">)])</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                            set -ux</span>
<span class="s1">                            if [[ $(echo $giteePullRequestDescription|grep without_compare|wc -l) -gt 0 ]]; then</span>
<span class="s1">                                echo &quot;skip Compile&quot;</span>
<span class="s1">                            else</span>
<span class="s1">                                cd $JENKINS_AGENT_WORKDIR/dockerfile &amp;&amp; \</span>
<span class="s1">                                sed &quot;s@PRID@${giteePullRequestIid}@g&quot; Dockerfile &gt; Dockerfile-${giteePullRequestIid}</span>
<span class="s1">                                sshpass -p &quot;${Password}&quot; scp $JENKINS_AGENT_WORKDIR/dockerfile/Dockerfile-${giteePullRequestIid} ${Username}@${NFS_SERVER}:/data/nfs/global &amp;&amp; \</span>
<span class="s1">                                rm -rf $JENKINS_AGENT_WORKDIR/dockerfile/Dockerfile-${giteePullRequestIid} &amp;&amp; \</span>
<span class="s1">                                sshpass -p &quot;${Password}&quot; ssh -n ${Username}@${NFS_SERVER} &quot;cd /data/nfs/global &amp;&amp; export DOCKER_HOST=tcp://192.168.1.113:2375 &amp;&amp; docker build --no-cache -f Dockerfile-${giteePullRequestIid} -o /data/nfs/global/${giteePullRequestIid}/public .&quot; &amp;&amp; \</span>
<span class="s1">                                sshpass -p &quot;${Password}&quot; ssh -n ${Username}@${NFS_SERVER} &quot;chown -R 1000:1000 /data/nfs/global/${giteePullRequestIid}/public/webpacks&quot; &amp;&amp; \</span>
<span class="s1">                                sshpass -p &quot;${Password}&quot; ssh -n ${Username}@${NFS_SERVER} &quot;rm -rf /data/nfs/global/Dockerfile-${giteePullRequestIid}&quot; &amp;&amp; \</span>
<span class="s1">                                export DOCKER_HOST=tcp://192.168.1.113:2375 &amp;&amp; $HOME/bin/docker rmi -f ${Harbor_project_name}/backend:${IMAGES_VERSION}-${giteePullRequestIid}</span>
<span class="s1">                            fi</span>
<span class="s1">                            &#39;&#39;&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

           <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;重启、提醒测试&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">when</span> <span class="o">{</span>
                    <span class="n">not</span> <span class="o">{</span>
                        <span class="n">anyOf</span> <span class="o">{</span>
                            <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;closed&#39;</span>
                            <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;giteePullRequestState&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;merged&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">failFast</span> <span class="kc">true</span>
                <span class="n">parallel</span> <span class="o">{</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;重启服务&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                            set -eux</span>
<span class="s1">                            echo &quot;restart the unicorn service...&quot;</span>
<span class="s1">                            BACKEND_POD_NAME=$($HOME/bin/kubectl get pod -n ci-gitee-${giteePullRequestIid} | grep cigiteebe|awk &#39;{print $1}&#39;)</span>
<span class="s1">                            $HOME/bin/kubectl exec -n ci-gitee-${giteePullRequestIid} $BACKEND_POD_NAME -c cigiteebe -- bash -x /restart_unicorn_sidekiq.sh</span>
<span class="s1">                            sleep 30</span>
<span class="s1">                        &#39;&#39;&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>

                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;提醒测试&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">sh</span>  <span class="s2">&quot;cd $JENKINS_AGENT_WORKDIR/scripts &amp;&amp; python pr_check_tips.py ${giteePullRequestIid} ${access_token}&quot;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;api测试&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s1">&#39;d3c4027b-8900-4ce1-b3fc-37998ff57abc&#39;</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s1">&#39;Password&#39;</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s1">&#39;Username&#39;</span><span class="o">)])</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">                    set -ux</span>
<span class="s1">                    sshpass -p &quot;${Password}&quot; ssh -n ${Username}@${NFS_SERVER} &quot;docker exec api-giteev5 python /root/apitest-demo/run_all.py 1 ${giteePullRequestIid}&quot;</span>
<span class="s1">                    mkdir -p ${WORKSPACE}/target</span>
<span class="s1">                    cp -rf $JENKINS_AGENT_WORKDIR/target/allure-results/${giteePullRequestIid} ${WORKSPACE}/target/${giteePullRequestIid}</span>
<span class="s1">                    &#39;&#39;&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>

           <span class="n">post</span> <span class="o">{</span>
                 <span class="n">success</span> <span class="o">{</span>
                     <span class="n">script</span> <span class="o">{</span>
                        <span class="n">allure</span> <span class="nl">includeProperties:</span> <span class="kc">false</span><span class="o">,</span> <span class="nl">jdk:</span> <span class="s1">&#39;&#39;</span><span class="o">,</span> <span class="nl">results:</span> <span class="o">[[</span><span class="nl">path:</span> <span class="s1">&#39;target/${giteePullRequestIid}&#39;</span><span class="o">]]</span>

                        <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ ✅️自动生成最新API接口报告 [API接口测试报告详细](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">BUILD_URL</span> <span class="o">+</span> <span class="s2">&quot;allure/&quot;</span> <span class="o">+</span><span class="s2">&quot;)&quot;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
    <span class="o">}</span>



    <span class="n">post</span> <span class="o">{</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI build failure! [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="n">emailext</span> <span class="o">(</span>
              <span class="nl">subject:</span> <span class="s1">&#39;构建通知：${PROJECT_NAME} - Build # ${BUILD_NUMBER} -${BUILD_STATUS}!&#39;</span><span class="o">,</span>
              <span class="nl">body:</span> <span class="s1">&#39;&#39;&#39;&lt;!DOCTYPE html&gt;</span>
<span class="s1">                    &lt;html&gt;</span>
<span class="s1">                    &lt;head&gt;</span>
<span class="s1">                    &lt;meta charset=&quot;UTF-8&quot;&gt;</span>
<span class="s1">                    &lt;/head&gt;</span>
<span class="s1">                    &lt;body leftmargin=&quot;8&quot; marginwidth=&quot;0&quot; topmargin=&quot;8&quot; marginheight=&quot;4&quot; offset=&quot;0&quot;&gt;</span>
<span class="s1">                        &lt;table width=&quot;95%&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; style=&quot;font-size: 16pt; font-family: Tahoma, Arial, Helvetica, sans-serif&quot;&gt;</span>
<span class="s1">                        &lt;tr&gt;</span>
<span class="s1">                            &lt;td&gt;&lt;font size=&quot;2&quot; color=&quot;red&quot;&gt;(本邮件是程序自动下发的，请勿回复！)&lt;/font&gt;&lt;/td&gt;</span>
<span class="s1">                        &lt;/tr&gt;</span>
<span class="s1">                            &lt;tr&gt;</span>
<span class="s1">                                &lt;td&gt;&lt;br /&gt;</span>
<span class="s1">                                    &lt;b&gt;&lt;font color=&quot;#0B610B&quot;&gt;&lt;font size=&quot;6&quot;&gt;构建信息&lt;/font&gt;&lt;/font&gt;&lt;/b&gt;</span>
<span class="s1">                                    &lt;hr size=&quot;2&quot; width=&quot;100%&quot; align=&quot;center&quot; /&gt;&lt;/td&gt;</span>
<span class="s1">                            &lt;/tr&gt;</span>
<span class="s1">                            &lt;tr&gt;</span>
<span class="s1">                                &lt;td&gt;</span>
<span class="s1">                                    &lt;ul&gt;</span>
<span class="s1">                                    &lt;div style=&quot;font-size:12px&quot;&gt;</span>
<span class="s1">                                        &lt;li&gt;项目名称&amp;nbsp;：&amp;nbsp;${PROJECT_NAME}&lt;/li&gt;</span>
<span class="s1">                                        &lt;li&gt;构建结果&amp;nbsp;：&amp;nbsp;${BUILD_STATUS}&lt;/span&gt;&lt;/li&gt;</span>
<span class="s1">                                        &lt;li&gt;构建编号&amp;nbsp;：&amp;nbsp;第${BUILD_NUMBER}次构建&lt;/li&gt;</span>
<span class="s1">                                        &lt;li&gt;触发原因：&amp;nbsp;${CAUSE}&lt;/li&gt;</span>
<span class="s1">                                        &lt;li&gt;变更概要：${CHANGES}&lt;/li&gt;</span>
<span class="s1">                                        &lt;hr&gt;</span>
<span class="s1">                                        &lt;li&gt;构建地址：&lt;a href=${BUILD_URL}&gt;${BUILD_URL}&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">                                        &lt;li&gt;CI环境访问地址： &lt;a href=http://${giteePullRequestIid}.runjs.cn&gt;http://${giteePullRequestIid}.runjs.cn&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">                                        &lt;li&gt;构建日志：&lt;a href=${BUILD_URL}console&gt;${BUILD_URL}console&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">                                        &lt;hr&gt;</span>
<span class="s1">                                        &lt;li&gt;历史变更记录 : &lt;a href=&quot;${PROJECT_URL}changes&quot;&gt;${PROJECT_URL}changes&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">                                        &lt;li&gt;变更集：${JELLY_SCRIPT}&lt;/li&gt;</span>
<span class="s1">                                        &lt;hr&gt;</span>
<span class="s1">                                        &lt;li&gt;CI jenkins访客 账号|密码： devops-dev|OSChina@2022&lt;/li&gt;</span>
<span class="s1">                                        &lt;hr&gt;</span>
<span class="s1">                                    &lt;/div&gt;</span>
<span class="s1">                                    &lt;/ul&gt;</span>
<span class="s1">                                &lt;/td&gt;</span>
<span class="s1">                            &lt;/tr&gt;</span>
<span class="s1">                        &lt;/table&gt;&lt;/font&gt;</span>
<span class="s1">                    &lt;/body&gt;</span>
<span class="s1">                    &lt;/html&gt;&#39;&#39;&#39;</span><span class="o">,</span>
              <span class="nl">to:</span> <span class="s1">&#39;1879324764@qq.com&#39;</span>
          <span class="o">)</span>
        <span class="o">}</span>

        <span class="n">aborted</span> <span class="o">{</span>
            <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI build aborted! [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="o">}</span>

        <span class="n">success</span> <span class="o">{</span>
            <span class="n">addGiteeMRComment</span> <span class="nl">comment:</span> <span class="s2">&quot;+ CI build success! [BUILD](&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="na">RUN_DISPLAY_URL</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id31">
<h4>4.4.9 pipeline并行和条件判断<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pipeline {
    environment {
        GIT_ADDRESS = &quot;https://gitee.com/oschina/gitee-xxxgit&quot;
        COMMENT_ID = sh(returnStdout: true, script: &#39;echo -n $noteBody |sed -e &quot;s/ci_build//g&quot;&#39;).trim()
        IS_COMMUNITY = sh(returnStdout: true, script: &#39;echo -n $giteeBranch |grep &quot;community&quot; -q &amp;&amp; echo true || echo false&#39;).trim()
        IS_Education = sh(returnStdout: true, script: &#39;echo -n $giteeBranch |grep &quot;feat/edu&quot; -q &amp;&amp; echo true || echo false&#39;).trim()
        GIT_AUTH = &quot;gitee-ci-bot&quot;
        Harbor_address = &quot;hub.gitee.cc&quot;
        Harbor_project_name = &quot;hub.gitee.cc/gitee_ci&quot;
        NFS_SERVER = &quot;192.168.1.60&quot;
        Harbor_auth = &quot;c9ae4329-29f2-433f-a1b6-6dac53e14081&quot;
        ENV_api = &quot;ci-runjs&quot;
        ENV = &quot;ci&quot;
        MAIL_RECEIVER = &quot;&quot;
    }

    options {
      disableResume()
      skipDefaultCheckout()
      quietPeriod(5)
      timestamps()
      buildDiscarder(logRotator(numToKeepStr: &#39;100&#39;))
      timeout(time: 60, unit: &#39;MINUTES&#39;)
    }


    agent {
        kubernetes {
                yaml &#39;&#39;&#39;
    apiVersion: &quot;v1&quot;
    kind: &quot;Pod&quot;
    metadata:
      labels:
        jenkins: &quot;slave&quot;
      name: &quot;jenkins-slave&quot;
    spec:
      containers:
      - env:
        - name: &quot;JENKINS_AGENT_WORKDIR&quot;
          value: &quot;/home/jenkins/agent&quot;
        - name: &quot;JENKINS_URL&quot;
          value: &quot;http://jenkins.ci.svc.cluster.local:8080/jenkins/&quot;
        name: &quot;jnlp&quot;
        image: &quot;hub.gitee.cc/library/jenkins-salve:v5.0.0&quot;
        imagePullPolicy: &quot;Always&quot;
        tty: true

        volumeMounts:
        - mountPath: &quot;/etc/hosts&quot;
          name: &quot;gitee-hosts-cm&quot;
          subPath: hosts
          readOnly: false
        - mountPath: &quot;/home/jenkins/agent/scripts&quot;
          name: &quot;gitee-scripts&quot;
          readOnly: false
        - mountPath: &quot;/home/jenkins/agent/helm-chart&quot;
          name: &quot;gitee-helm&quot;
          readOnly: false
        - mountPath: &quot;/home/jenkins/agent/global&quot;
          name: &quot;global&quot;
        - mountPath: &quot;/home/jenkins/agent/web-dist&quot;
          name: &quot;web-dist&quot;
        - mountPath: &quot;/home/jenkins/agent&quot;
          name: &quot;workspace-volume&quot;
          readOnly: false
      restartPolicy: &quot;OnFailure&quot;
      volumes:
      - name: &quot;gitee-hosts-cm&quot;
        configMap:
          name: gitee-hosts-cm
          defaultMode: 493
      - name: &quot;gitee-scripts&quot;
        nfs:
          path: &quot;/k8ssc/jenkins/scripts&quot;
          readOnly: false
          server: &quot;192.168.1.60&quot;
      - name: &quot;gitee-helm&quot;
        nfs:
          path: &quot;/k8ssc/jenkins/helm-charts&quot;
          readOnly: false
          server: &quot;192.168.1.60&quot;
      - name: &quot;global&quot;
        nfs:
          path: &quot;/global&quot;
          server: &quot;192.168.1.60&quot;
      - name: &quot;web-dist&quot;
        nfs:
          path: /k8ssc/jenkins/ent-gitee/nginx/htmlapi
          server: &quot;192.168.1.60&quot;
      - emptyDir:
          medium: &quot;&quot;
        name: &quot;workspace-volume&quot;
                &#39;&#39;&#39;
            }
        }

    stages {
      stage(&#39;删除遗留评论&#39;) {
          when {
              not {
                  anyOf {
                      environment name: &#39;giteePullRequestState&#39;, value: &#39;closed&#39;
                      environment name: &#39;giteePullRequestState&#39;, value: &#39;merged&#39;
                  }
              }
          }
          steps {
              sh &#39;python $JENKINS_AGENT_WORKDIR/scripts/delete_comment.py ${giteePullRequestIid} ${access_token}&#39;
          }
        }

      stage(&#39;钩子&#39;) {
        when {
            not {
                anyOf {
                    environment name: &#39;giteePullRequestState&#39;, value: &#39;closed&#39;
                    environment name: &#39;giteePullRequestState&#39;, value: &#39;merged&#39;
                }
            }
        }
        failFast true
        parallel {
          stage(&#39;拉取最新PR代码&#39;) {
            options { retry(3) }
              steps {
                checkout([$class: &#39;GitSCM&#39;, branches: [[name: &#39;pull/${giteePullRequestIid}/MERGE&#39;]], extensions: [], userRemoteConfigs: [[credentialsId: &#39;8b3c4868-feea-42cd-aa94-09431a281392&#39;, name: &#39;origin&#39;, refspec: &#39;+refs/pull/*/MERGE:refs/pull/*/MERGE&#39;, url: &quot;${GIT_ADDRESS}&quot;]]])
              }
            }

          stage(&#39;回评构建提醒&#39;) {
              steps {
                  addGiteeMRComment comment: &quot;+ CI triggered, building... [BUILD](&quot; + env.RUN_DISPLAY_URL + &quot;)&quot; +&quot; **查看构建进度 👉**   账号:devops-dev 密码:OSChina@2022&quot;
              }
            }
          }
        }

      stage(&#39;编译&#39;) {
        when {
            not {
                anyOf {
                    environment name: &#39;giteePullRequestState&#39;, value: &#39;closed&#39;
                    environment name: &#39;giteePullRequestState&#39;, value: &#39;merged&#39;
                }
            }
        }
        failFast true
        parallel {
            stage(&#39;社区版镜像&#39;) {
              when { environment name: &#39;IS_COMMUNITY&#39;, value:&#39;true&#39; }
                steps {
                  withCredentials([[$class: &#39;UsernamePasswordMultiBinding&#39;,
                  credentialsId: &quot;${Harbor_auth}&quot;,
                  usernameVariable: &#39;Harbor_user&#39;,
                  passwordVariable: &#39;Harbor_password&#39;]]) {
                    sh &#39;&#39;&#39;#!/bin/bash
                        set -ux
                        echo &quot;编译社区版镜像&quot;
                    &#39;&#39;&#39;
                  }
               }
            }

            stage(&#39;教育版镜像&#39;) {
              when { environment name: &#39;IS_Education&#39;, value:&#39;true&#39; }
                steps {
                  withCredentials([[$class: &#39;UsernamePasswordMultiBinding&#39;,
                  credentialsId: &quot;${Harbor_auth}&quot;,
                  usernameVariable: &#39;Harbor_user&#39;,
                  passwordVariable: &#39;Harbor_password&#39;]]) {
                    sh &#39;&#39;&#39;#!/bin/bash
                       echo &quot;编译教育版本镜像&quot;
                    &#39;&#39;&#39;
                   }
                }
             }

            stage(&#39;企业版镜像&#39;) {
              when {
                 allOf {
                    environment name: &#39;IS_COMMUNITY&#39;, value:&#39;false&#39;
                    environment name: &#39;IS_Education&#39;, value:&#39;false&#39;
                  }
              }
              steps {
                withCredentials([[$class: &#39;UsernamePasswordMultiBinding&#39;,
                credentialsId: &quot;${Harbor_auth}&quot;,
                usernameVariable: &#39;Harbor_user&#39;,
                passwordVariable: &#39;Harbor_password&#39;]]) {
                  sh &#39;&#39;&#39;#!/bin/bash
                       set -ux
                       echo &quot;编译企业版本镜像&quot;

                    &#39;&#39;&#39;
                }
              }
            }
          }
        }

        stage(&#39;部署&#39;) {
            when {
                not {
                    anyOf {
                        environment name: &#39;giteePullRequestState&#39;, value: &#39;closed&#39;
                        environment name: &#39;giteePullRequestState&#39;, value: &#39;merged&#39;
                    }
                }
            }
            failFast true
            parallel {
              stage(&#39;社区版&#39;) {
               when { environment name: &#39;IS_COMMUNITY&#39;, value:&#39;true&#39; }

               stages {
                   stage(&quot;默认后端&quot;) {
                     when { environment name: &#39;COMMENT_ID&#39;, value:&#39;&#39; }
                      steps {
                          sh &#39;&#39;&#39;#!/bin/bash
                                set -ux
                                echo &quot;部署社区nextjs&quot;
                             &#39;&#39;&#39;

                          sh &#39;&#39;&#39;#!/bin/bash
                                set -ux
                                echo &quot;部署社区版nginx-proxy&quot;
                             &#39;&#39;&#39;
                             }
                          }
                   stage(&quot;指定PR后端&quot;) {
                     when { not { environment name: &#39;COMMENT_ID&#39;, value:&#39;&#39; } }
                      steps {
                          sh &#39;&#39;&#39;#!/bin/bash
                                set -ux
                                echo &quot;部署社区nextjs&quot;
                             &#39;&#39;&#39;

                          sh &#39;&#39;&#39;#!/bin/bash
                                set -ux
                                echo &quot;部署社区版nginx-proxy&quot;
                             &#39;&#39;&#39;
                             }
                          }
                      }
                   }

              stage(&#39;教育版&#39;) {
                when { environment name: &#39;IS_Education&#39;, value:&#39;true&#39; }
                steps {
                    sh &#39;&#39;&#39;#!/bin/bash
                          set -ux
                          echo &quot;部署教育版&quot;
                       &#39;&#39;&#39;
                       }
                    }

              stage(&#39;企业版&#39;) {
                  when {
                       allOf {
                        environment name: &#39;IS_COMMUNITY&#39;, value:&#39;false&#39;
                        environment name: &#39;IS_Education&#39;, value:&#39;false&#39;
                     }
                  }
                stages {
                    stage(&quot;默认后端&quot;) {
                      when { environment name: &#39;COMMENT_ID&#39;, value:&#39;&#39; }
                      steps {
                        sh &#39;&#39;&#39;#!/bin/bash
                              set -ux
                              echo &quot;部署企业版-默认后端&quot;
                           &#39;&#39;&#39;
                           }
                    }
                    stage(&quot;指定PR后端&quot;) {
                      when { not { environment name: &#39;COMMENT_ID&#39;, value:&#39;&#39; } }
                      steps {
                        sh &#39;&#39;&#39;#!/bin/bash
                              set -ux
                              echo &quot;部署企业版-指定PR后端&quot;
                           &#39;&#39;&#39;
                           }
                        }
                      }
                   }
                }
            }

     stage(&#39;发布&#39;) {
       when {
           not {
               anyOf {
                 environment name: &#39;giteePullRequestState&#39;, value: &#39;closed&#39;
                 environment name: &#39;giteePullRequestState&#39;, value: &#39;merged&#39;
               }
           }
       }
      failFast true
      parallel {
      stage(&#39;社区版&#39;) {
         when { environment name: &#39;IS_COMMUNITY&#39;, value:&#39;true&#39; }
         steps {
            sh &#39;&#39;&#39;#!/bin/bash
                set -ux
                echo &quot;发布社区版&quot;
                &#39;&#39;&#39;
                 addGiteeMRComment comment: &#39;&#39;&#39;
 &lt;details&gt;
    &lt;summary&gt;✅️部署已完成 CI Opened，&lt;a href=&quot;https://&#39;&#39;&#39; + env.giteePullRequestIid + &#39;&#39;&#39;-com.runjs.cn&quot;&gt;开始测试&lt;/a&gt;&lt;/summary&gt;

 访问该 url 前 需要本地 dns 设置为 `192.168.1.60`

✎ 测试用户：（可联系测试人员获取更多用户）
.....

 若有任务需要执行或者查看docker容器日志,访问kubernetes容器管理界面，[点击访问](https://kube-dashboard.gitee.cc)

 &lt;/details&gt;
 &#39;&#39;&#39;
          }
      }

      stage(&#39;教育版&#39;) {
        when { environment name: &#39;IS_Education&#39;, value:&#39;true&#39; }
          steps {
              sh &#39;&#39;&#39;#!/bin/bash
                  set -ux
                  echo &quot;发布教育版&quot;
            }
          }
      stage(&#39;企业版&#39;) {
         when {
            allOf {
              environment name: &#39;IS_COMMUNITY&#39;, value:&#39;false&#39;
              environment name: &#39;IS_Education&#39;, value:&#39;false&#39;
             }
          }
         stages {
             stage(&quot;默认后端&quot;) {
                when { environment name: &#39;COMMENT_ID&#39;, value:&#39;&#39; }
                steps {
                 sh &#39;&#39;&#39;#!/bin/bash
                       set -ux
                       echo &quot;发布企业版&quot;
                  }
                }
             stage(&quot;指定PR后端&quot;) {
                when { not { environment name: &#39;COMMENT_ID&#39;, value:&#39;&#39; } }
                steps {
                 sh &#39;&#39;&#39;#!/bin/bash
                       set -ux
                       echo &quot;发布企业版&quot;
                  }
                }
              }
           }
         }
      }

    stage(&#39;提醒测试&#39;) {
        steps {
            sh &#39;python $JENKINS_AGENT_WORKDIR/scripts/test_reminder.py ${giteePullRequestIid} ${access_token}&#39;
          }
        }
    }


    post {
        failure { addGiteeMRComment comment: &quot;+ CI build failure! [BUILD](&quot; + env.RUN_DISPLAY_URL + &quot;)&quot; + &quot; 👉   账号:devops-dev 密码:OSChina@2022&quot; }
        aborted { addGiteeMRComment comment: &quot;+ CI build aborted! [BUILD](&quot; + env.RUN_DISPLAY_URL + &quot;)&quot; + &quot; 👉   账号:devops-dev 密码:OSChina@2022&quot; }
        success { addGiteeMRComment comment: &quot;+ CI build success! [BUILD](&quot; + env.RUN_DISPLAY_URL + &quot;)&quot; + &quot; 👉   账号:devops-dev 密码:OSChina@2022&quot; }
    }
}
</pre></div>
</div>
<p>部署效果如下：</p>
<p><img alt="image13" src="../_images/image-20220520181833236.png" /></p>
</section>
</section>
</section>
<section id="id32">
<h2><a class="toc-backref" href="#id128">5.构建工具</a><a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h2>
<section id="tools">
<h3><a class="toc-backref" href="#id129">5.1 tools指令介绍</a><a class="headerlink" href="#tools" title="Permalink to this headline">¶</a></h3>
<p>tools指令能帮助我们自动下载并安装所指定的构建工具，并将其加入PATH变量中。这样，我们就可以在sh步骤里直接使用了。但在agent
none的情况下不会生效。</p>
<p>tools指令默认支持3种工具：JDK、Maven、Gradle。通过安装插件，tools指令还可以支持更多的工具。接下来，我们介绍几种常用的构建环境的搭建。</p>
<section id="jdk">
<h4>JDK环境搭建<a class="headerlink" href="#jdk" title="Permalink to this headline">¶</a></h4>
<p><strong>自动安装JDK</strong></p>
<p>设置自动安装Oracle JDK时有一些特殊，因为下载Oracle
JDK时需要输入用户名和密码。</p>
<p><img alt="image14" src="../_images/jenkins_test010.png" /></p>
<p><img alt="image15" src="../_images/jenkins_test011.png" /></p>
<p>进入Manage Jenkins→Global Tool Configuration→JDK页，单击“Add
JDK”按钮，就可以设置自动安装JDK。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>

    <span class="n">tools</span> <span class="p">{</span>
        <span class="n">jdk</span> <span class="s1">&#39;jdk-8u172&#39;</span>
    <span class="p">}</span>

    <span class="n">stages</span><span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Build&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">sh</span> <span class="s2">&quot;printenv&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id33">
<h4>Maven<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h4>
<p><strong>使用Maven进行构建</strong></p>
<p>Jenkins pipeline的tools指令默认就支持Maven。所以，使用Maven只需要两步。</p>
<p>（1）进入Manage Jenkins→Global Tool Configuration→Maven页设置</p>
<p><img alt="image16" src="../_images/jenkins_test012.png" /></p>
<p>这样，当执行到tools指令时，Jenkins会自动下载并安装Maven。将mvn命令加入环境变量中，可以使我们在pipeline中直接执行mvn命令。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>

    <span class="n">tools</span> <span class="p">{</span>
        <span class="n">maven</span> <span class="s1">&#39;mvn-3.5.4&#39;</span>
    <span class="p">}</span>

    <span class="n">stages</span><span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Build&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="o">//</span><span class="n">sh</span> <span class="s2">&quot;mvn clean package spring-boot:repackage&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;mvn clean test install&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;printenv&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


<span class="p">}</span>
</pre></div>
</div>
<p><strong>使用Managed files设置Maven</strong></p>
<p>Maven默认使用的是其官方仓库，国内下载速度很慢。所以，我们通常会使用国内的Maven镜像仓库。</p>
<p>Config File
Provider插件（<a class="reference external" href="https://plugins.jenkins.io/config-file-provider">https://plugins.jenkins.io/config-file-provider</a>）能很好地解决这个问题。只需要在Jenkins的界面上填入settings.xml的内容，然后在pipeline中指定settings.xml就可以了。</p>
<p><img alt="image17" src="../_images/managed_files001.png" /></p>
<p>具体实现方法如下：</p>
<p>（1）安装Config File Provider插件。</p>
<p>（2）进入Manage Jenkins页面，就可以看到多出一个“Managed
files”菜单,在左侧菜单栏中选择“Add a new
Config”，就会看到该插件支持很多种配置文件的格式及方式。</p>
<p>（4）选择“Global Maven
settings.xml”选项。因为我们的设置是全局的。填写“ID”字段，Jenkins
pipeline会引用此变量名。假如使用的ID为<code class="docutils literal notranslate"><span class="pre">maven-global-settings</span></code>。</p>
<p><img alt="image18" src="../_images/manage_file002.png" /></p>
<p><img alt="image19" src="../_images/manage_file003.png" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>

    <span class="n">tools</span> <span class="p">{</span>
        <span class="n">maven</span> <span class="s1">&#39;mvn-3.5.4&#39;</span>
    <span class="p">}</span>

    <span class="n">stages</span><span class="p">{</span>

    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;mvn build&#39;</span><span class="p">){</span>
        <span class="n">steps</span><span class="p">{</span>
            <span class="o">//</span><span class="n">sh</span> <span class="s2">&quot;JAVA_HOME=$</span><span class="si">{javaHome}</span><span class="s2"> mvn clean package&quot;</span>
            <span class="n">configFileProvider</span><span class="p">([</span><span class="n">configFile</span><span class="p">(</span><span class="n">fileId</span><span class="p">:</span> <span class="s1">&#39;maven-global-settings&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="s1">&#39;MAVEN_SETTINGS&#39;</span><span class="p">)])</span> <span class="p">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;mvn -s $MAVEN_SETTINGS clean package&#39;</span>
                <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;mvn test&#39;</span><span class="p">){</span>
        <span class="n">steps</span><span class="p">{</span>
            <span class="n">sh</span> <span class="s2">&quot;echo test&quot;</span>
        <span class="p">}</span>

    <span class="p">}</span>
    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;mvn app deploy.&#39;</span><span class="p">){</span>
        <span class="n">steps</span><span class="p">{</span>
            <span class="n">sh</span> <span class="s2">&quot;echo deploy....&quot;</span>
        <span class="p">}</span>

    <span class="p">}</span>

   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="go">
<h4>Go语言环境搭建<a class="headerlink" href="#go" title="Permalink to this headline">¶</a></h4>
<p>Jenkins支持Golang的构建，只需要以下几步。</p>
<p>（1）安装Go插件（<a class="reference external" href="https://plugins.jenkins.io/golang">https://plugins.jenkins.io/golang</a>）。</p>
<p>（2）进入Manage Jenkins→Global Tool Configuration→Go页，设置如下图所示。</p>
<p>（3）在pipeline中加入tools部分。</p>
<p>在环境变量中会增加一个GOROOT变量。</p>
<p><img alt="image20" src="../_images/go_tools0001.png" /></p>
<p>（4）设置GOPATH。了解Go语言开发的读者都会知道，编译时需要设置GOPATH环境变量。直接在environment指令中添加就可以了。</p>
<p>完整代码如下：</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">GOPATH</span> <span class="o">=</span> <span class="s2">&quot;${env.WORKSPACE}/&quot;</span>
    <span class="o">}</span>
    <span class="n">tools</span> <span class="o">{</span>
        <span class="n">go</span> <span class="s1">&#39;go1.15.5&#39;</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;go build&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="python">
<h4>Python环境搭建<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h4>
<p>Python环境很容易产生Python版本冲突、第三方库冲突等问题。所以，Python开发通常会进行工程级别的环境隔离，也就是每个Python工程使用一个Python环境。</p>
<p>在Jenkins环境下，我们使用Pyenv
Pipeline插件（<a class="reference external" href="https://plugins.jenkins.io/pyenv-pipeline">https://plugins.jenkins.io/pyenv-pipeline</a>）可以轻松地实现。</p>
<p>首先，准备Python基础环境。</p>
<p>（1）在Jenkins机器上安装python、pip、virtualenv。</p>
<ul class="simple">
<li><p>pip：Python的包管理工具。</p></li>
<li><p>virtualenv：Python中的虚拟环境管理工具。</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ yum -y install python-pip
$ yum install python-virtualenv
$ wget https://files.pythonhosted.org/packages/33/bc/fa0b5347139cd9564f0d44ebd2b147ac97c36b2403943dbee8a25fd74012/virtualenv-16.0.0.tar.gz
$ sudo tar zxvf virtualenv-16.0.0.tar.gz
$ <span class="nb">cd</span> virtualenv-16.0.0
$ python setup.py install
</pre></div>
</div>
<p>（2）安装Pyenv Pipeline插件和ShiningPanda插件。</p>
<p><img alt="image21" src="../_images/python_tools001.png" /></p>
<p><strong>配置python路径</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">Manage</span> <span class="pre">Jenkins</span> <span class="pre">&gt;</span> <span class="pre">Global</span> <span class="pre">Tool</span> <span class="pre">Configuration</span></code>
填写python2或者python3在jenkins机器上的路径，一般都为：/usr/bin/python3.6，也可以使用<code class="docutils literal notranslate"><span class="pre">which</span> <span class="pre">python</span></code>来找；
名称随便写即可，后续会用到。</p>
<p><img alt="image22" src="../_images/python_tools002.png" /></p>
<p>然后，在pipeline中使用Pyenv Pipeline插件提供的withPythonEnv方法。</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">environment</span><span class="o">{</span>
        <span class="n">V</span> <span class="o">=</span> <span class="s2">&quot;version&quot;</span>
    <span class="o">}</span>

    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s2">&quot;build&quot;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
            <span class="n">withPythonEnv</span><span class="o">(</span><span class="s1">&#39;/usr/bin/python&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;python --${V}&#39;</span>
            <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>withPythonEnv方法会根据第一个参数——可执行python路径——在当前工作空间下创建一个virtualenv环境。</p>
<p>withPythonEnv方法的第二个参数是一个闭包。闭包内的代码就执行在新建的virtualenv环境下。</p>
</section>
</section>
<section id="id34">
<h3><a class="toc-backref" href="#id130">5.2 利用环境变量支持更多的构建工具</a><a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h3>
<p>不是所有的构建工具都需要安装相应的Jenkins插件才可以使用。
平时，开发人员在搭建开发环境时做的就是：首先在机器上安装好构建工具，然后将这个构建工具所在目录加入PATH环境变量中。
如果想让Jenkins支持更多的构建工具，也是同样的做法：在Jenkins
agent上安装构建工具，并记录下它的可执行命令的目录，然后在需要使用此命令的Jenkins
pipeline的PATH环境变量中加入该可执行命令的目录。示例如下：</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">none</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;/usr/local/customtool/bin:$PATH&quot;</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;customtool build&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>或者</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">none</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">CUSTOM_TOOL_HOME</span> <span class="o">=</span> <span class="s2">&quot;/usr/local/customtool/bin&quot;</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;${ CUSTOM_TOOL_HOME}/customtool build&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id35">
<h3><a class="toc-backref" href="#id131">5.3 利用tools作用域实现多版本编译</a><a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h3>
<p>tools指令除了支持pipeline作用域，还支持stage作用域。所以，我们可以在同一个pipeline中实现多版本编译。代码如下：</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>

    <span class="n">stages</span><span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s2">&quot;build JDK-10.0.2&quot;</span><span class="o">){</span>
            <span class="n">tools</span> <span class="o">{</span> <span class="n">jdk</span> <span class="s2">&quot;jdk-10.0.2&quot;</span> <span class="o">}</span>
            <span class="n">steps</span><span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;printenv&quot;</span>
            <span class="o">}</span>

        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s2">&quot;build JDK-10.1.0&quot;</span><span class="o">){</span>
            <span class="n">tools</span> <span class="o">{</span> <span class="n">jdk</span> <span class="s2">&quot;jdk-10.1.0&quot;</span> <span class="o">}</span>
            <span class="n">steps</span><span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;printenv&quot;</span>
            <span class="o">}</span>

        <span class="o">}</span>

    <span class="o">}</span>

    <span class="n">post</span><span class="o">{</span>
        <span class="n">changed</span><span class="o">{</span>
            <span class="n">echo</span> <span class="s2">&quot;pipeline post change&quot;</span>
            <span class="o">}</span>
        <span class="n">always</span><span class="o">{</span>
            <span class="n">echo</span> <span class="s2">&quot;pipeline post always&quot;</span>
        <span class="o">}</span>
        <span class="n">success</span><span class="o">{</span>
            <span class="n">echo</span> <span class="s2">&quot;pipeline post success&quot;</span>
        <span class="o">}</span>
        <span class="c1">// 省略其他条件</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p><strong>小结</strong></p>
<p>参考文献：</p>
<p><a class="reference external" href="https://blog.51cto.com/ygqygq2/2446717">https://blog.51cto.com/ygqygq2/2446717</a></p>
</section>
</section>
<section id="id36">
<h2><a class="toc-backref" href="#id132">6.触发Pipeline执行</a><a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h2>
<section id="id37">
<h3><a class="toc-backref" href="#id133">6.1 时间触发</a><a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h3>
<p>时间触发是指定义一个时间，时间到了就触发pipeline执行。在Jenkins
pipeline中使用trigger指令来定义时间触发。</p>
<p>trigger指令只能被定义在pipeline块下，Jenkins内置支持cron、pollSCM，upstream三种方式。其他方式可以通过插件来实现。</p>
<section id="cron">
<h4>6.1.1 定时执行：cron<a class="headerlink" href="#cron" title="Permalink to this headline">¶</a></h4>
<p>定时执行就像cronjob，一到时间点就执行。它的使用场景通常是执行一些周期性的job，如每夜构建。</p>
<p>必须手动执行一次，手动执行一次后，配置文件生效如下：</p>
<p><img alt="image23" src="../_images/jenkins_cicd_corn001.png" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">triggers</span> <span class="p">{</span>
        <span class="n">cron</span><span class="p">(</span><span class="s1">&#39;17 16 * * *&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Nightly build&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;这是一个耗时的构建，每天16:17执行&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;sleep 20&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
     <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><img alt="image24" src="../_images/pipeline_cron0001.png" /></p>
<p>Jenkins trigger cron语法采用的是UNIX
cron语法（有些细微的区别）。一条cron包含5个字段，使用空格或Tab分隔，</p>
<p>格式为：<code class="docutils literal notranslate"><span class="pre">MINUTE</span> <span class="pre">HOUR</span> <span class="pre">DOM</span> <span class="pre">MONTH</span> <span class="pre">DOW</span></code>。每个字段的含义为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• MINUTE：一小时内的分钟，取值范围为0∼59。

• HOUR：一天内的小时，取值范围为0∼23。

• DOM：一个月的某一天，取值范围为1∼31。

• MONTH：月份，取值范围为1∼12。

• DOW：星期几，取值范围为0∼7。0和7代表星期天。

还可以使用以下特殊字符，一次性指定多个值。

•*：匹配所有的值

• M-N ：匹配M 到N 之间的值。

• M-N /X or*/X ：指定在M 到N 范围内，以X 值为步长。

• A，B，· · ·，Z：使用逗号枚举多个值。
</pre></div>
</div>
<p>在一些大型组织中，会同时存在大量的同一时刻执行的定时任务，比如N
个半夜零点（<code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">0</span> <span class="pre">*</span> <span class="pre">*</span> <span class="pre">*</span></code>）执行的任务。这样会产生负载不均衡。在Jenkins
trigger
cron语法中使用“H”字符来解决这一问题，H代表hash。对于没必要准确到零点0分执行的任务，cron可以这样写：<code class="docutils literal notranslate"><span class="pre">H</span> <span class="pre">0</span> <span class="pre">*</span> <span class="pre">*</span> <span class="pre">*</span></code>，代表在零点0分至，H代表hash。代表在零点0分至零点59分之间任何一个时间点执行。</p>
<p>需要注意的是，H应用在DOM（一个月的某一天）字段时会有不准确的情况，因为10月有31天，而2月却是28天。</p>
<p>Jenkins trigger
cron还设计了一些人性化的别名：<code class="docutils literal notranslate"><span class="pre">&#64;yearly</span></code>、<code class="docutils literal notranslate"><span class="pre">&#64;annually</span></code>、<code class="docutils literal notranslate"><span class="pre">&#64;monthly</span></code>、<code class="docutils literal notranslate"><span class="pre">&#64;weekly</span></code>、<code class="docutils literal notranslate"><span class="pre">&#64;daily</span></code>、<code class="docutils literal notranslate"><span class="pre">&#64;midnight</span></code>和<code class="docutils literal notranslate"><span class="pre">&#64;hourly</span></code>。例如，<code class="docutils literal notranslate"><span class="pre">&#64;hourly</span></code>与<code class="docutils literal notranslate"><span class="pre">H</span> <span class="pre">*</span> <span class="pre">*</span> <span class="pre">*</span> <span class="pre">*</span></code>相同，代表一小时内的任何时间；<code class="docutils literal notranslate"><span class="pre">&#64;midnight</span></code>实际上代表在半夜12：00到凌晨2：59之间的某个时间。其他别名很少有应用场景。</p>
<p>一个时间触发的例子</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>

    <span class="n">options</span> <span class="o">{</span>
        <span class="n">disableConcurrentBuilds</span><span class="o">()</span>
        <span class="n">buildDiscarder</span><span class="o">(</span><span class="n">logRotator</span><span class="o">(</span><span class="nl">numToKeepStr:</span> <span class="s1">&#39;10&#39;</span><span class="o">))</span>
    <span class="o">}</span>

    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">createPipelineTriggers</span><span class="o">()</span>
                <span class="n">mvn</span> <span class="s1">&#39;clean install -DskipTests&#39;</span>
                <span class="n">archiveArtifacts</span> <span class="s1">&#39;**/target/*.*ar&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Tests&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">parallel</span> <span class="o">{</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Unit Test&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">mvn</span> <span class="s1">&#39;test&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Integration Test&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">when</span> <span class="o">{</span> <span class="n">expression</span> <span class="o">{</span> <span class="n">isTimeTriggeredBuild</span><span class="o">()</span> <span class="o">}</span> <span class="o">}</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">mvn</span> <span class="s1">&#39;verify -DskipUnitTests -Parq-wildfly-swarm &#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">post</span> <span class="o">{</span>
        <span class="n">always</span> <span class="o">{</span>
            <span class="c1">// Archive Unit and integration test results, if any</span>
            <span class="n">junit</span> <span class="nl">allowEmptyResults:</span> <span class="kc">true</span><span class="o">,</span>
                    <span class="nl">testResults:</span> <span class="s1">&#39;**/target/surefire-reports/TEST-*.xml, **/target/failsafe-reports/*.xml&#39;</span>
            <span class="n">mailIfStatusChanged</span> <span class="n">env</span><span class="o">.</span><span class="na">EMAIL_RECIPIENTS</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="cm">/**</span>
<span class="cm"> * @return {@code true} if the build was time triggered, otherwise {@code false}</span>
<span class="cm"> * @since workflow-support plugin 2.22</span>
<span class="cm"> */</span>
<span class="kt">boolean</span> <span class="nf">isTimeTriggeredBuild</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">currentBuildCause</span> <span class="o">:</span> <span class="n">currentBuild</span><span class="o">.</span><span class="na">getBuildCauses</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currentBuildCause</span><span class="o">.</span><span class="na">_class</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s1">&#39;TimerTriggerCause&#39;</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span>
<span class="o">}</span>


<span class="kt">void</span> <span class="nf">createPipelineTriggers</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">script</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">triggers</span> <span class="o">=</span> <span class="o">[]</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">BRANCH_NAME</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Run a nightly only for master</span>
            <span class="n">triggers</span> <span class="o">=</span> <span class="o">[</span><span class="n">cron</span><span class="o">(</span><span class="s1">&#39;H H(0-3) * * 1-5&#39;</span><span class="o">)]</span>
        <span class="o">}</span>
        <span class="n">properties</span><span class="o">([</span>
                <span class="n">pipelineTriggers</span><span class="o">(</span><span class="n">triggers</span><span class="o">)</span>
        <span class="o">])</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">mailIfStatusChanged</span><span class="o">(</span><span class="n">String</span> <span class="n">recipients</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Also send &quot;back to normal&quot; emails. Mailer seems to check build result, but SUCCESS is not set at this point.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">currentBuild</span><span class="o">.</span><span class="na">currentResult</span> <span class="o">==</span> <span class="s1">&#39;SUCCESS&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">currentBuild</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="s1">&#39;SUCCESS&#39;</span>
    <span class="o">}</span>
    <span class="n">step</span><span class="o">([</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;Mailer&#39;</span><span class="o">,</span> <span class="nl">recipients:</span> <span class="n">recipients</span><span class="o">])</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">mvn</span><span class="o">(</span><span class="kt">def</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">mvnHome</span> <span class="o">=</span> <span class="n">tool</span> <span class="s1">&#39;M3&#39;</span>
    <span class="kt">def</span> <span class="n">javaHome</span> <span class="o">=</span> <span class="n">tool</span> <span class="s1">&#39;JDK8&#39;</span>

    <span class="c1">// Apache Maven related side notes:</span>
    <span class="c1">// --batch-mode : recommended in CI to inform maven to not run in interactive mode (less logs)</span>
    <span class="c1">// -V : strongly recommended in CI, will display the JDK and Maven versions in use.</span>
    <span class="c1">//      Very useful to be quickly sure the selected versions were the ones you think.</span>
    <span class="c1">// -U : force maven to update snapshots each time (default : once an hour, makes no sense in CI).</span>
    <span class="c1">// -Dsurefire.useFile=false : useful in CI. Displays test errors in the logs directly (instead of</span>
    <span class="c1">//                            having to crawl the workspace files to see the cause).</span>

    <span class="c1">// Advice: don&#39;t define M2_HOME in general. Maven will autodetect its root fine.</span>
    <span class="c1">// See also</span>
    <span class="c1">// https://github.com/jenkinsci/pipeline-examples/blob/master/pipeline-examples/maven-and-jdk-specific-version/mavenAndJdkSpecificVersion.groovy</span>
    <span class="n">withEnv</span><span class="o">([</span><span class="s2">&quot;JAVA_HOME=${javaHome}&quot;</span><span class="o">,</span> <span class="s2">&quot;PATH+MAVEN=${mvnHome}/bin:${env.JAVA_HOME}/bin&quot;</span><span class="o">])</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s2">&quot;${mvnHome}/bin/mvn ${args} --batch-mode -V -U -e -Dsurefire.useFile=false&quot;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="pollscm">
<h4>6.1.2 轮询代码仓库：pollSCM<a class="headerlink" href="#pollscm" title="Permalink to this headline">¶</a></h4>
<p>轮询代码仓库是指定期到代码仓库询问代码是否有变化，如果有变化就执行。</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">triggers</span> <span class="o">{</span>
        <span class="c1">//每分钟判断代码是否有变化</span>
        <span class="n">cron</span><span class="o">(</span><span class="s1">&#39;H/1 * * * *&#39;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Example&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s1">&#39;Hello World&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>事实上，如果代码有变化，最好的方式是代码仓库主动通知Jenkins，而不是Jenkins频繁去代码仓库检查。那这种方式存在的意义是什么？
在一些特殊情况下，比如<strong>外网的代码仓库无法调用内网的Jenkins</strong>，或者反过来，则会采用这种方式。</p>
<p><strong>常用类型：</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1、每天凌晨1点构建一次：H 1 * * *


2、每天1点，7点，13点，19点构建：H 1,7,13,19 * * *

　　1,7,13,19表示时间，属于时间设置语法中的第二位，多个时间段用逗号分隔。


3、每15分钟构建一次：H/15 * * * *
</pre></div>
</div>
<p>写代码进行提交。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git add .
$ git commit -m &quot;second ...&quot;
$ git push origin master
</pre></div>
</div>
</section>
</section>
<section id="id38">
<h3><a class="toc-backref" href="#id134">6.2 事件触发</a><a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h3>
<p>事件触发就是发生了某个事件就触发pipeline执行。这个事件可以是你能想到的任何事件。比如手动在界面上触发、其他Job主动触发、HTTP
API Webhook触发等。</p>
<section id="upstream">
<h4>6.2.1 由上游任务触发：upstream<a class="headerlink" href="#upstream" title="Permalink to this headline">¶</a></h4>
<p>当B任务的执行依赖A任务的执行结果时，A就被称为B的上游任务。在Jenkins
2.22及以上版本中，trigger指令开始支持upstream类型的触发条件。upstream的作用就是能让B
pipeline自行决定依赖哪些上游任务。示例如下：</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">triggers</span> <span class="o">{</span>
        <span class="c1">// 如果pipeline-pollSC job执行成功了，就触发此job自动执行</span>
        <span class="n">upstream</span><span class="o">(</span><span class="nl">upstreamProjects:</span><span class="s2">&quot;pipeline-pollSCM&quot;</span><span class="o">,</span><span class="nl">threshold:</span><span class="n">hudson</span><span class="o">.</span><span class="na">model</span><span class="o">.</span><span class="na">Result</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">stages</span><span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s2">&quot;build froend...&quot;</span><span class="o">){</span>
            <span class="n">steps</span><span class="o">{</span>
                <span class="n">echo</span> <span class="s2">&quot;build stage&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;sleep 40&quot;</span>
            <span class="o">}</span>

        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">post</span> <span class="o">{</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s2">&quot;build&quot;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s2">&quot;failed&quot;</span>
        <span class="o">}</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s2">&quot;build&quot;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s2">&quot;success&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">options</span> <span class="o">{</span>
        <span class="n">gitLabConnection</span><span class="o">(</span><span class="s2">&quot;gitlab&quot;</span><span class="o">)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>当upstreamProjects参数接收多个任务时，使用，分隔。threshold参数是指上游任务的执行结果是什么值时触发。hudson.model.Result是一个枚举，包括以下值：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• ABORTED：任务被手动中止。

• FAILURE：构建失败。

• SUCCESS：构建成功。

• UNSTABLE：存在一些错误，但不至于构建失败。

• NOT_BUILT：在多阶段构建时，前面阶段的问题导致后面阶段无法执行。
</pre></div>
</div>
<p>注意：需要手动触发一次任务，让Jenkins加载pipeline后，trigger指令才会生效。</p>
</section>
</section>
<section id="gitlab">
<h3><a class="toc-backref" href="#id135">6.3 GitLab通知触发</a><a class="headerlink" href="#gitlab" title="Permalink to this headline">¶</a></h3>
<p>GitLab通知触发是指当GitLab发现源代码有变化时，触发Jenkins执行构建,使用webhook的方式。</p>
<p>gitlab触发Jenkins的构建需要依赖<code class="docutils literal notranslate"><span class="pre">Gitlab插件</span></code>，而并不需要插件当中列出来的所谓的gitlab
hook。如果直接在Jenkins当中安装插件失败，可以在国内镜像站下载对应插件，然后手动上传安装。</p>
<p>地址：<a class="reference external" href="http://www.eryajf.net/go?url=https://mirrors.tuna.tsinghua.edu.cn/jenkins/plugins/">清华大学开源软件镜像站。</a></p>
<p>创建pipeline项目，配置构建触发器,
首先需要在Jenkins界面上手动勾选“Buildwhen a change is pushed to
GitLab”复选框，还需要手动单击“Generate”按钮生成Secret
token或手动输入Secret token。</p>
<p><img alt="image25" src="../_images/webhook_gitlab001.png" /></p>
<p><img alt="image26" src="../_images/webhook_gitlab002.png" /></p>
<p>在Integrations配置页的相应输入框中粘贴上一步中Jenkins暴露的webhook及相应的Secret
token如下</p>
<p><img alt="image27" src="../_images/gitlab_webhook003.png" /></p>
<p>测试整个链路是否通了。在GitLab上添加好这个webhook后，可以跳到表单下方，有一个已添加的webhook列表，找到我们刚刚创建的webbook。单击“Test”按钮，选择“Pushevents”，GitLab就会向该webhook发送一个event。</p>
<p><img alt="image28" src="../_images/webhook_test0001.png" /></p>
<p>如果是首次添加，现在新版本的Gitlab可能会失败，报错
<code class="docutils literal notranslate"><span class="pre">Urlis</span> <span class="pre">blocked:</span> <span class="pre">Requests</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">local</span> <span class="pre">network</span> <span class="pre">are</span> <span class="pre">not</span> <span class="pre">allowed</span></code>，需要选中如下：</p>
<p><img alt="image29" src="../_images/jenkins_webhook2021001.png" /></p>
<p>添加之后，可以点击一下test看看流程是否能够走通，如果走通，那么我们以后开发的时候直接推送代码即可触发构建。</p>
<p>正常状态返回如下：</p>
<p><code class="docutils literal notranslate"><span class="pre">Hook</span> <span class="pre">executed</span> <span class="pre">successfully:</span> <span class="pre">HTTP</span> <span class="pre">200</span></code></p>
<p>Jenkins任务被GitLab事件触发，在gitlab中提交代码，每次提交，jenkins会进行自动的构建，如下图所示：</p>
<p><img alt="image30" src="../_images/webhook_gitlan0003.png" /></p>
<p>可参考如下文献</p>
<p><a class="reference external" href="http://www.eryajf.net/3304.html">Jenkins-pipeline学习笔记–自动构建的原始配置以及pipeline中的用法</a></p>
<p><a class="reference external" href="https://www.cnblogs.com/xiao987334176/p/11443002.html">Jenkins+Gitlab配置Webhook实现提交自动部署</a></p>
<p><a class="reference external" href="https://www.cnblogs.com/mingerlcm/p/12702528.html">Jenkins配置Gitlab自动触发构建</a></p>
<p><a class="reference external" href="https://www.cnblogs.com/yinzhengjie/p/9613270.html">配置GitLab Push
自动触发Jenkins构建</a></p>
<section id="jenkins-gitee-webhook">
<h4>6.3.1 Jenkins + gitee +webhook<a class="headerlink" href="#jenkins-gitee-webhook" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://my.oschina.net/attacker/blog/4456540">https://my.oschina.net/attacker/blog/4456540</a></p>
</section>
</section>
<section id="pipelinegitlab-trigger">
<h3><a class="toc-backref" href="#id136">6.4 在pipeline中实现GitLab trigger</a><a class="headerlink" href="#pipelinegitlab-trigger" title="Permalink to this headline">¶</a></h3>
<p>对于以上步骤，需要手动做的还不少。首先需要在Jenkins界面上手动勾选“Buildwhen
a change is pushed to
GitLab”复选框，还需要手动单击“Generate”按钮生成Secret
token或手动输入Secret
token。这部分手动操作，我们也希望通过修改Jenkinsfile就能实现。显然，不只是我们这样想，早就有人想到了，并在GitLab插件上实现了基于GitLab的trigger。以下是具体使用方法。</p>
<p><img alt="image31" src="../_images/jenkins_secretToken.png" /></p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">triggers</span> <span class="o">{</span>
        <span class="n">gitlab</span><span class="o">(</span><span class="nl">triggerOnPush:</span> <span class="kc">true</span><span class="o">,</span>
               <span class="nl">triggerOnMergeRequest:</span> <span class="kc">true</span><span class="o">,</span>
               <span class="nl">branchFilterType:</span> <span class="s1">&#39;All&#39;</span><span class="o">,</span>
               <span class="nl">secretToken:</span> <span class="s2">&quot;${env.secretHuToken}&quot;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s2">&quot;Hello wolrd1 \n Hello word2&quot;</span>
                <span class="n">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>secretToken使用随机字符串生成器生成即可。如果Jenkins在内网使用，并且安全性有一定的保障，我们可以将secretToken定义为一个Jenkins全局变量，供所有的项目使用。这样做就不用为每个项目重新生成token了。
GitLab trigger方法有很多参数可配置，下面简单介绍一些常用的参数。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">triggerOnPush</span></code>：当GitLab触发push事件时，是否执行构建。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">triggerOnMergeRequest</span></code>：当GitLab触发mergeRequest事件时，是否执行构建。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">branchFilterType</span></code>：只有符合条件的分支才会被触发。必选，否则无法实现触发。可以设置的值有：</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">NameBasedFilter</span></code>：基于分支名进行过滤，多个分支名使用逗号分隔。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RegexBasedFilter</span></code>：基于正则表达对分支名进行过滤。</p></li>
<li><p>All：所有分支都会被触发。</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">includeBranchesSpec</span></code>：基于branchFilterType值，输入期望包括的分支的规则。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">excludeBranchesSpec</span></code>：基于branchFilterType值，输入期望排除的分支的规则。</p></li>
</ul>
</section>
<section id="generic-webhook-trigger">
<h3><a class="toc-backref" href="#id137">6.5 使用Generic Webhook Trigger插件实现触发</a><a class="headerlink" href="#generic-webhook-trigger" title="Permalink to this headline">¶</a></h3>
<p>有了Generic Webhook
Trigger插件（https//plugins.jenkins.io/generic-webhook-trigger）就可以实现非webhook的方式触发jenkins。</p>
<p>安装 Generic Webhook Trigger 插件（下文使用 GWT 简称）后，Jenkins
会暴露一个 API:＜JENKINS
URL&gt;/generic-webhook-trigger/invoke，即由GWT插件来处理此API的请求。</p>
<p>我们创建一个普通的pipeline项目。代码如下：</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">triggers</span> <span class="o">{</span>
        <span class="n">GenericTrigger</span><span class="o">(</span><span class="nl">genericVariables:</span> <span class="o">[</span>
            <span class="o">[</span><span class="nl">key:</span><span class="s1">&#39;ref&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;$.ref&#39;</span><span class="o">]</span>
        <span class="o">],</span>
        <span class="nl">token:</span> <span class="s1">&#39;secret&#39;</span><span class="o">,</span>

        <span class="nl">causeString:</span> <span class="s1">&#39;Triggered on $ref&#39;</span><span class="o">,</span>
        <span class="nl">printContributedVariables:</span> <span class="kc">true</span><span class="o">,</span>
        <span class="nl">printPostContent:</span> <span class="kc">true</span><span class="o">,</span>
        <span class="o">)</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Some step&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s1">&#39;echo $ref&#39;</span>
                <span class="n">sh</span> <span class="s2">&quot;sleep 10&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;printenv&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>注意：在创建完成后，需要手动运行一次，这样pipeline的触发条件才会生效。手动触发，让jenkins将Jenkinsfile的内容读取到配置中。</p>
<p>然后，我们发起一次HTTP POST请求。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -X POST -H &quot;Content-Type: application/json&quot; -d &#39;{&quot;ref&quot;:&quot;ref/heads/master&quot;}&#39; -vs &quot;http://192.168.1.xx:8080/generic-webhook-trigger/invoke?token=secret&quot;
</pre></div>
</div>
<p>接着，我们就看到pipeline被触发执行了。</p>
<p><img alt="image32" src="../_images/jenkins_GWT0001.png" /></p>
<p>日志信息如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Triggered</span> <span class="n">on</span> <span class="n">ref</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
<span class="n">GenericWebhookEnvironmentContributor</span>
 <span class="n">Received</span><span class="p">:</span>

<span class="p">{</span><span class="s2">&quot;ref&quot;</span><span class="p">:</span><span class="s2">&quot;ref/heads/master&quot;</span><span class="p">}</span>


<span class="n">Contributing</span> <span class="n">variables</span><span class="p">:</span>

    <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>


<span class="n">Obtained</span> <span class="n">Jenkinsfile</span> <span class="kn">from</span> <span class="nn">git</span> <span class="n">ssh</span><span class="p">:</span><span class="o">//</span><span class="n">git</span><span class="o">@</span><span class="mf">192.168.1.31</span><span class="p">:</span><span class="mi">11022</span><span class="o">/</span><span class="n">hu_admin</span><span class="o">/</span><span class="n">jenkins</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">trigger</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>GenericTrigger触发条件由GWT插件提供。此触发条件可以说是GWT的所有内容。</p>
<p>GenericTrigger触发条件分为5部分，这样更易于理解各参数的作用。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• 从HTTP POST请求中提取参数值。

• token，GWT插件用于标识Jenkins项目的唯一性。

• 根据请求参数值判断是否触发Jenkins项目的执行。

• 日志打印控制。

• Webhook响应控制。
</pre></div>
</div>
<section id="webhook">
<h4>6.5.1 从Webhook请求中提取参数值<a class="headerlink" href="#webhook" title="Permalink to this headline">¶</a></h4>
<p>（1）genericVariables：提取POST body中的参数。</p>
<p>（2）genericRequestVariables：从URL参数中提取值。</p>
<p>（3）genericHeaderVariables：从HTTP header中提取值。</p>
<p>genericHeaderVariables的用法与genericRequestVariables一样，区别是它是从HTTP
header中提取值的。</p>
</section>
<section id="id39">
<h4>6.5.2 触发具体某个Jenkins项目<a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h4>
<p>token参数的作用是标识一个pipeline在Jenkins中的唯一性</p>
<blockquote>
<div><p>如果多个参数化项目的token值一样，则它们都会被触发。</p>
<p>小技巧：pipeline的token可以被设置为Jenkins的项目名。比如：</p>
</div></blockquote>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
  <span class="n">agent</span> <span class="n">any</span>
  <span class="n">triggers</span> <span class="o">{</span>
    <span class="n">GenericTrigger</span><span class="o">(</span>
     <span class="nl">genericVariables:</span> <span class="o">[</span>
      <span class="o">[</span><span class="nl">key:</span> <span class="s1">&#39;ref&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;$.ref&#39;</span><span class="o">],</span>
      <span class="c1">//[key: &#39;fixversion&#39;, value: &#39;$.issue.fields.customfield_10415&#39;]</span>
     <span class="o">],</span>
     <span class="nl">token:</span> <span class="s2">&quot;${env.JOB_NAME}&quot;</span><span class="o">,</span>
     <span class="nl">printContributedVariables:</span> <span class="kc">true</span><span class="o">,</span>
     <span class="nl">printPostContent:</span> <span class="kc">true</span><span class="o">,</span>
     <span class="nl">silentResponse:</span> <span class="kc">false</span><span class="o">,</span>
     <span class="nl">regexpFilterText:</span> <span class="s1">&#39;$ref&#39;</span><span class="o">,</span>
     <span class="nl">regexpFilterExpression:</span> <span class="s1">&#39;&#39;</span>
    <span class="o">)</span>
  <span class="o">}</span>
  <span class="n">stages</span> <span class="o">{</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;test&#39;</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">echo</span> <span class="s2">&quot;Running job name: ${env.JOB_NAME}&quot;</span>
        <span class="n">sh</span> <span class="s2">&quot;echo $ref&quot;</span>
        <span class="n">sh</span> <span class="s2">&quot;sleep 5&quot;</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>触发post请求命令如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -X POST -H &quot;Content-Type: application/json&quot; -d &#39;{&quot;ref&quot;:&quot;ref/heads/master&quot;}&#39; -vs &quot;http://192.168.1.40:8080/generic-webhook-trigger/invoke?token=pipeline_trigger&quot;
</pre></div>
</div>
</section>
<section id="id40">
<h4>6.5.3 根据请求参数值判断是否触发Jenkins项目执行<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h4>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
  <span class="n">agent</span> <span class="n">any</span>
  <span class="n">triggers</span> <span class="o">{</span>
    <span class="n">GenericTrigger</span><span class="o">(</span>
     <span class="nl">genericVariables:</span> <span class="o">[</span>
      <span class="o">[</span><span class="nl">key:</span> <span class="s1">&#39;ref&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;$.ref&#39;</span><span class="o">],</span>
      <span class="c1">//[key: &#39;fixversion&#39;, value: &#39;$.issue.fields.customfield_10415&#39;]</span>
     <span class="o">],</span>
     <span class="nl">token:</span> <span class="s2">&quot;${env.JOB_NAME}&quot;</span><span class="o">,</span>
     <span class="nl">printContributedVariables:</span> <span class="kc">true</span><span class="o">,</span>
     <span class="nl">printPostContent:</span> <span class="kc">true</span><span class="o">,</span>
     <span class="nl">silentResponse:</span> <span class="kc">false</span><span class="o">,</span>
     <span class="nl">regexpFilterText:</span> <span class="s1">&#39;$ref&#39;</span><span class="o">,</span>
     <span class="nl">regexpFilterExpression:</span> <span class="s1">&#39;.*/(master|dev)&#39;</span>
    <span class="o">)</span>
  <span class="o">}</span>
  <span class="n">stages</span> <span class="o">{</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;test&#39;</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">echo</span> <span class="s2">&quot;Running job name: ${env.JOB_NAME}&quot;</span>
        <span class="n">sh</span> <span class="s2">&quot;echo $ref&quot;</span>
        <span class="n">sh</span> <span class="s2">&quot;sleep 5&quot;</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">post</span> <span class="o">{</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s2">&quot;build&quot;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s2">&quot;failed&quot;</span>
        <span class="o">}</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s2">&quot;build&quot;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s2">&quot;success&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">options</span> <span class="o">{</span>
        <span class="n">gitLabConnection</span><span class="o">(</span><span class="s2">&quot;gitlab&quot;</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>regexpFilterText：需要进行匹配的key。例子中，我们使用从POST
body中提取出的ref变量值。</p></li>
<li><p>regexpFilterExpression：正则表达式。</p></li>
</ul>
<p>如果regexpFilterText参数的值符合regexpFilterExpression参数的正则表达式，则触发执行。</p>
<p>触发post命令如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -X POST -H &quot;Content-Type: application/json&quot; -d &#39;{&quot;ref&quot;:&quot;ref/heads/master&quot;}&#39; -vs &quot;http://192.168.1.40:8080/generic-webhook-trigger/invoke?token=pipeline_trigger&quot;
</pre></div>
</div>
<p>没有符合正则表达式的就不会触发。</p>
</section>
<section id="id41">
<h4>6.5.4 控制打印内容<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h4>
<p>打印日志有助于调试。GWT插件提供了三个参数。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• printPostContent：布尔值，将Webhook请求信息打印到日志上。

• printContributedVariables：布尔值，将提取后的变量名及变量值打印出来。

• causeString：字符串类型，触发原因，可以直接引用提取后的变量，如 causeString：&#39;Triggered on $msg&#39;。
</pre></div>
</div>
</section>
<section id="id42">
<h4>5.5.5 控制响应<a class="headerlink" href="#id42" title="Permalink to this headline">¶</a></h4>
<p>GWT插件最近才加入的一个参数：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• silentResponse：布尔类型，在正常情况下，当Webhook请求成功后，GWT插件会返回HTTP 200状态码和触发结果给调用方。

但是当silentResponse设置为true时，就只返回HTTP 200状态码，不返回触发结果。
</pre></div>
</div>
<p>参考文献：</p>
<p><a class="reference external" href="https://blog.csdn.net/weixin_42562106/article/details/107144445?utm_medium=distribute.pc_relevant.none-task-blog-searchFromBaidu-2.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-searchFromBaidu-2.control">https://blog.csdn.net/weixin_42562106/article/details/107144445?utm_medium=distribute.pc_relevant.none-task-blog-searchFromBaidu-2.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-searchFromBaidu-2.control</a></p>
</section>
</section>
</section>
<section id="id43">
<h2><a class="toc-backref" href="#id138">7.将构建状态信息推送到GitLab</a><a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h2>
<p>先生成一个访问令牌，用于在jenkins的系统配置去配置连接gitlab的选项，</p>
<p><img alt="image33" src="../_images/gitlab-token001.png" /></p>
<p>首先在<code class="docutils literal notranslate"><span class="pre">系统管理</span></code>-<code class="docutils literal notranslate"><span class="pre">系统配置</span></code>中配置好连接Gitlab的信息如下</p>
<p><img alt="image34" src="../_images/jenkins-gitlab0001.png" /></p>
<p><strong>在pipeline的post部分，将构建结果更新到GitLab的相应commit记录上</strong>。除此之外，</p>
<p>还需要在<strong>options部分加入gitLabConnection配置，同时传入“gitlab”参数</strong>。“gitlab”就是<code class="docutils literal notranslate"><span class="pre">Connection</span> <span class="pre">name</span></code>的值。</p>
<p>Jenkinsfile</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="cm">/* pipline语言格式 */</span>
<span class="n">pipeline</span> <span class="o">{</span>
    <span class="cm">/* 在stage阶段中指定执行节点 */</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="cm">/* 通过pollSCM轮询监测版本改动 */</span>
    <span class="n">triggers</span> <span class="o">{</span> <span class="n">pollSCM</span><span class="o">(</span><span class="s1">&#39;*/1 * * * *&#39;</span><span class="o">)</span> <span class="o">}</span>
    <span class="cm">/* 创建环境变量 */</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">USER</span> <span class="o">=</span> <span class="s2">&quot;xxx&quot;</span>
        <span class="n">MAIL</span> <span class="o">=</span> <span class="s2">&quot;xxx@xxx.com&quot;</span>
        <span class="n">PROJECT</span> <span class="o">=</span> <span class="s2">&quot;GAME OVER&quot;</span>
        <span class="n">PREPARATION</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="n">BUILD</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="n">DEPLOY</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="n">TEST</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
    <span class="o">}</span>
    <span class="cm">/* 指定代码块 */</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="cm">/* 指定主体阶段：拉取代码 */</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Preparation&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="cm">/* 选择节点标签</span>
<span class="cm">            agent {</span>
<span class="cm">                //label &#39;node1&#39;</span>
<span class="cm">                label any</span>
<span class="cm">               }</span>
<span class="cm">            */</span>

            <span class="cm">/* 指定DSL命令封装区域 */</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="cm">/* 拉取代码 */</span>
                <span class="n">git</span> <span class="nl">credentialsId:</span> <span class="s1">&#39;ad0cb5b7-fe4a-4caa-a9d6-2c3f8502bcdd&#39;</span><span class="o">,</span> <span class="nl">url:</span> <span class="s1">&#39;http://192.168.1.31:11080/hu_admin/gitlab-ci.git&#39;</span>
                <span class="n">echo</span> <span class="s2">&quot;pull code&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;sleep 10&quot;</span>
            <span class="o">}</span>
            <span class="cm">/* 校验条件：校验拉取代码 */</span>
            <span class="n">post</span> <span class="o">{</span>
                <span class="cm">/* 无论如何都执行 */</span>
                <span class="n">always</span> <span class="o">{</span>
                    <span class="n">echo</span> <span class="s2">&quot;The code pull action is completed&quot;</span>
                <span class="o">}</span>
                <span class="cm">/* 拉取失败执行 */</span>
                <span class="n">failure</span> <span class="o">{</span>
                    <span class="cm">/* 使用纯DSL语言编辑 */</span>
                    <span class="n">script</span> <span class="o">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;Failed to execute code pull action!!!&quot;</span>
                        <span class="n">PREPARATION</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="cm">/* 拉取成功执行 */</span>
                <span class="n">success</span> <span class="o">{</span>
                    <span class="cm">/* 使用纯DSL语言编辑 */</span>
                    <span class="n">script</span> <span class="o">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;Successfully execute code pull action!!!&quot;</span>
                        <span class="n">PREPARATION</span> <span class="o">=</span> <span class="s2">&quot;SUCCESS&quot;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="cm">/* 指定主体阶段：打包代码 */</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="cm">/* 选择节点标签</span>

<span class="cm">            agent {</span>
<span class="cm">                label any</span>
<span class="cm">            }</span>
<span class="cm">            */</span>

            <span class="cm">/* 指定DSL命令封装区域 */</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s2">&quot;gradle build will go here.&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
            <span class="o">}</span>
            <span class="cm">/* 校验条件：校验打包 */</span>
            <span class="n">post</span> <span class="o">{</span>
                <span class="cm">/* 无论如何都执行 */</span>
                <span class="n">always</span> <span class="o">{</span>
                    <span class="n">echo</span> <span class="s2">&quot;Build stage complete&quot;</span>
                    <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
                    <span class="c1">// 反馈状态给gitlab</span>
                    <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s1">&#39;build&#39;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s1">&#39;running&#39;</span>
                <span class="o">}</span>
                <span class="cm">/* 打包失败执行 */</span>
                <span class="n">failure</span> <span class="o">{</span>
                    <span class="cm">/* 使用纯DSL语言编辑 */</span>
                    <span class="n">script</span> <span class="o">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;Build failed!!!&quot;</span>
                        <span class="n">BUILD</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>
                        <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>

                       <span class="c1">// 反馈状态给gitlab</span>
                       <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s1">&#39;build&#39;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s1">&#39;failure&#39;</span>

                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="cm">/* 打包成功执行 */</span>
                <span class="n">success</span> <span class="o">{</span>
                    <span class="cm">/* 使用纯DSL语言编辑 */</span>
                    <span class="n">script</span> <span class="o">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;Build succeeded!!!&quot;</span>
                        <span class="n">BUILD</span> <span class="o">=</span> <span class="s2">&quot;SUCCESS&quot;</span>
                        <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
                        <span class="c1">// 反馈状态给gitlab</span>
                        <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s1">&#39;build&#39;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s1">&#39;success&#39;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="cm">/* 指定主体阶段：部署 */</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Deploy&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="cm">/* 选择节点标签</span>
<span class="cm">            agent {</span>
<span class="cm">                label any</span>
<span class="cm">            }</span>
<span class="cm">            */</span>


            <span class="cm">/* 指定DSL命令封装区域 */</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s2">&quot;Deploy the project environment.&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;sleep 10&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="cm">/* 指定主体阶段：测试 */</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Test&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="cm">/* 并发执行 */</span>
            <span class="n">parallel</span> <span class="o">{</span>
                <span class="cm">/* 指定主体阶段：测试组1 */</span>
                <span class="n">stage</span> <span class="o">(</span><span class="s1">&#39;set1&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="cm">/* 选择节点标签：可选标签组</span>
<span class="cm">                    agent {</span>
<span class="cm">                        label any</span>
<span class="cm">                    }</span>
<span class="cm">                    */</span>

                    <span class="cm">/* 指定DSL命令封装区域 */</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;Test project environment. node1&quot;</span>
                        <span class="n">echo</span> <span class="s2">&quot;Test project environment. node2&quot;</span>
                        <span class="n">echo</span> <span class="s2">&quot;Test project environment. node3&quot;</span>
                        <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="cm">/* 指定主体阶段：测试组2 */</span>
                <span class="n">stage</span> <span class="o">(</span><span class="s1">&#39;set2&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="cm">/* 选择节点标签：可选标签组</span>
<span class="cm">                    agent {</span>
<span class="cm">                        label any</span>
<span class="cm">                    }</span>
<span class="cm">                     */</span>

                    <span class="cm">/* 指定DSL命令封装区域 */</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;Test project environment. master1&quot;</span>
                        <span class="n">echo</span> <span class="s2">&quot;Test project environment. master2&quot;</span>
                        <span class="n">echo</span> <span class="s2">&quot;Test project environment. master3&quot;</span>
                        <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

        <span class="o">}</span>
    <span class="o">}</span>
    <span class="cm">/* 校验条件：校验整体发布流程 */</span>
    <span class="n">post</span> <span class="o">{</span>
        <span class="cm">/* 无论如何都执行 */</span>
        <span class="n">always</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s2">&quot;All executed&quot;</span>
        <span class="o">}</span>
        <span class="cm">/* 发布失败执行 */</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="cm">/* 使用纯DSL语言编辑 */</span>
            <span class="n">script</span> <span class="o">{</span>
                <span class="cm">/* 发送邮件 */</span>
                <span class="n">echo</span> <span class="s2">&quot;Unfortunately failed!!!&quot;</span>
                <span class="n">echo</span> <span class="s2">&quot;Send  mail ....... &quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
                <span class="c1">// 反馈状态给gitlab</span>
                <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s1">&#39;build&#39;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s1">&#39;failed&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="cm">/* 发布成功执行 */</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="cm">/* 使用纯DSL语言编辑 */</span>
            <span class="n">script</span> <span class="o">{</span>
                <span class="cm">/* 发送邮件 */</span>

                <span class="n">echo</span> <span class="s2">&quot;Great success!!!&quot;</span>
                <span class="n">echo</span> <span class="s2">&quot;Send  mail ....... &quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
 <span class="c1">//               mail to: &quot;${MAIL}&quot;,</span>
 <span class="c1">//               subject: &quot;项目:${PROJECT}发布成功&quot;,</span>
 <span class="c1">//               body: &quot;Preparation=${PREPARATION}\nBUILD=${BUILD}\nDEPLOY=${DEPLOY}\nTEST=${TEST}&quot;</span>
                <span class="c1">// 反馈状态给gitlab</span>
                <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s1">&#39;build&#39;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s1">&#39;success&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">options</span><span class="o">{</span>
        <span class="n">gitLabConnection</span><span class="o">(</span><span class="s1">&#39;gitlab&#39;</span><span class="o">)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>核心代码</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">triggers</span> <span class="o">{</span>
        <span class="n">gitlab</span><span class="o">(</span><span class="nl">triggerOnPush:</span> <span class="kc">true</span><span class="o">,</span>
            <span class="nl">triggerOnMergeRequest:</span> <span class="kc">true</span><span class="o">,</span>
            <span class="nl">branchFilterType:</span> <span class="s2">&quot;All&quot;</span><span class="o">,</span>
            <span class="nl">secretToken:</span> <span class="s2">&quot;t8vcxwuza023ehzcftzr5a74vkpto6xr&quot;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s1">&#39;Hello World from gitlab trigger&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">post</span> <span class="o">{</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s2">&quot;build&quot;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s2">&quot;failed&quot;</span>
        <span class="o">}</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s2">&quot;build&quot;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s2">&quot;success&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">options</span> <span class="o">{</span>
        <span class="n">gitLabConnection</span><span class="o">(</span><span class="s2">&quot;gitlab&quot;</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>提交代码后，需要手动触发一次构建，pipeline才会生效。</p>
<p><img alt="image35" src="../_images/webhook_gitlab_00004.png" /></p>
<p><img alt="image36" src="../_images/webhook_gitlab0005.png" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//jenkins 构建过程中的日志记录，每次成功都会将返回信息updating到gitlab上，如下
2020-12-11 17:05:01.300+0000 [id=1257]  INFO    c.d.g.util.CommitStatusUpdater#retrieveGitlabProjectIds: Retrieving gitlab project ids
2020-12-11 17:05:01.397+0000 [id=1257]  INFO    c.d.g.util.CommitStatusUpdater#updateCommitStatus: Updating build &#39;1&#39; to &#39;running&#39;
2020-12-11 17:05:08.443+0000 [id=1257]  INFO    c.d.g.util.CommitStatusUpdater#retrieveGitlabProjectIds: Retrieving gitlab project ids
2020-12-11 17:05:08.493+0000 [id=1257]  INFO    c.d.g.util.CommitStatusUpdater#updateCommitStatus: Updating build &#39;1&#39; to &#39;success&#39;
2020-12-11 17:05:32.953+0000 [id=1257]  INFO    c.d.g.util.CommitStatusUpdater#retrieveGitlabProjectIds: Retrieving gitlab project ids
2020-12-11 17:05:33.079+0000 [id=1257]  INFO    c.d.g.util.CommitStatusUpdater#updateCommitStatus: Updating build &#39;1&#39; to &#39;success&#39;
2020-12-11 17:05:33.545+0000 [id=1366]  INFO    o.j.p.workflow.job.WorkflowRun#finish: jenkins_pipline00001 #7 completed: SUCCESS
</pre></div>
</div>
<p><img alt="image37" src="../_images/gitlab_webhook0006.png" /></p>
<p>参考文献：</p>
<p><a class="reference external" href="https://blog.51cto.com/ygqygq2/2461766">https://blog.51cto.com/ygqygq2/2461766</a></p>
<p><a class="reference external" href="https://www.jianshu.com/p/d2af2915cfea">https://www.jianshu.com/p/d2af2915cfea</a></p>
</section>
<section id="id44">
<h2><a class="toc-backref" href="#id139">8.多分支构建</a><a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h2>
<section id="id45">
<h3><a class="toc-backref" href="#id140">8.1 创建多分支pipeline</a><a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h3>
<p>进入创建页面，我们介绍关键的几个选项。</p>
<p>（1）设置代码仓库地址</p>
<p><img alt="image38" src="../_images/duo_branch_pipeline001.png" /></p>
<p>（2）设置分支扫描触发策略。</p>
<p>分支扫描是指Jenkins根据一定的策略去代码仓库扫描分支，如果有新分支就创建一个以分支名命名的任务，如果发现有分支被删除了，就删除相应的Jenkins任务。</p>
<p><img alt="image39" src="../_images/duo_branch0002.png" /></p>
<p>在“Scan Multibranch Pipeline Triggers”下就只有一个可选项：Periodically
ifnot otherwise run
（没有手动触发，就定期扫描分支）。勾选此选项，设置扫描的间隔时长。</p>
<p><img alt="image40" src="../_images/duo_branch0003.png" /></p>
<p>越频繁建立分支，扫描周期应越短。当然，我们也可以单击任务页面左侧的“Scan
Multibranch PipelineNow”项，手动触发Jenkins去扫描分支。</p>
<p>（3）孤儿任务（Orphaned Item）处理策略。</p>
<p>如果在代码仓库中删除了release分支，那么在多分支任务页面上，该分支在Jenkins上的任务也应该被删除。至于什么时候删除，取决于下次分支扫描的时间。如果代码仓库中的分支被删除了，而Jenkins上的相应任务没有被删除，那么这个任务就被称为孤儿任务。</p>
<p>对于分支任务上的历史记录，保存多长时间是可以设置的。</p>
<p><img alt="image41" src="../_images/duo_branch0004.png" /></p>
<p>两个参数的含义分别是：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• Days to keep old items：保留多少天。

• Max＃of old items to keep：最多保留多少个孤儿任务。
</pre></div>
</div>
</section>
<section id="id46">
<h3><a class="toc-backref" href="#id141">8.2 根据分支部署到不同的环境</a><a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h3>
<p>git分支可以用于对代码进行物理隔离。对分支的管理有很多方法，比如主干开发，发布分支以及Gitflow法等。</p>
<p>我们不讨论它们的好坏。但不论使用哪种分支管理方法，都可能会涉及一个问题：如何根据不同的分支做不同的事情，比如根据不同的分支部署到不同的环境。类似这样的事情可以使用if-else来实现。</p>
<p>脚本式方式：</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">triggers</span> <span class="o">{</span>
        <span class="n">gitlab</span><span class="o">(</span><span class="nl">triggerOnPush:</span> <span class="kc">true</span><span class="o">,</span>
            <span class="nl">triggerOnMergeRequest:</span> <span class="kc">true</span><span class="o">,</span>
            <span class="nl">branchFilterType:</span> <span class="s2">&quot;All&quot;</span><span class="o">,</span>
            <span class="nl">secretToken:</span> <span class="s2">&quot;t8vcxwuza023ehzcftzr5a74vkpto6xr&quot;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;deploy to test&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">GIT_BRANCH</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;deploy to test env&quot;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;deploy to prod&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">GIT_BRANCH</span> <span class="o">==</span> <span class="s1">&#39;release&#39;</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;deploy to prod&quot;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
              <span class="o">}</span>

        <span class="o">}</span>

<span class="o">}</span>

    <span class="n">post</span> <span class="o">{</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s2">&quot;build&quot;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s2">&quot;failed&quot;</span>
        <span class="o">}</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s2">&quot;build&quot;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s2">&quot;success&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">options</span> <span class="o">{</span>
        <span class="n">gitLabConnection</span><span class="o">(</span><span class="s2">&quot;gitlab&quot;</span><span class="o">)</span>
    <span class="o">}</span>

<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>但是这样的代码不够优雅，而且不是声明式的。使用when指令可以让pipeline看起来更优雅。</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">triggers</span> <span class="o">{</span>
        <span class="n">gitlab</span><span class="o">(</span><span class="nl">triggerOnPush:</span> <span class="kc">true</span><span class="o">,</span>
            <span class="nl">triggerOnMergeRequest:</span> <span class="kc">true</span><span class="o">,</span>
            <span class="nl">branchFilterType:</span> <span class="s2">&quot;All&quot;</span><span class="o">,</span>
            <span class="nl">secretToken:</span> <span class="s2">&quot;t8vcxwuza023ehzcftzr5a74vkpto6xr&quot;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">stages</span> <span class="o">{</span>
      <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Deliver for development&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">branch</span> <span class="s1">&#39;release&#39;</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s2">&quot;deploy to test and dev.....&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Deploy for production&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">branch</span> <span class="s1">&#39;master&#39;</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                 <span class="n">echo</span> <span class="s2">&quot;deploy to production....&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>

<span class="o">}</span>

    <span class="n">post</span> <span class="o">{</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s2">&quot;build&quot;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s2">&quot;failed&quot;</span>
        <span class="o">}</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="n">updateGitlabCommitStatus</span> <span class="nl">name:</span> <span class="s2">&quot;build&quot;</span><span class="o">,</span> <span class="nl">state:</span> <span class="s2">&quot;success&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">options</span> <span class="o">{</span>
        <span class="n">gitLabConnection</span><span class="o">(</span><span class="s2">&quot;gitlab&quot;</span><span class="o">)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="when">
<h3><a class="toc-backref" href="#id142">8.3 when指令的用法</a><a class="headerlink" href="#when" title="Permalink to this headline">¶</a></h3>
<p>when指令允许pipeline根据给定的条件，决定是否执行阶段内的步骤。when指令必须至少包含一个条件。when指令除了支持branch判断条件，还支持多种判断条件。</p>
<section id="id47">
<h4>内置条件<a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>- branch

  当正在构建的分支与模式给定的分支匹配时，执行这个阶段, 例如: `when { branch &#39;master&#39; }`。注意，这只适用于多分支流水线。

- environment

  当指定的环境变量是给定的值时，执行这个步骤, 例如: `when { environment name: &#39;DEPLOY_TO&#39;, value: &#39;production&#39; }`

- expression

  当指定的Groovy表达式评估为true时，执行这个阶段, 例如: `when { expression { return params.DEBUG_BUILD } }`

- not

  当嵌套条件是错误时，执行这个阶段,必须包含一个条件，例如: `when { not { branch &#39;master&#39; } }`

- allOf

  当所有的嵌套条件都正确时，执行这个阶段,必须包含至少一个条件，例如: `when { allOf { branch &#39;master&#39;; environment name: &#39;DEPLOY_TO&#39;, value: &#39;production&#39; } }`

- anyOf

  当至少有一个嵌套条件为真时，执行这个阶段,必须包含至少一个条件，例如: `when { anyOf { branch &#39;master&#39;; branch &#39;staging&#39; } }`
</pre></div>
</div>
<p>示例</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Example Build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s1">&#39;Hello World&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Example Deploy&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">branch</span> <span class="s1">&#39;production&#39;</span>
                <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;DEPLOY_TO&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;production&#39;</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s1">&#39;Deploying&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Example Build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s1">&#39;Hello World&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Example Deploy&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">branch</span> <span class="s1">&#39;production&#39;</span>
                <span class="n">anyOf</span> <span class="o">{</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;DEPLOY_TO&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;production&#39;</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;DEPLOY_TO&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;staging&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s1">&#39;Deploying&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Example Build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s1">&#39;Hello World&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Example Deploy&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">allOf</span> <span class="o">{</span>
                    <span class="n">branch</span> <span class="s1">&#39;production&#39;</span>
                    <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;DEPLOY_TO&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;production&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s1">&#39;Deploying&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
</section>
<section id="gitlab-triggerpipeline">
<h3><a class="toc-backref" href="#id143">8.4 GitLab trigger对多分支pipeline的支持</a><a class="headerlink" href="#gitlab-triggerpipeline" title="Permalink to this headline">¶</a></h3>
<p>对于GitLab来说，并没有Jenkins多分支pipeline的概念，所以GitLab只会触发Jenkins进行分支索引（branch
index），Jenkins可根据索引结果决定是否执行构建。对于多分支pipeline，Jenkins
GitLab插件只监听push事件，不监听mergerequest事件。</p>
<p>而在Jenkins多分支pipeline项目的设置页面中，是找不到GitLab配置项的。只能通过修改Jenkinsfile来实现，在triggers指令中加入gitlab配置。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">triggers</span> <span class="p">{</span>
    <span class="n">gitlab</span><span class="p">(</span><span class="n">triggerOnPush</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="n">triggerOnMergeRequest</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="n">branchFilterType</span><span class="p">:</span> <span class="s2">&quot;All&quot;</span><span class="p">,</span>
    <span class="n">secretToken</span><span class="p">:</span> <span class="s2">&quot;t8vcxwuza023ehzcftzr5a74vkpto6xr&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id48">
<h3><a class="toc-backref" href="#id144">8.5 并发示例</a><a class="headerlink" href="#id48" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/* 指定主体阶段：部署 */
stage(&#39;Deploy&#39;) {
    //当其中一个进程失败时，你可以强制所有的 parallel 阶段都被终止。
    failFast true

    // 并发stage
    parallel {
        stage(&#39;Branch A&#39;) {
           /* 选择节点标签
            agent {
                label &quot;for-branch-a&quot;
            }
            */
            steps {
                echo &quot;Deploy On project Branch A......&quot;
                sh &quot;sleep 10&quot;
            }
        }
        stage(&#39;Branch B&#39;) {
            /**
            agent {
                label &quot;for-branch-b&quot;
            }
            **/

             /* 指定DSL命令封装区域 */
            steps {
                echo &quot;Deploy On project Branch B.......&quot;
                sh &quot;sleep 10&quot;
            }
        }
    }
}
</pre></div>
</div>
<p><strong>并行构建示例</strong></p>
<p>如果需要分别在Chrome、Firefox、IE等浏览器的各个不同版本中对同一个Web应用进行UI测试，该怎么做呢？根据前文对Jenkins
pipeline的学习，我们也许会这样写：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>

    <span class="n">stages</span><span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s2">&quot;Run Tests&quot;</span><span class="p">)</span> <span class="p">{</span>

            <span class="n">failFast</span> <span class="n">true</span>
            <span class="n">parallel</span> <span class="p">{</span>
                <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Build&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">steps</span> <span class="p">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;Building..............&quot;</span>

                    <span class="p">}</span>
                <span class="p">}</span>


                <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Test on Chrome&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">steps</span> <span class="p">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;Chrome  UI测试..&quot;</span>

                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Test on Firfox&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">steps</span> <span class="p">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;Firfox  UI测试..&quot;</span>

                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Test on IE&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">steps</span> <span class="p">{</span>
                        <span class="n">echo</span> <span class="s2">&quot;IE  UI测试..&quot;</span>

                    <span class="p">}</span>
                <span class="p">}</span>

        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id49">
<h2><a class="toc-backref" href="#id145">9.参数化pipeline</a><a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h2>
<section id="id50">
<h3><a class="toc-backref" href="#id146">9.1 什么是参数化pipeline</a><a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h3>
<p>参数化pipeline是指可以通过传参来决定pipeline的行为。参数化让写pipeline就像写函数，而函数意味着可重用、更抽象。所以，通常使用参数化pipeline来实现一些通用的pipeline。</p>
</section>
<section id="parameters">
<h3><a class="toc-backref" href="#id147">9.2 使用parameters指令</a><a class="headerlink" href="#parameters" title="Permalink to this headline">¶</a></h3>
<p>使用parameters指令在Jenkins
pipeline中定义参数使用的是parameters指令，其只允许被放在pipeline块下。代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>

    <span class="n">parameters</span> <span class="p">{</span>
        <span class="n">booleanParam</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="n">description</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">:</span><span class="s1">&#39;userFlag&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">stages</span><span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">){</span>
            <span class="n">steps</span><span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;flag: $</span><span class="si">{params.userFlag}</span><span class="s2">&quot;</span>
            <span class="p">}</span>

        <span class="p">}</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>booleanParam方法用于定义一个布尔类型的参数。booleanParam方法接收三个参数。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• defaultValue：默认值。
• description：参数的描述信息。
• name：参数名。
</pre></div>
</div>
<p><img alt="image42" src="../_images/pipeline_parameters00001.png" /></p>
<p>构建输出如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="p">}</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="o">//</span> <span class="n">stage</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="n">withEnv</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="p">{</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="n">stage</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="p">{</span> <span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="n">echo</span>
<span class="n">flag</span><span class="p">:</span> <span class="n">true</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="p">}</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="o">//</span> <span class="n">stage</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="p">}</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="o">//</span> <span class="n">withEnv</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="p">}</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="o">//</span> <span class="n">node</span>
<span class="p">[</span><span class="n">Pipeline</span><span class="p">]</span> <span class="n">End</span> <span class="n">of</span> <span class="n">Pipeline</span>
<span class="n">Finished</span><span class="p">:</span> <span class="n">SUCCESS</span>
</pre></div>
</div>
<section id="id51">
<h4>9.2.1 parameters指令支持的参数类型<a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h4>
<p>为了满足不同的应用场景，参数化pipeline支持多种参数类型，包括：</p>
<ul class="simple">
<li><p>string，字符串类型。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">parameters</span> <span class="p">{</span>
        <span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;PERSON&#39;</span><span class="p">,</span> <span class="n">defaultValue</span><span class="p">:</span> <span class="s1">&#39;Mr Jenkins&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;Who should I say hello to?&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;Hello $</span><span class="si">{params.PERSON}</span><span class="s2">&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><img alt="image43" src="../_images/pipeline_parameters00002.png" /></p>
<ul class="simple">
<li><p>text，多行文本类型，换行使用:raw-latex:<cite>n</cite>。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">parameters</span> <span class="p">{</span>
        <span class="n">text</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;DEPLOY_TEXT&#39;</span><span class="p">,</span> <span class="n">defaultValue</span><span class="p">:</span> <span class="s1">&#39;One</span><span class="se">\n</span><span class="s1">Two</span><span class="se">\n</span><span class="s1">Three</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;Hello $</span><span class="si">{params.DEPLOY_TEXT}</span><span class="s2">&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><img alt="image44" src="../_images/pipeline_parameters00004.png" /></p>
<ul class="simple">
<li><p>booleanParam，布尔类型。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parameters</span> <span class="p">{</span>
    <span class="n">booleanParam</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="n">description</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">:</span><span class="s1">&#39;userFlag&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>choice，选择参数类型，使用:raw-latex:<cite>n来分隔多个选项</cite>。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">parameters</span> <span class="p">{</span>
        <span class="o">//</span><span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;PERSON&#39;</span><span class="p">,</span> <span class="n">defaultValue</span><span class="p">:</span> <span class="s1">&#39;Mr Jenkins&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;Who should I say hello to?&#39;</span><span class="p">)</span>
        <span class="n">choice</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;CHOICES&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="s1">&#39;dev</span><span class="se">\n</span><span class="s1">test</span><span class="se">\n</span><span class="s1">staging&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;请选择部署环境?&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;Hello $</span><span class="si">{params.CHOICES}</span><span class="s2">&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><img alt="image45" src="../_images/jenkins_hu_parameters0001.png" /></p>
<p><img alt="image46" src="../_images/jenkins_hu_parameters0002.png" /></p>
<ul class="simple">
<li><p>password，密码类型。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">parameters</span> <span class="p">{</span>
        <span class="n">password</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;PASSWORD&#39;</span><span class="p">,</span> <span class="n">defaultValue</span><span class="p">:</span><span class="s1">&#39;SECRET&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;A secret password&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;Hello $</span><span class="si">{params.PASSWORD}</span><span class="s2">&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><img alt="image47" src="../_images/jenkins_parameters0003.png" /></p>
<p><img alt="image48" src="../_images/jenkins_parameter00004.png" /></p>
</section>
<section id="id52">
<h4>9.2.2 多参数<a class="headerlink" href="#id52" title="Permalink to this headline">¶</a></h4>
<p>当然，参数化的pipeline不可能只支持接收一个参数，以下就是为pipeline同时定义多个参数的例子。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">parameters</span> <span class="p">{</span>
        <span class="n">password</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;PASSWORD&#39;</span><span class="p">,</span> <span class="n">defaultValue</span><span class="p">:</span><span class="s1">&#39;SECRET&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;A secret password&#39;</span><span class="p">)</span>
        <span class="n">booleanParam</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="n">description</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">:</span><span class="s1">&#39;userFlag&#39;</span><span class="p">)</span>
        <span class="n">choice</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;CHOICES&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="s1">&#39;dev</span><span class="se">\n</span><span class="s1">test</span><span class="se">\n</span><span class="s1">staging&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;请选择部署环境?&#39;</span><span class="p">)</span>
        <span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;PERSON&#39;</span><span class="p">,</span> <span class="n">defaultValue</span><span class="p">:</span> <span class="s1">&#39;Mr Jenkins&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;Who should I say hello to?&#39;</span><span class="p">)</span>

    <span class="p">}</span>
    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;Hello $</span><span class="si">{params.PASSWORD}</span><span class="s2">&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><img alt="image49" src="../_images/jenkins_parameter00005.png" /></p>
</section>
</section>
<section id="id53">
<h3><a class="toc-backref" href="#id148">9.3 由另一个pipeline传参并触发</a><a class="headerlink" href="#id53" title="Permalink to this headline">¶</a></h3>
<p>既然存在参数化的pipeline，那么就表示可以在一个pipeline中“调用”另一个pipeline。</p>
<p>在Jenkins pipeline中可以使用build步骤实现此功能。</p>
<p>build步骤是pipeline插件的一个组件，所以不需要另外安装插件，可以直接使用。</p>
<p>build步骤其实也是一种触发pipeline执行的方式，它与triggers指令中的upstream方式有两个区别：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(1) build步骤是由上游pipeline使用的，而upstream方式是由下游pipeline使用的。

(2) build步骤是可以带参数的，而upstream方式只是被动触发，并且没有带参数。
</pre></div>
</div>
<p>创建一个pipeline，名叫<code class="docutils literal notranslate"><span class="pre">pipeline1</span></code></p>
<p><img alt="image50" src="../_images/jenkins_simple0001.png" /></p>
<p>pipeline脚本如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>

    <span class="n">parameters</span> <span class="p">{</span>
        <span class="n">booleanParam</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="n">description</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">:</span><span class="s1">&#39;userFlag&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s1">&#39;Hello World&#39;</span>
                <span class="n">echo</span> <span class="s2">&quot;flag: $</span><span class="si">{params.userFlag}</span><span class="s2">&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>用新创建的pipeline来调用<code class="docutils literal notranslate"><span class="pre">pipeline1</span></code>运行。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span>
    <span class="p">{</span>
        <span class="n">node</span> <span class="p">{</span>
                <span class="n">label</span> <span class="s1">&#39;master&#39;</span>
                <span class="n">customWorkspace</span> <span class="s2">&quot;$</span><span class="si">{env.JobPath}</span><span class="s2">&quot;</span>
              <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">stages</span>
    <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Start&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">sh</span> <span class="s1">&#39;ls&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">stage</span> <span class="p">(</span><span class="s1">&#39;Invoke_pipeline&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">build</span> <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;pipeline1&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;param1&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;End&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">sh</span> <span class="s1">&#39;ls&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>pipeline1也被触发运行，如下：</p>
<p><img alt="image51" src="../_images/jenkins_sample0002.png" /></p>
</section>
<section id="conditional-buildstep">
<h3><a class="toc-backref" href="#id149">9.4 使用Conditional BuildStep插件处理复杂的判断逻辑</a><a class="headerlink" href="#conditional-buildstep" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">parameters</span> <span class="p">{</span>
        <span class="n">choice</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;CHOICES&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="s1">&#39;dev</span><span class="se">\n</span><span class="s1">test</span><span class="se">\n</span><span class="s1">staging&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;请选择部署环境?&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;deploy to test&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">script</span> <span class="p">{</span>
                 <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">CHOICES</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">){</span>
                    <span class="n">echo</span> <span class="s2">&quot;deploy to test...........&quot;</span>
                    <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
                 <span class="p">}</span>
               <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;deploy to dev&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">script</span> <span class="p">{</span>
                 <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">CHOICES</span> <span class="o">==</span> <span class="s1">&#39;dev&#39;</span><span class="p">){</span>
                    <span class="n">echo</span> <span class="s2">&quot;deploy to dev.............&quot;</span>
                    <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
                 <span class="p">}</span>
               <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;deploy to staging&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">script</span> <span class="p">{</span>
                 <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">CHOICES</span> <span class="o">==</span> <span class="s1">&#39;staging&#39;</span><span class="p">){</span>
                    <span class="n">echo</span> <span class="s2">&quot;deploy to staging............&quot;</span>
                    <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这样写起来很不优雅，Conditional
BuildStep插件（<a class="reference external" href="https://plugins.jenkins.io/conditional-buildstep">https://plugins.jenkins.io/conditional-buildstep</a>）可以让我们像使用when指令一样进行条件判断。以下代码就是安装Conditional
BuildStep插件后的写法。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">parameters</span> <span class="p">{</span>
        <span class="n">choice</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;CHOICES&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="s1">&#39;dev</span><span class="se">\n</span><span class="s1">test</span><span class="se">\n</span><span class="s1">staging&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;请选择部署环境?&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">stages</span> <span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s2">&quot;deploy test&quot;</span><span class="p">){</span>
            <span class="n">when</span> <span class="p">{</span>
                <span class="n">expression</span> <span class="p">{</span> <span class="k">return</span> <span class="n">params</span><span class="o">.</span><span class="n">CHOICES</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;deploy to test.......&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">stage</span><span class="p">(</span><span class="s2">&quot;deploy staging&quot;</span><span class="p">){</span>
            <span class="n">when</span> <span class="p">{</span>
                <span class="n">expression</span> <span class="p">{</span> <span class="k">return</span> <span class="n">params</span><span class="o">.</span><span class="n">CHOICES</span> <span class="o">==</span> <span class="s1">&#39;staging&#39;</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;deploy to staging.......&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>

       <span class="n">stage</span><span class="p">(</span><span class="s2">&quot;deploy dev&quot;</span><span class="p">){</span>
            <span class="n">when</span> <span class="p">{</span>
                <span class="n">expression</span> <span class="p">{</span> <span class="k">return</span> <span class="n">params</span><span class="o">.</span><span class="n">CHOICES</span> <span class="o">==</span> <span class="s1">&#39;dev&#39;</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">steps</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s2">&quot;deploy to dev.......&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;sleep 6&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>此pipeline会根据choice的选择做出相应的部署操作。</p>
<p><img alt="image52" src="../_images/jenkins_20201215001.png" /></p>
<p><img alt="image53" src="../_images/jenkins_20201215002.png" /></p>
<p>现实中，我们会面对更复杂的判断条件。而expression表达式本质上就是一个Groovy代码块，大大提高了表达式的灵活性。以下是比较常用的例子。</p>
<ul class="simple">
<li><p>或逻辑</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">when</span> <span class="p">{</span>
<span class="o">//</span> <span class="n">A</span> <span class="ow">or</span> <span class="n">B</span>
    <span class="n">expression</span> <span class="p">{</span> <span class="k">return</span> <span class="n">A</span> <span class="o">||</span> <span class="n">B</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>与逻辑</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">when</span> <span class="p">{</span>
<span class="o">//</span> <span class="n">A</span> <span class="ow">and</span> <span class="n">B</span>
    <span class="n">expression</span> <span class="p">{</span> <span class="k">return</span> <span class="n">A</span> <span class="o">&amp;&amp;</span> <span class="n">B</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>从文件中取值</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">when</span> <span class="p">{</span>
    <span class="n">expression</span> <span class="p">{</span> <span class="k">return</span> <span class="n">readFile</span><span class="p">(</span><span class="s1">&#39;pom.xml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;mycomponent&#39;</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>正则表达式</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>when {
    expression { return token ==~ /(?i)(Y|YES|T|TRUE|ON|RUN)/ }
}
</pre></div>
</div>
</section>
<section id="input">
<h3><a class="toc-backref" href="#id150">9.5 使用input步骤</a><a class="headerlink" href="#input" title="Permalink to this headline">¶</a></h3>
<p>执行input步骤会暂停pipeline，直到用户输入参数。这是一种特殊的参数化pipeline的方法。我们可以利用input步骤实现以下两种场景：</p>
<p>（1）实现简易的审批流程。例如，pipeline暂停在部署前的阶段，由负责人点击确认后，才能部署。</p>
<p>（2）实现手动测试阶段。在pipeline中增加一个手动测试阶段，该阶段中只有一个input步骤，当手动测试通过后，测试人员才可以通过这个input步骤。</p>
<section id="id54">
<h4>9.5.1 input步骤的简单用法<a class="headerlink" href="#id54" title="Permalink to this headline">¶</a></h4>
<p>接下来，我们介绍input步骤的简单使用方式。</p>
<p>（1）在Jenkinsfile中加入input步骤。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">stages</span><span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;deploy&#39;</span><span class="p">){</span>
            <span class="n">steps</span><span class="p">{</span>
                <span class="nb">input</span> <span class="n">message</span><span class="p">:</span><span class="s2">&quot;发布或停止&quot;</span>
            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>（2）当pipeline执行到deploy阶段后，就会暂停。</p>
<p><img alt="image54" src="../_images/jenkins_202012150003.png" /></p>
<p><img alt="image55" src="../_images/jenkins_202012150004.png" /></p>
<p>这是简单的input步骤使用方式——手动确定是否通过。</p>
</section>
<section id="id55">
<h4>9.5.2 input步骤的复杂用法<a class="headerlink" href="#id55" title="Permalink to this headline">¶</a></h4>
<p>input步骤的简单用法很难满足更复杂的场景。现在，我们来看一种更复杂的使用方式。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// 定义变量，用于存储inout的返回值
def approvalMap

pipeline{
    agent any
    //approvalMap还有一种定义方式，放在environment中。
    /**
    environment {
    approvalMap = &#39;&#39;
    }

    **/
    stages{
        stage(&#39;pre deploy&#39;){
            steps{
               script{
                approvalMap = input(
                    //input步骤的提示消息。
                    message:&quot;准备发布到哪个环境？&quot;,
                    //自定义确定按钮的文本。
                    ok:&quot;确定&quot;,
                    //手动输入的参数列表。
                    parameters:[
                        choice(choices:&#39;dev\ntest\nprod&#39;,description:&quot;发布到什么环境？&quot;,name:&quot;ENV&quot;),
                        string(defaultValue:&#39;&#39;,description:&#39;&#39;,name:&#39;myparam&#39;)
                    ],
                    //字符串类型，可以进行操作的用户ID或用户组名，使用“，”分隔，在“，”左右不允许有空格。这在做input步骤的权限控制方面很实用。
                    submitter:&#39;admin,admin2,releaseGroup&#39;,
                    submitterParameter:&#39;APPROVER&#39;
                )
               }
            }
        }
      stage(&#39;deploy&#39;) {
            steps {
                echo &quot;操作者是:${approvalMap[&#39;APPROVER&#39;]}&quot;
                echo &quot;发布到什么环境？ ${approvalMap[&#39;ENV&#39;]}&quot;
                echo &quot;自定义参数: ${approvalMap[&#39;myparam&#39;]}&quot;
            }

      }

    }
}
</pre></div>
</div>
<p>我们在pipeline外定义了一个变量approvalMap。</p>
<p>这是因为定义在阶段内的变量的作用域只在这个阶段中，而input步骤的返回值需要跨阶段使用，所以需要将其定义在pipeline外。这样变量approvalMap的作用域就是整个pipeline了。</p>
<p><img alt="image56" src="../_images/jenkins_202012150005.png" /></p>
<p><img alt="image57" src="../_images/jenkins_202012150006.png" /></p>
</section>
</section>
<section id="id56">
<h3><a class="toc-backref" href="#id151">9.6 小贴士</a><a class="headerlink" href="#id56" title="Permalink to this headline">¶</a></h3>
<section id="id57">
<h4>9.6.1 获取上游pipeline的信息<a class="headerlink" href="#id57" title="Permalink to this headline">¶</a></h4>
<p>遗憾的是，上游pipeline触发下游pipeline时，并没有自动带上自身的信息。所以，当下游pipeline需要使用上游pipeline的信息时，上游pipeline信息就要以参数的方式传给下游pipeline。比如在上游pipeline中调用下游pipeline时，可以采用以下做法。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stage</span> <span class="p">(</span><span class="s1">&#39;Invoke_pipeline&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">steps</span> <span class="p">{</span>
        <span class="n">build</span> <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;pipeline1&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;param1&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">{deploy_env}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;param2&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">{env.JOB_NAME}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;param3&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">{env.BUILD_NUMBER}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id58">
<h4>9.6.2 设置手动输入步骤超时后，pipeline自动中止<a class="headerlink" href="#id58" title="Permalink to this headline">¶</a></h4>
<p>input步骤可以与timeout步骤实现超时自动中止pipeline，防止无限等待。以下pipeline
1分钟后不处理就自动中止。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>
    <span class="n">stages</span><span class="p">{</span>
        <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;deploy&#39;</span><span class="p">){</span>
            <span class="n">steps</span><span class="p">{</span>
                <span class="o">//</span><span class="n">timeout</span><span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="s1">&#39;HOURS&#39;</span><span class="p">)</span>           <span class="o">//</span> <span class="mi">1</span><span class="n">小时等待超时</span>
                <span class="n">timeout</span><span class="p">(</span><span class="n">time</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span><span class="s1">&#39;SECONDS&#39;</span><span class="p">){</span>            <span class="o">//</span> <span class="mi">5</span><span class="n">s钟等待超时</span>
                    <span class="nb">input</span> <span class="n">message</span><span class="p">:</span><span class="s2">&quot;发布或停止&quot;</span>
                <span class="p">}</span>

            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id59">
<h2><a class="toc-backref" href="#id152">10.凭证管理</a><a class="headerlink" href="#id59" title="Permalink to this headline">¶</a></h2>
<section id="id60">
<h3><a class="toc-backref" href="#id153">10.1 为什么要管理凭证</a><a class="headerlink" href="#id60" title="Permalink to this headline">¶</a></h3>
<p>（1）程序员或运维人员不知道如何保护密码。</p>
<p>（2）管理者没有足够重视，否则会给更多的时间让程序员或运维人员想办法隐藏明文密码。</p>
</section>
<section id="id61">
<h3><a class="toc-backref" href="#id154">10.2 凭证是什么</a><a class="headerlink" href="#id61" title="Permalink to this headline">¶</a></h3>
<p>凭证（cridential）是Jenkins进行受限操作时的凭据。比如使用SSH登录远程机器时，用户名和密码或SSH
key就是凭证。</p>
<p>而这些凭证不可能以明文写在Jenkinsfile中。Jenkins凭证管理指的就是对这些凭证进行管理。</p>
</section>
<section id="id62">
<h3><a class="toc-backref" href="#id155">10.3 常用凭证</a><a class="headerlink" href="#id62" title="Permalink to this headline">¶</a></h3>
<p>Jenkins默认支持以下凭证类型：</p>
<ul class="simple">
<li><p>Secret text</p></li>
<li><p>Username with password</p></li>
<li><p>Secret file</p></li>
<li><p>SSH Username with private key</p></li>
<li><p>Certificate：PKCS＃12</p></li>
<li><p>Docker Host Certificate Authentication credentials。</p></li>
<li></li>
</ul>
<section id="secret-text">
<h4>9.3.1 Secret text<a class="headerlink" href="#secret-text" title="Permalink to this headline">¶</a></h4>
<p>Secret text是一串需要保密的文本，比如GitLab的API token。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">withCredentials</span><span class="p">([</span><span class="n">string</span><span class="p">(</span><span class="n">credentialsId</span><span class="p">:</span> <span class="s1">&#39;secretText&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="s1">&#39;varName&#39;</span><span class="p">)])</span> <span class="p">{</span>
    <span class="n">echo</span> <span class="s2">&quot;$</span><span class="si">{varName}</span><span class="s2">&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="username-with-password">
<h4>9.3.2 Username with password<a class="headerlink" href="#username-with-password" title="Permalink to this headline">¶</a></h4>
<p>Username with password指用户和密码凭证</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">withCredentials</span><span class="p">([</span><span class="n">usernamePassword</span><span class="p">(</span><span class="n">credentialsId</span><span class="p">:</span> <span class="s1">&#39;ad0cb5b7-fe4a-4caa-a9d6-2c3f8502bcdd&#39;</span><span class="p">,</span> <span class="n">passwordVariable</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="n">usernameVariable</span><span class="p">:</span> <span class="s1">&#39;username&#39;</span><span class="p">)])</span> <span class="p">{</span>
    <span class="n">echo</span> <span class="s2">&quot;$</span><span class="si">{username}</span><span class="s2">,$</span><span class="si">{password}</span><span class="s2">&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="secret-filesecret-file">
<h4>9.3.3 Secret fileSecret file<a class="headerlink" href="#secret-filesecret-file" title="Permalink to this headline">¶</a></h4>
<p><img alt="image58" src="../_images/jenkins_secret0001.png" /></p>
<p><img alt="image59" src="../_images/jenkins_secret0002.png" /></p>
<p>指需要保密的文本文件。使用Secret
file时，Jenkins会将文件复制到一个临时目录中，再将文件路径设置到一个变量中。构建结束后，所复制的Secret
file会被删除。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">withCredentials</span><span class="p">([</span><span class="n">file</span><span class="p">(</span><span class="n">credentialsId</span><span class="p">:</span> <span class="s1">&#39;ansible-vault-password&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="s1">&#39;vault&#39;</span><span class="p">)])</span> <span class="p">{</span>
    <span class="n">sh</span> <span class="s2">&quot;ansible -i host playbook.yml --vault-password-file=$</span><span class="si">{vault}</span><span class="s2">&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="ssh-username-with-private-key">
<h4>9.3.4 SSH Username with private key<a class="headerlink" href="#ssh-username-with-private-key" title="Permalink to this headline">¶</a></h4>
<p>SSH Username with private key指一对SSH用户名和密钥。</p>
<p>在使用此类凭证时，Jenkins会将SSH
key复制到一个临时目录中，再将文件路径设置到一个变量中。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">withCredentials</span><span class="p">([</span><span class="n">sshUserPrivateKey</span><span class="p">(</span>
                <span class="n">KeyFileVariable</span><span class="p">:</span><span class="s2">&quot;key&quot;</span><span class="p">,</span>
                <span class="n">credentialsId</span><span class="p">:</span><span class="s2">&quot;private-key&quot;</span><span class="p">)])</span> <span class="p">{</span>

    <span class="n">echo</span> <span class="s2">&quot;$</span><span class="si">{key}</span><span class="s2">&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>sshUserPrivateKey函数还支持以下参数。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• usernameVariable：SSH用户名的变量名。

• passphraseVariable：SSH key密码的变量名。
</pre></div>
</div>
</section>
</section>
<section id="id63">
<h3><a class="toc-backref" href="#id156">9.4 优雅地使用凭证</a><a class="headerlink" href="#id63" title="Permalink to this headline">¶</a></h3>
<p>声明式pipeline提供了credentials
helper方法（只能在environment指令中使用）来简化凭证的使用。以下是使用方法。</p>
<section id="secret-text-1">
<span id="id64"></span><h4>Secret text<a class="headerlink" href="#secret-text-1" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">envirinment</span> <span class="p">{</span>
       <span class="n">Aws_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="n">credentials</span><span class="p">(</span><span class="s1">&#39;aws-secret-key-id&#39;</span><span class="p">)</span>
       <span class="n">Aws_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="n">credentials</span><span class="p">(</span><span class="s1">&#39;aws-secret-access-key&#39;</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>AWS-SECRET-KEY-ID和AWS-SECRET-ACCESS-KEY是我们预先定义的凭证ID。</p>
<p>creden-tials方法将凭证的值赋给变量后，我们就可以像使用普通环境变量一样使用它们了，如：<code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">&quot;${AWS</span> <span class="pre">ACCESS</span> <span class="pre">KEY</span> <span class="pre">ID}&quot;</span></code>。</p>
</section>
<section id="username-with-password-1">
<span id="id65"></span><h4>Username with password<a class="headerlink" href="#username-with-password-1" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">envirinment</span> <span class="p">{</span>
       <span class="n">BITBUCKET_CREDS</span> <span class="o">=</span> <span class="n">credentials</span><span class="p">(</span><span class="s1">&#39;jenkins-bitbucket-creds&#39;</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>与 Secret text 不同的是，我们需要通过 BITBUCKET CREDS USR
拿到用户名的值，通过BITBUCKET CREDS PSW拿到密码的值。</p>
<p>而变量BITBUCKET CREDS的值则是一个字符串，格式为：＜用户名&gt;：＜密码&gt;。</p>
</section>
<section id="secret-file">
<h4>Secret file<a class="headerlink" href="#secret-file" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">envirinment</span> <span class="p">{</span>
       <span class="n">KNOWN_HOSTS</span> <span class="o">=</span> <span class="n">credentials</span><span class="p">(</span><span class="s1">&#39;known_hosts&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>通过credentials helper方法，我们可以像使用环境变量一样使用凭证。</p>
<p>但遗憾的是，credentials
helper方法只支持<code class="docutils literal notranslate"><span class="pre">Secret</span> <span class="pre">text</span></code>、<code class="docutils literal notranslate"><span class="pre">Username</span> <span class="pre">withpassword</span></code>、<code class="docutils literal notranslate"><span class="pre">Secret</span> <span class="pre">file</span></code>三种凭证。</p>
</section>
</section>
<section id="hashicorp-vault">
<h3><a class="toc-backref" href="#id157">9.5 使用HashiCorp Vault</a><a class="headerlink" href="#hashicorp-vault" title="Permalink to this headline">¶</a></h3>
<p>如果觉得Jenkins的凭证管理功能太弱，无法满足你的需求，则可以考虑使用HashiCorp
Vault。</p>
<p>在此省略，使用不是很多。</p>
</section>
<section id="id66">
<h3><a class="toc-backref" href="#id158">9.6 在Jenkins日志中隐藏敏感信息</a><a class="headerlink" href="#id66" title="Permalink to this headline">¶</a></h3>
<p>Jenkins pipeline 避免使用明文密码的方法</p>
<p><a class="reference external" href="https://blog.csdn.net/qq_31977125/article/details/83861714">https://blog.csdn.net/qq_31977125/article/details/83861714</a></p>
<p>我有一个基于的参数化Jenkins管道<code class="docutils literal notranslate"><span class="pre">Jenkinsfile</span></code>。一些参数包含敏感的密码，我不想出现在作业的构建日志中。</p>
<p>所以我的问题是：我可以在其中以某种方式注册一个String
<code class="docutils literal notranslate"><span class="pre">Jenkinsfile</span></code>，然后<code class="docutils literal notranslate"><span class="pre">**********</span></code>每当它出现在日志输出中时，由它代替吗？</p>
<p>我知道此<code class="docutils literal notranslate"><span class="pre">withCredentials</span></code>步骤，但是我不能使用它，因为凭据没有存储在Jenkins凭据存储中（而是在运行时作为参数提供）。</p>
<p>我在这里找到了这个答案，并像这样尝试：</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="kt">def</span> <span class="n">secrets</span> <span class="o">=</span> <span class="o">[</span>
    <span class="o">[</span><span class="nl">password:</span> <span class="n">firstPassword</span><span class="o">,</span> <span class="nl">var:</span> <span class="s1">&#39;SECRET&#39;</span><span class="o">],</span>
    <span class="o">[</span><span class="nl">password:</span> <span class="n">secondPassword</span><span class="o">,</span> <span class="nl">var:</span> <span class="s1">&#39;SECRET&#39;</span><span class="o">],</span>
    <span class="o">[</span><span class="nl">password:</span> <span class="n">thirdPassword</span><span class="o">,</span> <span class="nl">var:</span> <span class="s1">&#39;SECRET&#39;</span><span class="o">]</span>
<span class="o">]</span>

<span class="n">node</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">wrap</span><span class="o">([</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;MaskPasswordsBuildWrapper&#39;</span><span class="o">,</span> <span class="nl">varPasswordPairs:</span> <span class="n">secrets</span><span class="o">])</span> <span class="o">{</span>
        <span class="c1">// my stages containing steps...</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id67">
<h2><a class="toc-backref" href="#id159">10.制品管理</a><a class="headerlink" href="#id67" title="Permalink to this headline">¶</a></h2>
</section>
<section id="id68">
<h2><a class="toc-backref" href="#id160">11.自动化部署</a><a class="headerlink" href="#id68" title="Permalink to this headline">¶</a></h2>
<section id="id69">
<h3><a class="toc-backref" href="#id161">11.1 关于部署有什么好说的</a><a class="headerlink" href="#id69" title="Permalink to this headline">¶</a></h3>
<section id="id70">
<h4>11.1.1 部署不等于发布<a class="headerlink" href="#id70" title="Permalink to this headline">¶</a></h4>
<p>用通俗的话来说，部署就是将应用服务软件“放”在远程服务器上，但是并不代表真正的用户可以看到这些新功能。当用户能看到这些新功能时，才代表发布了新功能。</p>
<p>通过一些技术，即使把最新的应用服务软件“放”到服务器上，但是用户也看不到这些功能。</p>
<p>这些技术就像是开关一样，能在后台控制开和关。只要打开某个功能的“开关”，这个功能就可以呈现给用户。</p>
</section>
<section id="id71">
<h4>11.1.2 什么是自动化部署<a class="headerlink" href="#id71" title="Permalink to this headline">¶</a></h4>
<p>部署逻辑，我们可以使用shell来描述，也可以使用Python来描述。但是，不论是使用shell还是使用Python，都太过于原始。就像使用汇编语言来开发一个HR系统，虽然可以实现，但是效率和成本都没有办法保证。</p>
<p>所以，有人开发了Puppet、Chef、Ansible等这类表达力更强的自动化运维工具。我们使用这些工具提供的运维领域的特定语言来描述部署逻辑，而自动化逻辑就交给了这些工具来实现。</p>
</section>
<section id="id72">
<h4>11.1.3 自动化运维工具解决的问题<a class="headerlink" href="#id72" title="Permalink to this headline">¶</a></h4>
<p>Ansible</p>
</section>
</section>
<section id="jenkinsansible">
<h3><a class="toc-backref" href="#id162">11.2 Jenkins集成Ansible实现自动化部署</a><a class="headerlink" href="#jenkinsansible" title="Permalink to this headline">¶</a></h3>
<section id="id73">
<h4>11.2.1 Ansible介绍<a class="headerlink" href="#id73" title="Permalink to this headline">¶</a></h4>
<p>Ansible采用了与Puppet、Chef不一样的解决方案，不需要在受控机器上安装额外的客户端软件。原因是Ansible使用的是SSH协议与受控机器进行通信的，一般服务器默认有SSH服务。Ansible也因此被称为agentless（去客户端的）。</p>
<p>Ansible也不像Puppet、Chef那样需要在一台相对稳定的机器上安装一个主控程序，好让所有的受控机器连接上来。只要是安装了Ansible的机器就可以作为主控机器，比如工作时用的电脑。</p>
<p>Puppet和Chef都自己做了一套DSL，而Ansible使用YAML格式作为自己的DSL格式。</p>
<p>所以相对Puppet、Chef，Ansible简单得多。</p>
<p>Ansible的隐喻了解Ansible的隐喻，对于了解Ansible背后的设计有一定的帮助。</p>
<p>Ansible的隐喻很简单：Ansible是导演，受控机器列表（inventory）为演员列表，开发者则是编剧。开发者只要把剧本（playbook.yml）写好，Ansible拿着剧本与invenstory一对上号，演员就会按照剧本如实表演，不会有任何个人发挥。</p>
</section>
<section id="id74">
<h4>11.2.2 Jenkins与Ansible集成<a class="headerlink" href="#id74" title="Permalink to this headline">¶</a></h4>
<p>Jenkins与Ansible集成能让Jenkins执行ansible命令。</p>
<p>是具体步骤如下：</p>
<p>（1）安装Ansible插件（<a class="reference external" href="https://plugins.jenkins.io/ansible">https://plugins.jenkins.io/ansible</a>）。</p>
<p>（2）在主控机器上安装 Ansible，并设置不进行 host key
检查。主控机器指的是真正执行ansible命令的机器，也就是Jenkins。我们需要在主控机器上自行安装Asible，然后修改主控机器的Ansible配置，不进行host
key检查。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@jenkins</span><span class="p">:</span><span class="o">/</span><span class="c1"># cat /etc/ansible/ansible.cfg</span>
<span class="p">[</span><span class="n">defaults</span><span class="p">]</span>
<span class="n">host_key_checking</span><span class="o">=</span><span class="kc">False</span>
</pre></div>
</div>
<p>如果要求安全级别高，则应该提前将所有受控机器的fingerprint放到主控机器的know_hosts文件中。</p>
<p>（3）在Jenkins上进入Manage Jenkins→Global Tool
Configuration→Ansible配置页面，配置Ansible的执行路径</p>
<p><img alt="image60" src="../_images/jenkins_ansible0004.png" /></p>
<p>（5）在pipeline中加入ansiblePlaybook步骤。</p>
<p>部署项目的目录结构如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tree -L 3
.
├── deploy
│   ├── group_vars
│   │   └── vars.yml
│   ├── hosts
│   ├── playbook.yml
│   └── role
├── Jenkinsfile
├── push_master.sh
└── README.md
</pre></div>
</div>
<p>hosts文件内容如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">example</span><span class="p">]</span>
<span class="mf">192.168.1.31</span> <span class="n">ansible_ssh_port</span><span class="o">=</span><span class="mi">222</span> <span class="n">ansible_ssh_user</span><span class="o">=</span><span class="n">git</span> <span class="n">ansible_ssh_pass</span><span class="o">=</span><span class="n">China</span><span class="o">@</span><span class="mi">2020</span>
</pre></div>
</div>
<p>playbook.yml文件内容如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>

<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">example</span>
  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">debug</span><span class="p">:</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;env&#39;,&#39;BUILD_TAG&#39;) }}&quot;</span>
</pre></div>
</div>
<p>Jenkinsfile的内容如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="p">{</span>
    <span class="n">agent</span> <span class="nb">any</span>

    <span class="n">stages</span><span class="p">{</span>
    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;Deploy&#39;</span><span class="p">){</span>
        <span class="n">steps</span><span class="p">{</span>
            <span class="n">ansiblePlaybook</span><span class="p">(</span>
                <span class="n">playbook</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">{env.WORKSPACE}</span><span class="s2">/deploy/playbook.yml&quot;</span><span class="p">,</span>
                <span class="n">inventory</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">{env.WORKSPACE}</span><span class="s2">/deploy/hosts&quot;</span><span class="p">,</span>
                <span class="n">credentialsId</span><span class="p">:</span> <span class="s1">&#39;vagrant&#39;</span>
                <span class="p">)</span>

    <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>


<span class="p">}</span>
</pre></div>
</div>
<p>ansiblePlaybook步骤执行的是ansible-playbook命令，其中playbook参数是playook文件的路径，inventory参数是inventory文件的路径，credentialsId参数就是在上一步中添加的凭证ID。</p>
<p>最后打印日志如下：</p>
<p><img alt="image61" src="../_images/jenkins_ansible0005.png" /></p>
<p>这样，Jenkins与Ansible的集成就算完成了。但是这只是刚刚开始，在实际工作中，我们还需要考虑自定义的公共role应该放在哪里等与Ansible相关的问题。</p>
<p>我们来看一下完整的代码示例</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pipeline{
    agent any

    stages{
        stage(&#39;Syntax check ansible playbook&#39;){
            steps{
                ansiblePlaybook(
                disableHostKeyChecking: true,           //是否进行host key检查
                playbook: &quot;${env.WORKSPACE}/deploy/playbook.yml&quot;,
                inventory: &quot;${env.WORKSPACE}/deploy/hosts&quot;,
                credentialsId: &#39;vagrant&#39;,
                extras: &#39;--syntax-check&#39;
                )

        }
        }

        stage(&#39;Deploy&#39;){
            steps{
                ansiblePlaybook(
                    playbook: &quot;${env.WORKSPACE}/deploy/playbook.yml&quot;,
                    inventory: &quot;${env.WORKSPACE}/deploy/hosts&quot;,
                    credentialsId: &#39;vagrant&#39;,
                    forks: 2,               // 进程数
                    limit: &#39;example&#39;        //指定执行的主机。相当于ansible命令行的-l参数
                    //tags                       //指定执行打上特定tag的任务。它相当于ansible命令行的-t参数。多个tag之间使用逗号分隔。
                    //skippedTags               // skip-tags
                    //startAtTask               // 从指定任务开始执行。它相当于ansible命令行的--start-at-task参数。
                    //become：布尔类型，在执行操作时是否加上sudo。它相当于ansible命令行的--become参数。
                    //extraVars：List＜org.jenkinsci.plugins.ansible.ExtraVar&gt;类型，扩展变量。它相当于ansible命令行的-e参数。使用它的方式比较特殊，
                    )

        }
    }
  }
}
</pre></div>
</div>
<p><strong>ansibleVault步骤</strong></p>
<p>放在配置文件中的MySQL连接密码，想必是不希望被所有人看见的。Ansiblevault是Ansible的一个特性，它能帮助我们加解密配置文件或者某个配置项。</p>
<p>在ansiblePlaybook步骤中，vaultCredentialsId参数的作用就是，在ansible-playbook执行过程中，会对事先放在playbook中的密文进行解密，解密需要密码，vaultCredentialsId就是我们事先存储在Jenkins中的密码的凭证ID。</p>
<p>而ansibleVault步骤所做的事情就是执行Ansible提供的ansible-vault命令。该命令通常用于对敏感数据进行加解密。</p>
<p>这里不进行展开。</p>
<p>另外一种方式：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sh</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">ansible-playbook --syntax-check deploy/playbook.yaml -i env-conf/dev</span>
<span class="s2">ansible-playbook deploy/playbook.yaml -i env-conf/dev --extra-vars &#39;{&quot;app_version&quot;: &quot;$</span><span class="si">{APP_VERSION}</span><span class="s2">&quot;}&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="id75">
<h3><a class="toc-backref" href="#id163">11.3 手动部署比自动化部署更可靠吗</a><a class="headerlink" href="#id75" title="Permalink to this headline">¶</a></h3>
<p>可靠的是人，自动部署实现了一个可靠的人。</p>
</section>
<section id="id76">
<h3><a class="toc-backref" href="#id164">11.4 如何开始自动化部署</a><a class="headerlink" href="#id76" title="Permalink to this headline">¶</a></h3>
<p>总结一下如何开始自动化部署：</p>
<p>（1）选择从可以独立部署的、影响范围小的服务开始。</p>
<p>（2）要想办法使用标准化的新机器，而不是旧机器。</p>
<p>（3）自动化所有的部署操作，包括机器级别的设置。</p>
<p>（4）重复以上三个步骤。</p>
<section id="id77">
<span id="id78"></span><h4>小贴士<a class="headerlink" href="#id77" title="Permalink to this headline">¶</a></h4>
<p>在现实环境中，对不同环境下的机器可能使用不同的登录方式，甚至对同一个环境下的不同机器也会使用不同的登录方式。使用Ansible的host变量，我们就可以轻松实现对不同机器使用不同的登录方式。</p>
<p>目录结构：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tree -L 3
.
├── deploy
│   ├── group_vars
│   │   └── vars.yml
│   ├── host_var
│   │   └── 192.168.1.31.yml
│   ├── hosts
│   ├── playbook.yml
│   ├── playbook_base.yml
│   └── role
├── Jenkinsfile
├── Jenkinsfile-base
├── push_master.sh
└── README.md
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">host_var/192.168.1.31.yml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible_ssh_user</span><span class="p">:</span> <span class="n">vagrant</span>
<span class="n">ansible_become_method</span><span class="p">:</span> <span class="n">sudo</span>
<span class="n">ansuble_ssh_pass</span><span class="p">:</span> <span class="n">admin</span><span class="c1">#123</span>
</pre></div>
</div>
<p>内容是YAML格式的。</p>
<p>其中ansible_ssh_user和，ansible_ssh_pass变量分别指SSH的用户名和密码；</p>
<p>ansible_become_method变量指执行任务时切换权限的方法。</p>
</section>
</section>
</section>
<section id="id79">
<h2><a class="toc-backref" href="#id165">12.通知</a><a class="headerlink" href="#id79" title="Permalink to this headline">¶</a></h2>
<section id="id80">
<h3><a class="toc-backref" href="#id166">12.1 邮件通知</a><a class="headerlink" href="#id80" title="Permalink to this headline">¶</a></h3>
<p>jenkins配置邮件参考：</p>
<p><a class="reference external" href="https://www.cnblogs.com/imyalost/p/8781759.html">https://www.cnblogs.com/imyalost/p/8781759.html</a></p>
<p>对于V2.61或更高版本，可以通过单选按钮进行配置</p>
<p>转到<code class="docutils literal notranslate"><span class="pre">管理Jenkins-&gt;配置系统-&gt;扩展电子邮件通知</span></code></p>
<p>并勾选<strong>允许发送给未注册用户的单选按钮</strong></p>
<p>配置方法如下所示：</p>
<p><img alt="image62" src="../_images/jenkins_sendm0001.png" /></p>
<p><img alt="image63" src="../_images/jenkins_sendm0002.png" /></p>
<p><img alt="image64" src="../_images/jenkins_sendm0004.png" /></p>
<p>必须点击测试成功，表示邮件可以正常发送。</p>
<p>参考文献：</p>
<p><a class="reference external" href="https://www.linuxea.com/1767.html">https://www.linuxea.com/1767.html</a></p>
<p><a class="reference external" href="https://www.e-learn.cn/topic/3357265">https://www.e-learn.cn/topic/3357265</a></p>
<p>jenkinsfile示例</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pipeline {
    agent any
    environment {
    def ITEMNAME = &quot;webapp&quot;
    def DESTPATH = &quot;/data/wwwroot&quot;
    def SRCPATH = &quot;~/workspace/test&quot;
    def BUILD_USER = &quot;mark&quot;
    def USERMAIL = &quot;962057147@qq.com&quot;
    }

    stages {
        stage(&#39;代码拉取&#39;){
            steps {
                echo &quot;code pull..........................&quot;
                sh &quot;sleep 2&quot;
                    }
                    }
        stage(&#39;服务检查&#39;) {
            steps {
                echo &quot;检查nginx进程是否存在&quot;
                sh &quot;sleep 2&quot;
                    }
                    }
        stage(&#39;目录检查&#39;) {
            steps {
                echo &quot;检查${DESTPATH}目录是否存在&quot;
                sh &quot;sleep 2&quot;
                    }
                    }
                    }
    post {
        success {
            emailext (
                subject: &quot;&#39;${env.JOB_NAME} [${env.BUILD_NUMBER}]&#39; 更新正常&quot;,
                body: &quot;&quot;&quot;
                &lt;hr/&gt;
                详情：
                SUCCESSFUL: Job &#39;${env.JOB_NAME} [${env.BUILD_NUMBER}]&#39;
                &lt;hr/&gt;
                状态：${env.JOB_NAME} jenkins 更新运行正常
                &lt;hr/&gt;
                URL ：${env.BUILD_URL}
                &lt;hr/&gt;
                项目名称 ：${env.JOB_NAME}
                &lt;hr/&gt;
                项目更新进度：${env.BUILD_NUMBER}
                &lt;hr/&gt;
                &quot;&quot;&quot;,
                to: &quot;${USERMAIL}&quot;,
                recipientProviders: [[$class: &#39;DevelopersRecipientProvider&#39;]]
                )
                }
        failure {
            emailext (
                subject: &quot;&#39;${env.JOB_NAME} [${env.BUILD_NUMBER}]&#39; 更新异常&quot;,
                body: &quot;&quot;&quot;
                &lt;hr/&gt;
                详情：
                &lt;hr/&gt;
                SUCCESSFUL: Job &#39;${env.JOB_NAME} [${env.BUILD_NUMBER}]&#39;
                &lt;hr/&gt;
                状态：${env.JOB_NAME} jenkins 更新运行异常
                &lt;hr/&gt;
                URL ：${env.BUILD_URL}
                &lt;hr/&gt;
                项目名称 ：${env.JOB_NAME}
                &lt;hr/&gt;
                项目更新进度：${env.BUILD_NUMBER}
                &lt;hr/&gt;
                &quot;&quot;&quot;,
                to: &quot;${USERMAIL}&quot;,
                recipientProviders: [[$class: &#39;DevelopersRecipientProvider&#39;]]
                )
                }
                }
}
</pre></div>
</div>
<p>查看邮箱信息如下：</p>
<p><img alt="image65" src="../_images/jenkins_email00001.png" /></p>
<p>jenkins示例2</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="p">{</span>
  <span class="n">agent</span> <span class="nb">any</span>
      <span class="n">environment</span> <span class="p">{</span>
        <span class="n">gitpullerr</span> <span class="o">=</span> <span class="s1">&#39;noerr&#39;</span>
        <span class="n">sendmail</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="n">jenkins_url</span> <span class="o">=</span> <span class="s2">&quot;$</span><span class="si">{JENKINS_URL}</span><span class="s2">&quot;</span>
        <span class="n">job_url</span> <span class="o">=</span> <span class="s2">&quot;$</span><span class="si">{JOB_URL}</span><span class="s2">&quot;</span>
        <span class="n">build_number</span> <span class="o">=</span> <span class="s2">&quot;$</span><span class="si">{BUILD_NUMBER}</span><span class="s2">&quot;</span>
        <span class="n">TO_SERND</span> <span class="o">=</span> <span class="s2">&quot;962057147@qq.com&quot;</span>

    <span class="p">}</span>

  <span class="n">triggers</span> <span class="p">{</span>
    <span class="n">GenericTrigger</span><span class="p">(</span>
     <span class="n">genericVariables</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">[</span><span class="n">key</span><span class="p">:</span> <span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="s1">&#39;$.ref&#39;</span><span class="p">],</span>
      <span class="o">//</span><span class="p">[</span><span class="n">key</span><span class="p">:</span> <span class="s1">&#39;fixversion&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="s1">&#39;$.issue.fields.customfield_10415&#39;</span><span class="p">]</span>
     <span class="p">],</span>
     <span class="n">token</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">{env.JOB_NAME}</span><span class="s2">&quot;</span><span class="p">,</span>
     <span class="n">printContributedVariables</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
     <span class="n">printPostContent</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
     <span class="n">silentResponse</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
     <span class="n">regexpFilterText</span><span class="p">:</span> <span class="s1">&#39;$ref&#39;</span><span class="p">,</span>
     <span class="n">regexpFilterExpression</span><span class="p">:</span> <span class="s1">&#39;.*/(master|dev)&#39;</span>
    <span class="p">)</span>
  <span class="p">}</span>
  <span class="n">stages</span> <span class="p">{</span>
    <span class="n">stage</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">steps</span> <span class="p">{</span>
        <span class="n">echo</span> <span class="s2">&quot;Running job name: $</span><span class="si">{env.JOB_NAME}</span><span class="s2">&quot;</span>
        <span class="n">sh</span> <span class="s2">&quot;echo $ref&quot;</span>
        <span class="n">sh</span> <span class="s2">&quot;sleep 3&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">post</span> <span class="p">{</span>
        <span class="n">success</span> <span class="p">{</span>
            <span class="n">script</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sendmail</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">emailext</span> <span class="n">body</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;&lt;!DOCTYPE html&gt;</span>
<span class="s1">&lt;html&gt;</span>
<span class="s1">&lt;head&gt;</span>
<span class="s1">&lt;meta charset=&quot;UTF-8&quot;&gt;</span>
<span class="s1">&lt;/head&gt;</span>
<span class="s1">    &lt;body leftmargin=&quot;8&quot; marginwidth=&quot;0&quot; topmargin=&quot;8&quot; marginheight=&quot;4&quot;</span>
<span class="s1">    offset=&quot;0&quot;&gt;</span>
<span class="s1">    &lt;table width=&quot;95%&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;</span>
<span class="s1">        style=&quot;font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif&quot;&gt;</span>
<span class="s1">        &lt;tr&gt;</span>
<span class="s1">            &lt;td&gt;&lt;br /&gt;</span>
<span class="s1">            &lt;b&gt;&lt;font color=&quot;#0B610B&quot;&gt;构建信息&lt;/font&gt;&lt;/b&gt;</span>
<span class="s1">            &lt;hr size=&quot;2&quot; width=&quot;100%&quot; align=&quot;center&quot; /&gt;&lt;/td&gt;</span>
<span class="s1">        &lt;/tr&gt;</span>
<span class="s1">        &lt;tr&gt;</span>
<span class="s1">            &lt;td&gt;</span>
<span class="s1">                &lt;ul&gt;</span>
<span class="s1">                    &lt;li&gt;构建名称：$</span><span class="si">{JOB_NAME}</span><span class="s1">&lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;触发原因： $</span><span class="si">{CAUSE}</span><span class="s1">&lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;构建结果: &lt;span style=&quot;color:green&quot;&gt; $</span><span class="si">{BUILD_STATUS}</span><span class="s1">&lt;/span&gt;&lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;构建编号：$</span><span class="si">{BUILD_NUMBER}</span><span class="s1">  &lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;Jenkins_URL 地址：$</span><span class="si">{jenkins_url}</span><span class="s1">&lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;项目  Url ： &lt;a href=&quot;$</span><span class="si">{PROJECT_URL}</span><span class="s1">&quot;&gt;$</span><span class="si">{PROJECT_URL}</span><span class="s1">&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;工作目录 ： &lt;a href=&quot;$</span><span class="si">{PROJECT_URL}</span><span class="s1">ws&quot;&gt;$</span><span class="si">{PROJECT_URL}</span><span class="s1">ws&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;变更记录: ${CHANGES,showPaths=true,showDependencies=true,format=&quot;&lt;pre&gt;&lt;ul&gt;&lt;li&gt;提交ID: </span><span class="si">%r</span><span class="s1">&lt;/li&gt;&lt;li&gt;提交人：</span><span class="si">%a</span><span class="s1">&lt;/li&gt;&lt;li&gt;提交时间：</span><span class="si">%d</span><span class="s1">&lt;/li&gt;&lt;li&gt;提交信息：%m&lt;/li&gt;&lt;li&gt;提交文件：&lt;br /&gt;%p&lt;/li&gt;&lt;/ul&gt;&lt;/pre&gt;&quot;,pathFormat=&quot;         %p &lt;br /&gt;&quot;}</span>
<span class="s1">                &lt;/ul&gt;</span>
<span class="s1">            &lt;/td&gt;</span>
<span class="s1">        &lt;/tr&gt;</span>
<span class="s1">        &lt;tr&gt;</span>
<span class="s1">            &lt;td&gt;&lt;b&gt;&lt;font color=&quot;#0B610B&quot;&gt;构建日志 :&lt;/font&gt;&lt;/b&gt;</span>
<span class="s1">            &lt;hr size=&quot;2&quot; width=&quot;100%&quot; align=&quot;center&quot; /&gt;&lt;/td&gt;</span>
<span class="s1">        &lt;/tr&gt;</span>
<span class="s1">        &lt;tr&gt;</span>
<span class="s1">            &lt;td&gt;&lt;textarea cols=&quot;150&quot; rows=&quot;30&quot; readonly=&quot;readonly&quot;</span>
<span class="s1">                    style=&quot;font-family: Courier New&quot;&gt;$</span><span class="si">{BUILD_LOG}</span><span class="s1">&lt;/textarea&gt;</span>
<span class="s1">            &lt;/td&gt;</span>
<span class="s1">        &lt;/tr&gt;</span>
<span class="s1">                &lt;tr&gt;</span>
<span class="s1">            &lt;td&gt;&lt;b&gt;&lt;font color=&quot;#0B610B&quot;&gt;变更集&lt;/font&gt;&lt;/b&gt;</span>
<span class="s1">            &lt;hr size=&quot;2&quot; width=&quot;100%&quot; align=&quot;center&quot; /&gt;&lt;/td&gt;</span>
<span class="s1">        &lt;/tr&gt;</span>

<span class="s1">        &lt;tr&gt;</span>
<span class="s1">            &lt;td&gt;${JELLY_SCRIPT,template=&quot;html&quot;}&lt;br/&gt;</span>
<span class="s1">            &lt;hr size=&quot;2&quot; width=&quot;100%&quot; align=&quot;center&quot; /&gt;&lt;/td&gt;</span>
<span class="s1">        &lt;/tr&gt;</span>
<span class="s1">    &lt;/table&gt;</span>
<span class="s1">&lt;/body&gt;</span>
<span class="s1">&lt;/html&gt;</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="s1">&#39;$</span><span class="si">{PROJECT_NAME}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">{TO_SERND}</span><span class="s2">&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">failure</span> <span class="p">{</span>

            <span class="n">script</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">gitpullerr</span> <span class="o">==</span> <span class="s1">&#39;noerr&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">emailext</span> <span class="n">body</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;&lt;!DOCTYPE html&gt;</span>
<span class="s1">&lt;html&gt;</span>
<span class="s1">&lt;head&gt;</span>
<span class="s1">&lt;meta charset=&quot;UTF-8&quot;&gt;</span>
<span class="s1">&lt;/head&gt;</span>
<span class="s1">&lt;body leftmargin=&quot;8&quot; marginwidth=&quot;0&quot; topmargin=&quot;8&quot; marginheight=&quot;4&quot;</span>
<span class="s1">    offset=&quot;0&quot;&gt;</span>
<span class="s1">    &lt;table width=&quot;95%&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;</span>
<span class="s1">        style=&quot;font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif&quot;&gt;</span>
<span class="s1">        &lt;tr&gt;</span>
<span class="s1">            &lt;td&gt;&lt;br /&gt;</span>
<span class="s1">            &lt;b&gt;&lt;font color=&quot;#0B610B&quot;&gt;构建信息&lt;/font&gt;&lt;/b&gt;</span>
<span class="s1">            &lt;hr size=&quot;2&quot; width=&quot;100%&quot; align=&quot;center&quot; /&gt;&lt;/td&gt;</span>
<span class="s1">        &lt;/tr&gt;</span>
<span class="s1">        &lt;tr&gt;</span>
<span class="s1">            &lt;td&gt;</span>
<span class="s1">                &lt;ul&gt;</span>
<span class="s1">                    &lt;li&gt;构建名称：$</span><span class="si">{JOB_NAME}</span><span class="s1">&lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;触发原因： $</span><span class="si">{CAUSE}</span><span class="s1">&lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;构建结果: &lt;span style=&quot;color:red&quot;&gt; $</span><span class="si">{BUILD_STATUS}</span><span class="s1">&lt;/span&gt;&lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;构建编号：$</span><span class="si">{build_number}</span><span class="s1">  &lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;Jenkins_URL 地址：$</span><span class="si">{jenkins_url}</span><span class="s1">&lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;项目  Url ： &lt;a href=&quot;$</span><span class="si">{PROJECT_URL}</span><span class="s1">&quot;&gt;$</span><span class="si">{PROJECT_URL}</span><span class="s1">&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;工作目录 ： &lt;a href=&quot;$</span><span class="si">{PROJECT_URL}</span><span class="s1">ws&quot;&gt;$</span><span class="si">{PROJECT_URL}</span><span class="s1">ws&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">                    &lt;li&gt;变更记录: ${CHANGES,showPaths=true,showDependencies=true,format=&quot;&lt;pre&gt;&lt;ul&gt;&lt;li&gt;提交ID: </span><span class="si">%r</span><span class="s1">&lt;/li&gt;&lt;li&gt;提交人：</span><span class="si">%a</span><span class="s1">&lt;/li&gt;&lt;li&gt;提交时间：</span><span class="si">%d</span><span class="s1">&lt;/li&gt;&lt;li&gt;提交信息：%m&lt;/li&gt;&lt;li&gt;提交文件：%p&lt;/li&gt;&lt;/ul&gt;&lt;/pre&gt;&quot;,pathFormat=&quot;%p &lt;br /&gt;&quot;}</span>
<span class="s1">                &lt;/ul&gt;</span>
<span class="s1">            &lt;/td&gt;</span>
<span class="s1">        &lt;/tr&gt;</span>
<span class="s1">        &lt;tr&gt;</span>
<span class="s1">            &lt;td&gt;&lt;b&gt;&lt;font color=&quot;#0B610B&quot;&gt;构建日志 :&lt;/font&gt;&lt;/b&gt;</span>
<span class="s1">            &lt;hr size=&quot;2&quot; width=&quot;100%&quot; align=&quot;center&quot; /&gt;&lt;/td&gt;</span>
<span class="s1">        &lt;/tr&gt;</span>
<span class="s1">        &lt;tr&gt;</span>
<span class="s1">            &lt;td&gt;&lt;b&gt;&lt;font color=&quot;#0B610B&quot;&gt;变更集&lt;/font&gt;&lt;/b&gt;</span>
<span class="s1">            &lt;hr size=&quot;2&quot; width=&quot;100%&quot; align=&quot;center&quot; /&gt;&lt;/td&gt;</span>
<span class="s1">        &lt;/tr&gt;</span>

<span class="s1">        &lt;tr&gt;</span>
<span class="s1">            &lt;td&gt;${JELLY_SCRIPT,template=&quot;html&quot;}&lt;br/&gt;</span>
<span class="s1">            &lt;hr size=&quot;2&quot; width=&quot;100%&quot; align=&quot;center&quot; /&gt;&lt;/td&gt;</span>
<span class="s1">        &lt;/tr&gt;</span>
<span class="s1">    &lt;/table&gt;</span>
<span class="s1">&lt;/body&gt;</span>
<span class="s1">&lt;/html&gt;</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="s1">&#39;$</span><span class="si">{PROJECT_NAME}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="s2">&quot;$</span><span class="si">{TO_SERND}</span><span class="s2">&quot;</span>
            <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
                <span class="n">echo</span> <span class="s1">&#39;scm pull error ignore send mail&#39;</span>
            <span class="p">}</span>

        <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><img alt="image66" src="../_images/jenkins_mail0003.png" /></p>
<p>Editable Email Notification邮件正文模板1</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot;&gt;
&lt;title&gt;${ENV, var=&quot;JOB_NAME&quot;}-第${BUILD_NUMBER}次构建日志&lt;/title&gt;
&lt;/head&gt;

&lt;body leftmargin=&quot;8&quot; marginwidth=&quot;0&quot; topmargin=&quot;8&quot; marginheight=&quot;4&quot;
    offset=&quot;0&quot;&gt;
    &lt;table width=&quot;95%&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;
        style=&quot;font-size: 14pt; font-family: Tahoma, Arial, Helvetica, sans-serif&quot;&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;br /&gt;
            &lt;b&gt;&lt;font color=&quot;#0B610B&quot;&gt;构建信息&lt;/font&gt;&lt;/b&gt;
            &lt;hr size=&quot;2&quot; width=&quot;100%&quot; align=&quot;center&quot; /&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;
                &lt;ul&gt;
                    &lt;li&gt;项目名称 ： ${PROJECT_NAME}&lt;/li&gt;
                    &lt;li&gt;构建编号 ： 第${BUILD_NUMBER}次构建&lt;/li&gt;
                    &lt;li&gt;触发原因： ${CAUSE}&lt;/li&gt;
                    &lt;li&gt;构建日志： &lt;a href=&quot;${BUILD_URL}console&quot;&gt;${BUILD_URL}console&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;构建  Url ： &lt;a href=&quot;${BUILD_URL}&quot;&gt;${BUILD_URL}&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;工作目录 ： &lt;a href=&quot;${PROJECT_URL}ws&quot;&gt;${PROJECT_URL}ws&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;项目  Url ： &lt;a href=&quot;${PROJECT_URL}&quot;&gt;${PROJECT_URL}&lt;/a&gt;&lt;/li&gt;
                &lt;/ul&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;&lt;font color=&quot;#0B610B&quot;&gt;变更集&lt;/font&gt;&lt;/b&gt;
            &lt;hr size=&quot;2&quot; width=&quot;100%&quot; align=&quot;center&quot; /&gt;&lt;/td&gt;
        &lt;/tr&gt;

        &lt;tr&gt;
            &lt;td&gt;${JELLY_SCRIPT,template=&quot;html&quot;}&lt;br/&gt;
            &lt;hr size=&quot;2&quot; width=&quot;100%&quot; align=&quot;center&quot; /&gt;&lt;/td&gt;
        &lt;/tr&gt;


    &lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>Editable Email Notification邮件正文模板2</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot;&gt;
&lt;title&gt;${ENV, var=&quot;JOB_NAME&quot;}-第${BUILD_NUMBER}次构建日志&lt;/title&gt;
&lt;/head&gt;

&lt;body leftmargin=&quot;8&quot; marginwidth=&quot;0&quot; topmargin=&quot;8&quot; marginheight=&quot;4&quot;
    offset=&quot;0&quot;&gt;
    &lt;h3&gt;以下是Jenkins自动发送的邮件，请勿回复！&lt;/h3&gt;
    &lt;div&gt;
    &lt;table width=&quot;95%&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;
        style=&quot;font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif&quot;&gt;
        &lt;tr&gt;
            &lt;th&gt;&lt;br /&gt;
                &lt;h2&gt;构建信息&lt;/h2&gt;
            &lt;/th&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;
                &lt;ul&gt;
                    &lt;li&gt;项目名称 ： ${PROJECT_NAME}&lt;/li&gt;&lt;br /&gt;
            &lt;li&gt;测试报告 ： &lt;a href=&quot;${PROJECT_URL}HTMLReport&quot;&gt;${PROJECT_URL}HTMLReport&lt;/a&gt;&lt;/li&gt;&lt;br /&gt;
                    &lt;li&gt;触发原因： ${CAUSE}&lt;/li&gt;&lt;br /&gt;
                    &lt;li&gt;项目  Url ： &lt;a href=&quot;${PROJECT_URL}&quot;&gt;${PROJECT_URL}&lt;/a&gt;&lt;/li&gt;&lt;br /&gt;
                &lt;/ul&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/table&gt;
    &lt;/div&gt;
    &lt;div&gt;
    &lt;table&gt;
        &lt;tr&gt;
            &lt;th&gt;&lt;br /&gt;
            &lt;h2&gt;测试报告&lt;/h2&gt;
            &lt;/th&gt;
        &lt;/tr&gt;

        &lt;tr&gt;
            &lt;td&gt;
                &lt;div&gt;${FILE ,path=&quot;/home/Jenkins/workspace/jobName/results/${BUILD_NUMBER}/TestReport.html&quot;}&lt;/div&gt;
            &lt;/td&gt;
        &lt;/tr&gt;

    &lt;/table&gt;
    &lt;/div&gt;

  &lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p><a class="reference external" href="https://www.cnblogs.com/zz0412/p/jenkins_jj_02.html%5Bhttps://www.cnblogs.com/zz0412/p/jenkins_jj_02.html">email-ext邮件通知模板</a></p>
<p>关于完整的收件人列表类型，可以参考官方文档：<a class="reference external" href="https://jenkins.io/doc/pipeline/steps/email-ext/">https://jenkins.io/doc/pipeline/steps/email-ext/</a></p>
</section>
<section id="id81">
<h3><a class="toc-backref" href="#id167">12.2 钉钉通知</a><a class="headerlink" href="#id81" title="Permalink to this headline">¶</a></h3>
<p>企业的通讯方式暂时不是钉钉，暂不做拓展。</p>
</section>
<section id="http">
<h3><a class="toc-backref" href="#id168">12.3 HTTP请求通知</a><a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h3>
<p>使用HTTP
Request插件（<a class="reference external" href="https://plugins.jenkins.io/http_request">https://plugins.jenkins.io/http_request</a>），我们能在Jenkins
pipeline中发送HTTP请求给第三方系统。这是最通用的Jenkins与第三方系统集成的方式之一。</p>
<p>HTTP Request插件提供了httpRequest步骤，代码示例如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pipeline{
    agent any

    stages{
        stage(&#39;http response bond&#39;){
            steps{
                script{
                    def response= httpRequest(url:&quot;http://192.168.1.40:8081&quot;,accetpType:&#39;APPLICATION_JSON&#39;,contentType:&quot;APPLICATION_JSON&quot;,
                    httpMode:&quot;POST&quot;,
                    authentication:&quot;http_request&quot;,              //字符串类型，Username with password凭证的ID，采用的是HTTP Basic认证方式。
                    customHeaders:[
                        [name:&quot;headername&quot;,value:&quot;headerValue&quot;],
                        [name:&quot;token&quot;,value:&quot;secret&quot;,maskValue:true]
                    ],
                    requestBody:&quot;{&#39;buildNumber&#39;:&#39;${env.BUILD_NUMBER}&#39;}&quot;,
                    timeout: 5,
                    validResponseCodes:&quot;200:302&quot;)

                    echo &quot;${response.status}&quot;
                    echo &quot;${response.content}&quot;

                }

            }

        }

    }
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>httpRequest步骤返回的response对象包含两个字段。

• content：响应内容。
• status：响应码。以下是httpRequest步骤支持的参数。
• url：字符串类型，请求URL。
• acceptType：枚举类型，HTTP请求Header的“Accept”的值类型为NOT_SET、TEXT_HTML、TEXT_PLAIN、APPLICATION_FORM、APPLICATION_JSON、APPLICATION_JSON_UTF8、APPLICATION_TAR、APPLICATION_ZIP、APPLICATION_OCTETSTREAM。
• authentication：字符串类型，Username with password凭证的ID，采用的是HTTP Basic认证方式。
• consoleLogResponseBody：布尔类型，是否将请求的响应body打印出来。
• contentType：枚举类型，HTTP请求Header的“Content-type”的值类型，与acceptType支持的枚举一样。


• customHeaders：HttpRequestNameValuePair对象数组，HTTP请求Header部分的内容，该对象有3个参数。
◦ name：字符串类型，Header名称。
◦ value：字符串类型，Header值。
◦ maskValue：布尔类型，是否隐藏Header值。如果设置为true，则在打印时使用“*”代替。


• httpMode：枚举类型，HTTP方法，有GET（默认）、HEAD、POST、PUT、DELETE、OPTIONS、PATCH。

• httpProxy：字符串类型，HTTP代理地址• ignoreSslErrors：布尔类型，是否忽略SSL错误。

• requestBody：字符串类型，请求的body内容。• timeout：整型，超时时间，单位为秒。默认值为0，代表不设置超时时间。

• validResponseCodes：字符串类型，代表HTTP请求成功的状态码。它支持3种格式的值。
◦ 单状态值：比如200，当收到200响应状态码时，表示HTTP请求成功。
◦ 多状态值：当响应状态码符合多个状态码中的一个时，代表请求成功。多个状态码之间使用逗号（，）分隔。比如200，404，500。
◦ 范围状态值：格式为“From：To”。比如200：302，代表收到200到302的响应状态码都代表请求成功。

• validResponseContent：字符串类型，比如设置它的值为“showme.codes”，那么只有当HTTP返回的内容中包含了“showme.codes”时，才代表请求成功。
• quiet：布尔类型，是否关闭所有的日志打印，默认值为false。
• responseHandle：枚举类型，获取HTTP响应内容的方式。其值可以为◦ NONE：不读取响应内容。
</pre></div>
</div>
</section>
</section>
<section id="id82">
<h2><a class="toc-backref" href="#id169">13.分布式构建与并行构建</a><a class="headerlink" href="#id82" title="Permalink to this headline">¶</a></h2>
</section>
<section id="id83">
<h2><a class="toc-backref" href="#id170">14.扩展pipeline</a><a class="headerlink" href="#id83" title="Permalink to this headline">¶</a></h2>
<p>Github 参考链接： <a class="reference external" href="https://github.com/jenkinsci">https://github.com/jenkinsci</a></p>
<section id="id84">
<h3><a class="toc-backref" href="#id171">14.1 <strong>为什么要扩展pipeline</strong></a><a class="headerlink" href="#id84" title="Permalink to this headline">¶</a></h3>
<p>在大量使用pipeline后，会发现Jenkins内置的功能并不能照顾到所有的需求。这时，我们就需要扩展pipeline。</p>
</section>
<section id="id85">
<h3><a class="toc-backref" href="#id172">14.2 在pipeline中定义函数</a><a class="headerlink" href="#id85" title="Permalink to this headline">¶</a></h3>
<p>pipeline本质就是一个Groovy脚本。所以，可以在pipeline中定义函数，并使用Groovy语言自带的特性。如下代码示例，我们定义了createVersion函数，并使用了Date类。</p>
</section>
</section>
<section id="id86">
<h2><a class="toc-backref" href="#id173">15.Jenkins运维</a><a class="headerlink" href="#id86" title="Permalink to this headline">¶</a></h2>
<section id="id87">
<h3><a class="toc-backref" href="#id174">15.1 认证管理</a><a class="headerlink" href="#id87" title="Permalink to this headline">¶</a></h3>
<p>如果没有设置Jenkins进行安全检查，那么任何能打开Jenkins页面的人都可以做任何事情。所以，在搭建好Jenkins后，我们要做的第一件事情就是打开Jenkins的安全检查。</p>
<p>进入Manage Jenkins→Manage Configure Global
Security页面，勾选“Enablesecurity”复选框。默认Jenkins支持两种认证方式：“Delegate
to servletcontainer”和“Jenkins’ own user database”。</p>
<section id="id88">
<h4>15.1.1 使用Jenkins自带的用户数据库<a class="headerlink" href="#id88" title="Permalink to this headline">¶</a></h4>
<p>“Jenkins’ own user
database”即使用Jenkins自带的用户数据库进行认证。如果你所在的公司没有搭建LDAP服务，则可以考虑使用这种认证方式。在Manage
Jenkins→Manage Configure Global Security页面打开Jenkins的安全检查后，</p>
<p><img alt="image67" src="../_images/jenkins_options001.png" /></p>
<p>创建用户在“Jenkins’ own user
database”认证方式下，创建的所有用户都具有Jenkins管理权限。</p>
<p>注册用户如果Jenkins管理员觉得为团队每个成员手动添加用户比较麻烦，则可以开启“Allow
users to sign up”（允许注册）功能。</p>
<p>开启后，可以通过Jenkins首页顶部的注册菜单进行注册。</p>
</section>
<section id="ldap">
<h4>15.1.2 使用LDAP认证<a class="headerlink" href="#ldap" title="Permalink to this headline">¶</a></h4>
<p>想象一下，新员工入职，你必须给他创建Jenkins、GitLab、SonarQube等各个系统的用户。你刚登录过Jenkins，想用GitLab时，还得输入用户名和密码再登录一次。当员工离职后，你还必须到各个系统中注销用户。这样的操作必定是低效的。单点登录服务可以为我们解决问题。</p>
<p>单点登录（Single Sign
On，SSO），是指在多系统应用中登录其中一个系统，便可以在其他所有系统中得到授权而无须再次登录，包括单点登录与单点注销两部分。</p>
</section>
</section>
<section id="id89">
<h3><a class="toc-backref" href="#id175">15.2 授权管理</a><a class="headerlink" href="#id89" title="Permalink to this headline">¶</a></h3>
<p>认证是为了解决“证明你是你”的问题，授权是为了解决“你能做什么”的问题。</p>
<p>我们已经知道，Jenkins默认的授权方式无法满足现实复杂的场景。</p>
<p>Jenkins有三款插件，分别支持不同维度的授权方式。它们分别是</p>
<ul class="simple">
<li><p>Matrix Authorization Strategy插件：提供基于矩阵的安全策略。</p></li>
<li><p>Project-based Matrix Authorization
Strategy插件：提供基于项目的矩阵授权策略。</p></li>
<li><p>Role-based Authorization Strategy插件：提供基于角色的安全策略。</p></li>
</ul>
<section id="role-based-authorization-strategy">
<h4>15.2.1 使用Role-based Authorization Strategy插件授权<a class="headerlink" href="#role-based-authorization-strategy" title="Permalink to this headline">¶</a></h4>
<p>使用Role-based Authorization
Strategy插件进行授权管理。因为现实中，其他插件真的很难满足要求。安装并配置插件的具体步骤如下：</p>
<p>​ 为现实中，其他插件真的很难满足要求。安装并配置插件的具体步骤如下：</p>
<ol class="arabic simple">
<li><p>安装插件Role-based Authorization
Strategy（<a class="reference external" href="https://plugins.jenkins.io/role-strategy">https://plugins.jenkins.io/role-strategy</a>）</p></li>
<li><p>勾选Role-Based Strategy</p></li>
<li><p>单击“Manage and Assign Roles”菜单项</p></li>
</ol>
</section>
<section id="id90">
<h4>15.2.2 管理角色<a class="headerlink" href="#id90" title="Permalink to this headline">¶</a></h4>
<p><strong>在“Manage Roles”页面中有三大块内容，可以分别设置三类角色。</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>全局角色（Global roles）：基于全局的角色，可以设置多种权限

项目角色（Item roles）：基于项目的角色，比如可以设置hr-project-role下的用户只能操作hr项目下的Jenkins任务

Node roles：有设置Jenkins节点相关权限的角色
</pre></div>
</div>
<p><img alt="image68" src="../_images/jenkins_quanxian0001.png" /></p>
</section>
<section id="id91">
<h4>15.2.3 权限大全<a class="headerlink" href="#id91" title="Permalink to this headline">¶</a></h4>
<p>Role-based Authorization
Strategy插件对权限的控制粒度非常细，而且还对这些权限进行了很合理的分类。</p>
<p>以下是各类权限的介绍。</p>
<p>Agent（一些老版本称为Slave）：管理Jenkins agent的相关权限。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>◦ Configure：配置Jenkins agent。
◦ Build：允许用户在Jenkins agent上运行任务。
◦ Connect：允许用户连接Jenkins agent，或者标识Jenkins agent上线。
◦ Create：允许用户创建Jenkins agent。
◦ Delete：允许用户删除Jenkins agent。
◦ Disconnect：允许用户断开与Jenkins agent的连接，或者标识Jenkins agent临时下线。
</pre></div>
</div>
<ul class="simple">
<li><p>Job：关于Jenkins任务的权限。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>◦ Create：创建任务。
◦ Delete：允许删除任务。
◦ Cancel：允许停止一个调度任务或者中止一个正在执行的任务。
◦ Configure：更改一个任务的配置。
◦ Read：查看任务。
◦ Build：启动任务。
◦ Discover：如果匿名用户没有Discover权限，直接在浏览器中输入Jenkins任务URL（该任务真实存在）时，会直接跳转到404页面；如果有Discover权限，则跳转到登录页面。

◦ Move：将任务从一个文件夹移动到另一个文件夹的权限。
◦ Workspace：允许查看Jenkins任务的工作空间内容的权限。
</pre></div>
</div>
<ul class="simple">
<li><p>Run：构建历史相关权限。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>◦ Delete：允许手动删除指定的构建历史。
◦ Replay：允许对一个任务进行重放。
◦ Update：允许用户更新构建历史的属性，比如手动更新某次构建失败的原因。
</pre></div>
</div>
<p>View：视图。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>◦ Configure：配置视图。
◦ Create：创建视图，需要与Configure权限一同授予，否则创建之后没有权限配置。
◦ Delete：删除视图。
◦ Read：查看视图。
</pre></div>
</div>
<ul class="simple">
<li><p>SCM：版本控制。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>◦ Tag：允许用户针对某次构建创建一个新的Tag。
</pre></div>
</div>
<p>Overall：特殊的权限类，系统级别权限。它包括以下权限。</p>
<ul class="simple">
<li><p>Administer：允许用户更改Jenkins系统级别的配置。如果要进入Jenkins管理页面，就必须有此权限。</p></li>
<li><p>Read：全局读权限。当然，必须是没有安全隐患的页面。另外，如果希望对凭证做更细粒度的权限控制，那么只要安装了Credentials插件，在角色管理页面中就会多出一列Credentials的权限控制。</p></li>
</ul>
</section>
<section id="id92">
<h4>15.2.4 角色分配<a class="headerlink" href="#id92" title="Permalink to this headline">¶</a></h4>
<p>在创建角色后，需要将角色分配给用户。</p>
<p>角色分配页面分为分配全局角色、项目角色（Item roles）和节点角色（Node
roles）三大块内容。</p>
<p>内置角色（Built-in Roles）</p>
<p>Role-based Authorization
Strategy插件有两个内置角色，我们可以直接设置它们所拥有的权限。</p>
<ul class="simple">
<li><p>Anonymous：匿名用户。</p></li>
<li><p>Authenticated：认证通过的用户。</p></li>
</ul>
<p>小结说实在的，Jenkins的Role-based Authorization
Strategy插件的授权管理功能真的非常弱，</p>
<p>不推荐使用它做过于复杂的权限控制。在某些情况下，多搭建几套Jenkins，让不同的团队分别使用不同的Jenkins也是可以的。</p>
<p>参考文献</p>
<blockquote>
<div><p>jenkins 添加用户管理权限</p>
<p><a class="reference external" href="https://www.cnsre.cn/posts/210426034157/">https://www.cnsre.cn/posts/210426034157/</a></p>
<p>Jenkins 中基于角色的权限管理</p>
<p><a class="reference external" href="http://www.mydlq.club/article/59/">http://www.mydlq.club/article/59/</a></p>
</div></blockquote>
</section>
</section>
<section id="id93">
<h3><a class="toc-backref" href="#id176">15.3 Jenkins监控</a><a class="headerlink" href="#id93" title="Permalink to this headline">¶</a></h3>
<section id="monitoring">
<h4>15.3.1 使用Monitoring插件监控<a class="headerlink" href="#monitoring" title="Permalink to this headline">¶</a></h4>
<p>Monitoring 插件（<a class="reference external" href="https://plugins.jenkins.io/monitoring">https://plugins.jenkins.io/monitoring</a>）</p>
<p>使用
JavaMelody（<a class="reference external" href="https://github.com/javamelody/javamelody/wiki">https://github.com/javamelody/javamelody/wiki</a>）对Jenkins进行监控</p>
<p>单击“Monitoring of Jenkins
master”菜单项进入后，显示Monitoring仪表盘，然而，它没有告警功能。因此，这款插件并不适合在大型企业中使用。</p>
<p><img alt="image69" src="../_images/jenkins_monitor0001.png" /></p>
</section>
<section id="prometheus">
<h4>15.3.2 使用Prometheus监控<a class="headerlink" href="#prometheus" title="Permalink to this headline">¶</a></h4>
<p>Prometheus（<a class="reference external" href="https://prometheus.io/">https://prometheus.io/</a>）是一款开源的监控、告警系统，是继Kubernetes之后第二个从Cloud
Native Computing Foundation（云原生计算基金会，简称CNCF）“毕业”的项目。</p>
<p>Prometheus实现了与Zabbix或者Open-Falcon类似的功能，但是更强大。</p>
<p>像Zabbix和Open-Falcon采用的是push模式收集指标数据的，Prometheus采用的是pull模式，即Prometheus的服务器端主动从客户端拉取指标数据。这个客户端被称为exporter。我们会在Jenkins上安装Prometheus插件，目的就是为了暴露一个接口（exporter），这样Prometheus就可以拉取到指标数据了。</p>
<p>这里假设读者已经安装好了Prometheus和Grafana。以下是具体的整合步骤。</p>
<p>（1）Jenkins：安装Prometheus插件（<a class="reference external" href="https://plugins.jenkins.io/prometheus">https://plugins.jenkins.io/prometheus</a>），Jenkins将暴露一个“/prometheus”接口。Prometheus插件本身是可以配置的。进入ManageJenkins→Configure
System页面.</p>
<p><img alt="image70" src="../_images/jenkins_prometheus001.png" /></p>
<p>配置Prometheus插件通过此配置，我们可以选择暴露接口的URL，以及暴露哪些指标数据。</p>
<p>设置完成后重启<code class="docutils literal notranslate"><span class="pre">Jenkins</span></code>服务，并且访问<code class="docutils literal notranslate"><span class="pre">jenkins</span></code>的<code class="docutils literal notranslate"><span class="pre">url</span></code>查看指标情况</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">jenkinsurl</span><span class="o">/</span><span class="n">prometheus</span>
</pre></div>
</div>
<p><img alt="image71" src="../_images/jenkins_prumetheus0002.png" /></p>
<p>（2）配置Prometheus向Jenkins拉取监控指标数据，加入配置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">yml</span>
<span class="k">global</span><span class="p">:</span>
  <span class="n">scrape_interval</span><span class="p">:</span>     <span class="mi">60</span><span class="n">s</span>
  <span class="n">evaluation_interval</span><span class="p">:</span> <span class="mi">60</span><span class="n">s</span>

<span class="n">scrape_configs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">job_name</span><span class="p">:</span> <span class="n">prometheus</span>
    <span class="n">static_configs</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">targets</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;localhost:9090&#39;</span><span class="p">]</span>
        <span class="n">labels</span><span class="p">:</span>
          <span class="n">instance</span><span class="p">:</span> <span class="n">prometheus</span>

  <span class="o">-</span> <span class="n">job_name</span><span class="p">:</span> <span class="n">linux</span>
    <span class="n">static_configs</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">targets</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;192.168.1.40:9100&#39;</span><span class="p">]</span>
        <span class="n">labels</span><span class="p">:</span>
          <span class="n">instance</span><span class="p">:</span> <span class="n">localhost</span>

  <span class="o">-</span> <span class="n">job_name</span><span class="p">:</span> <span class="n">jenkins</span>
    <span class="n">metrics_path</span><span class="p">:</span> <span class="o">/</span><span class="n">prometheus</span><span class="o">/</span>
    <span class="n">scrape_interval</span><span class="p">:</span> <span class="mi">10</span><span class="n">s</span>
    <span class="n">scrape_timeout</span><span class="p">:</span> <span class="mi">10</span><span class="n">s</span>
    <span class="n">static_configs</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">targets</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;192.168.1.40:8080&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>（3）Grafana：增加“Jenkins：Performance and health overview”面板</p>
<p><img alt="image72" src="../_images/jenkins_proumetheus0002.png" /></p>
<p>参考文献：</p>
<p><a class="reference external" href="https://my.oschina.net/u/4357035/blog/3313700">https://my.oschina.net/u/4357035/blog/3313700</a></p>
<p><a class="reference external" href="https://www.cnblogs.com/ssgeek/p/12272629.html">Prometheus监控Jenkins</a></p>
</section>
</section>
<section id="id94">
<h3><a class="toc-backref" href="#id177">15.4 Jenkins备份</a><a class="headerlink" href="#id94" title="Permalink to this headline">¶</a></h3>
<section id="jenkins-home">
<h4>15.4.1 JENKINS_HOME介绍<a class="headerlink" href="#jenkins-home" title="Permalink to this headline">¶</a></h4>
<p>Jenkins的所有数据都是存放在文件中的，所以，Jenkins备份其实就是备份JENKINS_HOME目录。</p>
<p><img alt="image73" src="../_images/jenkins_tree0001.png" /></p>
<p>并不是所有的内容都必须要备份。以下目录是可以不备份的。</p>
<ul class="simple">
<li><p>workspace</p></li>
<li><p>builds</p></li>
<li><p>fingerprints</p></li>
</ul>
<p>如果启动 Jenkins 时没有指定 JENKINS_HOME 环境变量，那么 Jenkins
将在当前用户目录下创建一个.jenkins目录作为JENKINS_HOME目录。</p>
<p>笔者强烈建议启动Jenkins时明确指定JENKINS_HOME目录。比如这样启动：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">alternatives</span><span class="o">/</span><span class="n">java</span><span class="o">-</span><span class="n">DJENKINS</span> <span class="n">HOME</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jenkins</span><span class="o">-</span><span class="n">jar</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jenkins</span><span class="o">/</span><span class="n">jenkins</span><span class="o">.</span><span class="n">war</span> <span class="o">--</span><span class="n">logfile</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">jenkins</span><span class="o">/</span><span class="n">jenkins</span><span class="o">.</span><span class="n">log</span> <span class="o">--</span><span class="n">webroot</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">jenkins</span><span class="o">/</span><span class="n">war</span> <span class="o">--</span><span class="n">httpPort</span><span class="o">=</span><span class="mi">8667</span>
</pre></div>
</div>
</section>
<section id="periodic-backup">
<h4>15.4.2 使用Periodic Backup插件进行备份<a class="headerlink" href="#periodic-backup" title="Permalink to this headline">¶</a></h4>
<p>Jenkins本身并不提供备份功能，而是交给插件来完成。我们使用Periodic
Backup插件（<a class="reference external" href="https://plugins.jenkins.io/periodicbackup">https://plugins.jenkins.io/periodicbackup</a>）来实现Jenkins的备份。</p>
<p>安装Periodic Backup插件后，在“Manage Jenkins”菜单下就会多出一个“Periodic
Backup Manager”菜单项。</p>
<p>单击“Configure”选项后，进入插件配置页面</p>
<p><img alt="image74" src="../_images/jenkins_backup1221.png" /></p>
<ul class="simple">
<li><p>Backup schedule （cron）：进行备份的cron表达式，单击“Validate
cronsyntax”按钮可进行校验。由于Jenkins是使用本地文件存储的方式来保存配置的，在备份过程中如果有其他操作，则很容易出现数据不一致的问题。所以，应尽量选择在无人使用Jenkins的时候进行备份。</p></li>
<li><p>File Management Strategy：备份策略。</p></li>
</ul>
<p>◦ ConfigOnly：只备份配置文件。</p>
<p>◦ FullBackup：进行全量备份。可以通过在“Excludes
list”中填入Ant风格路径表达式，排除不希望进行备份的文件。多个表达式之间使用分号分隔。</p>
<p><img alt="image75" src="../_images/jenkins_backup1221002.png" /></p>
<ul class="simple">
<li><p>Backup Location：配置备份文件的存放位置。</p></li>
</ul>
<p>注意，Jenkins运行用户一定要有对该文件夹进行写的权限。保存配置，单击“Backup
Now！”选项，可以马上进行一次备份。</p>
<p>当需要恢复时，单击“Restore”选项，然后选择需要恢复的版本。</p>
<p><img alt="image76" src="../_images/jenkins_restor0001.png" /></p>
</section>
</section>
<section id="id95">
<h3><a class="toc-backref" href="#id178">15.5 汉化</a><a class="headerlink" href="#id95" title="Permalink to this headline">¶</a></h3>
<p>Jenkins默认根据用户浏览器的语言设置来显示。如果希望设置Jenkins界面的语言，则安装Local插件（<a class="reference external" href="https://plugins.jenkins.io/locale">https://plugins.jenkins.io/locale</a>）后，进入“ManageJenkins→Configure
System”页面，找到“Local”进行设置</p>
<p><img alt="image77" src="../_images/jenkins_hanhua0001.png" /></p>
<p>注意：勾选“Ignore browser preference and force this language to
allusers”复选框，代表忽略用户浏览器的语言设置，强制使用中文界面。</p>
</section>
<section id="id96">
<h3><a class="toc-backref" href="#id179">15.6 Jenkins配置即代码</a><a class="headerlink" href="#id96" title="Permalink to this headline">¶</a></h3>
<p>Jenkins用久了，会有一种莫名的紧张感。因为没有人清楚Jenkins都配置了什么，以至于最终没有人敢动它。但凡使用界面进行配置的，都会有这样的后果。解决办法就是通过代码进行配置——Config-uration
as Code。</p>
<p>此处省略，暂时用不上</p>
</section>
<section id="init-groovyjenkins">
<h3><a class="toc-backref" href="#id180">15.7 使用init.groovy配置Jenkins</a><a class="headerlink" href="#init-groovyjenkins" title="Permalink to this headline">¶</a></h3>
<p>此处省略，暂时用不上</p>
</section>
<section id="jenkinsagent">
<h3><a class="toc-backref" href="#id181">15.8 为Jenkins添加静态agent节点</a><a class="headerlink" href="#jenkinsagent" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>参考文献：</p>
<p><a class="reference external" href="https://blog.csdn.net/weixin_40046357/article/details/107572671">https://blog.csdn.net/weixin_40046357/article/details/107572671</a></p>
</div></blockquote>
</section>
</section>
<section id="id97">
<h2><a class="toc-backref" href="#id182">16.自动化运维经验</a><a class="headerlink" href="#id97" title="Permalink to this headline">¶</a></h2>
<section id="id98">
<h3><a class="toc-backref" href="#id183">16.1 小团队自动化运维实践经验</a><a class="headerlink" href="#id98" title="Permalink to this headline">¶</a></h3>
<section id="id99">
<h4>16.1.1 先做监控和告警<a class="headerlink" href="#id99" title="Permalink to this headline">¶</a></h4>
<p>事情有轻重缓急，监控和告警是一开始就要做的，即使业务开发被拖慢也要先做。只有知道了当前情况，才能做好下一步计划。现在市面上有很多监控系统，如
Zabbix、Open-Falcon、Prometheus 等。最终笔者选择了Prometheus。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• Prometheus是pull模式的。自认为push模式是自己怼自己的模式。

• 不像Zabbix需要一个Web UI，Prometheus使用文本进行配置，有利于配置版本化（这点最关键）。

• 插件丰富，想要监控什么，基本都会有现成的。
</pre></div>
</div>
<p>以自己的工作电脑为控制机器，使用Ansible部署整个监控系统。</p>
<p>使用Ansible部署整个监控系统示意图</p>
<p><img alt="image78" src="../_images/jenkins_ansible0001.png" /></p>
<ul class="simple">
<li><p>Prometheus server负责监控数据收集和存储。</p></li>
<li><p>Prometheus alert
manager负责根据告警规则进行告警，可集成多种告警通道。</p></li>
<li><p>node-exporter（<a class="reference external" href="https://github.com/prometheus/node_exporter">https://github.com/prometheus/node_exporter</a>）的作用是从机器上读取指标数据，然后暴露一个HTTP服务，Prometheus就是从这个服务中收集监控指标数据的。Prometheus官方还提供了各种各样的exporter。</p></li>
</ul>
<p>使用Ansible作为部署工具的一个好处是有很多现成的role。在安装Prometheus时，笔者使用的是现成的prometheus-ansble（<a class="reference external" href="https://github.com/ernestas-poskus/ansible-prometheus">https://github.com/ernestas-poskus/ansible-prometheus</a>）。</p>
<p>有了监控数据后，我们就可以对数据进行可视化了。Grafana和Prometheus集成得非常好，所以我们又部署了Grafana。</p>
<p>可是，我们不可能24小时盯着屏幕看CPU负载有没有超吧？这时候就要做告警了。Prome-htues默认集成了多种告警渠道，钉钉除外。由于当时笔者所在团队使用的是钉钉，所以告警通道只能选择钉钉。有好心人开源了钉钉集成Prometheus告警的组件：prometheus-webhook-dingtalk（<a class="reference external" href="https://github.com/timonwong/prometheus-webhook-dingtalk">https://github.com/timonwong/prometheus-webhook-dingtalk</a>）。于是，我们做了告警，</p>
<p><img alt="image79" src="../_images/jenkins_ansible_dingding001.png" /></p>
<p>完成以上工作后，我们的基础监控的架子就搭好了，为后期的Redis监控、JVM监控等更上层的监控做好了准备。</p>
</section>
<section id="id100">
<h4>16.1.2 一开始就应该做配置版本化<a class="headerlink" href="#id100" title="Permalink to this headline">¶</a></h4>
<p>一开始就做配置版本化。在搭建监控系统的过程中，已经将配置抽离出来，放到一个单独的代码仓库进行管理。以后所有部署，我们都会将配置和部署逻辑分离。这样，只需要复制一份配置，改一改，就可以在新的环境中快速搭建一套新的监控系统。关于如何管理Ansible部署脚本的配置，我们使用如下目录结构。</p>
<p><img alt="image80" src="../_images/jenkins_ansible0002.png" /></p>
<p>现阶段，所有的配置都以文本方式存储，将来切换成使用Consul做配置中心，只需要将配置本身部署到Consul中就可以了。而且，Ansible
2.0以上版本已经原生支持Consul的操作。</p>
</section>
<section id="jenkins-jenkins">
<h4>16.1.3 Jenkins化：将打包工作交给Jenkins<a class="headerlink" href="#jenkins-jenkins" title="Permalink to this headline">¶</a></h4>
<p>有了监控后，我们就可以进行下一步操作：将所有项目的打包工作交给Jenkins。当然，现实中是逐步实现的，并不是一步到位的。首先要有Jenkins。搭建Jenkins同样有现成的Ansible
playbook：</p>
<p>ansible-role-jenkins（<a class="reference external" href="https://github.com/geerlingguy/ansible-role-jenkins">https://github.com/geerlingguy/ansible-role-jenkins</a>）。注意，网上的大多文章告诉你的都是Jenkins需要手动安装插件，而我们使用的ansible-role-jenkins实现了自动安装插件，只需要增加一个配置变量jenkins
plugins就可以了。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Converge</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">become</span><span class="p">:</span> <span class="n">true</span>

  <span class="nb">vars</span><span class="p">:</span>
    <span class="n">jenkins_plugins</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">ghprb</span>
      <span class="o">-</span> <span class="n">greenballs</span>
      <span class="o">-</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">cloudbees</span><span class="o">-</span><span class="n">folder</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="mf">6.11</span><span class="p">}</span>
    <span class="n">jenkins_home</span><span class="p">:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">jenkins</span>
    <span class="n">jenkins_plugin_timeout</span><span class="p">:</span> <span class="mi">120</span>

  <span class="n">pre_tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">include_tasks</span><span class="p">:</span> <span class="n">java</span><span class="o">-</span><span class="mf">8.</span><span class="n">yml</span>

  <span class="n">roles</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">geerlingguy</span><span class="o">.</span><span class="n">java</span>
    <span class="o">-</span> <span class="n">geerlingguy</span><span class="o">.</span><span class="n">jenkins</span>
</pre></div>
</div>
<p>最终Jenkins搭建完成，示意图如图</p>
<p><img alt="image81" src="../_images/jenkins_ansible_install0003.png" /></p>
<p>现在我们需要告诉Jenkins如何对业务代码进行编译打包。我们逐步在每个业务系统的根目录中加入相应的Jenkinsfile。在为每个业务系统写Jenkinsfile的过程中，注意这些业务系统的Jenkinsfile的共性，及时进行抽象，避免大量重复。</p>
</section>
<section id="nexus">
<h4>16.1.4 将制品交给Nexus<a class="headerlink" href="#nexus" title="Permalink to this headline">¶</a></h4>
<p>管理采用Jenkins进行自动化编译打包后，我们遇到的第一个问题就是将打包出来的制品放在哪里。所以，在搭建好Jenkins后，就需要搭建Nexus了。</p>
</section>
<section id="id101">
<h4>16.1.5 让Jenkins帮助我们执行Ansible<a class="headerlink" href="#id101" title="Permalink to this headline">¶</a></h4>
<p>不过，这里有一个问题需要考虑：是将Ansible脚本和业务系统放在同一个代码仓库中，还是分别放在不同的仓库中？笔者推荐将部署脚本与业务系统放在同一个代码仓库中，结构如下</p>
<p><img alt="image82" src="../_images/jenkins_ansibleo00003.png" /></p>
<p>这样做的好处是：</p>
<ul class="simple">
<li><p>职责清晰。Jenkinsfile负责构建逻辑，deploy目录负责部署逻辑。</p></li>
<li><p>标准化。所有需要部署的业务系统都可以使用此目录结构，而不论是Go项目还是Node.js项目。</p></li>
<li><p>有助于推行DevOps。开发人员对构建逻辑和部署逻辑负责。虽然推行DevOps只是手段，不是目的。</p></li>
</ul>
</section>
<section id="id102">
<span id="id103"></span><h4>16.1.6 小结<a class="headerlink" href="#id102" title="Permalink to this headline">¶</a></h4>
<p>小团队自动化运维实施的顺序大致为：</p>
<p>（1）做基础监控。</p>
<p>（2）搭建GitLab。</p>
<p>（3）搭建Jenkins，并集成GitLab。</p>
<p>（4）使用Jenkins实现自动编译打包。</p>
<p>（5）将制品交给制品库管理。</p>
<p>（6）使用Jenkins执行Ansible。</p>
<p>完成以上步骤后，自动化运维的基本框架就算搭建完成了。虽然它算不上一个平台，但是足以满足大多数团队的需求。</p>
<p>这说起来容易，但做起来难。在团队中，任何变化都可能面临阻力。笔者的经验是先让整个团队对这个实施过程有一个整体认识，并且达成共识。这样，自动化运维实施起来才会相对顺利一些。</p>
</section>
</section>
</section>
<section id="python-jenkins">
<h2><a class="toc-backref" href="#id184">17.Python-jenkins库</a><a class="headerlink" href="#python-jenkins" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://xieys.club/python-jenkins/">https://xieys.club/python-jenkins/</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="01.Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html" class="btn btn-neutral float-left" title="Jenkins基础知识" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="03.Jenkins-pipeline%E5%B0%8F%E7%BB%93.html" class="btn btn-neutral float-right" title="Jenkins pipeline 小结" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>