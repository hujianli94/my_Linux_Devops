<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>7. 镜像转换V2V &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="8. KVM带web管理界面" href="08.KVM%E5%B8%A6web%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2.html" />
    <link rel="prev" title="6. KVM相关参考文献" href="06.KVM%E7%9B%B8%E5%85%B3%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> 小健_Linux-shell-Devops_Blog
            <img src="../_static/devops_photo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../DevOps/index.html">DevOps和自动化运维实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Github/index.html">Github入门到实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Jenkins/index.html">Jenkins持续化集成</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">KVM实践</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01%E6%9E%84%E5%BB%BAKVM%E7%8E%AF%E5%A2%83.html">1. 构建KVM环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="02KVM%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7.html">2. KVM管理工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="03.qemu-img%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0.html">3. qemu-img命令学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.KVM%E8%AE%BE%E5%A4%87%E9%AB%98%E7%BA%A7%E7%AE%A1%E7%90%86.html">4. KVM设备高级管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.Vagrant%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%BF%AB%E9%80%9F%E5%88%9B%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83.html">5. Vagrant虚拟机快速创建开发环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.KVM%E7%9B%B8%E5%85%B3%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE.html">6. KVM相关参考文献</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">7. 镜像转换V2V</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#p2v">7.1. P2V工具</a></li>
<li class="toctree-l3"><a class="reference internal" href="#qemu-img">7.2. qemu-img工具转换镜像格式</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vmwarekvm">7.3. VMware转换为KVM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vmdkqcow2">7.4. vmdk转换为qcow2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">7.4.1. 总结</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">7.4.2. 转换格式</a></li>
<li class="toctree-l4"><a class="reference internal" href="#windows">7.4.3. windows迁移流程</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#kvmvmdk">7.5. Kvm转换为vmdk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#qcow2raw">7.6. qcow2转换为raw</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rawqcow2">7.6.1. raw格式和qcow2格式的转化</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">7.7. raw转换为qcow2</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ovaovf">7.8. ova转换为ovf</a></li>
<li class="toctree-l3"><a class="reference internal" href="#virtualboxkvm">7.9. VirtualBox迁移到KVM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kvmvmware">7.10. KVM虚机迁移到VMware</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kvmvmware-esxi">7.11. KVM镜像转vmware esxi</a></li>
<li class="toctree-l3"><a class="reference internal" href="#openstack-p2v">7.12. openstack 平台P2V迁移</a></li>
<li class="toctree-l3"><a class="reference internal" href="#openstack-rawvmdk">7.13. Openstack下云迁移(raw转vmdk)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vmware-esxi">7.14. Vmware esxi虚拟机冷迁移至各虚拟化平台方案</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vmware-exsi-vmzstack">7.15. Vmware exsi vm迁移到Zstack实战</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">7.15.1. 方法1</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">7.15.2. 方法2</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id10">7.16. 参考文献</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="08.KVM%E5%B8%A6web%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2.html">8. KVM带web管理界面</a></li>
<li class="toctree-l2"><a class="reference internal" href="09.Proxmox_VE.html">9. Proxmox VE</a></li>
<li class="toctree-l2"><a class="reference internal" href="10.CentOS7-ks.cfg%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE%E6%8A%80%E5%B7%A7.html">10. CentOS7-ks.cfg系统安装与配置技巧</a></li>
<li class="toctree-l2"><a class="reference internal" href="11.KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%28%E8%BD%AC%29.html">11. KVM虚拟化学习笔记系列文章列表(转)</a></li>
<li class="toctree-l2"><a class="reference internal" href="12.KVM%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%93%8D-%E5%AE%89%E8%A3%85%E5%92%8C%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C.html">12. KVM部署实操-安裝和常用操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="13.Zstack%E5%85%A5%E9%97%A8%E5%88%9D%E4%BD%93%E9%AA%8C.html">13. Zstack入门初体验</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Linux/index.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Mysql/index.html">Mysql王者之路</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/index.html">Other</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Network_route_switch/index.html">Network_route_switch</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">小健_Linux-shell-Devops_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">KVM实践</a> &raquo;</li>
      <li><span class="section-number">7. </span>镜像转换V2V</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/KVM/07.虚拟机镜像转换V2V.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#v2v" id="id11">镜像转换V2V</a></p>
<ul>
<li><p><a class="reference internal" href="#p2v" id="id12">P2V工具</a></p></li>
<li><p><a class="reference internal" href="#qemu-img" id="id13">qemu-img工具转换镜像格式</a></p></li>
<li><p><a class="reference internal" href="#vmwarekvm" id="id14">VMware转换为KVM</a></p></li>
<li><p><a class="reference internal" href="#vmdkqcow2" id="id15">vmdk转换为qcow2</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id16">总结</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id17">转换格式</a></p></li>
<li><p><a class="reference internal" href="#windows" id="id18">windows迁移流程</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#kvmvmdk" id="id19">Kvm转换为vmdk</a></p></li>
<li><p><a class="reference internal" href="#qcow2raw" id="id20">qcow2转换为raw</a></p>
<ul>
<li><p><a class="reference internal" href="#rawqcow2" id="id21">raw格式和qcow2格式的转化</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id7" id="id22">raw转换为qcow2</a></p></li>
<li><p><a class="reference internal" href="#ovaovf" id="id23">ova转换为ovf</a></p></li>
<li><p><a class="reference internal" href="#virtualboxkvm" id="id24">VirtualBox迁移到KVM</a></p></li>
<li><p><a class="reference internal" href="#kvmvmware" id="id25">KVM虚机迁移到VMware</a></p></li>
<li><p><a class="reference internal" href="#kvmvmware-esxi" id="id26">KVM镜像转vmware esxi</a></p></li>
<li><p><a class="reference internal" href="#openstack-p2v" id="id27">openstack 平台P2V迁移</a></p></li>
<li><p><a class="reference internal" href="#openstack-rawvmdk" id="id28">Openstack下云迁移(raw转vmdk)</a></p></li>
<li><p><a class="reference internal" href="#vmware-esxi" id="id29">Vmware esxi虚拟机冷迁移至各虚拟化平台方案</a></p></li>
<li><p><a class="reference internal" href="#vmware-exsi-vmzstack" id="id30">Vmware exsi vm迁移到Zstack实战</a></p>
<ul>
<li><p><a class="reference internal" href="#id8" id="id31">方法1</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id32">方法2</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id10" id="id33">参考文献</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="v2v">
<h1><a class="toc-backref" href="#id11"><span class="section-number">7. </span>镜像转换V2V</a><a class="headerlink" href="#v2v" title="Permalink to this headline">¶</a></h1>
<section id="p2v">
<h2><a class="toc-backref" href="#id12"><span class="section-number">7.1. </span>P2V工具</a><a class="headerlink" href="#p2v" title="Permalink to this headline">¶</a></h2>
<p>wget
<a class="reference external" href="javascript:void()">http://oirase.annexia.org/virt-p2v/RHEL-7.3/virt-p2v-1.32.7-2.el7.iso</a></p>
<p>P2V、V2V迁移总结</p>
<p><a class="reference external" href="https://blog.51cto.com/wangzc/2133439">https://blog.51cto.com/wangzc/2133439</a></p>
<p><a class="reference external" href="https://blog.51cto.com/h11345/1565345">https://blog.51cto.com/h11345/1565345</a></p>
</section>
<section id="qemu-img">
<h2><a class="toc-backref" href="#id13"><span class="section-number">7.2. </span>qemu-img工具转换镜像格式</a><a class="headerlink" href="#qemu-img" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://support.huaweicloud.com/bestpractice-ims/ims_bp_0030.html">https://support.huaweicloud.com/bestpractice-ims/ims_bp_0030.html</a></p>
<p>简单看看几种镜像的转化：</p>
</section>
<section id="vmwarekvm">
<h2><a class="toc-backref" href="#id14"><span class="section-number">7.3. </span>VMware转换为KVM</a><a class="headerlink" href="#vmwarekvm" title="Permalink to this headline">¶</a></h2>
</section>
<section id="vmdkqcow2">
<h2><a class="toc-backref" href="#id15"><span class="section-number">7.4. </span>vmdk转换为qcow2</a><a class="headerlink" href="#vmdkqcow2" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@localhost</span> <span class="n">migration</span><span class="p">]</span><span class="c1"># qemu-img info SLES11SP1-single.vmdk</span>
<span class="n">image</span><span class="p">:</span> <span class="n">SLES11SP1</span><span class="o">-</span><span class="n">single</span><span class="o">.</span><span class="n">vmdk</span>
<span class="n">file</span> <span class="nb">format</span><span class="p">:</span> <span class="n">vmdk</span>
<span class="n">virtual</span> <span class="n">size</span><span class="p">:</span> <span class="mi">20</span><span class="n">G</span> <span class="p">(</span><span class="mi">21474836480</span> <span class="nb">bytes</span><span class="p">)</span>
<span class="n">disk</span> <span class="n">size</span><span class="p">:</span> <span class="mf">3.9</span><span class="n">G</span>

<span class="p">[</span><span class="n">root</span><span class="nd">@localhost</span> <span class="n">migration</span><span class="p">]</span><span class="c1"># qemu-img convert -f vmdk -O qcow2 SLES11SP1-single.vmdk SLES11SP1-single.img</span>

<span class="p">[</span><span class="n">root</span><span class="nd">@localhost</span> <span class="n">migration</span><span class="p">]</span><span class="c1"># qemu-img info SLES11SP1-single.img</span>
<span class="n">image</span><span class="p">:</span> <span class="n">SLES11SP1</span><span class="o">-</span><span class="n">single</span><span class="o">.</span><span class="n">img</span>
<span class="n">file</span> <span class="nb">format</span><span class="p">:</span> <span class="n">qcow2</span>
<span class="n">virtual</span> <span class="n">size</span><span class="p">:</span> <span class="mi">20</span><span class="n">G</span> <span class="p">(</span><span class="mi">21474836480</span> <span class="nb">bytes</span><span class="p">)</span>
<span class="n">disk</span> <span class="n">size</span><span class="p">:</span> <span class="mf">3.9</span><span class="n">G</span>
<span class="n">cluster_size</span><span class="p">:</span> <span class="mi">65536</span>
</pre></div>
</div>
<p>virt-v2v工具来做迁移，实现将VMware
ESX中的一个客户机迁移到KVM上。利用virt-v2v
迁移VMware客户机的命令行示例如下：</p>
<p>kvm安装命令支持包</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">vmfs</span>
<span class="n">virsh</span> <span class="n">pool</span><span class="o">-</span><span class="n">define</span><span class="o">-</span><span class="k">as</span> <span class="n">vmdisk</span> <span class="o">--</span><span class="nb">type</span> <span class="nb">dir</span> <span class="o">--</span><span class="n">target</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">vmfs</span>
<span class="n">virsh</span> <span class="n">pool</span><span class="o">-</span><span class="n">build</span> <span class="n">vmdisk</span>
<span class="n">virsh</span> <span class="n">pool</span><span class="o">-</span><span class="n">autostart</span> <span class="n">vmdisk</span>
<span class="n">virsh</span> <span class="n">pool</span><span class="o">-</span><span class="n">start</span> <span class="n">vmdisk</span>
</pre></div>
</div>
<p>创建ESXI 验证文件</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vim</span> <span class="o">/</span><span class="n">root</span><span class="o">/.</span><span class="n">netrc</span>
<span class="n">machine</span> <span class="mf">192.168.1.58</span> <span class="n">login</span> <span class="n">root</span> <span class="n">password</span> <span class="mi">123456</span>
<span class="n">chmod</span> <span class="mi">0600</span> <span class="o">~/.</span><span class="n">netrc</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// 测试KVM连接ESXI
# virsh  -c esx://root@192.168.1.58?no_verify=1 list --all
Enter root&#39;s password for 192.168.1.58:
 Id    Name                           State
----------------------------------------------------
 1     Gitee-GO-k8s-master1           running
 3     Gitee-GO-k8s-node2             running
 4     Gitee-GO-k8s-node1             running
 22    centos7                        running
 -     docker-s1                      shut off


// 直接迁移转换exsi
virt-v2v -ic esx://root@192.168.1.58/?no_verify=1 -os vmdisk -of qcow2 -b br0 docker-s1

// 直接迁移转换vcenter
virt-v2v -ic vpx://administrator%40vsphere.local@192.168.1.40/OSChina/192.168.1.58?no_verify=1 docker-s1 -o libvirt -of qcow2




// 如果直接迁移报错了，就需要将vmdk复制到本地进行手动转换的方式进行迁移，硬盘文件+xml文件创建虚拟机


具体实现方式如下：
// 迁移到本地
# virt-v2v-copy-to-local -ic esx://root@192.168.1.58/?no_verify=1 docker-s1
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  1  100G    1 1096M    0     0  38.6M      0  0:44:06  0:00:28  0:43:38 44.1M


// 本地转换
# mkdir ./out2
# virt-v2v -i libvirtxml docker-s1.xml -o local --os  ./out2/ --of qcow2
[   0.0] Opening the source -i libvirtxml docker-s1.xml
[   0.0] Creating an overlay to protect the source from being modified

// 进入到out2输出目录，修改xml文件
// 这里首先自定义了一个桥 br1（之前已创建）

//重启网卡
# virsh iface-bridge br_em1 br1

# vim centos7-2.xml   修改桥接
 &lt;interface type=&#39;bridge&#39;&gt;
      &lt;mac address=&#39;fa:be:ba:da:5d:00&#39;/&gt;
      &lt;source bridge=&#39;br_em1&#39;/&gt;
      &lt;target dev=&#39;vnic1.0&#39;/&gt;
      &lt;model type=&#39;virtio&#39;/&gt;
      &lt;driver name=&#39;vhost&#39; txmode=&#39;iothread&#39; ioeventfd=&#39;on&#39; event_idx=&#39;off&#39; queues=&#39;2&#39; rx_queue_size=&#39;256&#39; tx_queue_size=&#39;256&#39;/&gt;
      &lt;mtu size=&#39;1500&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x03&#39; function=&#39;0x0&#39;/&gt;
    &lt;/interface&gt;


// 创建、启动虚拟机
# virsh define docker-s1.xml
# virsh start docker-s1
</pre></div>
</div>
<section id="id1">
<h3><a class="toc-backref" href="#id16"><span class="section-number">7.4.1. </span>总结</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>使用virt-v2v-copy-to-local这个工具来做迁移</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1.前提：关闭vm虚拟机
virt-v2v-copy-to-local -ic esx://root@192.168.20.158/?no_verify=1 es-node2-192.168.20.105

* exsi地址 -ic esx://root@192.168.20.158/?no_verify=
* 虚拟机名称  es-node2-192.168.20.105


将迁移后的虚拟机文件和配置文件通过virt-v2v工具转化成kvm可以识别的虚拟机文件和xml配置文件
2.virt-v2v -i libvirtxml es-node2-192.168.20.104.xml -o local -os /var/kvm/images/ -of qcow2


将xml跑配置文件转移到kvm默认配置文件目录下
3.mv /var/kvm/images/es-node2-192.168.20.105.xml /etc/libvirt/qemu


通过xml文件注册虚拟机
4.virsh define /etc/libvirt/qemu/es-node2-192.168.20.105.xml

5.需要修改下kvm虚拟机配置文件。目前需要修改下虚拟机使用的桥接网卡一般将桥接网卡改成br0
virsh edit es-node2-192.168.20.105

6.虚拟机启动后需要修改下虚拟机网卡名称 ifcfg-ens192
virsh start es-node2-192.168.20.105
通过ip a 获取网卡的名称，然后/etc/sysconfig/network-scripts/ifcfg-ens192 改成ip a 获取到的网 络文件
</pre></div>
</div>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id17"><span class="section-number">7.4.2. </span>转换格式</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>迁移VMware的镜像到zstack主要使用到两款工具：</p>
<ul class="simple">
<li><p>vmware-vdiskmanager（VMware自带工具，精简磁盘）</p></li>
<li><p>qemu-img（镜像转换格式）</p></li>
</ul>
<section id="id3">
<h4>1. 精简磁盘<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>命令案例如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vmware</span><span class="o">-</span><span class="n">vdiskmanager</span> <span class="o">-</span><span class="n">r</span> <span class="n">D</span><span class="p">:</span>\<span class="n">CentOS64</span>\<span class="n">CentOS</span><span class="o">-</span><span class="mf">64.</span><span class="n">vmdk</span> <span class="o">-</span><span class="n">t</span> <span class="mi">0</span> <span class="n">D</span><span class="p">:</span>\<span class="n">CentOS64</span>\<span class="n">CentOS</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">vmdk</span>
</pre></div>
</div>
<p>vmware-vdiskmanager使用：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>用法：vmware-vdiskmanager.exe选项&lt;disk-name&gt; | &lt;mount-point&gt;


脱机磁盘操作实用程序
  操作，一次只能指定一个：
     -c：创建磁盘。必须有其他创建选项
                            被指定。仅本地虚拟磁盘可以
                            创建。
     -d：对指定的虚拟磁盘进行碎片整理。仅有的
                            本地虚拟磁盘可能已碎片整理。
     -k：收缩指定的虚拟磁盘。仅本地
                            虚拟磁盘可能会缩小。
     -n &lt;源磁盘&gt;：重命名指定的虚拟磁盘；需要
                            指定目标磁盘名称。仅本地虚拟
                            磁盘可能会重命名。
     -p：准备由指定的已挂载的虚拟磁盘
                            缩小的安装点。
     -r &lt;源磁盘&gt;：转换指定的磁盘；需要指定
                            目标磁盘类型。对于本地目标磁盘
                            必须指定磁盘类型。
     -x &lt;新容量&gt;：将磁盘扩展到指定容量。仅有的
                            本地虚拟磁盘可能会扩展。
     -R：检查稀疏虚拟磁盘的一致性并尝试
                            修复任何错误。
     -e：检查磁盘链的一致性。
     -D：使磁盘可删除。仅应在磁盘上使用
                            已从另一产品复制的文件。
     -U：删除/取消链接单个磁盘链接。

  其他选项：
     -q：不记录消息

  用于创建和转换的其他选项：
     -a &lt;适配器&gt; ：（仅与-c一起使用）适配器类型
                            （ide，buslogic，lsilogic）。将lsilogic传递给其他适配器
     -s &lt;大小&gt;：虚拟磁盘的容量
     -t &lt;磁盘类型&gt;：磁盘类型标识

  磁盘类型：
      0：单个可增长虚拟磁盘
      1：可增长的虚拟磁盘拆分为多个文件
      2：预分配的虚拟磁盘
      3：将预分配的虚拟磁盘拆分为多个文件
      4：预分配的ESX型虚拟磁盘
      5：针对流进行了优化的压缩磁盘
      6：精简配置的虚拟磁盘-ESX 3.x及更高版本

     可以以扇区，KB，MB或GB来指定容量。

     可接受范围：
                           ide / scsi适配器：[1MB，8192.0GB]
                           buslogic适配器：[1MB，2040.0GB]
        例1：vmware-vdiskmanager.exe -c -s 850MB-助手-t 0 myIdeDisk.vmdk
        例2：vmware-vdiskmanager.exe -d myDisk.vmdk
        例3：vmware-vdiskmanager.exe -r sourceDisk.vmdk -t 0 destinationDisk.vmdk
        例4：vmware-vdiskmanager.exe -x 36GB myDisk.vmdk
        例5：vmware-vdiskmanager.exe -n sourceName.vmdk destinationName.vmdk
        例6：vmware-vdiskmanager.exe -k myDisk.vmdk
        例7：vmware-vdiskmanager.exe -p &lt;挂载点&gt;
              （首先需要在&lt;mount-point&gt;挂载虚拟磁盘）
</pre></div>
</div>
</section>
<section id="id4">
<span id="id5"></span><h4>2. 转换格式<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>命令案例如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">img</span> <span class="n">convert</span> <span class="o">-</span><span class="n">f</span> <span class="n">vmdk</span> <span class="o">-</span><span class="n">O</span> <span class="n">qcow2</span> <span class="n">CentOS</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">vmdk</span> <span class="n">CentOS</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">qcow2</span>
<span class="c1">## -f 指定文件格式</span>
<span class="c1">## -o 需要转成的格式</span>
</pre></div>
</div>
<p>检查上一步精简后的镜像是否存在问题，使用如下命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">img</span> <span class="n">info</span> <span class="n">CentOS</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">vmdk</span>
<span class="c1">## 检查镜像完整性</span>
</pre></div>
</div>
<p>主要流程如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>首先安装
yum install qemu-img –y

qemu-img info source-name.vmdk 查看虚拟机信息
qemu-img info Ubuntu-64-bit_12.04_EJBCA.vmdk

转换虚拟机格式，将vmdk转换为qcow2
qemu-img convert -f vmdk -O qcow2 source-name.vmdk target-name.qcow2

转换虚拟机定义文件
vmware2libvirt -f Metasploitable.vmx &gt; Metasploitable.xml

KVM中定义虚拟机
virsh -c qemu://system define Metasploitable.xml

打开KVM虚拟机管理软件
sudo virt-manager
</pre></div>
</div>
</section>
<section id="id6">
<h4>3. 导入<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>qcow2为安装好的系统打包成的镜像，qcow2镜像格式直接导入创建云主机就可以了，无需在进行系统安装。</p>
<p>参考文献：</p>
<p><a class="reference external" href="https://www.cnblogs.com/she11s/p/14587920.html">https://www.cnblogs.com/she11s/p/14587920.html</a></p>
<p><a class="reference external" href="https://blog.csdn.net/tantexian/article/details/42677427">https://blog.csdn.net/tantexian/article/details/42677427</a></p>
<p><a class="reference external" href="https://blog.csdn.net/annita2019/article/details/108758953?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-10.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-10.control">https://blog.csdn.net/annita2019/article/details/108758953?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-10.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-10.control</a></p>
</section>
</section>
<section id="windows">
<h3><a class="toc-backref" href="#id18"><span class="section-number">7.4.3. </span>windows迁移流程</a><a class="headerlink" href="#windows" title="Permalink to this headline">¶</a></h3>
<p>window2012、window2016最终可行的方案是下面这个流程：
1.使用qemu-img将vmdk文件转换成qcow2文件</p>
<p>2.通过图形化界面的virt-manager打开这个文件为虚拟机</p>
<p>3.添加软盘设备</p>
<p>4.添加virtio格式的硬盘</p>
<p>5.启动虚拟机，更新网卡驱动，新磁盘的驱动</p>
<p>6.关机，删除临时磁盘，将源磁盘格式改为virtio格式</p>
<p>具体过程如下：</p>
<p><a class="reference external" href="https://blog.csdn.net/qq_33317586/article/details/85613254?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522162080602816780269825776%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=162080602816780269825776&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2">https://blog.csdn.net/qq_33317586/article/details/85613254?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522162080602816780269825776%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=162080602816780269825776&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2</a><sub>all</sub>first_rank_v2~rank_v29-12-85613254.pc_search_result_before_js&amp;utm_term=ESXI+%E8%BF%81%E7%A7%BB%E8%87%B3KVM+%28V2V%E8%BF%81%E7%A7%BB%29&amp;spm=1018.2226.3001.4187</p>
<p>参考文献：</p>
<p><a class="reference external" href="https://blog.csdn.net/minxihou/article/details/52950125">https://blog.csdn.net/minxihou/article/details/52950125</a></p>
<p><a class="reference external" href="https://myfirstwon.com/esxi-kvm/">https://myfirstwon.com/esxi-kvm/</a></p>
<p><a class="reference external" href="https://blog.csdn.net/zstack_org/article/details/90082062">https://blog.csdn.net/zstack_org/article/details/90082062</a></p>
<p><a class="reference external" href="https://www.cnblogs.com/deelaaay/p/14138751.html">https://www.cnblogs.com/deelaaay/p/14138751.html</a></p>
<p><strong>Centos7系统下KVM虚拟化Migration(06)–企业迁移案例</strong></p>
<p><a class="reference external" href="https://blog.csdn.net/weixin_48504920/article/details/106662490?spm=1001.2014.3001.5502">https://blog.csdn.net/weixin_48504920/article/details/106662490?spm=1001.2014.3001.5502</a></p>
<p><strong>Centos7系统下KVM虚拟化Migration(07)–企业迁移案例</strong></p>
<p><a class="reference external" href="https://blog.csdn.net/weixin_48504920/article/details/106662493?spm=1001.2014.3001.5502">https://blog.csdn.net/weixin_48504920/article/details/106662493?spm=1001.2014.3001.5502</a></p>
<p><strong>Centos7系统下KVM虚拟化Migration(08)–企业迁移案例</strong></p>
<p><a class="reference external" href="https://blog.csdn.net/weixin_48504920/article/details/106662416?spm=1001.2014.3001.5502">https://blog.csdn.net/weixin_48504920/article/details/106662416?spm=1001.2014.3001.5502</a></p>
<p><strong>ESXI 迁移至KVM (V2V迁移)</strong></p>
<p>参考文献： <a class="reference external" href="https://www.cnblogs.com/clsn/p/8510670.html">https://www.cnblogs.com/clsn/p/8510670.html</a></p>
</section>
</section>
<section id="kvmvmdk">
<h2><a class="toc-backref" href="#id19"><span class="section-number">7.5. </span>Kvm转换为vmdk</a><a class="headerlink" href="#kvmvmdk" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://blog.csdn.net/weixin_48504920/article/details/106662416?spm=1001.2014.3001.5502">https://blog.csdn.net/weixin_48504920/article/details/106662416?spm=1001.2014.3001.5502</a></p>
</section>
<section id="qcow2raw">
<h2><a class="toc-backref" href="#id20"><span class="section-number">7.6. </span>qcow2转换为raw</a><a class="headerlink" href="#qcow2raw" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~$ qemu-img convert -O qcow2 image-raw.raw image-raw-converted.qcow
</pre></div>
</div>
<section id="rawqcow2">
<h3><a class="toc-backref" href="#id21"><span class="section-number">7.6.1. </span>raw格式和qcow2格式的转化</a><a class="headerlink" href="#rawqcow2" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>raw –&gt; qcow2</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">img</span> <span class="n">convert</span> <span class="o">-</span><span class="n">f</span> <span class="n">raw</span> <span class="o">-</span><span class="n">O</span> <span class="n">qcow2</span> <span class="n">centos</span><span class="o">.</span><span class="n">raw</span> <span class="n">centos</span><span class="o">.</span><span class="n">qcow2</span>
</pre></div>
</div>
</li>
<li><p>qcow2 –&gt; raw</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">img</span> <span class="n">convert</span> <span class="o">-</span><span class="n">f</span> <span class="n">qcow2</span> <span class="o">-</span><span class="n">O</span> <span class="n">raw</span> <span class="n">centos</span><span class="o">.</span><span class="n">qcow2</span> <span class="n">centos</span><span class="o">.</span><span class="n">raw</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="id7">
<h2><a class="toc-backref" href="#id22"><span class="section-number">7.7. </span>raw转换为qcow2</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 参数说明</span>
<span class="o">[</span>root@kvm data<span class="o">]</span><span class="c1"># qemu-img  --help |grep convert</span>
qemu-img convert <span class="o">[</span>-f fmt<span class="o">]</span> <span class="o">[</span>-O output_fmt<span class="o">]</span> filename  output_filename
</pre></div>
</div>
<p>转换原有磁盘格式</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@kvm data<span class="o">]</span><span class="c1"># qemu-img convert -f raw -O qcow2 clsn.raw clsn.qcow2</span>

<span class="c1"># 带有进度条的转换</span>
<span class="c1"># qemu-img convert Centos7.5.vmdk -O qcow2 Centos7.5.qcow2 -p</span>
    <span class="o">(</span><span class="m">100</span>.00/100%<span class="o">)</span>

<span class="c1"># 安装qcow2镜像的的虚拟机</span>
virt-install --name VM01 --ram <span class="m">4096</span> --vcpus<span class="o">=</span><span class="m">2</span> --disk <span class="nv">path</span><span class="o">=</span>/home/Centos7.5.qcow2 --network<span class="o">=</span>bridge:virbr0 --force --import --autostart
</pre></div>
</div>
</section>
<section id="ovaovf">
<h2><a class="toc-backref" href="#id23"><span class="section-number">7.8. </span>ova转换为ovf</a><a class="headerlink" href="#ovaovf" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ovftool --lax Centos6.6-lamp.ova Centos6.6-lamp.ovf
ovftool --overwrite --shaAlgorithm<span class="o">=</span>sha1 --lax Centos6.6-lamp.ova Centos6.6-lamp.ovf

<span class="c1">#修改.ovf文件</span>
&lt;vssd:VirtualSystemType&gt;virtualbox-2.2&lt;/vssd:VirtualSystemType&gt;

<span class="c1">#修改为</span>
&lt;vssd:VirtualSystemType&gt;vmx-07&lt;/vssd:VirtualSystemType&gt;

<span class="c1">#修改mf文件的sha1</span>
<span class="nb">echo</span> sha1<span class="o">(</span>file_get_contents<span class="o">(</span><span class="s1">&#39;xxx.mf&#39;</span><span class="o">))</span>
</pre></div>
</div>
</section>
<section id="virtualboxkvm">
<h2><a class="toc-backref" href="#id24"><span class="section-number">7.9. </span>VirtualBox迁移到KVM</a><a class="headerlink" href="#virtualboxkvm" title="Permalink to this headline">¶</a></h2>
<p>也可以将VirtualBox客户机镜像文件转化为QEMU/KVM中最常用的qcow2或raw格式
的镜像文件，然后在qemu命令行启动转化后的镜像文件。命令行操作如下：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@kvm-host ~<span class="o">]</span><span class="c1"># qemu-img convert ubuntu.vdi -O qcow2 ubuntu.qcow2</span>
<span class="o">[</span>root@kvm-host ~<span class="o">]</span><span class="c1"># qemu-img -m 1024 ubuntu.qcow2</span>
</pre></div>
</div>
</section>
<section id="kvmvmware">
<h2><a class="toc-backref" href="#id25"><span class="section-number">7.10. </span>KVM虚机迁移到VMware</a><a class="headerlink" href="#kvmvmware" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1.将kvm下虚拟机关机；

2.将kvm下img文件格式的虚拟机转换成vmdk格式，命令如下：

# qemu-img convert testvm1.img –O vmdk /tmp/testvm1.vmdk

3.在VMware vSphere环境里创建一个虚拟机和kvm环境虚拟机配置相同，不用创建磁盘使用刚刚转换的vmdk文件，开启虚拟机即可
</pre></div>
</div>
<p>KVM虚拟机迁移至VMware参考：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">blog</span><span class="o">.</span><span class="n">csdn</span><span class="o">.</span><span class="n">net</span><span class="o">/</span><span class="n">zhongbeida_xue</span><span class="o">/</span><span class="n">article</span><span class="o">/</span><span class="n">details</span><span class="o">/</span><span class="mi">95072123</span>
</pre></div>
</div>
</section>
<section id="kvmvmware-esxi">
<h2><a class="toc-backref" href="#id26"><span class="section-number">7.11. </span>KVM镜像转vmware esxi</a><a class="headerlink" href="#kvmvmware-esxi" title="Permalink to this headline">¶</a></h2>
<p>1.将kvm下虚拟机关机；</p>
<p>2.将kvm下img文件格式的虚拟机转换成vmdk格式，命令如下：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 该命令只转换为vmware workstation的兼容.</span>

yum install qemu-img –y
qemu-img info source-name.vmdk 查看虚拟机信息

qemu-img convert -f qcow2 file.qcow2 -O vmdk file.vmdk
</pre></div>
</div>
<p>3.将镜像文件传递到 esxi 中</p>
<ol class="arabic simple" start="4">
<li><p>转换esxi兼容的硬盘格式.
对于不同版本的ESXi服务器来说，这里转换的格式会有差异，比如ESXi6.7上默认是zeroedthick，通过vsphere
web client访问添加磁盘，无法修改：“scsi0:0”的磁盘类型 2
不受支持或无效。请确保磁盘已导入。</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zeroedthick</span>          <span class="n">厚置备延迟置零</span>
<span class="n">thin</span>                  <span class="n">精简置备</span>
<span class="n">eagerzeroedthick</span>      <span class="n">厚置备置零</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 转换为esxi兼容.</span>
vmkfstools -i myImage.vmdk outputName.vmdk -d thin
</pre></div>
</div>
<p>注意这样转换出来的是两个文件：一个outputName.vmdk
是元数据，一个outputName-flat.vmdk是硬盘数据，
二者必须保持一致的命名，如果要移动必须一起移动。不要自己给硬盘文件取名的时候在后面加-flat，这会导致问题。</p>
<p>5.在 esxi
环境里创建一个虚拟机和kvm环境虚拟机配置相同，不用创建磁盘使用刚刚转换的vmdk文件，开启虚拟机即可.
如果找不到启动项，请修改启动引导固件（Bios,EFI）然后在试试</p>
<blockquote>
<div><p>KVM虚拟机迁移到VMWare ESXi
<a class="reference external" href="https://blog.csdn.net/avatar_2009/article/details/117769202">https://blog.csdn.net/avatar_2009/article/details/117769202</a></p>
</div></blockquote>
</section>
<section id="openstack-p2v">
<h2><a class="toc-backref" href="#id27"><span class="section-number">7.12. </span>openstack 平台P2V迁移</a><a class="headerlink" href="#openstack-p2v" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>参考文献</p>
<p><a class="reference external" href="https://www.cnblogs.com/yanling-coder/p/11814045.html">https://www.cnblogs.com/yanling-coder/p/11814045.html</a></p>
</div></blockquote>
</section>
<section id="openstack-rawvmdk">
<h2><a class="toc-backref" href="#id28"><span class="section-number">7.13. </span>Openstack下云迁移(raw转vmdk)</a><a class="headerlink" href="#openstack-rawvmdk" title="Permalink to this headline">¶</a></h2>
<p>阿里云ECS系统盘镜像备份恢复到本地VMware</p>
<p><a class="reference external" href="https://blog.csdn.net/weixin_44312328/article/details/106265890">https://blog.csdn.net/weixin_44312328/article/details/106265890</a></p>
<p>导出镜像备份阿里ECS并在本地虚拟机中运行</p>
<p><a class="reference external" href="https://blog.csdn.net/iSunwish/article/details/118438359">https://blog.csdn.net/iSunwish/article/details/118438359</a></p>
<p>openstack环境虚拟机（KVM）到vsphere环境的手动迁移（Linux系统）</p>
<p><a class="reference external" href="http://blog.sina.com.cn/s/blog_c094640c0102wpyi.html">http://blog.sina.com.cn/s/blog_c094640c0102wpyi.html</a></p>
</section>
<section id="vmware-esxi">
<h2><a class="toc-backref" href="#id29"><span class="section-number">7.14. </span>Vmware esxi虚拟机冷迁移至各虚拟化平台方案</a><a class="headerlink" href="#vmware-esxi" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.cnblogs.com/deelaaay/p/14138751.html">https://www.cnblogs.com/deelaaay/p/14138751.html</a></p>
</section>
<section id="vmware-exsi-vmzstack">
<h2><a class="toc-backref" href="#id30"><span class="section-number">7.15. </span>Vmware exsi vm迁移到Zstack实战</a><a class="headerlink" href="#vmware-exsi-vmzstack" title="Permalink to this headline">¶</a></h2>
<section id="id8">
<h3><a class="toc-backref" href="#id31"><span class="section-number">7.15.1. </span>方法1</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p><strong>virt-v2v-copy-to-local这个工具</strong></p>
<ol class="arabic simple">
<li><p>将exsi主机上的虚拟机关机，将虚拟机硬盘迁移到本地</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">测试KVM连接ESXI</span>
<span class="c1"># virsh  -c esx://root@192.168.1.58?no_verify=1 list --all</span>

<span class="o">//</span> <span class="n">迁移到本地</span>
<span class="c1"># virt-v2v-copy-to-local -ic esx://root@192.168.1.58/?no_verify=1 docker-s1</span>
  <span class="o">%</span> <span class="n">Total</span>    <span class="o">%</span> <span class="n">Received</span> <span class="o">%</span> <span class="n">Xferd</span>  <span class="n">Average</span> <span class="n">Speed</span>   <span class="n">Time</span>    <span class="n">Time</span>     <span class="n">Time</span>  <span class="n">Current</span>
                                 <span class="n">Dload</span>  <span class="n">Upload</span>   <span class="n">Total</span>   <span class="n">Spent</span>    <span class="n">Left</span>  <span class="n">Speed</span>
  <span class="mi">1</span>  <span class="mi">100</span><span class="n">G</span>    <span class="mi">1</span> <span class="mi">1096</span><span class="n">M</span>    <span class="mi">0</span>     <span class="mi">0</span>  <span class="mf">38.6</span><span class="n">M</span>      <span class="mi">0</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">06</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">28</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">38</span> <span class="mf">44.1</span><span class="n">M</span>

<span class="c1"># mkdir -p ./vm_data/v2v/</span>

<span class="c1"># virt-v2v -i libvirtxml docker-s1.xml -o local -os vm_data/v2v/ -of qcow2</span>
<span class="p">[</span>   <span class="mf">0.0</span><span class="p">]</span> <span class="n">Opening</span> <span class="n">the</span> <span class="n">source</span> <span class="o">-</span><span class="n">i</span> <span class="n">libvirtxml</span> <span class="n">docker</span><span class="o">-</span><span class="n">s1</span><span class="o">.</span><span class="n">xml</span>
<span class="p">[</span>   <span class="mf">0.0</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">an</span> <span class="n">overlay</span> <span class="n">to</span> <span class="n">protect</span> <span class="n">the</span> <span class="n">source</span> <span class="kn">from</span> <span class="nn">being</span> <span class="n">modified</span>
<span class="p">[</span>  <span class="mf">25.0</span><span class="p">]</span> <span class="n">Opening</span> <span class="n">the</span> <span class="n">overlay</span>
<span class="p">[</span>  <span class="mf">50.8</span><span class="p">]</span> <span class="n">Inspecting</span> <span class="n">the</span> <span class="n">overlay</span>
<span class="p">[</span>  <span class="mf">78.2</span><span class="p">]</span> <span class="n">Checking</span> <span class="k">for</span> <span class="n">sufficient</span> <span class="n">free</span> <span class="n">disk</span> <span class="n">space</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">guest</span>
<span class="p">[</span>  <span class="mf">78.2</span><span class="p">]</span> <span class="n">Estimating</span> <span class="n">space</span> <span class="n">required</span> <span class="n">on</span> <span class="n">target</span> <span class="k">for</span> <span class="n">each</span> <span class="n">disk</span>
<span class="p">[</span>  <span class="mf">78.2</span><span class="p">]</span> <span class="n">Converting</span> <span class="n">CentOS</span> <span class="n">Linux</span> <span class="n">release</span> <span class="mf">7.9.2009</span> <span class="p">(</span><span class="n">Core</span><span class="p">)</span> <span class="n">to</span> <span class="n">run</span> <span class="n">on</span> <span class="n">KVM</span>
<span class="n">virt</span><span class="o">-</span><span class="n">v2v</span><span class="p">:</span> <span class="n">This</span> <span class="n">guest</span> <span class="n">has</span> <span class="n">virtio</span> <span class="n">drivers</span> <span class="n">installed</span><span class="o">.</span>
<span class="p">[</span> <span class="mf">219.8</span><span class="p">]</span> <span class="n">Mapping</span> <span class="n">filesystem</span> <span class="n">data</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">copying</span> <span class="n">unused</span> <span class="ow">and</span> <span class="n">blank</span> <span class="n">areas</span>
<span class="p">[</span> <span class="mf">220.9</span><span class="p">]</span> <span class="n">Closing</span> <span class="n">the</span> <span class="n">overlay</span>
<span class="p">[</span> <span class="mf">221.1</span><span class="p">]</span> <span class="n">Assigning</span> <span class="n">disks</span> <span class="n">to</span> <span class="n">buses</span>
<span class="p">[</span> <span class="mf">221.1</span><span class="p">]</span> <span class="n">Checking</span> <span class="k">if</span> <span class="n">the</span> <span class="n">guest</span> <span class="n">needs</span> <span class="n">BIOS</span> <span class="ow">or</span> <span class="n">UEFI</span> <span class="n">to</span> <span class="n">boot</span>
<span class="p">[</span> <span class="mf">221.1</span><span class="p">]</span> <span class="n">Initializing</span> <span class="n">the</span> <span class="n">target</span> <span class="o">-</span><span class="n">o</span> <span class="n">local</span> <span class="o">-</span><span class="n">os</span> <span class="n">vm_data</span><span class="o">/</span><span class="n">v2v</span><span class="o">/</span>
<span class="p">[</span> <span class="mf">221.1</span><span class="p">]</span> <span class="n">Copying</span> <span class="n">disk</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span> <span class="n">to</span> <span class="n">vm_data</span><span class="o">/</span><span class="n">v2v</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">s1</span><span class="o">-</span><span class="n">sda</span> <span class="p">(</span><span class="n">qcow2</span><span class="p">)</span>
    <span class="p">(</span><span class="mf">100.00</span><span class="o">/</span><span class="mi">100</span><span class="o">%</span><span class="p">)</span>
<span class="p">[</span> <span class="mf">253.3</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">output</span> <span class="n">metadata</span>
<span class="p">[</span> <span class="mf">254.1</span><span class="p">]</span> <span class="n">Finishing</span> <span class="n">off</span>

<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="mi">192</span><span class="o">-</span><span class="mi">168</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">21</span> <span class="n">VM</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">Zstack</span><span class="p">]</span><span class="c1"># cd vm_data/v2v/</span>
<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="mi">192</span><span class="o">-</span><span class="mi">168</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">21</span> <span class="n">v2v</span><span class="p">]</span><span class="c1"># ll</span>
<span class="n">total</span> <span class="mi">4578760</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4688707584</span> <span class="n">May</span> <span class="mi">12</span> <span class="mi">22</span><span class="p">:</span><span class="mi">42</span> <span class="n">docker</span><span class="o">-</span><span class="n">s1</span><span class="o">-</span><span class="n">sda</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>       <span class="mi">1501</span> <span class="n">May</span> <span class="mi">12</span> <span class="mi">22</span><span class="p">:</span><span class="mi">42</span> <span class="n">docker</span><span class="o">-</span><span class="n">s1</span><span class="o">.</span><span class="n">xml</span>
<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="mi">192</span><span class="o">-</span><span class="mi">168</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">21</span> <span class="n">v2v</span><span class="p">]</span><span class="c1"># du -sh *</span>
<span class="mf">4.4</span><span class="n">G</span>    <span class="n">docker</span><span class="o">-</span><span class="n">s1</span><span class="o">-</span><span class="n">sda</span>
<span class="mf">4.0</span><span class="n">K</span>    <span class="n">docker</span><span class="o">-</span><span class="n">s1</span><span class="o">.</span><span class="n">xml</span>

<span class="o">//</span> <span class="n">更改后缀名为qcow2</span>
<span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="mi">192</span><span class="o">-</span><span class="mi">168</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">21</span> <span class="n">v2v</span><span class="p">]</span><span class="c1"># mv docker-s1-sda docker-s1-sda.qcow2</span>
</pre></div>
</div>
<p>然后在进行接下来的添加镜像操作 选择云资源池-&gt;镜像-&gt;添加镜像</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">URL</span><span class="p">:</span> <span class="n">file</span><span class="p">:</span><span class="o">///</span><span class="n">root</span><span class="o">/</span><span class="n">VM</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">Zstack</span><span class="o">/</span><span class="n">vm_data</span><span class="o">/</span><span class="n">v2v</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">s1</span><span class="o">-</span><span class="n">sda</span><span class="o">.</span><span class="n">qcow2</span>
</pre></div>
</div>
<p><img alt="image0" src="../_images/vmware2zstack001.png" /></p>
<p>添加完毕镜像以后再来到云主机的创建流程 云资源池-&gt;云主机-&gt;创建云主机</p>
<p>这里我选择了不由ZStack分配IP，来验证之前的由主路由器来分配IP，体验无修改迁移。
创建完毕以后自动运行云主机，然后通过控制台访问，查看云主机IP以及是否能通过局域网ping通。</p>
<p>整个VMware下的虚拟机也完整的无缝迁移到了ZStack，本以为很麻烦、工作量很大的迁移，就在ZStack的加持下让一切变得如此简单。</p>
<section id="linux">
<h4>Linux修改网卡名称<a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h4>
<p>迁移完毕后，修改网卡名称</p>
<p>编辑配置文件/etc/sysconfig/network-scripts/ifcfg-eno16777736</p>
<p>将DEVICE=eno16777736修改成DEVICE=eth0</p>
<p>重命名该配置文件。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cd /etc/sysconfig/network-scripts/</span>
<span class="c1"># mv ifcfg-eno16777736 ifcfg-eth0</span>
</pre></div>
</div>
<p>编辑/etc/default/grub并加入</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">net</span><span class="o">.</span><span class="n">ifnames</span><span class="o">=</span><span class="mi">0</span> <span class="n">biosdevname</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
<p>重新生成GRUB配置并更新内核参数</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grub2</span><span class="o">-</span><span class="n">mkconfig</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">grub2</span><span class="o">/</span><span class="n">grub</span><span class="o">.</span><span class="n">cfg</span>
</pre></div>
</div>
<p>使用reboot命令重启操作系统。</p>
<p>修改网卡名称参考文献：</p>
<p><a class="reference external" href="https://i4t.com/3723.html">https://i4t.com/3723.html</a></p>
<p>参考文献</p>
<p>virt-v2v 使用指南</p>
<p><a class="reference external" href="https://blog.csdn.net/qq_33932782/article/details/53997023">https://blog.csdn.net/qq_33932782/article/details/53997023</a></p>
<p><a class="reference external" href="https://blog.csdn.net/zstack_org/article/details/90082062">https://blog.csdn.net/zstack_org/article/details/90082062</a></p>
</section>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id32"><span class="section-number">7.15.2. </span>方法2</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p><strong>直接连接vcenter转换</strong></p>
<ol class="arabic simple">
<li><p>登录到zstack服务器后台，执行如下命令</p></li>
</ol>
<p>将vcenter虚拟机转换为kvm虚拟机</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># export LIBGUESTFS_BACKEND=direct</span>

<span class="o">-</span> <span class="n">local模式</span><span class="p">,</span> <span class="o">%</span><span class="mi">40</span><span class="n">为</span><span class="o">@</span>
<span class="o">-</span> <span class="mf">192.168.1.40</span> <span class="n">为vcenterIP</span>
<span class="o">-</span> <span class="n">OSChina</span>  <span class="n">数据中心名称</span>
<span class="o">-</span> <span class="mf">192.168.1.58</span> <span class="n">为待转换虚拟机所在的esxi服务器IP</span>

<span class="c1"># virt-v2v -ic vpx://administrator%40vsphere.local@192.168.1.40/OSChina/192.168.1.58?no_verify=1 docker-s1 -o libvirt -of qcow2</span>
</pre></div>
</div>
<p><strong>如何将KVM上的云主机迁移到ZStack中？</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>A：
1. 通过libvirt导出云主机的镜像（.qcow2文件）。
2. 将镜像上传至一个http服务器中。
3. 使用ZStack镜像服务器导入镜像。
4. 通过镜像创建云主机。
注:如果原来的云主机挂载了数据云盘，如何将数据云盘也迁移过来呢?

• 方法一：
与上述操作类似，需要先将数据盘生成镜像，同理导入，ZStack使用该镜像创建数据
云盘，再将数据云盘挂载到云主机即可。

• 方法二:
先在ZStack中创建一个相同大小的数据云盘，找到对应的路径，将原云盘数据直接复
制到新的路径下，最后再挂载到云主机上。
</pre></div>
</div>
<p>参考文献：</p>
<p><a class="reference external" href="https://www.cnblogs.com/jinyuanliu/p/10488033.html">https://www.cnblogs.com/jinyuanliu/p/10488033.html</a></p>
</section>
</section>
<section id="id10">
<h2><a class="toc-backref" href="#id33"><span class="section-number">7.16. </span>参考文献</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>vmware迁移到zstack</p>
<p><a class="reference external" href="https://www.cnblogs.com/she11s/p/14587920.html">https://www.cnblogs.com/she11s/p/14587920.html</a></p>
<p><a class="reference external" href="https://blog.csdn.net/zstack_org/article/details/90082062">https://blog.csdn.net/zstack_org/article/details/90082062</a></p>
<p>vmware转kvm格式</p>
<p><a class="reference external" href="https://blog.csdn.net/zstack_org/article/details/90082062">https://blog.csdn.net/zstack_org/article/details/90082062</a>
<a class="reference external" href="https://www.cnblogs.com/she11s/p/14587920.html">https://www.cnblogs.com/she11s/p/14587920.html</a></p>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="06.KVM%E7%9B%B8%E5%85%B3%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE.html" class="btn btn-neutral float-left" title="6. KVM相关参考文献" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="08.KVM%E5%B8%A6web%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2.html" class="btn btn-neutral float-right" title="8. KVM带web管理界面" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>