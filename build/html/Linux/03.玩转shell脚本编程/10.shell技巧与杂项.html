<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3.10. shell技巧与杂项 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3.11. xagrs使用" href="11.xagrs%E4%BD%BF%E7%94%A8.html" />
    <link rel="prev" title="3.9. 9 三剑客之awk" href="09.%E4%B8%89%E5%89%91%E5%AE%A2-awk.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> 小健_Linux-shell-Devops_Blog
            <img src="../../_static/devops_photo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../DevOps/index.html">DevOps和自动化运维实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Github/index.html">Github入门到实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Jenkins/index.html">Jenkins持续化集成</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../KVM/index.html">KVM实践</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01.%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%92%8C%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/index.html">1. 命令行和操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02.Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%B6%E8%AE%BE/index.html">2. Linux服务器架设</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">3. 玩转shell脚本编程</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html">3.1. 1 基础知识</a></li>
<li class="toctree-l3"><a class="reference internal" href="02.%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8E%E6%95%B0%E7%BB%84.html">3.2. 2 字符串与数组</a></li>
<li class="toctree-l3"><a class="reference internal" href="03.%E8%BF%90%E7%AE%97%E7%AC%A6.html">3.3. 3 运算符</a></li>
<li class="toctree-l3"><a class="reference internal" href="04.%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6.html">3.4. 4 流程控制</a></li>
<li class="toctree-l3"><a class="reference internal" href="05.%E5%87%BD%E6%95%B0.html">3.5. 5 函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="06.%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F.html">3.6. 6 正则表达式</a></li>
<li class="toctree-l3"><a class="reference internal" href="07.%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep.html">3.7. 7 三剑客之grep</a></li>
<li class="toctree-l3"><a class="reference internal" href="08.%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed.html">3.8. 8 三剑客之sed</a></li>
<li class="toctree-l3"><a class="reference internal" href="09.%E4%B8%89%E5%89%91%E5%AE%A2-awk.html">3.9. 9 三剑客之awk</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">3.10. shell技巧与杂项</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#echoprintf">3.10.1. echo和printf打印</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cron">3.10.2. cron</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">3.10.3. 标准输入输出重定向</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">3.10.4. 常见小技巧</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">3.10.5. Shell脚本的调试技术</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">3.10.6. 信号的名称和值</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">3.10.7. Shell脚本的参数解析工具</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">3.10.8. 子shell</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">3.10.9. 自动化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id23">3.10.10. Shell脚本实战</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id24">3.10.11. 服务脚本的基本语法</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="11.xagrs%E4%BD%BF%E7%94%A8.html">3.11. xagrs使用</a></li>
<li class="toctree-l3"><a class="reference internal" href="12.%E6%94%B6%E9%9B%86%E7%9A%84%E4%B8%80%E4%BA%9Bshell%E8%84%9A%E6%9C%AC.html">3.12. 收集的一些shell脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="13.%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85zabbix%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%84%9A%E6%9C%AC.html">3.13. 自动化安装zabbix</a></li>
<li class="toctree-l3"><a class="reference internal" href="14.%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AE%89%E8%A3%85cacti%E8%84%9A%E6%9C%AC.html">3.14. 自动化安装cacti服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="15.%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85MongoDB%E8%84%9A%E6%9C%AC.html">3.15. 自动化安装MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="16.%E5%A4%87%E4%BB%BDMongoDB%E8%84%9A%E6%9C%AC.html">3.16. 备份MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="17.%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85memcached%E8%84%9A%E6%9C%AC.html">3.17. 自动安装memcached</a></li>
<li class="toctree-l3"><a class="reference internal" href="18.system%E6%A3%80%E6%B5%8B%E8%84%9A%E6%9C%AC.html">3.18. 系统各项内容检测check_os</a></li>
<li class="toctree-l3"><a class="reference internal" href="19.%E5%AE%89%E8%A3%85tomcat%E8%84%9A%E6%9C%AC.html">3.19. 安装tomcat脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="20.install_zookeeper%E8%84%9A%E6%9C%AC.html">3.20. install_zookeeper脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="21.install_elasticserch%E8%84%9A%E6%9C%AC.html">3.21. install_elasticserch脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="22.%E8%87%AA%E5%8A%A8Autoinstall_ELK_V1.3.html">3.22. 自动Autoinstall_ELK_V1.3脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="23.install_vsftpd%E8%84%9A%E6%9C%AC.html">3.23. install_vsftpd_or_nfs脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="24.install_mysql5.7.html">3.24. install_mysql5.7</a></li>
<li class="toctree-l3"><a class="reference internal" href="25.Linux%E4%B8%8B%E4%BB%A5%E7%A7%92%E4%B8%BA%E5%8D%95%E4%BD%8D%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC.html">3.25. Linux下以秒为单位执行脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="26.%E5%A4%87%E4%BB%BD%E6%96%87%E4%BB%B6shell%E8%84%9A%E6%9C%AC.html">3.26. 备份文件shell脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="27.monitor_Linux%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD.html">3.27. monitor_Linux系统性能</a></li>
<li class="toctree-l3"><a class="reference internal" href="28.%E4%BF%AE%E6%94%B9IP_%E4%B8%BB%E6%9C%BA%E5%90%8D_%E7%BD%91%E5%8D%A1%E4%BF%A1%E6%81%AF%E8%84%9A%E6%9C%AC.html">3.28. 修改IP_主机名_网卡信息脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="29.%E6%A3%80%E6%9F%A5%E6%81%B6%E6%84%8FIP%E7%99%BB%E5%BD%95%EF%BC%8C%E6%8B%92%E7%BB%9DSSH.html">3.29. 检查恶意IP登录，拒绝SSH</a></li>
<li class="toctree-l3"><a class="reference internal" href="30.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD.html">3.30. 数据库备份</a></li>
<li class="toctree-l3"><a class="reference internal" href="31.Centos6%E5%BC%80%E6%9C%BA%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html">3.31. Centos6x开机性能优化</a></li>
<li class="toctree-l3"><a class="reference internal" href="32.%E7%99%BE%E5%AE%9D%E7%AE%B1%E8%84%9A%E6%9C%AC.html">3.32. 百宝箱脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="33.deploy_mongo.html">3.33. 使用python脚本安装MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="34.python%E5%AE%9E%E7%8E%B0%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F.html">3.34. python实现端口扫描</a></li>
<li class="toctree-l3"><a class="reference internal" href="35.python%E6%A3%80%E6%B5%8Bip%E5%AD%98%E6%B4%BB%E7%8A%B6%E6%80%81.html">3.35. python检测ip存活状态</a></li>
<li class="toctree-l3"><a class="reference internal" href="36.k8s_deploy%E8%84%9A%E6%9C%AC.html">3.36. k8s_deploy脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="37.example%28%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%29.html">3.37. example(字符串处理)</a></li>
<li class="toctree-l3"><a class="reference internal" href="38.%E7%94%A8Python%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BDMongodb%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%B9%B6%E4%B8%8A%E4%BC%A0%E5%88%B0FTP%E6%9C%8D%E5%8A%A1%E5%99%A8.html">3.38. 用Python实现定时备份Mongodb数据，并上传到FTP服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="39.Nginx%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2%E8%84%9A%E6%9C%AC.html">3.39. Nginx日志切割脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="40.%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85Docker%E8%84%9A%E6%9C%AC.html">3.40. 一键安装docker脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="41.shell%E5%AE%9E%E7%8E%B0%E5%A4%9A%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E8%84%9A%E6%9C%AC.html">3.41. shell实现多并发控制</a></li>
<li class="toctree-l3"><a class="reference internal" href="42.%E5%88%A4%E6%96%AD%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B.html">3.42. 判断文件类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="43.%E7%94%A8if%E8%AF%AD%E5%8F%A5%E7%BC%96%E5%86%99%E9%80%89%E6%8B%A9%E8%8F%9C%E5%8D%95.html">3.43. 用if语句编写选择菜单</a></li>
<li class="toctree-l3"><a class="reference internal" href="44.%E4%BD%BF%E7%94%A8while%E8%AF%AD%E5%8F%A5%E7%BC%96%E5%86%99%E9%80%89%E6%8B%A9%E8%8F%9C%E5%8D%95.html">3.44. 使用while语句编写选择菜单</a></li>
<li class="toctree-l3"><a class="reference internal" href="45.%E4%BD%BF%E7%94%A8until%E7%BC%96%E5%86%99%E9%80%89%E6%8B%A9%E8%8F%9C%E5%8D%95.html">3.45. 使用until编写选择菜单</a></li>
<li class="toctree-l3"><a class="reference internal" href="46.%E7%9B%AE%E5%BD%95%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD.html">3.46. 目录定时备份</a></li>
<li class="toctree-l3"><a class="reference internal" href="47.%E8%BF%9C%E7%A8%8B%E6%93%8D%E4%BD%9Cftp%E8%BF%9B%E8%A1%8C%E4%B8%8A%E4%BC%A0%E5%92%8C%E4%B8%8B%E8%BD%BD.html">3.47. 远程操作ftp进行上传和下载</a></li>
<li class="toctree-l3"><a class="reference internal" href="48.%E6%89%B9%E9%87%8F%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E8%84%9A%E6%9C%AC.html">3.48. 批量创建用户脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="49.Centos%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8%E7%89%88%E6%9C%AC%28%E9%99%84%E5%B8%A6%E5%8D%87%E7%BA%A7%E8%84%9A%E6%9C%AC%29.html">3.49. Centos升级内核版本(附带升级脚本)</a></li>
<li class="toctree-l3"><a class="reference internal" href="50.CPU%E7%9B%91%E6%8E%A7%E8%84%9A%E6%9C%AC.html">3.50. CPU监控脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="51.%E6%A3%80%E6%B5%8B%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E6%98%AF%E5%90%A6%E8%B6%85%E6%97%B6.html">3.51. 检测函数执行是否超时</a></li>
<li class="toctree-l3"><a class="reference internal" href="52.%E8%80%81%E7%94%B7%E5%AD%A9Shell%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98.html">3.52. 老男孩Shell编程实战</a></li>
<li class="toctree-l3"><a class="reference internal" href="53.%E5%BF%AB%E6%8D%B7%E5%AE%89%E8%A3%85%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%ACPython.html">3.53. 快捷安装不同版本Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="54.%E5%B8%B8%E7%94%A8shell%E8%84%9A%E6%9C%AC%E5%A4%A7%E5%85%A8.html">3.54. 常用shell脚本大全</a></li>
<li class="toctree-l3"><a class="reference internal" href="55.%E7%BC%96%E5%86%99Shell%E8%84%9A%E6%9C%AC%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html">3.55. 编写Shell脚本的最佳实践</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../04.%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%88mysql%E3%80%81Redis%EF%BC%89/index.html">4. 玩转数据库(mysql、Redis)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05.Nginx%E5%AD%A6%E4%B9%A0/index.html">5. Nginx学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06.LAMP%E3%80%81LNMP%E5%AD%A6%E4%B9%A0/index.html">6. LNMP、LAMP学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07.Zabbix%E7%9B%91%E6%8E%A7%E4%BC%81%E4%B8%9A%E5%AE%9E%E6%88%98/index.html">7. Zabbix监控企业实战</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08.Linux%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84/index.html">8. 构建Linux高可用架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09.Zabbix3.0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/index.html">9. Zabbix3.0入门到精通</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10.%E5%BF%AB%E9%80%9F%E9%98%85%E8%AF%BBLinux%E5%85%A5%E9%97%A8-%E9%98%BF%E9%93%ADLinux/index.html">10. 快速阅读Linux入门-阿铭Linux</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Mysql/index.html">Mysql王者之路</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/index.html">Other</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Network_route_switch/index.html">Network_route_switch</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">小健_Linux-shell-Devops_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Linux</a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">3. </span>玩转shell脚本编程</a> &raquo;</li>
      <li><span class="section-number">3.10. </span>shell技巧与杂项</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Linux/03.玩转shell脚本编程/10.shell技巧与杂项.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#shell" id="id31">shell技巧与杂项</a></p>
<ul>
<li><p><a class="reference internal" href="#echoprintf" id="id32">echo和printf打印</a></p>
<ul>
<li><p><a class="reference internal" href="#echo" id="id33">echo</a></p></li>
<li><p><a class="reference internal" href="#printf" id="id34">printf</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#cron" id="id35">cron</a></p></li>
<li><p><a class="reference internal" href="#id1" id="id36">标准输入输出重定向</a></p>
<ul>
<li><p><a class="reference internal" href="#io" id="id37">文件IO标识符</a></p></li>
<li><p><a class="reference internal" href="#tree" id="id38">tree</a></p></li>
<li><p><a class="reference internal" href="#here-document" id="id39">Here Document</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id5" id="id40">常见小技巧</a></p>
<ul>
<li><p><a class="reference internal" href="#stty" id="id41">stty关闭回显</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id42">计算运行时间</a></p></li>
<li><p><a class="reference internal" href="#date" id="id43">date的常见用法</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id44">持续执行命令直至成功才退出</a></p></li>
<li><p><a class="reference internal" href="#tr" id="id45">tr:替换或删除字符</a></p></li>
<li><p><a class="reference internal" href="#screen" id="id46">screen</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id47">脚本编写注意事项</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id9" id="id48">Shell脚本的调试技术</a></p>
<ul>
<li><p><a class="reference internal" href="#id10" id="id49">使用echo命令调试脚本</a></p></li>
<li><p><a class="reference internal" href="#trapshell" id="id50">使用trap命令调试Shell脚本</a></p></li>
<li><p><a class="reference internal" href="#teeshell" id="id51">使用tee命令调试shell脚本</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id52">使用钩子函数，调试shell脚本</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id53">shell自带的调试选项</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id13" id="id54">信号的名称和值</a></p>
<ul>
<li><p><a class="reference internal" href="#id14" id="id55">捕获信号</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id15" id="id56">Shell脚本的参数解析工具</a></p>
<ul>
<li><p><a class="reference internal" href="#while-case" id="id57">while+case命令行参数传递</a></p></li>
<li><p><a class="reference internal" href="#getopts" id="id58">getopts处理多命令行选项</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id16" id="id59">子shell</a></p>
<ul>
<li><p><a class="reference internal" href="#id17" id="id60">在子shell中执行命令</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id21" id="id61">自动化</a></p>
<ul>
<li><p><a class="reference internal" href="#id22" id="id62">开机自启动脚本</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id23" id="id63">Shell脚本实战</a></p></li>
<li><p><a class="reference internal" href="#id24" id="id64">服务脚本的基本语法</a></p>
<ul>
<li><p><a class="reference internal" href="#apache" id="id65">1. Apache服务器日志管理</a></p></li>
<li><p><a class="reference internal" href="#id25" id="id66">2 文件扫描校验</a></p></li>
<li><p><a class="reference internal" href="#id26" id="id67">3 自定义垃圾回收</a></p></li>
<li><p><a class="reference internal" href="#linux" id="id68">4 Linux系统检测</a></p></li>
<li><p><a class="reference internal" href="#lnmp" id="id69">5 自动化安装lnmp，安装提示菜单</a></p></li>
<li><p><a class="reference internal" href="#id27" id="id70">6 选择菜单 2</a></p></li>
<li><p><a class="reference internal" href="#id28" id="id71">7 启动脚本示例</a></p></li>
<li><p><a class="reference internal" href="#id29" id="id72">8 备份24小时被修改的文件</a></p></li>
<li><p><a class="reference internal" href="#rpmrpm" id="id73">9 卸载相关的rpm包、检查rpm包的方法</a></p></li>
<li><p><a class="reference internal" href="#id30" id="id74">10 检查软件状态</a></p></li>
<li><p><a class="reference internal" href="#color-print" id="id75">11 color_print输出</a></p></li>
<li><p><a class="reference internal" href="#linuxfunction" id="id76">12 Linux下function函数库</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="shell">
<h1><a class="toc-backref" href="#id31"><span class="section-number">3.10. </span>shell技巧与杂项</a><a class="headerlink" href="#shell" title="Permalink to this headline">¶</a></h1>
<section id="echoprintf">
<h2><a class="toc-backref" href="#id32"><span class="section-number">3.10.1. </span>echo和printf打印</a><a class="headerlink" href="#echoprintf" title="Permalink to this headline">¶</a></h2>
<section id="echo">
<h3><a class="toc-backref" href="#id33">echo</a><a class="headerlink" href="#echo" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#version:1.0</span>
<span class="c1">#这个脚本仅演示菜单输出，没有具体的功能实现</span>

<span class="nb">echo</span> <span class="s2">&quot;这是一个打印菜单的例子&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;1.查看网卡信息&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;2.查看内存信息&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;3.查看磁盘信息</span>
<span class="s2">4.查看CPU信息</span>
<span class="s2">5.查看账户信息&quot;</span>

<span class="c1">#!/bin/bash</span>
<span class="c1">#Version:2.0</span>
clear
<span class="nb">echo</span> -e <span class="s2">&quot;\033[42m---------------------------------\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;\e[2;10H这里是菜单\t\t#&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;#\e[32m 1.查看网卡信息\e[0m                #&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;#\e[33m 2.查看内存信息\e[0m                #&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;#\e[34m 3.查看磁盘信息\e[0m                #&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;#\e[35m 4.查看CPU信息\e[0m                 #&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;#\e[36m 5.查看账户信息\e[0m                #&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;\033[42m---------------------------------\033[0m&quot;</span>
<span class="nb">echo</span>
</pre></div>
</div>
</section>
<section id="printf">
<h3><a class="toc-backref" href="#id34">printf</a><a class="headerlink" href="#printf" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#Version:1.0</span>
clear
<span class="nb">printf</span>  <span class="s2">&quot;\e[42m%s\n\e[0m&quot;</span> <span class="s2">&quot;---------------------------------&quot;</span>
<span class="nb">printf</span>  <span class="s2">&quot;\e[2;10H%s\t\t\n&quot;</span> <span class="s2">&quot;这里是菜单&quot;</span>
<span class="nb">printf</span>  <span class="s2">&quot;\e[32m%s\e[0m\n&quot;</span>  <span class="s2">&quot;1.查看网卡信息&quot;</span>
<span class="nb">printf</span>  <span class="s2">&quot;\e[35m%s\e[0m\n&quot;</span>  <span class="s2">&quot;2.查看内存信息&quot;</span>
<span class="nb">printf</span>  <span class="s2">&quot;\e[36m%s\e[0m\n&quot;</span>  <span class="s2">&quot;3.查看磁盘信息&quot;</span>
<span class="nb">printf</span>  <span class="s2">&quot;\e[34m%s\e[0m\n&quot;</span>  <span class="s2">&quot;4.查看CPU信息&quot;</span>
<span class="nb">printf</span>  <span class="s2">&quot;\e[33m%s\e[0m\n&quot;</span>  <span class="s2">&quot;5.查看账户信息&quot;</span>
<span class="nb">printf</span>  <span class="s2">&quot;\e[42m%s\n\e[0m&quot;</span> <span class="s2">&quot;---------------------------------&quot;</span>
<span class="nb">echo</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">printf</span> <span class="s2">&quot;%-5s %-10s %-4s\n&quot;</span> NO Name Mark
<span class="nb">printf</span> <span class="s2">&quot;%-5s %-10s %-4.2f\n&quot;</span> <span class="m">01</span> Tom <span class="m">90</span>.3456
<span class="nb">printf</span> <span class="s2">&quot;%-5s %-10s %-4.2f\n&quot;</span> <span class="m">02</span> Jack <span class="m">89</span>.2345
<span class="nb">printf</span> <span class="s2">&quot;%-5s %-10s %-4.2f\n&quot;</span> <span class="m">03</span> Jeff <span class="m">98</span>.4323

<span class="c1"># %-5s 格式为左对齐且宽度为5的字符串代替（-表示左对齐），不使用则是又对齐。</span>
<span class="c1"># %-4.2f 格式为左对齐宽度为4，保留两位小数。</span>
</pre></div>
</div>
</section>
</section>
<section id="cron">
<h2><a class="toc-backref" href="#id35"><span class="section-number">3.10.2. </span>cron</a><a class="headerlink" href="#cron" title="Permalink to this headline">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>crontab -e       <span class="c1"># 编辑计划任务</span>
crontab -l      <span class="c1"># 查看当前计划任务</span>
crontab -r      <span class="c1"># 删除某条计划任务</span>

<span class="c1"># 在crontab命令中加上-u参数来编辑他人的计划任务</span>
</pre></div>
</div>
<p>示例</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="m">25</span> <span class="m">3</span> * * <span class="m">1</span>,3,5  /usr/bin/tar -czvf backup.tar.gz /home/wwwroot
<span class="m">0</span> <span class="m">1</span> * * <span class="m">1</span>-5     /usr/bin/rm -rf /tmp/*


<span class="m">0</span> */3 * * * /usr/local/apache2/apachectl restart
<span class="c1">#表示每隔3个小时重启apache服务一次。</span>

<span class="m">30</span> <span class="m">3</span> * * <span class="m">6</span> /webdata/bin/backup.sh
<span class="c1">#表示每周六的3点30分执行/webdata/bin/backup.sh脚本的操作。</span>

<span class="m">0</span> <span class="m">0</span> <span class="m">1</span>,20 * *  fsck /dev/sdb8
<span class="c1">#表示每个月的1号和20号检查/dev/sdb8磁盘设备。</span>

<span class="m">10</span> <span class="m">5</span> */5 * *  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>&gt;/usr/local/apache2/log/access_log
<span class="c1">#表示每个月的5号、10号、15号、20号、25号、30号的5点10分执行清理apache日志操作。</span>

*  */1  *  *  * service httpd restart
<span class="c1">#每小时重启httpd 进程</span>

<span class="m">23</span>-3/1  *  *  *      service httpd restart
<span class="c1"># 从23点开始到3点，每小时重启httpd 进程</span>

<span class="m">30</span> <span class="m">23</span> *  *  *   service httpd restart
<span class="c1">#每天晚上23点30分重启httpd进程</span>

<span class="m">30</span> <span class="m">23</span> <span class="m">1</span>  *  *   service httpd restart
<span class="c1">#每月的第一天晚上23点30分重启httpd进程</span>

<span class="m">30</span> <span class="m">23</span> <span class="m">1</span>  <span class="m">1</span>  *   service httpd restart
<span class="c1">#每年1月1日的晚上23点30分重启httpd</span>

<span class="m">30</span> <span class="m">23</span> *  *  <span class="m">0</span>   service httpd restart
<span class="c1">#每周日晚上23点30分重启httpd进程</span>
</pre></div>
</div>
</section>
<section id="id1">
<h2><a class="toc-backref" href="#id36"><span class="section-number">3.10.3. </span>标准输入输出重定向</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>一般情况下，每个 Unix/Linux 命令运行时都会打开三个文件：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>标准输入文件<span class="o">(</span>stdin<span class="o">)</span>：stdin的文件描述符为0，Unix程序默认从stdin读取数据。
标准输出文件<span class="o">(</span>stdout<span class="o">)</span>：stdout 的文件描述符为1，Unix程序默认向stdout输出数据。
标准错误文件<span class="o">(</span>stderr<span class="o">)</span>：stderr的文件描述符为2，Unix程序会向stderr流中写入错误信息。
默认情况下，command &gt; file 将 stdout 重定向到 file，command &lt; file 将stdin 重定向到 file。


cmd &gt; file             把标准输出重定向到新文件中
cmd &gt;&gt; file            追加
cmd &gt; file <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>        标准出错也重定向到1所指向的file里
cmd &gt;&gt; file <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
cmd &lt; file1 &gt; file2    输入输出都定向到文件里
cmd &lt; <span class="p">&amp;</span>fd              把文件描述符fd作为标准输入
cmd &gt; <span class="p">&amp;</span>fd              把文件描述符fd作为标准输出
cmd &lt; <span class="p">&amp;</span>-               关闭标准输入


如果希望 stderr 重定向到 file，可以这样写：
$ <span class="nb">command</span> <span class="m">2</span> &gt; file


如果希望 stderr 追加到 file 文件末尾，可以这样写：
$ <span class="nb">command</span> <span class="m">2</span> &gt;&gt; file
<span class="c1">#2 表示标准错误文件(stderr)。</span>


如果希望将 stdout 和 stderr 合并后重定向到 file，可以这样写：
$ <span class="nb">command</span> <span class="p">&amp;</span>&gt;file
或者将错误输出转为标准输出，然后一同定向到一个文件
$ <span class="nb">command</span> &gt; file <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
或者
如果希望对 stdin 和 stdout 都重定向，可以这样写：
$ <span class="nb">command</span> &gt;&gt; file <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>

<span class="nb">command</span> 命令将 stdin 重定向到 file1，将 stdout 重定向到 file2。
$ <span class="nb">command</span> &lt; file1 &gt;file2
</pre></div>
</div>
<p>如果希望屏蔽 stdout 和 stderr，可以这样写：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>同时重定向命令的标准输出和标准错误的信息到/dev/null的语法如下所示：
command &amp;&gt; /dev/null

command &gt;&amp; /dev/null

command &gt; /dev/null 2&gt;&amp;1

command 2&gt;&amp;1 &gt; /dev/null
</pre></div>
</div>
<ul class="simple">
<li><p>/dev/tty</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/dev/tty是一个很实用的文件，当程序打开这个文件时，Uninx/Linux会自动将它重定向到当前所处的终端，
输出到此的信息只会显示在当前工作的显示器上。当某些时候（指定了脚本输出到/dev/null）时，而又想在当前终端上
显示一些很重要的信息，就可以调用这个设备,写入信息，这样做可以强制信息到终端。

$ a=`tty`
$ echo &quot;aaa&quot; &gt;/dev/null &gt; $a
aaa
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tty
/dev/pty0

$ echo &quot;aaa&quot; &gt; /dev/tty0
$ echo &quot;aaa&quot; &gt; /dev/pty0
aaa
</pre></div>
</div>
<p>举例</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:xxx.sh</span>
<span class="c1"># author：xiaojian</span>
<span class="c1">#  设置用户和密码</span>

<span class="nb">printf</span> <span class="s2">&quot;Enter User:&quot;</span>
<span class="nb">read</span> user
<span class="nb">printf</span> <span class="s2">&quot;Enter new passwd:&quot;</span>

<span class="c1">#关闭自动打印输入字符的功能</span>
stty -echo

<span class="nb">read</span> pass &lt; /dev/tty            <span class="c1">#读取密码</span>
<span class="nb">echo</span>
<span class="nb">printf</span> <span class="s2">&quot;Enter again:&quot;</span>
<span class="nb">read</span> pass2 &lt; /dev/tty           <span class="c1">#再次读取密码</span>
stty <span class="nb">echo</span>                       <span class="c1">#打开输入字符的功能</span>


<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$pass</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$pass2</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Two passwords do not match!&quot;</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="nv">$pass2</span> <span class="p">|</span> passwd <span class="nv">$user</span> --stdin
    <span class="nb">echo</span> <span class="s2">&quot;Passwd is Successful setup!&quot;</span>
<span class="k">fi</span>
</pre></div>
</div>
<ul class="simple">
<li><p>/dev/null</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>如果希望执行某个命令，但又不希望在屏幕上显示输出结果，那么可以将输出重定向到 /dev/null：

$ <span class="nb">command</span> &gt; /dev/null
/dev/null 是一个特殊的文件，写入到它的内容都会被丢弃；如果尝试从该文件读取内容，那么什么也读不到。但是 /dev/null 文件非常有用，将命令的输出重定向到它，会起到<span class="s2">&quot;禁止输出&quot;</span>的效果。
</pre></div>
</div>
<ul class="simple">
<li><p>从文件输入</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -ne <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> FILEPATH&quot;</span>
    <span class="nb">exit</span>
<span class="k">fi</span>

<span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>

<span class="c1">#第一个参数为输入文件，并读取2行内容</span>
<span class="o">{</span>
    <span class="nb">read</span> line1
    <span class="nb">read</span> line2
<span class="o">}</span> &lt; <span class="nv">$file</span>

<span class="nb">echo</span> <span class="s2">&quot;First line in </span><span class="nv">$file</span><span class="s2"> is </span><span class="nv">$line1</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Second line in </span><span class="nv">$file</span><span class="s2"> is </span><span class="nv">$line2</span><span class="s2">&quot;</span>
<span class="nb">exit</span> <span class="m">0</span>
</pre></div>
</div>
<ul class="simple">
<li><p>exec命令分配文件描述符</p></li>
</ul>
<p>用户在命令后面使用重定向操作符的时候，重定向只对当前的命令有效。用户可以使用exec命令创建新的文件描述符，并且将文件描述符绑定到文件或者另外一个文件描述符或者文件</p>
<p>常用的重定向操作</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>重定向                 说　明
<span class="nb">exec</span> <span class="m">2</span>&gt; file        将所有命令的标准错误重定向到文件file
<span class="nb">exec</span> n&lt; file        只读的方式打开名称为file的文件，并且使用文件描述符n，n是大于3的整数
<span class="nb">exec</span> n&gt; file        以写入的方式打开名称为file的文件，并且使用文件描述符n，n是大于3的整数
<span class="nb">exec</span> n&lt;&gt; file       以读写方式打开文件file，并且使用文件描述符n，n是大于3的整数
<span class="nb">exec</span> n&gt;<span class="p">&amp;</span>-           关闭文件描述符n
<span class="nb">exec</span> n&gt;<span class="p">&amp;</span>m           使得文件描述符n成为文件描述符m的副本，即将文件描述符m复制到n
<span class="nb">exec</span> n&gt;<span class="p">&amp;</span>-           关闭文件描述符n
</pre></div>
</div>
<p>exec 3文件输出例子</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">exec</span> <span class="m">3</span>&lt;input.txt <span class="c1"># 使用文件描述符3</span>

$ <span class="nb">echo</span> this is a <span class="nb">test</span> line &gt; input.txt
$ <span class="nb">exec</span> <span class="m">3</span>&lt;input.txt
现在你就可以在命令中使用文件描述符 <span class="m">3</span> 了。例如：
$ cat&lt;<span class="p">&amp;</span><span class="m">3</span>
this is a <span class="nb">test</span> line

<span class="c1">#创建一个用于写入（截断模式）的文件描述符：</span>
$ <span class="nb">exec</span> <span class="m">4</span>&gt;output.txt
$ <span class="nb">echo</span> newline &gt;<span class="p">&amp;</span><span class="m">4</span>
$ cat output.txt
newline


<span class="c1">#创建一个用于写入（追加模式）的文件描述符:</span>
$ <span class="nb">exec</span> <span class="m">5</span>&gt;&gt;input.txt
$ <span class="nb">echo</span> appended line &gt;<span class="p">&amp;</span><span class="m">5</span>
$ cat input.txt
newline
appended line
</pre></div>
</div>
<p>示例</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/sh
# @Author: huxiaojian
# @Date:   2018-11-08 17:17:26
# @Last Modified by:   hujianli
# @Last Modified time: 2018-11-09 13:45:07
NOW=$(date + %Y%m%d)

#定义输出文件
UTPUT=&quot;/tmp/sysinfo.${NOW}.log&quot;

#定义文件描述符
exec 3&gt; $OUTPUT



echo &quot;**********************************************&quot; &gt;&amp;3
echo &quot;************* File System Disk Space Usage ****&quot; &gt;&amp;3
echo &quot;**********************************************&quot; &gt;&amp;3
df -H &gt;&amp;3


echo &quot;**********************************************&quot; &gt;&amp;3
echo &quot;************* Operating System Info  ****&quot; &gt;&amp;3
echo &quot;**********************************************&quot; &gt;&amp;3
uname -a &gt;&amp;3

[ -x /usr/bin/lsb_release ] &amp;&amp; /usr/bin/lsb_release -a &gt;&amp;3
echo &quot;/usr/bin/lsb_release not found&quot;


echo &quot;**********************************************&quot; &gt;&amp;3
echo &quot;************* Amount of Free And Used Memory ****&quot; &gt;&amp;3
echo &quot;**********************************************&quot; &gt;&amp;3

free -m &gt;&amp;3

echo &quot;**********************************************&quot; &gt;&amp;3
echo &quot;************* Top 10 CPU Eating Process ****&quot; &gt;&amp;3
echo &quot;**********************************************&quot; &gt;&amp;3
ps auxf | sort -nr -k 3 | head -10 &gt;&amp;3


echo &quot;**********************************************&quot; &gt;&amp;3
echo &quot;************* Network DEVICE information [eth0] ****&quot; &gt;&amp;3
echo &quot;**********************************************&quot; &gt;&amp;3
netstat -i | grep -q eth0 &amp;&amp; /sbin/ifconfig eth0 &gt;&amp;3

echo &quot;**********************************************&quot; &gt;&amp;3
exec 3&gt; $OUTPUT


echo &quot;---------------------------------------------&quot; &gt;&amp;3
echo &quot;System Info run @-@ $(date) for $(hostname)&quot;   &gt;&amp;3
echo &quot;---------------------------------------------&quot; &gt;&amp;3

echo &quot;**********************************************&quot; &gt;&amp;3
echo &quot;************** Install Hared Disk ************&quot; &gt;&amp;3
echo &quot;**********************************************&quot; &gt;&amp;3

fdisk -l | egrep &quot;Disk /dev&quot; &gt;&amp;3

echo &quot;**********************************************&quot; &gt;&amp;3
echo &quot;************** CPU information ************&quot; &gt;&amp;3
echo &quot;**********************************************&quot; &gt;&amp;3

grep &#39;mode name&#39; /proc/cpuinfo| uniq &gt;&amp;3

echo &quot;**********************************************&quot; &gt;&amp;3
echo &quot;************* File System Disk Space Usage ****&quot; &gt;&amp;3
echo &quot;**********************************************&quot; &gt;&amp;3
df -H &gt;&amp;3


echo &quot;**********************************************&quot; &gt;&amp;3
echo &quot;************* Operating System Info  ****&quot; &gt;&amp;3
echo &quot;**********************************************&quot; &gt;&amp;3
uname -a &gt;&amp;3

[ -x /usr/bin/lsb_release ] &amp;&amp; /usr/bin/lsb_release -a &gt;&amp;3
echo &quot;/usr/bin/lsb_release not found&quot;


echo &quot;**********************************************&quot; &gt;&amp;3
echo &quot;************* Amount of Free And Used Memory ****&quot; &gt;&amp;3
echo &quot;**********************************************&quot; &gt;&amp;3

free -m &gt;&amp;3


echo &quot;**********************************************&quot; &gt;&amp;3
echo &quot;************* Top 10 Memory Eating Process ****&quot; &gt;&amp;3
echo &quot;**********************************************&quot; &gt;&amp;3
ps auxf | sort -nr -k 4 | head -10 &gt;&amp;3


echo &quot;**********************************************&quot; &gt;&amp;3
echo &quot;************* Top 10 CPU Eating Process ****&quot; &gt;&amp;3
echo &quot;**********************************************&quot; &gt;&amp;3
ps auxf | sort -nr -k 3 | head -10 &gt;&amp;3


#关闭文件描述符3
exec 1&gt;&amp;3   #恢复标准输出
exec 3&gt; &amp;-
</pre></div>
</div>
<section id="io">
<h3><a class="toc-backref" href="#id37">文件IO标识符</a><a class="headerlink" href="#io" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/usr/bin/env bash

标准输入（stdin）、标准输出（stdout）、标准错误输出（stderr），分别用文件标识符0、1、2来标识
如果要为进程打开其他的输入输出，则需要从整数3开始标识。
默认情况下，标准输入为键盘，标准输出和错误输出为显示器。


exec 5&gt;file
#使用文件描述符5的命令
exec 5&gt;&amp;-
# 接下来的命令不再需要使用文件描述符5

#在文件描述符4上打开用于读写的文件/tmp/file
exec 4&lt;&gt; /tmp/file
#从文件描述符4读取前3个字符
read -n 3 var &lt;&amp; 4
echo $var

echo -n + tow &gt;&amp; 4
exec 4&gt;&amp;-
cat /tmp/file
one+two

#要将标准输出和标准错误同时定向到同一个文件中，可使用如下命令：
COMMAND &gt; stdout_stderr.txt 2&gt;&amp;1
or
COMMAND &amp;&gt; stdout_stderr.txt

COMMAND &gt; stdout.txt &amp;&gt; /dev/null                       #屏幕上不显示任何输出
find / -type f -name *.txt &gt; /dev/null 2&gt;&amp;1             #屏幕上不显示任何输出


#使用块记录日志
{
    ...
    ...
} &gt; $LOGFILE 2&gt;&amp;1




#将file文件作为标准输出
$ exec &gt; 1.txt

huxiaojian@DESKTOP-EKCVIQ7 ~
$ echo &quot;aa&quot;

huxiaojian@DESKTOP-EKCVIQ7 ~
$ whoami

huxiaojian@DESKTOP-EKCVIQ7 ~
$ ps aux

huxiaojian@DESKTOP-EKCVIQ7 ~
$ exec &gt;/dev/tty

huxiaojian@DESKTOP-EKCVIQ7 ~
$ ps aux
      PID    PPID    PGID     WINPID   TTY         UID    STIME COMMAND
    10684   11620   10684      16140  pty0      197609 12:44:23 /usr/bin/ps
    11620    8952   11620       8128  pty0      197609 11:56:23 /usr/bin/bash
     8952       1    8952       8952  ?         197609 11:56:23 /usr/bin/mintty

huxiaojian@DESKTOP-EKCVIQ7 ~
$ cat 1.txt
aa
huxiaojian
      PID    PPID    PGID     WINPID   TTY         UID    STIME COMMAND
    16616   11620   16616      11180  pty0      197609 12:44:10 /usr/bin/ps
    11620    8952   11620       8128  pty0      197609 11:56:23 /usr/bin/bash
     8952       1    8952       8952  ?         197609 11:56:23 /usr/bin/mintty



#aaa.txt文件并指定标识符为3，
huxiaojian@DESKTOP-EKCVIQ7 ~
$ cat aaa.txt
b
d
c
e
f
g

huxiaojian@DESKTOP-EKCVIQ7 ~
$ exec 3&lt;aaa.txt

huxiaojian@DESKTOP-EKCVIQ7 ~
$ sort &lt;&amp;3
b
c
d
e
f
g

#-----------------------------------------------------------------------------
#将写入指定文件标识符的内容写入指定文件
#-----------------------------------------------------------------------------
#打开/关闭文件标识符
$ exec 3&gt;aaa.txt

huxiaojian@DESKTOP-EKCVIQ7 /home
$ cat aaa.txt

huxiaojian@DESKTOP-EKCVIQ7 /home
$ echo &quot;hello word11 &quot; &gt;&amp;3

huxiaojian@DESKTOP-EKCVIQ7 /home
$ echo &quot;hello word12 &quot; &gt;&amp;3

huxiaojian@DESKTOP-EKCVIQ7 /home
$ echo &quot;hello word13 &quot; &gt;&amp;3

huxiaojian@DESKTOP-EKCVIQ7 /home
$ exec 3&gt;&amp;-         #关闭文件标识符

huxiaojian@DESKTOP-EKCVIQ7 /home
$ cat aaa.txt
hello word11
hello word12
hello word13




#------------------------------------------------------------
#创建文件标识符的拷贝 标识符3和4都指向同一个文件
#------------------------------------------------------------
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# exec 3&gt;aaa.sh
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# exec 4&lt;3&amp;

[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# echo &quot;this is &amp;3&quot; &gt;&amp;3
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# echo &quot;this is &amp;4&quot; &gt;&amp;4
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# echo &quot;this is &amp;34&quot; &gt;&amp;4
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# echo &quot;this is &amp;34(2)&quot; &gt;&amp;3

[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# exec 3&gt;&amp;-
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# cat aaa.sh
this is &amp;3
this is &amp;4
this is &amp;34
this is &amp;34(2)


root@iZuf6i0q7nfqv3ii5lhz0mZ home]# exec 3&gt;hujianli.log
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# exec 4&lt;&amp;3
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# echo &quot;&amp;3 input &quot; &gt; &amp;3
-bash: syntax error near unexpected token `&amp;&#39;
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# echo &quot;&amp;3 input &quot;  &gt;&amp;3
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# echo &quot;&amp;4 input &quot;  &gt;&amp;3
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# echo &quot;&amp;3-1 input &quot;  &gt;&amp;3
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# echo &quot;&amp;4-2 input &quot;  &gt;&amp;3
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# exec 3&gt;&amp;-
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# exec 4&gt;&amp;-
[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# cat hujianli.log
&amp;3 input
&amp;4 input
&amp;3-1 input
&amp;4-2 input


#-------------------------------------------------------
# 同时读取和写入数据到文件中
#-------------------------------------------------------

#!/usr/bin/env bash
#usage:xxx
#scripts_name:xxx.sh

#开启描述符3，用于读取信息
exec 3&lt; test.txt

#卡其描述符4，用于写入信息
exec 4&gt; output.txt

# 读取描述符3中的2行数据
read -u 3 a
read -u 3 b

# 屏幕上输出读取的数据
echo &quot;Data read from fd # 3:&quot;

# 打印变量a和b的值
echo $a
echo $b


echo &quot;Writing data read from fd 3 to fd 4.....&quot;

# 在文件描述符4上向文件/temp/output.txt写入数据
echo &quot;Field #1 - $a &quot; &gt;&amp;4
echo &quot;Field #2 - $b &quot; &gt;&amp;4

# 关闭文件描述符3
exec 3&lt;&amp;-
#关闭文件描述符4
exec 4&lt;&amp;-



#-----------------------------------------------------------
# 创建文件标识符的拷贝
#-----------------------------------------------------------

[root@iZuf6i0q7nfqv3ii5lhz0mZ home]# cd /dev/fd/
[root@iZuf6i0q7nfqv3ii5lhz0mZ fd]# ll
total 0
lrwx------ 1 root root 64 Nov 22 10:55 0 -&gt; /dev/pts/1
lrwx------ 1 root root 64 Nov 22 10:55 1 -&gt; /dev/pts/1
lrwx------ 1 root root 64 Nov 22 10:55 2 -&gt; /dev/pts/1
lrwx------ 1 root root 64 Nov 22 13:05 255 -&gt; /dev/pts/1
[root@iZuf6i0q7nfqv3ii5lhz0mZ fd]# exec 3&lt;/home/hujianli.log
[root@iZuf6i0q7nfqv3ii5lhz0mZ fd]# exec 4&lt;&amp;3
[root@iZuf6i0q7nfqv3ii5lhz0mZ fd]# ll
total 0
lrwx------ 1 root root 64 Nov 22 10:55 0 -&gt; /dev/pts/1
lrwx------ 1 root root 64 Nov 22 10:55 1 -&gt; /dev/pts/1
lrwx------ 1 root root 64 Nov 22 10:55 2 -&gt; /dev/pts/1
lrwx------ 1 root root 64 Nov 22 13:05 255 -&gt; /dev/pts/1
lr-x------ 1 root root 64 Nov 22 10:55 3 -&gt; /home/hujianli.log
lr-x------ 1 root root 64 Nov 22 13:05 4 -&gt; /home/hujianli.log
[root@iZuf6i0q7nfqv3ii5lhz0mZ fd]# cat 3
&amp;3 input
&amp;4 input
&amp;3-1 input
&amp;4-2 input
[root@iZuf6i0q7nfqv3ii5lhz0mZ fd]# cat 4
&amp;3 input
&amp;4 input
&amp;3-1 input
&amp;4-2 input
</pre></div>
</div>
<p><strong>小结</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#------------------------------------------------------------
# 小结
#-----------------------------------------------------------
给一个输入文件指定一个文件描述符的语法是：exec [n]&lt; file。
给一个输出文件指定一个文件描述符的语法是：$ exec [n]&gt; file。
关闭文件描述符的语法是：[n]&lt;&amp;- 或 [n]&gt;&amp;-。

符号“&lt;&gt;”是Bash中的菱形操作符，这个操作符用于打开一个可读写的操作符。
$ cat exec_read_write.sh
#!/bin/bash
echo &quot;one two &quot; &gt;/tmp/file

#开启/tmp/file的读写，描述符4
exec 4&lt;&gt; /tmp/file

#读取文件描述符前3个字符给var变量
read -n 3 var &lt;&amp;4
echo $var

echo -n + &gt;&amp;4
echo 4&gt;&amp;-
</pre></div>
</div>
</section>
<section id="tree">
<h3><a class="toc-backref" href="#id38">tree</a><a class="headerlink" href="#tree" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># tee命令把结果输出到标准输出，另一个副本输出到相应文件。</span>
<span class="n">df</span> <span class="o">-</span><span class="n">k</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;{print $1}&#39;</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="s2">&quot;文件系统&quot;</span> <span class="o">|</span> <span class="n">tee</span> <span class="n">a</span><span class="o">.</span><span class="n">txt</span>


<span class="c1"># tee -a a.txt表示追加操作。</span>
<span class="n">df</span> <span class="o">-</span><span class="n">k</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;{print $1}&#39;</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="s2">&quot;文件系统&quot;</span> <span class="o">|</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="n">a</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</section>
<section id="here-document">
<h3><a class="toc-backref" href="#id39">Here Document</a><a class="headerlink" href="#here-document" title="Permalink to this headline">¶</a></h3>
<section id="id2">
<h4>输出提示信息<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 输出提示信息</span>
<span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">End</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">message</span>
   <span class="mi">8</span> <span class="o">-------------------------------------</span>
   <span class="mi">9</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">line</span> <span class="mi">1</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span><span class="o">.</span>
  <span class="mi">10</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">line</span> <span class="mi">2</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span><span class="o">.</span>
  <span class="mi">11</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">line</span> <span class="mi">3</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span><span class="o">.</span>
  <span class="mi">12</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">line</span> <span class="mi">4</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span><span class="o">.</span>
  <span class="mi">13</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">last</span> <span class="n">line</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span><span class="o">.</span>
  <span class="mi">14</span> <span class="o">-------------------------------------</span>
<span class="n">End</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">message</span>
</pre></div>
</div>
</section>
<section id="tab">
<h4>抑制输出时前边的tab<a class="headerlink" href="#tab" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># &lt;&lt;-LimitString可以抑制输出时前边的tab(不是空格). 这可以增加一个脚本的可读性.</span>
<span class="n">cat</span> <span class="o">&lt;&lt;-</span><span class="n">ENDOFMESSAGE</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">line</span> <span class="mi">1</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span><span class="o">.</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">line</span> <span class="mi">2</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span><span class="o">.</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">line</span> <span class="mi">3</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span><span class="o">.</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">line</span> <span class="mi">4</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span><span class="o">.</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">last</span> <span class="n">line</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span><span class="o">.</span>
<span class="n">ENDOFMESSAGE</span>
</pre></div>
</div>
</section>
<section id="id3">
<h4>关闭参数替换<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 关闭参数替换
NAME=&quot;John Doe&quot;
RESPONDENT=&quot;the author of this fine script&quot;

cat &lt;&lt;&#39;Endofmessage&#39;
Hello, there, $NAME.
Greetings to you, $NAME, from $RESPONDENT.
Endofmessage


或者
cat &lt;&lt;\Endofmessage
Hello, there, $NAME.
Greetings to you, $NAME, from $RESPONDENT.
Endofmessage
</pre></div>
</div>
</section>
<section id="id4">
<h4>举例说明<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
cat &gt; file.txt <span class="s">&lt;&lt;EOF</span>
<span class="s">context</span>
<span class="s">EOF</span>

ls aa &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>


cat &gt; /tmp/test.txt <span class="s">&lt;&lt; HERE</span>
<span class="s">该文件为测试文件。</span>
<span class="s">测试完后，记得将该文件删除。</span>
<span class="s">Welcome to Earth.</span>
<span class="s">HERE</span>


<span class="c1">#创建文件</span>
cat <span class="s">&lt;&lt; EOF &gt; foo.sh</span>
<span class="s">   printf &quot;%s was here&quot; &quot;$name&quot;</span>
<span class="s">EOF</span>

cat &gt;&gt; foo.sh <span class="s">&lt;&lt;EOF</span>
<span class="s">   printf &quot;%s was here&quot; &quot;$name&quot;</span>
<span class="s">EOF</span>


<span class="c1">#重定向到文件</span>
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <span class="s">&lt;&lt;-&#39;EOF&#39;</span>
<span class="s">{</span>
<span class="s">  &quot;registry-mirrors&quot;: [&quot;https://du8c1in9.mirror.aliyuncs.com&quot;]</span>
<span class="s">}</span>
<span class="s">EOF</span>
sudo systemctl daemon-reload
sudo systemctl restart docker



<span class="c1">#不能屏蔽Tab键,缩进将作为内容的一部分被输出</span>
<span class="c1">#注意hello和world前面是tab键</span>
cat <span class="s">&lt;&lt; EOF</span>
<span class="s">    hello</span>
<span class="s">    world</span>
<span class="s">EOF</span>

<span class="c1">#Tab键将被忽略,仅输出数据内容</span>
cat <span class="s">&lt;&lt;- EOF</span>
<span class="s">    hello</span>
<span class="s">    world</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>一个Here Document用于说明文档的示例</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">()</span> <span class="p">{</span>

<span class="n">cat</span> <span class="o">&lt;&lt;-</span><span class="n">EOF</span>

  <span class="n">usage</span><span class="p">:</span> <span class="n">command</span> <span class="p">[</span><span class="o">-</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">v</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">z</span><span class="p">]</span> <span class="p">[</span><span class="n">file</span> <span class="o">...</span><span class="p">]</span>

  <span class="n">A</span> <span class="n">short</span> <span class="n">explanation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">operation</span> <span class="n">goes</span> <span class="n">here</span><span class="o">.</span>

  <span class="n">It</span> <span class="n">might</span> <span class="n">be</span> <span class="n">a</span> <span class="n">few</span> <span class="n">lines</span> <span class="n">long</span><span class="p">,</span> <span class="n">but</span> <span class="n">shouldn</span><span class="s1">&#39;t be excessive.</span>

<span class="n">EOF</span>

<span class="p">}</span>
</pre></div>
</div>
<p>使用Here Document进行硬盘分区</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#本脚本会自动将vdb整个磁盘分成一个区,将将该分区格式化.</span>
<span class="c1">#注意:所有数据均将丢失!!!</span>
<span class="c1">#n(新建分区),p(新建主分区),1(主分区编号为1)</span>
<span class="c1">#回车(从磁盘哪个位置开始分区,默认从第1个扇区)</span>
<span class="c1">#回车(分区到哪个扇区结束,回车代表最后,将整个磁盘分1个区)</span>
<span class="c1">#wq(保存退出),mkfs.xfs(格式化命令)</span>
fdisk /dev/vdb <span class="s">&lt;&lt; EOF</span>
<span class="s">n</span>
<span class="s">p</span>
<span class="s">1</span>


<span class="s">wq</span>
<span class="s">EOF</span>

mkfs.xfs /dev/vdb1

<span class="o">[</span> ! -d /data <span class="o">]</span> <span class="o">&amp;&amp;</span> mkdir /data
cat &gt;&gt; /etc/fstab <span class="s">&lt;&lt; EOF</span>
<span class="s">/dev/vdb1  /data   xfs   defaults  0 0</span>
<span class="s">EOF</span>
mount -a
</pre></div>
</div>
<p>自动发送邮件，使用Here Document</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mail -s warning root@localhost <span class="s">&lt;&lt; EOF</span>
<span class="s">This is content.</span>
<span class="s">This is a test mail for redirect.</span>
<span class="s">EOF</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id40"><span class="section-number">3.10.4. </span>常见小技巧</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<section id="stty">
<h3><a class="toc-backref" href="#id41">stty关闭回显</a><a class="headerlink" href="#stty" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:xxx.sh</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;Enter password:&quot;</span>
<span class="c1"># 在读取密码前禁止回显</span>
<span class="n">stty</span> <span class="o">-</span><span class="n">echo</span>
<span class="n">read</span> <span class="n">password</span>
<span class="c1"># 重新允许回显</span>
<span class="n">stty</span> <span class="n">echo</span>
<span class="n">echo</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;$password&quot;</span>
<span class="n">echo</span> <span class="n">Password</span> <span class="n">read</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3><a class="toc-backref" href="#id42">计算运行时间</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
# 文件名: time_take.sh
start=$(date +%s)
commands;
statements;
end=$(date +%s)
difference=$(( end - start))
echo Time taken to execute commands is $difference seconds.

或者
$ cat test3.sh
#!/bin/bash
start=$(date +%s)
sleep 3
end=$(date +%s)
echo -e &quot;speed $((end - start)) times.....&quot;
</pre></div>
</div>
</section>
<section id="date">
<h3><a class="toc-backref" href="#id43">date的常见用法</a><a class="headerlink" href="#date" title="Permalink to this headline">¶</a></h3>
<img alt="../../_images/shell+date-args001.png" src="../../_images/shell+date-args001.png" />
<img alt="../../_images/shell+date-args002.png" src="../../_images/shell+date-args002.png" />
<p>date使用示例</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>时间加减：
显示前 30 秒：date -d &#39;-30 second&#39; +&#39;%F %T&#39;
显示前一分钟：date -d &#39;-1 minute&#39; +&#39;%F %T&#39;
显示前一个时间：date -d &#39;-1 hour&#39; +&#39;%F %T&#39;
显示前一个天：date -d &#39;-1 day&#39; +&#39;%F %T&#39;
显示上一周：date -d &#39;-1 week&#39; +&#39;%F %T&#39;
显示上一个月日期：date -d &#39;-1 month&#39; +%F
显示上一年日期：date -d &#39;-1 year&#39; +%F
或
显示前一天日期：date -d yesterday +%F
显示后一天日期：date -d tomorrow +%F
</pre></div>
</div>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id44">持续执行命令直至成功才退出</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>repeat() { while :; do $@ &amp;&amp; return; sleep 30; done }


# 间隔30s就去下载tar.gz包，直至下载成功。
repeat wget -c http://www.example.com/software-0.1.tar.gz
</pre></div>
</div>
</section>
<section id="tr">
<h3><a class="toc-backref" href="#id45">tr:替换或删除字符</a><a class="headerlink" href="#tr" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>tr: 转换字符或删除字符
    tr &#39;集合1&#39; &#39;集合2&#39;
    tr -d &#39;字符集合&#39;

# 压缩重复字符
result=&#39;tr -s &quot;[a-z]&quot; &lt; demo9.txt&#39;

# 删除空白行
result=&#39;cat demo10.txt | tr -s [&quot;\n&quot;]&#39;

# 将当前目录在的所有文件的文件名转为大写
for file in &#39;ls&#39;;do
   echo &quot;$file&quot; | tr &#39;a-z&#39; &#39;A-Z&#39;
done

# 删除数字和冒号
result=&#39;tr -d &quot;[0-9][:]&quot; &lt; demo11.txt&#39;

$ tr &#39;a-z&#39; &#39;A-Z&#39; &lt;a.txt &gt;a1.txt  # 将文本内容转换为大写
$ tr &#39;{}&#39; &#39;()&#39; &lt;test.txt &gt;newfile.txt   # 将文本的大括号转为小括号
$ tr &#39;{}&#39; &#39;\[]&#39; &lt;test.txt &gt;newfile.txt  # 将文本的大括号转为中括号
</pre></div>
</div>
</section>
<section id="screen">
<h3><a class="toc-backref" href="#id46">screen</a><a class="headerlink" href="#screen" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">screen</span> <span class="o">-</span><span class="n">ls</span>
<span class="o">*</span> <span class="n">screen</span> <span class="o">-</span><span class="n">r</span>
<span class="o">*</span> <span class="n">screen</span> <span class="o">-</span><span class="n">wipe</span>
</pre></div>
</div>
</section>
<section id="id8">
<h3><a class="toc-backref" href="#id47">脚本编写注意事项</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1）开头加解释器：#!/bin/bash
2）语法缩进，使用四个空格；多加注释说明。
3）命名建议规则：变量名大写、局部变量小写，函数名小写，名字体现出实际作用。
4）默认变量是全局的，在函数中变量 local 指定为局部变量，避免污染其他作用域。
5）有两个命令能帮助我调试脚本：set -e 遇到执行非 0 时退出脚本，set -x 和 set +x 打印执行过程。set-x 和set+x常用于调试函数。

set -x
function(){
}
set +x

6）写脚本一定先测试再到生产上。


set 的一些用法：
    shopt -s -o nounset         #强调变量必须先声明才能使用

    set x y z               # 将x,y,z的值赋予位置参数1,2,3

    #把 set -u 或 set -o nounset 插入到脚本中, 并运行它, 就会在每个试图使用未声明变量的地方给出一个unbound variable错误信息.
    #set -e     # 遇到执行非 0 时退出脚本，set -x 打印执行过程

    set -o pipefail #在这个设置执行后，其后面的代码，包括管道命令的返回值，为最后一个非零的命令的返回值，或者当管道内的所有命令都执行成功后返回零。

    set -o nounset      #未声明变量就报错，强制退出
    set +o nounset      # set -/+u,简写

    set -o errexit      # 脚本只要发生错误，执行出现非0的结果,当脚本发生第一个错误时退出脚本
    set +o errexit      # set -/+e,简写

    set -o xtrace       # 表示跟踪脚本的执行过程，有利于调试,运行结果之前，先输出执行的那一行命令,比set -v更加完整详细
    set +o xtrace       # set -/+x,简写

    set -o noclobber    # 防止文件覆盖，文件存在就报错，不存在就正常创建
    set +o noclobber    # set -/+C,简写

    set -o allexport    # export 所有已定于的变量
    set +o allexport    # set -/+a,简写

    set -o noexec       # 读取脚本命令，不执行，进行语法检查
    set +o noexec       # set -/+n,简写

    set -o verbose      # 执行一个命令前打印出这个命令
    set +o verbose      # set -/+v,简写



    set -x
    uname -a
    ......
    set +x              #调试某一个区域  打印执行过程,用于调试函数居多
</pre></div>
</div>
<p>脚本开头执行时，执行如下命令，
在执行过程中若遇到使用了未定义的变量或命令返回值为非零，将直接报错退出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="o">-</span><span class="n">eu</span>
<span class="nb">set</span> <span class="o">-</span><span class="n">euo</span> <span class="n">pipefail</span>
</pre></div>
</div>
</section>
</section>
<section id="id9">
<h2><a class="toc-backref" href="#id48"><span class="section-number">3.10.5. </span>Shell脚本的调试技术</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<section id="id10">
<h3><a class="toc-backref" href="#id49">使用echo命令调试脚本</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>echo命令是Shell编程中最简单的调试技术。当用户需要验证程序中某个变量的值时，就可以直接使用echo命令将该变量的值输出到屏幕。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#! /bin/bash</span>
<span class="c1"># 定义变量 a</span>
<span class="n">a</span><span class="o">=</span><span class="mi">1</span>
<span class="c1"># 当 a 的值等于 1 时</span>
<span class="k">if</span> <span class="p">[</span> <span class="s2">&quot;$a&quot;</span> <span class="o">-</span><span class="n">eq</span> <span class="mi">1</span> <span class="p">]</span>
<span class="n">then</span>
   <span class="n">b</span><span class="o">=</span><span class="mi">2</span>
<span class="k">else</span>
   <span class="n">b</span><span class="o">=</span><span class="mi">1</span>
<span class="n">fi</span>
<span class="n">c</span><span class="o">=</span><span class="mi">3</span>

<span class="n">echo</span> <span class="s2">&quot;a=$a&quot;</span>
<span class="n">echo</span> <span class="s2">&quot;b=$b&quot;</span>
<span class="n">echo</span> <span class="s2">&quot;c=$c&quot;</span>
</pre></div>
</div>
</section>
<section id="trapshell">
<h3><a class="toc-backref" href="#id50">使用trap命令调试Shell脚本</a><a class="headerlink" href="#trapshell" title="Permalink to this headline">¶</a></h3>
<p>trap命令可以捕获指定的信号，并且执行预定的命令，其基本语法如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">trap</span> <span class="s1">&#39;command&#39;</span> <span class="n">signal</span>
</pre></div>
</div>
<p>其中，参数command表示捕获指定的信号后要执行的命令，而参数signal表示指定的信号。</p>
<p><code class="docutils literal notranslate"><span class="pre">在Shell脚本执行的时候，会产生3个所谓的伪信号，分别为EXIT、ERR以及DEBUG。</span></code>其中，EXIT信号在退出某个函数或者某个脚本执行完成时触发，ERR信号在某条命令返回非0状态时触发，DEBUG信号在脚本的每一条命令执行之前触发。</p>
<p>演示使用trap命令输出发生错误的行号以及退出状态码，代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#! /bin/bash</span>
<span class="c1"># 定义信号处理函数</span>
<span class="n">ERRTRAP</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">echo</span> <span class="s2">&quot;[LINE:$1] Error:Command or function exited with status code $?&quot;</span>
<span class="p">}</span>
<span class="c1"># 定义函数</span>
<span class="n">func</span><span class="p">()</span>
<span class="p">{</span>
   <span class="c1"># 返回值为 1</span>
   <span class="k">return</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="c1"># 使用 trap 命令捕获 ERR 信号</span>
<span class="n">trap</span> <span class="s1">&#39;ERRTRAP $LINENO&#39;</span> <span class="n">ERR</span>
<span class="c1"># 调用错误的命令</span>
<span class="n">abc</span>
<span class="c1"># 调用函数</span>
<span class="n">func</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="mi">192</span> <span class="n">chapter5</span><span class="p">]</span><span class="c1"># sh sample01.sh</span>
<span class="n">sample01</span><span class="o">.</span><span class="n">sh</span><span class="p">:</span><span class="n">行17</span><span class="p">:</span> <span class="n">abc</span><span class="p">:</span> <span class="n">未找到命令</span>
<span class="p">[</span><span class="n">LINE</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span> <span class="n">Error</span><span class="p">:</span><span class="n">Command</span> <span class="ow">or</span> <span class="n">function</span> <span class="n">exited</span> <span class="k">with</span> <span class="n">status</span> <span class="n">code</span> <span class="mi">127</span>
<span class="p">[</span><span class="n">LINE</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span> <span class="n">Error</span><span class="p">:</span><span class="n">Command</span> <span class="ow">or</span> <span class="n">function</span> <span class="n">exited</span> <span class="k">with</span> <span class="n">status</span> <span class="n">code</span> <span class="mi">1</span>
</pre></div>
</div>
<p>演示通过捕获DEBUG信号来进行程序调试的方法，代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#! /bin/bash</span>
<span class="c1"># 捕获 DEBUG 信号</span>
<span class="n">trap</span> <span class="s1">&#39;echo &quot;before execute line:$LINENO,a=$a,b=$b,c=$c&quot;&#39;</span> <span class="n">DEBUG</span>

<span class="c1"># 定义变量 a</span>
<span class="n">a</span><span class="o">=</span><span class="mi">1</span>
<span class="c1"># 根据变量 a 的值初始化变量 b</span>
<span class="k">if</span> <span class="p">[</span> <span class="s2">&quot;$a&quot;</span> <span class="o">-</span><span class="n">eq</span> <span class="mi">1</span> <span class="p">]</span>
<span class="n">then</span>
   <span class="n">b</span><span class="o">=</span><span class="mi">2</span>
<span class="k">else</span>
   <span class="n">b</span><span class="o">=</span><span class="mi">1</span>
<span class="n">fi</span>
<span class="c1"># 定义变量 c</span>
<span class="n">c</span><span class="o">=</span><span class="mi">3</span>

<span class="n">echo</span> <span class="s2">&quot;end&quot;</span>
</pre></div>
</div>
</section>
<section id="teeshell">
<h3><a class="toc-backref" href="#id51">使用tee命令调试shell脚本</a><a class="headerlink" href="#teeshell" title="Permalink to this headline">¶</a></h3>
<p>在普通的语句中，用户使用echo和trap命令就可以非常轻松地完成调试，但是对于管道或者重定向来说，使用上面两种方法就显得心有余而力不足，因为在管道的作用下，一些命令的输出结果将会直接成为下一个命令的输入，中间结果并不会显示在屏幕上，因此给程序调试带来了困难。</p>
<p>由于在实际开发过程中，管道和重定向在Shell脚本中使用得非常多。所以必须找到能够输出中间结果的方法。在这种情况下，tee命令就可以轻松地完成任务。tee命令会从标准输入读取数据，将其内容输出到标准输出设备，同时又可将内容保存成文件。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#! /bin/bash
# 将文件名转换为大写
list=&#39;ls -l | tee list.txt | awk &#39;{print toupper($7)}&#39;&#39;&#39;
echo &quot;$list&quot;
</pre></div>
</div>
</section>
<section id="id11">
<h3><a class="toc-backref" href="#id52">使用钩子函数，调试shell脚本</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>在许多程序设计语言中，用户在调试程序的时候都可以设定一个开关变量，当该变量的值为真时，才输出调试信息；否则，不输出调试信息。例如用户可以设计以下代码：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">[</span> <span class="s2">&quot;$DEBUG&quot;</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span> <span class="p">];</span> <span class="n">then</span>
    <span class="n">输出调试信息</span>
<span class="n">fi</span>
</pre></div>
</div>
<p>只有当变量DEBUG的值为true时，才输出调试信息。这样的代码块称为调试钩子。在调试钩子中，用户可以输出任何调试信息。使用调试钩子，用户可以通过开关变量控制是否输出调试信息。这样的话，在开发过程中，可以将开关变量的值设置为真，便于程序的调试。当调试完成，需要发布脚本的时候，将开关变量的值设置为flase即可，无需再一条条地删除程序中的调试代码。</p>
<p>演示使用调试钩子调试程序的方法，代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#! /bin/bash

# 定义调试开关
export DEBUG=true

# 调试函数
DEBUG()
{
   if [ &quot;$DEBUG&quot; == &quot;true&quot; ];then
      $@
   fi
}

a=1
# 调用调试函数
DEBUG echo &quot;a=$a&quot;

if [ &quot;$a&quot; -eq 1 ]
then
     b=2
else
     b=1
fi
# 调用调试函数
DEBUG echo &quot;b=$b&quot;
c=3
# 调用调试函数
DEBUG echo &quot;c=$c&quot;
</pre></div>
</div>
<p>从上面的执行结果可以得知，因为开关变量DEBUG的值为true，所以输出了相应的调试信息。如果将DEBUG变量的值设置为false，则上面的程序没有任何输出，用户可以自行验证。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[root@k8s-node1 centos]# _DEBUG=on ./gouzi.sh
I is 1
I is 2
I is 3
I is 4
I is 5
I is 6
I is 7
I is 8
I is 9
I is 10
[root@k8s-node1 centos]# ./gouzi.sh


[root@k8s-node1 centos]# cat gouzi.sh
#!/bin/bash
DEBUG() {
[ &quot;$_DEBUG&quot; == &quot;on&quot; ] &amp;&amp; $@ || :

}
for i in {1..10};do
    #set -x
    DEBUG echo -e &quot;I is $i&quot;
   #set +x
done
</pre></div>
</div>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id53">shell自带的调试选项</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>Shell提供了一些用于调试脚本的选项，如下所示：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 93%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>参数</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>-n</p></td>
<td><p>读一遍脚本中的命令但不执行，用于检查脚本中的语法错误</p></td>
</tr>
<tr class="row-odd"><td><p>-v</p></td>
<td><p>一边执行脚本，一边将执行过的脚本命令打印到标准错误输出</p></td>
</tr>
<tr class="row-even"><td><p>-x</p></td>
<td><p>提供跟踪执行信息，将执行的每一条命令和结果依次打印出来</p></td>
</tr>
</tbody>
</table>
<p>使用这些选项有三种方法，一是在命令行提供参数</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sh -x ./script.sh
</pre></div>
</div>
<p>二是在脚本开头提供参数</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#! /bin/sh -x</span>
</pre></div>
</div>
<p>第三种方法是在脚本中用set命令启用或禁用参数</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#! /bin/sh</span>
<span class="k">if</span> <span class="p">[</span> <span class="o">-</span><span class="n">z</span> <span class="s2">&quot;$1&quot;</span> <span class="p">];</span> <span class="n">then</span>
  <span class="nb">set</span> <span class="o">-</span><span class="n">x</span>
  <span class="n">echo</span> <span class="s2">&quot;ERROR: Insufficient Args.&quot;</span>
  <span class="n">exit</span> <span class="mi">1</span>
  <span class="nb">set</span> <span class="o">+</span><span class="n">x</span>
<span class="n">fi</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="o">-</span><span class="n">e</span>    <span class="c1">#若指令传回值不等于0，则立即退出shell。</span>
<span class="nb">set</span> <span class="o">-</span><span class="n">n</span>    <span class="c1">#只读取指令，而不实际执行。</span>

<span class="nb">set</span> <span class="o">-</span><span class="n">u</span> 　     <span class="c1">#当执行时使用到未定义过的变量，则显示错误信息。</span>
<span class="nb">set</span> <span class="o">-</span><span class="n">v</span> 　     <span class="c1">#显示shell所读取的输入值。</span>


<span class="nb">set</span> <span class="o">-</span><span class="n">x</span>
<span class="o">......</span>
<span class="nb">set</span> <span class="o">+</span><span class="n">x</span>
<span class="c1">#分别表示启用和禁用-x参数，这样可以只对脚本中的某一段进行跟踪调试。</span>
</pre></div>
</div>
</section>
</section>
<section id="id13">
<h2><a class="toc-backref" href="#id54"><span class="section-number">3.10.6. </span>信号的名称和值</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<p>每个信号都有以“SIG”开头的名称，并定义为唯一的正整数。在Shell命令行提示符下，输入“kill
-l”命令，将显示所有信号的信号值和相应的信号名，类似如下所示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kill -l
 1) SIGHUP       2) SIGINT       3) SIGQUIT      4) SIGILL       5) SIGTRAP
 6) SIGABRT      7) SIGEMT       8) SIGFPE       9) SIGKILL     10) SIGBUS
11) SIGSEGV     12) SIGSYS      13) SIGPIPE     14) SIGALRM     15) SIGTERM
16) SIGURG      17) SIGSTOP     18) SIGTSTP     19) SIGCONT     20) SIGCHLD
21) SIGTTIN     22) SIGTTOU     23) SIGIO       24) SIGXCPU     25) SIGXFSZ
26) SIGVTALRM   27) SIGPROF     28) SIGWINCH    29) SIGPWR      30) SIGUSR1
31) SIGUSR2     32) SIGRTMIN    33) SIGRTMIN+1  34) SIGRTMIN+2  35) SIGRTMIN+3
36) SIGRTMIN+4  37) SIGRTMIN+5  38) SIGRTMIN+6  39) SIGRTMIN+7  40) SIGRTMIN+8
41) SIGRTMIN+9  42) SIGRTMIN+10 43) SIGRTMIN+11 44) SIGRTMIN+12 45) SIGRTMIN+13
46) SIGRTMIN+14 47) SIGRTMIN+15 48) SIGRTMIN+16 49) SIGRTMAX-15 50) SIGRTMAX-14
51) SIGRTMAX-13 52) SIGRTMAX-12 53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9
56) SIGRTMAX-8  57) SIGRTMAX-7  58) SIGRTMAX-6  59) SIGRTMAX-5  60) SIGRTMAX-4
61) SIGRTMAX-3  62) SIGRTMAX-2  63) SIGRTMAX-1  64) SIGRTMAX
</pre></div>
</div>
<p>实例1：发送SIGKILL信号到PID是123的进程。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">kill</span> -9 <span class="m">123</span>
或是
<span class="nb">kill</span> -KILL <span class="m">123</span>
</pre></div>
</div>
<p>POSIX标准信号表</p>
<img alt="../../_images/linux_sigin001.png" src="../../_images/linux_sigin001.png" />
<section id="id14">
<h3><a class="toc-backref" href="#id55">捕获信号</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>Bash的内部命令trap，让我们可以在Shell脚本内捕获特定的信号并对它们进行处理。trap命令的语法如下所示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ trap command signal [ signal … ]
</pre></div>
</div>
<p><strong>示例 1：按 CTRL+C 不退出循环</strong></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nb">trap</span> <span class="s2">&quot;&quot;</span> <span class="m">2</span> <span class="c1"># 不指定 arg 就不做任何操作，后面也可以写多个信号，以空格分隔</span>
    <span class="k">for</span> i <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> <span class="nv">$i</span>
    sleep <span class="m">1</span>
<span class="k">done</span>
</pre></div>
</div>
<p><strong>示例 2：循环打印数字，按 CTRL+C 退出，并打印退出提示</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Testing signal trapping</span>
<span class="c1">#</span>
<span class="nb">trap</span> <span class="s2">&quot;echo &#39; Sorry! I have trapped Ctrl-C&#39;&quot;</span> SIGINT
<span class="c1">#</span>
<span class="nb">echo</span> This is a <span class="nb">test</span> script
<span class="c1">#</span>
<span class="nv">count</span><span class="o">=</span><span class="m">1</span>
<span class="k">while</span> <span class="o">[</span> <span class="nv">$count</span> -le <span class="m">10</span> <span class="o">]</span>
<span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&quot;Loop #</span><span class="nv">$count</span><span class="s2">&quot;</span>
    sleep <span class="m">1</span>
    <span class="nv">count</span><span class="o">=</span>$<span class="o">[</span> <span class="nv">$count</span> + <span class="m">1</span> <span class="o">]</span>
<span class="k">done</span>
<span class="c1">#</span>
<span class="nb">echo</span> <span class="s2">&quot;This is the end of the test script&quot;</span>
</pre></div>
</div>
<p><strong>示例 3：让用户选择是否终止循环</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nb">trap</span> <span class="s2">&quot;func&quot;</span> <span class="m">2</span>
func<span class="o">()</span> <span class="o">{</span>
<span class="nb">read</span> -p <span class="s2">&quot;Terminate the process? (Y/N): &quot;</span> input
<span class="k">if</span> <span class="o">[</span> <span class="nv">$input</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">exit</span>
<span class="k">fi</span>
<span class="o">}</span>
<span class="k">for</span> i <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
<span class="nb">echo</span> <span class="nv">$i</span>
sleep <span class="m">1</span>
<span class="k">done</span>
<span class="c1"># bash a.sh</span>
<span class="m">1</span>
<span class="m">2</span>
<span class="m">3</span>
^CTerminate the process? <span class="o">(</span>Y/N<span class="o">)</span>: Y
<span class="c1"># bash a.sh</span>
<span class="m">1</span>
<span class="m">2</span>
<span class="m">3</span>
</pre></div>
</div>
<p><strong>示例4：捕获退出</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#捕获退出状态0</span>
<span class="nb">trap</span> <span class="s1">&#39;echo &quot;Exit 0 signal detected...&quot;&#39;</span> <span class="m">0</span>
<span class="c1"># 打印信息</span>
<span class="nb">echo</span> <span class="s2">&quot;This script is used for testing trap command.&quot;</span>

<span class="c1"># 以状态（信号）0退出此Shell脚本</span>
<span class="nb">exit</span>
</pre></div>
</div>
<p><strong>示例5：捕获中断或kill</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#捕获信号SIGINT，然后打印相应信息</span>
<span class="nb">trap</span> <span class="s2">&quot;echo &#39;You hit control+C! I am ignoring you.&#39;&quot;</span> SIGINT
<span class="c1">#捕获信号SIGTERM，然后打印相应信息</span>
<span class="nb">trap</span> <span class="s2">&quot;echo &#39;You tried to kill me! I am ignoring you.&#39;&quot;</span> SIGTERM

<span class="c1">#循环5次</span>
<span class="k">for</span> i <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..5<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
  <span class="nb">echo</span> <span class="s2">&quot;Iteration </span><span class="nv">$i</span><span class="s2"> of 5&quot;</span>
  <span class="c1">#暂停5秒</span>
  sleep <span class="m">5</span>
<span class="c1">#结束for循环</span>
<span class="k">done</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">如果敲击CTRL+C组合键，将会中断sleep命令，进入下一次循环，此脚本并不会被终结，并看到输出信息“You</span> <span class="pre">hit</span> <span class="pre">control+C!</span> <span class="pre">I</span> <span class="pre">am</span> <span class="pre">ignoring</span> <span class="pre">you.”</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">如果我们同时在另一个终端窗口尝试使用kill命令终结此脚本，此脚本并不会被终结，而是会显示信息“You</span> <span class="pre">tried</span> <span class="pre">to</span> <span class="pre">kill</span> <span class="pre">me!</span> <span class="pre">I</span> <span class="pre">am</span> <span class="pre">ignoring</span> <span class="pre">you.”</span></code></p>
</section>
</section>
<section id="id15">
<h2><a class="toc-backref" href="#id56"><span class="section-number">3.10.7. </span>Shell脚本的参数解析工具</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.escapelife.site/posts/9b814911.html">https://www.escapelife.site/posts/9b814911.html</a></p>
<p><a class="reference external" href="https://www.yuque.com/fcant/linux/yu9cx5">https://www.yuque.com/fcant/linux/yu9cx5</a></p>
<section id="while-case">
<h3><a class="toc-backref" href="#id57">while+case命令行参数传递</a><a class="headerlink" href="#while-case" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://blog.csdn.net/zhoudatianchai/article/details/113984286">https://blog.csdn.net/zhoudatianchai/article/details/113984286</a></p>
<p>实现对输入参数的分析，但是下面的使用case表达式的例子</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

help<span class="o">()</span>
<span class="o">{</span>
   cat <span class="p">&amp;</span>lt<span class="p">;&amp;</span>lt<span class="p">;</span> HELP
   This is a generic <span class="nb">command</span> line parser demo.
   USAGE EXAMPLE: cmdparser -l hello -f -- -somefile1 somefile2
HELP
   <span class="nb">exit</span> <span class="m">0</span>
<span class="o">}</span>

<span class="k">while</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
   -h<span class="o">)</span> help<span class="p">;</span><span class="nb">shift</span> <span class="m">1</span><span class="p">;;</span> <span class="c1"># function help is called</span>
   -f<span class="o">)</span> <span class="nv">opt_f</span><span class="o">=</span><span class="m">1</span><span class="p">;</span><span class="nb">shift</span> <span class="m">1</span><span class="p">;;</span> <span class="c1"># variable opt_f is set</span>
   -l<span class="o">)</span> <span class="nv">opt_l</span><span class="o">=</span><span class="nv">$2</span><span class="p">;</span><span class="nb">shift</span> <span class="m">2</span><span class="p">;;</span> <span class="c1"># -l takes an argument -&amp;gt; shift by 2</span>
   --<span class="o">)</span> shift<span class="p">;</span>break<span class="p">;;</span> <span class="c1"># end of options</span>
   -*<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;error: no such option </span><span class="nv">$1</span><span class="s2">. -h for help&quot;</span><span class="p">;</span><span class="nb">exit</span> <span class="m">1</span><span class="p">;;</span>
   *<span class="o">)</span> break<span class="p">;;</span>
<span class="k">esac</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;opt_f is </span><span class="nv">$opt_f</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;opt_l is </span><span class="nv">$opt_l</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;first arg is </span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;2nd arg is </span><span class="nv">$2</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>你可以这样运行该脚本：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cmdparser -l hello -f -- -somefile1 somefile2
</pre></div>
</div>
<p>Shell编程基础参考</p>
<p><a class="reference external" href="https://wiki.ubuntu.org.cn/Shell%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80#Shell.E9.87.8C.E7.9A.84.E5.87.BD.E6.95.B0">https://wiki.ubuntu.org.cn/Shell%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80#Shell.E9.87.8C.E7.9A.84.E5.87.BD.E6.95.B0</a></p>
</section>
<section id="getopts">
<h3><a class="toc-backref" href="#id58">getopts处理多命令行选项</a><a class="headerlink" href="#getopts" title="Permalink to this headline">¶</a></h3>
<p>例如，下面的命令告诉getopts查找-f、-A和-x选项：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ getopts fAx VARNAME
</pre></div>
</div>
<p>下面的命令表示告诉getopts命令，-A选项后面会有一个参数：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ getopts fA:x VARNAME
</pre></div>
</div>
<p>当你希望以专业的方式解析命令行选项和参数时，getopts将是一个很好的工具。它是Bash的内部命令。它的优势在于：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>* 你不需要通过一个外部程序来处理位置参数。
* getopts可以很容易地设置你可以用来解析的Shell变量（对于一个外部进程是不可能的）。
* getopts定义在POSIX中。
</pre></div>
</div>
<p>因为当没有内容可解析时，getopts会设置一个退出状态FALSE，所以它很容易在while循环中使用：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>while getopts …; do
  …
done
</pre></div>
</div>
<p>getopts会使用到以下3个变量。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>OPTIND：存放下一个要处理的参数的索引。这是getopts在调用过程中记住自己状态的方式。同样可以用于移位使用getopts处理后的位置参数。OPTIND初始被设为1，并且如果你想再次使用getopts解析任何内容，需要将其重置为1。
OPTARG：这个变量被设置为由getopts找到的选项所对应的参数。
OPTERR：它的值为0或1。指示Bash是否应该显示由getopts产生的错误信息。在每个Shell启动时，它的值被初始化为1。如果你不想看烦人的信息，请确保将它设置为0。
</pre></div>
</div>
<p><strong>代码示例</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 使用getopts解析命令行选项，这里仅解析-a选项，选项字符串中的第一个字符为冒号(:)，表示抑制错误报告
while getopts &quot;:a&quot; opt
do
  case $opt in
                # 匹配-a选项
        a)
                  echo &quot;The option -a was triggered!&quot;
                  ;;
                # 匹配其他选项
        \?)
                  echo &quot;Invalid option: -${OPTARG}&quot;
                  ;;
          esac
done
$ sh test_getopts_1.sh

$ sh test_getopts_1.sh -a
The option -a was triggered!

$ sh test_getopts_1.sh -b
Invalid option: -b
</pre></div>
</div>
<p><strong>代码示例2</strong> 这个脚本稍微复杂一些，它可以接收多个命令行选项和参数</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

# 定义变量vflag
vflag=off

# 定义变量filename
filename=&quot;&quot;

# 定义变量output
output=&quot;&quot;


# 定义函数usage
function usage() {
  echo &quot;USAGE:&quot;
  echo &quot;    myscript [-h] [-v] [-f &lt;filename&gt;] [-o &lt;filename&gt;]&quot;
  exit -1
}



# 在while循环中使用getopts解析命令行选项
# 要解析的选项有-h、-v、-f和-o，其中-f和-o选项带有参数
# 字符串选项中第一个冒号表示getopts使用抑制错误报告模式
while getopts :hvf:o: opt
do
  case &quot;$opt&quot; in

    v)

        vflag=on

    ;;
    f)
      # 将-f选项的参数赋值给变量filename
          filename=$OPTARG

          # 如果文件不存在，则显示提示信息，并退出脚本的执行
          if [ ! -f $filename ]
          then
            echo &quot;The source file $filename doesn&#39;t exist!&quot;
            exit
          fi
          ;;

    o)
        # 将-o选项的参数赋值给变量output
        output=$OPTARG
        # 如果指定的输出文件的目录不存在，则显示提示信息，并退出脚本的执行
        if [ ! -d `dirname $output` ]
            then
            echo &quot;The output path `dirname $output` doesn&#39;t exist!&quot;
            exit
        fi

        ;;

    h)
      # 显示脚本的使用信息
          usage
          exit
          ;;
    :)

         # 如果没有为需要参数的选项指定参数，则显示提示信息，并退出脚本的运行
          echo &quot;The option -$OPTARG requires an argument.&quot;
          exit 1
          ;;

    ?)
        # 若指定的选项为无效选项，则显示提示信息，及脚本的使用方法信息，并退出脚本的运行
          echo &quot;Invalid option: -$OPTARG&quot;
          usage
          exit 2
          ;;
      esac
done
$ sh test_getopts_2.sh -h
USAGE:
    myscript [-h] [-v] [-f &lt;filename&gt;] [-o &lt;filename&gt;]

$ sh test_getopts_2.sh -vf
The option -f requires an argument.

$ sh test_getopts_2.sh -q
Invalid option: -q
USAGE:
    myscript [-h] [-v] [-f &lt;filename&gt;] [-o &lt;filename&gt;]

$ sh test_getopts_2.sh -vf /etc/networks -o /tmp/out.log/aaa
The output path /tmp/out.log doesn&#39;t exist!
</pre></div>
</div>
<p><strong>getopt 参数解析</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ARGS=`getopt -o u:j: -al user:,job: -- &quot;$@&quot;`
eval set -- &quot;$ARGS&quot;
while [ -n &quot;$1&quot; ]; do
    case &quot;$1&quot; in
        -j|--job) job=$2; shift 2;;
        -u|--user) user=$2; shift 2;;
        *) break;;
    esac
done
</pre></div>
</div>
<p>注：</p>
<p>​ -o 短变量名</p>
<p>​ -al 长变量名</p>
<p>​ ： 需要复制</p>
<p>getopt：命令行选项、参数处理</p>
<p>参考如下文献</p>
<p><a class="reference external" href="https://blog.csdn.net/tdmyl/article/details/24714297?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control">https://blog.csdn.net/tdmyl/article/details/24714297?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control</a></p>
<p><a class="reference external" href="https://blog.csdn.net/hanlizhong85/article/details/78008845">https://blog.csdn.net/hanlizhong85/article/details/78008845</a></p>
<p><a class="reference external" href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/index.html">Linux常用命令工具箱</a></p>
</section>
</section>
<section id="id16">
<h2><a class="toc-backref" href="#id59"><span class="section-number">3.10.8. </span>子shell</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h2>
<section id="id17">
<h3><a class="toc-backref" href="#id60">在子shell中执行命令</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<section id="id18">
<h4>1．圆括号结构<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<p>当一组命令放在圆括号中时，该组命令会在一个子Shell环境中执行，其语法如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">command1</span><span class="p">;</span><span class="n">command2</span><span class="p">;</span><span class="n">command3</span><span class="p">;</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>在上面的语法中，command1、command2，以及command3等都是Shell命令，这些命令写在一行中，它们之间用分号隔开。</p>
<p>如果每一行只有一条命令，则可以省略分号，变成以下语法形式：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
   <span class="n">command1</span>
   <span class="n">command2</span>
   <span class="n">command3</span>
   <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>演示子shell的使用</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nb">echo</span>
<span class="c1"># 输出子 Shell 的层次</span>
<span class="nb">echo</span> <span class="s2">&quot;Subshell level OUTSIDE subshell = </span><span class="nv">$BASH_SUBSHELL</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="c1"># 定义子 Shell 外面的变量</span>
<span class="nv">outer_variable</span><span class="o">=</span>Outer
<span class="c1"># 圆括号开始</span>
<span class="o">(</span>
   <span class="c1"># 输出子 Shell 的层次</span>
   <span class="nb">echo</span> <span class="s2">&quot;Subshell level INSIDE subshell = </span><span class="nv">$BASH_SUBSHELL</span><span class="s2">&quot;</span>
   <span class="c1"># 定义子 Shell 内的变量</span>
   <span class="nv">inner_variable</span><span class="o">=</span>Inner
   <span class="c1"># 在子 Shell 内输出圆括号里面定义的变量</span>
   <span class="nb">echo</span> <span class="s2">&quot;From subshell, \&quot;inner_variable\&quot; = </span><span class="nv">$inner_variable</span><span class="s2">&quot;</span>
   <span class="c1"># 在子 Shell 内输出圆括号外面定义的变量</span>
   <span class="nb">echo</span> <span class="s2">&quot;From subshell, \&quot;outer\&quot; = </span><span class="nv">$outer_variable</span><span class="s2">&quot;</span>
<span class="o">)</span>

<span class="nb">echo</span>
<span class="c1"># 输出子 Shell 级别</span>
<span class="nb">echo</span> <span class="s2">&quot;Subshell level OUTSIDE subshell = </span><span class="nv">$BASH_SUBSHELL</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="c1"># 判断 inner_variable 变量是否已经定义</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$inner_variable</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;inner_variable undefined in main body of shell&quot;</span>
<span class="k">else</span>
  <span class="nb">echo</span> <span class="s2">&quot;inner_variable defined in main body of shell&quot;</span>
<span class="k">fi</span>
<span class="c1"># 输出圆括号内定义的变量</span>
<span class="nb">echo</span> <span class="s2">&quot;From main body of shell, \&quot;inner_variable\&quot; = </span><span class="nv">$inner_variable</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>演示将脚本中的部分代码放在后台执行的方法</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># 输出开始提示信息</span>
<span class="nb">echo</span> <span class="s2">&quot;Before starting subshell&quot;</span>
<span class="c1"># 圆括号结构开始</span>
<span class="o">(</span>
   <span class="nv">count</span><span class="o">=</span><span class="m">1</span>
   <span class="k">while</span> <span class="o">[</span> <span class="nv">$count</span> -le <span class="m">10</span> <span class="o">]</span>
   <span class="k">do</span>
       <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$count</span><span class="s2">&quot;</span>
       sleep <span class="m">1</span>
       <span class="c1"># 在 Shell 中修改循环变量的值</span>
       <span class="o">((</span> count++ <span class="o">))</span>
   <span class="k">done</span>
<span class="o">)</span> <span class="p">&amp;</span>
<span class="nb">echo</span> <span class="s2">&quot;Finished&quot;</span>
</pre></div>
</div>
</section>
<section id="id19">
<h4>2．后台执行或异步执行<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<p>在某些情况下，Shell命令需要较长的时间来执行，尤其是在处理大量的数据的时候。在这种情况下，用户可以将命令置于后台执行，而不必等待命令执行结束。</p>
<p>将命令置于后台执行的语法如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">command</span><span class="o">&amp;</span>
</pre></div>
</div>
<p>其中，command表示要执行的命令，&amp;操作符表示将前面的命令置于后台执行。在命令末尾追加&amp;操作符之后，当前命令会由一个子Shell在后台执行。当前的Shell会立即获得控制权并且返回到命令行提示符。后台命令和当前的Shell是并行的，相互之间没有依赖及等待关系。这意味着，后台命令和当前Shell是异步的并行。</p>
</section>
<section id="id20">
<h4>3．命令替换<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<p>命令替换的语法如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;command&#39;</span>
</pre></div>
</div>
<p>或者</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$(command)
</pre></div>
</div>
<p>其中，command表示要执行的命令。command会在一个子Shell中执行，不会影响当前的Shell环境。</p>
</section>
</section>
</section>
<section id="id21">
<h2><a class="toc-backref" href="#id61"><span class="section-number">3.10.9. </span>自动化</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h2>
<section id="id22">
<h3><a class="toc-backref" href="#id62">开机自启动脚本</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>如果要添加为开机启动执行的脚本文件，可先将脚本复制或者软连接到/etc/init.d/目录下，然后用：

    update-rc.d xxx defaults NN命令(NN为启动顺序)，
将脚本添加到初始化执行的队列中去。

注意如果脚本需要用到网络，则NN需设置一个比较大的数字，如99。

1) 将你的启动脚本复制到 /etc/init.d目录下,以下假设你的脚本文件名为 test。

2) 设置脚本文件的权限

    $ sudo chmod 755 /etc/init.d/test
3) 执行如下命令将脚本放到启动脚本中去：

    $ cd /etc/init.d
    $ sudo update-rc.d test defaults 95
</pre></div>
</div>
</section>
</section>
<section id="id23">
<h2><a class="toc-backref" href="#id63"><span class="section-number">3.10.10. </span>Shell脚本实战</a><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h2>
<p>更多示例可参考：<a class="reference external" href="https://github.com/redhatxl/scripts">shell
脚本示例</a></p>
</section>
<section id="id24">
<h2><a class="toc-backref" href="#id64"><span class="section-number">3.10.11. </span>服务脚本的基本语法</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h2>
<p>在Linux系统中，服务脚本有固定的语法，通常情况下，服务脚本应该包括处理服务启动、服务停止、服务重新启动，以及查看服务状态的函数。另外，服务脚本还可以接受某些特定的参数，例如start、stop，以及restart等，并且根据这些参数调用不同的函数。</p>
<p>下面给出的是某个Linux系统中的Apache
Web服务器的服务脚本，为了节省篇幅，省略了部分无关紧要的代码。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 在当前 Shell 中执行定义公共函数的脚本</span>
. /etc/rc.d/init.d/functions

<span class="c1">#Apache 各组件的路径</span>
<span class="nv">apachectl</span><span class="o">=</span>/usr/sbin/apachectl
<span class="nv">httpd</span><span class="o">=</span><span class="si">${</span><span class="nv">HTTPD</span><span class="p">-/usr/sbin/httpd</span><span class="si">}</span>
<span class="nv">prog</span><span class="o">=</span>httpd
<span class="nv">pidfile</span><span class="o">=</span><span class="si">${</span><span class="nv">PIDFILE</span><span class="p">-/var/run/httpd/httpd.pid</span><span class="si">}</span>
<span class="nv">lockfile</span><span class="o">=</span><span class="si">${</span><span class="nv">LOCKFILE</span><span class="p">-/var/lock/subsys/httpd</span><span class="si">}</span>

<span class="c1"># 脚本执行结果</span>
<span class="nv">RETVAL</span><span class="o">=</span><span class="m">0</span>
<span class="c1"># 停止服务的超时时间</span>
<span class="nv">STOP_TIMEOUT</span><span class="o">=</span><span class="si">${</span><span class="nv">STOP_TIMEOUT</span><span class="p">-10</span><span class="si">}</span>

<span class="c1"># 定义启动服务的函数</span>
start<span class="o">()</span> <span class="o">{</span>
        <span class="nb">echo</span> -n $<span class="s2">&quot;Starting </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
        <span class="nv">LANG</span><span class="o">=</span><span class="nv">$HTTPD_LANG</span> daemon --pidfile<span class="o">=</span><span class="si">${</span><span class="nv">pidfile</span><span class="si">}</span> <span class="nv">$httpd</span> <span class="nv">$OPTIONS</span>
        <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
        <span class="nb">echo</span>
        <span class="o">[</span> <span class="nv">$RETVAL</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> touch <span class="si">${</span><span class="nv">lockfile</span><span class="si">}</span>
        <span class="k">return</span> <span class="nv">$RETVAL</span>
<span class="o">}</span>

<span class="c1"># 定义停止服务的函数</span>
stop<span class="o">()</span> <span class="o">{</span>
   <span class="nb">echo</span> -n $<span class="s2">&quot;Stopping </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
        killproc -p <span class="si">${</span><span class="nv">pidfile</span><span class="si">}</span> -d <span class="si">${</span><span class="nv">STOP_TIMEOUT</span><span class="si">}</span> <span class="nv">$httpd</span>
        <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
        <span class="nb">echo</span>
        <span class="o">[</span> <span class="nv">$RETVAL</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -f <span class="si">${</span><span class="nv">lockfile</span><span class="si">}</span> <span class="si">${</span><span class="nv">pidfile</span><span class="si">}</span>
<span class="o">}</span>
<span class="c1"># 定义重新加载配置文件的函数</span>
reload<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> -n $<span class="s2">&quot;Reloading </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
    <span class="k">if</span> ! <span class="nv">LANG</span><span class="o">=</span><span class="nv">$HTTPD_LANG</span> <span class="nv">$httpd</span> <span class="nv">$OPTIONS</span> -t &gt;<span class="p">&amp;</span>/dev/null<span class="p">;</span> <span class="k">then</span>
        <span class="nv">RETVAL</span><span class="o">=</span><span class="m">6</span>
        <span class="nb">echo</span> <span class="s2">$&quot;not reloading due to configuration syntax error&quot;</span>
        failure $<span class="s2">&quot;not reloading </span><span class="nv">$httpd</span><span class="s2"> due to configuration syntax error&quot;</span>
    <span class="k">else</span>
        <span class="c1"># Force LSB behaviour from killproc</span>
        <span class="nv">LSB</span><span class="o">=</span><span class="m">1</span> killproc -p <span class="si">${</span><span class="nv">pidfile</span><span class="si">}</span> <span class="nv">$httpd</span> -HUP
        <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">7</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            failure <span class="s2">$&quot;httpd shutdown&quot;</span>
        <span class="k">fi</span>
    <span class="k">fi</span>
    <span class="nb">echo</span>
<span class="o">}</span>

<span class="c1"># 根据用户传递的参数执行不同的操作</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
      <span class="c1"># 启动服务</span>
      start<span class="o">)</span>
           start
           <span class="p">;;</span>
      <span class="c1"># 停止服务</span>
      stop<span class="o">)</span>
           stop
           <span class="p">;;</span>
      <span class="c1"># 查看服务状态</span>
      status<span class="o">)</span>
           status -p <span class="si">${</span><span class="nv">pidfile</span><span class="si">}</span> <span class="nv">$httpd</span>
           <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
           <span class="p">;;</span>
      <span class="c1"># 重新启动服务</span>
      restart<span class="o">)</span>
           stop
           start
           <span class="p">;;</span>
      <span class="c1"># 强制重新启动</span>
      force-reload<span class="p">|</span>reload<span class="o">)</span>
           reload
           <span class="p">;;</span>
      <span class="c1"># 处理其他情况</span>
      *<span class="o">)</span>
           <span class="nb">echo</span> $<span class="s2">&quot;Usage: </span><span class="nv">$prog</span><span class="s2"> {start|stop|restart|condrestart|try-restart|force-reload|reload|status|fullstatus|graceful|help|configtest}&quot;</span>
          <span class="nv">RETVAL</span><span class="o">=</span><span class="m">2</span>
  <span class="k">esac</span>

  <span class="nb">exit</span> <span class="nv">$RETVAL</span>
</pre></div>
</div>
<p>编写MySQL服务脚本</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="c1">#</span>
<span class="c1"># MySQL 服务脚本</span>
<span class="c1">#  指定运行级别以及优先级</span>
<span class="c1"># chkconfig: - 64 36</span>
<span class="c1"># description:  MySQL database server.</span>

<span class="c1">#MySQL 服务主程序的路径</span>
<span class="nv">mysql</span><span class="o">=</span><span class="s2">&quot;/usr/bin/mysqld_safe&quot;</span>

<span class="c1">#MySQL 管理工具路径</span>
<span class="nv">mysqladmin</span><span class="o">=</span><span class="s2">&quot;/usr/bin/mysqladmin&quot;</span>

<span class="c1"># 定义获取 MySQL 选项的函数</span>
get_mysql_option<span class="o">()</span>
<span class="o">{</span>
   <span class="c1"># 使用 my_print_defaults 命令输出各个选项</span>
   <span class="nv">result</span><span class="o">=</span><span class="s1">&#39;/usr/bin/my_print_defaults &quot;$1&quot; | sed -n &quot;s/^--$2=//p&quot; |tail -n 1&#39;</span>
   <span class="c1"># 如果文件不存在，则使用默认值</span>
   <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$result</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nv">result</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
   <span class="k">fi</span>
<span class="o">}</span>
<span class="c1"># 数据库文件路径</span>
get_mysql_option mysqld datadir <span class="s2">&quot;/var/lib/mysql&quot;</span>

<span class="nv">datadir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$result</span><span class="s2">&quot;</span>

<span class="c1">#Socket 文件路径</span>
get_mysql_option mysqld socket <span class="s2">&quot;</span><span class="nv">$datadir</span><span class="s2">/mysql.sock&quot;</span>
<span class="nv">socketfile</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$result</span><span class="s2">&quot;</span>

<span class="c1"># 日志文件路径</span>
get_mysql_option mysqld_safe log-error <span class="s2">&quot;/var/log/mysqld.log&quot;</span>
<span class="nv">errlogfile</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$result</span><span class="s2">&quot;</span>

<span class="c1"># 进程 ID 文件路径</span>
get_mysql_option mysqld_safe pid-file <span class="s2">&quot;/var/run/mysqld/mysqld.pid&quot;</span>
<span class="nv">mypidfile</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$result</span><span class="s2">&quot;</span>

<span class="c1"># 服务启动函数</span>
start<span class="o">(){</span>
   <span class="c1"># 如果程序不可执行，则直接退出</span>
   <span class="o">[</span> -x <span class="nv">$mysql</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">5</span>
   <span class="c1">#  判断服务进程是否存在</span>
   /usr/bin/mysqladmin --socket<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$socketfile</span><span class="s2">&quot;</span> --user<span class="o">=</span>mysql ping <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
   <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;mysql has been already running.&quot;</span>
      <span class="nv">ret</span><span class="o">=</span><span class="m">0</span>
   <span class="k">else</span>
      <span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;</span><span class="nv">$datadir</span><span class="s2">/mysql&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
         <span class="nb">echo</span> <span class="s2">&quot;mysql database does not exists.&quot;</span>
         <span class="nb">exit</span> <span class="m">1</span>
      <span class="k">fi</span>

      <span class="nv">$mysql</span> --datadir<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$datadir</span><span class="s2">&quot;</span> --socket<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$socketfile</span><span class="s2">&quot;</span> --pid-file<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$mypidfile</span><span class="s2">&quot;</span> --basedir<span class="o">=</span>/usr --user<span class="o">=</span>mysql &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>

      <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>

      <span class="k">if</span> <span class="o">[</span> <span class="nv">$ret</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
         touch <span class="nv">$lockfile</span>
      <span class="k">else</span>
         <span class="nb">echo</span> <span class="s2">&quot;starting mysql failed.&quot;</span>
      <span class="k">fi</span>
   <span class="k">fi</span>
   <span class="k">return</span> <span class="nv">$ret</span>
<span class="o">}</span>

stop<span class="o">(){</span>
   <span class="c1"># 如果进程文件不存在，则直接退出</span>
   <span class="k">if</span> <span class="o">[</span> ! -f <span class="s2">&quot;</span><span class="nv">$mypidfile</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;mysql is not running.&quot;</span>
      <span class="k">return</span> <span class="m">0</span>
   <span class="k">fi</span>
   <span class="c1"># 从进程文件中获取进程 ID</span>
   <span class="nv">mysqlpid</span><span class="o">=</span><span class="s1">&#39;cat &quot;$mypidfile&quot;&#39;</span>
   <span class="c1"># 如果进程 ID 为整数，则调用 mysqladmin 停止 mysql 服务</span>
   <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$mysqlpid</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nv">$mysqladmin</span> --socket<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$socketfile</span><span class="s2">&quot;</span> --user<span class="o">=</span>root shutdown

      <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>
      <span class="c1"># 如果停止成功，则删除锁定文件和 Socket 文件</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nv">$ret</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
         rm -f <span class="nv">$lockfile</span>
         rm -f <span class="s2">&quot;</span><span class="nv">$socketfile</span><span class="s2">&quot;</span>
         <span class="nb">echo</span> <span class="s2">&quot;mysql stopped.&quot;</span>
         <span class="nv">ret</span><span class="o">=</span><span class="m">0</span>
      <span class="k">else</span>
         <span class="nb">echo</span> <span class="s2">&quot;stopping mysql failed.&quot;</span>
         <span class="nv">ret</span><span class="o">=</span><span class="m">1</span>
      <span class="k">fi</span>

      <span class="k">return</span> <span class="nv">$ret</span>
<span class="o">}</span>

restart<span class="o">(){</span>
    stop
    start
<span class="o">}</span>

<span class="c1"># 根据参数值执行相应的操作</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
   <span class="c1"># 启动服务</span>
   start<span class="o">)</span>
      start
      <span class="p">;;</span>
   <span class="c1"># 停止服务</span>
   stop<span class="o">)</span>
      stop
    <span class="p">;;</span>
   <span class="c1"># 查看状态</span>
   status<span class="o">)</span>
      <span class="k">if</span> <span class="o">[</span> -n pidof <span class="s2">&quot;</span><span class="nv">$procname</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
         <span class="nb">echo</span> <span class="s2">&quot;mysql is running.&quot;</span>
      <span class="k">fi</span>
      <span class="p">;;</span>
   <span class="c1"># 重新启动</span>
   restart<span class="o">)</span>
      restart
      <span class="p">;;</span>
   *<span class="o">)</span>
      <span class="nb">echo</span> $<span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> {start|stop|status|restart}&quot;</span>
      <span class="nb">exit</span> <span class="m">2</span>
<span class="k">esac</span>

<span class="nb">exit</span> <span class="nv">$?</span>
</pre></div>
</div>
<p>在上面的代码中，第6行需要特别说明一下。该行的作用是告诉chkconfig命令，当前的服务脚本可以在哪些运行级别下面执行。其中连字符-表示当前脚本适用于所有的运行级别。如果只想在某些运行级别下面执行，则可以直接用数字指定，例如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># chkconfig: 345 64 36</span>
</pre></div>
</div>
<p>表示当前脚本可以在3、4和5这3个运行级别下面运行。后面的2个数字分别表示当前脚本在启动和停止时的优先级。数值越小，优先级越高；反之，优先级越低。</p>
<p>当整个mysql脚本都编写完成之后，将其复制到/etc/init.d目录中，并且赋予可执行权限，命令如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@linux</span> <span class="n">chapter15</span><span class="p">]</span><span class="c1"># cp mysql /etc/init.d/</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@linux</span> <span class="n">chapter15</span><span class="p">]</span><span class="c1"># chmod +x /etc/init.d/mysqld</span>
</pre></div>
</div>
<p>接下来使用chkconfig命令更新系统服务，如下所示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@linux</span> <span class="n">chapter15</span><span class="p">]</span><span class="c1"># chkconfig mysql on</span>
</pre></div>
</div>
<p>最后，用户就可以使用service命令来启动、停止或者查看运行状态了，代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@linux</span> <span class="n">chapter15</span><span class="p">]</span><span class="c1"># service mysql start</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@linux</span> <span class="n">chapter15</span><span class="p">]</span><span class="c1"># service mysql status</span>
</pre></div>
</div>
<section id="apache">
<h3><a class="toc-backref" href="#id65">1. Apache服务器日志管理</a><a class="headerlink" href="#apache" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#! /bin/bash</span>

<span class="c1"># 归档文件名生成函数</span>
<span class="k">function</span> filename<span class="o">()</span>
<span class="o">{</span>
   <span class="nv">timestamp</span><span class="o">=</span><span class="k">$(</span>date +%Y%m%d%H%M%S<span class="k">)</span>
   <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>.<span class="nv">$timestamp</span>.<span class="s2">&quot;tar&quot;</span>
<span class="o">}</span>


<span class="c1"># 过期日志归档函数</span>
<span class="k">function</span> archivelog<span class="o">()</span>
<span class="o">{</span>
   <span class="nv">archivefile</span><span class="o">=</span><span class="s1">&#39;filename httpd_log&#39;</span>

   <span class="nv">archivedest</span><span class="o">=</span><span class="nv">$1</span>

   <span class="k">if</span> <span class="o">[</span> ! -d archivedest <span class="o">]</span><span class="p">;</span><span class="k">then</span>
      mkdir -p <span class="nv">$archivedest</span>
   <span class="k">fi</span>

   <span class="nb">cd</span> /var/log/httpd

   find . -mtime +1 -exec tar -rf <span class="nv">$archivedest$archivefile</span> <span class="o">{}</span> <span class="se">\;</span>

   zip <span class="nv">$archivedest$archivefile</span><span class="s2">&quot;.zip&quot;</span> <span class="nv">$archivedest$archivefile</span>

   <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span>
   <span class="k">then</span>
      rm -f <span class="nv">$archivedest$archivefile</span>
   <span class="k">fi</span>

   <span class="k">return</span> <span class="nv">$?</span>
<span class="o">}</span>


<span class="c1"># 已归档日志删除函数</span>
<span class="k">function</span> removearchivedlog<span class="o">()</span>
<span class="o">{</span>
   <span class="nb">cd</span> /var/log/httpd

   find . -mtime +1 -exec rm -f <span class="nv">$archivedest$archivefile</span> <span class="o">{}</span> <span class="se">\;</span>
<span class="o">}</span>

<span class="c1"># 将过期日志归档</span>
archivelog <span class="s2">&quot;/root/chapter15/&quot;</span>


<span class="c1"># 删除已归档日志</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span>
<span class="k">then</span>
   removearchivedlog
<span class="k">fi</span>

<span class="nb">exit</span> <span class="m">0</span>
</pre></div>
</div>
<p>定时运行日志归档脚本</p>
<p>通常情况下，用户可以使用两种方法来实现脚本的定时运行。一种方法是使用sleep命令，另外一种方法是使用cron工具。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 无限循环</span>
<span class="k">while</span> <span class="nb">true</span>
<span class="k">do</span>
   <span class="c1"># 归档过期日志</span>
   archivelog <span class="s2">&quot;/root/chapter15/&quot;</span>

   <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span>
   <span class="k">then</span>
      <span class="c1"># 删除过期日志</span>
      removearchivedlog
   <span class="k">fi</span>
   <span class="c1"># 休眠 1 天</span>
   sleep <span class="m">86400</span>
<span class="k">done</span>
</pre></div>
</div>
<p>为了使得归档操作能够不断地重复执行，将archivelog()和removearchivedlog()这两个函数的调用都放在了一个无限循环结构中。第13行使用sleep命令使进程每天执行一次，其中sleep命令以秒为单位。</p>
<p>修改完成之后，用户可以使用以下命令执行归档脚本：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@linux</span> <span class="n">chapter15</span><span class="p">]</span><span class="c1"># ./archivelog.sh &amp;</span>
</pre></div>
</div>
<p>Cron计划任务的方式</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@linux log<span class="o">]</span><span class="c1"># crontab -l</span>
<span class="m">0</span> * * * * /root/chapter15/archivelog.sh
</pre></div>
</div>
</section>
<section id="id25">
<h3><a class="toc-backref" href="#id66">2 文件扫描校验</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#func:scan file</span>
<span class="c1">#md5sum -c $SCAN_FILE</span>


<span class="nv">SCAN_DIR</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$PATH</span> <span class="p">|</span>sed <span class="s1">&#39;s/:/ /g&#39;</span><span class="sb">`</span>
<span class="nv">SCAN_CMD</span><span class="o">=</span><span class="sb">`</span>which md5sum<span class="sb">`</span>
<span class="nv">SCAN_FILE_FALL</span><span class="o">=</span><span class="s2">&quot;/tmp/scan_</span><span class="k">$(</span>date +%F%H%m<span class="k">)</span><span class="s2">_fall.txt&quot;</span>
<span class="nv">SCAN_FILE_BIN</span><span class="o">=</span><span class="s2">&quot;/tmp/scan_</span><span class="k">$(</span>date +%F%H%m<span class="k">)</span><span class="s2">_bin.txt&quot;</span>

scan_fall_disk<span class="o">()</span> <span class="o">{</span>
        <span class="nb">echo</span> <span class="s2">&quot;正在全盘扫描，请稍等！文件路径:</span><span class="nv">$SCAN_FILE_FALL</span><span class="s2">&quot;</span>
        find / -type f -exec <span class="nv">$SCAN_CMD</span> <span class="se">\{\}</span> <span class="se">\;</span>&gt;&gt; <span class="nv">$SCAN_FILE_FALL</span> <span class="m">2</span>&gt;/dev/null
<span class="o">}</span>

scan_bin<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;正在扫描PATH可执行文件，请稍等，文件路径：</span><span class="nv">$SCAN_FILE_BIN</span><span class="s2">&quot;</span>
    <span class="k">for</span> file <span class="k">in</span> <span class="nv">$SCAN_DIR</span>
    <span class="k">do</span>
        find <span class="nv">$filae</span> -type f -exec <span class="nv">$SCAN_CMD</span> <span class="se">\{\}</span> <span class="se">\;</span>&gt;&gt; <span class="nv">$SCAN_FILE_BIN</span> <span class="m">2</span>&gt;/dev/null
    <span class="k">done</span>
<span class="o">}</span>

main<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="nv">$#</span> -lt <span class="m">1</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;请使用参数，1表示全盘扫描，2表示二进制可执行文件扫描&quot;</span>
    <span class="nb">read</span> number
    <span class="k">case</span> <span class="nv">$number</span> <span class="k">in</span>
    <span class="m">1</span><span class="o">)</span>
        scan_fall_disk<span class="p">;;</span>
    <span class="m">2</span><span class="o">)</span>
        scan_bin<span class="p">;;</span>
    *<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;参数错误，1，表示全盘扫描，2表示二进制文件扫描&quot;</span>
    <span class="k">esac</span>
<span class="o">}</span>


main
</pre></div>
</div>
</section>
<section id="id26">
<h3><a class="toc-backref" href="#id67">3 自定义垃圾回收</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># function:自定义rm命令，每天晚上定时清理</span>

<span class="nv">CMD_SCRIPTS</span><span class="o">=</span><span class="nv">$HOME</span>/.rm_scripts.sh
<span class="nv">TRASH_DIR</span><span class="o">=</span><span class="nv">$HOME</span>/.TRASH_DIR
<span class="nv">CRON_FILE</span><span class="o">=</span>/var/spool/cron/root
<span class="nv">BASHRC</span><span class="o">=</span><span class="nv">$HOME</span>/.bashrc

<span class="o">[</span> ! -d <span class="si">${</span><span class="nv">TRASH_DIR</span><span class="si">}</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> mkdir -p <span class="si">${</span><span class="nv">TRASH_DIR</span><span class="si">}</span>
cat &gt; <span class="nv">$CMD_SCRIPTS</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">PARA_CNT=\$#</span>
<span class="s">TRASH_DIR=$TRASH_DIR</span>

<span class="s">for i in \$*; do</span>
<span class="s">     DATE=\$(date +%F%T)</span>
<span class="s">     fileName=\$(basename \$i)</span>
<span class="s">     mv \$i \$TRASH_DIR/\$fileName.\$DATE</span>
<span class="s">done</span>
<span class="s">EOF</span>

sed -i <span class="s2">&quot;s@</span><span class="k">$(</span>grep <span class="s1">&#39;alias rm=&#39;</span> <span class="nv">$BASHRC</span><span class="k">)</span><span class="s2">@alias rm=&#39;bash </span><span class="si">${</span><span class="nv">CMD_SCRIPTS</span><span class="si">}</span><span class="s2">&#39;@g&quot;</span> <span class="nv">$BASHRC</span>
<span class="nb">source</span> <span class="nv">$HOME</span>/.bashrc

<span class="nb">echo</span> <span class="s2">&quot;0 0 * * * rm -rf </span><span class="nv">$TRASH_DIR</span><span class="s2">/*&quot;</span> &gt;&gt; <span class="nv">$CRON_FILE</span>
<span class="nb">echo</span> <span class="s2">&quot;删除目录:</span><span class="nv">$TRASH_DIR</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;删除脚本:</span><span class="nv">$CMD_SCRIPTS</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;请执行:source </span><span class="nv">$BASHRC</span><span class="s2"> 来加载文件或退出当前shell重新登录&quot;</span>
</pre></div>
</div>
</section>
<section id="linux">
<h3><a class="toc-backref" href="#id68">4 Linux系统检测</a><a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># auth:kaliarch</span>
<span class="c1"># func:sys info check</span>
<span class="c1"># version:v1.0</span>
<span class="c1"># sys:centos6.x/7.x</span>

<span class="o">[</span> <span class="k">$(</span>id -u<span class="k">)</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;请用root用户执行此脚本！&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">1</span>
<span class="nv">sysversion</span><span class="o">=</span><span class="k">$(</span>rpm -q centos-release<span class="p">|</span>cut -d- -f3<span class="k">)</span>
<span class="nv">line</span><span class="o">=</span><span class="s2">&quot;-------------------------------------------------&quot;</span>


<span class="o">[</span> -d logs <span class="o">]</span> <span class="o">||</span> mkdir logs

<span class="nv">sys_check_file</span><span class="o">=</span><span class="s2">&quot;logs/</span><span class="k">$(</span>ip a show dev eth0<span class="p">|</span>grep -w inet<span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="p">|</span>awk -F <span class="s1">&#39;/&#39;</span> <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span><span class="s2">-`date +%Y%m%d`.txt&quot;</span>

<span class="c1"># 获取系统cpu信息</span>
<span class="k">function</span> get_cpu_info<span class="o">()</span> <span class="o">{</span>
    <span class="nv">Physical_CPUs</span><span class="o">=</span><span class="k">$(</span>grep <span class="s2">&quot;physical id&quot;</span> /proc/cpuinfo<span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> wc -l<span class="k">)</span>
    <span class="nv">Virt_CPUs</span><span class="o">=</span><span class="k">$(</span>grep <span class="s2">&quot;processor&quot;</span> /proc/cpuinfo <span class="p">|</span> wc -l<span class="k">)</span>
    <span class="nv">CPU_Kernels</span><span class="o">=</span><span class="k">$(</span>grep <span class="s2">&quot;cores&quot;</span> /proc/cpuinfo<span class="p">|</span>uniq<span class="p">|</span> awk -F <span class="s1">&#39;: &#39;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
    <span class="nv">CPU_Type</span><span class="o">=</span><span class="k">$(</span>grep <span class="s2">&quot;model name&quot;</span> /proc/cpuinfo <span class="p">|</span> awk -F <span class="s1">&#39;: &#39;</span> <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> sort <span class="p">|</span> uniq<span class="k">)</span>
    <span class="nv">CPU_Arch</span><span class="o">=</span><span class="k">$(</span>uname -m<span class="k">)</span>
cat <span class="s">&lt;&lt;EOF | column -t</span>
<span class="s">CPU信息:</span>

<span class="s">物理CPU个数: $Physical_CPUs</span>
<span class="s">逻辑CPU个数: $Virt_CPUs</span>
<span class="s">每CPU核心数: $CPU_Kernels</span>
<span class="s">CPU型号: $CPU_Type</span>
<span class="s">CPU架构: $CPU_Arch</span>
<span class="s">EOF</span>
<span class="o">}</span>

<span class="c1"># 获取系统内存信息</span>
<span class="k">function</span> get_mem_info<span class="o">()</span> <span class="o">{</span>
    <span class="nv">check_mem</span><span class="o">=</span><span class="k">$(</span>free -m<span class="k">)</span>
    <span class="nv">MemTotal</span><span class="o">=</span><span class="k">$(</span>grep MemTotal /proc/meminfo<span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>  <span class="c1">#KB</span>
    <span class="nv">MemFree</span><span class="o">=</span><span class="k">$(</span>grep MemFree /proc/meminfo<span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>    <span class="c1">#KB</span>
    <span class="nb">let</span> <span class="nv">MemUsed</span><span class="o">=</span>MemTotal-MemFree
    <span class="nv">MemPercent</span><span class="o">=</span><span class="k">$(</span>awk <span class="s2">&quot;BEGIN {if(</span><span class="nv">$MemTotal</span><span class="s2">==0){printf 100}else{printf \&quot;%.2f\&quot;,</span><span class="nv">$MemUsed</span><span class="s2">*100/</span><span class="nv">$MemTotal</span><span class="s2">}}&quot;</span><span class="k">)</span>
    <span class="nv">report_MemTotal</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$((</span>MemTotal/1024<span class="k">))</span><span class="s2">&quot;&quot;MB&quot;</span>        <span class="c1">#内存总容量(MB)</span>
    <span class="nv">report_MemFree</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$((</span>MemFree/1024<span class="k">))</span><span class="s2">&quot;&quot;MB&quot;</span>          <span class="c1">#内存剩余(MB)</span>
    <span class="nv">report_MemUsedPercent</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>awk <span class="s2">&quot;BEGIN {if(</span><span class="nv">$MemTotal</span><span class="s2">==0){printf 100}else{printf \&quot;%.2f\&quot;,</span><span class="nv">$MemUsed</span><span class="s2">*100/</span><span class="nv">$MemTotal</span><span class="s2">}}&quot;</span><span class="k">)</span><span class="s2">&quot;&quot;%&quot;</span>   <span class="c1">#内存使用率%</span>

cat <span class="s">&lt;&lt;EOF</span>
<span class="s">内存信息：</span>

<span class="s">${check_mem}</span>
<span class="s">EOF</span>
<span class="o">}</span>

<span class="c1"># 获取系统网络信息</span>
<span class="k">function</span> get_net_info<span class="o">()</span> <span class="o">{</span>
    <span class="nv">pri_ipadd</span><span class="o">=</span><span class="k">$(</span>ip a show dev eth0<span class="p">|</span>grep -w inet<span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="p">|</span>awk -F <span class="s1">&#39;/&#39;</span> <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
    <span class="nv">pub_ipadd</span><span class="o">=</span><span class="k">$(</span>curl ifconfig.me -s<span class="k">)</span>
    <span class="nv">gateway</span><span class="o">=</span><span class="k">$(</span>ip route <span class="p">|</span> grep default <span class="p">|</span> awk <span class="s1">&#39;{print $3}&#39;</span><span class="k">)</span>
    <span class="nv">mac_info</span><span class="o">=</span><span class="k">$(</span>ip link<span class="p">|</span> egrep -v <span class="s2">&quot;lo&quot;</span><span class="p">|</span>grep link<span class="p">|</span>awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
    <span class="nv">dns_config</span><span class="o">=</span><span class="k">$(</span>egrep -v <span class="s2">&quot;^</span>$<span class="s2">|^#&quot;</span> /etc/resolv.conf<span class="k">)</span>
    <span class="nv">route_info</span><span class="o">=</span><span class="k">$(</span>route -n<span class="k">)</span>
cat <span class="s">&lt;&lt;EOF | column -t</span>
<span class="s">IP信息:</span>

<span class="s">系统公网地址: ${pub_ipadd}</span>
<span class="s">系统私网地址: ${pri_ipadd}</span>
<span class="s">网关地址: ${gateway}</span>
<span class="s">MAC地址: ${mac_info}</span>

<span class="s">路由信息:</span>
<span class="s">${route_info}</span>

<span class="s">DNS 信息:</span>
<span class="s">${dns_config}</span>
<span class="s">EOF</span>
<span class="o">}</span>

<span class="c1"># 获取系统磁盘信息</span>
<span class="k">function</span> get_disk_info<span class="o">()</span> <span class="o">{</span>
    <span class="nv">disk_info</span><span class="o">=</span><span class="k">$(</span>fdisk -l<span class="p">|</span>grep <span class="s2">&quot;Disk /dev&quot;</span><span class="p">|</span>cut -d, -f1<span class="k">)</span>
    <span class="nv">disk_use</span><span class="o">=</span><span class="k">$(</span>df -hTP<span class="p">|</span>awk <span class="s1">&#39;$2!=&quot;tmpfs&quot;{print}&#39;</span><span class="k">)</span>
    <span class="nv">disk_inode</span><span class="o">=</span><span class="k">$(</span>df -hiP<span class="p">|</span>awk <span class="s1">&#39;$1!=&quot;tmpfs&quot;{print}&#39;</span><span class="k">)</span>

cat <span class="s">&lt;&lt;EOF</span>
<span class="s">磁盘信息:</span>

<span class="s">${disk_info}</span>
<span class="s">磁盘使用:</span>

<span class="s">${disk_use}</span>
<span class="s">inode信息:</span>

<span class="s">${disk_inode}</span>
<span class="s">EOF</span>


<span class="o">}</span>

<span class="c1"># 获取系统信息</span>
<span class="k">function</span> get_systatus_info<span class="o">()</span> <span class="o">{</span>
    <span class="nv">sys_os</span><span class="o">=</span><span class="k">$(</span>uname -o<span class="k">)</span>
    <span class="nv">sys_release</span><span class="o">=</span><span class="k">$(</span>cat /etc/redhat-release<span class="k">)</span>
    <span class="nv">sys_kernel</span><span class="o">=</span><span class="k">$(</span>uname -r<span class="k">)</span>
    <span class="nv">sys_hostname</span><span class="o">=</span><span class="k">$(</span>hostname<span class="k">)</span>
    <span class="nv">sys_selinux</span><span class="o">=</span><span class="k">$(</span>getenforce<span class="k">)</span>
    <span class="nv">sys_lang</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$LANG</span><span class="k">)</span>
    <span class="nv">sys_lastreboot</span><span class="o">=</span><span class="k">$(</span>who -b <span class="p">|</span> awk <span class="s1">&#39;{print $3,$4}&#39;</span><span class="k">)</span>
    <span class="nv">sys_runtime</span><span class="o">=</span><span class="k">$(</span>uptime <span class="p">|</span>awk <span class="s1">&#39;{print  $3,$4}&#39;</span><span class="p">|</span>cut -d, -f1<span class="k">)</span>
    <span class="nv">sys_time</span><span class="o">=</span><span class="k">$(</span>date<span class="k">)</span>
    <span class="nv">sys_load</span><span class="o">=</span><span class="k">$(</span>uptime <span class="p">|</span>cut -d: -f5<span class="k">)</span>

cat <span class="s">&lt;&lt;EOF | column -t</span>
<span class="s">系统信息:</span>

<span class="s">系统: ${sys_os}</span>
<span class="s">发行版本:   ${sys_release}</span>
<span class="s">系统内核:   ${sys_kernel}</span>
<span class="s">主机名:    ${sys_hostname}</span>
<span class="s">selinux状态:  ${sys_selinux}</span>
<span class="s">系统语言:   ${sys_lang}</span>
<span class="s">系统当前时间: ${sys_time}</span>
<span class="s">系统最后重启时间:   ${sys_lastreboot}</span>
<span class="s">系统运行时间: ${sys_runtime}</span>
<span class="s">系统负载:   ${sys_load}</span>
<span class="s">EOF</span>
<span class="o">}</span>

<span class="c1"># 获取服务信息</span>
<span class="k">function</span> get_service_info<span class="o">()</span> <span class="o">{</span>
    <span class="nv">port_listen</span><span class="o">=</span><span class="k">$(</span>netstat -lntup<span class="p">|</span>grep -v <span class="s2">&quot;Active Internet&quot;</span><span class="k">)</span>
    <span class="nv">kernel_config</span><span class="o">=</span><span class="k">$(</span>sysctl -p <span class="m">2</span>&gt;/dev/null<span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">sysversion</span><span class="si">}</span> -gt <span class="m">6</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
        <span class="nv">service_config</span><span class="o">=</span><span class="k">$(</span>systemctl list-unit-files --type<span class="o">=</span>service --state<span class="o">=</span>enabled<span class="p">|</span>grep <span class="s2">&quot;enabled&quot;</span><span class="k">)</span>
        <span class="nv">run_service</span><span class="o">=</span><span class="k">$(</span>systemctl list-units --type<span class="o">=</span>service --state<span class="o">=</span>running <span class="p">|</span>grep <span class="s2">&quot;.service&quot;</span><span class="k">)</span>
    <span class="k">else</span>
        <span class="nv">service_config</span><span class="o">=</span><span class="k">$(</span>/sbin/chkconfig <span class="p">|</span> grep -E <span class="s2">&quot;:on|:启用&quot;</span> <span class="p">|</span>column -t<span class="k">)</span>
        <span class="nv">run_service</span><span class="o">=</span><span class="k">$(</span>/sbin/service --status-all<span class="p">|</span>grep -E <span class="s2">&quot;running&quot;</span><span class="k">)</span>
    <span class="k">fi</span>
cat <span class="s">&lt;&lt;EOF</span>
<span class="s">服务启动配置:</span>

<span class="s">${service_config}</span>
<span class="s">${line}</span>
<span class="s">运行的服务:</span>

<span class="s">${run_service}</span>
<span class="s">${line}</span>
<span class="s">监听端口:</span>

<span class="s">${port_listen}</span>
<span class="s">${line}</span>
<span class="s">内核参考配置:</span>

<span class="s">${kernel_config}</span>
<span class="s">EOF</span>
<span class="o">}</span>


<span class="k">function</span> get_sys_user<span class="o">()</span> <span class="o">{</span>
    <span class="nv">login_user</span><span class="o">=</span><span class="k">$(</span>awk -F: <span class="s1">&#39;{if ($NF==&quot;/bin/bash&quot;) print $0}&#39;</span> /etc/passwd<span class="k">)</span>
    <span class="nv">ssh_config</span><span class="o">=</span><span class="k">$(</span>egrep -v <span class="s2">&quot;^#|^</span>$<span class="s2">&quot;</span> /etc/ssh/sshd_config<span class="k">)</span>
    <span class="nv">sudo_config</span><span class="o">=</span><span class="k">$(</span>egrep -v <span class="s2">&quot;^#|^</span>$<span class="s2">&quot;</span> /etc/sudoers <span class="p">|</span>grep -v <span class="s2">&quot;^Defaults&quot;</span><span class="k">)</span>
    <span class="nv">host_config</span><span class="o">=</span><span class="k">$(</span>egrep -v <span class="s2">&quot;^#|^</span>$<span class="s2">&quot;</span> /etc/hosts<span class="k">)</span>
    <span class="nv">crond_config</span><span class="o">=</span><span class="k">$(for</span> cronuser <span class="k">in</span> /var/spool/cron/* <span class="p">;</span><span class="k">do</span> ls <span class="si">${</span><span class="nv">cronuser</span><span class="si">}</span> <span class="m">2</span>&gt;/dev/null<span class="p">|</span>cut -d/ -f5<span class="p">;</span>egrep -v <span class="s2">&quot;^</span>$<span class="s2">|^#&quot;</span> <span class="si">${</span><span class="nv">cronuser</span><span class="si">}</span> <span class="m">2</span>&gt;/dev/null<span class="p">;</span><span class="nb">echo</span> <span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">done)</span>
cat <span class="s">&lt;&lt;EOF</span>
<span class="s">系统登录用户:</span>

<span class="s">${login_user}</span>
<span class="s">${line}</span>
<span class="s">ssh 配置信息:</span>

<span class="s">${ssh_config}</span>
<span class="s">${line}</span>
<span class="s">sudo 配置用户:</span>

<span class="s">${sudo_config}</span>
<span class="s">${line}</span>
<span class="s">定时任务配置:</span>

<span class="s">${crond_config}</span>
<span class="s">${line}</span>
<span class="s">hosts 信息:</span>

<span class="s">${host_config}</span>
<span class="s">EOF</span>
<span class="o">}</span>


<span class="k">function</span> process_top_info<span class="o">()</span> <span class="o">{</span>

    <span class="nv">top_title</span><span class="o">=</span><span class="k">$(</span>top -b n1<span class="p">|</span>head -7<span class="p">|</span>tail -1<span class="k">)</span>
    <span class="nv">cpu_top10</span><span class="o">=</span><span class="k">$(</span>top b -n1 <span class="p">|</span> head -17 <span class="p">|</span> tail -10<span class="k">)</span>
    <span class="nv">mem_top10</span><span class="o">=</span><span class="k">$(</span>top -b n1<span class="p">|</span>head -17<span class="p">|</span>tail -10<span class="p">|</span>sort -k10 -r<span class="k">)</span>

cat <span class="s">&lt;&lt;EOF</span>
<span class="s">CPU占用top10:</span>

<span class="s">${top_title}</span>
<span class="s">${cpu_top10}</span>

<span class="s">内存占用top10:</span>

<span class="s">${top_title}</span>
<span class="s">${mem_top10}</span>
<span class="s">EOF</span>
<span class="o">}</span>


<span class="k">function</span> sys_check<span class="o">()</span> <span class="o">{</span>
    get_cpu_info
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">line</span><span class="si">}</span>
    get_mem_info
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">line</span><span class="si">}</span>
    get_net_info
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">line</span><span class="si">}</span>
    get_disk_info
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">line</span><span class="si">}</span>
    get_systatus_info
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">line</span><span class="si">}</span>
    get_service_info
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">line</span><span class="si">}</span>
    get_sys_user
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">line</span><span class="si">}</span>
    process_top_info
<span class="o">}</span>


sys_check &gt; <span class="si">${</span><span class="nv">sys_check_file</span><span class="si">}</span>
</pre></div>
</div>
</section>
<section id="lnmp">
<h3><a class="toc-backref" href="#id69">5 自动化安装lnmp，安装提示菜单</a><a class="headerlink" href="#lnmp" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/sh
# @Author: hujianli
# @Date:   2018-11-15 16:39:51
# @Last Modified by:   hujianli
# @Last Modified time: 2018-11-15 16:59:47
Hu_File=httpd-2.0.1.tar.gz
Hu_File_dir=http-2.0.1
Hu_Mysql=mysql-2.0.1.tar.gz
Hu_Mysql_Dir=mysql-2.0.1
Hu_Url=http://mirrors.cnnic.cn/apache/httpd
Hu_http_PREFIX=/usr/local/apache/
Hu_mysql_PREFIX=/usr/local/mysql
Php_FILE=php-5.3.28.tar.bz2
Php_FIle_dir=php-5.3.28
P_URL=http://mirrors.cnnic/php/
Php_PREFIX=/usr/local/php/
echo -e &quot;\033[32m-----------------------------------------\033[0m&quot;
echo
if [[ -z &quot;$1&quot; ]]; then
    echo -e &quot;\033[36mPlease Select Install Menu follow: \033[0m &quot;
    echo -e &quot;\033[32m1) 编译安装apache服务器 \033[1m&quot;
    echo -e &quot;2) 编译安装mysql服务器&quot;
    echo -e &quot;3) 编译安装 PHP 服务器&quot;
    echo -e &quot;4) 配置php服务，并启动LNMP服务&quot;
    echo
    echo -e &quot;\033[32m-----------------------------------------\033[0m&quot;
    echo -e &quot;\033[31mUsage: [/bin/sh $0 1|2|3|4|help \033[0m]&quot;
    echo -e &quot;\033[32m-----------------------------------------\033[0m&quot;
    exit
fi

if [[ &quot;$1&quot; -eq &quot;--help&quot; ]]; then
cat &lt;&lt;EOF
    1) 编译安装apache服务器
    2) 编译安装mysql服务器
    3) 编译安装 PHP 服务器
    4) 配置php服务，并启动LNMP服务
EOF

fi
</pre></div>
</div>
</section>
<section id="id27">
<h3><a class="toc-backref" href="#id70">6 选择菜单 2</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/sh
# @Author: hujianli
# @Date:   2018-11-15 15:49:22
# @Last Modified by:   hujianli
# @Last Modified time: 2018-11-15 16:31:16
echo -e &quot;\033[32m --------------------------\033[0m&quot;
File=http-2.2.3.tar.bz2
URL=http://mirrors.cnnic.cn/apache/httpd
PREFIX=/usr/local/apache2/

echo -e &quot;\033[32m Please Select Install Menu: \033[0m&quot;
echo
echo &quot;1)下载apache安装包&quot;
echo &quot;2)解压apache安装包&quot;
echo &quot;3)编译apache安装包&quot;
echo &quot;4)启动httpd服务&quot;

echo -e &quot;\033[32m --------------------------\033[0m&quot;
read -p &quot;Please input you choice: &quot; choice

case $choice in
    1 )
        echo &quot;开始下载apache安装包.......&quot;
        sleep 2
        echo &#39;下载apache安装包finsh！！&#39;
        ;;
    2 )

        echo &quot;开始解压apache安装包.......&quot;
        sleep 2
        echo &#39;解压apache安装包finsh！！&#39;
        ;;
    3 )
        echo &quot;开始编译apache安装包.......&quot;
        sleep 2
        echo &#39;编译apache安装包finsh！！&#39;
        ;;
    4 )
        echo &quot;开始启动httpd服务.......&quot;
        sleep 2
        echo &#39;启动httpd服务finsh！！&#39;
        ;;
    * )
        echo &quot;输入错误！&quot;
        ;;
esac
</pre></div>
</div>
</section>
<section id="id28">
<h3><a class="toc-backref" href="#id71">7 启动脚本示例</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#?$Id:?gmond.init?180?2003-03-07?20:38:36Z?sacerdoti $</span>
<span class="c1"># chkconfig:?2345?70?40</span>
<span class="c1"># description:?gmond?startup?script</span>

<span class="c1">#定义变量GMOND，指定gmond守护进程路径</span>
<span class="nv">GMOND</span><span class="o">=</span>/usr/sbin/gmond

<span class="c1">#读取并执行文件 /etc/rc.d/init.d/functions的内容</span>
. /etc/rc.d/init.d/functions

<span class="c1">#定义变量RETVAL</span>
<span class="nv">RETVAL</span><span class="o">=</span><span class="m">0</span>

<span class="c1">#使用case语句来根据指定的不同参数，执行不同的行为</span>
<span class="k">case</span> <span class="nv">$1</span> <span class="k">in</span>
    start<span class="o">)</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;Starting GANGLIA gmond: &quot;</span>
    <span class="c1">#如果gmond守护进程不存在，则退出脚本的执行，退出状态码为1</span>
    <span class="o">[</span> -f <span class="nv">$GMOND</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span>
    <span class="c1">#将gmond守护进程放在后台运行，daemon是function中的函数</span>
    daemon <span class="nv">$GMOND</span>
    <span class="c1">#将上一命令的退出状态码赋值给变量RETVAL</span>
    <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">echo</span>
    <span class="c1">##若gmond守护进程成功运行，则创建一个lock文件/var/lock/subsys/gmond</span>
    <span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> touch /var/lock/subsys/gmond
   <span class="p">;;</span>
    stop<span class="o">)</span>
        <span class="c1">#显示停止ganglia gmond的信息</span>
        <span class="nb">echo</span> -n <span class="s2">&quot;Shutting down GANGLIA gmond: &quot;</span>
        <span class="c1">#停止gmond守护进程，killproc是functions中定义的函数</span>
        killproc gmond
        <span class="c1">#将上一命令的退出状态码赋值给变量RETVAL</span>
        <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
        <span class="nb">echo</span>
        <span class="c1">#若gmond守护进程成功停止，则删除lock文件 /var/lock/subsys/gmond</span>
        <span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -rf /var/lock/subsys/gmond
   <span class="p">;;</span>
    restart<span class="p">|</span>reload<span class="o">)</span>
        <span class="c1">#重新调用此脚本，命令行参数为stop</span>
        <span class="nv">$0</span> stop
        <span class="c1">#重新调用此脚本，命令行参数为start</span>
        <span class="nv">$0</span> start
        <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
   <span class="p">;;</span>
    status<span class="o">)</span>
        <span class="c1">#显示gmond守护进程的运行状态，其中status是functions 定义的函数</span>
        status gmond
        <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
   <span class="p">;;</span>
    *<span class="o">)</span>
        <span class="c1">#显示脚本的使用方法信息到标准输出</span>
        <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> {start|stop|restart|status}&quot;</span>
        <span class="c1">#退出脚本的运行，退出状态码为1</span>
        <span class="nb">exit</span> <span class="m">1</span>
   <span class="p">;;</span>
<span class="k">esac</span>

<span class="c1">#退出脚本的运行，退出状态码为变量RETVAL的值</span>
<span class="nb">exit</span> <span class="nv">$RETVAL</span>
</pre></div>
</div>
</section>
<section id="id29">
<h3><a class="toc-backref" href="#id72">8 备份24小时被修改的文件</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>

<span class="c1">#备份当前目录下所有前24小时被修改的文件为一个归档压缩包</span>
<span class="nv">BACKUPFILE</span><span class="o">=</span>back-<span class="k">$(</span>date +%m-%d-%Y<span class="k">)</span>   <span class="c1">#备份文件中嵌入日期</span>
<span class="nv">archive</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">$BACKUPFILE</span><span class="si">}</span>   <span class="c1">#如果没有在命令行上指定备份的归档文件名，默认以&quot;back-xxxx作为默认的文件名&quot;</span>

tar cvf - <span class="k">$(</span>find . -mtime -1 -type f -print<span class="k">)</span> &gt;<span class="si">${</span><span class="nv">archive</span><span class="si">}</span>.tar
gzip <span class="si">${</span><span class="nv">archive</span><span class="si">}</span>.tar
<span class="nb">echo</span> <span class="s2">&quot;Directory </span><span class="nv">$PWD</span><span class="s2"> backed up in archive file \&quot;</span><span class="nv">$archive</span><span class="s2">.tar.gz\&quot;.&quot;</span>

<span class="c1">#建议使用xagrs或者-exec</span>
find . -mtime -1 -type f -print0 <span class="p">|</span> xargs -0 tar rvf <span class="s2">&quot;</span><span class="nv">$archive</span><span class="s2">.tar&quot;</span>
find . -mitime -1 -type f -exec tar rvf <span class="s2">&quot;</span><span class="nv">$archive</span><span class="s2">.tar&quot;</span> <span class="s1">&#39;{}&#39;</span> <span class="se">\ </span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="rpmrpm">
<h3><a class="toc-backref" href="#id73">9 卸载相关的rpm包、检查rpm包的方法</a><a class="headerlink" href="#rpmrpm" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="nv">File_1</span><span class="o">=</span>unstall.txt
rpm -qa <span class="p">|</span> grep ssh &gt; <span class="nv">$File_1</span>

<span class="k">while</span> <span class="nb">read</span> -r line
<span class="k">do</span>
    rpm -e <span class="nv">$line</span>
    <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;unstall is successful!!&quot;</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span>
<span class="k">done</span> &lt; <span class="nv">$File_1</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="k">if</span> rpm -qa sysstat <span class="p">&amp;</span>&gt; /dev/null<span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;sysstat is already  install&quot;</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;sysstat is not  install&quot;</span>
<span class="k">fi</span>
</pre></div>
</div>
</section>
<section id="id30">
<h3><a class="toc-backref" href="#id74">10 检查软件状态</a><a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="nv">PORT_C</span><span class="o">=</span><span class="k">$(</span>ss -anu<span class="p">|</span> grep -c <span class="m">123</span><span class="k">)</span>
<span class="nv">PS_C</span><span class="o">=</span><span class="k">$(</span>ps -aux<span class="p">|</span> grep ntp<span class="p">|</span> grep -vc grep<span class="k">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$PORT_C</span> -eq <span class="m">0</span> -o <span class="nv">$PS_C</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Server is fail,restart !!&quot;</span>
    :
<span class="k">fi</span>
</pre></div>
</div>
</section>
<section id="color-print">
<h3><a class="toc-backref" href="#id75">11 color_print输出</a><a class="headerlink" href="#color-print" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#方法1</span>
color_printf1<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$1</span> <span class="o">==</span> <span class="s2">&quot;red&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -e <span class="s2">&quot;\033[32;40m</span><span class="nv">$2</span><span class="s2">\033[0m&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$1</span> <span class="o">==</span> <span class="s2">&quot;green&quot;</span> <span class="o">]]</span><span class="p">;</span><span class="k">then</span>
        <span class="nb">echo</span> -e <span class="s2">&quot;\033[31;40m</span><span class="nv">$2</span><span class="s2">\033[0m&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c1">#方法2</span>
color_printf2<span class="o">(){</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
    <span class="s2">&quot;red&quot;</span><span class="o">)</span>
       <span class="nb">echo</span> -e <span class="s2">&quot;\033[32;40m</span><span class="nv">$2</span><span class="s2">\033[0m&quot;</span>
       <span class="p">;;</span>
    <span class="s2">&quot;green&quot;</span><span class="o">)</span>
       <span class="nb">echo</span> -e <span class="s2">&quot;\033[31;40m</span><span class="nv">$2</span><span class="s2">\033[0m&quot;</span>
       <span class="p">;;</span>
    *<span class="o">)</span>
       <span class="nb">echo</span> -e <span class="s2">&quot;Example: color_printf2 red xxxxxx&quot;</span>
       <span class="p">;;</span>
    <span class="k">esac</span>

<span class="o">}</span>

<span class="k">function</span> echo_r <span class="o">(){</span>
    <span class="c1"># Color red: Error, Failed</span>
    <span class="o">[</span> <span class="nv">$#</span> -ne <span class="m">1</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">1</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;\033[31m</span><span class="nv">$1</span><span class="s2">\033[0m&quot;</span>
<span class="o">}</span>

<span class="k">function</span> echo_g <span class="o">(){</span>
    <span class="c1"># Color green: Success</span>
    <span class="o">[</span> <span class="nv">$#</span> -ne <span class="m">1</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">1</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;\033[32m</span><span class="nv">$1</span><span class="s2">\033[0m&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="linuxfunction">
<h3><a class="toc-backref" href="#id76">12 Linux下function函数库</a><a class="headerlink" href="#linuxfunction" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1"># -*-Shell-script-*-</span>
<span class="c1">#</span>
<span class="c1"># functions This file contains functions to be used by most or all</span>
<span class="c1">#       shell scripts in the /etc/init.d directory.</span>
<span class="c1">#</span>

:<span class="s">&lt;&lt;EOF</span>

<span class="s">checkpid():检查是否已存在pid，如果有一个存在，返回0（通过查看/proc目录）</span>

<span class="s">daemon():启动某个服务。/etc/init.d目录部分脚本的start使用到这个</span>

<span class="s">killproc():杀死某个进程。/etc/init.d目录部分脚本的stop使用到这个</span>

<span class="s">pidfileofproc():寻找某个进程的pid</span>

<span class="s">pidofproc():类似上面的，只是还查找了pidof命令</span>

<span class="s">status():返回一个服务的状态</span>

<span class="s">echo_success():打印OK</span>

<span class="s">echo_failure():打印FAILED</span>

<span class="s">echo_passed():打印PASSED</span>

<span class="s">echo_warning():打印WARNING</span>

<span class="s">success():打印OK并记录日志</span>

<span class="s">failure():打印FAILED并记录日志</span>

<span class="s">passed():打印PASSED并记录日志</span>

<span class="s">action():打印某个信息并执行给定的命令，它会根据命令执行的结果来调用 success,failure方法</span>

<span class="s">strstr():判断$1是否含有$2</span>

<span class="s">confirm():提示是否启动某个服务</span>

<span class="s">is_ignored_file():检查$1文件是否是*.bak、*.orig、*.rpmnew....等文件</span>

<span class="s">is_true()/is_false():交互式yes|no的选项</span>

<span class="s">apply_sysctl()应用sysctl设置，包括/etc/sysctl.d中的文件</span>

<span class="s">EOF</span>


<span class="nv">TEXTDOMAIN</span><span class="o">=</span>initscripts

<span class="c1"># Make sure umask is sane</span>
<span class="nb">umask</span> <span class="m">022</span>

<span class="c1"># Set up a default search path.</span>
<span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/sbin:/usr/sbin:/bin:/usr/bin&quot;</span>

<span class="c1">#导出环境变量</span>
<span class="nb">export</span> PATH


<span class="c1">#判断PPID和字符串否为空</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$PPID</span> -ne <span class="m">1</span> -a -z <span class="s2">&quot;</span><span class="nv">$SYSTEMCTL_SKIP_REDIRECT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
        <span class="o">[</span> -d /run/systemd/system <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">&quot;</span> <span class="k">in</span>
    /etc/init.d/*<span class="p">|</span>/etc/rc.d/init.d/*<span class="o">)</span>
        <span class="nv">_use_systemctl</span><span class="o">=</span><span class="m">1</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
<span class="k">fi</span>

systemctl_redirect <span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> s
    <span class="nb">local</span> <span class="nv">prog</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">##*/</span><span class="si">}</span>
    <span class="nb">local</span> <span class="nv">command</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local</span> <span class="nv">options</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$command</span><span class="s2">&quot;</span> <span class="k">in</span>
    start<span class="o">)</span>
        <span class="nv">s</span><span class="o">=</span>$<span class="s2">&quot;Starting </span><span class="nv">$prog</span><span class="s2"> (via systemctl): &quot;</span>
        <span class="p">;;</span>
    stop<span class="o">)</span>
        <span class="nv">s</span><span class="o">=</span>$<span class="s2">&quot;Stopping </span><span class="nv">$prog</span><span class="s2"> (via systemctl): &quot;</span>
        <span class="p">;;</span>
    reload<span class="p">|</span>try-reload<span class="o">)</span>
        <span class="nv">s</span><span class="o">=</span>$<span class="s2">&quot;Reloading </span><span class="nv">$prog</span><span class="s2"> configuration (via systemctl): &quot;</span>
        <span class="p">;;</span>
    restart<span class="p">|</span>try-restart<span class="p">|</span>condrestart<span class="o">)</span>
        <span class="nv">s</span><span class="o">=</span>$<span class="s2">&quot;Restarting </span><span class="nv">$prog</span><span class="s2"> (via systemctl): &quot;</span>
        <span class="p">;;</span>
    <span class="k">esac</span>

    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$SYSTEMCTL_IGNORE_DEPENDENCIES</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nv">options</span><span class="o">=</span><span class="s2">&quot;--ignore-dependencies&quot;</span>
    <span class="k">fi</span>

    <span class="k">if</span> ! systemctl show <span class="s2">&quot;</span><span class="nv">$prog</span><span class="s2">.service&quot;</span> &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="o">||</span> <span class="se">\</span>
            systemctl show -p LoadState <span class="s2">&quot;</span><span class="nv">$prog</span><span class="s2">.service&quot;</span> <span class="p">|</span> grep -q <span class="s1">&#39;not-found&#39;</span> <span class="p">;</span> <span class="k">then</span>
        action <span class="s2">$&quot;Reloading systemd: &quot;</span> /bin/systemctl daemon-reload
    <span class="k">fi</span>

    action <span class="s2">&quot;</span><span class="nv">$s</span><span class="s2">&quot;</span> /bin/systemctl <span class="nv">$options</span> <span class="nv">$command</span> <span class="s2">&quot;</span><span class="nv">$prog</span><span class="s2">.service&quot;</span>
<span class="o">}</span>

<span class="c1"># Get a sane screen width</span>
<span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">COLUMNS</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">COLUMNS</span><span class="o">=</span><span class="m">80</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CONSOLETYPE</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="k">if</span> <span class="o">[</span> -c <span class="s2">&quot;/dev/stderr&quot;</span> -a -r <span class="s2">&quot;/dev/stderr&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">CONSOLETYPE</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>/sbin/consoletype &lt; /dev/stderr <span class="m">2</span>&gt;/dev/null<span class="k">)</span><span class="s2">&quot;</span>
    <span class="k">else</span>
        <span class="nv">CONSOLETYPE</span><span class="o">=</span><span class="s2">&quot;serial&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">NOLOCALE</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LANGSH_SOURCED</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
        <span class="o">[</span> -f /etc/sysconfig/i18n -o -f /etc/locale.conf <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    . /etc/profile.d/lang.sh <span class="m">2</span>&gt;/dev/null
    <span class="c1"># avoid propagating LANGSH_SOURCED any further</span>
    <span class="nb">unset</span> LANGSH_SOURCED
<span class="k">fi</span>

<span class="c1"># Read in our configuration</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">BOOTUP</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="k">if</span> <span class="o">[</span> -f /etc/sysconfig/init <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        . /etc/sysconfig/init
    <span class="k">else</span>
        <span class="c1"># This all seem confusing? Look in /etc/sysconfig/init,</span>
        <span class="c1"># or in /usr/share/doc/initscripts-*/sysconfig.txt</span>
        <span class="nv">BOOTUP</span><span class="o">=</span>color
        <span class="nv">RES_COL</span><span class="o">=</span><span class="m">60</span>
        <span class="nv">MOVE_TO_COL</span><span class="o">=</span><span class="s2">&quot;echo -en \\033[</span><span class="si">${</span><span class="nv">RES_COL</span><span class="si">}</span><span class="s2">G&quot;</span>
        <span class="nv">SETCOLOR_SUCCESS</span><span class="o">=</span><span class="s2">&quot;echo -en \\033[1;32m&quot;</span>
        <span class="nv">SETCOLOR_FAILURE</span><span class="o">=</span><span class="s2">&quot;echo -en \\033[1;31m&quot;</span>
        <span class="nv">SETCOLOR_WARNING</span><span class="o">=</span><span class="s2">&quot;echo -en \\033[1;33m&quot;</span>
        <span class="nv">SETCOLOR_NORMAL</span><span class="o">=</span><span class="s2">&quot;echo -en \\033[0;39m&quot;</span>
        <span class="nv">LOGLEVEL</span><span class="o">=</span><span class="m">1</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$CONSOLETYPE</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;serial&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">BOOTUP</span><span class="o">=</span>serial
        <span class="nv">MOVE_TO_COL</span><span class="o">=</span>
        <span class="nv">SETCOLOR_SUCCESS</span><span class="o">=</span>
        <span class="nv">SETCOLOR_FAILURE</span><span class="o">=</span>
        <span class="nv">SETCOLOR_WARNING</span><span class="o">=</span>
        <span class="nv">SETCOLOR_NORMAL</span><span class="o">=</span>
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="c1"># Check if any of $pid (could be plural) are running</span>
checkpid<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> i

    <span class="k">for</span> i <span class="k">in</span> <span class="nv">$*</span> <span class="p">;</span> <span class="k">do</span>
        <span class="o">[</span> -d <span class="s2">&quot;/proc/</span><span class="nv">$i</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">0</span>
    <span class="k">done</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>

__kill_pids_term_kill_checkpids<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">base_stime</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">shift</span> <span class="m">1</span>
    <span class="nb">local</span> <span class="nv">pid</span><span class="o">=</span>
    <span class="nb">local</span> <span class="nv">pids</span><span class="o">=</span><span class="nv">$*</span>
    <span class="nb">local</span> <span class="nv">remaining</span><span class="o">=</span>
    <span class="nb">local</span> <span class="nv">stat</span><span class="o">=</span>
    <span class="nb">local</span> <span class="nv">stime</span><span class="o">=</span>

    <span class="k">for</span> pid <span class="k">in</span> <span class="nv">$pids</span> <span class="p">;</span> <span class="k">do</span>
        <span class="o">[</span> ! -e  <span class="s2">&quot;/proc/</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
        <span class="nb">read</span> -r line &lt; <span class="s2">&quot;/proc/</span><span class="nv">$pid</span><span class="s2">/stat&quot;</span> <span class="m">2</span>&gt; /dev/null

        <span class="nv">stat</span><span class="o">=(</span><span class="nv">$line</span><span class="o">)</span>
        <span class="nv">stime</span><span class="o">=</span><span class="si">${</span><span class="nv">stat</span><span class="p">[21]</span><span class="si">}</span>

        <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$stime</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$base_stime</span><span class="s2">&quot;</span> -lt <span class="s2">&quot;</span><span class="nv">$stime</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
        <span class="nv">remaining</span><span class="o">+=</span><span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2"> &quot;</span>
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$remaining</span><span class="s2">&quot;</span>
    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$remaining</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">1</span>

    <span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

__kill_pids_term_kill<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">try</span><span class="o">=</span><span class="m">0</span>
    <span class="nb">local</span> <span class="nv">delay</span><span class="o">=</span><span class="m">3</span><span class="p">;</span>
    <span class="nb">local</span> <span class="nv">pid</span><span class="o">=</span>
    <span class="nb">local</span> <span class="nv">stat</span><span class="o">=(</span><span class="k">$(</span>&lt; /proc/self/stat<span class="k">)</span><span class="o">)</span>
    <span class="nb">local</span> <span class="nv">base_stime</span><span class="o">=</span><span class="si">${</span><span class="nv">stat</span><span class="p">[21]</span><span class="si">}</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-d&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">delay</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>

    <span class="nb">local</span> <span class="nv">kill_list</span><span class="o">=</span><span class="nv">$*</span>

    <span class="nv">kill_list</span><span class="o">=</span><span class="k">$(</span>__kill_pids_term_kill_checkpids <span class="nv">$base_stime</span> <span class="nv">$kill_list</span><span class="k">)</span>

    <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$kill_list</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">0</span>

    <span class="nb">kill</span> -TERM <span class="nv">$kill_list</span> &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    usleep <span class="m">100000</span>

    <span class="nv">kill_list</span><span class="o">=</span><span class="k">$(</span>__kill_pids_term_kill_checkpids <span class="nv">$base_stime</span> <span class="nv">$kill_list</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$kill_list</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="k">while</span> <span class="o">[</span> <span class="nv">$try</span> -lt <span class="nv">$delay</span> <span class="o">]</span> <span class="p">;</span> <span class="k">do</span>
            sleep <span class="m">1</span>
            <span class="nv">kill_list</span><span class="o">=</span><span class="k">$(</span>__kill_pids_term_kill_checkpids <span class="nv">$base_stime</span> <span class="nv">$kill_list</span><span class="k">)</span>
            <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$kill_list</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
            <span class="nb">let</span> <span class="nv">try</span><span class="o">+=</span><span class="m">1</span>
        <span class="k">done</span>
        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$kill_list</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
            <span class="nb">kill</span> -KILL <span class="nv">$kill_list</span> &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
            usleep <span class="m">100000</span>
            <span class="nv">kill_list</span><span class="o">=</span><span class="k">$(</span>__kill_pids_term_kill_checkpids <span class="nv">$base_stime</span> <span class="nv">$kill_list</span><span class="k">)</span>
        <span class="k">fi</span>
    <span class="k">fi</span>

    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$kill_list</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">1</span>
    <span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

<span class="c1"># __proc_pids {program} [pidfile]</span>
<span class="c1"># Set $pid to pids from /var/run* for {program}.  $pid should be declared</span>
<span class="c1"># local in the caller.</span>
<span class="c1"># Returns LSB exit code for the &#39;status&#39; action.</span>
__pids_var_run<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">base</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">##*/</span><span class="si">}</span>
    <span class="nb">local</span> <span class="nv">pid_file</span><span class="o">=</span><span class="si">${</span><span class="nv">2</span><span class="k">:-</span><span class="p">/var/run/</span><span class="nv">$base</span><span class="p">.pid</span><span class="si">}</span>
    <span class="nb">local</span> <span class="nv">pid_dir</span><span class="o">=</span><span class="k">$(</span>/usr/bin/dirname <span class="nv">$pid_file</span> &gt; /dev/null<span class="k">)</span>
    <span class="nb">local</span> <span class="nv">binary</span><span class="o">=</span><span class="nv">$3</span>

    <span class="o">[</span> -d <span class="s2">&quot;</span><span class="nv">$pid_dir</span><span class="s2">&quot;</span> -a ! -r <span class="s2">&quot;</span><span class="nv">$pid_dir</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">4</span>

    <span class="nv">pid</span><span class="o">=</span>
    <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
            <span class="nb">local</span> line p

        <span class="o">[</span> ! -r <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">4</span> <span class="c1"># &quot;user had insufficient privilege&quot;</span>
        <span class="k">while</span> : <span class="p">;</span> <span class="k">do</span>
            <span class="nb">read</span> line
            <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
            <span class="k">for</span> p <span class="k">in</span> <span class="nv">$line</span> <span class="p">;</span> <span class="k">do</span>
                <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">p</span><span class="p">//[0-9]/</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> -d <span class="s2">&quot;/proc/</span><span class="nv">$p</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
                    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$binary</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
                        <span class="nb">local</span> <span class="nv">b</span><span class="o">=</span><span class="k">$(</span>readlink /proc/<span class="nv">$p</span>/exe <span class="p">|</span> sed -e <span class="s1">&#39;s/\s*(deleted)$//&#39;</span><span class="k">)</span>
                        <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$b</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$binary</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
                    <span class="k">fi</span>
                    <span class="nv">pid</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2"> </span><span class="nv">$p</span><span class="s2">&quot;</span>
                <span class="k">fi</span>
            <span class="k">done</span>
        <span class="k">done</span> &lt; <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                    <span class="k">return</span> <span class="m">0</span>
            <span class="k">fi</span>
        <span class="k">return</span> <span class="m">1</span> <span class="c1"># &quot;Program is dead and /var/run pid file exists&quot;</span>
    <span class="k">fi</span>
    <span class="k">return</span> <span class="m">3</span> <span class="c1"># &quot;Program is not running&quot;</span>
<span class="o">}</span>

<span class="c1"># Output PIDs of matching processes, found using pidof</span>
__pids_pidof<span class="o">()</span> <span class="o">{</span>
    pidof -c -m -o <span class="nv">$$</span> -o <span class="nv">$PPID</span> -o %PPID -x <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
        pidof -c -m -o <span class="nv">$$</span> -o <span class="nv">$PPID</span> -o %PPID -x <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">##*/</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>


<span class="c1"># A function to start a program.</span>
daemon<span class="o">()</span> <span class="o">{</span>
    <span class="c1"># Test syntax.</span>
    <span class="nb">local</span> <span class="nv">gotbase</span><span class="o">=</span> <span class="nv">force</span><span class="o">=</span> nicelevel corelimit
    <span class="nb">local</span> pid <span class="nv">base</span><span class="o">=</span> <span class="nv">user</span><span class="o">=</span> <span class="nv">nice</span><span class="o">=</span> <span class="nv">bg</span><span class="o">=</span> <span class="nv">pid_file</span><span class="o">=</span>
    <span class="nb">local</span> <span class="nv">cgroup</span><span class="o">=</span>
    <span class="nv">nicelevel</span><span class="o">=</span><span class="m">0</span>
    <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">##[-+]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
        <span class="k">case</span> <span class="nv">$1</span> <span class="k">in</span>
        <span class="s1">&#39;&#39;</span><span class="o">)</span>
            <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">: Usage: daemon [+/-nicelevel] {program}&quot;</span> <span class="s2">&quot;[arg1]...&quot;</span>
            <span class="k">return</span> <span class="m">1</span>
            <span class="p">;;</span>
        --check<span class="o">)</span>
            <span class="nv">base</span><span class="o">=</span><span class="nv">$2</span>
            <span class="nv">gotbase</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
            <span class="nb">shift</span> <span class="m">2</span>
            <span class="p">;;</span>
        --check<span class="o">=</span>?*<span class="o">)</span>
            <span class="nv">base</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">#--check=</span><span class="si">}</span>
            <span class="nv">gotbase</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
            <span class="nb">shift</span>
            <span class="p">;;</span>
        --user<span class="o">)</span>
            <span class="nv">user</span><span class="o">=</span><span class="nv">$2</span>
            <span class="nb">shift</span> <span class="m">2</span>
            <span class="p">;;</span>
        --user<span class="o">=</span>?*<span class="o">)</span>
            <span class="nv">user</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">#--user=</span><span class="si">}</span>
            <span class="nb">shift</span>
            <span class="p">;;</span>
        --pidfile<span class="o">)</span>
            <span class="nv">pid_file</span><span class="o">=</span><span class="nv">$2</span>
            <span class="nb">shift</span> <span class="m">2</span>
            <span class="p">;;</span>
        --pidfile<span class="o">=</span>?*<span class="o">)</span>
            <span class="nv">pid_file</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">#--pidfile=</span><span class="si">}</span>
            <span class="nb">shift</span>
            <span class="p">;;</span>
        --force<span class="o">)</span>
            <span class="nv">force</span><span class="o">=</span><span class="s2">&quot;force&quot;</span>
            <span class="nb">shift</span>
            <span class="p">;;</span>
        <span class="o">[</span>-+<span class="o">][</span><span class="m">0</span>-9<span class="o">]</span>*<span class="o">)</span>
            <span class="nv">nice</span><span class="o">=</span><span class="s2">&quot;nice -n </span><span class="nv">$1</span><span class="s2">&quot;</span>
            <span class="nb">shift</span>
            <span class="p">;;</span>
        *<span class="o">)</span>
            <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">: Usage: daemon [+/-nicelevel] {program}&quot;</span> <span class="s2">&quot;[arg1]...&quot;</span>
            <span class="k">return</span> <span class="m">1</span>
            <span class="p">;;</span>
      <span class="k">esac</span>
    <span class="k">done</span>

    <span class="c1"># Save basename.</span>
    <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$gotbase</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">base</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">##*/</span><span class="si">}</span>

    <span class="c1"># See if it&#39;s already running. Look *only* at the pid file.</span>
    __pids_var_run <span class="s2">&quot;</span><span class="nv">$base</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span>

    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> -a -z <span class="s2">&quot;</span><span class="nv">$force</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>

    <span class="c1"># make sure it doesn&#39;t core dump anywhere unless requested</span>
    <span class="nv">corelimit</span><span class="o">=</span><span class="s2">&quot;ulimit -S -c </span><span class="si">${</span><span class="nv">DAEMON_COREFILE_LIMIT</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># if they set NICELEVEL in /etc/sysconfig/foo, honor it</span>
    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">NICELEVEL</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">nice</span><span class="o">=</span><span class="s2">&quot;nice -n </span><span class="nv">$NICELEVEL</span><span class="s2">&quot;</span>

    <span class="c1"># if they set CGROUP_DAEMON in /etc/sysconfig/foo, honor it</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CGROUP_DAEMON</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> ! -x /bin/cgexec <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nb">echo</span> -n <span class="s2">&quot;Cgroups not installed&quot;</span><span class="p">;</span> warning
            <span class="nb">echo</span>
        <span class="k">else</span>
            <span class="nv">cgroup</span><span class="o">=</span><span class="s2">&quot;/bin/cgexec&quot;</span><span class="p">;</span>
            <span class="k">for</span> i <span class="k">in</span> <span class="nv">$CGROUP_DAEMON</span><span class="p">;</span> <span class="k">do</span>
                <span class="nv">cgroup</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$cgroup</span><span class="s2"> -g </span><span class="nv">$i</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="k">done</span>
        <span class="k">fi</span>
    <span class="k">fi</span>

    <span class="c1"># Echo daemon</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">BOOTUP</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;verbose&quot;</span> -a -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -n <span class="s2">&quot; </span><span class="nv">$base</span><span class="s2">&quot;</span>

    <span class="c1"># And start it up.</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$user</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
       <span class="nv">$cgroup</span> <span class="nv">$nice</span> /bin/bash -c <span class="s2">&quot;</span><span class="nv">$corelimit</span><span class="s2"> &gt;/dev/null 2&gt;&amp;1 ; </span><span class="nv">$*</span><span class="s2">&quot;</span>
    <span class="k">else</span>
       <span class="nv">$cgroup</span> <span class="nv">$nice</span> runuser -s /bin/bash <span class="nv">$user</span> -c <span class="s2">&quot;</span><span class="nv">$corelimit</span><span class="s2"> &gt;/dev/null 2&gt;&amp;1 ; </span><span class="nv">$*</span><span class="s2">&quot;</span>
    <span class="k">fi</span>

    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> success $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> startup&quot;</span> <span class="o">||</span> failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> startup&quot;</span>
<span class="o">}</span>

<span class="c1"># A function to stop a program.</span>
killproc<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> RC <span class="nv">killlevel</span><span class="o">=</span> base pid <span class="nv">pid_file</span><span class="o">=</span> delay try <span class="nv">binary</span><span class="o">=</span>

    <span class="nv">RC</span><span class="o">=</span><span class="m">0</span><span class="p">;</span> <span class="nv">delay</span><span class="o">=</span><span class="m">3</span><span class="p">;</span> <span class="nv">try</span><span class="o">=</span><span class="m">0</span>
    <span class="c1"># Test syntax.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$#</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">$&quot;Usage: killproc [-p pidfile] [ -d delay] {program} [-signal]&quot;</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-p&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">pid_file</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-b&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> -z <span class="nv">$pid_file</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nb">echo</span> <span class="s2">$&quot;-b option can be used only with -p&quot;</span>
            <span class="nb">echo</span> <span class="s2">$&quot;Usage: killproc -p pidfile -b binary program&quot;</span>
            <span class="k">return</span> <span class="m">1</span>
        <span class="k">fi</span>
        <span class="nv">binary</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-d&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">delay</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$2</span> <span class="p">|</span> awk -v <span class="nv">RS</span><span class="o">=</span><span class="s1">&#39; &#39;</span> -v <span class="nv">IGNORECASE</span><span class="o">=</span><span class="m">1</span> <span class="s1">&#39;{if($1!~/^[0-9.]+[smhd]?$/) exit 1;d=$1~/s$|^[0-9.]*$/?1:$1~/m$/?60:$1~/h$/?60*60:$1~/d$/?24*60*60:-1;if(d==-1) exit 1;delay+=d*$1} END {printf(&quot;%d&quot;,delay+0.5)}&#39;</span><span class="k">)</span>
        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nb">echo</span> <span class="s2">$&quot;Usage: killproc [-p pidfile] [ -d delay] {program} [-signal]&quot;</span>
            <span class="k">return</span> <span class="m">1</span>
        <span class="k">fi</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>


    <span class="c1"># check for second arg to be kill level</span>
    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">2</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">killlevel</span><span class="o">=</span><span class="nv">$2</span>

    <span class="c1"># Save basename.</span>
    <span class="nv">base</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">##*/</span><span class="si">}</span>

    <span class="c1"># Find pid.</span>
    __pids_var_run <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$binary</span><span class="s2">&quot;</span>
    <span class="nv">RC</span><span class="o">=</span><span class="nv">$?</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nv">pid</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>__pids_pidof <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
        <span class="k">else</span>
            <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$RC</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;4&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> shutdown&quot;</span> <span class="p">;</span> <span class="k">return</span> <span class="nv">$RC</span> <span class="p">;</span><span class="o">}</span>
        <span class="k">fi</span>
    <span class="k">fi</span>

    <span class="c1"># Kill it.</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;verbose&quot;</span> -a -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> &quot;</span>
        <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$killlevel</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
            __kill_pids_term_kill -d <span class="nv">$delay</span> <span class="nv">$pid</span>
            <span class="nv">RC</span><span class="o">=</span><span class="nv">$?</span>
            <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$RC</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> success $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> shutdown&quot;</span> <span class="o">||</span> failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> shutdown&quot;</span>
        <span class="c1"># use specified level only</span>
        <span class="k">else</span>
            <span class="k">if</span> checkpid <span class="nv">$pid</span><span class="p">;</span> <span class="k">then</span>
                <span class="nb">kill</span> <span class="nv">$killlevel</span> <span class="nv">$pid</span> &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
                <span class="nv">RC</span><span class="o">=</span><span class="nv">$?</span>
                <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$RC</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> success $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> </span><span class="nv">$killlevel</span><span class="s2">&quot;</span> <span class="o">||</span> failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> </span><span class="nv">$killlevel</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                <span class="nv">RC</span><span class="o">=</span><span class="m">7</span> <span class="c1"># Program is not running</span>
            <span class="k">fi</span>
        <span class="k">fi</span>
    <span class="k">else</span>
        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> -a -n <span class="s2">&quot;</span><span class="nv">$killlevel</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nv">RC</span><span class="o">=</span><span class="m">7</span> <span class="c1"># Program is not running</span>
        <span class="k">else</span>
            failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> shutdown&quot;</span>
            <span class="nv">RC</span><span class="o">=</span><span class="m">0</span>
        <span class="k">fi</span>
    <span class="k">fi</span>

    <span class="c1"># Remove pid file if any.</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$killlevel</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        rm -f <span class="s2">&quot;</span><span class="si">${</span><span class="nv">pid_file</span><span class="k">:-</span><span class="p">/var/run/</span><span class="nv">$base</span><span class="p">.pid</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">fi</span>
    <span class="k">return</span> <span class="nv">$RC</span>
<span class="o">}</span>

<span class="c1"># A function to find the pid of a program. Looks *only* at the pidfile</span>
pidfileofproc<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> pid

    <span class="c1"># Test syntax.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$#</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">$&quot;Usage: pidfileofproc {program}&quot;</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">fi</span>

    __pids_var_run <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$pid</span>
    <span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

<span class="c1"># A function to find the pid of a program.</span>
pidofproc<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> RC pid <span class="nv">pid_file</span><span class="o">=</span>

    <span class="c1"># Test syntax.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$#</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">$&quot;Usage: pidofproc [-p pidfile] {program}&quot;</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-p&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">pid_file</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="nv">fail_code</span><span class="o">=</span><span class="m">3</span> <span class="c1"># &quot;Program is not running&quot;</span>

    <span class="c1"># First try &quot;/var/run/*.pid&quot; files</span>
    __pids_var_run <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span>
    <span class="nv">RC</span><span class="o">=</span><span class="nv">$?</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="nv">$pid</span>
        <span class="k">return</span> <span class="m">0</span>
    <span class="k">fi</span>

    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="nv">$RC</span>
    __pids_pidof <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$RC</span>
<span class="o">}</span>

status<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> base pid <span class="nv">lock_file</span><span class="o">=</span> <span class="nv">pid_file</span><span class="o">=</span> <span class="nv">binary</span><span class="o">=</span>

    <span class="c1"># Test syntax.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$#</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">$&quot;Usage: status [-p pidfile] {program}&quot;</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-p&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">pid_file</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-l&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">lock_file</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-b&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> -z <span class="nv">$pid_file</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nb">echo</span> <span class="s2">$&quot;-b option can be used only with -p&quot;</span>
            <span class="nb">echo</span> <span class="s2">$&quot;Usage: status -p pidfile -b binary program&quot;</span>
            <span class="k">return</span> <span class="m">1</span>
        <span class="k">fi</span>
        <span class="nv">binary</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="nv">base</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">##*/</span><span class="si">}</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$_use_systemctl</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        systemctl status <span class="si">${</span><span class="nv">0</span><span class="p">##*/</span><span class="si">}</span>.service
        <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>
        <span class="c1"># LSB daemons that dies abnormally in systemd looks alive in systemd&#39;s eyes due to RemainAfterExit=yes</span>
        <span class="c1"># lets adjust the reality a little bit</span>
        <span class="k">if</span> systemctl show -p ActiveState <span class="si">${</span><span class="nv">0</span><span class="p">##*/</span><span class="si">}</span>.service <span class="p">|</span> grep -q <span class="s1">&#39;=active$&#39;</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
        systemctl show -p SubState <span class="si">${</span><span class="nv">0</span><span class="p">##*/</span><span class="si">}</span>.service <span class="p">|</span> grep -q <span class="s1">&#39;=exited$&#39;</span> <span class="p">;</span> <span class="k">then</span>
            <span class="nv">ret</span><span class="o">=</span><span class="m">3</span>
        <span class="k">fi</span>
        <span class="k">return</span> <span class="nv">$ret</span>
    <span class="k">fi</span>

    <span class="c1"># First try &quot;pidof&quot;</span>
    __pids_var_run <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$binary</span><span class="s2">&quot;</span>
    <span class="nv">RC</span><span class="o">=</span><span class="nv">$?</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> -a -z <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">pid</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>__pids_pidof <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span><span class="s2"> (pid </span><span class="nv">$pid</span><span class="s2">) is running...&quot;</span>
        <span class="k">return</span> <span class="m">0</span>
    <span class="k">fi</span>

    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$RC</span><span class="s2">&quot;</span> <span class="k">in</span>
    <span class="m">0</span><span class="o">)</span>
        <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span><span class="s2"> (pid </span><span class="nv">$pid</span><span class="s2">) is running...&quot;</span>
        <span class="k">return</span> <span class="m">0</span>
        <span class="p">;;</span>
    <span class="m">1</span><span class="o">)</span>
        <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span><span class="s2"> dead but pid file exists&quot;</span>
        <span class="k">return</span> <span class="m">1</span>
        <span class="p">;;</span>
    <span class="m">4</span><span class="o">)</span>
        <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span><span class="s2"> status unknown due to insufficient privileges.&quot;</span>
        <span class="k">return</span> <span class="m">4</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">lock_file</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">lock_file</span><span class="o">=</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span>
    <span class="k">fi</span>
    <span class="c1"># See if /var/lock/subsys/${lock_file} exists</span>
    <span class="k">if</span> <span class="o">[</span> -f /var/lock/subsys/<span class="si">${</span><span class="nv">lock_file</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span><span class="s2"> dead but subsys locked&quot;</span>
        <span class="k">return</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span><span class="s2"> is stopped&quot;</span>
    <span class="k">return</span> <span class="m">3</span>
<span class="o">}</span>

echo_success<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$MOVE_TO_COL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;[&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_SUCCESS</span>
    <span class="nb">echo</span> -n <span class="s2">$&quot;  OK  &quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_NORMAL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;]&quot;</span>
    <span class="nb">echo</span> -ne <span class="s2">&quot;\r&quot;</span>
    <span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

echo_failure<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$MOVE_TO_COL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;[&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_FAILURE</span>
    <span class="nb">echo</span> -n <span class="s2">$&quot;FAILED&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_NORMAL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;]&quot;</span>
    <span class="nb">echo</span> -ne <span class="s2">&quot;\r&quot;</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>

echo_passed<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$MOVE_TO_COL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;[&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_WARNING</span>
    <span class="nb">echo</span> -n <span class="s2">$&quot;PASSED&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_NORMAL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;]&quot;</span>
    <span class="nb">echo</span> -ne <span class="s2">&quot;\r&quot;</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>

echo_warning<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$MOVE_TO_COL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;[&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_WARNING</span>
    <span class="nb">echo</span> -n <span class="s2">$&quot;WARNING&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_NORMAL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;]&quot;</span>
    <span class="nb">echo</span> -ne <span class="s2">&quot;\r&quot;</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>

<span class="c1"># Inform the graphical boot of our current state</span>
update_boot_stage<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -x /bin/plymouth <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        /bin/plymouth --update<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
    <span class="k">fi</span>
    <span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

<span class="c1"># Log that something succeeded</span>
success<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;verbose&quot;</span> -a -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> echo_success
    <span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

<span class="c1"># Log that something failed</span>
failure<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">rc</span><span class="o">=</span><span class="nv">$?</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;verbose&quot;</span> -a -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> echo_failure
    <span class="o">[</span> -x /bin/plymouth <span class="o">]</span> <span class="o">&amp;&amp;</span> /bin/plymouth --details
    <span class="k">return</span> <span class="nv">$rc</span>
<span class="o">}</span>

<span class="c1"># Log that something passed, but may have had errors. Useful for fsck</span>
passed<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">rc</span><span class="o">=</span><span class="nv">$?</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;verbose&quot;</span> -a -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> echo_passed
    <span class="k">return</span> <span class="nv">$rc</span>
<span class="o">}</span>

<span class="c1"># Log a warning</span>
warning<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">rc</span><span class="o">=</span><span class="nv">$?</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;verbose&quot;</span> -a -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> echo_warning
    <span class="k">return</span> <span class="nv">$rc</span>
<span class="o">}</span>

<span class="c1"># Run some action. Log its output.</span>
action<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> STRING rc

    <span class="nv">STRING</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$STRING</span><span class="s2"> &quot;</span>
    <span class="nb">shift</span>
    <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> success $<span class="s2">&quot;</span><span class="nv">$STRING</span><span class="s2">&quot;</span> <span class="o">||</span> failure $<span class="s2">&quot;</span><span class="nv">$STRING</span><span class="s2">&quot;</span>
    <span class="nv">rc</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">echo</span>
    <span class="k">return</span> <span class="nv">$rc</span>
<span class="o">}</span>

<span class="c1"># returns OK if $1 contains $2</span>
strstr<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">#*</span><span class="nv">$2</span><span class="p">*</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">1</span>
    <span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

<span class="c1"># Check whether file $1 is a backup or rpm-generated file and should be ignored</span>
is_ignored_file<span class="o">()</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
    *~ <span class="p">|</span> *.bak <span class="p">|</span> *.orig <span class="p">|</span> *.rpmnew <span class="p">|</span> *.rpmorig <span class="p">|</span> *.rpmsave<span class="o">)</span>
        <span class="k">return</span> <span class="m">0</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>

<span class="c1"># Evaluate shvar-style booleans</span>
is_true<span class="o">()</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
    <span class="o">[</span>tT<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>yY<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>yY<span class="o">][</span>eE<span class="o">][</span>sS<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>tT<span class="o">][</span>rR<span class="o">][</span>uU<span class="o">][</span>eE<span class="o">]</span> <span class="p">|</span> <span class="m">1</span><span class="o">)</span>
        <span class="k">return</span> <span class="m">0</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>

<span class="c1"># Evaluate shvar-style booleans</span>
is_false<span class="o">()</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
    <span class="o">[</span>fF<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>nN<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>nN<span class="o">][</span>oO<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>fF<span class="o">][</span>aA<span class="o">][</span>lL<span class="o">][</span>sS<span class="o">][</span>eE<span class="o">]</span> <span class="p">|</span> <span class="m">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="m">0</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>

<span class="c1"># Apply sysctl settings, including files in /etc/sysctl.d</span>
apply_sysctl<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -x /lib/systemd/systemd-sysctl <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    /lib/systemd/systemd-sysctl
    <span class="k">else</span>
        <span class="k">for</span> file <span class="k">in</span> /usr/lib/sysctl.d/*.conf <span class="p">;</span> <span class="k">do</span>
            is_ignored_file <span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
            <span class="o">[</span> -f /run/sysctl.d/<span class="si">${</span><span class="nv">file</span><span class="p">##*/</span><span class="si">}</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
            <span class="o">[</span> -f /etc/sysctl.d/<span class="si">${</span><span class="nv">file</span><span class="p">##*/</span><span class="si">}</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
            <span class="nb">test</span> -f <span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> sysctl -e -p <span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span> &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
        <span class="k">done</span>
        <span class="k">for</span> file <span class="k">in</span> /run/sysctl.d/*.conf <span class="p">;</span> <span class="k">do</span>
            is_ignored_file <span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
            <span class="o">[</span> -f /etc/sysctl.d/<span class="si">${</span><span class="nv">file</span><span class="p">##*/</span><span class="si">}</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
            <span class="nb">test</span> -f <span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> sysctl -e -p <span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span> &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
        <span class="k">done</span>
        <span class="k">for</span> file <span class="k">in</span> /etc/sysctl.d/*.conf <span class="p">;</span> <span class="k">do</span>
            is_ignored_file <span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
            <span class="nb">test</span> -f <span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> sysctl -e -p <span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span> &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
        <span class="k">done</span>
        sysctl -e -p /etc/sysctl.conf &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># A sed expression to filter out the files that is_ignored_file recognizes</span>
<span class="nv">__sed_discard_ignored_files</span><span class="o">=</span><span class="s1">&#39;/\(~\|\.bak\|\.orig\|\.rpmnew\|\.rpmorig\|\.rpmsave\)$/d&#39;</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$_use_systemctl</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="k">if</span>  <span class="o">[</span> <span class="s2">&quot;x</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> xstart -o <span class="se">\</span>
              <span class="s2">&quot;x</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> xstop -o <span class="se">\</span>
              <span class="s2">&quot;x</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> xrestart -o <span class="se">\</span>
              <span class="s2">&quot;x</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> xreload -o <span class="se">\</span>
              <span class="s2">&quot;x</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> xtry-restart -o <span class="se">\</span>
              <span class="s2">&quot;x</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> xforce-reload -o <span class="se">\</span>
              <span class="s2">&quot;x</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> xcondrestart <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>

        systemctl_redirect <span class="nv">$0</span> <span class="nv">$1</span>
        <span class="nb">exit</span> <span class="nv">$?</span>
    <span class="k">fi</span>
<span class="k">fi</span>

strstr <span class="s2">&quot;</span><span class="k">$(</span>cat /proc/cmdline<span class="k">)</span><span class="s2">&quot;</span> <span class="s2">&quot;rc.debug&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">set</span> -x
<span class="k">return</span> <span class="m">0</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="09.%E4%B8%89%E5%89%91%E5%AE%A2-awk.html" class="btn btn-neutral float-left" title="3.9. 9 三剑客之awk" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="11.xagrs%E4%BD%BF%E7%94%A8.html" class="btn btn-neutral float-right" title="3.11. xagrs使用" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>