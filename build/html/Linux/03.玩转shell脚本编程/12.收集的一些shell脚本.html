<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3.12. 收集的一些shell脚本 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3.13. 自动化安装zabbix" href="13.%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85zabbix%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%84%9A%E6%9C%AC.html" />
    <link rel="prev" title="3.11. xagrs使用" href="11.xagrs%E4%BD%BF%E7%94%A8.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> 小健_Linux-shell-Devops_Blog
            <img src="../../_static/devops_photo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../DevOps/index.html">DevOps和自动化运维实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Github/index.html">Github入门到实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Jenkins/index.html">Jenkins持续化集成</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../KVM/index.html">KVM实践</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01.%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%92%8C%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/index.html">1. 命令行和操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02.Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%B6%E8%AE%BE/index.html">2. Linux服务器架设</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">3. 玩转shell脚本编程</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="01.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html">3.1. 1 基础知识</a></li>
<li class="toctree-l3"><a class="reference internal" href="02.%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8E%E6%95%B0%E7%BB%84.html">3.2. 2 字符串与数组</a></li>
<li class="toctree-l3"><a class="reference internal" href="03.%E8%BF%90%E7%AE%97%E7%AC%A6.html">3.3. 3 运算符</a></li>
<li class="toctree-l3"><a class="reference internal" href="04.%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6.html">3.4. 4 流程控制</a></li>
<li class="toctree-l3"><a class="reference internal" href="05.%E5%87%BD%E6%95%B0.html">3.5. 5 函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="06.%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F.html">3.6. 6 正则表达式</a></li>
<li class="toctree-l3"><a class="reference internal" href="07.%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep.html">3.7. 7 三剑客之grep</a></li>
<li class="toctree-l3"><a class="reference internal" href="08.%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed.html">3.8. 8 三剑客之sed</a></li>
<li class="toctree-l3"><a class="reference internal" href="09.%E4%B8%89%E5%89%91%E5%AE%A2-awk.html">3.9. 9 三剑客之awk</a></li>
<li class="toctree-l3"><a class="reference internal" href="10.shell%E6%8A%80%E5%B7%A7%E4%B8%8E%E6%9D%82%E9%A1%B9.html">3.10. shell技巧与杂项</a></li>
<li class="toctree-l3"><a class="reference internal" href="11.xagrs%E4%BD%BF%E7%94%A8.html">3.11. xagrs使用</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">3.12. 收集的一些shell脚本</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">3.12.1. 监控服务器主要性能参数指标</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sshd">3.12.2. 修改SSHD配置文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dhcp">3.12.3. 一键安装部署DHCP服务</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vsftpd">3.12.4. 自动部署配置vsftpd服务器</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mysql">3.12.5. 使用脚本操作MySQL数据库</a></li>
<li class="toctree-l4"><a class="reference internal" href="#system-opt">3.12.6. system_opt系统优化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#centos61">3.12.7. Centos6最小化安装后优化1</a></li>
<li class="toctree-l4"><a class="reference internal" href="#centos62">3.12.8. Centos6最小化安装后优化2</a></li>
<li class="toctree-l4"><a class="reference internal" href="#centos7">3.12.9. Centos7安装后优化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">3.12.10. 备份数据库脚本</a></li>
<li class="toctree-l4"><a class="reference internal" href="#s3">3.12.11. 备份数据库上传到S3存储库</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-py">3.12.12. 控制进程数执行run.py脚本</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">3.12.13. 转换数据库表存储引擎</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">3.12.14. 监控网站状态脚本</a></li>
<li class="toctree-l4"><a class="reference internal" href="#httpd">3.12.15. 监控httpd服务状态脚本</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nginx-stop-keepalived">3.12.16. 监控Nginx进程，如果尝试启动失败就stop Keepalived</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">3.12.17. 进程控制示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lnmp">3.12.18. lnmp一键安装示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">3.12.19. 服务器初始化脚本示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">3.12.20. 服务启动脚本示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">3.12.21. 监控mysql数据库示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tar-var-log">3.12.22. 每周五使用tar命令备份/var/log下的所有日志文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">3.12.23. 一些常用的函数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">3.12.24. 检查监控内存、硬盘</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">3.12.25. 猜随机数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ip">3.12.26. 检查网段内存活的主机IP信息</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">3.12.27. 进度条</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nginx">3.12.28. nginx启动脚本</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test">3.12.29. 3种test的写法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#case-color">3.12.30. case+color用法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#io">3.12.31. 监控磁盘IO脚本</a></li>
<li class="toctree-l4"><a class="reference internal" href="#color-print">3.12.32. color_print</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">3.12.33. 网页检测</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">3.12.34. 函数检查服务</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">3.12.35. 编写脚本抓取单个网页中的图片数据</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="13.%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85zabbix%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%84%9A%E6%9C%AC.html">3.13. 自动化安装zabbix</a></li>
<li class="toctree-l3"><a class="reference internal" href="14.%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AE%89%E8%A3%85cacti%E8%84%9A%E6%9C%AC.html">3.14. 自动化安装cacti服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="15.%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85MongoDB%E8%84%9A%E6%9C%AC.html">3.15. 自动化安装MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="16.%E5%A4%87%E4%BB%BDMongoDB%E8%84%9A%E6%9C%AC.html">3.16. 备份MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="17.%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85memcached%E8%84%9A%E6%9C%AC.html">3.17. 自动安装memcached</a></li>
<li class="toctree-l3"><a class="reference internal" href="18.system%E6%A3%80%E6%B5%8B%E8%84%9A%E6%9C%AC.html">3.18. 系统各项内容检测check_os</a></li>
<li class="toctree-l3"><a class="reference internal" href="19.%E5%AE%89%E8%A3%85tomcat%E8%84%9A%E6%9C%AC.html">3.19. 安装tomcat脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="20.install_zookeeper%E8%84%9A%E6%9C%AC.html">3.20. install_zookeeper脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="21.install_elasticserch%E8%84%9A%E6%9C%AC.html">3.21. install_elasticserch脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="22.%E8%87%AA%E5%8A%A8Autoinstall_ELK_V1.3.html">3.22. 自动Autoinstall_ELK_V1.3脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="23.install_vsftpd%E8%84%9A%E6%9C%AC.html">3.23. install_vsftpd_or_nfs脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="24.install_mysql5.7.html">3.24. install_mysql5.7</a></li>
<li class="toctree-l3"><a class="reference internal" href="25.Linux%E4%B8%8B%E4%BB%A5%E7%A7%92%E4%B8%BA%E5%8D%95%E4%BD%8D%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC.html">3.25. Linux下以秒为单位执行脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="26.%E5%A4%87%E4%BB%BD%E6%96%87%E4%BB%B6shell%E8%84%9A%E6%9C%AC.html">3.26. 备份文件shell脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="27.monitor_Linux%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD.html">3.27. monitor_Linux系统性能</a></li>
<li class="toctree-l3"><a class="reference internal" href="28.%E4%BF%AE%E6%94%B9IP_%E4%B8%BB%E6%9C%BA%E5%90%8D_%E7%BD%91%E5%8D%A1%E4%BF%A1%E6%81%AF%E8%84%9A%E6%9C%AC.html">3.28. 修改IP_主机名_网卡信息脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="29.%E6%A3%80%E6%9F%A5%E6%81%B6%E6%84%8FIP%E7%99%BB%E5%BD%95%EF%BC%8C%E6%8B%92%E7%BB%9DSSH.html">3.29. 检查恶意IP登录，拒绝SSH</a></li>
<li class="toctree-l3"><a class="reference internal" href="30.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD.html">3.30. 数据库备份</a></li>
<li class="toctree-l3"><a class="reference internal" href="31.Centos6%E5%BC%80%E6%9C%BA%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html">3.31. Centos6x开机性能优化</a></li>
<li class="toctree-l3"><a class="reference internal" href="32.%E7%99%BE%E5%AE%9D%E7%AE%B1%E8%84%9A%E6%9C%AC.html">3.32. 百宝箱脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="33.deploy_mongo.html">3.33. 使用python脚本安装MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="34.python%E5%AE%9E%E7%8E%B0%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F.html">3.34. python实现端口扫描</a></li>
<li class="toctree-l3"><a class="reference internal" href="35.python%E6%A3%80%E6%B5%8Bip%E5%AD%98%E6%B4%BB%E7%8A%B6%E6%80%81.html">3.35. python检测ip存活状态</a></li>
<li class="toctree-l3"><a class="reference internal" href="36.k8s_deploy%E8%84%9A%E6%9C%AC.html">3.36. k8s_deploy脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="37.example%28%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%29.html">3.37. example(字符串处理)</a></li>
<li class="toctree-l3"><a class="reference internal" href="38.%E7%94%A8Python%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BDMongodb%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%B9%B6%E4%B8%8A%E4%BC%A0%E5%88%B0FTP%E6%9C%8D%E5%8A%A1%E5%99%A8.html">3.38. 用Python实现定时备份Mongodb数据，并上传到FTP服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="39.Nginx%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2%E8%84%9A%E6%9C%AC.html">3.39. Nginx日志切割脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="40.%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85Docker%E8%84%9A%E6%9C%AC.html">3.40. 一键安装docker脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="41.shell%E5%AE%9E%E7%8E%B0%E5%A4%9A%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E8%84%9A%E6%9C%AC.html">3.41. shell实现多并发控制</a></li>
<li class="toctree-l3"><a class="reference internal" href="42.%E5%88%A4%E6%96%AD%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B.html">3.42. 判断文件类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="43.%E7%94%A8if%E8%AF%AD%E5%8F%A5%E7%BC%96%E5%86%99%E9%80%89%E6%8B%A9%E8%8F%9C%E5%8D%95.html">3.43. 用if语句编写选择菜单</a></li>
<li class="toctree-l3"><a class="reference internal" href="44.%E4%BD%BF%E7%94%A8while%E8%AF%AD%E5%8F%A5%E7%BC%96%E5%86%99%E9%80%89%E6%8B%A9%E8%8F%9C%E5%8D%95.html">3.44. 使用while语句编写选择菜单</a></li>
<li class="toctree-l3"><a class="reference internal" href="45.%E4%BD%BF%E7%94%A8until%E7%BC%96%E5%86%99%E9%80%89%E6%8B%A9%E8%8F%9C%E5%8D%95.html">3.45. 使用until编写选择菜单</a></li>
<li class="toctree-l3"><a class="reference internal" href="46.%E7%9B%AE%E5%BD%95%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD.html">3.46. 目录定时备份</a></li>
<li class="toctree-l3"><a class="reference internal" href="47.%E8%BF%9C%E7%A8%8B%E6%93%8D%E4%BD%9Cftp%E8%BF%9B%E8%A1%8C%E4%B8%8A%E4%BC%A0%E5%92%8C%E4%B8%8B%E8%BD%BD.html">3.47. 远程操作ftp进行上传和下载</a></li>
<li class="toctree-l3"><a class="reference internal" href="48.%E6%89%B9%E9%87%8F%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E8%84%9A%E6%9C%AC.html">3.48. 批量创建用户脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="49.Centos%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8%E7%89%88%E6%9C%AC%28%E9%99%84%E5%B8%A6%E5%8D%87%E7%BA%A7%E8%84%9A%E6%9C%AC%29.html">3.49. Centos升级内核版本(附带升级脚本)</a></li>
<li class="toctree-l3"><a class="reference internal" href="50.CPU%E7%9B%91%E6%8E%A7%E8%84%9A%E6%9C%AC.html">3.50. CPU监控脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="51.%E6%A3%80%E6%B5%8B%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E6%98%AF%E5%90%A6%E8%B6%85%E6%97%B6.html">3.51. 检测函数执行是否超时</a></li>
<li class="toctree-l3"><a class="reference internal" href="52.%E8%80%81%E7%94%B7%E5%AD%A9Shell%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98.html">3.52. 老男孩Shell编程实战</a></li>
<li class="toctree-l3"><a class="reference internal" href="53.%E5%BF%AB%E6%8D%B7%E5%AE%89%E8%A3%85%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%ACPython.html">3.53. 快捷安装不同版本Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="54.%E5%B8%B8%E7%94%A8shell%E8%84%9A%E6%9C%AC%E5%A4%A7%E5%85%A8.html">3.54. 常用shell脚本大全</a></li>
<li class="toctree-l3"><a class="reference internal" href="55.%E7%BC%96%E5%86%99Shell%E8%84%9A%E6%9C%AC%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html">3.55. 编写Shell脚本的最佳实践</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../04.%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%88mysql%E3%80%81Redis%EF%BC%89/index.html">4. 玩转数据库(mysql、Redis)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05.Nginx%E5%AD%A6%E4%B9%A0/index.html">5. Nginx学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06.LAMP%E3%80%81LNMP%E5%AD%A6%E4%B9%A0/index.html">6. LNMP、LAMP学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07.Zabbix%E7%9B%91%E6%8E%A7%E4%BC%81%E4%B8%9A%E5%AE%9E%E6%88%98/index.html">7. Zabbix监控企业实战</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08.Linux%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84/index.html">8. 构建Linux高可用架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09.Zabbix3.0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/index.html">9. Zabbix3.0入门到精通</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10.%E5%BF%AB%E9%80%9F%E9%98%85%E8%AF%BBLinux%E5%85%A5%E9%97%A8-%E9%98%BF%E9%93%ADLinux/index.html">10. 快速阅读Linux入门-阿铭Linux</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Mysql/index.html">Mysql王者之路</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/index.html">Other</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Network_route_switch/index.html">Network_route_switch</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">小健_Linux-shell-Devops_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Linux</a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">3. </span>玩转shell脚本编程</a> &raquo;</li>
      <li><span class="section-number">3.12. </span>收集的一些shell脚本</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Linux/03.玩转shell脚本编程/12.收集的一些shell脚本.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#shell" id="id18">收集的一些shell脚本</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id19">监控服务器主要性能参数指标</a></p></li>
<li><p><a class="reference internal" href="#sshd" id="id20">修改SSHD配置文件</a></p></li>
<li><p><a class="reference internal" href="#dhcp" id="id21">一键安装部署DHCP服务</a></p></li>
<li><p><a class="reference internal" href="#vsftpd" id="id22">自动部署配置vsftpd服务器</a></p></li>
<li><p><a class="reference internal" href="#mysql" id="id23">使用脚本操作MySQL数据库</a></p></li>
<li><p><a class="reference internal" href="#system-opt" id="id24">system_opt系统优化</a></p></li>
<li><p><a class="reference internal" href="#centos61" id="id25">Centos6最小化安装后优化1</a></p></li>
<li><p><a class="reference internal" href="#centos62" id="id26">Centos6最小化安装后优化2</a></p></li>
<li><p><a class="reference internal" href="#centos7" id="id27">Centos7安装后优化</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id28">备份数据库脚本</a></p></li>
<li><p><a class="reference internal" href="#s3" id="id29">备份数据库上传到S3存储库</a></p></li>
<li><p><a class="reference internal" href="#run-py" id="id30">控制进程数执行run.py脚本</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id31">转换数据库表存储引擎</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id32">监控网站状态脚本</a></p></li>
<li><p><a class="reference internal" href="#httpd" id="id33">监控httpd服务状态脚本</a></p></li>
<li><p><a class="reference internal" href="#nginx-stop-keepalived" id="id34">监控Nginx进程，如果尝试启动失败就stop Keepalived</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id35">进程控制示例</a></p></li>
<li><p><a class="reference internal" href="#lnmp" id="id36">lnmp一键安装示例</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id37">服务器初始化脚本示例</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id38">服务启动脚本示例</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id39">监控mysql数据库示例</a></p></li>
<li><p><a class="reference internal" href="#tar-var-log" id="id40">每周五使用tar命令备份/var/log下的所有日志文件</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id41">一些常用的函数</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id42">检查监控内存、硬盘</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id43">猜随机数</a></p></li>
<li><p><a class="reference internal" href="#ip" id="id44">检查网段内存活的主机IP信息</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id45">进度条</a></p></li>
<li><p><a class="reference internal" href="#nginx" id="id46">nginx启动脚本</a></p></li>
<li><p><a class="reference internal" href="#test" id="id47">3种test的写法</a></p></li>
<li><p><a class="reference internal" href="#case-color" id="id48">case+color用法</a></p></li>
<li><p><a class="reference internal" href="#io" id="id49">监控磁盘IO脚本</a></p></li>
<li><p><a class="reference internal" href="#color-print" id="id50">color_print</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id51">网页检测</a></p>
<ul>
<li><p><a class="reference internal" href="#id14" id="id52">检测网页状态发送邮件</a></p></li>
<li><p><a class="reference internal" href="#id15" id="id53">检测网页状态是否变化</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id16" id="id54">函数检查服务</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id55">编写脚本抓取单个网页中的图片数据</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="shell">
<h1><a class="toc-backref" href="#id18"><span class="section-number">3.12. </span>收集的一些shell脚本</a><a class="headerlink" href="#shell" title="Permalink to this headline">¶</a></h1>
<section id="id1">
<h2><a class="toc-backref" href="#id19"><span class="section-number">3.12.1. </span>监控服务器主要性能参数指标</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description):监控服务器主要性能参数指标.</span>
<span class="c1">#监控项目:内核信息,主机名称,IP地址,登陆账户,内存与swap信息,磁盘信息,CPU负载.</span>

<span class="nv">kernel</span><span class="o">=</span><span class="k">$(</span>uname -r<span class="k">)</span>                                         <span class="c1">#内核信息</span>
<span class="nv">release</span><span class="o">=</span><span class="k">$(</span>cat /etc/redhat-release<span class="k">)</span>                         <span class="c1">#操作系统版本</span>
<span class="nv">hostname</span><span class="o">=</span><span class="nv">$HOSTNAME</span>                                         <span class="c1">#主机名称</span>
<span class="nv">localip</span><span class="o">=</span><span class="k">$(</span>ip a s <span class="p">|</span> awk <span class="s1">&#39;/inet /{print $2}&#39;</span><span class="k">)</span>                <span class="c1">#本地IP地址列表</span>
<span class="nv">mem_total</span><span class="o">=</span><span class="k">$(</span>free <span class="p">|</span> awk <span class="s1">&#39;/Mem/{print $2}&#39;</span><span class="k">)</span>                  <span class="c1">#总内存容量</span>
<span class="nv">mem_free</span><span class="o">=</span><span class="k">$(</span>free <span class="p">|</span> awk <span class="s1">&#39;/Mem/{print $NF}&#39;</span><span class="k">)</span>                  <span class="c1">#剩余内存容量</span>
<span class="nv">swap_total</span><span class="o">=</span><span class="k">$(</span>free <span class="p">|</span> awk <span class="s1">&#39;/Swap/{print $2}&#39;</span><span class="k">)</span>                <span class="c1">#总swap容量</span>
<span class="nv">swap_free</span><span class="o">=</span><span class="k">$(</span>free <span class="p">|</span> awk <span class="s1">&#39;/Swap/{print $NF}&#39;</span><span class="k">)</span>                <span class="c1">#剩余swap容量</span>
<span class="nv">disk</span><span class="o">=</span><span class="k">$(</span>df <span class="p">|</span> awk <span class="s1">&#39;/^\/dev/{print $1,$2,$4}&#39;</span><span class="p">|</span>column -t<span class="k">)</span>      <span class="c1">#磁盘信息</span>
<span class="nv">load1</span><span class="o">=</span><span class="k">$(</span>uptime <span class="p">|</span> sed <span class="s1">&#39;s/,//g&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $(NF-2)}&#39;</span><span class="k">)</span>     <span class="c1">#CPU最近1分钟平均负载</span>
<span class="nv">load5</span><span class="o">=</span><span class="k">$(</span>uptime <span class="p">|</span> sed <span class="s1">&#39;s/,//g&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $(NF-1)}&#39;</span><span class="k">)</span>     <span class="c1">#CPU最近5分钟平均负载</span>
<span class="nv">load15</span><span class="o">=</span><span class="k">$(</span>uptime <span class="p">|</span> sed <span class="s1">&#39;s/,//g&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $NF}&#39;</span><span class="k">)</span>        <span class="c1">#CPU最近15分钟平均负载</span>
<span class="nv">login_users</span><span class="o">=</span><span class="k">$(</span>who <span class="p">|</span> wc -l<span class="k">)</span>                                 <span class="c1">#登陆用户数量</span>
<span class="nv">procs</span><span class="o">=</span><span class="k">$(</span>ps aux <span class="p">|</span> wc -l<span class="k">)</span>                                    <span class="c1">#进程数量</span>
<span class="nv">users</span><span class="o">=</span><span class="k">$(</span>sed -n <span class="s1">&#39;$=&#39;</span> /etc/passwd<span class="k">)</span>                           <span class="c1">#系统总账户数量</span>
<span class="nv">cpu_info</span><span class="o">=</span><span class="k">$(</span><span class="nv">LANG</span><span class="o">=</span>C lscpu <span class="p">|</span> awk -F: <span class="s1">&#39;/Model name/ {print $2}&#39;</span><span class="k">)</span>         <span class="c1">#CPU型号</span>
<span class="nv">cpu_core</span><span class="o">=</span><span class="k">$(</span>awk <span class="s1">&#39;/processor/{core++} END{print core}&#39;</span> /proc/cpuinfo<span class="k">)</span>  <span class="c1">#CPU内核数量</span>

yum -y -q install sysstat <span class="p">&amp;</span>&gt;/dev/null                                <span class="c1">#安装性能监控软件</span>
<span class="nb">echo</span> -e <span class="s2">&quot;\033[34m提取磁盘性能指标,请稍后...\033[0m&quot;</span>
<span class="nv">tps</span><span class="o">=</span><span class="k">$(</span><span class="nv">LANG</span><span class="o">=</span>C sar -d -p <span class="m">1</span> <span class="m">6</span> <span class="p">|</span> awk <span class="s1">&#39;/Average/&#39;</span> <span class="p">|</span> tail -n +2 <span class="p">|</span> awk <span class="s1">&#39;{print &quot;[&quot;$2&quot;]磁盘平均IO数量:&quot;$3}&#39;</span><span class="k">)</span> <span class="p">&amp;</span>
<span class="nv">read_write</span><span class="o">=</span><span class="k">$(</span><span class="nv">LANG</span><span class="o">=</span>C sar -d -p <span class="m">1</span> <span class="m">6</span> <span class="p">|</span> awk <span class="s1">&#39;/Average/&#39;</span> <span class="p">|</span> tail -n +2 <span class="p">|</span> awk <span class="s1">&#39;{print &quot;[&quot;$2&quot;]平均每秒读写扇区量:&quot;$4,$5}&#39;</span><span class="k">)</span> <span class="p">&amp;</span>

<span class="nv">irq</span><span class="o">=</span><span class="k">$(</span>vmstat <span class="m">1</span> <span class="m">2</span> <span class="p">|</span> tail -n +4 <span class="p">|</span> awk <span class="s1">&#39;{print $11}&#39;</span><span class="k">)</span>         <span class="c1">#中断数量</span>
<span class="nv">cs</span><span class="o">=</span><span class="k">$(</span>vmstat <span class="m">1</span> <span class="m">2</span> <span class="p">|</span> tail -n +4 <span class="p">|</span> awk <span class="s1">&#39;{print $12}&#39;</span><span class="k">)</span>          <span class="c1">#上下文切换数量</span>

<span class="nv">top_proc_mem</span><span class="o">=</span><span class="k">$(</span>ps --no-headers -eo comm,rss <span class="p">|</span> sort -k2 -n <span class="p">|</span> tail -10<span class="k">)</span> <span class="c1">#占用内存资源最多的10个进程列表</span>
<span class="nv">top_proc_cpu</span><span class="o">=</span><span class="k">$(</span>ps --no-headers -eo comm,pcpu <span class="p">|</span> sort -k2 -n <span class="p">|</span> tail -5<span class="k">)</span> <span class="c1">#占用CPU资源最多的5个进程列表</span>

<span class="c1">#获取网卡流量,接收|发送的数据流量,单位为字节bytes).</span>
<span class="nv">net_monitor</span><span class="o">=</span><span class="k">$(</span>cat /proc/net/dev <span class="p">|</span> tail -n +3 <span class="p">|</span> <span class="se">\</span>
              awk <span class="s1">&#39;BEGIN{ print &quot;网卡名称 入站数据流量(bytes) 出站数据流量(bytes)&quot; } \</span>
<span class="s1">                   { print $1,$2,$10 }&#39;</span> <span class="p">|</span> column -t<span class="k">)</span>

<span class="c1">#输出数据信息.</span>
<span class="nb">echo</span> -e <span class="s2">&quot;\033[32m--------------本机主要数据参数表-----------------\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;本机IP地址列表:\033[32m</span><span class="nv">$localip</span><span class="s2">\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;本机主机名称:\033[32m</span><span class="nv">$hostname</span><span class="s2">\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;操作系统版本:\033[32m</span><span class="nv">$release</span><span class="s2">\033[0m,内核版本:\033[32m</span><span class="nv">$kernel</span><span class="s2">\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;CPU型号为:\033[32m</span><span class="nv">$cpu_info</span><span class="s2">\033[0m,CPU内核数量:\033[32m</span><span class="nv">$cpu_core</span><span class="s2">\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;本机总内存容量:\033[32m</span><span class="nv">$mem_total</span><span class="s2">\033[0m,剩余可用内存容量:\033[32m</span><span class="nv">$mem_free</span><span class="s2">\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;本机swap总容量:\033[32m</span><span class="nv">$swap_total</span><span class="s2">\033[0m,剩余容量:\033[32m</span><span class="nv">$swap_free</span><span class="s2">\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;CPU最近1分钟,5分钟,15分钟的平均负载分别为:\033[32m</span><span class="nv">$load1</span><span class="s2"> </span><span class="nv">$load5</span><span class="s2"> </span><span class="nv">$load15</span><span class="s2">\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;本机总账户数量为:\033[32m</span><span class="nv">$users</span><span class="s2">\033[0m,当前登陆系统的账户数量:\033[32m</span><span class="nv">$login_users</span><span class="s2">\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;当前系统中启动的进程数量:\033[32m</span><span class="nv">$procs</span><span class="s2">\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;占用CPU资源最多的5个进程列表为:&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;\033[32m</span><span class="nv">$top_proc_cpu</span><span class="s2">\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;占用内存资源最多的10个进程列表为:&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;\033[32m</span><span class="nv">$top_proc_mem</span><span class="s2">\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;CPU中断数量:\033[32m</span><span class="nv">$irq</span><span class="s2">\033[0m,CPU上下文切换数量:\033[32m</span><span class="nv">$cs</span><span class="s2">\033[0m&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;每个磁盘分区的总容量与剩余容量信息如下:&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="nv">$disk</span><span class="s2">&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="nv">$tps</span><span class="s2">&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="nv">$read_write</span><span class="s2">&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="nv">$net_monitor</span><span class="s2">&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;\033[32m------------------The End------------------------\033[0m&quot;</span>
</pre></div>
</div>
</section>
<section id="sshd">
<h2><a class="toc-backref" href="#id20"><span class="section-number">3.12.2. </span>修改SSHD配置文件</a><a class="headerlink" href="#sshd" title="Permalink to this headline">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description):修改SSHD配置文件,提升SSH安全性.</span>

<span class="nv">config_file</span><span class="o">=</span><span class="s2">&quot;/etc/ssh/sshd_config&quot;</span>
<span class="nv">PORT</span><span class="o">=</span><span class="m">12345</span>

<span class="c1">#将默认端口号修改为自定义端口号.</span>
<span class="k">if</span> grep -q <span class="s2">&quot;^Port&quot;</span> <span class="nv">$config_file</span><span class="p">;</span><span class="k">then</span>
    sed -i <span class="s2">&quot;/^Port/c Port </span><span class="nv">$PORT</span><span class="s2">&quot;</span> <span class="nv">$config_file</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;Port </span><span class="nv">$PORT</span><span class="s2">&quot;</span> &gt;&gt; <span class="nv">$config_file</span>
<span class="k">fi</span>

<span class="c1">#禁止root远程登陆SSH服务器.</span>
<span class="k">if</span> grep -q <span class="s2">&quot;^PermitRootLogin&quot;</span> <span class="nv">$config_file</span><span class="p">;</span><span class="k">then</span>
    sed -i <span class="s1">&#39;/^PermitRootLogin/s/yes/no/&#39;</span> <span class="nv">$config_file</span>
<span class="k">else</span>
    sed -i <span class="s1">&#39;$a PermitRootLogin no&#39;</span> <span class="nv">$config_file</span>
<span class="k">fi</span>

<span class="c1">#禁止使用密码远程登陆SSH服务器.</span>
<span class="k">if</span> grep -q <span class="s2">&quot;^PasswordAuthentication&quot;</span> <span class="nv">$config_file</span><span class="p">;</span><span class="k">then</span>
    sed -i <span class="s1">&#39;/^PasswordAuthentication/s/yes/no/&#39;</span> <span class="nv">$config_file</span>
<span class="k">else</span>
    sed -i <span class="s1">&#39;$a PasswordAuthentication no&#39;</span> <span class="nv">$config_file</span>
<span class="k">fi</span>

<span class="c1">#禁止X11图形转发功能.</span>
<span class="k">if</span> grep -q <span class="s2">&quot;^X11Forwarding&quot;</span> <span class="nv">$config_file</span><span class="p">;</span><span class="k">then</span>
    sed -i <span class="s1">&#39;/^X11Forwarding/s/yes/no/&#39;</span> <span class="nv">$config_file</span>
<span class="k">else</span>
    sed -i <span class="s1">&#39;$a X11Forwarding no&#39;</span> <span class="nv">$config_file</span>
<span class="k">fi</span>

<span class="c1">#禁止DNS查询.</span>
<span class="k">if</span> grep -q <span class="s2">&quot;^UseDNS&quot;</span> <span class="nv">$config_file</span><span class="p">;</span><span class="k">then</span>
    sed -i <span class="s1">&#39;/^UseDNS/s/yes/no/&#39;</span> <span class="nv">$config_file</span>
<span class="k">else</span>
    sed -i <span class="s1">&#39;$a UseDNS no&#39;</span> <span class="nv">$config_file</span>
<span class="k">fi</span>
</pre></div>
</div>
</section>
<section id="dhcp">
<h2><a class="toc-backref" href="#id21"><span class="section-number">3.12.3. </span>一键安装部署DHCP服务</a><a class="headerlink" href="#dhcp" title="Permalink to this headline">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description):一键安装部署DHCP服务.</span>

<span class="c1">#定义变量:显示信息的颜色属性及配置文件路径.</span>
<span class="nv">SUCCESS</span><span class="o">=</span><span class="s2">&quot;echo -en \\033[1;32m&quot;</span>   <span class="c1">#绿色.</span>
<span class="nv">FAILURE</span><span class="o">=</span><span class="s2">&quot;echo -en \\033[1;31m&quot;</span>   <span class="c1">#红色.</span>
<span class="nv">WARNING</span><span class="o">=</span><span class="s2">&quot;echo -en \\033[1;33m&quot;</span>   <span class="c1">#黄色.</span>
<span class="nv">NORMAL</span><span class="o">=</span><span class="s2">&quot;echo -en \\033[0;39m&quot;</span>    <span class="c1">#黑色.</span>
<span class="nv">conf_file</span><span class="o">=</span>/etc/dhcp/dhcpd.conf

<span class="c1">#测试YUM源是否可用.</span>
test_yum<span class="o">(){</span>
    <span class="nv">num</span><span class="o">=</span><span class="k">$(</span>yum repolist <span class="p">|</span> tail -1 <span class="p">|</span> sed  <span class="s1">&#39;s/.*: *//;s/,//&#39;</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$num</span> -le <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
        <span class="nv">$FAILURE</span>
        <span class="nb">echo</span> <span class="s2">&quot;没有可用的Yum源.&quot;</span>
        <span class="nv">$NORMAL</span>
        <span class="nb">exit</span>
    <span class="k">else</span>
        <span class="k">if</span> ! yum list dhcp <span class="p">&amp;</span>&gt; /dev/null <span class="p">;</span><span class="k">then</span>
            <span class="nv">$FAILURE</span>
            <span class="nb">echo</span> <span class="s2">&quot;Yum源中没有dhcp软件包.&quot;</span>
            <span class="nv">$NORMAL</span>
            <span class="nb">exit</span>
        <span class="k">fi</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c1">#安装部署dhcp软件包.</span>
install_dhcp<span class="o">(){</span>
    <span class="c1">#如果软件包已经安装则提示警告信息并退出脚本.</span>
    <span class="k">if</span> rpm -q dhcp <span class="p">&amp;</span>&gt; /dev/null <span class="p">;</span><span class="k">then</span>
        <span class="nv">$WARNING</span>
        <span class="nb">echo</span> <span class="s2">&quot;dhcp已安装.&quot;</span>
        <span class="nv">$NORMAL</span>
        <span class="nb">exit</span>
    <span class="k">else</span>
        yum -y install dhcp
    <span class="k">fi</span>
<span class="o">}</span>


<span class="c1">#修改dhcp配置文件.</span>
modify_conf<span class="o">(){</span>
    <span class="c1">#拷贝模板配置文件.</span>
    /bin/cp -f /usr/share/doc/dhcp*/dhcpd.conf.example /etc/dhcp/dhcpd.conf
    sed -i <span class="s1">&#39;/10.152.187.0/{N;d}&#39;</span> <span class="nv">$conf_file</span>   <span class="c1">#删除多余配置,通过N读取多行,然后d删除.</span>
    sed -i <span class="s1">&#39;/10.254.239.0/,+3d&#39;</span> <span class="nv">$conf_file</span>    <span class="c1">#删除多余配置,通过正则匹配某行以及之后的3行都删除.</span>
    sed -i <span class="s1">&#39;/10.254.239.32/,+4d&#39;</span> <span class="nv">$conf_file</span>   <span class="c1">#删除多余配置,正则匹配某行以及后面的4行都删除.</span>
    sed -i <span class="s2">&quot;s/10.5.5.0/</span><span class="nv">$subnet</span><span class="s2">/&quot;</span> <span class="nv">$conf_file</span>   <span class="c1">#设置DHCP网段.</span>
    sed -i <span class="s2">&quot;s/255.255.255.224/</span><span class="nv">$netmask</span><span class="s2">/&quot;</span> <span class="nv">$conf_file</span> <span class="c1">#设置DHCP网段的子网掩码.</span>
    sed -i <span class="s2">&quot;s/10.5.5.26/</span><span class="nv">$start</span><span class="s2">/&quot;</span> <span class="nv">$conf_file</span>   <span class="c1">#设置DHCP为客户端分配的IP地址池起始IP.</span>
    sed -i <span class="s2">&quot;s/10.5.5.30/</span><span class="nv">$end</span><span class="s2">/&quot;</span> <span class="nv">$conf_file</span>     <span class="c1">#设置DHCP为客户端分配的IP地址池结束IP.</span>
    sed -i <span class="s2">&quot;s/ns1.internal.example.org/</span><span class="nv">$dns</span><span class="s2">/&quot;</span> <span class="nv">$conf_file</span>  <span class="c1">#设置为客户端分配的DNS.</span>
    sed -i <span class="s1">&#39;/internal.example.org/d&#39;</span> <span class="nv">$conf_file</span> <span class="c1">#删除多余的配置行.</span>
    sed -i <span class="s2">&quot;/routers/s/10.5.5.1/</span><span class="nv">$router</span><span class="s2">/&quot;</span> <span class="nv">$conf_file</span> <span class="c1">#设置为客户端分配的默认网关.</span>
    sed -i <span class="s1">&#39;/broadcast-address/d&#39;</span> <span class="nv">$conf_file</span>  <span class="c1">#删除多余的配置行.</span>
<span class="o">}</span>


test_yum      <span class="c1">#调用函数,测试yum源.</span>
install_dhcp  <span class="c1">#调用函数,安装软件包.</span>

<span class="c1">#读取必要的配置参数.</span>
<span class="nb">echo</span> -n <span class="s2">&quot;请输入DHCP网段(如:192.168.4.0):&quot;</span>
<span class="nv">$SUCCESS</span>
<span class="nb">read</span> subnet
<span class="nv">$NORMAL</span>
<span class="nb">echo</span> -n <span class="s2">&quot;请输入DHCP网段的子网掩码(如:255.255.255.0):&quot;</span>
<span class="nv">$SUCCESS</span>
<span class="nb">read</span> netmask
<span class="nv">$NORMAL</span>
<span class="nb">echo</span> -n <span class="s2">&quot;请输入为客户端分配的地址池(如:192.168.4.1-192.168.4.10):&quot;</span>
<span class="nv">$SUCCESS</span>
<span class="nb">read</span> pools
<span class="nv">$NORMAL</span>
<span class="nb">echo</span> -n <span class="s2">&quot;请输入为客户端分配的默认网关:&quot;</span>
<span class="nv">$SUCCESS</span>
<span class="nb">read</span> router
<span class="nv">$NORMAL</span>
<span class="nb">echo</span> -n <span class="s2">&quot;请输入为客户端分配的DNS服务器:&quot;</span>
<span class="nv">$SUCCESS</span>
<span class="nb">read</span> dns
<span class="nv">$NORMAL</span>
<span class="nv">start</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$pools</span> <span class="p">|</span> cut -d- -f1<span class="k">)</span>     <span class="c1">#获取起始IP.</span>
<span class="nv">end</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$pools</span> <span class="p">|</span> cut -d- -f2<span class="k">)</span>       <span class="c1">#获取结束IP.</span>

modify_conf   <span class="c1">#调用函数,修改配置文件.</span>

<span class="c1">#重启服务.</span>
systemctl restart dhcpd  <span class="p">&amp;</span>&gt;/dev/null
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    <span class="nv">$SUCCESS</span>
    <span class="nb">echo</span> <span class="s2">&quot;部署配置DHCP完毕.&quot;</span>
<span class="k">else</span>
    <span class="nv">$FAILURE</span>
    <span class="nb">echo</span> <span class="s2">&quot;部署配置DHCP失败,通过 journalctl -xe查看日志.&quot;</span>
<span class="k">fi</span>
<span class="nv">$NORMAL</span>
</pre></div>
</div>
</section>
<section id="vsftpd">
<h2><a class="toc-backref" href="#id22"><span class="section-number">3.12.4. </span>自动部署配置vsftpd服务器</a><a class="headerlink" href="#vsftpd" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
#功能描述(Description):自动部署配置vsftpd服务器,管理FTP服务器,针对RHEL|CentOS系统.
#本地账户访问FTP的共享目录为/common,其中/common/pub为可上传目录.
#匿名账户访问FTP的共享目录为/var/ftp,其中/var/ftp/pub为可上传目录.

#定义变量:显示信息的颜色属性及配置文件路径.
SUCCESS=&quot;echo -en \\033[1;32m&quot;   #绿色.
FAILURE=&quot;echo -en \\033[1;31m&quot;   #红色.
WARNING=&quot;echo -en \\033[1;33m&quot;   #黄色.
NORMAL=&quot;echo -en \\033[0;39m&quot;    #黑色.
conf_file=/etc/vsftpd/vsftpd.conf

#####从这里开始先将所有需要的功能定义为函数.#####
#定义脚本的主菜单功能.
menu(){
    clear
    echo &quot;-----------------------------------&quot;
    echo &quot;#          菜单(Menu)             #&quot;
    echo &quot;-----------------------------------&quot;
    echo &quot;# 1.安装配置vsftpd.               #&quot;
    echo &quot;# 2.创建FTP账户.                  #&quot;
    echo &quot;# 3.删除FTP账户.                  #&quot;
    echo &quot;# 4.配置匿名账户.                 #&quot;
    echo &quot;# 5.启动关闭vsftpd.               #&quot;
    echo &quot;# 6.退出脚本.                     #&quot;
    echo &quot;-----------------------------------&quot;
    echo
}

#定义配置匿名账户的子菜单.
anon_sub_menu(){
    clear
    echo &quot;-----------------------------------&quot;
    echo &quot;#      匿名配置子菜单(Menu)       #&quot;
    echo &quot;-----------------------------------&quot;
    echo &quot;# 1.禁用匿名账户.                 #&quot;
    echo &quot;# 2.启用匿名登陆.                 #&quot;
    echo &quot;# 3.允许匿名账户上传.             #&quot;
    echo &quot;-----------------------------------&quot;
    echo
}

#定义服务管理的子菜单.
service_sub_menu(){
    clear
    echo &quot;-----------------------------------&quot;
    echo &quot;#       服务管理子菜单(Menu)      #&quot;
    echo &quot;-----------------------------------&quot;
    echo &quot;# 1.启动vsftpd.                   #&quot;
    echo &quot;# 2.关闭vsftpd.                   #&quot;
    echo &quot;# 3.重启vsftpd.                   #&quot;
    echo &quot;-----------------------------------&quot;
    echo
}

#测试YUM是否可用.
test_yum(){
    num=$(yum repolist | tail -1 | sed  &#39;s/.*: *//;s/,//&#39;)
    if [ $num -le 0 ];then
        $FAILURE
        echo &quot;没有可用的Yum源.&quot;
        $NORMAL
        exit
    else
        if ! yum list vsftpd &amp;&gt; /dev/null ;then
            $FAILURE
            echo &quot;Yum源中没有vsftpd软件包.&quot;
            $NORMAL
            exit
        fi
    fi
}

#安装部署vsftpd软件包.
install_vsftpd(){
#如果软件包已经安装则提示警告信息并退出脚本.
    if rpm -q vsftpd &amp;&gt; /dev/null ;then
        $WARNING
        echo &quot;vsftpd已安装.&quot;
        $NORMAL
        exit
    else
        yum -y install vsftpd
    fi
}

#修改初始化配置文件.
init_config(){
#备份配置文件.
    [ ! -e $conf_file.bak ] &amp;&amp; cp $conf_file{,.bak}

#为本地账户创建共享目录/common,修改配置文件指定共享根目录.
    [ ! -d /common/pub ] &amp;&amp; mkdir -p /common/pub
    chmod a+w /common/pub
    grep -q local_root $conf_file || sed -i &#39;$a local_root=/common&#39; $conf_file

#默认客户端通过本地账户访问FTP时
#允许使用cd命令跳出共享目录,可以看到/etc等系统目录及文件.
#通过设置chroot_local_user=YES可以将账户禁锢在自己的家目录,无法进入其他目录.
    sed -i &#39;s/^#chroot_local_user=YES/chroot_local_user=YES/&#39; $conf_file
}

#创建FTP账户,如果账户已存在则直接退出脚本.
create_ftpuser(){
    if id $1 &amp;&gt; /dev/null ;then
        $FAILURE
        echo &quot;$1账户已存在.&quot;
        $NORMAL
        exit
    else
        useradd $1
        echo &quot;$2&quot; | passwd --stdin $1 &amp;&gt;/dev/null
    fi
}

#删除FTP账户,如果账户不存在则直接退出脚本.
delete_ftpuser(){
    if ! id $1 &amp;&gt; /dev/null ;then
        $FAILURE
        echo &quot;$1账户不存在.&quot;
        $NORMAL
        exit
    else
        userdel $1
    fi
}

#配置匿名账户.
#第一个位置参数为1则将匿名账户禁用.
#第一个位置参数为2则开启匿名账户登陆功能.
#第一个位置参数为3则设置允许匿名账户上传文件.
anon_config(){
    if [ ! -f $conf_file ];then
        $FAILURE
        echo &quot;配置文件不存在.&quot;
        $NORMAL
        exit
    fi
#设置anonymous_enable=YES可以开启匿名登陆功能,默认为开启状态.
#设置anonymous_enable=NO可以禁止匿名登陆功能.
#设置anon_upload_enable=YES可以允许匿名上传文件,默认该配置被注释.
#设置anon_mkdir_write_enable=YES可以允许匿名账户创建目录,默认该配置被注释.
case $1 in
1)
    sed -i &#39;s/anonymous_enable=YES/anonymous_enable=NO/&#39; $conf_file
    systemctl restart vsftpd;;
2)
    sed -i &#39;s/anonymous_enable=NO/anonymous_enable=YES/&#39; $conf_file
    systemctl restart vsftpd;;
3)
    sed -i &#39;s/^#anon_/anon_/&#39; $conf_file
    chmod a+w /var/ftp/pub
    systemctl restart vsftpd;;
esac
}

#服务管理.
#第一个位置参数为start时启动vsftpd服务.
#第一个位置参数为stop时关闭vsftpd服务.
#第一个位置参数为restart时重启vsftpd服务.
proc_manager(){
    if ! rpm -q vsftpd &amp;&gt;/dev/null ;then
        $FAILURE
        echo &quot;未安装vsftpd软件包.&quot;
        $NORMAL
        exit
    fi
case $1 in
start)
    systemctl start vsftpd;;
stop)
    systemctl stop vsftpd;;
restart)
    systemctl restart vsftpd;;
esac
}


######从这里开始调用前面定义的函数.#####
menu
read -p &quot;请输入选项[1-6]:&quot; input
case $input in
1)
    test_yum           #测试yum源.
    install_vsftpd     #安装vsftpd软件包.
    init_config;;      #初始化修改配置文件.
2)
    read -p &quot;请输入账户名称:&quot; username
    read -s -p &quot;请输入账户密码:&quot; password
    echo
    create_ftpuser $username $password;;   #创建FTP账户.
3)
    read -p &quot;请输入账户名称:&quot; username
    delete_ftpuser $username $password;;   #删除FTP账户.
4)
    anon_sub_menu
    read -p &quot;请输入选项[1-3]:&quot; anon
    if [ $anon -eq 1 ];then
        anon_config 1                     #禁止匿名登陆.
    elif [ $anon -eq 2 ];then
        anon_config 2                     #启用匿名登陆.
    elif [ $anon -eq 3 ];then
        anon_config 3                     #允许匿名上传.
    fi;;
5)
    service_sub_menu
    read -p &quot;请输入选项[1-3]:&quot; proc
    if [ $proc -eq 1 ];then
        proc_manager start                #启动vsftpd服务.
    elif [ $proc -eq 2 ];then
        proc_manager stop                 #关闭vsftpd服务.
    elif [ $proc -eq 3 ];then
        proc_manager restart              #重启vsftpd服务.
    fi;;
6)
    exit;;
*)
    $FAILURE
    echo &quot;您的输入有误.&quot;
    $NORMAL
    exit;;
esac
</pre></div>
</div>
</section>
<section id="mysql">
<h2><a class="toc-backref" href="#id23"><span class="section-number">3.12.5. </span>使用脚本操作MySQL数据库</a><a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 操作数据库</span>
<span class="n">mysql</span> <span class="o">-</span><span class="n">uUSER</span> <span class="o">-</span><span class="n">pPASSWORD</span> <span class="o">-</span><span class="n">e</span><span class="s2">&quot;SQL STATEMENTS&quot;</span>

<span class="c1">#查看本地所有数据库</span>
<span class="n">mysql</span> <span class="o">-</span><span class="n">uroot</span> <span class="o">-</span><span class="n">ppassword</span> <span class="o">-</span><span class="n">e</span><span class="s2">&quot;show databases&quot;</span>
</pre></div>
</div>
<p>操作数据库脚本</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cat mysql01.sh</span>
<span class="c1">#!/bin/bash</span>
<span class="nv">HOSTNAME</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span>
<span class="nv">USERNAME</span><span class="o">=</span><span class="s2">&quot;root&quot;</span>
<span class="nv">PASSWORD</span><span class="o">=</span><span class="s2">&quot;password&quot;</span>
<span class="nv">MYSQL</span><span class="o">=</span>/usr/bin/mysql
<span class="nv">SH_DB</span><span class="o">=</span><span class="s2">&quot;show databases&quot;</span>
<span class="nv">$MYSQL</span> -u<span class="nv">$USERNAME</span> -p<span class="nv">$PASSWORD</span> -e<span class="s2">&quot;</span><span class="nv">$SH_DB</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>下面列举了常用的数据库操作脚本：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#创建数据库
create_db_sql=&quot;create database  ${DBNAME}&quot;
mysql -u${USERNAME} -p${PASSWORD} -e &quot;${create_db_sql}&quot;

#创建表
create_table_sql=&quot;create table  ${TABLE} (name varchar(20), id int(10))&quot;
mysql -u${USERNAME} -p${PASSWORD} ${DBNAME} -e&quot;${create_table_sql}&quot;

#插入数据
insert_sql=&quot;insert into ${TABLENAME} values(&#39;john&#39;,1)&quot;
mysql -u${USERNAME} -p${PASSWORD} ${DBNAME} -e&quot;${insert_sql}&quot;

#查询
select_sql=&quot;select * from ${TABLENAME}&quot;
mysql -u${USERNAME} -p${PASSWORD} ${DBNAME} -e&quot;${select_sql}&quot;

#更新数据
update_sql=&quot;update ${TABLENAME} set id=3&quot;
mysql -u${USERNAME} -p${PASSWORD} ${DBNAME} -e&quot;${update_sql}&quot;

#删除数据
delete_sql=&quot;delete from ${TABLENAME}&quot;
mysql -u${USERNAME} -p${PASSWORD} ${DBNAME} -e&quot;${delete_sql}&quot;
</pre></div>
</div>
<p>使用Here Document执行SQL代码块，命令如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@localhost</span> <span class="o">~</span><span class="p">]</span><span class="c1"># cat mysql02.sh</span>
<span class="c1">#!/bin/bash</span>
<span class="n">mysql</span> <span class="o">-</span><span class="n">uroot</span> <span class="o">-</span><span class="n">ppassword</span> <span class="o">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">CREATE</span> <span class="n">DATABASE</span> <span class="n">DB01</span><span class="p">;</span>
<span class="n">use</span> <span class="n">DB01</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">user</span>
<span class="p">(</span>
<span class="n">userID</span> <span class="nb">int</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="ow">not</span> <span class="n">null</span><span class="p">,</span>
<span class="n">userName</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="ow">not</span> <span class="n">null</span><span class="p">,</span>
<span class="n">userPass</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="ow">not</span> <span class="n">null</span><span class="p">,</span>
<span class="n">age</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="ow">not</span> <span class="n">null</span><span class="p">,</span>
<span class="n">primary</span> <span class="n">key</span><span class="p">(</span><span class="n">userID</span><span class="p">)</span>
<span class="p">);</span>
<span class="n">EOF</span>
</pre></div>
</div>
<p>使用管道或重定向符执行SQL代码块，命令如下：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mysql -uroot -ppassword &lt; update.sql
cat update.sql <span class="p">|</span> mysql -uroot -ppassword
</pre></div>
</div>
</section>
<section id="system-opt">
<h2><a class="toc-backref" href="#id24"><span class="section-number">3.12.6. </span>system_opt系统优化</a><a class="headerlink" href="#system-opt" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">system_opt.sh</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:${NAME}.sh</span>
<span class="c1"># author：xiaojian</span>

<span class="c1">#usage() {</span>
<span class="c1">#    echo &quot;请按如下格式执行&quot;</span>
<span class="c1">#    echo &quot;USAGE: bash $0 函数名1#函数名2&quot;</span>
<span class="c1">#    echo &quot;USAGE: bash $0 epel#ulimits#ssh&quot;</span>
<span class="c1">#    exit 1</span>
<span class="c1">#}</span>
<span class="c1">#</span>

<span class="k">function</span> epel<span class="o">(){</span>
    yum install epel-release -y &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    sed -i <span class="s1">&#39;s/mirrorlist/#mirrorlist/g&#39;</span> /etc/yum.repos.d/epel.repo
    sed -i <span class="s1">&#39;s/#baseurl/baseurl/g&#39;</span> /etc/yum.repos.d/epel.repo
    sed -i <span class="s1">&#39;6s/enabled=0/enabled=1/g&#39;</span> /etc/yum.repos.d/epel.repo
    sed -i <span class="s1">&#39;7s/gpgcheck=1/gpgcheck=0/g&#39;</span> /etc/yum.repos.d/epel.repo
    yum clean all &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="c1">#阿里云机器用aliyun epel</span>
    <span class="c1">#echo &quot;[EPEL 配置] ==&gt; OK&quot;</span>
<span class="o">}</span>

<span class="k">function</span> ulimits<span class="o">(){</span>
cat &gt; /etc/security/limits.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">* soft noproc 65536</span>
<span class="s">* hard noproc 65536</span>
<span class="s">* soft nofile 65536</span>
<span class="s">* hard nofile 65536</span>
<span class="s">EOF</span>
<span class="c1"># centos 7.3 还是 7.4开始， 这个文件有一部分soft 和 nproc 内容，登陆后会被覆盖，/etc/security/limits.conf 不会生效</span>
<span class="nb">echo</span> &gt; /etc/security/limits.d/20-nproc.conf

<span class="nb">ulimit</span> -n <span class="m">65536</span>
<span class="nb">ulimit</span> -u <span class="m">65536</span>


<span class="c1">#echo &quot;[ulimits 配置] ==&gt; OK&quot;</span>


<span class="o">}</span>


<span class="c1"># 系统默认没有 /etc/init.d/sshd 需要使用 systemctl restart  sshd</span>
<span class="k">function</span> ssh<span class="o">(){</span>
    <span class="o">[</span> -f /etc/ssh/sshd_config <span class="o">]</span>  <span class="o">&amp;&amp;</span> sed -ir <span class="s1">&#39;13 iUseDNS no\nGSSAPIAuthentication no&#39;</span> /etc/ssh/sshd_config <span class="o">&amp;&amp;</span> systemctl restart  sshd &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="c1">#echo &quot;[SSH 优化] ==&gt; OK&quot;</span>
<span class="o">}</span>

<span class="c1"># 修改内核参数，增加缓存区，减少等待时间</span>
<span class="c1"># 可以接收更大的包，增加对轻量ddos抗性</span>
<span class="k">function</span> kernel<span class="o">(){</span>
cat &gt; /etc/sysctl.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">fs.file-max = 65536</span>
<span class="s">net.core.netdev_max_backlog = 32768</span>
<span class="s">net.core.rmem_default = 8388608</span>
<span class="s">net.core.rmem_max = 16777216</span>
<span class="s">net.core.somaxconn = 32768</span>
<span class="s">net.core.wmem_default = 8388608</span>
<span class="s">net.core.wmem_max = 16777216</span>
<span class="s">net.ipv4.conf.all.arp_ignore = 0</span>
<span class="s">net.ipv4.conf.lo.arp_announce = 0</span>
<span class="s">net.ipv4.conf.lo.arp_ignore = 0</span>
<span class="s">net.ipv4.ip_local_port_range = 5000 65000</span>
<span class="s">net.ipv4.tcp_fin_timeout = 30</span>
<span class="s">net.ipv4.tcp_keepalive_intvl = 30</span>
<span class="s">net.ipv4.tcp_keepalive_probes = 3</span>
<span class="s">net.ipv4.tcp_keepalive_time = 300</span>
<span class="s">net.ipv4.tcp_max_orphans = 3276800</span>
<span class="s">net.ipv4.tcp_max_syn_backlog = 65536</span>
<span class="s">net.ipv4.tcp_max_tw_buckets = 5000</span>
<span class="s">net.ipv4.tcp_mem = 94500000 915000000 927000000</span>
<span class="s">net.ipv4.tcp_syn_retries = 2</span>
<span class="s">net.ipv4.tcp_synack_retries = 2</span>
<span class="s">net.ipv4.tcp_syncookies = 1</span>
<span class="s">net.ipv4.tcp_timestamps = 0</span>
<span class="s">net.ipv4.tcp_tw_recycle = 1</span>
<span class="s">net.ipv4.tcp_tw_reuse = 1</span>
<span class="s">EOF</span>
sysctl -p &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="c1">#echo &quot;[内核 优化] ==&gt; OK&quot;</span>
<span class="o">}</span>

<span class="c1"># 增加操作系统记录数量</span>
<span class="k">function</span> history<span class="o">(){</span>
    <span class="k">if</span> ! grep <span class="s2">&quot;HISTTIMEFORMAT&quot;</span> /etc/profile &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="k">then</span> <span class="nb">echo</span> <span class="s1">&#39;</span>
<span class="s1">    UserIP=$(who -u am i | cut -d&quot;(&quot;  -f 2 | sed -e &quot;s/[()]//g&quot;)</span>
<span class="s1">    export HISTTIMEFORMAT=&quot;[%F %T] [`whoami`] [${UserIP}] &quot; &#39;</span> &gt;&gt; /etc/profile<span class="p">;</span>
    <span class="k">fi</span>
    sed -i <span class="s2">&quot;s/HISTSIZE=1000/HISTSIZE=999999999/&quot;</span> /etc/profile
<span class="c1">#echo &quot;[history 优化] ==&gt; OK&quot;</span>
<span class="o">}</span>

<span class="c1"># 这个稍后我再试一试，我是倾向不要关闭selinux，而是使用系统权限完善来控制软件运行。</span>
<span class="c1"># 稍后测试一下看看</span>
<span class="k">function</span> security<span class="o">(){</span>
    &gt; /etc/issue
    sed -i <span class="s1">&#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39;</span> /etc/selinux/config
    sed -i <span class="s1">&#39;s/SELINUX=permissive/SELINUX=disabled/g&#39;</span> /etc/selinux/config
    setenforce <span class="m">0</span> &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="c1">#systemctl stop firewalld.service</span>
    <span class="c1">#systemctl disable firewalld.service</span>
    yum install -y openssl openssh bash &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="c1">#echo &quot;[安全配置] ==&gt; OK&quot;</span>
<span class="o">}</span>

<span class="k">function</span> other<span class="o">(){</span>
    yum groupinstall Development tools -y &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    yum install -y vim wget lrzsz telnet traceroute iotop tree &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    yum install -y ncftp axel git zlib-devel openssl-devel unzip xz libxslt-devel libxml2-devel libcurl-devel &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="c1">#echo &quot;[安装常用工具] ==&gt; OK&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;export HOME=/root&quot;</span> &gt;&gt; /etc/profile
    <span class="nb">source</span> /etc/profile
    useradd -M -s /sbin/nologin nginx &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    mkdir -p /root/ops_scripts /data1/www
    mkdir -p /opt/codo/
<span class="o">}</span>

<span class="nb">export</span> -f epel
<span class="nb">export</span> -f ulimits
<span class="nb">export</span> -f ssh
<span class="nb">export</span> -f kernel
<span class="nb">export</span> -f <span class="nb">history</span>
<span class="nb">export</span> -f security
<span class="nb">export</span> -f other

<span class="c1">##格式必须是: bash script 函数名1#函数2</span>
<span class="c1">## 例如: bash system_init_v1.sh epel#ulimits#ssh</span>
<span class="c1">#echo $1 | awk -F &quot;#&quot; &#39;{for(i=1;i&lt;=NF;++i) system($i)}&#39;</span>
epel
ulimits
ssh
kernel
<span class="nb">history</span>
security
other
<span class="c1">#echo &#39;[Success]System Init OK&#39;</span>
</pre></div>
</div>
</section>
<section id="centos61">
<h2><a class="toc-backref" href="#id25"><span class="section-number">3.12.7. </span>Centos6最小化安装后优化1</a><a class="headerlink" href="#centos61" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#系统基础升级,建议以root执行</span>

<span class="c1">#必须使用root才能执行此脚本</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$USER</span> !<span class="o">=</span> <span class="s2">&quot;root&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;需要使用 sudo 才能使用本脚本&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="nb">cd</span> /usr/local/src
wget http://mirrors.163.com/.help/CentOS6-Base-163.repo
<span class="nb">cd</span> /etc/yum.repos.d/
mv CentOS-Base.repo CentOS-Base.repo.bak
cp /usr/local/src/CentOS6-Base-163.repo ./CentOS-Base.repo
yum clean all <span class="c1">#清除yum缓存</span>
yum makecache <span class="c1">#重建缓存</span>
yum update -y  <span class="c1">#升级Linux系统</span>
<span class="nb">cd</span> ../
<span class="c1">#添加epel外部yum扩展源</span>
<span class="nb">cd</span> /usr/local/src
wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
rpm -ivh epel-release-6-8.noarch.rpm
<span class="c1">#安装gcc基础库文件以及sysstat工具</span>
yum -y install gcc gcc-c++ vim-enhanced unzip unrar sysstat
<span class="c1">#配置ntpdate自动对时</span>
yum -y install ntp
<span class="nb">echo</span> <span class="s2">&quot;01 01 * * * /usr/sbin/ntpdate ntp.api.bz    &gt;&gt; /dev/null 2&gt;&amp;1&quot;</span> &gt;&gt; /etc/crontab
/usr/sbin/ntpdate ntp.api.bz
service crond restart

<span class="c1">#配置文件的ulimit值</span>
<span class="nb">ulimit</span> -SHn <span class="m">65534</span>
<span class="nb">echo</span> <span class="s2">&quot;ulimit -SHn 65534&quot;</span> &gt;&gt; /etc/rc.local
cat &gt;&gt; /etc/security/limits.conf <span class="s">&lt;&lt; EOF</span>
<span class="s">*                     soft     nofile             65535</span>
<span class="s">*                     hard     nofile             65535</span>
<span class="s">EOF</span>
<span class="nb">echo</span> <span class="s2">&quot;fs.file-max=419430&quot;</span> &gt;&gt; /etc/sysctl.conf

<span class="c1">#基础系统内核优化</span>
cat &gt;&gt; /etc/sysctl.conf <span class="s">&lt;&lt; EOF</span>
<span class="s">net.ipv4.tcp_syncookies = 1</span>
<span class="s">net.ipv4.tcp_syn_retries = 1</span>
<span class="s">net.ipv4.tcp_tw_recycle = 1</span>
<span class="s">net.ipv4.tcp_tw_reuse = 1</span>
<span class="s">net.ipv4.tcp_fin_timeout = 1</span>
<span class="s">net.ipv4.tcp_keepalive_time = 1200</span>
<span class="s">net.ipv4.ip_local_port_range = 10000 65535</span>
<span class="s">net.ipv4.tcp_max_syn_backlog = 16384</span>
<span class="s">net.ipv4.tcp_max_tw_buckets = 36000</span>
<span class="s">net.ipv4.route.gc_timeout = 100</span>
<span class="s">net.ipv4.tcp_syn_retries = 1</span>
<span class="s">net.ipv4.tcp_synack_retries = 1</span>
<span class="s">net.core.somaxconn = 16384</span>
<span class="s">net.core.netdev_max_backlog = 16384</span>
<span class="s">net.ipv4.tcp_max_orphans = 16384</span>

<span class="s">EOF</span>
/sbin/sysctl -p

<span class="c1">#禁用control-alt-delete组合键以防止误操作</span>
sed -i <span class="s1">&#39;s@ca::ctrlaltdel:/sbin/shutdown -t3 -r now@#ca::ctrlaltdel:/sbin/shutdown -t3 -r now@&#39;</span> /etc/inittab
<span class="c1">#关闭SElinux</span>
sed -i <span class="s1">&#39;s@SELINUX=enforcing@SELINUX=disabled@&#39;</span> /etc/selinux/config
<span class="c1">#关闭iptables</span>
service iptables stop
chkconfig iptables off
<span class="c1">#ssh服务配置优化,请至少保持机器中至少有一个具有sudo权限的用户，下面的配置会禁止root远程登录</span>
sed -i <span class="s1">&#39;s@#PermitRootLogin yes@PermitRootLogin no@&#39;</span> /etc/ssh/sshd_config
<span class="c1">#禁止空密码登录</span>
sed -i <span class="s1">&#39;s@#PermitEmptyPasswords no@PermitEmptyPasswords no@&#39;</span> /etc/ssh/sshd_config
<span class="c1">#禁止SSH反向解析</span>
sed -i <span class="s1">&#39;s@#UseDNS yes@UseDNS no@&#39;</span> /etc/ssh/sshd_config /etc/ssh/sshd_config
service sshd restart
<span class="c1">#禁用ipv6地址,根据实际需求来设，如果需要安装lvs服务的机器，建议保留此选项</span>
<span class="nb">echo</span> <span class="s2">&quot;install ipv6 /bin/true&quot;</span> &gt; /etc/modprobe.d/disable-ipv6.conf
<span class="c1">#每当系统需要加载IPv6模块时，强制执行/bin/true来代替实际加载的模块</span>
<span class="nb">echo</span> <span class="s2">&quot;IPV6INIT=no&quot;</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-eth0
<span class="c1">#禁用基于IPv6网络，使之不会被触发启动</span>
chkconfig ip6tables off
<span class="c1">#vim基础语法优化</span>
cat &gt;&gt; /root/.vimrc <span class="s">&lt;&lt; EOF</span>
<span class="s">set number</span>
<span class="s">set ruler</span>
<span class="s">set nohlsearch</span>
<span class="s">set shiftwidth=2</span>
<span class="s">set tabstop=4</span>
<span class="s">set expandtab</span>
<span class="s">set cindent</span>
<span class="s">set autoindent</span>
<span class="s">set mouse=v</span>
<span class="s">syntax on</span>
<span class="s">EOF</span>
<span class="c1">#精简开机自启动服务，安装最小化服务的机器初始可以只留crond|network|rsyslog|sshd这四个服务</span>
<span class="k">for</span> i <span class="k">in</span> <span class="sb">`</span>chkconfig --list<span class="p">|</span>grep <span class="m">3</span>:on<span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span><span class="p">;</span><span class="k">do</span> chkconfig --level <span class="m">3</span> <span class="nv">$i</span> off<span class="p">;</span><span class="k">done</span>
<span class="k">for</span> CURSRV  <span class="k">in</span> crond rsyslog sshd network<span class="p">;</span><span class="k">do</span> chkconfig --level <span class="m">3</span> <span class="nv">$CURSRV</span> on<span class="p">;</span><span class="k">done</span>
<span class="c1">#重启服务器</span>
reboot
</pre></div>
</div>
</section>
<section id="centos62">
<h2><a class="toc-backref" href="#id26"><span class="section-number">3.12.8. </span>Centos6最小化安装后优化2</a><a class="headerlink" href="#centos62" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#添加epel外部yum扩展源</span>
<span class="nb">cd</span> /usr/local/src
wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
rpm -ivh epel-release-6-8.noarch.rpm
<span class="c1">#安装gcc基础库文件以及sysstat工具</span>
yum -y install gcc gcc-c++ vim-enhanced unzip unrar sysstat
<span class="c1">#配置ntpdate自动对时</span>
yum -y install ntp
<span class="nb">echo</span> <span class="s2">&quot;01 01 * * * /usr/sbin/ntpdate ntp.api.bz    &gt;&gt; /dev/null 2&gt;&amp;1&quot;</span> &gt;&gt; /etc/crontab
ntpdate ntp.api.bz
service crond restart
<span class="c1">#配置文件的ulimit值</span>
<span class="nb">ulimit</span> -SHn <span class="m">65535</span>
<span class="nb">echo</span> <span class="s2">&quot;ulimit -SHn 65535&quot;</span> &gt;&gt; /etc/rc.local
cat&gt;&gt; /etc/security/limits.conf <span class="s">&lt;&lt; EOF</span>
<span class="s">*                     soft     nofile             65535</span>
<span class="s">*                     hard     nofile             65535</span>
<span class="s">EOF</span>

<span class="c1">#基础系统内核优化</span>
cat&gt;&gt; /etc/sysctl.conf <span class="s">&lt;&lt; EOF</span>
<span class="s">fs.file-max=419430</span>
<span class="s">net.ipv4.tcp_syncookies = 1</span>
<span class="s">net.ipv4.tcp_syn_retries = 1</span>
<span class="s">net.ipv4.tcp_tw_recycle = 1</span>
<span class="s">net.ipv4.tcp_tw_reuse = 1</span>
<span class="s">net.ipv4.tcp_fin_timeout = 1</span>
<span class="s">net.ipv4.tcp_keepalive_time = 1200</span>
<span class="s">net.ipv4.ip_local_port_range = 1024 65535</span>
<span class="s">net.ipv4.tcp_max_syn_backlog = 16384</span>
<span class="s">net.ipv4.tcp_max_tw_buckets = 36000</span>
<span class="s">net.ipv4.route.gc_timeout = 100</span>
<span class="s">net.ipv4.tcp_syn_retries = 1</span>
<span class="s">net.ipv4.tcp_synack_retries = 1</span>
<span class="s">net.core.somaxconn = 16384</span>
<span class="s">net.core.netdev_max_backlog = 16384</span>
<span class="s">net.ipv4.tcp_max_orphans = 16384</span>
<span class="s">EOF</span>
/sbin/sysctl -p

<span class="c1">#禁用control-alt-delete组合键以防止误操作</span>
sed -i <span class="s1">&#39;s@ca::ctrlaltdel:/sbin/shutdown -t3 -r now@#ca::ctrlaltdel:/sbin/shutdown -t3 -r now@&#39;</span> /etc/inittab
<span class="c1">#关闭SElinux</span>
sed -i <span class="s1">&#39;s@SELINUX=enforcing@SELINUX=disabled@&#39;</span> /etc/selinux/config
<span class="c1">#关闭iptables</span>
service iptables stop
chkconfig iptables off
<span class="c1">#ssh服务配置优化,请至少保持机器中至少有一个具有sudo权限的用户，下面的配置会禁止root远程登录</span>
sed -i <span class="s1">&#39;s@#PermitRootLogin yes@PermitRootLogin no@&#39;</span> /etc/ssh/sshd_config <span class="c1">#禁止root远程登录</span>
sed -i <span class="s1">&#39;s@#PermitEmptyPasswords no@PermitEmptyPasswords no@&#39;</span> /etc/ssh/sshd_config <span class="c1">#禁止空密码登录</span>
sed -i <span class="s1">&#39;s@#UseDNS yes@UseDNS no@&#39;</span> /etc/ssh/sshd_config /etc/ssh/sshd_config
service sshd restart
<span class="c1">#禁用ipv6地址</span>
<span class="nb">echo</span> <span class="s2">&quot;alias net-pf-10 off&quot;</span> &gt;&gt; /etc/modprobe.d/dist.conf
<span class="nb">echo</span> <span class="s2">&quot;alias ipv6 off&quot;</span> &gt;&gt; /etc/modprobe.d/dist.conf
chkconfig ip6tables off
<span class="c1">#vim基础语法优化</span>
<span class="nb">echo</span> <span class="s2">&quot;syntax on&quot;</span> &gt;&gt; /root/.vimrc
<span class="nb">echo</span> <span class="s2">&quot;set nohlsearch&quot;</span> &gt;&gt; /root/.vimrc
<span class="c1">#精简开机自启动服务，安装最小化服务的机器初始可以只保留crond，network，rsyslog，sshd这四个服务。</span>
<span class="k">for</span> i <span class="k">in</span> <span class="sb">`</span>chkconfig --list<span class="p">|</span>grep <span class="m">3</span>:on<span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span><span class="p">;</span><span class="k">do</span> chkconfig --level <span class="m">3</span> <span class="nv">$i</span> off<span class="p">;</span><span class="k">done</span>
<span class="k">for</span> CURSRV  <span class="k">in</span> crond rsyslog sshd network<span class="p">;</span><span class="k">do</span> chkconfig --level <span class="m">3</span> <span class="nv">$CURSRV</span> on<span class="p">;</span><span class="k">done</span>
<span class="c1">#重启服务器</span>
reboot
</pre></div>
</div>
</section>
<section id="centos7">
<h2><a class="toc-backref" href="#id27"><span class="section-number">3.12.9. </span>Centos7安装后优化</a><a class="headerlink" href="#centos7" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#author shunxin by</span>
<span class="c1">#this script is only for CentOS 7.x</span>
<span class="c1">#check the OS</span>
<span class="nv">platform</span><span class="o">=</span><span class="sb">`</span>uname -i<span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$platform</span> !<span class="o">=</span> <span class="s2">&quot;x86_64&quot;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
<span class="nb">echo</span> <span class="s2">&quot;this script is only for 64bit Operating System !&quot;</span>
<span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>
<span class="nb">echo</span> <span class="s2">&quot;the platform is ok&quot;</span>
cat <span class="s">&lt;&lt; EOF</span>
<span class="s">+---------------------------------------+</span>
<span class="s">|   your system is CentOS 7 x86_64      |</span>
<span class="s">|      start optimizing.......          |</span>
<span class="s">+---------------------------------------</span>
<span class="s">EOF</span>
<span class="c1">#Yum源更换为国内阿里源</span>
yum install wget -y
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
<span class="c1">#添加阿里的epel源</span>
<span class="c1">#add the epel</span>
wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
<span class="c1">#yum重新建立缓存</span>
yum clean all
yum makecache
<span class="c1">#同步时间</span>
yum -y install ntp
/usr/sbin/ntpdate ntp1.aliyun.com
<span class="nb">echo</span> <span class="s2">&quot;* 3 * * * /usr/sbin/ntpdate ntp1.aliyun.com &gt; /dev/null 2&gt;&amp;1&quot;</span> &gt;&gt; /var/spool/cron/root
systemctl  restart crond.service
<span class="c1">#设置主机名</span>
hostnamectl   set-hostname qiuyuetao
<span class="c1">#设置字符集</span>
<span class="c1">#设置最大打开文件描述符数</span>
<span class="nb">echo</span> <span class="s2">&quot;ulimit -SHn 102400&quot;</span> &gt;&gt; /etc/rc.local
cat &gt;&gt; /etc/security/limits.conf <span class="s">&lt;&lt; EOF</span>
<span class="s">*           soft   nofile       655350</span>
<span class="s">*           hard   nofile       655350</span>
<span class="s">EOF</span>
<span class="c1">#禁用selinux</span>
sed -i <span class="s1">&#39;s/SELINUX=enforcing/SELINUX=disabled/&#39;</span> /etc/selinux/config
setenforce <span class="m">0</span>
<span class="c1">#关闭防火墙</span>
systemctl disable firewalld.service
systemctl stop firewalld.service
<span class="c1">#set ssh</span>
sed -i <span class="s1">&#39;s/^GSSAPIAuthentication yes$/GSSAPIAuthentication no/&#39;</span> /etc/ssh/sshd_config
sed -i <span class="s1">&#39;s/#UseDNS yes/UseDNS no/&#39;</span> /etc/ssh/sshd_config
systemctl  restart sshd.service
<span class="c1">#内核参数优化</span>
cat &gt;&gt; /etc/sysctl.conf <span class="s">&lt;&lt; EOF</span>
<span class="s">#CTCDN系统优化参数</span>
<span class="s">#关闭ipv6</span>
<span class="s">net.ipv6.conf.all.disable_ipv6 = 1</span>
<span class="s">net.ipv6.conf.default.disable_ipv6 = 1</span>
<span class="s">#决定检查过期多久邻居条目</span>
<span class="s">net.ipv4.neigh.default.gc_stale_time=120</span>
<span class="s">#使用arp_announce / arp_ignore解决ARP映射问题</span>
<span class="s">net.ipv4.conf.default.arp_announce = 2</span>
<span class="s">net.ipv4.conf.all.arp_announce=2</span>
<span class="s">net.ipv4.conf.lo.arp_announce=2</span>
<span class="s"># 避免放大攻击</span>
<span class="s">net.ipv4.icmp_echo_ignore_broadcasts = 1</span>
<span class="s"># 开启恶意icmp错误消息保护</span>
<span class="s">net.ipv4.icmp_ignore_bogus_error_responses = 1</span>
<span class="s">#开启路由转发</span>
<span class="s">net.ipv4.ip_forward = 1</span>
<span class="s">net.ipv4.conf.all.send_redirects = 1</span>
<span class="s">net.ipv4.conf.default.send_redirects = 1</span>
<span class="s">#开启反向路径过滤</span>
<span class="s">net.ipv4.conf.all.rp_filter = 1</span>
<span class="s">net.ipv4.conf.default.rp_filter = 1</span>
<span class="s">#处理无源路由的包</span>
<span class="s">net.ipv4.conf.all.accept_source_route = 0</span>
<span class="s">net.ipv4.conf.default.accept_source_route = 0</span>
<span class="s">#关闭sysrq功能</span>
<span class="s">kernel.sysrq = 0</span>
<span class="s">#core文件名中添加pid作为扩展名</span>
<span class="s">kernel.core_uses_pid = 1</span>
<span class="s"># 开启SYN洪水攻击保护</span>
<span class="s">net.ipv4.tcp_syncookies = 1</span>
<span class="s">#修改消息队列长度</span>
<span class="s">kernel.msgmnb = 65536</span>
<span class="s">kernel.msgmax = 65536</span>
<span class="s">#设置最大内存共享段大小bytes</span>
<span class="s">kernel.shmmax = 68719476736</span>
<span class="s">kernel.shmall = 4294967296</span>
<span class="s">#timewait的数量，默认180000</span>
<span class="s">net.ipv4.tcp_max_tw_buckets = 6000</span>
<span class="s">net.ipv4.tcp_sack = 1</span>
<span class="s">net.ipv4.tcp_window_scaling = 1</span>
<span class="s">net.ipv4.tcp_rmem = 4096        87380   4194304</span>
<span class="s">net.ipv4.tcp_wmem = 4096        16384   4194304</span>
<span class="s">net.core.wmem_default = 8388608</span>
<span class="s">net.core.rmem_default = 8388608</span>
<span class="s">net.core.rmem_max = 16777216</span>
<span class="s">net.core.wmem_max = 16777216</span>
<span class="s">#每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目</span>
<span class="s">net.core.netdev_max_backlog = 262144</span>
<span class="s">#限制仅仅是为了防止简单的DoS 攻击</span>
<span class="s">net.ipv4.tcp_max_orphans = 3276800</span>
<span class="s">#未收到客户端确认信息的连接请求的最大值</span>
<span class="s">net.ipv4.tcp_max_syn_backlog = 262144</span>
<span class="s">net.ipv4.tcp_timestamps = 0</span>
<span class="s">#内核放弃建立连接之前发送SYNACK 包的数量</span>
<span class="s">net.ipv4.tcp_synack_retries = 1</span>
<span class="s">#内核放弃建立连接之前发送SYN 包的数量</span>
<span class="s">net.ipv4.tcp_syn_retries = 1</span>
<span class="s">#启用timewait 快速回收</span>
<span class="s">net.ipv4.tcp_tw_recycle = 0</span>
<span class="s">#开启重用。允许将TIME-WAIT sockets 重新用于新的TCP 连接</span>
<span class="s">net.ipv4.tcp_tw_reuse = 1</span>
<span class="s">net.ipv4.tcp_mem = 94500000 915000000 927000000</span>
<span class="s">net.ipv4.tcp_fin_timeout = 1</span>
<span class="s">#当keepalive 起用的时候，TCP 发送keepalive 消息的频度。缺省是2 小时</span>
<span class="s">net.ipv4.tcp_keepalive_time = 1800</span>
<span class="s">net.ipv4.tcp_keepalive_probes = 3</span>
<span class="s">net.ipv4.tcp_keepalive_intvl = 15</span>
<span class="s">#允许系统打开的端口范围</span>
<span class="s">net.ipv4.ip_local_port_range = 1024    65000</span>
<span class="s">#修改防火墙表大小，默认65536</span>
<span class="s">net.netfilter.nf_conntrack_max=655350</span>
<span class="s">net.netfilter.nf_conntrack_tcp_timeout_established=1200</span>
<span class="s"># 确保无人能修改路由表</span>
<span class="s">net.ipv4.conf.all.accept_redirects = 0</span>
<span class="s">net.ipv4.conf.default.accept_redirects = 0</span>
<span class="s">net.ipv4.conf.all.secure_redirects = 0</span>
<span class="s">net.ipv4.conf.default.secure_redirects = 0</span>
<span class="s">EOF</span>
/sbin/sysctl -p
<span class="c1">#vim定义退格键可删除最后一个字符类型</span>
<span class="nb">echo</span> <span class="s1">&#39;alias vi=vim&#39;</span> &gt;&gt; /etc/profile
<span class="nb">echo</span> <span class="s1">&#39;stty erase ^H&#39;</span> &gt;&gt; /etc/profile
<span class="nb">echo</span> <span class="s1">&#39;curl ip.6655.com/ip.aspx&amp;&amp;echo&#39;</span> &gt;&gt; /etc/profile
cat &gt;&gt; /root/.vimrc <span class="s">&lt;&lt; EOF</span>
<span class="s">set tabstop=4</span>
<span class="s">set shiftwidth=4</span>
<span class="s">set expandtab</span>
<span class="s">syntax on</span>
<span class="s">&quot;set number</span>
<span class="s">EOF</span>
<span class="c1">#update soft</span>
yum -y update
cat <span class="s">&lt;&lt; EOF</span>
<span class="s">+-------------------------------------------------+</span>
<span class="s">|                优 化 已 完 成             |</span>
<span class="s">|             5s 后 重启 这台服务器 !       |</span>
<span class="s">+-------------------------------------------------+</span>
<span class="s">EOF</span>
sleep <span class="m">5</span>
<span class="nb">echo</span> -e <span class="s2">&quot;\n\033[31m请重启机器 使内核修改生效！！！\033[0m\n&quot;</span>  <span class="c1">##重启加载内核修改</span>
</pre></div>
</div>
</section>
<section id="id2">
<h2><a class="toc-backref" href="#id28"><span class="section-number">3.12.10. </span>备份数据库脚本</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#this scripts is backup_mysql_db</span>

<span class="nv">mysqldump</span><span class="o">=</span><span class="s2">&quot;/usr/local/mysql/bin/mysqldump&quot;</span>
<span class="nv">bakuser</span><span class="o">=</span><span class="s2">&quot;backup&quot;</span>
<span class="nv">passwd</span><span class="o">=</span><span class="s2">&quot;admin#123&quot;</span>
<span class="nv">bakdir</span><span class="o">=</span><span class="s2">&quot;/data/backup&quot;</span>
<span class="nv">remote_dir</span><span class="o">=</span><span class="s1">&#39;rsync://10.10.10.122/mysqlbak&#39;</span>
<span class="nv">d1</span><span class="o">=</span><span class="sb">`</span>date +%F<span class="sb">`</span>
<span class="nv">d2</span><span class="o">=</span><span class="sb">`</span>date +%d<span class="sb">`</span>

<span class="c1">#定义日志</span>
<span class="nb">exec</span> <span class="p">&amp;</span>&gt; /tmp/mysql_bak.log

<span class="nb">echo</span> <span class="s2">&quot;mysql backup begin at `date`&quot;</span>

<span class="c1">#对所有数据库进行遍历</span>
<span class="k">for</span> db <span class="k">in</span> item1 item2 item3 <span class="p">;</span> <span class="k">do</span>
    <span class="nv">$mysqldump</span> -u<span class="nv">$bakuser</span> -p<span class="nv">$passwd</span> <span class="nv">$db</span> &gt; <span class="nv">$bakdir</span>/<span class="nv">$db</span>-<span class="nv">$d1</span>.sql
<span class="k">done</span>

<span class="c1">#对1天前的所有sql文件压缩</span>
find <span class="nv">$bakdir</span>/ -type f -name <span class="s2">&quot;*.sql&quot;</span> -mtime +1 <span class="p">|</span>xargs gzip

<span class="c1">#查找一周以前的老文件，并删除</span>
find <span class="nv">$bakdir</span>/ -type f -mtime +7 <span class="p">|</span> xargs rm

<span class="c1">#当天备份文件同步到远程</span>
<span class="k">for</span> db <span class="k">in</span> item1 item2 item3 <span class="p">;</span> <span class="k">do</span>
    rsync -a <span class="nv">$bakdir</span>/<span class="nv">$db</span>-<span class="nv">$d1</span>.sql <span class="nv">$remote_dir</span>/<span class="nv">$db</span>-<span class="nv">$d2</span>.sql
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;mysql bacup end at `date`&quot;</span>
</pre></div>
</div>
</section>
<section id="s3">
<h2><a class="toc-backref" href="#id29"><span class="section-number">3.12.11. </span>备份数据库上传到S3存储库</a><a class="headerlink" href="#s3" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#</span>
<span class="c1"># Filename:</span>
<span class="c1"># backupdatabase.sh</span>
<span class="c1"># Description:</span>
<span class="c1"># backup cms database and remove backup data before 7 days</span>
<span class="c1"># crontab</span>
<span class="c1"># 55 23 * * * /bin/sh /yundisk/cms/crontab/backupdatabase.sh &gt;&gt; /yundisk/cms/crontab/backupdatabase.log 2&gt;&amp;1</span>

<span class="nv">DATE</span><span class="o">=</span><span class="sb">`</span>date +%Y-%m-%d<span class="sb">`</span>
<span class="nv">OLDDATE</span><span class="o">=</span><span class="sb">`</span>date +%Y-%m-%d -d <span class="s1">&#39;-7 days&#39;</span><span class="sb">`</span>

<span class="c1">#MYSQL=/usr/local/mysql/bin/mysql</span>
<span class="c1">#MYSQLDUMP=/usr/local/mysql/bin/mysqldump</span>
<span class="c1">#MYSQLADMIN=/usr/local/mysql/bin/mysqladmin</span>

<span class="nv">BACKDIR</span><span class="o">=</span>/yundisk/cms/database
<span class="o">[</span> -d <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span> <span class="o">]</span> <span class="o">||</span> mkdir -p <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>
<span class="o">[</span> -d <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span> <span class="o">]</span> <span class="o">||</span> mkdir <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>
<span class="o">[</span> ! -d <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">OLDDATE</span><span class="si">}</span> <span class="o">]</span> <span class="o">||</span> rm -rf <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">OLDDATE</span><span class="si">}</span>

mysqldump --default-character-set<span class="o">=</span>utf8 --no-autocommit --quick --hex-blob --single-transaction -uroot  cms_production  <span class="p">|</span> gzip &gt; <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>/cms-backup-<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>.sql.gz
<span class="nb">echo</span> <span class="s2">&quot;Database cms_production and bbs has been backup successful&quot;</span>
/bin/sleep <span class="m">5</span>

aws s3 cp <span class="si">${</span><span class="nv">BACKDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATE</span><span class="si">}</span>/* s3://example-share/cms/databackup/
</pre></div>
</div>
</section>
<section id="run-py">
<h2><a class="toc-backref" href="#id30"><span class="section-number">3.12.12. </span>控制进程数执行run.py脚本</a><a class="headerlink" href="#run-py" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
#每5分钟运行一次脚本

CE_HOME=&#39;/data/ContentEngine&#39;
LOG_PATH=&#39;/data/logs&#39;

# 控制爬虫数量为8
MAX_SPIDER_COUNT=8

# current count of spider
count=`ps -ef | grep -v grep | grep run.py | wc -l`
# 下面的逻辑是控制run.py进程数量始终为8，充分挖掘机器的性能，并且为了防止形成死循环，这里没有用while语句。
try_time=0
cd $CE_HOME
while [ $count -lt $MAX_SPIDER_COUNT -a $try_time -lt $MAX_SPIDER_COUNT ];do
    let try_time+=1
    python run.py &gt;&gt; ${LOG_PATH}/spider.log 2&gt;&amp;1 &amp;
    count=`ps -ef | grep -v grep | grep run.py | wc -l`
done
</pre></div>
</div>
</section>
<section id="id3">
<h2><a class="toc-backref" href="#id31"><span class="section-number">3.12.13. </span>转换数据库表存储引擎</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#/bin/bash</span>
<span class="nv">DB</span><span class="o">=</span>pharma
<span class="nv">USER</span><span class="o">=</span>root
<span class="nv">PASSWD</span><span class="o">=</span>root@change

/usr/local/mysql/bin/mysql  -u<span class="nv">$USER</span> -p<span class="nv">$PASSWD</span> <span class="nv">$DB</span> -e <span class="s2">&quot;select TABLE_NAME from information_schema.TABLES where TABLE_SCHEMA=&#39;&quot;</span><span class="nv">$DB</span><span class="s2">&quot;&#39; and ENGINE=&#39;&quot;</span>MyISAM<span class="s2">&quot;&#39;;&quot;</span> <span class="p">|</span> grep -v <span class="s2">&quot;TABLE_NAME&quot;</span> &gt; mysql_table.txt
cat  mysql_table.txt <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> LINE
<span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&quot;Starting convert table engine...&quot;</span>
    /usr/local/mysql/bin/mysql -u<span class="nv">$USER</span> -p<span class="nv">$PASSWD</span> <span class="nv">$DB</span> -e <span class="s2">&quot;alter table </span><span class="nv">$LINE</span><span class="s2">  engine=&#39;&quot;</span>InnoDB<span class="s2">&quot;&#39;&quot;</span>
    sleep <span class="m">1</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="id4">
<h2><a class="toc-backref" href="#id32"><span class="section-number">3.12.14. </span>监控网站状态脚本</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="nb">source</span> /etc/init.d/functions
<span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -ne <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> $<span class="s2">&quot;usage </span><span class="nv">$0</span><span class="s2"> url&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">[</span> <span class="sb">`</span>curl -o /dev/null --connect-timeout <span class="m">5</span> -s -w  <span class="s2">&quot;%{http_code}&quot;</span> <span class="nv">$1</span> <span class="p">|</span> egrep -w <span class="s2">&quot;200|301|302&quot;</span><span class="p">|</span>wc -l<span class="sb">`</span> -ne <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        action <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2"> is error.&quot;</span> /bin/false
        <span class="c1">#echo &quot;$1 is error.&quot;|mail -s &quot;$1 is error.&quot; 1879324764@qq.com</span>
     <span class="k">else</span>
        action <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2"> is ok &quot;</span> /bin/true
    <span class="k">fi</span>
    sleep <span class="m">10</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="httpd">
<h2><a class="toc-backref" href="#id33"><span class="section-number">3.12.15. </span>监控httpd服务状态脚本</a><a class="headerlink" href="#httpd" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:xxx.sh</span>
<span class="c1"># author：xiaojian</span>

<span class="nv">LogTime</span><span class="o">=</span><span class="k">$(</span>date +%Y%m%d-%T<span class="k">)</span>
<span class="nv">Log_File</span><span class="o">=</span><span class="s2">&quot;/home/check_httpd.log&quot;</span>

<span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
    <span class="nv">HTTPD_STATUS</span><span class="o">=</span><span class="sb">`</span>service httpd status <span class="p">|</span> grep running<span class="sb">`</span>
    <span class="k">if</span> <span class="nb">test</span> -z <span class="s2">&quot;</span><span class="nv">$HTTPD_STATUS</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$LogTime</span><span class="s2">  HTTPD is stopped, try to restart&quot;</span> &gt;&gt; <span class="nv">$Log_File</span>
        service httpd restart
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;HTTPD is running ,wait 2 sec until next check&quot;</span> <span class="p">&amp;</span>&gt;/dev/null
        sleep <span class="m">2</span>
    <span class="k">fi</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="nginx-stop-keepalived">
<h2><a class="toc-backref" href="#id34"><span class="section-number">3.12.16. </span>监控Nginx进程，如果尝试启动失败就stop Keepalived</a><a class="headerlink" href="#nginx-stop-keepalived" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="k">while</span> :
<span class="k">do</span>
    <span class="nv">nginxpid</span><span class="o">=</span><span class="sb">`</span>ps -C nginx --no-header <span class="p">|</span> wc -l<span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$nginxpid</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
        <span class="nb">ulimit</span> -SHn <span class="m">65535</span>
        /usr/local/nginx/sbin/nginx
        sleep <span class="m">5</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$nginxpid</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
            /etc/init.d/keepalived stop
        <span class="k">fi</span>
    <span class="k">fi</span>
sleep <span class="m">5</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id35"><span class="section-number">3.12.17. </span>进程控制示例</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="nv">pidpath</span><span class="o">=</span>/tmp/a.pid
<span class="k">if</span> <span class="nb">test</span> -f <span class="s2">&quot;</span><span class="nv">$pidpath</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">kill</span> <span class="sb">`</span>cat <span class="nv">$pidpath</span><span class="sb">`</span> &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>        <span class="c1">#杀掉与前一个进程对应的进程</span>
        rm -rf <span class="nv">$pidpath</span>

<span class="k">fi</span>
<span class="nb">echo</span> <span class="nv">$$</span> &gt; <span class="nv">$pidpath</span>      <span class="c1">##&lt;==将当前Shell进程号记录到pid文件里。</span>
sleep <span class="m">300</span>
</pre></div>
</div>
</section>
<section id="lnmp">
<h2><a class="toc-backref" href="#id36"><span class="section-number">3.12.18. </span>lnmp一键安装示例</a><a class="headerlink" href="#lnmp" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## written by aming.</span>
<span class="c1">## 2015-06-24.</span>

<span class="c1">#######Begin########</span>
<span class="nb">echo</span> <span class="s2">&quot;It will install lamp or lnmp.&quot;</span>
sleep <span class="m">1</span>
<span class="c1">##check last command is OK or not.</span>
check_ok<span class="o">()</span> <span class="o">{</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Error, Check the error log.&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>
<span class="o">}</span>
<span class="c1">##get the archive of the system,i686 or x86_64.</span>
<span class="nv">ar</span><span class="o">=</span><span class="sb">`</span>arch<span class="sb">`</span>
<span class="c1">##close seliux</span>
sed -i <span class="s1">&#39;s/SELINUX=enforcing/SELINUX=disabled/&#39;</span> /etc/selinux/config
<span class="nv">selinux_s</span><span class="o">=</span><span class="sb">`</span>getenforce<span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$selinux_s</span> <span class="o">==</span> <span class="s2">&quot;enforcing&quot;</span> <span class="o">]</span>
<span class="k">then</span>
    setenforce <span class="m">0</span>
<span class="k">fi</span>
<span class="c1">##close iptables</span>
iptables-save &gt; /etc/sysconfig/iptables_<span class="sb">`</span>date +%s<span class="sb">`</span>
iptables -F
service iptables save

<span class="c1">##if the packge installed ,then omit.</span>
myum<span class="o">()</span> <span class="o">{</span>
<span class="k">if</span> ! rpm -qa<span class="p">|</span>grep -q <span class="s2">&quot;^</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="k">then</span>
    yum install -y <span class="nv">$1</span>
    check_ok
<span class="k">else</span>
    <span class="nb">echo</span> <span class="nv">$1</span> already installed.
<span class="k">fi</span>
<span class="o">}</span>

<span class="c1">## install some packges.</span>
<span class="k">for</span> p <span class="k">in</span> gcc wget perl perl-devel libaio libaio-devel pcre-devel zlib-devel
<span class="k">do</span>
    myum <span class="nv">$p</span>
<span class="k">done</span>

<span class="c1">##install epel.</span>
<span class="k">if</span> rpm -qa epel-release &gt;/dev/null
<span class="k">then</span>
    rpm -e epel-release
<span class="k">fi</span>
<span class="k">if</span> ls /etc/yum.repos.d/epel-6.repo* &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="k">then</span>
    rm -f /etc/yum.repos.d/epel-6.repo*
<span class="k">fi</span>
wget -P /etc/yum.repos.d/ http://mirrors.aliyun.com/repo/epel-6.repo


<span class="c1">##function of installing mysqld.</span>
install_mysqld<span class="o">()</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nv">$mysql_v</span> <span class="k">in</span>
        <span class="m">5</span>.1<span class="o">)</span>
            <span class="nb">cd</span> /usr/local/src
            <span class="o">[</span> -f mysql-5.1.72-linux-<span class="nv">$ar</span>-glibc23.tar.gz <span class="o">]</span> <span class="o">||</span> wget http://mirrors.sohu.com/mysql/MySQL-5.1/mysql-5.1.72-linux-<span class="nv">$ar</span>-glibc23.tar.gz
            tar zxf mysql-5.1.72-linux-<span class="nv">$ar</span>-glibc23.tar.gz
            check_ok
            <span class="o">[</span> -d /usr/local/mysql <span class="o">]</span> <span class="o">&amp;&amp;</span> /bin/mv /usr/local/mysql /usr/local/mysql_<span class="sb">`</span>date +%s<span class="sb">`</span>
            mv mysql-5.1.72-linux-<span class="nv">$ar</span>-glibc23 /usr/local/mysql
            check_ok
            <span class="k">if</span> ! grep <span class="s1">&#39;^mysql:&#39;</span> /etc/passwd
            <span class="k">then</span>
                useradd -M mysql -s /sbin/nologin
                check_ok
            <span class="k">fi</span>
            myum compat-libstdc++-33
            <span class="o">[</span> -d /data/mysql <span class="o">]</span> <span class="o">&amp;&amp;</span> /bin/mv /data/mysql /data/mysql_<span class="sb">`</span>date +%s<span class="sb">`</span>
            mkdir -p /data/mysql
            chown -R mysql:mysql /data/mysql
            <span class="nb">cd</span> /usr/local/mysql
            ./scripts/mysql_install_db --user<span class="o">=</span>mysql --datadir<span class="o">=</span>/data/mysql
            check_ok
            /bin/cp support-files/my-huge.cnf /etc/my.cnf
            check_ok
            sed -i <span class="s1">&#39;/^\[mysqld\]$/a\datadir = /data/mysql&#39;</span> /etc/my.cnf
            /bin/cp support-files/mysql.server /etc/init.d/mysqld
            sed -i <span class="s1">&#39;s#^datadir=#datadir=/data/mysql#&#39;</span> /etc/init.d/mysqld
            chmod <span class="m">755</span> /etc/init.d/mysqld
            chkconfig --add mysqld
            chkconfig mysqld on
            service mysqld start
            check_ok
            <span class="nb">break</span>
            <span class="p">;;</span>
        <span class="m">5</span>.6<span class="o">)</span>
            <span class="nb">cd</span> /usr/local/src
            <span class="o">[</span> -f mysql-5.6.26-linux-glibc2.5-<span class="nv">$ar</span>.tar.gz <span class="o">]</span> <span class="o">||</span> wget http://mirrors.sohu.com/mysql/MySQL-5.6/mysql-5.6.26-linux-glibc2.5-<span class="nv">$ar</span>.tar.gz
            tar zxf mysql-5.6.26-linux-glibc2.5-<span class="nv">$ar</span>.tar.gz
            check_ok
            <span class="o">[</span> -d /usr/local/mysql <span class="o">]</span> <span class="o">&amp;&amp;</span> /bin/mv /usr/local/mysql /usr/local/mysql_bak
            mv mysql-5.6.26-linux-glibc2.5-<span class="nv">$ar</span> /usr/local/mysql
            <span class="k">if</span> ! grep <span class="s1">&#39;^mysql:&#39;</span> /etc/passwd
            <span class="k">then</span>
                useradd -M mysql -s /sbin/nologin
            <span class="k">fi</span>
            myum compat-libstdc++-33
            <span class="o">[</span> -d /data/mysql <span class="o">]</span> <span class="o">&amp;&amp;</span> /bin/mv /data/mysql /data/mysql_bak
            mkdir -p /data/mysql
            chown -R mysql:mysql /data/mysql
            <span class="nb">cd</span> /usr/local/mysql
            ./scripts/mysql_install_db --user<span class="o">=</span>mysql --datadir<span class="o">=</span>/data/mysql
            check_ok
            /bin/cp support-files/my-default.cnf /etc/my.cnf
            check_ok
            sed -i <span class="s1">&#39;/^\[mysqld\]$/a\datadir = /data/mysql&#39;</span> /etc/my.cnf
            /bin/cp support-files/mysql.server /etc/init.d/mysqld
            sed -i <span class="s1">&#39;s#^datadir=#datadir=/data/mysql#&#39;</span> /etc/init.d/mysqld
            chmod <span class="m">755</span> /etc/init.d/mysqld
            chkconfig --add mysqld
            chkconfig mysqld on
            service mysqld start
            check_ok
            <span class="nb">break</span>
            <span class="p">;;</span>

         *<span class="o">)</span>
            <span class="nb">echo</span> <span class="s2">&quot;only 1(5.1) or 2(5.6)&quot;</span>
            <span class="nb">exit</span> <span class="m">1</span>
            <span class="p">;;</span>
    <span class="k">esac</span>
<span class="o">}</span>

<span class="c1">##function of install httpd.</span>
install_httpd<span class="o">()</span> <span class="o">{</span>
<span class="nb">echo</span> <span class="s2">&quot;Install apache version 2.2.&quot;</span>
<span class="nb">cd</span> /usr/local/src
<span class="o">[</span> -f httpd-2.2.16.tar.gz <span class="o">]</span> <span class="o">||</span> wget  http://syslab.comsenz.com/downloads/linux/httpd-2.2.16.tar.gz
tar zxf  httpd-2.2.16.tar.gz <span class="o">&amp;&amp;</span> <span class="nb">cd</span> httpd-2.2.16
check_ok
./configure <span class="se">\</span>
--prefix<span class="o">=</span>/usr/local/apache2 <span class="se">\</span>
--with-included-apr <span class="se">\</span>
--enable-so <span class="se">\</span>
--enable-deflate<span class="o">=</span>shared <span class="se">\</span>
--enable-expires<span class="o">=</span>shared <span class="se">\</span>
--enable-rewrite<span class="o">=</span>shared <span class="se">\</span>
--with-pcre
check_ok
make <span class="o">&amp;&amp;</span> make install
check_ok
<span class="o">}</span>

<span class="c1">##function of install lamp&#39;s php.</span>
install_php<span class="o">()</span> <span class="o">{</span>
<span class="nb">echo</span> -e <span class="s2">&quot;Install php.\nPlease chose the version of php.&quot;</span>
    <span class="k">case</span> <span class="nv">$php_v</span> <span class="k">in</span>
        <span class="m">5</span>.4<span class="o">)</span>
            <span class="nb">cd</span> /usr/local/src/
            <span class="o">[</span> -f php-5.4.45.tar.bz2 <span class="o">]</span> <span class="o">||</span> wget <span class="s1">&#39;http://cn2.php.net/get/php-5.4.45.tar.bz2/from/this/mirror&#39;</span> -O php-5.4.45.tar.bz2
            tar jxf php-5.4.45.tar.bz2 <span class="o">&amp;&amp;</span> <span class="nb">cd</span> php-5.4.45

            <span class="k">for</span> p <span class="k">in</span> openssl-devel bzip2-devel <span class="se">\</span>
            libxml2-devel curl-devel libpng-devel <span class="se">\</span>
            libjpeg-devel freetype-devel libmcrypt-devel<span class="se">\</span>
            libtool-ltdl-devel perl-devel
            <span class="k">do</span>
                myum <span class="nv">$p</span>
            <span class="k">done</span>

            check_ok
            ./configure <span class="se">\</span>
            --prefix<span class="o">=</span>/usr/local/php <span class="se">\</span>
            --with-apxs2<span class="o">=</span>/usr/local/apache2/bin/apxs <span class="se">\</span>
            --with-config-file-path<span class="o">=</span>/usr/local/php/etc  <span class="se">\</span>
            --with-mysql<span class="o">=</span>/usr/local/mysql <span class="se">\</span>
            --with-libxml-dir <span class="se">\</span>
            --with-gd <span class="se">\</span>
            --with-jpeg-dir <span class="se">\</span>
            --with-png-dir <span class="se">\</span>
            --with-freetype-dir <span class="se">\</span>
            --with-iconv-dir <span class="se">\</span>
            --with-zlib-dir <span class="se">\</span>
            --with-bz2 <span class="se">\</span>
            --with-openssl <span class="se">\</span>
            --with-mcrypt <span class="se">\</span>
            --enable-soap <span class="se">\</span>
            --enable-gd-native-ttf <span class="se">\</span>
            --enable-mbstring <span class="se">\</span>
            --enable-sockets <span class="se">\</span>
            --enable-exif <span class="se">\</span>
            --disable-ipv6
            check_ok
            make <span class="o">&amp;&amp;</span> make install
            check_ok
            <span class="o">[</span> -f /usr/local/php/etc/php.ini <span class="o">]</span> <span class="o">||</span> /bin/cp php.ini-production  /usr/local/php/etc/php.ini
            <span class="nb">break</span>
            <span class="p">;;</span>
        <span class="m">5</span>.6<span class="o">)</span>
            <span class="nb">cd</span> /usr/local/src/
            <span class="o">[</span> -f php-5.6.6.tar.gz <span class="o">]</span> <span class="o">||</span> wget http://mirrors.sohu.com/php/php-5.6.6.tar.gz
            tar zxf php-5.6.6.tar.gz <span class="o">&amp;&amp;</span>   <span class="nb">cd</span> php-5.6.6
            <span class="k">for</span> p <span class="k">in</span> openssl-devel bzip2-devel <span class="se">\</span>
            libxml2-devel curl-devel libpng-devel <span class="se">\</span>
            libjpeg-devel freetype-devel libmcrypt-devel<span class="se">\</span>
            libtool-ltdl-devel perl-devel
            <span class="k">do</span>
                myum <span class="nv">$p</span>
            <span class="k">done</span>

            ./configure <span class="se">\</span>
            --prefix<span class="o">=</span>/usr/local/php <span class="se">\</span>
            --with-apxs2<span class="o">=</span>/usr/local/apache2/bin/apxs <span class="se">\</span>
            --with-config-file-path<span class="o">=</span>/usr/local/php/etc  <span class="se">\</span>
            --with-mysql<span class="o">=</span>/usr/local/mysql <span class="se">\</span>
            --with-libxml-dir <span class="se">\</span>
            --with-gd <span class="se">\</span>
            --with-jpeg-dir <span class="se">\</span>
            --with-png-dir <span class="se">\</span>
            --with-freetype-dir <span class="se">\</span>
            --with-iconv-dir <span class="se">\</span>
            --with-zlib-dir <span class="se">\</span>
            --with-bz2 <span class="se">\</span>
            --with-openssl <span class="se">\</span>
            --with-mcrypt <span class="se">\</span>
            --enable-soap <span class="se">\</span>
            --enable-gd-native-ttf <span class="se">\</span>
            --enable-mbstring <span class="se">\</span>
            --enable-sockets <span class="se">\</span>
            --enable-exif <span class="se">\</span>
            --disable-ipv6
            check_ok
            make <span class="o">&amp;&amp;</span> make install
            check_ok
            <span class="o">[</span> -f /usr/local/php/etc/php.ini <span class="o">]</span> <span class="o">||</span> /bin/cp php.ini-production  /usr/local/php/etc/php.ini
            <span class="nb">break</span>
            <span class="p">;;</span>

        *<span class="o">)</span>
            <span class="nb">echo</span> <span class="s2">&quot;only 1(5.4) or 2(5.6)&quot;</span>
            <span class="p">;;</span>
    <span class="k">esac</span>
<span class="o">}</span>

<span class="c1">##function of apache and php configue.</span>
join_apa_php<span class="o">()</span> <span class="o">{</span>
sed -i <span class="s1">&#39;/AddType .*.gz .tgz$/a\AddType application\/x-httpd-php .php&#39;</span> /usr/local/apache2/conf/httpd.conf
check_ok
sed -i <span class="s1">&#39;s/DirectoryIndex index.html/DirectoryIndex index.php index.html index.htm/&#39;</span> /usr/local/apache2/conf/httpd.conf
check_ok
cat &gt; /usr/local/apache2/htdocs/index.php <span class="s">&lt;&lt;EOF</span>
<span class="s">&lt;?php</span>
<span class="s">   phpinfo();</span>
<span class="s">?&gt;</span>
<span class="s">EOF</span>

<span class="k">if</span> /usr/local/php/bin/php -i <span class="p">|</span>grep -iq <span class="s1">&#39;date.timezone =&gt; no value&#39;</span>
<span class="k">then</span>
    sed -i <span class="s1">&#39;/;date.timezone =$/a\date.timezone = &quot;Asia\/Chongqing&quot;&#39;</span>  /usr/local/php/etc/php.ini
<span class="k">fi</span>

/usr/local/apache2/bin/apachectl restart
check_ok
<span class="o">}</span>

<span class="c1">##function of check service is running or not, example nginx, httpd, php-fpm.</span>
check_service<span class="o">()</span> <span class="o">{</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;phpfpm&quot;</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nv">s</span><span class="o">=</span><span class="s2">&quot;php-fpm&quot;</span>
<span class="k">else</span>
    <span class="nv">s</span><span class="o">=</span><span class="nv">$1</span>
<span class="k">fi</span>
<span class="nv">n</span><span class="o">=</span><span class="sb">`</span>ps aux <span class="p">|</span>grep <span class="s2">&quot;</span><span class="nv">$s</span><span class="s2">&quot;</span><span class="p">|</span>wc -l<span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$n</span> -gt <span class="m">1</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2"> service is already started.&quot;</span>
<span class="k">else</span>
    <span class="k">if</span> <span class="o">[</span> -f /etc/init.d/<span class="nv">$1</span> <span class="o">]</span>
    <span class="k">then</span>
        /etc/init.d/<span class="nv">$1</span> start
        check_ok
    <span class="k">else</span>
        install_<span class="nv">$1</span>
    <span class="k">fi</span>
<span class="k">fi</span>
<span class="o">}</span>

<span class="c1">##function of install lamp</span>
lamp<span class="o">()</span> <span class="o">{</span>
check_service mysqld
check_service httpd
install_php
join_apa_php
<span class="nb">echo</span> <span class="s2">&quot;LAMP done，Please use &#39;http://your ip/index.php&#39; to access.&quot;</span>
<span class="o">}</span>

<span class="c1">##function of install nginx</span>
install_nginx<span class="o">()</span> <span class="o">{</span>
<span class="nb">cd</span> /usr/local/src
<span class="o">[</span> -f nginx-1.8.0.tar.gz <span class="o">]</span> <span class="o">||</span> wget http://nginx.org/download/nginx-1.8.0.tar.gz
tar zxf nginx-1.8.0.tar.gz
<span class="nb">cd</span> nginx-1.8.0
myum pcre-devel
./configure --prefix<span class="o">=</span>/usr/local/nginx
check_ok
make <span class="o">&amp;&amp;</span> make install
check_ok
<span class="k">if</span> <span class="o">[</span> -f /etc/init.d/nginx <span class="o">]</span>
<span class="k">then</span>
    /bin/mv /etc/init.d/nginx  /etc/init.d/nginx_<span class="sb">`</span>date +%s<span class="sb">`</span>
<span class="k">fi</span>
curl http://www.apelearn.com/study_v2/.nginx_init  -o /etc/init.d/nginx
check_ok
chmod <span class="m">755</span> /etc/init.d/nginx
chkconfig --add nginx
chkconfig nginx on
curl http://www.apelearn.com/study_v2/.nginx_conf -o /usr/local/nginx/conf/nginx.conf
check_ok
service nginx start
check_ok
<span class="nb">echo</span> -e <span class="s2">&quot;&lt;?php\n    phpinfo();\n?&gt;&quot;</span> &gt; /usr/local/nginx/html/index.php
check_ok
<span class="o">}</span>

<span class="c1">##function of install php-fpm</span>
install_phpfpm<span class="o">()</span> <span class="o">{</span>
<span class="nb">echo</span> -e <span class="s2">&quot;Install php.\nPlease chose the version of php.&quot;</span>
    <span class="k">case</span> <span class="nv">$php_v</span> <span class="k">in</span>
        <span class="m">5</span>.4<span class="o">)</span>
            <span class="nb">cd</span> /usr/local/src/
            <span class="o">[</span> -f php-5.4.45.tar.bz2 <span class="o">]</span> <span class="o">||</span> wget <span class="s1">&#39;http://cn2.php.net/get/php-5.4.45.tar.bz2/from/this/mirror&#39;</span> -O php-5.4.45.tar.bz2
            tar jxf php-5.4.45.tar.bz2 <span class="o">&amp;&amp;</span> <span class="nb">cd</span> php-5.4.45
            <span class="k">for</span> p <span class="k">in</span>  openssl-devel bzip2-devel <span class="se">\</span>
            libxml2-devel curl-devel libpng-devel <span class="se">\</span>
            libjpeg-devel freetype-devel libmcrypt-devel<span class="se">\</span>
            libtool-ltdl-devel perl-devel
            <span class="k">do</span>
                myum <span class="nv">$p</span>
            <span class="k">done</span>
            <span class="k">if</span> ! grep -q <span class="s1">&#39;^php-fpm:&#39;</span> /etc/passwd
            <span class="k">then</span>
                useradd -M -s /sbin/nologin php-fpm
                check_ok
            <span class="k">fi</span>
            ./configure <span class="se">\</span>
            --prefix<span class="o">=</span>/usr/local/php-fpm <span class="se">\</span>
            --with-config-file-path<span class="o">=</span>/usr/local/php-fpm/etc <span class="se">\</span>
            --enable-fpm <span class="se">\</span>
            --with-fpm-user<span class="o">=</span>php-fpm <span class="se">\</span>
            --with-fpm-group<span class="o">=</span>php-fpm <span class="se">\</span>
            --with-mysql<span class="o">=</span>/usr/local/mysql <span class="se">\</span>
            --with-mysql-sock<span class="o">=</span>/tmp/mysql.sock <span class="se">\</span>
            --with-libxml-dir <span class="se">\</span>
            --with-gd <span class="se">\</span>
            --with-jpeg-dir <span class="se">\</span>
            --with-png-dir <span class="se">\</span>
            --with-freetype-dir <span class="se">\</span>
            --with-iconv-dir <span class="se">\</span>
            --with-zlib-dir <span class="se">\</span>
            --with-mcrypt <span class="se">\</span>
            --enable-soap <span class="se">\</span>
            --enable-gd-native-ttf <span class="se">\</span>
            --enable-ftp <span class="se">\</span>
            --enable-mbstring <span class="se">\</span>
            --enable-exif <span class="se">\</span>
            --enable-zend-multibyte <span class="se">\</span>
            --disable-ipv6 <span class="se">\</span>
            --with-pear <span class="se">\</span>
            --with-curl <span class="se">\</span>
            --with-openssl
            check_ok
            make <span class="o">&amp;&amp;</span> make install
            check_ok
            <span class="o">[</span> -f /usr/local/php-fpm/etc/php.ini <span class="o">]</span> <span class="o">||</span> /bin/cp php.ini-production  /usr/local/php-fpm/etc/php.ini
            <span class="k">if</span> /usr/local/php-fpm/bin/php -i <span class="p">|</span>grep -iq <span class="s1">&#39;date.timezone =&gt; no value&#39;</span>
            <span class="k">then</span>
                sed -i <span class="s1">&#39;/;date.timezone =$/a\date.timezone = &quot;Asia\/Chongqing&quot;&#39;</span>  /usr/local/php-fpm/etc/php.ini
                check_ok
            <span class="k">fi</span>
            <span class="o">[</span> -f /usr/local/php-fpm/etc/php-fpm.conf <span class="o">]</span> <span class="o">||</span> curl http://www.apelearn.com/study_v2/.phpfpm_conf -o /usr/local/php-fpm/etc/php-fpm.conf
            <span class="o">[</span> -f /etc/init.d/phpfpm <span class="o">]</span> <span class="o">||</span> /bin/cp sapi/fpm/init.d.php-fpm /etc/init.d/phpfpm
            chmod <span class="m">755</span> /etc/init.d/phpfpm
            chkconfig phpfpm on
            service phpfpm start
            check_ok
            <span class="nb">break</span>
            <span class="p">;;</span>
        <span class="m">5</span>.6<span class="o">)</span>
            <span class="nb">cd</span> /usr/local/src/
            <span class="o">[</span> -f php-5.6.6.tar.gz <span class="o">]</span> <span class="o">||</span> wget http://mirrors.sohu.com/php/php-5.6.6.tar.gz

            tar zxf php-5.6.6.tar.gz <span class="o">&amp;&amp;</span>   <span class="nb">cd</span> php-5.6.6
            <span class="k">for</span> p <span class="k">in</span>  openssl-devel bzip2-devel <span class="se">\</span>
            libxml2-devel curl-devel libpng-devel <span class="se">\</span>
            libjpeg-devel freetype-devel libmcrypt-devel<span class="se">\</span>
            libtool-ltdl-devel perl-devel
            <span class="k">do</span>
                myum <span class="nv">$p</span>
            <span class="k">done</span>

            <span class="k">if</span> ! grep -q <span class="s1">&#39;^php-fpm:&#39;</span> /etc/passwd
            <span class="k">then</span>
                useradd -M -s /sbin/nologin php-fpm
            <span class="k">fi</span>
            check_ok
            ./configure <span class="se">\</span>
            --prefix<span class="o">=</span>/usr/local/php-fpm <span class="se">\</span>
            --with-config-file-path<span class="o">=</span>/usr/local/php-fpm/etc <span class="se">\</span>
            --enable-fpm <span class="se">\</span>
            --with-fpm-user<span class="o">=</span>php-fpm <span class="se">\</span>
            --with-fpm-group<span class="o">=</span>php-fpm <span class="se">\</span>
            --with-mysql<span class="o">=</span>/usr/local/mysql <span class="se">\</span>
            --with-mysql-sock<span class="o">=</span>/tmp/mysql.sock <span class="se">\</span>
            --with-libxml-dir <span class="se">\</span>
            --with-gd <span class="se">\</span>
            --with-jpeg-dir <span class="se">\</span>
            --with-png-dir <span class="se">\</span>
            --with-freetype-dir <span class="se">\</span>
            --with-iconv-dir <span class="se">\</span>
            --with-zlib-dir <span class="se">\</span>
            --with-mcrypt <span class="se">\</span>
            --enable-soap <span class="se">\</span>
            --enable-gd-native-ttf <span class="se">\</span>
            --enable-ftp <span class="se">\</span>
            --enable-mbstring <span class="se">\</span>
            --enable-exif <span class="se">\</span>
            --disable-ipv6 <span class="se">\</span>
            --with-pear <span class="se">\</span>
            --with-curl <span class="se">\</span>
            --with-openssl
            check_ok
            make <span class="o">&amp;&amp;</span> make install
            check_ok
            <span class="o">[</span> -f /usr/local/php-fpm/etc/php.ini <span class="o">]</span> <span class="o">||</span> /bin/cp php.ini-production  /usr/local/php-fpm/etc/php.ini
            <span class="k">if</span> /usr/local/php-fpm/bin/php -i <span class="p">|</span>grep -iq <span class="s1">&#39;date.timezone =&gt; no value&#39;</span>
            <span class="k">then</span>
                sed -i <span class="s1">&#39;/;date.timezone =$/a\date.timezone = &quot;Asia\/Chongqing&quot;&#39;</span>  /usr/local/php-fpm/etc/php.ini
                check_ok
            <span class="k">fi</span>
            <span class="o">[</span> -f /usr/local/php-fpm/etc/php-fpm.conf <span class="o">]</span> <span class="o">||</span> curl http://www.apelearn.com/study_v2/.phpfpm_conf -o /usr/local/php-fpm/etc/php-fpm.conf
            check_ok
            <span class="o">[</span> -f /etc/init.d/phpfpm <span class="o">]</span> <span class="o">||</span> /bin/cp sapi/fpm/init.d.php-fpm /etc/init.d/phpfpm
            chmod <span class="m">755</span> /etc/init.d/phpfpm
            chkconfig phpfpm on
            service phpfpm start
            check_ok
            <span class="nb">break</span>
            <span class="p">;;</span>

        *<span class="o">)</span>
            <span class="nb">echo</span> <span class="s1">&#39;only 1(5.4) or 2(5.6)&#39;</span>
            <span class="p">;;</span>
    <span class="k">esac</span>
<span class="o">}</span>

<span class="c1">##function of install lnmp</span>
lnmp<span class="o">()</span> <span class="o">{</span>
check_service mysqld
check_service nginx
check_service phpfpm
<span class="nb">echo</span> <span class="s2">&quot;The lnmp done, Please use &#39;http://your ip/index.php&#39; to access.&quot;</span>
<span class="o">}</span>

<span class="nb">read</span> -p <span class="s2">&quot;Please chose which type env you install, (lamp|lnmp)? &quot;</span> t
<span class="k">case</span> <span class="nv">$t</span> <span class="k">in</span>
    lamp<span class="o">)</span>
        <span class="nb">read</span> -p <span class="s2">&quot;Please chose the version of mysql. (5.1|5.6)&quot;</span> mysql_v
        <span class="nb">read</span> -p <span class="s2">&quot;Please chose the version of php. (5.4|5.6)&quot;</span> php_v
        lamp
        <span class="p">;;</span>
    lnmp<span class="o">)</span>
        <span class="nb">read</span> -p <span class="s2">&quot;Please chose the version of mysql. (5.1|5.6)&quot;</span> mysql_v
        <span class="nb">read</span> -p <span class="s2">&quot;Please chose the version of php. (5.4|5.6)&quot;</span> php_v
        lnmp
        <span class="p">;;</span>
    *<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;Only &#39;lamp&#39; or &#39;lnmp&#39; your can input.&quot;</span>
        <span class="p">;;</span>
<span class="k">esac</span>
</pre></div>
</div>
</section>
<section id="id6">
<h2><a class="toc-backref" href="#id37"><span class="section-number">3.12.19. </span>服务器初始化脚本示例</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/bin:/sbin:/usr/sbin

<span class="c1">#root check</span>
<span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;</span><span class="nv">$UID</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Please run this scripts by root&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="c1">#define cmd var</span>
<span class="nv">SERVICE</span><span class="o">=</span><span class="sb">`</span>which service<span class="sb">`</span>
<span class="nv">CHKCONIFIG</span><span class="o">=</span><span class="sb">`</span>which chkconfig<span class="sb">`</span>

mod_yum<span class="o">(){</span>
    <span class="k">if</span> <span class="nb">test</span> -e /etc/yum.repos.d/CentOS-Base.repo<span class="p">;</span> <span class="k">then</span>
        cp /etc/yum.repos.d/CentOS-Base.repo<span class="o">{</span>,_bak<span class="o">}</span>
        wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo
    <span class="k">fi</span>
<span class="o">}</span>

close_selinux<span class="o">(){</span>
    <span class="c1">#close_selinux</span>
    sed -i <span class="s1">&#39;s/SELINUX=enforcing/SELINUX=disabled/&#39;</span> /etc/selinux/config

    <span class="c1">##grep SELINUX=disabled /etc/selinux/config</span>
    setenforce <span class="m">0</span> <span class="p">&amp;</span>&gt;/dev/null
<span class="o">}</span>

close_iptables<span class="o">(){</span>
    /etc/init.d/iptables stop
    /etc/init.d/iptables stop
    chkconfi iptables off
<span class="o">}</span>

least_service<span class="o">(){</span>

chkconfig<span class="p">|</span>awk <span class="s1">&#39;{print &quot;chkconfig&quot;,$1,&quot;off&quot;}&#39;</span><span class="p">|</span>bash
chkconfig<span class="p">|</span>egrep <span class="s2">&quot;crond|sshd|network|rsyslog|sysstat&quot;</span><span class="p">|</span>awk <span class="s1">&#39;{print &quot;chkconfig&quot;,$1,&quot;on&quot;}&#39;</span><span class="p">|</span>bash
<span class="c1">#export LANG=en</span>
<span class="c1"># chkconfig --list|grep 3:on</span>
<span class="o">}</span>

time_sync<span class="o">(){</span>
    <span class="nv">cron</span><span class="o">=</span>/var/spool/cron/root
    <span class="k">if</span> <span class="o">[</span> <span class="sb">`</span>grep -w <span class="s2">&quot;ntpdate&quot;</span> <span class="nv">$cron</span><span class="p">|</span>wc -l<span class="sb">`</span> -lt <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s1">&#39;#time sync by oldboy at 2010-2-1&#39;</span> &gt;&gt;<span class="nv">$cron</span>
        <span class="nb">echo</span> <span class="s1">&#39;*/5 * * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&#39;</span> &gt;&gt;<span class="nv">$cron</span>
        crontab -l
    <span class="k">fi</span>

<span class="o">}</span>
com_line_set<span class="o">(){</span>
<span class="c1">#7.command set.</span>
<span class="k">if</span> <span class="o">[</span> <span class="sb">`</span>egrep <span class="s2">&quot;TMOUT|HISTSIZE|ISTFILESIZE&quot;</span> /etc/profile<span class="p">|</span>wc -l<span class="sb">`</span> -lt <span class="m">3</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s1">&#39;export TMOUT=300&#39;</span> &gt;&gt;/etc/profile
    <span class="nb">echo</span> <span class="s1">&#39;export HISTSIZE=5&#39;</span> &gt;&gt;/etc/profile
    <span class="nb">echo</span> <span class="s1">&#39;export HISTFILESIZE=5&#39;</span> &gt;&gt;/etc/profile
    . /etc/profile
<span class="k">fi</span>
<span class="o">}</span>

open_file_set<span class="o">(){</span>
<span class="c1"># increase open file.</span>
    <span class="k">if</span> <span class="o">[</span><span class="sb">`</span>grep <span class="m">65535</span> /etc/security/limits.conf<span class="p">|</span>wc -l -lt <span class="m">1</span><span class="sb">`</span><span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s1">&#39;*           -      nofile        65535 &#39;</span> &gt;&gt;/etc/security/limits.conf
    tail -1 /etc/security/limits.conf
    <span class="k">fi</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id7">
<h2><a class="toc-backref" href="#id38"><span class="section-number">3.12.20. </span>服务启动脚本示例</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
. /etc/init.d/functions

usage<span class="o">(){</span>
    <span class="nb">echo</span> $<span class="s2">&quot;usage:</span><span class="nv">$0</span><span class="s2"> {start|stop|restart}&quot;</span>
    <span class="nb">exit</span>
<span class="o">}</span>

start<span class="o">(){</span>
    rsync --daemon
    sleep <span class="m">1</span>
    <span class="k">if</span> <span class="nb">test</span> <span class="sb">``</span>netstat -lntup<span class="p">|</span>grep rsync<span class="p">|</span>wc -l<span class="sb">`</span> -ge <span class="m">1</span><span class="sb">`</span><span class="p">;</span> <span class="k">then</span>
        action <span class="s2">&quot;rsync is started.&quot;</span> /bin/true
    <span class="k">else</span>
        action <span class="s2">&quot;rsyncd is started.&quot;</span> /bin/false
    <span class="k">fi</span>
<span class="o">}</span>
stop<span class="o">(){</span>
    killall rsync <span class="p">&amp;</span>&gt;/dev/null
    sleep <span class="m">2</span>
    <span class="k">if</span> <span class="nb">test</span> <span class="sb">`</span>netstat -lntup<span class="p">|</span>grep rsync<span class="p">|</span>wc -l<span class="sb">`</span> -eq <span class="m">0</span><span class="p">;</span> <span class="k">then</span>
        action <span class="s2">&quot;rsyncd is stopped. &quot;</span> /bin/true
    <span class="k">else</span>
        action <span class="s2">&quot;rsyncd is started.&quot;</span> /bin/false
    <span class="k">fi</span>
<span class="o">}</span>

main <span class="o">(){</span>
    <span class="k">if</span>  <span class="o">[</span> <span class="nv">$#</span> -ne <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        usage
    <span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        start
    <span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;stop&quot;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
        stop
    <span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;restart&quot;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
        stop
        sleep <span class="m">1</span>
        start
    <span class="k">else</span>
        usage
    <span class="k">fi</span>
<span class="o">}</span>
</pre></div>
</div>
<p>eg2</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:xxx.sh</span>
<span class="c1"># author：xiaojian</span>
<span class="c1"># Starts the at daemon</span>
<span class="c1">#chkconfig: 345 95 5</span>
<span class="c1"># 345 默认开启atd</span>
<span class="c1"># 955 默认设置为on的时候是95</span>
<span class="c1"># 5 默认设置为off的时候是5</span>

<span class="c1"># Source function library</span>
. /etc/init.d/functions

<span class="o">[</span> -f /etc/sysconfig/atd <span class="o">]</span> <span class="o">&amp;&amp;</span> . /etc/sysconfig/atd
<span class="nb">test</span> -x /usr/sbin/atd <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>
<span class="nv">RETVAL</span><span class="o">=</span><span class="m">0</span>

<span class="nv">prog</span> <span class="o">=</span> <span class="s2">&quot;atd&quot;</span>
start<span class="o">()</span> <span class="o">{</span>
<span class="c1"># Check if atd is already running</span>
    <span class="k">if</span> <span class="o">[</span> ! -f /var/lock/subsys/atd <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -n $<span class="s2">&quot;Starting </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
        daemon /usr/sbin/atd <span class="nv">$OPTS</span> <span class="o">&amp;&amp;</span> success <span class="o">||</span> failure
        <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
        <span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> touch /var/lock/subsys/atd
        <span class="nb">echo</span>
    <span class="k">fi</span>
    <span class="k">return</span> <span class="nv">$RETVAL</span>
<span class="o">}</span>

stop<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> -n $<span class="s2">&quot;Stopping </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
    killproc /usr/sbin/atd
    <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
    <span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -f /var/lock/subsys/atd
    <span class="nb">echo</span>
    <span class="k">return</span> <span class="nv">$RETVAL</span>
<span class="o">}</span>

restart<span class="o">()</span> <span class="o">{</span>
    stop
    start
<span class="o">}</span>

reload<span class="o">()</span> <span class="o">{</span>
    restart
<span class="o">}</span>

<span class="c1">#是调用/etc/init.d/functions 中定义的函数status</span>
status_at<span class="o">()</span> <span class="o">{</span>
    status /usr/sbin/atd
<span class="o">}</span>

<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
start<span class="o">)</span>
    start
   <span class="p">;;</span>
stop<span class="o">)</span>
    stop
   <span class="p">;;</span>
restart<span class="p">|</span>reload<span class="o">)</span>
    restart
   <span class="p">;;</span>
condrestart<span class="o">)</span>
    <span class="k">if</span> <span class="nb">test</span> -f /var/lock/subsys/atd<span class="p">;</span> <span class="k">then</span>
        restart
    <span class="k">fi</span>
   <span class="p">;;</span>
status<span class="o">)</span>
    status_at
   <span class="p">;;</span>
*<span class="o">)</span>
    <span class="nb">echo</span>  -e <span class="s2">&quot;\033[31mUsage :`basename </span><span class="nv">$0</span><span class="s2">` {Start|Stop|Restart|condrestart|status}\033[0m&quot;</span>
   <span class="p">;;</span>
<span class="k">esac</span>
<span class="nb">exit</span> <span class="nv">$?</span>
<span class="nb">exit</span> <span class="nv">$RETVAL</span>
</pre></div>
</div>
<p>eg3</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="c1"># chkconfig: 2345 55 25</span>
<span class="c1"># description: Redis Service</span>

<span class="c1">### BEGIN INIT INFO</span>
<span class="c1"># Provides:          Redis</span>
<span class="c1"># Required-Start:    $all</span>
<span class="c1"># Required-Stop:     $all</span>
<span class="c1"># Default-Start:     2 3 4 5</span>
<span class="c1"># Default-Stop:      0 1 6</span>
<span class="c1"># Short-Description: starts Redisrm -</span>
<span class="c1"># Description:       starts the BT-Web</span>
<span class="c1">### END INIT INFO</span>

<span class="c1"># Simple Redis init.d script conceived to work on Linux systems</span>
<span class="c1"># as it does use of the /proc filesystem.</span>

<span class="nv">REDISPORT</span><span class="o">=</span><span class="m">6379</span>
<span class="nv">EXEC</span><span class="o">=</span><span class="s2">&quot;/usr/local/redis/bin/redis-server&quot;</span>
<span class="nv">CLIEXEC</span><span class="o">=</span><span class="s2">&quot;/usr/local/redis/bin/redis-cli&quot;</span>
<span class="nv">LOF_file</span><span class="o">=</span><span class="s2">&quot;/usr/local/redis/redis.log&quot;</span>
<span class="nv">PIDFILE</span><span class="o">=</span><span class="s2">&quot;/var/run/redis.pid&quot;</span>
<span class="nv">CONF</span><span class="o">=</span><span class="s2">&quot;/usr/local/redis/redis.conf&quot;</span>

redis_start<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$PIDFILE</span> <span class="o">]</span>
    <span class="k">then</span>
            <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$PIDFIILE</span><span class="s2"> exists, process is already running or crashed&quot;</span>
    <span class="k">else</span>
            <span class="nb">echo</span> <span class="s2">&quot;Starting Redis server...&quot;</span>
            nohup <span class="nv">$EXEC</span> <span class="nv">$CONF</span> &gt;&gt; <span class="nv">$LOF_file</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>
    <span class="k">fi</span>
<span class="o">}</span>
redis_stop<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$PIDFILE</span> <span class="o">]</span>
    <span class="k">then</span>
            <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$PIDFILE</span><span class="s2"> does not exist, process is not running&quot;</span>
    <span class="k">else</span>
            <span class="nv">PID</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$PIDFILE</span><span class="k">)</span>
            <span class="nb">echo</span> <span class="s2">&quot;Stopping ...&quot;</span>
            <span class="nv">$CLIEXEC</span> -p <span class="nv">$REDISPORT</span> shutdown
            rm -rf <span class="nv">$PIDFILE</span>
            <span class="k">while</span> <span class="o">[</span> -x /proc/<span class="si">${</span><span class="nv">PID</span><span class="si">}</span> <span class="o">]</span>
            <span class="k">do</span>
                <span class="nb">echo</span> <span class="s2">&quot;Waiting for Redis to shutdown ...&quot;</span>
                sleep <span class="m">1</span>
            <span class="k">done</span>
            <span class="nb">echo</span> <span class="s2">&quot;Redis stopped&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>


<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
    start<span class="o">)</span>
        redis_start
        <span class="p">;;</span>
    stop<span class="o">)</span>
        redis_stop
        <span class="p">;;</span>
    restart<span class="p">|</span>reload<span class="o">)</span>
        <span class="si">${</span><span class="nv">0</span><span class="si">}</span> stop
        <span class="si">${</span><span class="nv">0</span><span class="si">}</span> start
        <span class="p">;;</span>
    *<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;Please use start or stop as first argument&quot;</span>
        <span class="p">;;</span>
<span class="k">esac</span>
</pre></div>
</div>
<p>eg4</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:${NAME}.sh</span>
<span class="c1"># author：xiaojian</span>
<span class="nv">PID</span><span class="o">=</span><span class="s2">&quot;/usr/local/squid/var/run/squid&quot;</span>
<span class="nv">CONF</span><span class="o">=</span><span class="s1">&#39;/etc/squid.conf&#39;</span>
<span class="nv">CMD</span><span class="o">=</span><span class="s1">&#39;/usr/local/squid/sbin/squid&#39;</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
    start<span class="o">)</span>
        netstat -anpt<span class="p">|</span> grep squid <span class="p">&amp;</span>&gt;/dev/null
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nb">echo</span> <span class="s2">&quot;squid is running&quot;</span>
         <span class="k">else</span>
            <span class="nb">echo</span> <span class="s2">&quot;正在启动Squid&quot;</span>
            <span class="nv">$CMD</span>
        <span class="k">fi</span>
       <span class="p">;;</span>
    stop<span class="o">)</span>
        <span class="nv">$CMD</span> -k <span class="nb">kill</span> <span class="p">&amp;</span> &gt;/dev/null
        rm -rf <span class="nv">$PID</span> <span class="p">&amp;</span> &gt; /dev/null

       <span class="p">;;</span>
    status<span class="o">)</span>
        <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$PID</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            netstat -anpt<span class="p">|</span> grep squid
        <span class="k">else</span>
            <span class="nb">echo</span> <span class="s2">&quot;Squid is not running.&quot;</span>
        <span class="k">fi</span>
       <span class="p">;;</span>
    restart<span class="o">)</span>
        <span class="nv">$0</span> stop <span class="p">&amp;</span> &gt;/dev/null
        <span class="nb">echo</span> <span class="s2">&quot;正在关闭Squid......&quot;</span>
        <span class="nv">$0</span> start <span class="p">&amp;</span> &gt;/dev/null
        <span class="nb">echo</span> <span class="s2">&quot;正在启动Squid.....&quot;</span>
       <span class="p">;;</span>

    reload<span class="o">)</span>
        <span class="nv">$CMD</span> -k reconfigure
       <span class="p">;;</span>

    check<span class="o">)</span>
        <span class="nv">$CMD</span> -k parse
       <span class="p">;;</span>

    *<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> {start|stop|restart|reload|check|status}&quot;</span>
       <span class="p">;;</span>
<span class="k">esac</span>
</pre></div>
</div>
</section>
<section id="id8">
<h2><a class="toc-backref" href="#id39"><span class="section-number">3.12.21. </span>监控mysql数据库示例</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#方法1</span>
<span class="k">if</span> <span class="o">[</span> <span class="sb">`</span>lsof -i tcp:3306<span class="p">|</span>wc -l<span class="sb">`</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="c1">#&lt;==过滤端口转成数字，很优秀的取值判断方法。</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;MySQL is Running.&quot;</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;MySQL is Stopped.&quot;</span>
    /etc/init.d/mysqld start
<span class="k">fi</span>

<span class="c1">#方法2</span>

<span class="k">if</span> <span class="o">[</span> <span class="sb">`</span>ps aux<span class="p">|</span> grep -v grep <span class="p">|</span> grep mysql <span class="p">|</span>wc - l<span class="sb">`</span>  -gt <span class="m">0</span><span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span>  <span class="s2">&quot;Mysql is Running&quot;</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;Mysql is Stopped. &quot;</span>
    /etc/init.d/mysqld start
<span class="k">fi</span>
</pre></div>
</div>
</section>
<section id="tar-var-log">
<h2><a class="toc-backref" href="#id40"><span class="section-number">3.12.22. </span>每周五使用tar命令备份/var/log下的所有日志文件</a><a class="headerlink" href="#tar-var-log" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#usage:每周五使用tar命令备份/var/log下的所有日志文件</span>
<span class="c1">#scripts_name:logbak.sh</span>

<span class="c1">#编写计划任务，执行备份脚本</span>
<span class="c1"># crontab -e</span>
<span class="c1">#00 03 * * 5 /root/logbak.sh</span>
tar -zcf log-<span class="sb">`</span>date +%Y%m%d<span class="sb">`</span>.tar.gz /var/log
</pre></div>
</div>
</section>
<section id="id9">
<h2><a class="toc-backref" href="#id41"><span class="section-number">3.12.23. </span>一些常用的函数</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#判断是否是false</span>
is_false<span class="o">()</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
    <span class="o">[</span>fF<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>nN<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>nN<span class="o">][</span>oO<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>fF<span class="o">][</span>aA<span class="o">][</span>lL<span class="o">][</span>sS<span class="o">][</span>eE<span class="o">]</span> <span class="p">|</span> <span class="m">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="m">0</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>

<span class="c1">#判断进程是否运行</span>
is_running<span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">read</span> pid &lt; <span class="nv">$1</span>
        <span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;/proc/</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="k">return</span> <span class="m">0</span>
        <span class="k">fi</span>
    <span class="k">fi</span>
    <span class="k">return</span> -1
<span class="o">}</span>

<span class="c1">#安装epel源</span>
<span class="k">function</span> _install_epel <span class="o">{</span>
    <span class="c1"># NOTE: We always remove and install latest -- some environments</span>
    <span class="c1"># use snapshot images, and if EPEL version updates they break</span>
    <span class="c1"># unless we update them to latest version.</span>
    <span class="k">if</span> sudo yum repolist enabled epel <span class="p">|</span> grep -q <span class="s1">&#39;epel&#39;</span><span class="p">;</span> <span class="k">then</span>
        uninstall_package epel-release <span class="o">||</span> <span class="nb">true</span>
    <span class="k">fi</span>

    <span class="c1"># This trick installs the latest epel-release from a bootstrap</span>
    <span class="c1"># repo, then removes itself (as epel-release installed the</span>
    <span class="c1"># &quot;real&quot; repo).</span>
    <span class="c1">#</span>
    <span class="c1"># You would think that rather than this, you could use</span>
    <span class="c1"># $releasever directly in .repo file we create below.  However</span>
    <span class="c1"># RHEL gives a $releasever of &quot;6Server&quot; which breaks the path;</span>
    <span class="c1"># see https://bugzilla.redhat.com/show_bug.cgi?id=1150759</span>
    cat <span class="s">&lt;&lt;EOF | sudo tee /etc/yum.repos.d/epel-bootstrap.repo</span>
<span class="s">[epel-bootstrap]</span>
<span class="s">name=Bootstrap EPEL</span>
<span class="s">mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=epel-7&amp;arch=\$basearch</span>
<span class="s">failovermethod=priority</span>
<span class="s">enabled=0</span>
<span class="s">gpgcheck=0</span>
<span class="s">EOF</span>
    <span class="c1"># Enable a bootstrap repo.  It is removed after finishing</span>
    <span class="c1"># the epel-release installation.</span>
    is_package_installed yum-utils <span class="o">||</span> install_package yum-utils
    sudo yum-config-manager --enable epel-bootstrap
    yum_install epel-release <span class="o">||</span> <span class="se">\</span>
        die <span class="nv">$LINENO</span> <span class="s2">&quot;Error installing EPEL repo, cannot continue&quot;</span>
    sudo rm -f /etc/yum.repos.d/epel-bootstrap.repo
<span class="o">}</span>

<span class="c1">#记录日志的function</span>
<span class="k">function</span> fnLogInfo<span class="o">()</span>
<span class="o">{</span>
        <span class="nb">local</span> <span class="nv">infomsg</span><span class="o">=</span><span class="nv">$1</span>
        <span class="nb">echo</span> <span class="si">${</span><span class="nv">infomsg</span><span class="si">}</span>
        <span class="nb">echo</span> <span class="sb">`</span>date <span class="s2">&quot;</span><span class="si">${</span><span class="nv">data_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="sb">`</span> <span class="s2">&quot;Info:</span><span class="si">${</span><span class="nv">infomsg</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; <span class="si">${</span><span class="nv">log_file</span><span class="si">}</span>
<span class="o">}</span>


<span class="c1">#备份文件的function</span>
fnBackupBeforeModify<span class="o">()</span>
<span class="o">{</span>
        <span class="nb">local</span> <span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
        <span class="nb">local</span> <span class="nv">backupFile</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">file</span><span class="si">}</span><span class="s2">.bak&quot;</span>

        fnLogInfo <span class="s2">&quot;Start to backup file </span><span class="nv">$file</span><span class="s2">&quot;</span>

        cp <span class="si">${</span><span class="nv">file</span><span class="si">}</span> -p <span class="si">${</span><span class="nv">backupFile</span><span class="si">}</span>

        fnLogInfo <span class="s2">&quot;End to backup file </span><span class="nv">$file</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># 1. change the network config as DHCP</span>
<span class="c1"># 2. delete the 70-persistent-net.rules file</span>
fnModifyNetworkConfig<span class="o">()</span>
<span class="o">{</span>
        fnLogInfo <span class="s2">&quot;----------------------------------------&quot;</span>
        fnLogInfo <span class="s2">&quot;Start to modify the network configuration&quot;</span>

        <span class="nb">local</span> <span class="nv">files</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

        <span class="c1">#1. change the network config as DHCP</span>
        <span class="k">case</span> <span class="nv">$os_type</span> <span class="k">in</span>

        <span class="c1">#/etc/sysconfig/network-scripts</span>
        <span class="s2">&quot;redhat&quot;</span><span class="o">)</span>
        <span class="nv">files</span><span class="o">=</span><span class="s2">&quot;`ls /etc/sysconfig/network-scripts/ifcfg-eth* |grep -v .bak`&quot;</span>
        <span class="nv">files</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">files</span><span class="si">}</span><span class="s2"> `ls /etc/sysconfig/network-scripts/ifcfg-ens* |grep -v .bak`&quot;</span>
        <span class="k">for</span> file <span class="k">in</span> <span class="nv">$files</span>
        <span class="k">do</span>
            fnLogInfo <span class="s2">&quot;Start to modify the network configuration: </span><span class="nv">$file</span><span class="s2">&quot;</span>
            <span class="c1">#backup  the file</span>
            fnBackupBeforeModify <span class="nv">$file</span>
            <span class="c1">#modify the file</span>
            sed -i <span class="s1">&#39;/PERSISTENT_DHCLIENT/d&#39;</span> <span class="nv">$file</span>
            sed -i <span class="s1">&#39;$a\PERSISTENT_DHCLIENT=yes&#39;</span> <span class="nv">$file</span>
            fnLogInfo <span class="s2">&quot;End to modify the network configuration: </span><span class="nv">$file</span><span class="s2">&quot;</span>
        <span class="k">done</span>
        <span class="p">;;</span>

        <span class="c1">#/etc/sysconfig/network/dhcp</span>
        <span class="s2">&quot;suse&quot;</span><span class="o">)</span>
        <span class="nv">file</span><span class="o">=</span><span class="s1">&#39;/etc/sysconfig/network/dhcp&#39;</span>

        <span class="c1">#first backup file</span>
        fnBackupBeforeModify <span class="nv">$file</span>

        sed -i <span class="s2">&quot;s/DHCLIENT_USE_LAST_LEASE=yes\|DHCLIENT_USE_LAST_LEASE=&#39;yes&#39;\|DHCLIENT_USE_LAST_LEASE=\&quot;yes\&quot;/DHCLIENT_USE_LAST_LEASE=\&quot;no\&quot;/g&quot;</span> <span class="nv">$file</span>
        <span class="p">;;</span>

        <span class="c1">#/etc/network/interfaces</span>
        <span class="s2">&quot;debian&quot;</span> <span class="p">|</span> <span class="s2">&quot;ubuntu&quot;</span><span class="o">)</span>
        <span class="nv">file</span><span class="o">=</span><span class="s1">&#39;/etc/network/interfaces&#39;</span>

        <span class="c1">#backup the file</span>
        fnBackupBeforeModify <span class="nv">$file</span>

        sed -i <span class="s2">&quot;s/static\| manual/ dhcp/g&quot;</span> <span class="nv">$file</span>
        sed -i <span class="s2">&quot;s/address /#address /g&quot;</span> <span class="nv">$file</span>
        sed -i <span class="s2">&quot;s/netmask /#netmask /g&quot;</span> <span class="nv">$file</span>
        sed -i <span class="s2">&quot;s/gateway /#gateway /g&quot;</span> <span class="nv">$file</span>

        <span class="p">;;</span>

        *<span class="o">)</span>
        fnLogInfo <span class="s2">&quot;Other Linux, network configuration cannot be modified.&quot;</span>
        <span class="p">;;</span>
        <span class="k">esac</span>

        <span class="c1">#2. delete the 70-persistent-net.rules file</span>
        rm -rf /etc/udev/rules.d/70-persistent-net.rules

        fnLogInfo <span class="s2">&quot;Delete 70-persistent-net.rules file, resut: </span><span class="nv">$?</span><span class="s2">&quot;</span>

        fnLogInfo <span class="s2">&quot;End to modify the network configuration&quot;</span>
<span class="o">}</span>
<span class="c1">#check OS的function</span>
fnGetOSType<span class="o">()</span>
<span class="o">{</span>
        fnLogInfo <span class="s2">&quot;---------------------------&quot;</span>
        fnLogInfo <span class="s2">&quot;Start to get the os type&quot;</span>

        <span class="nb">local</span> <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;/proc/version&quot;</span>
        <span class="k">if</span> ! <span class="o">[</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">version</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
            <span class="k">return</span> <span class="m">1</span>
        <span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="k">$(</span>grep -i <span class="s1">&#39;suse&#39;</span> <span class="si">${</span><span class="nv">version</span><span class="si">}</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
            <span class="nv">os_type</span><span class="o">=</span><span class="s1">&#39;suse&#39;</span>
        <span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="k">$(</span>grep -i <span class="s1">&#39;ubuntu&#39;</span> <span class="si">${</span><span class="nv">version</span><span class="si">}</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
            <span class="nv">os_type</span><span class="o">=</span><span class="s1">&#39;ubuntu&#39;</span>
        <span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="k">$(</span>grep -i <span class="s1">&#39;Red Hat&#39;</span> <span class="si">${</span><span class="nv">version</span><span class="si">}</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
            <span class="nv">os_type</span><span class="o">=</span><span class="s1">&#39;redhat&#39;</span>
                <span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="k">$(</span>grep -i <span class="s1">&#39;debian&#39;</span> <span class="si">${</span><span class="nv">version</span><span class="si">}</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
            <span class="nv">os_type</span><span class="o">=</span><span class="s1">&#39;debian&#39;</span>
        <span class="k">fi</span>


        fnLogInfo <span class="s2">&quot;End to get the os type: </span><span class="nv">$os_type</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1">#输入选择Yes和No函数</span>
YES_NO_choice<span class="o">(){</span>
<span class="nb">read</span> -t <span class="m">10</span> -p <span class="s2">&quot;Please input you commit ,wait 5.....to exit: &quot;</span> input

<span class="k">case</span> <span class="nv">$input</span> <span class="k">in</span>
    <span class="o">[</span>yY<span class="o">]</span><span class="p">|</span><span class="o">[</span>yY<span class="o">][</span>eE<span class="o">][</span>sS<span class="o">]</span> <span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;YES!!!!!&quot;</span>
        <span class="p">;;</span>
    <span class="o">[</span>nN<span class="o">]</span><span class="p">|</span><span class="o">[</span>nN<span class="o">][</span>oO<span class="o">]</span> <span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;NO  Error!!!!!&quot;</span>
        <span class="p">;;</span>
        *<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;============================&quot;</span>
        <span class="p">;;</span>

<span class="k">esac</span>

<span class="c1">#错误提示函数</span>
die <span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;ERROR: </span><span class="nv">$1</span><span class="s2">. Aborting!&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="o">}</span>

<span class="c1">#判断用户输入如果没有输入，选择默认值 redis为例</span>
<span class="nv">_REDIS_PORT</span><span class="o">=</span><span class="m">6379</span>
<span class="nv">_MANUAL_EXECUTION</span><span class="o">=</span><span class="nb">false</span>     <span class="c1">#标志信息</span>
check_input_redis_port<span class="o">(){</span>
<span class="k">if</span> ! <span class="nb">echo</span> <span class="nv">$REDIS_PORT</span> <span class="p">|</span> egrep -q <span class="s1">&#39;^[0-9]+$&#39;</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">_MANUAL_EXECUTION</span><span class="o">=</span><span class="nb">true</span>      <span class="c1">#重置标志信息</span>
    <span class="c1">#Read the redis port</span>
    <span class="nb">read</span>  -p <span class="s2">&quot;Please select the redis port for this instance: [</span><span class="nv">$_REDIS_PORT</span><span class="s2">] &quot;</span> REDIS_PORT
    <span class="k">if</span> ! <span class="nb">echo</span> <span class="nv">$REDIS_PORT</span> <span class="p">|</span> egrep -q <span class="s1">&#39;^[0-9]+$&#39;</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Selecting default: </span><span class="nv">$_REDIS_PORT</span><span class="s2">&quot;</span>
        <span class="nv">REDIS_PORT</span><span class="o">=</span><span class="nv">$_REDIS_PORT</span>
    <span class="k">fi</span>
<span class="k">fi</span>
<span class="o">}</span>


Get_OS_Bit<span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="sb">`</span>getconf WORD_BIT<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;32&#39;</span> <span class="o">&amp;&amp;</span> <span class="sb">`</span>getconf LONG_BIT<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;64&#39;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nv">Is_64bit</span><span class="o">=</span><span class="s1">&#39;y&#39;</span>
    <span class="k">else</span>
        <span class="nv">Is_64bit</span><span class="o">=</span><span class="s1">&#39;n&#39;</span>
    <span class="k">fi</span>
<span class="o">}</span>


Download_Files<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">local</span> <span class="nv">URL</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local</span> <span class="nv">FileName</span><span class="o">=</span><span class="nv">$2</span>
    <span class="k">if</span> <span class="o">[</span> -s <span class="s2">&quot;</span><span class="si">${</span><span class="nv">FileName</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">FileName</span><span class="si">}</span><span class="s2"> [found]&quot;</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;Notice: </span><span class="si">${</span><span class="nv">FileName</span><span class="si">}</span><span class="s2"> not found!!!download now...&quot;</span>
        wget -c --progress<span class="o">=</span>bar:force --prefer-family<span class="o">=</span>IPv4 --no-check-certificate <span class="si">${</span><span class="nv">URL</span><span class="si">}</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c1">#批量安装基础包</span>
CentOS_Dependent<span class="o">()</span>
<span class="o">{</span>
    <span class="se">\c</span>p /etc/yum.conf /etc/yum.conf.lnmp
    sed -i <span class="s1">&#39;s:exclude=.*:exclude=:g&#39;</span> /etc/yum.conf

    Echo_Blue <span class="s2">&quot;[+] Yum installing dependent packages...&quot;</span>
    <span class="k">for</span> packages <span class="k">in</span> make cmake gcc gcc-c++ gcc-g77 flex bison file libtool libtool-libs autoconf kernel-devel patch wget crontabs libjpeg libjpeg-devel libpng libpng-devel libpng10 libpng10-devel gd gd-devel libxml2 libxml2-devel zlib zlib-devel glib2 glib2-devel unzip tar bzip2 bzip2-devel libevent libevent-devel ncurses ncurses-devel curl curl-devel libcurl libcurl-devel e2fsprogs e2fsprogs-devel krb5 krb5-devel libidn libidn-devel openssl openssl-devel vim-minimal gettext gettext-devel ncurses-devel gmp-devel pspell-devel unzip libcap diffutils ca-certificates net-tools libc-client-devel psmisc libXpm-devel git-core c-ares-devel libicu-devel libxslt libxslt-devel xz<span class="p">;</span>
    <span class="k">do</span> yum -y install <span class="nv">$packages</span><span class="p">;</span> <span class="k">done</span>

    mv -f /etc/yum.conf.lnmp /etc/yum.conf
<span class="o">}</span>


<span class="c1">#设置cron计划任务</span>
Crontab_func<span class="o">(){</span>
<span class="c1">#!/bin/bash</span>
cat  <span class="s">&lt;&lt;EOF &gt; /var/spool/cron/root</span>
<span class="s">*/30 * * * * sh /home/cheungssh/mysite/mysite/cheungssh/cheungssh_demo.sh 2&gt;&gt;/home/cheungssh/logs/demo.log  &gt;&gt; /home/cheungssh/logs/demo.log</span>
<span class="s">EOF</span>
<span class="o">}</span>



<span class="c1">#判断进程信息，杀掉进程</span>
kill_Process<span class="o">(){</span>
ps -fel<span class="p">|</span>grep websocket_server_cheung.py<span class="p">|</span>grep  -v <span class="s2">&quot;</span><span class="nv">$$</span><span class="s2">&quot;</span><span class="p">|</span>awk  <span class="s1">&#39;{print  $4}&#39;</span><span class="p">|</span>xargs -i <span class="nb">kill</span>  -9 <span class="o">{}</span>
<span class="o">}</span>

<span class="c1">#获取MD5值</span>
MD5_value<span class="o">(){</span>
md5sum /etc/hosts <span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span>

<span class="o">}</span>

<span class="nv">data_format</span><span class="o">=</span><span class="s2">&quot;+%Y-%m-%d %H:%M:%S&quot;</span>

<span class="c1">#记录日志的function</span>
<span class="k">function</span> fnLogInfo<span class="o">()</span>
<span class="o">{</span>
        <span class="nb">local</span> <span class="nv">infomsg</span><span class="o">=</span><span class="nv">$1</span>
        <span class="nb">echo</span> <span class="si">${</span><span class="nv">infomsg</span><span class="si">}</span>
        <span class="nb">echo</span> <span class="sb">`</span>date <span class="s2">&quot;</span><span class="si">${</span><span class="nv">data_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="sb">`</span> <span class="s2">&quot;Info:</span><span class="si">${</span><span class="nv">infomsg</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; <span class="si">${</span><span class="nv">log_file</span><span class="si">}</span>
<span class="o">}</span>


<span class="c1">#scritps path</span>
dir_path<span class="o">(){</span>
<span class="nv">pwd</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id10">
<h2><a class="toc-backref" href="#id42"><span class="section-number">3.12.24. </span>检查监控内存、硬盘</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:xxx.sh</span>

<span class="c1">#提取根分区剩余空间</span>
<span class="nv">disk_size</span><span class="o">=</span><span class="k">$(</span>df / <span class="p">|</span> awk <span class="s1">&#39;/\// {print $4}&#39;</span><span class="k">)</span>

<span class="c1">#提取内存剩余空间</span>
<span class="nv">mem_size</span><span class="o">=</span><span class="k">$(</span>free <span class="p">|</span> awk <span class="s1">&#39;/Mem/{print $4}&#39;</span><span class="k">)</span>
<span class="k">while</span> :<span class="p">;</span> <span class="k">do</span>
    <span class="c1">#大小为kb</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$disk_size</span> -le <span class="m">512000</span> -a <span class="nv">$mem_size</span> -le <span class="m">1024000</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        mail -s Warning root <span class="s">&lt;&lt;-EOF</span>
<span class="s">        insufficient resources,资源不足</span>
<span class="s">EOF</span>
    <span class="k">fi</span>

<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="id11">
<h2><a class="toc-backref" href="#id43"><span class="section-number">3.12.25. </span>猜随机数</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:xxx.sh</span>
<span class="c1">#取余的算法将随机数变为1-100之间</span>
<span class="nv">num</span><span class="o">=</span>$<span class="o">[</span>RANDOM%100+1<span class="o">]</span>

<span class="c1">#使用read捕获输入</span>
<span class="c1">#使用if判断</span>
<span class="k">while</span> True<span class="p">;</span> <span class="k">do</span>
    <span class="nb">read</span> -p <span class="s2">&quot;计算生成的一个1-100的随机数：&quot;</span> cai
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$cai</span> -eq <span class="nv">$num</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;恭喜，猜对了&quot;</span>
    <span class="k">elif</span> <span class="o">[</span> <span class="nv">$cai</span> -gt <span class="nv">$num</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;oops，猜大了&quot;</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;oops，猜小了&quot;</span>
    <span class="k">fi</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="ip">
<h2><a class="toc-backref" href="#id44"><span class="section-number">3.12.26. </span>检查网段内存活的主机IP信息</a><a class="headerlink" href="#ip" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#版本一</span>

<span class="c1">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:xxx.sh</span>
<span class="nv">i</span><span class="o">=</span><span class="m">1</span>
<span class="k">while</span> <span class="o">[</span> <span class="nv">$VAR</span> -le <span class="m">254</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
    ping -c2 -i0.3 -W1 <span class="m">192</span>.168.4.<span class="nv">$VAR</span> &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="k">if</span> <span class="nb">test</span> <span class="nv">$?</span> -eq <span class="m">0</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;192.168.4.</span><span class="nv">$VAR</span><span class="s2"> is up&quot;</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;192.169.4.</span><span class="nv">$VAR</span><span class="s2"> is down&quot;</span>
    <span class="k">fi</span>
    <span class="nb">let</span> i++
<span class="k">done</span>


<span class="c1">#版本二</span>

<span class="c1">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:test_network.sh</span>
<span class="k">for</span> VAR <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..254<span class="o">}</span> <span class="p">;</span> <span class="k">do</span>
    <span class="c1">#ping -c2 -i0.3 -W1 192.168.4.$VAR &amp;&gt;/dev/null</span>
    ping -c2 -i0.3 -W1 <span class="m">192</span>.168.4.<span class="nv">$VAR</span> &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="k">if</span> <span class="nb">test</span> <span class="nv">$?</span> -eq <span class="m">0</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;192.168.4.</span><span class="nv">$VAR</span><span class="s2"> is up&quot;</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;192.168.4.</span><span class="nv">$VAR</span><span class="s2"> is down&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
    <span class="k">fi</span>
<span class="k">done</span>

<span class="c1">#版本三</span>

<span class="c1">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:xxx.sh</span>
myping<span class="o">(){</span>
ping -c2 -i0.3 -W1 <span class="m">192</span>.168.4.<span class="nv">$VAR</span> <span class="p">&amp;</span>&gt;/dev/null
<span class="k">if</span> <span class="nb">test</span> <span class="nv">$?</span> -eq <span class="m">0</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2"> is up&quot;</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2"> is down&quot;</span>
    <span class="nb">echo</span>
<span class="k">fi</span>
<span class="o">}</span>

<span class="k">for</span> VAR <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..254<span class="o">}</span> <span class="p">;</span> <span class="k">do</span>
    myping <span class="m">192</span>.168.4.<span class="nv">$VAR</span> <span class="p">&amp;</span>     <span class="c1">#将执行函数放入后台执行，不需要等待ping的回应过程</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="id12">
<h2><a class="toc-backref" href="#id45"><span class="section-number">3.12.27. </span>进度条</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
<p>eg</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description):为拷贝文件设计一个进度条效果.</span>

<span class="c1">#防止提前执行Ctrl+C后无法结束进度条.</span>
<span class="nb">trap</span> <span class="s1">&#39;kill $!&#39;</span> INT

<span class="c1">#定义函数:实现无限显示不换行的#符号.</span>
bar<span class="o">(){</span>
    <span class="k">while</span> :
    <span class="k">do</span>
        <span class="nb">echo</span> -n <span class="s1">&#39;#&#39;</span>
        sleep <span class="m">0</span>.3
    <span class="k">done</span>
<span class="o">}</span>

<span class="c1">#调用函数,屏幕显示#进度,直到拷贝结束kill杀死进度函数.</span>
<span class="c1">#$!变量保存的是最后一个后台进程的进程号.</span>
bar <span class="p">&amp;</span>
cp -r <span class="nv">$1</span> <span class="nv">$2</span>
<span class="nb">kill</span> <span class="nv">$!</span>
<span class="nb">echo</span> <span class="s2">&quot;拷贝结束!&quot;</span>
</pre></div>
</div>
<p>eg</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description):为拷贝文件设计一个进度条效果.</span>

<span class="c1">#防止提前执行Ctrl+C后无法结束进度条.</span>
<span class="nb">trap</span> <span class="s1">&#39;kill $!&#39;</span> INT

<span class="c1">#定义函数:实现无限显示不换行的背景色块.</span>
bar<span class="o">(){</span>
    <span class="k">while</span> :
    <span class="k">do</span>
        <span class="nb">echo</span> -ne <span class="s1">&#39;\033[42m \033[0m&#39;</span>
        sleep <span class="m">0</span>.3
    <span class="k">done</span>
<span class="o">}</span>

<span class="c1">#调用函数,屏幕显示色块进度,直到拷贝结束kill杀死进度函数.</span>
<span class="c1">#$!变量保存的是最后一个后台进程的进程号.</span>
bar <span class="p">&amp;</span>
cp -r <span class="nv">$1</span> <span class="nv">$2</span>
<span class="nb">kill</span> <span class="nv">$!</span>
<span class="nb">echo</span> <span class="s2">&quot;拷贝结束!&quot;</span>
</pre></div>
</div>
<p>eg</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description):为拷贝文件设计一个进度条效果.</span>

<span class="c1">#防止提前执行Ctrl+C后无法结束进度条.</span>
<span class="nb">trap</span> <span class="s1">&#39;kill $!&#39;</span> INT

<span class="c1">#定义函数:在宽度为50的范围内输出进度条,#和空格占用48个宽度,竖线占用2个宽度.</span>
<span class="c1">#1个#组合47个空格=48,2个#组合46个空格=48,3个#组合45个空格=48,依此类推.</span>
<span class="c1">#输出完成后不换号将光标切换至行首,准备下一次进度条的显示.</span>
bar<span class="o">(){</span>
    <span class="k">while</span> :
    <span class="k">do</span>
        <span class="nv">pound</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span><span class="m">47</span><span class="p">;</span>i&gt;<span class="o">=</span><span class="m">1</span><span class="p">;</span>i--<span class="o">))</span>
        <span class="k">do</span>
            <span class="nv">pound</span><span class="o">+=</span><span class="c1">#</span>
            <span class="nb">printf</span> <span class="s2">&quot;|%s%</span><span class="si">${</span><span class="nv">i</span><span class="si">}</span><span class="s2">s|\r&quot;</span> <span class="s2">&quot;</span><span class="nv">$pound</span><span class="s2">&quot;</span>
            sleep <span class="m">0</span>.2
        <span class="k">done</span>
    <span class="k">done</span>
<span class="o">}</span>

<span class="c1">#调用函数,显示进度符号,直到拷贝结束kill杀死进度函数.</span>
<span class="c1">#$!变量保存的是最后一个后台进程的进程号.</span>
bar <span class="p">&amp;</span>
cp -r <span class="nv">$1</span> <span class="nv">$2</span>
<span class="nb">kill</span> <span class="nv">$!</span>
<span class="nb">echo</span> <span class="s2">&quot;拷贝结束!&quot;</span>
</pre></div>
</div>
<p>eg</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description):为拷贝文件设计一个进度条效果.</span>

<span class="c1">#防止提前执行Ctrl+C后无法结束进度条.</span>
<span class="nb">trap</span> <span class="s1">&#39;kill $!&#39;</span> INT

<span class="c1">#定义变量,存储指针的四个符号.</span>
<span class="nv">rotate</span><span class="o">=</span><span class="s1">&#39;|/-\&#39;</span>

<span class="c1">#定义函数:实现动态指针进度条.</span>
bar<span class="o">()</span> <span class="o">{</span>
<span class="c1">#回车到下一行打印一个空格,第一次打印指针符号时会把这个空格删除.</span>
<span class="c1">#这里的空格主要目的是换行.</span>
    <span class="nb">printf</span> <span class="s1">&#39; &#39;</span>
    <span class="k">while</span> :
    <span class="k">do</span>
<span class="c1">#删除前一个字符后,仅打印rotate变量中的第一个字符.</span>
<span class="c1">#没循环一次就将rotate中四个字符的位置调整一次.</span>
        <span class="nb">printf</span> <span class="s2">&quot;\b%.1s&quot;</span> <span class="s2">&quot;</span><span class="nv">$rotate</span><span class="s2">&quot;</span>
        <span class="nv">rotate</span><span class="o">=</span><span class="si">${</span><span class="nv">rotate</span><span class="p">#?</span><span class="si">}${</span><span class="nv">rotate</span><span class="p">%???</span><span class="si">}</span>
        sleep <span class="m">0</span>.2
    <span class="k">done</span>
<span class="o">}</span>

bar <span class="p">&amp;</span>
cp -r <span class="nv">$1</span> <span class="nv">$2</span>
<span class="nb">kill</span> <span class="nv">$!</span>
<span class="nb">echo</span> <span class="s2">&quot;拷贝结束!&quot;</span>
</pre></div>
</div>
<p>eg</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description):为拷贝文件设计一个进度条效果.</span>

<span class="c1">#防止提前执行Ctrl+C后无法结束进度条.</span>
<span class="nb">trap</span> <span class="s1">&#39;kill $!&#39;</span> INT

<span class="c1">#定义变量,存储源与目标的容量大小,目标初始大小为0.</span>
<span class="nv">src</span><span class="o">=</span><span class="k">$(</span>du -s <span class="nv">$1</span> <span class="p">|</span> cut -f1<span class="k">)</span>
<span class="nv">dst</span><span class="o">=</span><span class="m">0</span>

<span class="c1">#定义函数:实时对比源文件与目标文件的大小,计算拷贝进度.</span>
bar<span class="o">()</span> <span class="o">{</span>
    <span class="k">while</span> :
    <span class="k">do</span>
        <span class="nv">size</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;scale=2;</span><span class="nv">$dst</span><span class="s2">/</span><span class="nv">$src</span><span class="s2">*100&quot;</span> <span class="p">|</span> bc<span class="k">)</span>
        <span class="nb">echo</span> -en <span class="s2">&quot;\r|</span><span class="nv">$size</span><span class="s2">%|&quot;</span>
        <span class="o">[</span> -f <span class="nv">$2</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">dst</span><span class="o">=</span><span class="k">$(</span>du -s <span class="nv">$2</span> <span class="p">|</span> cut -f1<span class="k">)</span>
        <span class="o">[</span> -d <span class="nv">$2</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">dst</span><span class="o">=</span><span class="k">$(</span>du -s <span class="nv">$2</span>/<span class="nv">$1</span> <span class="p">|</span> cut -f1<span class="k">)</span>
        sleep <span class="m">0</span>.3
    <span class="k">done</span>
<span class="o">}</span>

bar <span class="nv">$1</span> <span class="nv">$2</span> <span class="p">&amp;</span>
cp -r <span class="nv">$1</span> <span class="nv">$2</span>
<span class="nb">kill</span> <span class="nv">$!</span>
<span class="nb">echo</span> <span class="s2">&quot;拷贝结束!&quot;</span>
</pre></div>
</div>
</section>
<section id="nginx">
<h2><a class="toc-backref" href="#id46"><span class="section-number">3.12.28. </span>nginx启动脚本</a><a class="headerlink" href="#nginx" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#usage:xxx</span>
<span class="c1">#scripts_name:xxx.sh</span>
<span class="c1">#放置位置/etc/init.d/目录下</span>
<span class="c1">#脚本名称为nginx，则service nginx start就可以启动该服务</span>

<span class="c1"># service nginx stop 关闭服务</span>
<span class="c1"># service nginx start 开启服务</span>
<span class="c1"># service nginx restart 重启服务</span>
<span class="nv">program</span><span class="o">=</span>/usr/local/nginx/sbin/nginx
<span class="nv">pid</span><span class="o">=</span>/usr/local/nginx/logs/nginx.pid

start<span class="o">(){</span>
<span class="k">if</span> <span class="nb">test</span> -f <span class="nv">$pid</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;nginx 服务启动正常&quot;</span>
<span class="k">else</span>
    <span class="nv">$program</span>
<span class="k">fi</span>

<span class="o">}</span>
stop<span class="o">(){</span>
<span class="k">if</span> <span class="o">[</span> -! -f <span class="nv">$pid</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;nginx 服务已经关闭&quot;</span>
<span class="k">else</span>
    <span class="nv">$program</span> -s stop
    <span class="nb">echo</span> <span class="s2">&quot;关闭服务ok&quot;</span>
<span class="k">fi</span>

<span class="o">}</span>

status<span class="o">(){</span>
<span class="k">if</span> <span class="o">[[</span> -f <span class="nv">$pid</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;服务正在运行.....&quot;</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;服务已经关闭......&quot;</span>
<span class="k">fi</span>
<span class="o">}</span>
<span class="k">case</span> <span class="nv">$1</span> <span class="k">in</span>
start<span class="o">)</span>
    start
   <span class="p">;;</span>
stop<span class="o">)</span>
    stop
   <span class="p">;;</span>
restart<span class="o">)</span>
    stop
    sleep <span class="m">1</span>
    start
   <span class="p">;;</span>
status<span class="o">)</span>
    status
   <span class="p">;;</span>
*<span class="o">)</span>
    <span class="nb">echo</span> <span class="s2">&quot;unknow program!...........&quot;</span>
   <span class="p">;;</span>
<span class="k">esac</span>
</pre></div>
</div>
</section>
<section id="test">
<h2><a class="toc-backref" href="#id47"><span class="section-number">3.12.29. </span>3种test的写法</a><a class="headerlink" href="#test" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="nv">FreeMem</span><span class="o">=</span><span class="sb">`</span>free -m<span class="p">|</span>awk <span class="s1">&#39;NR==3 {print $NF}&#39;</span><span class="sb">`</span>
<span class="k">if</span> <span class="o">((</span> <span class="nv">$FreeMem</span> &lt; <span class="m">1000</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;xxxxxxxxxx&quot;</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$FreeMem</span> -lt <span class="m">1000</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;xxxxxxxx&quot;</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="nb">test</span> <span class="nv">$FreeMem</span> -lt <span class="m">1000</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;xxxxxxxxxxxx&quot;</span>
<span class="k">fi</span>

<span class="k">if</span> grep  /etc/passwd &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;xxxxxxxxxx&quot;</span>
<span class="k">fi</span>
</pre></div>
</div>
</section>
<section id="case-color">
<h2><a class="toc-backref" href="#id48"><span class="section-number">3.12.30. </span>case+color用法</a><a class="headerlink" href="#case-color" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="k">function</span> AddColor<span class="o">(){</span>
<span class="c1">#&lt;==定义加颜色函数AddColor</span>
<span class="nv">RED_COLOR</span><span class="o">=</span><span class="s1">&#39;\E[1;31m&#39;</span>
<span class="nv">GREEN_COLOR</span><span class="o">=</span><span class="s1">&#39;\E[1;32m&#39;</span>
<span class="nv">YELLOW_COLOR</span><span class="o">=</span><span class="s1">&#39;\E[1;33m&#39;</span>
<span class="nv">BLUE_COLOR</span><span class="o">=</span><span class="s1">&#39;\E[1;34m&#39;</span>
<span class="nv">PINK</span><span class="o">=</span><span class="s1">&#39;\E[1;35m&#39;</span>
<span class="nv">RES</span><span class="o">=</span><span class="s1">&#39;\E[0m&#39;</span>
<span class="o">}</span>

<span class="o">[</span> <span class="nv">$#</span> -ne <span class="m">2</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;Usage </span><span class="nv">$0</span><span class="s2"> content {red|yellow|blue|green}&quot;</span><span class="p">;</span>exit<span class="p">;</span> <span class="o">}</span>

<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="k">in</span>
red<span class="p">|</span>RED<span class="o">)</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED_COLOR</span><span class="si">}</span><span class="nv">$1</span><span class="si">${</span><span class="nv">RES</span><span class="si">}</span><span class="s2">&quot;</span>
   <span class="p">;;</span>
yellow<span class="p">|</span>YELLOW<span class="o">)</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">YELLOW_COLOR</span><span class="si">}</span><span class="nv">$1</span><span class="si">${</span><span class="nv">RES</span><span class="si">}</span><span class="s2">&quot;</span>
   <span class="p">;;</span>
green<span class="p">|</span>GREEN<span class="o">)</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">GREEN_COLOR</span><span class="si">}</span><span class="nv">$1</span><span class="si">${</span><span class="nv">RES</span><span class="si">}</span><span class="s2">&quot;</span>
   <span class="p">;;</span>
blue<span class="p">|</span>BLUE<span class="o">)</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">BLUE_COLOR</span><span class="si">}</span><span class="nv">$1</span><span class="si">${</span><span class="nv">RES</span><span class="si">}</span><span class="s2">&quot;</span>
   <span class="p">;;</span>
pink<span class="p">|</span>PINK<span class="o">)</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PINK_COLOR</span><span class="si">}</span><span class="nv">$1</span><span class="si">${</span><span class="nv">RES</span><span class="si">}</span><span class="s2">&quot;</span>
   <span class="p">;;</span>
*<span class="o">)</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage </span><span class="nv">$0</span><span class="s2"> content {red|yellow|blue|green}&quot;</span>
    <span class="nb">exit</span>
<span class="k">esac</span>

main<span class="o">(){</span>

AddColor<span class="nv">$1</span> <span class="nv">$2</span>
<span class="o">}</span>

main <span class="nv">$*</span>
</pre></div>
</div>
</section>
<section id="io">
<h2><a class="toc-backref" href="#id49"><span class="section-number">3.12.31. </span>监控磁盘IO脚本</a><a class="headerlink" href="#io" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">##监控磁盘IO使用率，并找出哪个进程造成磁盘使用率很高</span>


<span class="c1">#判断机器上是否安装iostat命令</span>
<span class="k">if</span> ! which iostat <span class="p">&amp;</span>&gt;/dev/null
<span class="k">then</span>
    yum install -y sysstat
    <span class="c1">#如果你的机器为ubuntu，请使用这个命令：apt-get install -y sysstat</span>
<span class="k">fi</span>

<span class="c1">#判断机器上是否安装iotop命令</span>
<span class="k">if</span> ! which iotop <span class="p">&amp;</span>&gt;/dev/null
<span class="k">then</span>
    yum install -y iotop
    <span class="c1">#如果你的机器为ubuntu，请使用这个命令：apt-get install -y iotop</span>
<span class="k">fi</span>

<span class="c1">#定义记录日志的目录</span>
<span class="nv">logdir</span><span class="o">=</span>/tmp/iolog
<span class="o">[</span> -d <span class="nv">$logdir</span> <span class="o">]</span> <span class="o">||</span> mkdir <span class="nv">$logdir</span>

<span class="c1">#定义日志名字</span>
<span class="nv">dt</span><span class="o">=</span><span class="sb">`</span>date +%F<span class="sb">`</span>

<span class="c1">#定义获取io的函数（取5次平均值）</span>
get_io<span class="o">()</span>
<span class="o">{</span>
    iostat -dx <span class="m">1</span> <span class="m">5</span> &gt; <span class="nv">$logdir</span>/iostat.log
    <span class="nv">sum</span><span class="o">=</span><span class="m">0</span>

    <span class="c1">#取最后一列的%util值循环遍历然后相加</span>
    <span class="k">for</span> ut <span class="k">in</span>  <span class="sb">`</span>grep <span class="s2">&quot;^</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="nv">$logdir</span>/iostat.log<span class="p">|</span>awk <span class="s1">&#39;{print $NF}&#39;</span><span class="p">|</span>cut -d. -f1<span class="sb">`</span>
    <span class="k">do</span>
        <span class="nv">sum</span><span class="o">=</span>$<span class="o">[</span><span class="nv">$sum</span>+<span class="nv">$ut</span><span class="o">]</span>
    <span class="k">done</span>
    <span class="nb">echo</span> $<span class="o">[</span><span class="nv">$sum</span>/5<span class="o">]</span>
<span class="o">}</span>

<span class="c1">#这里的true表示条件为真</span>
<span class="k">while</span> <span class="nb">true</span>
<span class="k">do</span>
    <span class="c1">#获取所有设备，对所有设备名遍历</span>
    <span class="k">for</span> d <span class="k">in</span> <span class="sb">`</span>iostat -dx<span class="p">|</span>egrep -v <span class="s1">&#39;^$|Device:|CPU\)&#39;</span><span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
    <span class="k">do</span>
        <span class="nv">io</span><span class="o">=</span><span class="sb">`</span>get_io <span class="nv">$d</span><span class="sb">`</span>
        <span class="c1">#如果io使用率大于等于80</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$io</span> -ge <span class="m">80</span> <span class="o">]</span>
        <span class="k">then</span>
            <span class="c1">#向日志里记录时间、iostat和iotop信息</span>
            date &gt;&gt; <span class="nv">$logdir</span>/<span class="nv">$dt</span>
            cat <span class="nv">$logdir</span>/iostat.log &gt;&gt;<span class="nv">$logdir</span>/<span class="nv">$dt</span>
            iotop -obn2 &gt;&gt;<span class="nv">$logdir</span>/<span class="nv">$dt</span>
            <span class="nb">echo</span> <span class="s2">&quot;####################&quot;</span> &gt;&gt;<span class="nv">$logdir</span>/<span class="nv">$dt</span>
        <span class="k">fi</span>
    <span class="c1">#休眠10秒，继续以上步骤</span>
    <span class="k">done</span>
    sleep <span class="m">10</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="color-print">
<h2><a class="toc-backref" href="#id50"><span class="section-number">3.12.32. </span>color_print</a><a class="headerlink" href="#color-print" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#ийие1</span>
color_printf1<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$1</span> <span class="o">==</span> <span class="s2">&quot;red&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -e <span class="s2">&quot;\033[32;40m</span><span class="nv">$2</span><span class="s2">\033[0m&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$1</span> <span class="o">==</span> <span class="s2">&quot;green&quot;</span> <span class="o">]]</span><span class="p">;</span><span class="k">then</span>
        <span class="nb">echo</span> -e <span class="s2">&quot;\033[31;40m</span><span class="nv">$2</span><span class="s2">\033[0m&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

color_printf2<span class="o">(){</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="k">in</span>
    <span class="s2">&quot;red&quot;</span><span class="o">)</span>
       <span class="nb">echo</span> -e <span class="s2">&quot;\033[32;40m</span><span class="nv">$2</span><span class="s2">\033[0m&quot;</span>
       <span class="p">;;</span>
    <span class="s2">&quot;green&quot;</span><span class="o">)</span>
       <span class="nb">echo</span> -e <span class="s2">&quot;\033[31;40m</span><span class="nv">$2</span><span class="s2">\033[0m&quot;</span>
       <span class="p">;;</span>
    *<span class="o">)</span>
       <span class="nb">echo</span> -e <span class="s2">&quot;Example: color_printf2 red xxxxxx&quot;</span>
       <span class="p">;;</span>
    <span class="k">esac</span>

<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id13">
<h2><a class="toc-backref" href="#id51"><span class="section-number">3.12.33. </span>网页检测</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<section id="id14">
<h3><a class="toc-backref" href="#id52">检测网页状态发送邮件</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description):使用curl访问具体的HTTP页面,检测HTTP状态码</span>
<span class="c1">#连续测试3次都失败则发送邮件报警.</span>

<span class="c1">#curl命令选项说明:</span>
<span class="c1">#-m设置超时时间</span>
<span class="c1">#-s设置静默连接</span>
<span class="c1">#-o下载数据另存为</span>
<span class="c1">#-w返回附加信息,HTTP状态码</span>

<span class="nv">url</span><span class="o">=</span>http://192.168.4.5/index.html
<span class="nv">date</span><span class="o">=</span><span class="k">$(</span>date +<span class="s2">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="k">)</span>
<span class="nv">mail_to</span><span class="o">=</span><span class="s2">&quot;root@localhost&quot;</span>
<span class="nv">mail_subject</span><span class="o">=</span><span class="s2">&quot;http_warning&quot;</span>
<span class="nv">fail_times</span><span class="o">=</span><span class="m">0</span>
<span class="k">for</span> i <span class="k">in</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span>
<span class="k">do</span>
    <span class="nv">status_code</span><span class="o">=</span><span class="k">$(</span>curl -m <span class="m">3</span> -s -o /dev/null -w %<span class="o">{</span>http_code<span class="o">}</span> <span class="nv">$url</span><span class="k">)</span>
<span class="c1">#使用&lt;&lt;-重定向可以忽略tab键缩进的内容,代码可读性更好.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$status_code</span> -ne <span class="m">200</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
        <span class="nb">let</span> fail_times++
    <span class="k">fi</span>
    sleep <span class="m">1</span>
<span class="k">done</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$fail_times</span> -eq <span class="m">3</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    mail -s <span class="nv">$mail_subject</span> <span class="nv">$mail_to</span> <span class="s">&lt;&lt;- EOF</span>
<span class="s">    检测时间为:$date</span>
<span class="s">    $url页面异常,服务器返回状态码:${status_code}.</span>
<span class="s">    请尽快排查异常.</span>
<span class="s">    EOF</span>
<span class="k">else</span>
    cat &gt;&gt; /var/log/http_check.log <span class="s">&lt;&lt;- EOF</span>
<span class="s">    $date &quot;$url 页面访问正常.&quot;</span>
<span class="s">    EOF</span>
<span class="k">fi</span>
</pre></div>
</div>
</section>
<section id="id15">
<h3><a class="toc-backref" href="#id53">检测网页状态是否变化</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description):根据数据的HASH值监控网站数据是否被篡改.</span>

<span class="nv">url</span><span class="o">=</span><span class="s2">&quot;http://192.168.4.5/index.html&quot;</span>
<span class="nv">date</span><span class="o">=</span><span class="k">$(</span>date +<span class="s2">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="k">)</span>

<span class="c1">#定义变量并赋值为源数据的HASH值.</span>
<span class="nv">source_hash</span><span class="o">=</span><span class="s2">&quot;e3eb0a1df437f3f97a64aca5952c8ea0&quot;</span>
<span class="c1">#实时检测网页数据的HASH值</span>
<span class="nv">url_hash</span><span class="o">=</span><span class="k">$(</span>curl -s <span class="nv">$url</span> <span class="p">|</span>md5sum <span class="p">|</span> cut -d <span class="s1">&#39; &#39;</span> -f1<span class="k">)</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$url_hash</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$source_hash</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
     mail -s http_Warning root@localhost <span class="s">&lt;&lt;- EOF</span>
<span class="s">    检测时间为:$date</span>
<span class="s">    数据完整性校验失败,$url,页面数据被篡改.</span>
<span class="s">    请尽快排查异常.</span>
<span class="s">    EOF</span>
<span class="k">else</span>
    cat &gt;&gt; /var/log/http_check.log <span class="s">&lt;&lt;- EOF</span>
<span class="s">    $date &quot;$url,数据完整性校验正常.&quot;</span>
<span class="s">    EOF</span>
<span class="k">fi</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description):使用nmap的端口扫描功能监控HTTP端口</span>
<span class="nv">ip</span><span class="o">=</span><span class="m">192</span>.168.4.254
<span class="nv">mail_to</span><span class="o">=</span>root@localhost

nmap -n -sS -p80 <span class="m">192</span>.168.4.254 <span class="p">|</span> grep -q <span class="s2">&quot;^80/tcp open&quot;</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;http service is running on </span><span class="nv">$ip</span><span class="s2">&quot;</span> <span class="p">|</span> mail -s http_status_OK <span class="nv">$mail_to</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;http service is stoped on </span><span class="nv">$ip</span><span class="s2">&quot;</span> <span class="p">|</span> mail -s http_status_error <span class="nv">$mail_to</span>
<span class="k">fi</span>
</pre></div>
</div>
</section>
</section>
<section id="id16">
<h2><a class="toc-backref" href="#id54"><span class="section-number">3.12.34. </span>函数检查服务</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description):使用函数检查服务是否启动的案例脚本.</span>

<span class="nv">date_time</span><span class="o">=</span><span class="k">$(</span>date +<span class="s1">&#39;%Y-%m-%dT%H:%M:%S%z&#39;</span><span class="k">)</span>

<span class="k">function</span> check_services<span class="o">()</span> <span class="o">{</span>
    <span class="k">for</span> i <span class="k">in</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
    <span class="k">do</span>
        <span class="k">if</span> systemctl --quiet is-active <span class="si">${</span><span class="nv">i</span><span class="si">}</span>.service<span class="p">;</span> <span class="k">then</span>
            <span class="nb">echo</span> -e <span class="s2">&quot;[</span><span class="nv">$date_time</span><span class="s2">)]: \033[92mservice </span><span class="nv">$i</span><span class="s2"> is active\033[0m&quot;</span>
        <span class="k">else</span>
            <span class="nb">echo</span> <span class="s2">&quot;[</span><span class="nv">$date_time</span><span class="s2">]: service </span><span class="nv">$i</span><span class="s2"> is not active&quot;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
        <span class="k">fi</span>
    <span class="k">done</span>
<span class="o">}</span>

check_services httpd sshd vsftpd
</pre></div>
</div>
</section>
<section id="id17">
<h2><a class="toc-backref" href="#id55"><span class="section-number">3.12.35. </span>编写脚本抓取单个网页中的图片数据</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#功能描述(Description)编写脚本抓取单个网页中的图片数据.</span>

<span class="c1">#需要抓取数据的网页链接与种子URL文件名.</span>
<span class="nv">page</span><span class="o">=</span><span class="s2">&quot;http://www.tmooc.cn&quot;</span>
<span class="nv">URL</span><span class="o">=</span><span class="s2">&quot;/tmp/spider_</span><span class="nv">$$</span><span class="s2">.txt&quot;</span>

<span class="c1">#将网页源代码保存到文件中.</span>
curl -s http://www.tmooc.cn/ &gt; <span class="nv">$URL</span>

<span class="c1">#对文件进行过滤和清洗,获取需要的种子URL链接.</span>
<span class="nb">echo</span> -e <span class="s2">&quot;\033[32m正在获取种子URL,请稍后...\033[0m&quot;</span>
sed -i <span class="s1">&#39;/&lt;img/!d&#39;</span> <span class="nv">$URL</span>         <span class="c1">#删除不包含&lt;img的行.</span>
sed -i <span class="s1">&#39;s/.*src=&quot;//&#39;</span> <span class="nv">$URL</span>      <span class="c1">#删除src=&quot;及其前面的所有内容.</span>
sed -i <span class="s1">&#39;s/&quot;.*//&#39;</span> <span class="nv">$URL</span>          <span class="c1">#删除双引号及其后面的所有内容.</span>
<span class="nb">echo</span>

<span class="c1">#检测系统如果没有wget下载工具则安装该软件.</span>
<span class="k">if</span> ! rpm -q wget <span class="p">&amp;</span>&gt;/dev/null<span class="p">;</span>
<span class="k">then</span>
    yum -y install wget
<span class="k">fi</span>

<span class="c1">#利用循环批量下载所有图片数据.</span>
<span class="c1">#wget为下载工具,其参数选项描述如下:</span>
<span class="c1">#    -P指定将数据下载到特定目录(prefix).</span>
<span class="c1">#    -c支持断点续传(continue).</span>
<span class="c1">#    -q不显示下载过程(quiet).</span>
<span class="nb">echo</span> -e <span class="s2">&quot;\033[32m正在批量下载种子数据,请稍后...\033[0m&quot;</span>
<span class="k">for</span> i <span class="k">in</span> <span class="k">$(</span>cat <span class="nv">$URL</span><span class="k">)</span>
<span class="k">do</span>
    wget -P /tmp/ -c -q <span class="nv">$i</span>
<span class="k">done</span>

<span class="c1">#删除临时种子列表文件.</span>
rm -rf <span class="nv">$URL</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="11.xagrs%E4%BD%BF%E7%94%A8.html" class="btn btn-neutral float-left" title="3.11. xagrs使用" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="13.%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85zabbix%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%84%9A%E6%9C%AC.html" class="btn btn-neutral float-right" title="3.13. 自动化安装zabbix" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>