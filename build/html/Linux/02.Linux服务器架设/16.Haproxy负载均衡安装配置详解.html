<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2.17. Haproxy负载均衡安装配置详解 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="2.18. 国内常使用的yum源信息" href="20.%E5%9B%BD%E5%86%85%E5%B8%B8%E4%BD%BF%E7%94%A8%E7%9A%84yum%E6%BA%90%E4%BF%A1%E6%81%AF.html" />
    <link rel="prev" title="2.16. CentOS7安装xrdp(windows远程桌面连接linux)" href="15.CentOS7%E5%AE%89%E8%A3%85xrdp%28windows%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E8%BF%9E%E6%8E%A5linux%29.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> 小健_Linux-shell-Devops_Blog
            <img src="../../_static/devops_photo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../DevOps/index.html">DevOps和自动化运维实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Github/index.html">Github入门到实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Jenkins/index.html">Jenkins持续化集成</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../KVM/index.html">KVM实践</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01.%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%92%8C%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/index.html">1. 命令行和操作系统</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">2. Linux服务器架设</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="0.1RPM%E7%BA%A2%E5%B8%BD%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86.html">2.1. RPM软件包管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="1.RAID%E4%B8%8ELVM%E7%A3%81%E7%9B%98%E9%98%B5%E5%88%97%E6%8A%80%E6%9C%AF.html">2.2. RAID与LVM磁盘阵列</a></li>
<li class="toctree-l3"><a class="reference internal" href="2.NFS%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA.html">2.3. NFS共享服务器搭建</a></li>
<li class="toctree-l3"><a class="reference internal" href="3.Vsftpd%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA.html">2.4. vsftpd服务安装配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="4.%E6%8C%82%E8%BD%BD%E7%A1%AC%E7%9B%98mount%E5%91%BD%E4%BB%A4.html">2.5. 挂载硬盘和分区</a></li>
<li class="toctree-l3"><a class="reference internal" href="5.Apache%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA.html">2.6. Apache服务源码搭建</a></li>
<li class="toctree-l3"><a class="reference internal" href="6.%E4%BD%BF%E7%94%A8iSCSI%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8.html">2.7. 使用iSCSI服务部署网络存储</a></li>
<li class="toctree-l3"><a class="reference internal" href="7.%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95Linux%E7%B3%BB%E7%BB%9F.html">2.8. 远程登录Linux系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="8.Samba%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%90%AD%E5%BB%BA.html">2.9. Samba服务器搭建</a></li>
<li class="toctree-l3"><a class="reference internal" href="9.rsync%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5.html">2.10. rsync数据同步</a></li>
<li class="toctree-l3"><a class="reference internal" href="10.iptables%E4%B8%8Efirewalld%E9%98%B2%E7%81%AB%E5%A2%99.html">2.11. iptables与firewalld 防火墙</a></li>
<li class="toctree-l3"><a class="reference internal" href="11.Tomcat%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA%E9%85%8D%E7%BD%AE.html">2.12. Tomcat服务搭建配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="12.autofs%E8%87%AA%E5%8A%A8%E6%8C%82%E8%BD%BD%E6%9C%8D%E5%8A%A1.html">2.13. autofs自动挂载服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="13.%E4%BD%BF%E7%94%A8Squid%E9%83%A8%E7%BD%B2%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1.html">2.14. 使用Squid部署代理缓存服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="14.Jenkins%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%BC%81%E4%B8%9A%E5%AE%9E%E6%88%98.html">2.15. Jenkins持续集成企业实战</a></li>
<li class="toctree-l3"><a class="reference internal" href="15.CentOS7%E5%AE%89%E8%A3%85xrdp%28windows%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E8%BF%9E%E6%8E%A5linux%29.html">2.16. CentOS7安装xrdp(windows远程桌面连接linux)</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">2.17. Haproxy负载均衡安装配置详解</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">2.17.1. 简介</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">2.17.2. 安装</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">2.17.3. HAProxy日志配置详解</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">2.17.4. 配置(自己创建)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">2.17.5. 负载均衡算法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#acl">2.17.6. ACL规则定义</a></li>
<li class="toctree-l4"><a class="reference internal" href="#haproxy-cfg">2.17.7. haproxy.cfg文件配置案例</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">2.17.8. 负载均衡示例1</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">2.17.9. 负载均衡示例2</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">2.17.10. 负载均衡示例3</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mysql">2.17.11. 负载均衡MySQL服务的配置示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="#redismysql">2.17.12. 反向代理redis和mysql示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">2.17.13. 启动</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">2.17.14. 查看状态</a></li>
<li class="toctree-l4"><a class="reference internal" href="#openstackhaproxy">2.17.15. openstack高可用haproxy配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#haproxy-ssl">2.17.16. haproxy ssl 配置方式</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="20.%E5%9B%BD%E5%86%85%E5%B8%B8%E4%BD%BF%E7%94%A8%E7%9A%84yum%E6%BA%90%E4%BF%A1%E6%81%AF.html">2.18. 国内常使用的yum源信息</a></li>
<li class="toctree-l3"><a class="reference internal" href="21.Centos7%E5%AE%89%E8%A3%85VNC%EF%BC%8C%E6%89%8B%E5%8A%A8%E7%BD%91%E7%BB%9C%E9%87%8D%E8%A3%85VPS.html">2.19. Centos7安装VNC，手动网络重装VPS</a></li>
<li class="toctree-l3"><a class="reference internal" href="22.windows%E4%B8%8A%E6%90%AD%E5%BB%BAyum%E6%BA%90%E7%AB%99%E7%82%B9.html">2.20. windows上搭建yum源站点</a></li>
<li class="toctree-l3"><a class="reference internal" href="23.%E7%94%A8Python%E5%BF%AB%E9%80%9F%E5%AE%9E%E7%8E%B0HTTP%E5%92%8CFTP%E6%9C%8D%E5%8A%A1%E5%99%A8.html">2.21. 用 Python 快速实现 HTTP 和 FTP 服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="24.%E4%BD%BF%E7%94%A8%E5%9B%BE%E5%BD%A2%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1nmtui.html">2.22. nmtui图形配置网络服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="25.Openssh%E6%9B%B4%E6%96%B0%E5%8D%87%E7%BA%A7.html">2.23. Openssh更新升级</a></li>
<li class="toctree-l3"><a class="reference internal" href="26.rabbitmq%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2.html">2.24. rabbitmq服务部署</a></li>
<li class="toctree-l3"><a class="reference internal" href="27.Cobbler%E6%97%A0%E4%BA%BA%E5%80%BC%E5%AE%88%E5%AE%89%E8%A3%85.html">2.25. Cobbler无人值守安装</a></li>
<li class="toctree-l3"><a class="reference internal" href="28.Linux%E8%BF%90%E7%BB%B4%E5%B7%A5%E5%85%B7Supervisor%28%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%29.html">2.26. Linux运维工具Supervisor(进程管理工具)</a></li>
<li class="toctree-l3"><a class="reference internal" href="29.%E7%9B%AE%E5%89%8D%E6%B5%81%E8%A1%8C%E7%9A%84%E5%BC%80%E6%BA%90%E7%9B%91%E6%8E%A7%E6%A1%86%E6%9E%B6.html">2.27. 目前流行的开源监控框架</a></li>
<li class="toctree-l3"><a class="reference internal" href="30.%E6%BA%90%E7%A0%81%E5%8C%85%E5%88%B6%E4%BD%9C%E6%88%90rpm%E5%8C%85.html">2.28. 源码包制作成rpm包</a></li>
<li class="toctree-l3"><a class="reference internal" href="31.Yum%E8%87%AA%E5%8A%A8%E4%B8%8B%E8%BD%BDRPM%E5%8C%85%E5%8F%8A%E5%85%B6%E6%89%80%E6%9C%89%E4%BE%9D%E8%B5%96%E7%9A%84%E5%8C%85.html">2.29. Yum自动下载RPM包及其所有依赖的包</a></li>
<li class="toctree-l3"><a class="reference internal" href="32.%E5%9F%BA%E4%BA%8EGalera_Cluster%E5%A4%9A%E4%B8%BB%E7%BB%93%E6%9E%84%E7%9A%84Mysql%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4.html">2.30. 基于Galera多主结构的Mysql高可用集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="33.Gitlab%E5%AE%89%E8%A3%85.html">2.31. Gitlab安装</a></li>
<li class="toctree-l3"><a class="reference internal" href="34.Rsync%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6%E8%BD%AF%E4%BB%B6%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.html">2.32. Rsync数据复制软件应用实践</a></li>
<li class="toctree-l3"><a class="reference internal" href="35.Extundelete%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D.html">2.33. Extundelete 数据恢复</a></li>
<li class="toctree-l3"><a class="reference internal" href="36.Openvpn%E9%83%A8%E7%BD%B2.html">2.34. Openvpn部署</a></li>
<li class="toctree-l3"><a class="reference internal" href="37.CentOS8%E5%AE%89%E8%A3%85Docker%E5%92%8CDocker-componse.html">2.35. CentOS8 安装Docker和Docker-componse</a></li>
<li class="toctree-l3"><a class="reference internal" href="38.CentOS8%E5%BC%80%E5%90%AFBBR%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8.html">2.36. CentOS8开启BBR/升级内核</a></li>
<li class="toctree-l3"><a class="reference internal" href="39.Centos7%E9%80%9A%E8%BF%87python%2Bjs%E5%AE%9E%E7%8E%B0webssh.html">2.37. Centos7通过python+js实现webssh</a></li>
<li class="toctree-l3"><a class="reference internal" href="40.Centos7%E9%83%A8%E7%BD%B2NTP%E6%97%B6%E9%97%B4%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%8C%E6%AD%A5%E7%8E%AF%E5%A2%83.html">2.38. Centos7部署NTP时间服务器同步环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="41.Linux%E4%BC%98%E7%A7%80%E8%BD%AF%E4%BB%B6%E6%95%B4%E7%90%86.html">2.39. Linux优秀软件整理</a></li>
<li class="toctree-l3"><a class="reference internal" href="42.Centos7%E5%AE%89%E8%A3%85Openvpn.html">2.40. CentOS 7上设置和配置OpenVPN服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="43.ubuntu%E5%AE%89%E8%A3%85Power-shell.html">2.41. ubuntu18.04 安装power shell</a></li>
<li class="toctree-l3"><a class="reference internal" href="44.Nginx%E6%95%B4%E5%90%88FastDFS%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8.html">2.42. Nginx整合FastDFS实现文件服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="45.ubuntu20.04-desktop-vmware-workstation.html">2.43. ubuntu20.04-desktop-vmware-workstation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../03.%E7%8E%A9%E8%BD%ACshell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/index.html">3. 玩转shell脚本编程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04.%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%88mysql%E3%80%81Redis%EF%BC%89/index.html">4. 玩转数据库(mysql、Redis)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05.Nginx%E5%AD%A6%E4%B9%A0/index.html">5. Nginx学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06.LAMP%E3%80%81LNMP%E5%AD%A6%E4%B9%A0/index.html">6. LNMP、LAMP学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07.Zabbix%E7%9B%91%E6%8E%A7%E4%BC%81%E4%B8%9A%E5%AE%9E%E6%88%98/index.html">7. Zabbix监控企业实战</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08.Linux%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84/index.html">8. 构建Linux高可用架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09.Zabbix3.0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/index.html">9. Zabbix3.0入门到精通</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10.%E5%BF%AB%E9%80%9F%E9%98%85%E8%AF%BBLinux%E5%85%A5%E9%97%A8-%E9%98%BF%E9%93%ADLinux/index.html">10. 快速阅读Linux入门-阿铭Linux</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Mysql/index.html">Mysql王者之路</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/index.html">Other</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Network_route_switch/index.html">Network_route_switch</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">小健_Linux-shell-Devops_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Linux</a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">2. </span>Linux服务器架设</a> &raquo;</li>
      <li><span class="section-number">2.17. </span>Haproxy负载均衡安装配置详解</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Linux/02.Linux服务器架设/16.Haproxy负载均衡安装配置详解.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#haproxy" id="id18">Haproxy负载均衡安装配置详解</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id19">简介</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id20">安装</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id21">HAProxy日志配置详解</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id22">配置(自己创建)</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id23">负载均衡算法</a></p></li>
<li><p><a class="reference internal" href="#acl" id="id24">ACL规则定义</a></p></li>
<li><p><a class="reference internal" href="#haproxy-cfg" id="id25">haproxy.cfg文件配置案例</a></p>
<ul>
<li><p><a class="reference internal" href="#id6" id="id26">配置案例</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id27"><strong>1. 定义独立日志文件</strong></a></p></li>
<li><p><a class="reference internal" href="#http" id="id28"><strong>2.一个最简单的http服务的配置</strong></a></p></li>
<li><p><a class="reference internal" href="#id8" id="id29"><strong>3. haproxy统计页面的输出机制</strong></a></p></li>
<li><p><a class="reference internal" href="#id9" id="id30"><strong>4. 动静分离示例</strong></a></p></li>
<li><p><a class="reference internal" href="#id10" id="id31"><strong>5. http服务器配置完整示例</strong></a></p></li>
<li><p><a class="reference internal" href="#id11" id="id32"><strong>6.用于4层端口转发</strong></a></p></li>
<li><p><a class="reference internal" href="#id12" id="id33"><strong>7.用于7层负载均衡和反向代理</strong></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id13" id="id34">负载均衡示例1</a></p></li>
<li><p><a class="reference internal" href="#id14" id="id35">负载均衡示例2</a></p></li>
<li><p><a class="reference internal" href="#id15" id="id36">负载均衡示例3</a></p></li>
<li><p><a class="reference internal" href="#mysql" id="id37">负载均衡MySQL服务的配置示例</a></p></li>
<li><p><a class="reference internal" href="#redismysql" id="id38">反向代理redis和mysql示例</a></p>
<ul>
<li><p><a class="reference internal" href="#github" id="id39">代理github示例</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id16" id="id40">启动</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id41">查看状态</a></p></li>
<li><p><a class="reference internal" href="#openstackhaproxy" id="id42">openstack高可用haproxy配置</a></p></li>
<li><p><a class="reference internal" href="#haproxy-ssl" id="id43">haproxy ssl 配置方式</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="haproxy">
<h1><a class="toc-backref" href="#id18"><span class="section-number">2.17. </span>Haproxy负载均衡安装配置详解</a><a class="headerlink" href="#haproxy" title="Permalink to this headline">¶</a></h1>
<section id="id1">
<h2><a class="toc-backref" href="#id19"><span class="section-number">2.17.1. </span>简介</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。

HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。

HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。

HAProxy实现了一种事件驱动, 单一进程模型，此模型支持非常大的并发连接数。多进程或多线程模型受内存限制 、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的资源和时间管理的用户空间(User-Space) 实现所有这

些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么他们必须进行优化以 使每个CPU时间片(Cycle)做更多的工作。
</pre></div>
</div>
</section>
<section id="id2">
<h2><a class="toc-backref" href="#id20"><span class="section-number">2.17.2. </span>安装</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>快速安装HAProxy集群软件</p>
<p>可以在HAProxy的官网http://haproxy.1wt.eu/下载HAProxy的源码包，这里以操作系统CentOS
6.3版本为例，下载的HAProxy是当前的稳定版本haproxy-1.4.24.tar.gz，安装过程如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@haproxy</span><span class="o">-</span><span class="n">server</span> <span class="n">app</span><span class="p">]</span><span class="c1"># tar zcvf haproxy-1.4.24.tar.gz</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@haproxy</span><span class="o">-</span><span class="n">server</span> <span class="n">app</span><span class="p">]</span><span class="c1">#cd haproxy-1.4.24</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@haproxy</span><span class="o">-</span><span class="n">server</span> <span class="n">haproxy</span><span class="o">-</span><span class="mf">1.4.24</span><span class="p">]</span><span class="c1">#make TARGET=linux26 PREFIX=/usr/local/haproxy</span>
<span class="c1"># 将HAProxy安装到/usr/local/haproxy下</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@haproxy</span><span class="o">-</span><span class="n">server</span> <span class="n">haproxy</span><span class="o">-</span><span class="mf">1.4.24</span><span class="p">]</span><span class="c1">#make install PREFIX=/usr/local/haproxy</span>

<span class="c1"># HAProxy默认不创建配置文件目录，这里是创建HAProxy配置文件目录</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@haproxy</span><span class="o">-</span><span class="n">server</span> <span class="n">haproxy</span><span class="o">-</span><span class="mf">1.4.24</span><span class="p">]</span><span class="c1">#mkdir /usr/local/haproxy/conf</span>


<span class="c1"># HAProxy安装完成后，默认安装目录中没有配置文件，这里是将源码包里面的示例配置文件复制到配置文件目录</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@haproxy</span><span class="o">-</span><span class="n">server</span> <span class="n">haproxy</span><span class="o">-</span><span class="mf">1.4.24</span><span class="p">]</span><span class="c1"># cp examples/haproxy.cfg  /usr/local/haproxy/conf</span>
</pre></div>
</div>
<p>这样，HAProxy就安装完成了。</p>
<p>安装示例2</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#下载</span>
<span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">haproxy</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="mf">1.9</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">haproxy</span><span class="o">-</span><span class="mf">1.9.0</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="c1">#解压</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">zxvf</span> <span class="n">haproxy</span><span class="o">-</span><span class="mf">1.6.9</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">cd</span> <span class="n">haproxy</span><span class="o">-</span><span class="mf">1.6.9</span>
<span class="c1">#安装</span>
<span class="n">make</span> <span class="n">TARGET</span><span class="o">=</span><span class="n">linux2628</span> <span class="n">ARCH</span><span class="o">=</span><span class="n">x86_64</span> <span class="n">PREFIX</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">haproxy</span>
<span class="n">make</span> <span class="n">install</span> <span class="n">PREFIX</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">haproxy</span>

<span class="c1">#参数说明</span>
<span class="n">TARGET</span><span class="o">=</span><span class="n">linux26</span> <span class="c1">#内核版本，使用uname -r查看内核，如：2.6.18-371.el5，此时该参数就为linux26；kernel 大于2.6.28的用：TARGET=linux2628</span>
<span class="n">ARCH</span><span class="o">=</span><span class="n">x86_64</span> <span class="c1">#系统位数</span>
<span class="n">PREFIX</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">haprpxy</span> <span class="c1">#/usr/local/haprpxy为haprpxy安装路径</span>
</pre></div>
</div>
<p>安裝步骤参考如下：</p>
<p><a class="reference external" href="https://support.huaweicloud.com/prtg-kunpengwebs/kunpenghaproxy_02_0005.html">https://support.huaweicloud.com/prtg-kunpengwebs/kunpenghaproxy_02_0005.html</a></p>
<blockquote>
<div><p>Centos7 安装haproxy</p>
<p><a class="reference external" href="https://www.cnblogs.com/xu360/articles/6593863.html">https://www.cnblogs.com/xu360/articles/6593863.html</a></p>
</div></blockquote>
</section>
<section id="id3">
<h2><a class="toc-backref" href="#id21"><span class="section-number">2.17.3. </span>HAProxy日志配置详解</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>参考文献</p>
<p><a class="reference external" href="https://www.cnblogs.com/xu360/articles/6625608.html">https://www.cnblogs.com/xu360/articles/6625608.html</a></p>
</div></blockquote>
</section>
<section id="id4">
<h2><a class="toc-backref" href="#id22"><span class="section-number">2.17.4. </span>配置(自己创建)</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">/usr/local/haproxy/haproxy.cfg</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">###########全局配置#########</span>
<span class="k">global</span>
    <span class="n">log</span> <span class="mf">127.0.0.1</span> <span class="n">local0</span> <span class="c1">#[日志输出配置，所有日志都记录在本机，通过local0输出]</span>
    <span class="n">log</span> <span class="mf">127.0.0.1</span> <span class="n">local1</span> <span class="n">notice</span> <span class="c1">#定义haproxy 日志级别[error warringinfo debug]</span>
    <span class="n">daemon</span> <span class="c1">#以后台形式运行harpoxy</span>
    <span class="n">nbproc</span> <span class="mi">1</span> <span class="c1">#设置进程数量</span>
    <span class="n">maxconn</span> <span class="mi">4096</span> <span class="c1">#默认最大连接数,需考虑ulimit-n限制</span>
    <span class="c1">#user haproxy #运行haproxy的用户</span>
    <span class="c1">#group haproxy #运行haproxy的用户所在的组</span>
    <span class="c1">#pidfile /var/run/haproxy.pid #haproxy 进程PID文件</span>
    <span class="c1">#ulimit-n 819200 #ulimit 的数量限制</span>
    <span class="c1">#chroot /usr/share/haproxy #chroot运行路径</span>
    <span class="c1">#debug #haproxy 调试级别，建议只在开启单进程的时候调试</span>
    <span class="c1">#quiet</span>

<span class="c1">########默认配置############</span>
<span class="n">defaults</span>
　　<span class="n">log</span> <span class="k">global</span>
　　<span class="n">mode</span> <span class="n">http</span> <span class="c1">#默认的模式mode { tcp|http|health }，tcp是4层，http是7层，health只会返回OK</span>
　　<span class="n">option</span> <span class="n">httplog</span> <span class="c1">#日志类别,采用httplog</span>
　　<span class="n">option</span> <span class="n">dontlognull</span> <span class="c1">#不记录健康检查日志信息</span>
　　<span class="n">retries</span> <span class="mi">2</span> <span class="c1">#两次连接失败就认为是服务器不可用，也可以通过后面设置</span>
　　<span class="c1">#option forwardfor #如果后端服务器需要获得客户端真实ip需要配置的参数，可以从Http Header中获得客户端ip</span>
　　<span class="n">option</span> <span class="n">httpclose</span> <span class="c1">#每次请求完毕后主动关闭http通道,haproxy不支持keep-alive,只能模拟这种模式的实现</span>
　　<span class="c1">#option redispatch #当serverId对应的服务器挂掉后，强制定向到其他健康的服务器，以后将不支持</span>
　　<span class="n">option</span> <span class="n">abortonclose</span> <span class="c1">#当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接</span>
　　<span class="n">maxconn</span> <span class="mi">4096</span> <span class="c1">#默认的最大连接数</span>
　　<span class="n">timeout</span> <span class="n">connect</span> <span class="mi">5000</span><span class="n">ms</span> <span class="c1">#连接超时</span>
　　<span class="n">timeout</span> <span class="n">client</span> <span class="mi">30000</span><span class="n">ms</span> <span class="c1">#客户端超时</span>
　　<span class="n">timeout</span> <span class="n">server</span> <span class="mi">30000</span><span class="n">ms</span> <span class="c1">#服务器超时</span>
　　<span class="c1">#timeout check 2000 #心跳检测超时</span>
　　<span class="c1">#timeout http-keep-alive10s #默认持久连接超时时间</span>
　　<span class="c1">#timeout http-request 10s #默认http请求超时时间</span>
　　<span class="c1">#timeout queue 1m #默认队列超时时间</span>
　　<span class="n">balance</span> <span class="n">roundrobin</span> <span class="c1">#设置默认负载均衡方式，轮询方式</span>
　　<span class="c1">#balance source #设置默认负载均衡方式，类似于nginx的ip_hash</span>
　　<span class="c1">#balnace leastconn #设置默认负载均衡方式，最小连接数</span>

<span class="c1">########统计页面配置########</span>
<span class="n">listen</span> <span class="n">stats</span>
　　<span class="n">bind</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">1080</span> <span class="c1">#设置Frontend和Backend的组合体，监控组的名称，按需要自定义名称</span>
　　<span class="n">mode</span> <span class="n">http</span> <span class="c1">#http的7层模式</span>
　　<span class="n">option</span> <span class="n">httplog</span> <span class="c1">#采用http日志格式</span>
　　<span class="c1">#log 127.0.0.1 local0 err #错误日志记录</span>
　　<span class="n">maxconn</span> <span class="mi">10</span> <span class="c1">#默认的最大连接数</span>
　　<span class="n">stats</span> <span class="n">refresh</span> <span class="mi">30</span><span class="n">s</span> <span class="c1">#统计页面自动刷新时间</span>
　　<span class="n">stats</span> <span class="n">uri</span> <span class="o">/</span><span class="n">stats</span> <span class="c1">#统计页面url</span>
　　<span class="n">stats</span> <span class="n">realm</span> <span class="n">XingCloud</span>\ <span class="n">Haproxy</span> <span class="c1">#统计页面密码框上提示文本</span>
　　<span class="n">stats</span> <span class="n">auth</span> <span class="n">admin</span><span class="p">:</span><span class="n">admin</span> <span class="c1">#设置监控页面的用户和密码:admin,可以设置多个用户名</span>
　　<span class="n">stats</span> <span class="n">auth</span> <span class="n">Frank</span><span class="p">:</span><span class="n">Frank</span> <span class="c1">#设置监控页面的用户和密码：Frank</span>
　　<span class="n">stats</span> <span class="n">hide</span><span class="o">-</span><span class="n">version</span> <span class="c1">#隐藏统计页面上HAProxy的版本信息</span>
　　<span class="n">stats</span> <span class="n">admin</span> <span class="k">if</span> <span class="n">TRUE</span> <span class="c1">#设置手工启动/禁用，后端服务器(haproxy-1.4.9以后版本)</span>

<span class="c1">########设置haproxy 错误页面#####</span>
<span class="c1">#errorfile 403 /home/haproxy/haproxy/errorfiles/403.http</span>
<span class="c1">#errorfile 500 /home/haproxy/haproxy/errorfiles/500.http</span>
<span class="c1">#errorfile 502 /home/haproxy/haproxy/errorfiles/502.http</span>
<span class="c1">#errorfile 503 /home/haproxy/haproxy/errorfiles/503.http</span>
<span class="c1">#errorfile 504 /home/haproxy/haproxy/errorfiles/504.http</span>

<span class="c1">#############frontend前端配置##############</span>
<span class="n">frontend</span> <span class="n">main</span>
　　<span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">80</span> <span class="c1">#这里建议使用bind *:80的方式，要不然做集群高可用的时候有问题，vip切换到其他机器就不能访问了。</span>
　　<span class="n">acl</span> <span class="n">web</span> <span class="n">hdr</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">-</span><span class="n">i</span> <span class="n">www</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">com</span>  <span class="c1">#acl后面是规则名称，-i为忽略大小写，后面跟的是要访问的域名，如果访问www.abc.com这个域名，就触发web规则，。</span>
　　<span class="n">acl</span> <span class="n">img</span> <span class="n">hdr</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">-</span><span class="n">i</span> <span class="n">img</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">com</span>  <span class="c1">#如果访问img.abc.com这个域名，就触发img规则。</span>
　　<span class="n">use_backend</span> <span class="n">webserver</span> <span class="k">if</span> <span class="n">web</span>   <span class="c1">#如果上面定义的web规则被触发，即访问www.abc.com，就将请求分发到webserver这个作用域。</span>
　　<span class="n">use_backend</span> <span class="n">imgserver</span> <span class="k">if</span> <span class="n">img</span>   <span class="c1">#如果上面定义的img规则被触发，即访问img.abc.com，就将请求分发到imgserver这个作用域。</span>
　　<span class="n">default_backend</span> <span class="n">dynamic</span> <span class="c1">#不满足则响应backend的默认页面</span>

<span class="c1">##############backend后端配置##############</span>
<span class="n">backend</span> <span class="n">webserver</span> <span class="c1">#webserver作用域</span>
　　<span class="n">mode</span> <span class="n">http</span>
　　<span class="n">balance</span> <span class="n">roundrobin</span> <span class="c1">#balance roundrobin 负载轮询，balance source 保存session值，支持static-rr，leastconn，first，uri等参数</span>
　　<span class="n">option</span> <span class="n">httpchk</span> <span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="c1">#健康检查, 检测文件，如果分发到后台index.html访问不到就不再分发给它</span>
　　<span class="n">server</span> <span class="n">web1</span> <span class="mf">10.16.0.9</span><span class="p">:</span><span class="mi">8085</span> <span class="n">cookie</span> <span class="mi">1</span> <span class="n">weight</span> <span class="mi">5</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
　　<span class="n">server</span> <span class="n">web2</span> <span class="mf">10.16.0.10</span><span class="p">:</span><span class="mi">8085</span> <span class="n">cookie</span> <span class="mi">2</span> <span class="n">weight</span> <span class="mi">3</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
　　<span class="c1">#cookie 1表示serverid为1，check inter 1500 是检测心跳频率</span>
　　<span class="c1">#rise 2是2次正确认为服务器可用，fall 3是3次失败认为服务器不可用，weight代表权重</span>

<span class="n">backend</span> <span class="n">imgserver</span>
　　<span class="n">mode</span> <span class="n">http</span>
　　<span class="n">option</span> <span class="n">httpchk</span> <span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span>
　　<span class="n">balance</span> <span class="n">roundrobin</span>
　　<span class="n">server</span> <span class="n">img01</span> <span class="mf">192.168.137.101</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">fall</span> <span class="mi">3</span>
　　<span class="n">server</span> <span class="n">img02</span> <span class="mf">192.168.137.102</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">fall</span> <span class="mi">3</span>

<span class="n">backend</span> <span class="n">dynamic</span>
　　<span class="n">balance</span> <span class="n">roundrobin</span>
　　<span class="n">server</span> <span class="n">test1</span> <span class="mf">192.168.1.23</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span> <span class="n">maxconn</span> <span class="mi">2000</span>
　　<span class="n">server</span> <span class="n">test2</span> <span class="mf">192.168.1.24</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span> <span class="n">maxconn</span> <span class="mi">2000</span>


<span class="n">listen</span> <span class="n">tcptest</span>
　　<span class="n">bind</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">5222</span>
　　<span class="n">mode</span> <span class="n">tcp</span>
　　<span class="n">option</span> <span class="n">tcplog</span> <span class="c1">#采用tcp日志格式</span>
　　<span class="n">balance</span> <span class="n">source</span>
　　<span class="c1">#log 127.0.0.1 local0 debug</span>
　　<span class="n">server</span> <span class="n">s1</span> <span class="mf">192.168.100.204</span><span class="p">:</span><span class="mi">7222</span> <span class="n">weight</span> <span class="mi">1</span>
　　<span class="n">server</span> <span class="n">s2</span> <span class="mf">192.168.100.208</span><span class="p">:</span><span class="mi">7222</span> <span class="n">weight</span> <span class="mi">1</span>
</pre></div>
</div>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id23"><span class="section-number">2.17.5. </span>负载均衡算法</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>一、roundrobin，表示简单的轮询，每个服务器根据权重轮流使用，在服务器的处理时间平均分配的情况下这是最流畅和公平的算法。该算法是动态的，对于实例启动慢的服务器权重会在运行中调整。

二、static-rr，表示根据权重，建议关注；每个服务器根据权重轮流使用，类似roundrobin，但它是静态的，意味着运行时修改权限是无效的。另外，它对服务器的数量没有限制。

三、leastconn，表示最少连接者先处理，建议关注；leastconn建议用于长会话服务，例如LDAP、SQL、TSE等，而不适合短会话协议。如HTTP.该算法是动态的，对于实例启动慢的服务器权重会在运行中调整。

四、source，表示根据请求源IP，建议关注；对请求源IP地址进行哈希，用可用服务器的权重总数除以哈希值，根据结果进行分配。
           只要服务器正常，同一个客户端IP地址总是访问同一个服务器。如果哈希的结果随可用服务器数量而变化，那么客户端会定向到不同的服务器；
           该算法一般用于不能插入cookie的Tcp模式。它还可以用于广域网上为拒绝使用会话cookie的客户端提供最有效的粘连；
           该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。

五、uri，表示根据请求的URI；表示根据请求的URI左端（问号之前）进行哈希，用可用服务器的权重总数除以哈希值，根据结果进行分配。
        只要服务器正常，同一个URI地址总是访问同一个服务器。
        一般用于代理缓存和反病毒代理，以最大限度的提高缓存的命中率。该算法只能用于HTTP后端；
        该算法一般用于后端是缓存服务器；
        该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。

六、url_param，表示根据请求的URl参数&#39;balance url_param&#39; requires an URL parameter name
              在HTTP GET请求的查询串中查找&lt;param&gt;中指定的URL参数，基本上可以锁定使用特制的URL到特定的负载均衡器节点的要求；
              该算法一般用于将同一个用户的信息发送到同一个后端服务器；
              该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。

七、hdr(name)，表示根据HTTP请求头来锁定每一次HTTP请求；
              在每个HTTP请求中查找HTTP头&lt;name&gt;，HTTP头&lt;name&gt;将被看作在每个HTTP请求，并针对特定的节点；
              如果缺少头或者头没有任何值，则用roundrobin代替；
              该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。

八、rdp-cookie(name)，表示根据据cookie(name)来锁定并哈希每一次TCP请求。
                     为每个进来的TCP请求查询并哈希RDP cookie&lt;name&gt;；
                     该机制用于退化的持久模式，可以使同一个用户或者同一个会话ID总是发送给同一台服务器。
                     如果没有cookie，则使用roundrobin算法代替；
                     该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。

#其实这些算法各有各的用法，我们平时应用得比较多的应该是roundrobin、source和lestconn。
</pre></div>
</div>
</section>
<section id="acl">
<h2><a class="toc-backref" href="#id24"><span class="section-number">2.17.6. </span>ACL规则定义</a><a class="headerlink" href="#acl" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>########ACL策略定义#########################
1、#如果请求的域名满足正则表达式返回true -i是忽略大小写
acl denali_policy hdr_reg(host) -i ^(www.inbank.com|image.inbank.com)$

2、#如果请求域名满足www.inbank.com 返回 true -i是忽略大小写
acl tm_policy hdr_dom(host) -i www.inbank.com

3、#在请求url中包含sip_apiname=，则此控制策略返回true,否则为false
acl invalid_req url_sub -i sip_apiname=#定义一个名为invalid_req的策略

4、#在请求url中存在timetask作为部分地址路径，则此控制策略返回true,否则返回false
acl timetask_req url_dir -i timetask

5、#当请求的header中Content-length等于0时返回 true
acl missing_cl hdr_cnt(Content-length) eq 0

#########acl策略匹配相应###################
1、#当请求中header中Content-length等于0 阻止请求返回403
block if missing_cl

2、#block表示阻止请求，返回403错误，当前表示如果不满足策略invalid_req，或者满足策略timetask_req，则阻止请求。
block if !invalid_req || timetask_req

3、#当满足denali_policy的策略时使用denali_server的backend
use_backend denali_server if denali_policy

4、#当满足tm_policy的策略时使用tm_server的backend
use_backend tm_server if tm_policy

5、#reqisetbe关键字定义，根据定义的关键字选择backend
reqisetbe ^Host:\ img dynamic
reqisetbe ^[^\ ]*\ /(img|css)/ dynamic
reqisetbe ^[^\ ]*\ /admin/stats stats

6、#以上都不满足的时候使用默认mms_server的backend
default_backend mms
</pre></div>
</div>
</section>
<section id="haproxy-cfg">
<h2><a class="toc-backref" href="#id25"><span class="section-number">2.17.7. </span>haproxy.cfg文件配置案例</a><a class="headerlink" href="#haproxy-cfg" title="Permalink to this headline">¶</a></h2>
<section id="id6">
<h3><a class="toc-backref" href="#id26">配置案例</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>前端调度器IP：192.168.1.210

后端应用服务器IP:   192.168.1.111 和 192.168.1.112
</pre></div>
</div>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id27"><strong>1. 定义独立日志文件</strong></a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[root@node1 haproxy]# vim /etc/rsyslog.conf     #为其添加日志功能
# Provides UDP syslog reception
$ModLoad imudp
$UDPServerRun 514                   ------&gt;启动udp，启动端口后将作为服务器工作

# Provides TCP syslog reception
$ModLoad imtcp
$InputTCPServerRun 514            ------&gt;启动tcp监听端口
local2.*                                                /var/log/haproxy.log

[root@node1 haproxy]# service rsyslog  restart

[root@LB haproxy]# vim haproxy.cfg

log         127.0.0.1 local2 info          ---------&gt;在global端中添加此行
</pre></div>
</div>
</section>
<section id="http">
<h3><a class="toc-backref" href="#id28"><strong>2.一个最简单的http服务的配置</strong></a><a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">global</span>
    <span class="n">log</span>         <span class="mf">127.0.0.1</span> <span class="n">local2</span>

    <span class="n">chroot</span>      <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">haproxy</span>
    <span class="n">pidfile</span>     <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">pid</span>
    <span class="n">maxconn</span>     <span class="mi">4000</span>
    <span class="n">user</span>        <span class="n">haproxy</span>
    <span class="n">group</span>       <span class="n">haproxy</span>
    <span class="n">daemon</span>

    <span class="n">stats</span> <span class="n">socket</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">stats</span>

<span class="n">defaults</span>
    <span class="n">mode</span>                    <span class="n">http</span>
    <span class="n">log</span>                     <span class="k">global</span>
    <span class="n">option</span>                  <span class="n">httplog</span>
    <span class="n">option</span>                  <span class="n">dontlognull</span>
    <span class="n">option</span> <span class="n">http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">close</span>
    <span class="n">option</span> <span class="n">forwardfor</span>       <span class="k">except</span> <span class="mf">127.0.0.0</span><span class="o">/</span><span class="mi">8</span>
    <span class="n">option</span>                  <span class="n">redispatch</span>
    <span class="n">retries</span>                 <span class="mi">3</span>
    <span class="n">timeout</span> <span class="n">http</span><span class="o">-</span><span class="n">request</span>    <span class="mi">10</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">queue</span>           <span class="mi">1</span><span class="n">m</span>
    <span class="n">timeout</span> <span class="n">connect</span>         <span class="mi">10</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">client</span>          <span class="mi">1</span><span class="n">m</span>
    <span class="n">timeout</span> <span class="n">server</span>          <span class="mi">1</span><span class="n">m</span>
    <span class="n">timeout</span> <span class="n">http</span><span class="o">-</span><span class="n">keep</span><span class="o">-</span><span class="n">alive</span> <span class="mi">10</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">check</span>           <span class="mi">10</span><span class="n">s</span>
    <span class="n">maxconn</span>                 <span class="mi">3000</span>

<span class="n">frontend</span> <span class="n">webser</span>                                               <span class="c1">#webser为名称</span>
        <span class="n">option</span> <span class="n">forwardfor</span>
        <span class="n">bind</span>  <span class="o">*</span><span class="p">:</span><span class="mi">80</span>
        <span class="n">default_backend</span>         <span class="n">app</span>
<span class="n">backend</span> <span class="n">app</span>
        <span class="n">balance</span> <span class="n">roundrobin</span>                            <span class="c1">#使拥roundrobin 算法</span>
        <span class="n">server</span>  <span class="n">app1</span> <span class="mf">192.168.1.111</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span>
        <span class="n">server</span>  <span class="n">app2</span> <span class="mf">192.168.1.112</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span>
</pre></div>
</div>
</section>
<section id="id8">
<h3><a class="toc-backref" href="#id29"><strong>3. haproxy统计页面的输出机制</strong></a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>frontend webser
        log 127.0.0.1 local3
        option forwardfor
        bind  *:80
        default_backend         app
backend app
        cookie node insert nocache
        balance roundrobin
        server  app1 192.168.1.111:80 check  cookie  node1    intval 2 rise 1 fall 2
        server  app2 192.168.1.112:80 check  cookie  node2    intval 2 rise 1 fall 2
        server  backup 127.0.0.1:8010  check  backup

listen statistics
        bind *:8009                           # 自定义监听端口
        stats enable                          # 启用基于程序编译时默认设置的统计报告
        stats auth admin:admin        # 统计页面用户名和密码设置
        stats uri  /admin?stats          # 自定义统计页面的URL，默认为/haproxy?stats
        stats hide-version                 # 隐藏统计页面上HAProxy的版本信息
        stats refresh 30s                   # 统计页面自动刷新时间
        stats admin if TRUE              #如果认证通过就做管理功能，可以管理后端的服务器
        stats realm Hapadmin          # 统计页面密码框上提示文本，默认为Haproxy\ Statistics
</pre></div>
</div>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id30"><strong>4. 动静分离示例</strong></a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">frontend</span>  <span class="n">webservs</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">80</span>
    <span class="n">acl</span> <span class="n">url_static</span>       <span class="n">path_beg</span>       <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">static</span> <span class="o">/</span><span class="n">images</span> <span class="o">/</span><span class="n">javascript</span> <span class="o">/</span><span class="n">stylesheets</span>
    <span class="n">acl</span> <span class="n">url_static</span>       <span class="n">path_end</span>       <span class="o">-</span><span class="n">i</span> <span class="o">.</span><span class="n">jpg</span> <span class="o">.</span><span class="n">gif</span> <span class="o">.</span><span class="n">png</span> <span class="o">.</span><span class="n">css</span> <span class="o">.</span><span class="n">js</span>  <span class="o">.</span><span class="n">html</span>
    <span class="n">acl</span> <span class="n">url_php</span>          <span class="n">path_end</span>       <span class="o">-</span><span class="n">i</span> <span class="o">.</span><span class="n">php</span>
    <span class="n">acl</span> <span class="n">host_static</span>      <span class="n">hdr_beg</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>  <span class="o">-</span><span class="n">i</span> <span class="n">img</span><span class="o">.</span> <span class="n">imgs</span><span class="o">.</span> <span class="n">video</span><span class="o">.</span> <span class="n">videos</span><span class="o">.</span>  <span class="n">ftp</span><span class="o">.</span> <span class="n">image</span><span class="o">.</span> <span class="n">download</span><span class="o">.</span>
    <span class="n">use_backend</span> <span class="n">static</span>          <span class="k">if</span> <span class="n">url_static</span>  <span class="ow">or</span> <span class="n">host_static</span>

    <span class="n">use_backend</span> <span class="n">dynamic</span>         <span class="k">if</span> <span class="n">url_php</span>
    <span class="n">default_backend</span>             <span class="n">dynamic</span>

<span class="n">backend</span> <span class="n">static</span>
    <span class="n">balance</span>     <span class="n">roundrobin</span>
    <span class="n">server</span>      <span class="n">node1</span> <span class="mf">192.168.1.111</span><span class="p">:</span><span class="mi">80</span>  <span class="n">check</span> <span class="n">maxconn</span> <span class="mi">3000</span>

<span class="n">backend</span> <span class="n">dynamic</span>
        <span class="n">balance</span> <span class="n">roundrobin</span>
        <span class="n">server</span>  <span class="n">node2</span>   <span class="mf">192.168.1.112</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span> <span class="n">maxconn</span> <span class="mi">1000</span>
</pre></div>
</div>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id31"><strong>5. http服务器配置完整示例</strong></a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    # to have these messages end up in /var/log/haproxy.log you will
    # need to:
    #
    # 1) configure syslog to accept network log events.  This is done
    #    by adding the &#39;-r&#39; option to the SYSLOGD_OPTIONS in
    #    /etc/sysconfig/syslog
    #
    # 2) configure local2 events to go to the /var/log/haproxy.log
    #   file. A line like the following can be added to
    #   /etc/sysconfig/syslog
    #
    #    local2.*                       /var/log/haproxy.log
    #
    log         127.0.0.1 local2

    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon

defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option http-server-close
    option forwardfor       except 127.0.0.0/8
    option                  redispatch
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 30000

listen stats
    mode http
    bind 0.0.0.0:1080
    stats enable
    stats hide-version
    stats uri     /haproxyadmin?stats
    stats realm   Haproxy\ Statistics
    stats auth    admin:admin
    stats admin if TRUE


frontend http-in
    bind *:80
    mode http
    log global
    option httpclose
    option logasap     #不等待响应结束就记录日志，表示提前记录日志，一般日志会记录响应时长，此不记录响应时长
    option dontlognull     #不记录空信息
    capture request  header Host len 20    #记录请求首部的前20个字符
    capture request  header Referer len 60   #referer跳转引用，就是上一级
    default_backend servers

frontend healthcheck
    bind :1099    #定义外部检测机制
    mode http
    option httpclose
    option forwardfor
    default_backend servers

backend servers
  balance roundrobin
    server websrv1 192.168.1.111:80 check maxconn 2000
    server websrv2 192.168.1.112:80 check maxconn 200
</pre></div>
</div>
</section>
<section id="id11">
<h3><a class="toc-backref" href="#id32"><strong>6.用于4层端口转发</strong></a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">global</span>
        <span class="n">ulimit</span><span class="o">-</span><span class="n">n</span>  <span class="mi">51200</span>
        <span class="n">log</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">log</span>    <span class="n">local0</span>
        <span class="n">log</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">log</span>    <span class="n">local1</span> <span class="n">notice</span>
        <span class="n">chroot</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">haproxy</span>
        <span class="n">pidfile</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">pid</span>
        <span class="n">user</span> <span class="n">haproxy</span>
        <span class="n">group</span> <span class="n">haproxy</span>
        <span class="n">daemon</span>

<span class="n">defaults</span>
        <span class="n">log</span>     <span class="k">global</span>
        <span class="n">mode</span>    <span class="n">tcp</span>
        <span class="n">option</span>  <span class="n">dontlognull</span>
        <span class="n">timeout</span> <span class="n">connect</span> <span class="mi">600</span>
        <span class="n">timeout</span> <span class="n">client</span> <span class="mi">5</span><span class="n">m</span>
        <span class="n">timeout</span> <span class="n">server</span> <span class="mi">5</span><span class="n">m</span>

<span class="n">frontend</span> <span class="mi">51</span><span class="o">-</span><span class="ow">in</span>
        <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">2222</span>
        <span class="n">default_backend</span> <span class="mi">51</span><span class="o">-</span><span class="n">out</span>

<span class="n">backend</span> <span class="mi">51</span><span class="o">-</span><span class="n">out</span>
        <span class="n">server</span> <span class="n">server1</span> <span class="mf">192.168.122.51</span><span class="p">:</span><span class="mi">22</span> <span class="n">maxconn</span> <span class="mi">20480</span>

<span class="n">frontend</span> <span class="mi">101</span><span class="o">-</span><span class="ow">in</span>
        <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">8080</span>
        <span class="n">default_backend</span> <span class="mi">101</span><span class="o">-</span><span class="n">out</span>

<span class="n">backend</span> <span class="mi">101</span><span class="o">-</span><span class="n">out</span>
        <span class="n">server</span> <span class="n">server1</span> <span class="mf">192.168.122.101</span><span class="p">:</span><span class="mi">8080</span> <span class="n">maxconn</span> <span class="mi">20480</span>
</pre></div>
</div>
<p><strong>迅投前置机(基于4层)，端口转发配置如下：</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>global
        log 127.0.0.1   local0
        #log 127.0.0.1  local1 notice
        #log loghost    local0 info
        maxconn 4096
        ulimit-n 12288
        chroot E:\\Agent01/
        uid haproxy
        gid haproxy
        daemon
        nbproc 4
        pidfile E:\\Xt_agent/haproxy/haproxy.pid
        #debug
        #quiet

defaults
        log     127.0.0.1       local3
        mode    tcp
        option  httplog
        option  dontlognull
        option  httpclose
        option  abortonclose
        option  forwardfor
        option  redispatch
        option nolinger
        retries 3
        #maxconn 4096
        #ulimit-n 12288
        balance roundrobin
        stats enable
        stats uri /ha?stats  #haproxy运行状态查看 自定义uri
        contimeout      5000
        clitimeout      50000
        srvtimeout      50000

listen stock1 0.0.0.0:55300   #监听端口
        mode tcp
        #option httpchk HEAD /check.txt HTTP/1.0
        server s1 210.14.136.66:55300 weight 1 check inter 10s

listen stock2 0.0.0.0:55400   #监听端口
        mode tcp
        #option httpchk HEAD /check.txt HTTP/1.0
        server s2 210.14.136.67:55300 weight 1 check inter 10s
</pre></div>
</div>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id33"><strong>7.用于7层负载均衡和反向代理</strong></a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">global</span>
        <span class="n">maxconn</span> <span class="mi">65535</span>
        <span class="n">chroot</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">haproxy</span>
        <span class="n">uid</span> <span class="mi">99</span>
        <span class="n">gid</span> <span class="mi">99</span>
        <span class="c1">#maxconn 4096</span>
        <span class="n">spread</span><span class="o">-</span><span class="n">checks</span> <span class="mi">3</span>
        <span class="n">daemon</span>
        <span class="n">nbproc</span> <span class="mi">1</span>
        <span class="n">pidfile</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">pid</span>

<span class="n">defaults</span>
         <span class="n">log</span>     <span class="mf">127.0.0.1</span>       <span class="n">local3</span>
         <span class="n">mode</span>   <span class="n">http</span>
         <span class="n">option</span> <span class="n">httplog</span>
         <span class="n">option</span> <span class="n">httpclose</span>
         <span class="n">option</span> <span class="n">dontlognull</span>
         <span class="n">option</span> <span class="n">forwardfor</span>
         <span class="n">option</span> <span class="n">redispatch</span>
         <span class="n">retries</span> <span class="mi">10</span>
         <span class="n">maxconn</span> <span class="mi">2000</span>
         <span class="n">stats</span>  <span class="n">uri</span> <span class="o">/</span><span class="n">haproxy</span><span class="o">-</span><span class="n">stats</span>
         <span class="n">stats</span> <span class="n">auth</span> <span class="n">admin</span><span class="p">:</span><span class="n">admin</span>
         <span class="n">contimeout</span>      <span class="mi">5000</span>
         <span class="n">clitimeout</span>      <span class="mi">50000</span>
         <span class="n">srvtimeout</span>      <span class="mi">50000</span>

<span class="n">frontend</span> <span class="n">HAProxy</span>
         <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">80</span>
         <span class="n">mode</span> <span class="n">http</span>
         <span class="n">option</span> <span class="n">httplog</span>
         <span class="n">acl</span> <span class="n">cache_domain</span> <span class="n">path_end</span> <span class="o">.</span><span class="n">css</span> <span class="o">.</span><span class="n">js</span> <span class="o">.</span><span class="n">gif</span> <span class="o">.</span><span class="n">png</span> <span class="o">.</span><span class="n">swf</span> <span class="o">.</span><span class="n">jpg</span> <span class="o">.</span><span class="n">jpeg</span>
         <span class="n">acl</span> <span class="n">cache_dir</span>  <span class="n">path_reg</span> <span class="o">/</span><span class="n">apping</span>
         <span class="n">acl</span> <span class="n">cache_jpg</span>  <span class="n">path_reg</span> <span class="o">/</span><span class="n">theme</span>
         <span class="n">acl</span> <span class="n">bugfree_domain</span> <span class="n">path_reg</span> <span class="o">/</span><span class="n">bugfree</span>

         <span class="n">use_backend</span> <span class="n">varnish</span><span class="o">.</span><span class="n">offer99</span><span class="o">.</span><span class="n">com</span> <span class="k">if</span> <span class="n">cache_domain</span>
         <span class="n">use_backend</span> <span class="n">varnish</span><span class="o">.</span><span class="n">offer99</span><span class="o">.</span><span class="n">com</span> <span class="k">if</span> <span class="n">cache_dir</span>
         <span class="n">use_backend</span> <span class="n">varnish</span><span class="o">.</span><span class="n">offer99</span><span class="o">.</span><span class="n">com</span> <span class="k">if</span> <span class="n">cache_jpg</span>
         <span class="n">use_backend</span> <span class="n">bugfree</span><span class="o">.</span><span class="n">offer99</span><span class="o">.</span><span class="n">com</span> <span class="k">if</span> <span class="n">bugfree_domain</span>
         <span class="n">default_backend</span> <span class="n">www</span><span class="o">.</span><span class="n">offer99</span><span class="o">.</span><span class="n">com</span>

<span class="n">backend</span> <span class="n">bugfree</span><span class="o">.</span><span class="n">offer99</span><span class="o">.</span><span class="n">com</span>
        <span class="n">server</span> <span class="n">bugfree</span> <span class="mf">222.35.135.151</span><span class="p">:</span><span class="mi">80</span> <span class="n">weight</span> <span class="mi">5</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>


<span class="n">backend</span> <span class="n">varnish</span><span class="o">.</span><span class="n">offer99</span><span class="o">.</span><span class="n">com</span>
        <span class="n">server</span> <span class="n">varnish</span> <span class="mf">222.35.135.152</span><span class="p">:</span><span class="mi">81</span> <span class="n">weight</span> <span class="mi">5</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>

<span class="n">backend</span> <span class="n">www</span><span class="o">.</span><span class="n">offer99</span><span class="o">.</span><span class="n">com</span>
        <span class="n">balance</span> <span class="n">source</span>
        <span class="n">option</span> <span class="n">httpchk</span> <span class="n">HEAD</span> <span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span>  <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span>
        <span class="n">server</span> <span class="n">web1</span>  <span class="mf">222.35.135.154</span><span class="p">:</span><span class="mi">80</span>   <span class="n">weight</span> <span class="mi">5</span>  <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
        <span class="n">server</span> <span class="n">web2</span>  <span class="mf">222.35.135.155</span><span class="p">:</span><span class="mi">80</span>   <span class="n">weight</span> <span class="mi">5</span>  <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
</pre></div>
</div>
</section>
</section>
<section id="id13">
<h2><a class="toc-backref" href="#id34"><span class="section-number">2.17.8. </span>负载均衡示例1</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">HAProxy</span><span class="p">]</span><span class="c1"># cat haproxy.cfg</span>
<span class="k">global</span>
    <span class="n">log</span> <span class="mf">127.0.0.1</span>   <span class="n">local0</span>
    <span class="n">maxconn</span> <span class="mi">4096</span>
    <span class="n">chroot</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span>
    <span class="n">daemon</span>
    <span class="n">nbproc</span>  <span class="mi">4</span>
    <span class="n">pidfile</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">pid</span>


<span class="n">defaults</span>
    <span class="n">log</span>     <span class="mf">127.0.0.1</span>   <span class="n">local3</span>
    <span class="n">mode</span>    <span class="n">http</span>
    <span class="n">option</span>  <span class="n">dontlognull</span>
    <span class="n">option</span>  <span class="n">redispatch</span>
    <span class="n">retries</span> <span class="mi">2</span>
    <span class="n">maxconn</span> <span class="mi">2000</span>
    <span class="n">balance</span> <span class="n">roundrobin</span>
    <span class="n">timeout</span> <span class="n">connect</span> <span class="mi">5000</span><span class="n">ms</span>
    <span class="n">timeout</span> <span class="n">client</span>  <span class="mi">50000</span><span class="n">ms</span>
    <span class="n">timeout</span> <span class="n">server</span>  <span class="mi">50000</span><span class="n">ms</span>

<span class="n">listen</span> <span class="n">redis_proxy</span>
    <span class="n">bind</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">6301</span>
    <span class="n">stats</span> <span class="n">enable</span>
    <span class="n">bind</span><span class="o">-</span><span class="n">process</span>    <span class="mi">2</span>            <span class="c1">#让它跑在两颗CPU上</span>
    <span class="n">stats</span> <span class="n">uri</span> <span class="o">/</span><span class="n">haproxy</span><span class="o">-</span><span class="n">stats</span>
    <span class="n">stats</span> <span class="n">auth</span> <span class="n">phil</span><span class="p">:</span><span class="n">NRG93012</span>
        <span class="n">server</span> <span class="n">APP1</span> <span class="n">APP1</span><span class="p">:</span><span class="mi">8001</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
        <span class="n">server</span> <span class="n">APP2</span> <span class="n">APP2</span><span class="p">:</span><span class="mi">8002</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
</pre></div>
</div>
</section>
<section id="id14">
<h2><a class="toc-backref" href="#id35"><span class="section-number">2.17.9. </span>负载均衡示例2</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">global</span>
        <span class="n">log</span> <span class="mf">127.0.0.1</span> <span class="n">local0</span> <span class="n">info</span>
        <span class="n">maxconn</span> <span class="mi">4096</span>
        <span class="n">user</span> <span class="n">nobody</span>
        <span class="n">group</span> <span class="n">nobody</span>
        <span class="n">daemon</span>
        <span class="n">nbproc</span> <span class="mi">1</span>
        <span class="n">pidfile</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">pid</span>
<span class="n">defaults</span>
        <span class="n">mode</span> <span class="n">http</span>
        <span class="n">retries</span> <span class="mi">3</span>
        <span class="n">timeout</span> <span class="n">connect</span> <span class="mi">5</span><span class="n">s</span>
        <span class="n">timeout</span> <span class="n">client</span> <span class="mi">30</span><span class="n">s</span>
        <span class="n">timeout</span> <span class="n">server</span> <span class="mi">30</span><span class="n">s</span>
        <span class="n">timeout</span> <span class="n">check</span> <span class="mi">2</span><span class="n">s</span>
<span class="n">listen</span> <span class="n">admin_stats</span>
        <span class="n">bind</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">19088</span>
        <span class="n">mode</span> <span class="n">http</span>
        <span class="n">log</span> <span class="mf">127.0.0.1</span> <span class="n">local0</span> <span class="n">err</span>
        <span class="n">stats</span> <span class="n">refresh</span> <span class="mi">30</span><span class="n">s</span>
        <span class="n">stats</span> <span class="n">uri</span> <span class="o">/</span><span class="n">haproxy</span><span class="o">-</span><span class="n">status</span>
        <span class="n">stats</span> <span class="n">realm</span> <span class="n">welcome</span> <span class="n">login</span>\ <span class="n">Haproxy</span>
        <span class="n">stats</span> <span class="n">auth</span> <span class="n">admin</span><span class="p">:</span><span class="n">xxxxxx</span>
        <span class="n">stats</span> <span class="n">hide</span><span class="o">-</span><span class="n">version</span>
        <span class="n">stats</span> <span class="n">admin</span> <span class="k">if</span> <span class="n">TRUE</span>
<span class="n">frontend</span> <span class="n">www</span>
         <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">80</span>
         <span class="n">mode</span>    <span class="n">http</span>
         <span class="n">option</span>  <span class="n">httplog</span>
         <span class="n">option</span>  <span class="n">forwardfor</span>
         <span class="n">log</span>     <span class="k">global</span>
        <span class="n">acl</span> <span class="n">host_www</span>            <span class="n">hdr_dom</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>   <span class="o">-</span><span class="n">i</span>      <span class="n">www</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">com</span>
        <span class="n">acl</span> <span class="n">host_img</span>            <span class="n">hdr_dom</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>   <span class="o">-</span><span class="n">i</span>      <span class="n">img</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">com</span>
        <span class="n">use_backend</span>     <span class="n">server_www</span>              <span class="k">if</span> <span class="n">host_www</span>
        <span class="n">use_backend</span>     <span class="n">server_img</span>              <span class="k">if</span> <span class="n">host_img</span>

<span class="n">backend</span> <span class="n">server_www</span>
        <span class="n">mode</span>            <span class="n">http</span>
        <span class="n">option</span>          <span class="n">redispatch</span>
        <span class="n">option</span>          <span class="n">abortonclose</span>
        <span class="n">balance</span>         <span class="n">roundrobin</span>
        <span class="n">option</span>          <span class="n">httpchk</span> <span class="n">HEAD</span> <span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span>
        <span class="n">server</span>          <span class="n">webapp1</span> <span class="mf">192.168.66.31</span><span class="p">:</span><span class="mi">80</span> <span class="n">weight</span> <span class="mi">6</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
        <span class="n">server</span>          <span class="n">webapp2</span> <span class="mf">192.168.66.32</span><span class="p">:</span><span class="mi">80</span> <span class="n">weight</span> <span class="mi">6</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
<span class="n">backend</span> <span class="n">server_img</span>
        <span class="n">mode</span>            <span class="n">http</span>
        <span class="n">option</span>          <span class="n">redispatch</span>
        <span class="n">option</span>          <span class="n">abortonclose</span>
        <span class="n">balance</span>         <span class="n">roundrobin</span>
        <span class="n">option</span>          <span class="n">httpchk</span> <span class="n">HEAD</span> <span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
        <span class="n">server</span> <span class="n">webimg1</span> <span class="mf">192.168.66.33</span><span class="p">:</span><span class="mi">80</span> <span class="n">weight</span> <span class="mi">6</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
        <span class="n">server</span> <span class="n">webimg2</span> <span class="mf">192.168.66.34</span><span class="p">:</span><span class="mi">80</span> <span class="n">weight</span> <span class="mi">6</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
</pre></div>
</div>
</section>
<section id="id15">
<h2><a class="toc-backref" href="#id36"><span class="section-number">2.17.10. </span>负载均衡示例3</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">global</span>
    <span class="n">log</span>         <span class="mf">127.0.0.1</span> <span class="n">local2</span>
    <span class="n">chroot</span>      <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">haproxy</span>
    <span class="n">pidfile</span>     <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">pid</span>
    <span class="n">maxconn</span>     <span class="mi">4000</span>
    <span class="n">user</span>        <span class="n">haproxy</span>
    <span class="n">group</span>       <span class="n">haproxy</span>
    <span class="n">daemon</span>
    <span class="n">stats</span> <span class="n">socket</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">stats</span>
<span class="n">defaults</span>
    <span class="n">mode</span>                    <span class="n">tcp</span>
    <span class="n">log</span>                     <span class="k">global</span>
    <span class="n">retries</span>                 <span class="mi">3</span>
    <span class="n">timeout</span> <span class="n">connect</span>         <span class="mi">10</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">client</span>          <span class="mi">1</span><span class="n">m</span>
    <span class="n">timeout</span> <span class="n">server</span>          <span class="mi">1</span><span class="n">m</span>
<span class="n">frontend</span>  <span class="n">ingress80</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">80</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">default_backend</span>             <span class="n">ingress8880</span>
<span class="n">backend</span> <span class="n">ingress8880</span>
    <span class="n">balance</span>     <span class="n">roundrobin</span>
    <span class="n">server</span>      <span class="n">n1</span> <span class="mf">10.0.0.213</span><span class="p">:</span><span class="mi">8880</span> <span class="n">check</span> <span class="n">maxconn</span> <span class="mi">2000</span>
    <span class="n">server</span>      <span class="n">n2</span> <span class="mf">10.0.0.38</span><span class="p">:</span><span class="mi">8880</span> <span class="n">check</span> <span class="n">maxconn</span> <span class="mi">2000</span>
<span class="n">frontend</span>  <span class="n">ingress443</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">443</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">default_backend</span>             <span class="n">ingress4443</span>
<span class="n">backend</span> <span class="n">ingress4443</span>
    <span class="n">balance</span>     <span class="n">roundrobin</span>
    <span class="n">server</span>      <span class="n">n1</span> <span class="mf">10.0.0.213</span><span class="p">:</span><span class="mi">4443</span> <span class="n">check</span> <span class="n">maxconn</span> <span class="mi">2000</span>
    <span class="n">server</span>      <span class="n">n2</span> <span class="mf">10.0.0.38</span><span class="p">:</span><span class="mi">4443</span> <span class="n">check</span> <span class="n">maxconn</span> <span class="mi">2000</span>
<span class="n">frontend</span>  <span class="n">ingress22</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">22</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">default_backend</span>             <span class="n">ingress2222</span>
<span class="n">backend</span> <span class="n">ingress2222</span>
    <span class="n">balance</span>     <span class="n">roundrobin</span>
    <span class="n">server</span>      <span class="n">n1</span> <span class="mf">10.0.0.213</span><span class="p">:</span><span class="mi">2222</span> <span class="n">check</span> <span class="n">maxconn</span> <span class="mi">2000</span>
    <span class="n">server</span>      <span class="n">n2</span> <span class="mf">10.0.0.38</span><span class="p">:</span><span class="mi">2222</span> <span class="n">check</span> <span class="n">maxconn</span> <span class="mi">2000</span>
</pre></div>
</div>
</section>
<section id="mysql">
<h2><a class="toc-backref" href="#id37"><span class="section-number">2.17.11. </span>负载均衡MySQL服务的配置示例</a><a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    # to have these messages end up in /var/log/haproxy.log you will
    # need to:
    #
    # 1) configure syslog to accept network log events.  This is done
    #    by adding the &#39;-r&#39; option to the SYSLOGD_OPTIONS in
    #    /etc/sysconfig/syslog
    #
    # 2) configure local2 events to go to the /var/log/haproxy.log
    #   file. A line like the following can be added to
    #   /etc/sysconfig/syslog
    #
    #    local2.*                       /var/log/haproxy.log
    #
    log         127.0.0.1 local2

    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon

defaults
    mode                    tcp
    log                     global
    option                  httplog
    option                  dontlognull
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 600

listen stats
    mode http
    bind 0.0.0.0:1080
    stats enable
    stats hide-version
    stats uri     /haproxyadmin?stats
    stats realm   Haproxy\ Statistics
    stats auth    admin:admin
    stats admin if TRUE


frontend mysql
    bind *:3306
    mode tcp
    log global
    default_backend mysqlservers

backend mysqlservers
    balance leastconn
    server dbsrv1 192.168.1.111:3306 check port 3306 intval 2 rise 1 fall 2 maxconn 300
    server dbsrv2 192.168.1.112:3306 check port 3306 intval 2 rise 1 fall 2 maxconn 300
</pre></div>
</div>
</section>
<section id="redismysql">
<h2><a class="toc-backref" href="#id38"><span class="section-number">2.17.12. </span>反向代理redis和mysql示例</a><a class="headerlink" href="#redismysql" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#---------------------------------------------------------------------</span>
<span class="c1"># Example configuration for a possible web application.  See the</span>
<span class="c1"># full configuration options online.</span>
<span class="c1">#</span>
<span class="c1">#   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt</span>
<span class="c1">#</span>
<span class="c1">#---------------------------------------------------------------------</span>

<span class="c1">#---------------------------------------------------------------------</span>
<span class="c1"># Global settings</span>
<span class="c1">#---------------------------------------------------------------------</span>
<span class="k">global</span>
    <span class="c1"># to have these messages end up in /var/log/haproxy.log you will</span>
    <span class="c1"># need to:</span>
    <span class="c1">#</span>
    <span class="c1"># 1) configure syslog to accept network log events.  This is done</span>
    <span class="c1">#    by adding the &#39;-r&#39; option to the SYSLOGD_OPTIONS in</span>
    <span class="c1">#    /etc/sysconfig/syslog</span>
    <span class="c1">#</span>
    <span class="c1"># 2) configure local2 events to go to the /var/log/haproxy.log</span>
    <span class="c1">#   file. A line like the following can be added to</span>
    <span class="c1">#   /etc/sysconfig/syslog</span>
    <span class="c1">#</span>
    <span class="c1">#    local2.*                       /var/log/haproxy.log</span>
    <span class="c1">#</span>
    <span class="n">log</span>         <span class="mf">127.0.0.1</span> <span class="n">local2</span>

    <span class="n">chroot</span>      <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">haproxy</span>
    <span class="n">pidfile</span>     <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">pid</span>
    <span class="n">maxconn</span>     <span class="mi">4000</span>
    <span class="n">user</span>        <span class="n">haproxy</span>
    <span class="n">group</span>       <span class="n">haproxy</span>
    <span class="n">daemon</span>

    <span class="c1"># turn on stats unix socket</span>
    <span class="n">stats</span> <span class="n">socket</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">stats</span>

<span class="c1">#---------------------------------------------------------------------</span>
<span class="c1"># common defaults that all the &#39;listen&#39; and &#39;backend&#39; sections will</span>
<span class="c1"># use if not designated in their block</span>
<span class="c1">#---------------------------------------------------------------------</span>
<span class="n">defaults</span>
    <span class="n">mode</span>                    <span class="n">tcp</span>
    <span class="n">log</span>                     <span class="k">global</span>
    <span class="n">option</span>                  <span class="n">httplog</span>
    <span class="n">option</span>                  <span class="n">dontlognull</span>
    <span class="n">option</span> <span class="n">http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">close</span>
    <span class="n">option</span> <span class="n">forwardfor</span>       <span class="k">except</span> <span class="mf">127.0.0.0</span><span class="o">/</span><span class="mi">8</span>
    <span class="n">option</span>                  <span class="n">redispatch</span>
    <span class="n">retries</span>                 <span class="mi">3</span>
    <span class="n">timeout</span> <span class="n">http</span><span class="o">-</span><span class="n">request</span>    <span class="mi">10</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">queue</span>           <span class="mi">1</span><span class="n">m</span>
    <span class="n">timeout</span> <span class="n">connect</span>         <span class="mi">10</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">client</span>          <span class="mi">1</span><span class="n">m</span>
    <span class="n">timeout</span> <span class="n">server</span>          <span class="mi">1</span><span class="n">m</span>
    <span class="n">timeout</span> <span class="n">http</span><span class="o">-</span><span class="n">keep</span><span class="o">-</span><span class="n">alive</span> <span class="mi">10</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">check</span>           <span class="mi">10</span><span class="n">s</span>
    <span class="n">maxconn</span>                 <span class="mi">3000</span>

<span class="c1">#---------------------------------------------------------------------</span>
<span class="c1"># main frontend which proxys to the backends</span>
<span class="c1">#---------------------------------------------------------------------</span>
<span class="n">frontend</span>  <span class="n">main</span> <span class="o">*</span><span class="p">:</span><span class="mi">5000</span>
    <span class="n">acl</span> <span class="n">url_static</span>       <span class="n">path_beg</span>       <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">static</span> <span class="o">/</span><span class="n">images</span> <span class="o">/</span><span class="n">javascript</span> <span class="o">/</span><span class="n">stylesheets</span>
    <span class="n">acl</span> <span class="n">url_static</span>       <span class="n">path_end</span>       <span class="o">-</span><span class="n">i</span> <span class="o">.</span><span class="n">jpg</span> <span class="o">.</span><span class="n">gif</span> <span class="o">.</span><span class="n">png</span> <span class="o">.</span><span class="n">css</span> <span class="o">.</span><span class="n">js</span>

    <span class="n">use_backend</span> <span class="n">static</span>          <span class="k">if</span> <span class="n">url_static</span>

<span class="c1">#---------------------------------------------------------------------</span>
<span class="c1"># static backend for serving up images, stylesheets and such</span>
<span class="c1">#---------------------------------------------------------------------</span>
<span class="n">backend</span> <span class="n">static</span>
    <span class="n">balance</span>     <span class="n">roundrobin</span>
    <span class="n">server</span>      <span class="n">static</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">4331</span> <span class="n">check</span>


<span class="n">frontend</span> <span class="n">main</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">3306</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">log</span> <span class="k">global</span>
    <span class="n">default_backend</span> <span class="n">mysqlservers</span>

<span class="n">frontend</span> <span class="n">redis6379</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">6379</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">log</span> <span class="k">global</span>
    <span class="n">default_backend</span> <span class="n">redis6379servers</span>

<span class="n">frontend</span> <span class="n">redis6380</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">6380</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">log</span> <span class="k">global</span>
    <span class="n">default_backend</span> <span class="n">redis6380servers</span>

<span class="c1">#---------------------------------------------------------------------</span>
<span class="c1"># round robin balancing between the various backends</span>

<span class="n">backend</span> <span class="n">mysqlservers</span>
    <span class="n">balance</span> <span class="n">leastconn</span>
    <span class="n">server</span> <span class="n">dbsrv1</span> <span class="mf">192.168.1.30</span><span class="p">:</span><span class="mi">13306</span> <span class="n">check</span>
    <span class="c1">#server dbsrv2 192.168.1.112:3306 check port 3306 intval 2 rise 1 fall 2 maxconn 300</span>

<span class="n">backend</span> <span class="n">redis6379servers</span>
    <span class="n">balance</span> <span class="n">leastconn</span>
    <span class="n">server</span> <span class="n">r16379</span> <span class="mf">192.168.1.30</span><span class="p">:</span><span class="mi">16379</span> <span class="n">check</span>

<span class="n">backend</span> <span class="n">redis6380servers</span>
    <span class="n">balance</span> <span class="n">leastconn</span>
    <span class="n">server</span> <span class="n">r16380</span> <span class="mf">192.168.1.30</span><span class="p">:</span><span class="mi">16380</span> <span class="n">check</span>
</pre></div>
</div>
<section id="github">
<h3><a class="toc-backref" href="#id39">代理github示例</a><a class="headerlink" href="#github" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>global
        log /dev/log    local0
        log /dev/log    local1 notice
        chroot /var/lib/haproxy
        #stats socket /run/haproxy/admin.sock mode 660 level admin
        stats socket /var/lib/haproxy/stats
        stats timeout 30s
        maxconn                 100000
        user haproxy
        group haproxy
        daemon

        # Default SSL material locations
        ca-base /etc/ssl/certs
        crt-base /etc/ssl/private

        # Default ciphers to use on SSL-enabled listening sockets.
        # For more information, see ciphers(1SSL). This list is from:
        #  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
        # An alternative list with additional directives can be obtained from
        #  https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxy
        ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS
        ssl-default-bind-options no-sslv3

defaults
        mode                    tcp
        log                     global
        retries                 3
        timeout queue           1m
        timeout connect         10s
        timeout client          1m
        timeout server          1m
        timeout check           10s
        maxconn                 100000

#---------------------------------------------------------------------
# gitee-proxy 30808 frontend which proxys to the backends
#---------------------------------------------------------------------
frontend  giteeproxy
        bind 0.0.0.0:30808
        mode tcp
        maxconn                 60000
        default_backend             giteeproxy

#---------------------------------------------------------------------
# static backend for serving up images, stylesheets and such
#---------------------------------------------------------------------
backend giteeproxy
        balance     static-rr
        server      proxy1 141.164.53.201:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy2 141.164.42.149:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy3 141.164.59.220:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy4 158.247.200.100:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy5 158.247.201.180:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy6 158.247.195.237:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy7 141.164.63.7:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy8 141.164.59.21:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy9 158.247.211.2:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy10 141.164.61.234:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy11 158.247.209.23:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy12 141.164.37.87:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy13 141.164.42.188:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy14 141.164.47.132:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy15 158.247.213.86:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy16 158.247.198.157:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy17 141.164.60.88:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy18 158.247.198.78:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy19 141.164.44.175:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
        server      proxy20 141.164.42.247:30443 maxconn 2000 inter 5000 rise 2 fall 5 weight 2
</pre></div>
</div>
</section>
</section>
<section id="id16">
<h2><a class="toc-backref" href="#id40"><span class="section-number">2.17.13. </span>启动</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">haproxy</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">cfg</span>
</pre></div>
</div>
</section>
<section id="id17">
<h2><a class="toc-backref" href="#id41"><span class="section-number">2.17.14. </span>查看状态</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.1.22</span><span class="p">:</span><span class="mi">1080</span><span class="o">/</span><span class="n">stats</span>

<span class="c1">#说明：</span>
<span class="c1">#1080即haproxy配置文件中监听端口</span>
<span class="n">s</span><span class="c1">#tats 即haproxy配置文件中的监听名称</span>
</pre></div>
</div>
</section>
<section id="openstackhaproxy">
<h2><a class="toc-backref" href="#id42"><span class="section-number">2.17.15. </span>openstack高可用haproxy配置</a><a class="headerlink" href="#openstackhaproxy" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#openstack高可用haproxy配置</span>

<span class="c1">###########全局配置#########</span>
    <span class="k">global</span>
    <span class="n">log</span> <span class="mf">127.0.0.1</span> <span class="n">local0</span>
    <span class="n">log</span> <span class="mf">127.0.0.1</span> <span class="n">local1</span> <span class="n">notice</span>
    <span class="n">daemon</span>
    <span class="c1">#nbproc 1     #进程数量</span>
    <span class="n">maxconn</span> <span class="mi">4096</span>  <span class="c1">#最大连接数</span>
    <span class="n">user</span> <span class="n">haproxy</span>  <span class="c1">#运行用户</span>
    <span class="n">group</span> <span class="n">haproxy</span> <span class="c1">#运行组</span>
    <span class="n">chroot</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">haproxy</span>
    <span class="n">pidfile</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">pid</span>
<span class="c1">########默认配置############</span>
    <span class="n">defaults</span>
    <span class="n">log</span> <span class="k">global</span>
    <span class="n">mode</span> <span class="n">http</span>            <span class="c1">#默认模式{ tcp|http|health }</span>
    <span class="n">option</span> <span class="n">httplog</span>       <span class="c1">#日志类别,采用httplog</span>
    <span class="n">option</span> <span class="n">dontlognull</span>   <span class="c1">#不记录健康检查日志信息</span>
    <span class="n">retries</span> <span class="mi">2</span>            <span class="c1">#2次连接失败不可用</span>
    <span class="n">option</span> <span class="n">forwardfor</span>    <span class="c1">#后端服务获得真实ip</span>
    <span class="n">option</span> <span class="n">httpclose</span>     <span class="c1">#请求完毕后主动关闭http通道</span>
    <span class="n">option</span> <span class="n">abortonclose</span>  <span class="c1">#服务器负载很高，自动结束比较久的链接</span>
    <span class="n">maxconn</span> <span class="mi">4096</span>         <span class="c1">#最大连接数</span>
    <span class="n">timeout</span> <span class="n">connect</span> <span class="mi">5</span><span class="n">m</span>   <span class="c1">#连接超时</span>
    <span class="n">timeout</span> <span class="n">client</span> <span class="mi">1</span><span class="n">m</span>    <span class="c1">#客户端超时</span>
    <span class="n">timeout</span> <span class="n">server</span> <span class="mi">31</span><span class="n">m</span>   <span class="c1">#服务器超时</span>
    <span class="n">timeout</span> <span class="n">check</span> <span class="mi">10</span><span class="n">s</span>    <span class="c1">#心跳检测超时</span>
    <span class="n">balance</span> <span class="n">roundrobin</span>   <span class="c1">#负载均衡方式，轮询</span>
<span class="c1">########统计页面配置########</span>
    <span class="n">listen</span> <span class="n">stats</span>
    <span class="n">bind</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">1080</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">option</span> <span class="n">httplog</span>
    <span class="n">log</span> <span class="mf">127.0.0.1</span> <span class="n">local0</span> <span class="n">err</span>
    <span class="n">stats</span> <span class="n">refresh</span> <span class="mi">30</span><span class="n">s</span>
    <span class="n">maxconn</span> <span class="mi">10</span>               <span class="c1">#最大连接数</span>
    <span class="n">stats</span> <span class="n">uri</span> <span class="o">/</span><span class="n">admin</span>         <span class="c1">#状态页面 http//ip:1080/admin访问</span>
    <span class="n">stats</span> <span class="n">realm</span> <span class="n">Haproxy</span>\ <span class="n">Statistics</span>
    <span class="n">stats</span> <span class="n">auth</span> <span class="n">admin</span><span class="p">:</span><span class="n">admin</span>   <span class="c1">#用户和密码:admin</span>
    <span class="n">stats</span> <span class="n">hide</span><span class="o">-</span><span class="n">version</span>       <span class="c1">#隐藏版本信息</span>
    <span class="n">stats</span> <span class="n">admin</span> <span class="k">if</span> <span class="n">TRUE</span>      <span class="c1">#设置手工启动/禁用</span>

<span class="c1">########以下为openstack高可用配置############</span>

<span class="c1">#dashboard_cluster</span>
<span class="n">listen</span> <span class="n">dashboard_cluster</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">80</span>
    <span class="n">balance</span>  <span class="n">roundrobin</span>
    <span class="c1">#balance  source</span>
    <span class="n">option</span>  <span class="n">tcpka</span>
    <span class="n">option</span>  <span class="n">httpchk</span>
    <span class="n">option</span>  <span class="n">tcplog</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">8080</span> <span class="n">check</span> <span class="n">port</span> <span class="mi">8080</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">8080</span> <span class="n">check</span> <span class="n">port</span> <span class="mi">8080</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">8080</span> <span class="n">check</span> <span class="n">port</span> <span class="mi">8080</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>

<span class="c1">#mariadb_cluster</span>
<span class="n">listen</span> <span class="n">mariadb_cluster</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">3306</span>
    <span class="n">balance</span> <span class="n">leastconn</span>
    <span class="n">option</span> <span class="n">mysql</span><span class="o">-</span><span class="n">check</span> <span class="n">user</span> <span class="n">haproxy</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">3306</span> <span class="n">weight</span> <span class="mi">1</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">3306</span> <span class="n">weight</span> <span class="mi">1</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">3306</span> <span class="n">weight</span> <span class="mi">1</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>

<span class="c1">#RabbitMQ_cluster</span>
<span class="n">listen</span> <span class="n">RabbitMQ</span><span class="o">-</span><span class="n">Server</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">5673</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">balance</span> <span class="n">roundrobin</span>
    <span class="n">option</span> <span class="n">tcpka</span>
    <span class="n">timeout</span> <span class="n">client</span>  <span class="mi">30</span><span class="n">m</span>
    <span class="n">timeout</span> <span class="n">server</span>  <span class="mi">30</span><span class="n">m</span>
    <span class="n">option</span>  <span class="n">clitcpka</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">5672</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">5</span><span class="n">s</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">5672</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">5</span><span class="n">s</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">5672</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">5</span><span class="n">s</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>

<span class="c1">#RabbitMQ</span>
<span class="n">listen</span> <span class="n">RabbitMQ</span><span class="o">-</span><span class="n">Web</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">15673</span>
    <span class="n">balance</span> <span class="n">roundrobin</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">option</span> <span class="n">tcpka</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">15672</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">5</span><span class="n">s</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">15672</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">5</span><span class="n">s</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">15672</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">5</span><span class="n">s</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">3</span>
<span class="c1">#</span>

<span class="c1">#keystone</span>
<span class="n">listen</span> <span class="n">keystone_admin_cluster</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">35357</span>
    <span class="c1">#balance  source</span>
    <span class="n">option</span>  <span class="n">tcpka</span>
    <span class="n">option</span>  <span class="n">httpchk</span>
    <span class="n">option</span>  <span class="n">tcplog</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">35356</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">35356</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">35356</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>

<span class="n">listen</span> <span class="n">keystone_public_cluster</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">5000</span>
    <span class="c1">#balance  source</span>
    <span class="n">option</span>  <span class="n">tcpka</span>
    <span class="n">option</span>  <span class="n">httpchk</span>
    <span class="n">option</span>  <span class="n">tcplog</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">4999</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">4999</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">4999</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>

<span class="c1">#glance_api_cluster</span>
<span class="n">listen</span> <span class="n">glance_api_cluster</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">9292</span>
    <span class="c1">#balance  source</span>
    <span class="n">option</span>  <span class="n">tcpka</span>
    <span class="n">option</span>  <span class="n">httpchk</span>
    <span class="n">option</span>  <span class="n">tcplog</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">9292</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">9292</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">9292</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
<span class="c1">#</span>
<span class="n">listen</span> <span class="n">glance_registry_cluster</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">9191</span>
    <span class="n">balance</span>  <span class="n">source</span>
    <span class="n">option</span>  <span class="n">tcpka</span>
    <span class="n">option</span>  <span class="n">tcplog</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">9191</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">9191</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">9191</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>


<span class="c1">##nova_compute</span>
<span class="n">listen</span> <span class="n">nova_compute_api_cluster</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">8774</span>
    <span class="c1">#balance source</span>
    <span class="n">option</span> <span class="n">tcpka</span>
    <span class="n">option</span> <span class="n">httpchk</span>
    <span class="n">option</span> <span class="n">tcplog</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">8774</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">8774</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">8774</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
<span class="c1">#Nova-api-metadata</span>
<span class="n">listen</span> <span class="n">Nova</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">metadata_cluster</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">8775</span>
    <span class="n">balance</span> <span class="n">source</span>
    <span class="n">option</span> <span class="n">tcpka</span>
    <span class="n">option</span> <span class="n">httpchk</span>
    <span class="n">option</span> <span class="n">tcplog</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">8775</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">8775</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">8775</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
<span class="c1">#nova_placement</span>
<span class="n">listen</span> <span class="n">nova_placement_cluster</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">8778</span>
    <span class="c1">#balance source</span>
    <span class="n">option</span> <span class="n">tcpka</span>
    <span class="n">option</span> <span class="n">tcplog</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">9778</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">9778</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">9778</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
<span class="c1">#nova_vncproxy</span>
<span class="n">listen</span> <span class="n">nova_vncproxy_cluster</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">6080</span>
    <span class="c1">#balance source</span>
    <span class="n">option</span> <span class="n">tcpka</span>
    <span class="n">option</span> <span class="n">tcplog</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">6080</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">6080</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">6080</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>

<span class="c1">#Neutron_API</span>
<span class="n">listen</span> <span class="n">Neutron_API_cluster</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">9696</span>
    <span class="c1">#balance source</span>
    <span class="n">option</span> <span class="n">tcpka</span>
    <span class="n">option</span> <span class="n">tcplog</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">9696</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">9696</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">9696</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
<span class="c1">#Cinder_API_cluster</span>
<span class="n">listen</span> <span class="n">Cinder_API_cluster</span>
    <span class="n">bind</span> <span class="n">controller</span><span class="p">:</span><span class="mi">8776</span>
    <span class="c1">#balance source</span>
    <span class="n">option</span> <span class="n">tcpka</span>
    <span class="n">option</span> <span class="n">httpchk</span>
    <span class="n">option</span> <span class="n">tcplog</span>
    <span class="n">server</span> <span class="n">controller1</span> <span class="n">controller1</span><span class="p">:</span><span class="mi">8776</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller2</span> <span class="n">controller2</span><span class="p">:</span><span class="mi">8776</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
    <span class="n">server</span> <span class="n">controller3</span> <span class="n">controller3</span><span class="p">:</span><span class="mi">8776</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
<span class="c1">#</span>
</pre></div>
</div>
<p>文章来源文献： <a class="reference external" href="https://www.cnblogs.com/MacoLee/p/5853413.html">https://www.cnblogs.com/MacoLee/p/5853413.html</a></p>
<p>haproxy1.7编译安装配置 <a class="reference external" href="https://www.cnblogs.com/elvi/p/7717582.html">https://www.cnblogs.com/elvi/p/7717582.html</a></p>
<p><a class="reference external" href="https://www.cnblogs.com/saneri/p/12195837.html">https://www.cnblogs.com/saneri/p/12195837.html</a></p>
</section>
<section id="haproxy-ssl">
<h2><a class="toc-backref" href="#id43"><span class="section-number">2.17.16. </span>haproxy ssl 配置方式</a><a class="headerlink" href="#haproxy-ssl" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>参考文献</p>
<p><a class="reference external" href="https://www.cnblogs.com/xu360/articles/6593837.html">https://www.cnblogs.com/xu360/articles/6593837.html</a></p>
</div></blockquote>
<p>参考文献：</p>
<p><a class="reference external" href="https://www.bookstack.cn/books/HAProxy-zh">HAProxy用法详解
全网最详细中文文档</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="15.CentOS7%E5%AE%89%E8%A3%85xrdp%28windows%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E8%BF%9E%E6%8E%A5linux%29.html" class="btn btn-neutral float-left" title="2.16. CentOS7安装xrdp(windows远程桌面连接linux)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="20.%E5%9B%BD%E5%86%85%E5%B8%B8%E4%BD%BF%E7%94%A8%E7%9A%84yum%E6%BA%90%E4%BF%A1%E6%81%AF.html" class="btn btn-neutral float-right" title="2.18. 国内常使用的yum源信息" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>