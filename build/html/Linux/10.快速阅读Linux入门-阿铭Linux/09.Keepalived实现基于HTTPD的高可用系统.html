<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>10.9. Keepalived实现基于HTTPD的高可用系统 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="10.10. 搭建HAProxy+Keepalived高可用负载均衡系统" href="10.%E6%90%AD%E5%BB%BAHAProxy%2BKeepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%B3%BB%E7%BB%9F.html" />
    <link rel="prev" title="10.8. 虚拟化与集群应用篇" href="08.%E8%99%9A%E6%8B%9F%E5%8C%96%E4%B8%8E%E9%9B%86%E7%BE%A4%E5%BA%94%E7%94%A8%E7%AF%87.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> 小健_Linux-shell-Devops_Blog
            <img src="../../_static/devops_photo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../DevOps/index.html">DevOps和自动化运维实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Github/index.html">Github入门到实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Jenkins/index.html">Jenkins持续化集成</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../KVM/index.html">KVM实践</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01.%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%92%8C%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/index.html">1. 命令行和操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02.Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%B6%E8%AE%BE/index.html">2. Linux服务器架设</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03.%E7%8E%A9%E8%BD%ACshell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/index.html">3. 玩转shell脚本编程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04.%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%88mysql%E3%80%81Redis%EF%BC%89/index.html">4. 玩转数据库(mysql、Redis)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05.Nginx%E5%AD%A6%E4%B9%A0/index.html">5. Nginx学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06.LAMP%E3%80%81LNMP%E5%AD%A6%E4%B9%A0/index.html">6. LNMP、LAMP学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07.Zabbix%E7%9B%91%E6%8E%A7%E4%BC%81%E4%B8%9A%E5%AE%9E%E6%88%98/index.html">7. Zabbix监控企业实战</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08.Linux%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84/index.html">8. 构建Linux高可用架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09.Zabbix3.0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/index.html">9. Zabbix3.0入门到精通</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">10. 快速阅读Linux入门-阿铭Linux</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="01.awk%E7%BB%83%E4%B9%A0%E9%A2%98%E6%B5%8B%E8%AF%95.html">10.1. awk练习题测试</a></li>
<li class="toctree-l3"><a class="reference internal" href="02.sed%E7%BB%83%E4%B9%A0%E9%A2%98%E6%B5%8B%E8%AF%95.html">10.2. sed练习题测试</a></li>
<li class="toctree-l3"><a class="reference internal" href="03.xargs%E4%B8%8Eexec.html">10.3. xargs与exec</a></li>
<li class="toctree-l3"><a class="reference internal" href="04.Nginx%E7%B3%BB%E5%88%97.html">10.4. Nginx系列</a></li>
<li class="toctree-l3"><a class="reference internal" href="05.Keepalived%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8ENginx%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8.html">10.5. Keepalived实现基于Nginx的高可用</a></li>
<li class="toctree-l3"><a class="reference internal" href="06.%E4%B8%80%E4%B8%AA%E9%82%AE%E4%BB%B6%E6%8A%A5%E8%AD%A6%E7%9A%84%E5%B0%8F%E8%84%9A%E6%9C%AC.html">10.6. 一个邮件报警的小脚本</a></li>
<li class="toctree-l3"><a class="reference internal" href="07.Keepalived%E5%AE%9E%E7%8E%B0MySQL%E5%8F%8C%E4%B8%BB%E9%AB%98%E5%8F%AF%E7%94%A8.html">10.7. Keepalived实现MySQL双主高可用</a></li>
<li class="toctree-l3"><a class="reference internal" href="08.%E8%99%9A%E6%8B%9F%E5%8C%96%E4%B8%8E%E9%9B%86%E7%BE%A4%E5%BA%94%E7%94%A8%E7%AF%87.html">10.8. 虚拟化与集群应用篇</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">10.9. Keepalived实现基于HTTPD的高可用系统</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#keepalived">10.9.1. Keepalived高可用集群环境部署说明</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">10.9.2. 环境准备</a></li>
<li class="toctree-l4"><a class="reference internal" href="#keepalived-master">10.9.3. keepalived_master</a></li>
<li class="toctree-l4"><a class="reference internal" href="#keepalived-backup">10.9.4. keepalived_backup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vrrp-script">10.9.5. 通过vrrp_script实现对集群资源的监控</a></li>
<li class="toctree-l4"><a class="reference internal" href="#keepalivedmasterbackup">10.9.6. Keepalived集群中Master和Backup角色选举策略</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="10.%E6%90%AD%E5%BB%BAHAProxy%2BKeepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%B3%BB%E7%BB%9F.html">10.10. 搭建HAProxy+Keepalived高可用负载均衡系统</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Mysql/index.html">Mysql王者之路</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other/index.html">Other</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Network_route_switch/index.html">Network_route_switch</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">小健_Linux-shell-Devops_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Linux</a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">10. </span>快速阅读Linux入门-阿铭Linux</a> &raquo;</li>
      <li><span class="section-number">10.9. </span>Keepalived实现基于HTTPD的高可用系统</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Linux/10.快速阅读Linux入门-阿铭Linux/09.Keepalived实现基于HTTPD的高可用系统.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#keepalivedhttpd" id="id5">Keepalived实现基于HTTPD的高可用系统</a></p>
<ul>
<li><p><a class="reference internal" href="#keepalived" id="id6">Keepalived高可用集群环境部署说明</a></p></li>
<li><p><a class="reference internal" href="#id1" id="id7">环境准备</a></p></li>
<li><p><a class="reference internal" href="#keepalived-master" id="id8">keepalived_master</a></p></li>
<li><p><a class="reference internal" href="#keepalived-backup" id="id9">keepalived_backup</a></p>
<ul>
<li><p><a class="reference internal" href="#httpd" id="id10">在主机上停止httpd</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id11">备机切换成主机</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#vrrp-script" id="id12">通过vrrp_script实现对集群资源的监控</a></p>
<ul>
<li><p><a class="reference internal" href="#killall" id="id13">1.通过killall命令监控服务运行状态</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id14">2.检测端口运行状态</a></p></li>
<li><p><a class="reference internal" href="#shell" id="id15">3.通过shell语句进行状态监控</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id16">4.通过脚本进行服务状态监控</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#keepalivedmasterbackup" id="id17">Keepalived集群中Master和Backup角色选举策略</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="keepalivedhttpd">
<h1><a class="toc-backref" href="#id5"><span class="section-number">10.9. </span>Keepalived实现基于HTTPD的高可用系统</a><a class="headerlink" href="#keepalivedhttpd" title="Permalink to this headline">¶</a></h1>
<section id="keepalived">
<h2><a class="toc-backref" href="#id6"><span class="section-number">10.9.1. </span>Keepalived高可用集群环境部署说明</a><a class="headerlink" href="#keepalived" title="Permalink to this headline">¶</a></h2>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 19%" />
<col style="width: 23%" />
<col style="width: 13%" />
<col style="width: 19%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>主机名</p></th>
<th class="head"><p>主机IP地址</p></th>
<th class="head"><p>集群角色</p></th>
<th class="head"><p>集群服务</p></th>
<th class="head"><p>MySQL VIP</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>keepalived-master</p></td>
<td><p>192.168.0.128</p></td>
<td><p>Master(主节点)</p></td>
<td><p>HTTPD</p></td>
<td><p>192.168.0.130</p></td>
</tr>
<tr class="row-odd"><td><p>keepalived-backup</p></td>
<td><p>192.168.0.129</p></td>
<td><p>Backup(备用节点)</p></td>
<td><p>HTTP</p></td>
<td><p>192.168.0.130</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id1">
<h2><a class="toc-backref" href="#id7"><span class="section-number">10.9.2. </span>环境准备</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">keepalived-master</span></code>和<code class="docutils literal notranslate"><span class="pre">keepalived-backup</span></code>上安装httpd服务。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">httpd</span>
<span class="n">echo</span> <span class="s2">&quot;&lt;h1&gt; hello hujianli web1&lt;h1&gt;&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">httpd</span>

<span class="n">systemctl</span> <span class="n">disable</span> <span class="n">firewalld</span><span class="o">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">stop</span> <span class="n">firewalld</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
<p>检查http安装后的状态。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@keepalived</span><span class="o">-</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="c1"># curl 127.0.0.1</span>
<span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span> <span class="n">hello</span> <span class="n">hujianli</span> <span class="n">web1</span><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@keepalived</span><span class="o">-</span><span class="n">backup</span> <span class="o">~</span><span class="p">]</span><span class="c1"># curl 127.0.0.1</span>
<span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span> <span class="n">hello</span> <span class="n">hujianli</span> <span class="n">web1</span><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="keepalived-master">
<h2><a class="toc-backref" href="#id8"><span class="section-number">10.9.3. </span>keepalived_master</a><a class="headerlink" href="#keepalived-master" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">/etc/keepalived/keepalived.conf</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>! Configuration File for keepalived

global_defs {
    notification_email {
        root@localhost
    }
    notification_email_from keepalived@localhost
    smtp_server 127.0.0.1
    smtp_connect_timeout 30
    script_user root
    enable_script_security
    route_id httpd_keep
}
vrrp_script chk_httpd
{
    script  &quot;/usr/bin/killall -0 httpd&quot;
    interval 5
}

vrrp_instance VI_1 {
    state MASTER
    interface ens32
    virtual_router_id 151
    priority 100
    nopreempt
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    notify_master &quot;/etc/keepalived/master.sh &quot;
    notify_backup &quot;/etc/keepalived/backup.sh&quot;
    notify_fault &quot;/etc/keepalived/fault.sh&quot;
    track_script {
        chk_httpd
    }
    virtual_ipaddress {
        192.168.0.130/24
    }

}
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/etc/keepalived/master.sh</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
LOGFILE=/var/log/keepalived-mysql-state.log
echo  &quot;[Master]&quot;  &gt;&gt;  $LOGFILE
date  &gt;&gt;  $LOGFILE
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/etc/keepalived/backup.sh</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
LOGFILE=/var/log/keepalived-mysql-state.log
echo  &quot;[Backup]&quot;  &gt;&gt;  $LOGFILE
date  &gt;&gt;  $LOGFILE
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/etc/keepalived/fault.sh</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
LOGFILE=/var/log/keepalived-mysql-state.log
echo  &quot;[FAULT]&quot;  &gt;&gt;  $LOGFILE
date  &gt;&gt;  $LOGFILE
</pre></div>
</div>
</section>
<section id="keepalived-backup">
<h2><a class="toc-backref" href="#id9"><span class="section-number">10.9.4. </span>keepalived_backup</a><a class="headerlink" href="#keepalived-backup" title="Permalink to this headline">¶</a></h2>
<p>keepalived-backup节点上的keepalived.conf配置文件内容与keepalived-master节点上的基本相同，
需要修改的地方有两个。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>将“state MASTER”更改为“state BACKUP”。
将priority 100更改为一个较小的值，这里改为“priority 80”。
</pre></div>
</div>
<p>将配置好的
<code class="docutils literal notranslate"><span class="pre">keepalived.conf</span></code>文件及<code class="docutils literal notranslate"><span class="pre">master.sh</span></code>、<code class="docutils literal notranslate"><span class="pre">backup.sh</span></code>、<code class="docutils literal notranslate"><span class="pre">fault.sh</span></code>三个文件一起复制到keepalived-backup
备用节点对应的路径下，</p>
<p>Keepalived启动过程分析</p>
<p>主机</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@keepalived</span><span class="o">-</span><span class="n">master</span> <span class="n">keepalived</span><span class="p">]</span><span class="c1"># ip a</span>
<span class="mi">2</span><span class="p">:</span> <span class="n">ens32</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span> <span class="n">qdisc</span> <span class="n">pfifo_fast</span> <span class="n">state</span> <span class="n">UP</span> <span class="n">group</span> <span class="n">default</span> <span class="n">qlen</span> <span class="mi">1000</span>
    <span class="n">link</span><span class="o">/</span><span class="n">ether</span> <span class="mi">00</span><span class="p">:</span><span class="mi">0</span><span class="n">c</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">6</span><span class="n">e</span><span class="p">:</span><span class="mi">3</span><span class="n">d</span><span class="p">:</span><span class="n">f6</span> <span class="n">brd</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span>
    <span class="n">inet</span> <span class="mf">192.168.0.128</span><span class="o">/</span><span class="mi">24</span> <span class="n">brd</span> <span class="mf">192.168.0.255</span> <span class="n">scope</span> <span class="k">global</span> <span class="n">noprefixroute</span> <span class="n">dynamic</span> <span class="n">ens32</span>
       <span class="n">valid_lft</span> <span class="mi">84056</span><span class="n">sec</span> <span class="n">preferred_lft</span> <span class="mi">84056</span><span class="n">sec</span>
    <span class="n">inet</span> <span class="mf">192.168.0.130</span><span class="o">/</span><span class="mi">24</span> <span class="n">scope</span> <span class="k">global</span> <span class="n">secondary</span> <span class="n">ens32</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
    <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">14</span><span class="n">d7</span><span class="p">:</span><span class="mi">407</span><span class="n">e</span><span class="p">:</span><span class="n">aeb6</span><span class="p">:</span><span class="mi">6</span><span class="n">a42</span><span class="o">/</span><span class="mi">64</span> <span class="n">scope</span> <span class="n">link</span> <span class="n">tentative</span> <span class="n">noprefixroute</span> <span class="n">dadfailed</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
    <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">44</span><span class="n">c2</span><span class="p">:</span><span class="mi">32</span><span class="n">ba</span><span class="p">:</span><span class="n">d50e</span><span class="p">:</span><span class="mi">44</span><span class="n">c3</span><span class="o">/</span><span class="mi">64</span> <span class="n">scope</span> <span class="n">link</span> <span class="n">noprefixroute</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>

<span class="p">[</span><span class="n">root</span><span class="nd">@keepalived</span><span class="o">-</span><span class="n">master</span> <span class="n">keepalived</span><span class="p">]</span><span class="c1"># cat /var/log/keepalived-mysql-state.log</span>
<span class="p">[</span><span class="n">Master</span><span class="p">]</span>
<span class="mi">2020</span><span class="n">年</span> <span class="mi">03</span><span class="n">月</span> <span class="mi">28</span><span class="n">日</span> <span class="n">星期六</span> <span class="mi">13</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">07</span> <span class="n">CST</span>
</pre></div>
</div>
<p>备机</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@keepalived</span><span class="o">-</span><span class="n">backup</span> <span class="n">keepalived</span><span class="p">]</span><span class="c1"># cat /var/log/keepalived-mysql-state.log</span>
<span class="p">[</span><span class="n">Backup</span><span class="p">]</span>
<span class="mi">2020</span><span class="n">年</span> <span class="mi">03</span><span class="n">月</span> <span class="mi">28</span><span class="n">日</span> <span class="n">星期六</span> <span class="mi">13</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">11</span> <span class="n">CST</span>
</pre></div>
</div>
<section id="httpd">
<h3><a class="toc-backref" href="#id10">在主机上停止httpd</a><a class="headerlink" href="#httpd" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@keepalived</span><span class="o">-</span><span class="n">master</span> <span class="n">keepalived</span><span class="p">]</span><span class="c1"># cat /var/log/keepalived-mysql-state.log</span>
<span class="p">[</span><span class="n">Master</span><span class="p">]</span>
<span class="mi">2020</span><span class="n">年</span> <span class="mi">03</span><span class="n">月</span> <span class="mi">28</span><span class="n">日</span> <span class="n">星期六</span> <span class="mi">14</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">03</span> <span class="n">CST</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@keepalived</span><span class="o">-</span><span class="n">master</span> <span class="n">keepalived</span><span class="p">]</span><span class="c1"># systemctl stop httpd</span>


<span class="c1">#### 主机进入fault的状态</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@keepalived</span><span class="o">-</span><span class="n">master</span> <span class="n">keepalived</span><span class="p">]</span><span class="c1"># cat /var/log/keepalived-mysql-state.log</span>
<span class="p">[</span><span class="n">Master</span><span class="p">]</span>
<span class="mi">2020</span><span class="n">年</span> <span class="mi">03</span><span class="n">月</span> <span class="mi">28</span><span class="n">日</span> <span class="n">星期六</span> <span class="mi">14</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">03</span> <span class="n">CST</span>
<span class="p">[</span><span class="n">Fault</span><span class="p">]</span>
<span class="mi">2020</span><span class="n">年</span> <span class="mi">03</span><span class="n">月</span> <span class="mi">28</span><span class="n">日</span> <span class="n">星期六</span> <span class="mi">14</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">34</span> <span class="n">CST</span>
</pre></div>
</div>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id11">备机切换成主机</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@keepalived</span><span class="o">-</span><span class="n">backup</span> <span class="n">keepalived</span><span class="p">]</span><span class="c1"># ip a</span>
<span class="mi">2</span><span class="p">:</span> <span class="n">ens32</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span> <span class="n">qdisc</span> <span class="n">pfifo_fast</span> <span class="n">state</span> <span class="n">UP</span> <span class="n">group</span> <span class="n">default</span> <span class="n">qlen</span> <span class="mi">1000</span>
    <span class="n">link</span><span class="o">/</span><span class="n">ether</span> <span class="mi">00</span><span class="p">:</span><span class="mi">0</span><span class="n">c</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="n">f6</span><span class="p">:</span><span class="mi">8</span><span class="n">a</span><span class="p">:</span><span class="mi">13</span> <span class="n">brd</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span>
    <span class="n">inet</span> <span class="mf">192.168.0.129</span><span class="o">/</span><span class="mi">24</span> <span class="n">brd</span> <span class="mf">192.168.0.255</span> <span class="n">scope</span> <span class="k">global</span> <span class="n">noprefixroute</span> <span class="n">dynamic</span> <span class="n">ens32</span>
       <span class="n">valid_lft</span> <span class="mi">81044</span><span class="n">sec</span> <span class="n">preferred_lft</span> <span class="mi">81044</span><span class="n">sec</span>
    <span class="n">inet</span> <span class="mf">192.168.0.130</span><span class="o">/</span><span class="mi">24</span> <span class="n">scope</span> <span class="k">global</span> <span class="n">secondary</span> <span class="n">ens32</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
    <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">14</span><span class="n">d7</span><span class="p">:</span><span class="mi">407</span><span class="n">e</span><span class="p">:</span><span class="n">aeb6</span><span class="p">:</span><span class="mi">6</span><span class="n">a42</span><span class="o">/</span><span class="mi">64</span> <span class="n">scope</span> <span class="n">link</span> <span class="n">noprefixroute</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>

<span class="p">[</span><span class="n">root</span><span class="nd">@keepalived</span><span class="o">-</span><span class="n">backup</span> <span class="n">keepalived</span><span class="p">]</span><span class="c1"># cat /var/log/keepalived-mysql-state.log</span>
<span class="p">[</span><span class="n">Backup</span><span class="p">]</span>
<span class="mi">2020</span><span class="n">年</span> <span class="mi">03</span><span class="n">月</span> <span class="mi">28</span><span class="n">日</span> <span class="n">星期六</span> <span class="mi">14</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">08</span> <span class="n">CST</span>
<span class="p">[</span><span class="n">Master</span><span class="p">]</span>
<span class="mi">2020</span><span class="n">年</span> <span class="mi">03</span><span class="n">月</span> <span class="mi">28</span><span class="n">日</span> <span class="n">星期六</span> <span class="mi">14</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">35</span> <span class="n">CST</span>
</pre></div>
</div>
<p>主机上启动httpd服务后，状态立马变成backup状态</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@keepalived</span><span class="o">-</span><span class="n">master</span> <span class="n">keepalived</span><span class="p">]</span><span class="c1"># systemctl start httpd</span>
</pre></div>
</div>
<p>日志信息</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Mar</span> <span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">54</span> <span class="n">keepalived</span><span class="o">-</span><span class="n">master</span> <span class="n">systemd</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">The</span> <span class="n">Apache</span> <span class="n">HTTP</span> <span class="n">Server</span><span class="o">...</span>
<span class="n">Mar</span> <span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">58</span> <span class="n">keepalived</span><span class="o">-</span><span class="n">master</span> <span class="n">Keepalived_vrrp</span><span class="p">[</span><span class="mi">11022</span><span class="p">]:</span> <span class="n">VRRP_Script</span><span class="p">(</span><span class="n">chk_httpd</span><span class="p">)</span> <span class="n">succeeded</span>
<span class="n">Mar</span> <span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">59</span> <span class="n">keepalived</span><span class="o">-</span><span class="n">master</span> <span class="n">Keepalived_vrrp</span><span class="p">[</span><span class="mi">11022</span><span class="p">]:</span> <span class="n">VRRP_Instance</span><span class="p">(</span><span class="n">VI_1</span><span class="p">)</span> <span class="n">Entering</span> <span class="n">BACKUP</span> <span class="n">STATE</span>
<span class="n">Mar</span> <span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">01</span> <span class="n">keepalived</span><span class="o">-</span><span class="n">master</span> <span class="n">httpd</span><span class="p">:</span> <span class="n">AH00558</span><span class="p">:</span> <span class="n">httpd</span><span class="p">:</span> <span class="n">Could</span> <span class="ow">not</span> <span class="n">reliably</span> <span class="n">determine</span> <span class="n">the</span> <span class="n">server</span><span class="s1">&#39;s fully qualified domain name, using fe80::44c2:32ba:d50e:44c3.</span>
<span class="n">Set</span> <span class="n">the</span> <span class="s1">&#39;ServerName&#39;</span> <span class="n">directive</span> <span class="n">globally</span> <span class="n">to</span> <span class="n">suppress</span> <span class="n">this</span> <span class="n">messageMar</span> <span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">03</span> <span class="n">keepalived</span><span class="o">-</span><span class="n">master</span> <span class="n">systemd</span><span class="p">:</span> <span class="n">Started</span> <span class="n">The</span> <span class="n">Apache</span> <span class="n">HTTP</span> <span class="n">Server</span><span class="o">.</span>
<span class="n">Mar</span> <span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">01</span> <span class="n">keepalived</span><span class="o">-</span><span class="n">master</span> <span class="n">systemd</span><span class="p">:</span> <span class="n">Started</span> <span class="n">Session</span> <span class="mi">23</span> <span class="n">of</span> <span class="n">user</span> <span class="n">root</span><span class="o">.</span>
</pre></div>
</div>
<p>Keepalived配置中的一个通知机制，也是Keepalived包含的4种状态。下面介绍每个选项的含义。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>notify_master：指定当Keepalived进入Master状态时要执行的脚本，这个脚本可以是一个状态报警脚本，也可以是一个服务管理脚本。Keepalived允许脚本传入参数，因此灵活性很强。

notify_backup：指定当Keepalived进入Backup状态时要执行的脚本，同理，这个脚本可以是一个状态报警脚本，也可以是一个服务管理脚本。

notify_fault：指定当Keepalived进入Fault状态时要执行的脚本，脚本功能与前两个类似。

notify_stop：指定当Keepalived程序终止时需要执行的脚本。
</pre></div>
</div>
</section>
</section>
<section id="vrrp-script">
<h2><a class="toc-backref" href="#id12"><span class="section-number">10.9.5. </span>通过vrrp_script实现对集群资源的监控</a><a class="headerlink" href="#vrrp-script" title="Permalink to this headline">¶</a></h2>
<section id="killall">
<h3><a class="toc-backref" href="#id13">1.通过killall命令监控服务运行状态</a><a class="headerlink" href="#killall" title="Permalink to this headline">¶</a></h3>
<p>这里要用到的信号为0，代号为0的信号并不表示要关闭某个程序，而表示对程序（进程）的运行状态进行监控，
如果发现进程关闭或其他异常，将返回状态码1，反之，如果发现进程运行正常，将返回状态码0。vrrp_script模块正是利用了killall命令的这个特性，变相地实现了对服务运行状态的监控。下面看一个实例。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vrrp_script</span> <span class="n">check_mysqld</span> <span class="p">{</span>
      <span class="n">script</span>  <span class="s2">&quot;killall  -0  mysqld&quot;</span>
      <span class="n">interval</span>  <span class="mi">2</span>
      <span class="p">}</span>
  <span class="n">track_script</span> <span class="p">{</span>
      <span class="n">check_mysqld</span>
      <span class="p">}</span>
</pre></div>
</div>
<p>rrp_script模块其实并不关注监控脚本或监控命令是如何实现的，它仅仅通过监控脚本的返回状态码来识别集群服务是否正常，如果返回的状态码为
0，那么就认为服务正常，如果返回的状态码为 1，则认为服务故障。</p>
</section>
<section id="id3">
<h3><a class="toc-backref" href="#id14">2.检测端口运行状态</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>检测端口的运行状态，也是最常见的服务监控方式。在Keepalived的vrrp_script模块中可以通过如下方式对本机的端口进行检测。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    vrrp_script check_httpd {
        script &quot;&lt;/dev/tcp/127.0.0.1/80&quot;
        interval  2

    vrrp_script check_mysqld {
        script  &quot;killall  -0  mysqld&quot;
        interval  2
        }
    track_script {
        check_mysqld
        }
在这个例子中，定义了一个服务监控模块check_mysqld，其采用的监控方式是通过“killall-0 mysqld”，其中“interval”选项用于设置检查的时间间隔，即2秒钟执行一次检测。

在mysql服务运行正常的情况下，通过killall命令检测的结果如下。


    [root@keepalived-master ～]# killall -0 mysqld
    [root@keepalived-master ～]# echo $?
    0
这里通过“echo $?”方式显示了上个命令返回的状态码，mysql服务运行正常，因此返回的状态码为0，此时check_mysqld模块将返回服务检测正常的提示。接着将mysql服务关闭，再次执行检测，结果如下。


    [root@keepalived-master ～]#   killall -0 mysqld
    mysqld:  no  process  killed
    [root@keepalived-master ～]# echo $?
    1
由于mysql服务被关闭，因此返回的状态码为1，此时check_mysqld模块将返回服务检测失败的提示。然后根据vrrp_script模块中设定的“weight”值重新设置Keepalived主、备节点的优先级，进而引发主、备节点发生切换。

从这个过程可以看到，vrrp_script模块其实并不关注监控脚本或监控命令是如何实现的，它仅仅通过监控脚本的返回状态码来识别集群服务是否正常，如果返回的状态码为 0，那么就认为服务正常，如果返回的状态码为 1，则认为服务故障。明白了这个原理之后，在进行自定义监控脚本的时候，只需按照这个原则来编写即可。

2.检测端口运行状态

检测端口的运行状态，也是最常见的服务监控方式。在Keepalived的vrrp_script模块中可以通过如下方式对本机的端口进行检测。


    vrrp_script check_httpd {
        script &quot;&lt;/dev/tcp/127.0.0.1/80&quot;
        interval  2
        fall    2
        rise    1
        }
    track_script {
        check_httpd
        }
</pre></div>
</div>
<p>其中，“fall”选项表示检测到失败的最大次数。也就是说，如果请求失败两次，就认为此节点资源发生故障，将进行切换操作；“rise”表示如果请求一次成功，就认为此节点资源恢复正常。</p>
</section>
<section id="shell">
<h3><a class="toc-backref" href="#id15">3.通过shell语句进行状态监控</a><a class="headerlink" href="#shell" title="Permalink to this headline">¶</a></h3>
<p>在Keepalived的vrrp_script模块中甚至可以直接引用shell语句进行状态监控。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vrrp_script</span> <span class="n">chk_httpd</span> <span class="p">{</span>
    <span class="n">script</span> <span class="s2">&quot;if [ -f /var/run/httpd/httpd.pid ]; then exit 0; else exit 1; fi&quot;</span>
    <span class="n">interval</span>  <span class="mi">2</span>
    <span class="n">fall</span>    <span class="mi">1</span>
    <span class="n">rise</span>    <span class="mi">1</span>
    <span class="p">}</span>
<span class="n">track_script</span> <span class="p">{</span>
    <span class="n">chk_httpd</span>
    <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id16">4.通过脚本进行服务状态监控</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>这是最常见的监控方式，其监控过程类似于Nagios的执行方式。不同的是，这里只有0、1两种返回状态。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vrrp_script</span> <span class="n">chk_mysqld</span> <span class="p">{</span>
    <span class="n">script</span> <span class="s2">&quot;/etc/keepalived/check_mysqld.sh&quot;</span>
    <span class="n">interval</span>  <span class="mi">2</span>
    <span class="p">}</span>
    <span class="n">track_script</span> <span class="p">{</span>
    <span class="n">chk_mysqld</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>check_mysqld.sh的内容如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
MYSQL=/usr/bin/mysql
MYSQL_HOST=localhost
MYSQL_USER=root
MYSQL_PASSWORD=&#39;xxxxxx&#39;
$MYSQL -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD -e &quot;show status;&quot; &gt; /dev/null 2&gt;&amp;1
if  [  $?  =  0  ]  ;then
    MYSQL_STATUS=0
else
    MYSQL_STATUS=1
fi
    exit $MYSQL_STATUS
</pre></div>
</div>
</section>
</section>
<section id="keepalivedmasterbackup">
<h2><a class="toc-backref" href="#id17"><span class="section-number">10.9.6. </span>Keepalived集群中Master和Backup角色选举策略</a><a class="headerlink" href="#keepalivedmasterbackup" title="Permalink to this headline">¶</a></h2>
<p>在Keepalived集群中，其实并没有严格意义上的主、备节点，虽然可以在Keepalived配置文件中设置state选项为MASTER状态，但是这并不意味着此节点一直就是MASTER角色。控制节点角色的是Keepalived配置文件中的priority值，但它并不控制所有节点的角色，另一个能改变节点角色的是在vrrp_script模块中设置的weight值，这两个选项对应的都是一个整数值，其中weight值可以是个负整数，一个节点在集群中的角色就是通过这两个值的大小决定的。</p>
<p>在一个一主多备的Keepalived集群中，priority值最大的将成为集群中的MASTER节点，而其他都是BACKUP节点。在MASTER节点发生故障后，BACKUP节点之间将进行“民主选举”，通过对节点优先级值priority和weight的计算，选出新的MASTER节点接管集群服务。</p>
<p>在vrrp_script模块中，如果不设置weight选项值，那么集群优先级的选择将由Keepalived配置文件中的priority值决定，而在需要对集群中优先级进行灵活控制时，可以通过在vrrp_script模块中设置weight值来实现。下面列举一个实例来具体说明。</p>
<p>假定由A和B两个节点组成的Keepalived集群，在A节点keepalived.conf文件中，设置priority值为100，而在B节点keepalived.conf文件中，设置priority值为80，并且A、B两个节点都使用了vrrp_script模块来监控MySQL服务，同时都设置weight值为10，那么将会发生如下情况。</p>
<p>在两节点都启动Keepalived服务后，正常情况是A节点将成为集群中的MASTER节点，而B自动成为BACKUP节点，此时将A节点的MySQL服务关闭，通过查看日志发现，并没有出现B节点接管A节点的日志，B节点仍然处于BACKUP状态，而A节点依旧处于MASTER状态，在这种情况下整个HA集群将失去意义。</p>
<p>下面分析产生这种情况的原因。这也就是Keepalived集群中主、备角色选举策略的问题。下面总结在Keepalived中使用vrrp_script模块时整个集群角色的选举算法，由于weight值可以是正数也可以是负数，因此，要分两种情况进行说明。</p>
<p><strong>1.weight值为正数时</strong></p>
<p>在vrrp_script中指定的脚本如果检测成功，那么MASTER节点的权值将是weight值与priority值之和；如果脚本检测失败，那么MASTER节点的权值保持为priority值，因此切换策略为：</p>
<p>·MASTER节点vrrp_script脚本检测失败时，如果MASTER节点priority值小于BACKUP节点weight值与priority值之和，将发生主、备切换。</p>
<p>·MASTER节点vrrp_script脚本检测成功时，如果MASTER节点weight值与priority值之和大于BACKUP节点weight值与priority值之和，主节点依然为主节点，不发生切换。</p>
<p><strong>2.weight值为负数时</strong></p>
<p>在vrrp_script中指定的脚本如果检测成功，那么MASTER节点的权值仍为priority值，当脚本检测失败时，MASTER节点的权值将是priority值与weight值之差，因此切换策略为：</p>
<p>·MASTER节点vrrp_script脚本检测失败时，如果MASTER节点priority值与weight值之差小于BACKUP节点priority值，将发生主、备切换。</p>
<p>·MASTER节点vrrp_script脚本检测成功时，如果MASTER节点priority值大于BACKUP节点priority值时，主节点依然为主节点，不发生切换。</p>
<p>在熟悉了Keepalived主、备角色的选举策略后，再来分析一下前面的那个实例。由于A、B两个节点设置的weight值都为10，因此符合选举策略的第一种，在A节点停止MySQL服务后，A节点的脚本检测将失败，此时A节点的权值将保持为A节点上设置的priority值，即为100，而B节点的权值将变为weight值与priority值之和，也就是90（10+80），这样就出现了A节点权值仍然大于B节点权值的情况，因此不会发生主、备切换。</p>
<p>对于weight值的设置，有一个简单的标准，即weight值的绝对值要大于MASTER和BACKUP节点priority值之差。对于上面A、B两个节点的例子，只要设置weight值大于20即可保证集群正常运行和切换。由此可见，对于weight值的设置要非常谨慎，如果设置不好，主节点发生故障时将导致集群角色选举失败，使集群陷于瘫痪状态。</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="08.%E8%99%9A%E6%8B%9F%E5%8C%96%E4%B8%8E%E9%9B%86%E7%BE%A4%E5%BA%94%E7%94%A8%E7%AF%87.html" class="btn btn-neutral float-left" title="10.8. 虚拟化与集群应用篇" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="10.%E6%90%AD%E5%BB%BAHAProxy%2BKeepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%B3%BB%E7%BB%9F.html" class="btn btn-neutral float-right" title="10.10. 搭建HAProxy+Keepalived高可用负载均衡系统" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>